<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Haiku-commits] r25189 - in haiku/trunk: headers/os/opengl/GL	src/kits/opengl/mesa/drivers/common src/kits/opengl/mesa/main	src/kits/opengl/mesa/shader src/kits/opengl/mesa/shader/slang	src/kits/opengl/mesa/shader/slang/library	src/kits/opengl/mesa/swrast src/kits/opengl/mesa/swrast_setup	src/kits/opengl/mesa/tnl src/kits/opengl/mesa/tnl_dd	src/kits/opengl/mesa/vbo src/kits/opengl/mesa/x86/rtasm
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/haiku-commits/2008-April/index.html" >
   <LINK REL="made" HREF="mailto:haiku-commits%40lists.berlios.de?Subject=Re%3A%20%5BHaiku-commits%5D%20r25189%20-%20in%20haiku/trunk%3A%20headers/os/opengl/GL%0A%09src/kits/opengl/mesa/drivers/common%20src/kits/opengl/mesa/main%0A%09src/kits/opengl/mesa/shader%20src/kits/opengl/mesa/shader/slang%0A%09src/kits/opengl/mesa/shader/slang/library%0A%09src/kits/opengl/mesa/swrast%20src/kits/opengl/mesa/swrast_setup%0A%09src/kits/opengl/mesa/tnl%20src/kits/opengl/mesa/tnl_dd%0A%09src/kits/opengl/mesa/vbo%20src/kits/opengl/mesa/x86/rtasm&In-Reply-To=%3C200804261633.m3QGXP4A015749%40sheep.berlios.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="008226.html">
   <LINK REL="Next"  HREF="008228.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Haiku-commits] r25189 - in haiku/trunk: headers/os/opengl/GL	src/kits/opengl/mesa/drivers/common src/kits/opengl/mesa/main	src/kits/opengl/mesa/shader src/kits/opengl/mesa/shader/slang	src/kits/opengl/mesa/shader/slang/library	src/kits/opengl/mesa/swrast src/kits/opengl/mesa/swrast_setup	src/kits/opengl/mesa/tnl src/kits/opengl/mesa/tnl_dd	src/kits/opengl/mesa/vbo src/kits/opengl/mesa/x86/rtasm</H1>
    <B>korli at BerliOS</B> 
    <A HREF="mailto:haiku-commits%40lists.berlios.de?Subject=Re%3A%20%5BHaiku-commits%5D%20r25189%20-%20in%20haiku/trunk%3A%20headers/os/opengl/GL%0A%09src/kits/opengl/mesa/drivers/common%20src/kits/opengl/mesa/main%0A%09src/kits/opengl/mesa/shader%20src/kits/opengl/mesa/shader/slang%0A%09src/kits/opengl/mesa/shader/slang/library%0A%09src/kits/opengl/mesa/swrast%20src/kits/opengl/mesa/swrast_setup%0A%09src/kits/opengl/mesa/tnl%20src/kits/opengl/mesa/tnl_dd%0A%09src/kits/opengl/mesa/vbo%20src/kits/opengl/mesa/x86/rtasm&In-Reply-To=%3C200804261633.m3QGXP4A015749%40sheep.berlios.de%3E"
       TITLE="[Haiku-commits] r25189 - in haiku/trunk: headers/os/opengl/GL	src/kits/opengl/mesa/drivers/common src/kits/opengl/mesa/main	src/kits/opengl/mesa/shader src/kits/opengl/mesa/shader/slang	src/kits/opengl/mesa/shader/slang/library	src/kits/opengl/mesa/swrast src/kits/opengl/mesa/swrast_setup	src/kits/opengl/mesa/tnl src/kits/opengl/mesa/tnl_dd	src/kits/opengl/mesa/vbo src/kits/opengl/mesa/x86/rtasm">korli at mail.berlios.de
       </A><BR>
    <I>Sat Apr 26 18:33:25 CEST 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="008226.html">[Haiku-commits] r25188 - haiku/vendor/mesa
</A></li>
        <LI>Next message: <A HREF="008228.html">[Haiku-commits] r25190 - in haiku/trunk: build/jam data data/bin
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8227">[ date ]</a>
              <a href="thread.html#8227">[ thread ]</a>
              <a href="subject.html#8227">[ subject ]</a>
              <a href="author.html#8227">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: korli
Date: 2008-04-26 18:33:15 +0200 (Sat, 26 Apr 2008)
New Revision: 25189
ViewCVS: <A HREF="http://svn.berlios.de/viewcvs/haiku?rev=25189&amp;view=rev">http://svn.berlios.de/viewcvs/haiku?rev=25189&amp;view=rev</A>

Modified:
   haiku/trunk/headers/os/opengl/GL/glext.h
   haiku/trunk/src/kits/opengl/mesa/drivers/common/driverfuncs.c
   haiku/trunk/src/kits/opengl/mesa/main/buffers.c
   haiku/trunk/src/kits/opengl/mesa/main/config.h
   haiku/trunk/src/kits/opengl/mesa/main/context.c
   haiku/trunk/src/kits/opengl/mesa/main/context.h
   haiku/trunk/src/kits/opengl/mesa/main/dd.h
   haiku/trunk/src/kits/opengl/mesa/main/drawpix.c
   haiku/trunk/src/kits/opengl/mesa/main/enable.c
   haiku/trunk/src/kits/opengl/mesa/main/fbobject.c
   haiku/trunk/src/kits/opengl/mesa/main/get.c
   haiku/trunk/src/kits/opengl/mesa/main/glheader.h
   haiku/trunk/src/kits/opengl/mesa/main/imports.h
   haiku/trunk/src/kits/opengl/mesa/main/mtypes.h
   haiku/trunk/src/kits/opengl/mesa/main/points.c
   haiku/trunk/src/kits/opengl/mesa/main/state.c
   haiku/trunk/src/kits/opengl/mesa/main/texenvprogram.c
   haiku/trunk/src/kits/opengl/mesa/main/teximage.c
   haiku/trunk/src/kits/opengl/mesa/main/texobj.c
   haiku/trunk/src/kits/opengl/mesa/main/texstore.c
   haiku/trunk/src/kits/opengl/mesa/main/varray.c
   haiku/trunk/src/kits/opengl/mesa/main/version.h
   haiku/trunk/src/kits/opengl/mesa/shader/arbprogparse.c
   haiku/trunk/src/kits/opengl/mesa/shader/arbprogram.c
   haiku/trunk/src/kits/opengl/mesa/shader/arbprogram_syn.h
   haiku/trunk/src/kits/opengl/mesa/shader/prog_execute.c
   haiku/trunk/src/kits/opengl/mesa/shader/prog_execute.h
   haiku/trunk/src/kits/opengl/mesa/shader/prog_parameter.c
   haiku/trunk/src/kits/opengl/mesa/shader/prog_statevars.c
   haiku/trunk/src/kits/opengl/mesa/shader/prog_statevars.h
   haiku/trunk/src/kits/opengl/mesa/shader/program.c
   haiku/trunk/src/kits/opengl/mesa/shader/shader_api.c
   haiku/trunk/src/kits/opengl/mesa/shader/slang/library/slang_common_builtin.gc
   haiku/trunk/src/kits/opengl/mesa/shader/slang/library/slang_common_builtin_gc.h
   haiku/trunk/src/kits/opengl/mesa/shader/slang/slang_builtin.c
   haiku/trunk/src/kits/opengl/mesa/shader/slang/slang_codegen.c
   haiku/trunk/src/kits/opengl/mesa/shader/slang/slang_emit.c
   haiku/trunk/src/kits/opengl/mesa/swrast/s_aalinetemp.h
   haiku/trunk/src/kits/opengl/mesa/swrast/s_aatritemp.h
   haiku/trunk/src/kits/opengl/mesa/swrast/s_context.c
   haiku/trunk/src/kits/opengl/mesa/swrast/s_context.h
   haiku/trunk/src/kits/opengl/mesa/swrast/s_drawpix.c
   haiku/trunk/src/kits/opengl/mesa/swrast/s_fragprog.c
   haiku/trunk/src/kits/opengl/mesa/swrast/s_linetemp.h
   haiku/trunk/src/kits/opengl/mesa/swrast/s_pointtemp.h
   haiku/trunk/src/kits/opengl/mesa/swrast/s_readpix.c
   haiku/trunk/src/kits/opengl/mesa/swrast/s_texfilter.c
   haiku/trunk/src/kits/opengl/mesa/swrast/s_triangle.c
   haiku/trunk/src/kits/opengl/mesa/swrast/s_tritemp.h
   haiku/trunk/src/kits/opengl/mesa/swrast/swrast.h
   haiku/trunk/src/kits/opengl/mesa/swrast_setup/ss_context.c
   haiku/trunk/src/kits/opengl/mesa/swrast_setup/ss_triangle.c
   haiku/trunk/src/kits/opengl/mesa/swrast_setup/ss_tritmp.h
   haiku/trunk/src/kits/opengl/mesa/tnl/t_vb_program.c
   haiku/trunk/src/kits/opengl/mesa/tnl/t_vertex_sse.c
   haiku/trunk/src/kits/opengl/mesa/tnl/tnl.h
   haiku/trunk/src/kits/opengl/mesa/tnl_dd/t_dd_tritmp.h
   haiku/trunk/src/kits/opengl/mesa/vbo/vbo_context.c
   haiku/trunk/src/kits/opengl/mesa/vbo/vbo_exec.h
   haiku/trunk/src/kits/opengl/mesa/vbo/vbo_exec_api.c
   haiku/trunk/src/kits/opengl/mesa/vbo/vbo_exec_array.c
   haiku/trunk/src/kits/opengl/mesa/vbo/vbo_save.c
   haiku/trunk/src/kits/opengl/mesa/x86/rtasm/x86sse.c
   haiku/trunk/src/kits/opengl/mesa/x86/rtasm/x86sse.h
Log:
updated mesa to 7.0.3


Modified: haiku/trunk/headers/os/opengl/GL/glext.h
===================================================================
--- haiku/trunk/headers/os/opengl/GL/glext.h	2008-04-26 16:20:39 UTC (rev 25188)
+++ haiku/trunk/headers/os/opengl/GL/glext.h	2008-04-26 16:33:15 UTC (rev 25189)
@@ -46,9 +46,9 @@
 /*************************************************************/
 
 /* Header file version number, required by OpenGL ABI for Linux */
-/* glext.h last updated 2007/02/12 */
+/* glext.h last updated 2008/03/24 */
 /* Current version at <A HREF="http://www.opengl.org/registry/">http://www.opengl.org/registry/</A> */
-#define GL_GLEXT_VERSION 39
+#define GL_GLEXT_VERSION 40
 
 #ifndef GL_VERSION_1_2
 #define GL_UNSIGNED_BYTE_3_3_2            0x8032
@@ -3091,8 +3091,8 @@
 #ifndef GL_EXT_framebuffer_blit
 #define GL_READ_FRAMEBUFFER_EXT           0x8CA8
 #define GL_DRAW_FRAMEBUFFER_EXT           0x8CA9
-#define GL_READ_FRAMEBUFFER_BINDING_EXT   GL_FRAMEBUFFER_BINDING_EXT
-#define GL_DRAW_FRAMEBUFFER_BINDING_EXT   0x8CAA
+#define GL_DRAW_FRAMEBUFFER_BINDING_EXT   GL_FRAMEBUFFER_BINDING_EXT
+#define GL_READ_FRAMEBUFFER_BINDING_EXT   0x8CAA
 #endif
 
 #ifndef GL_EXT_framebuffer_multisample
@@ -3379,7 +3379,10 @@
 #define GL_RGBA_INTEGER_MODE_EXT          0x8D9E
 #endif
 
+#ifndef GL_GREMEDY_frame_terminator
+#endif
 
+
 /*************************************************************/
 
 #include &lt;stddef.h&gt;
@@ -7252,7 +7255,15 @@
 typedef void (APIENTRYP PFNGLCLEARCOLORIUIEXTPROC) (GLuint red, GLuint green, GLuint blue, GLuint alpha);
 #endif
 
+#ifndef GL_GREMEDY_frame_terminator
+#define GL_GREMEDY_frame_terminator 1
+#ifdef GL_GLEXT_PROTOTYPES
+GLAPI void APIENTRY glFrameTerminatorGREMEDY (void);
+#endif /* GL_GLEXT_PROTOTYPES */
+typedef void (APIENTRYP PFNGLFRAMETERMINATORGREMEDYPROC) (void);
+#endif
 
+
 #ifdef __cplusplus
 }
 #endif

Modified: haiku/trunk/src/kits/opengl/mesa/drivers/common/driverfuncs.c
===================================================================
--- haiku/trunk/src/kits/opengl/mesa/drivers/common/driverfuncs.c	2008-04-26 16:20:39 UTC (rev 25188)
+++ haiku/trunk/src/kits/opengl/mesa/drivers/common/driverfuncs.c	2008-04-26 16:33:15 UTC (rev 25189)
@@ -112,6 +112,8 @@
    driver-&gt;DeleteTexture = _mesa_delete_texture_object;
    driver-&gt;NewTextureImage = _mesa_new_texture_image;
    driver-&gt;FreeTexImageData = _mesa_free_texture_image_data; 
+   driver-&gt;MapTexture = NULL;
+   driver-&gt;UnmapTexture = NULL;
    driver-&gt;TextureMemCpy = _mesa_memcpy; 
    driver-&gt;IsTextureResident = NULL;
    driver-&gt;PrioritizeTexture = NULL;

Modified: haiku/trunk/src/kits/opengl/mesa/main/buffers.c
===================================================================
--- haiku/trunk/src/kits/opengl/mesa/main/buffers.c	2008-04-26 16:20:39 UTC (rev 25188)
+++ haiku/trunk/src/kits/opengl/mesa/main/buffers.c	2008-04-26 16:33:15 UTC (rev 25189)
@@ -271,6 +271,14 @@
          return BUFFER_BIT_COLOR2;
       case GL_COLOR_ATTACHMENT3_EXT:
          return BUFFER_BIT_COLOR3;
+      case GL_COLOR_ATTACHMENT4_EXT:
+         return BUFFER_BIT_COLOR4;
+      case GL_COLOR_ATTACHMENT5_EXT:
+         return BUFFER_BIT_COLOR5;
+      case GL_COLOR_ATTACHMENT6_EXT:
+         return BUFFER_BIT_COLOR6;
+      case GL_COLOR_ATTACHMENT7_EXT:
+         return BUFFER_BIT_COLOR7;
       default:
          /* error */
          return BAD_MASK;
@@ -320,6 +328,14 @@
          return BUFFER_COLOR2;
       case GL_COLOR_ATTACHMENT3_EXT:
          return BUFFER_COLOR3;
+      case GL_COLOR_ATTACHMENT4_EXT:
+         return BUFFER_COLOR4;
+      case GL_COLOR_ATTACHMENT5_EXT:
+         return BUFFER_COLOR5;
+      case GL_COLOR_ATTACHMENT6_EXT:
+         return BUFFER_COLOR6;
+      case GL_COLOR_ATTACHMENT7_EXT:
+         return BUFFER_COLOR7;
       default:
          /* error */
          return -1;

Modified: haiku/trunk/src/kits/opengl/mesa/main/config.h
===================================================================
--- haiku/trunk/src/kits/opengl/mesa/main/config.h	2008-04-26 16:20:39 UTC (rev 25188)
+++ haiku/trunk/src/kits/opengl/mesa/main/config.h	2008-04-26 16:33:15 UTC (rev 25189)
@@ -209,7 +209,7 @@
 /** For GL_ARB_vertex_shader */
 /*@{*/
 #define MAX_VERTEX_ATTRIBS 16
-#define MAX_VERTEX_TEXTURE_IMAGE_UNITS 0
+#define MAX_VERTEX_TEXTURE_IMAGE_UNITS MAX_TEXTURE_UNITS
 #define MAX_COMBINED_TEXTURE_IMAGE_UNITS (MAX_TEXTURE_IMAGE_UNITS + MAX_VERTEX_TEXTURE_IMAGE_UNITS)
 /*@}*/
 

Modified: haiku/trunk/src/kits/opengl/mesa/main/context.c
===================================================================
--- haiku/trunk/src/kits/opengl/mesa/main/context.c	2008-04-26 16:20:39 UTC (rev 25188)
+++ haiku/trunk/src/kits/opengl/mesa/main/context.c	2008-04-26 16:33:15 UTC (rev 25189)
@@ -640,7 +640,12 @@
     */
    /*assert(fb-&gt;RefCount == 1);*/
    fb-&gt;RefCount = 0;
-   fb-&gt;Delete(fb);
+
+   /* NOTE: Delete should always be defined but there are two reports
+    * of it being NULL (bugs 13507, 14293).  Work-around for now.
+    */
+   if (fb-&gt;Delete)
+      fb-&gt;Delete(fb);
 }
 
 /**
@@ -682,10 +687,10 @@
    _mesa_DeleteHashTable(ss-&gt;Programs);
 #endif
 #if FEATURE_ARB_vertex_program
-   _mesa_delete_program(ctx, ss-&gt;DefaultVertexProgram);
+   ctx-&gt;Driver.DeleteProgram(ctx, ss-&gt;DefaultVertexProgram);
 #endif
 #if FEATURE_ARB_fragment_program
-   _mesa_delete_program(ctx, ss-&gt;DefaultFragmentProgram);
+   ctx-&gt;Driver.DeleteProgram(ctx, ss-&gt;DefaultFragmentProgram);
 #endif
 
 #if FEATURE_ATI_fragment_shader
@@ -749,7 +754,7 @@
    }
 
    /* redo special cases: */
-   ASSIGN_4V( ctx-&gt;Current.Attrib[VERT_ATTRIB_WEIGHT], 1.0, 0.0, 0.0, 1.0 );
+   ASSIGN_4V( ctx-&gt;Current.Attrib[VERT_ATTRIB_WEIGHT], 1.0, 0.0, 0.0, 0.0 );
    ASSIGN_4V( ctx-&gt;Current.Attrib[VERT_ATTRIB_NORMAL], 0.0, 0.0, 1.0, 1.0 );
    ASSIGN_4V( ctx-&gt;Current.Attrib[VERT_ATTRIB_COLOR0], 1.0, 1.0, 1.0, 1.0 );
    ASSIGN_4V( ctx-&gt;Current.Attrib[VERT_ATTRIB_COLOR1], 0.0, 0.0, 0.0, 1.0 );
@@ -977,7 +982,6 @@
    /* Miscellaneous */
    ctx-&gt;NewState = _NEW_ALL;
    ctx-&gt;ErrorValue = (GLenum) GL_NO_ERROR;
-   ctx-&gt;_Facing = 0;
 
    return GL_TRUE;
 }

Modified: haiku/trunk/src/kits/opengl/mesa/main/context.h
===================================================================
--- haiku/trunk/src/kits/opengl/mesa/main/context.h	2008-04-26 16:20:39 UTC (rev 25188)
+++ haiku/trunk/src/kits/opengl/mesa/main/context.h	2008-04-26 16:33:15 UTC (rev 25189)
@@ -272,10 +272,10 @@
    (((CTX)-&gt;Light.Enabled &amp;&amp;						\
      (CTX)-&gt;Light.Model.ColorControl == GL_SEPARATE_SPECULAR_COLOR)	\
     || (CTX)-&gt;Fog.ColorSumEnabled					\
-    || ((CTX)-&gt;VertexProgram._Enabled &amp;&amp;				\
-        ((CTX)-&gt;VertexProgram.Current-&gt;Base.InputsRead &amp; VERT_BIT_COLOR1)) \
-    || ((CTX)-&gt;FragmentProgram._Enabled &amp;&amp;				\
-        ((CTX)-&gt;FragmentProgram.Current-&gt;Base.InputsRead &amp; FRAG_BIT_COL1)) \
+    || ((CTX)-&gt;VertexProgram._Current &amp;&amp;				\
+        ((CTX)-&gt;VertexProgram._Current-&gt;Base.InputsRead &amp; VERT_BIT_COLOR1)) \
+    || ((CTX)-&gt;FragmentProgram._Current &amp;&amp;				\
+        ((CTX)-&gt;FragmentProgram._Current-&gt;Base.InputsRead &amp; FRAG_BIT_COL1)) \
    )
 
 

Modified: haiku/trunk/src/kits/opengl/mesa/main/dd.h
===================================================================
--- haiku/trunk/src/kits/opengl/mesa/main/dd.h	2008-04-26 16:20:39 UTC (rev 25188)
+++ haiku/trunk/src/kits/opengl/mesa/main/dd.h	2008-04-26 16:33:15 UTC (rev 25189)
@@ -493,6 +493,11 @@
     */
    void (*FreeTexImageData)( GLcontext *ctx, struct gl_texture_image *tImage );
 
+   /** Map texture image data into user space */
+   void (*MapTexture)( GLcontext *ctx, struct gl_texture_object *tObj );
+   /** Unmap texture images from user space */
+   void (*UnmapTexture)( GLcontext *ctx, struct gl_texture_object *tObj );
+
    /**
     * Note: no context argument.  This function doesn't initially look
     * like it belongs here, except that the driver is the only entity

Modified: haiku/trunk/src/kits/opengl/mesa/main/drawpix.c
===================================================================
--- haiku/trunk/src/kits/opengl/mesa/main/drawpix.c	2008-04-26 16:20:39 UTC (rev 25188)
+++ haiku/trunk/src/kits/opengl/mesa/main/drawpix.c	2008-04-26 16:33:15 UTC (rev 25189)
@@ -1,8 +1,8 @@
 /*
  * Mesa 3-D graphics library
- * Version:  6.5
+ * Version:  7.0.3
  *
- * Copyright (C) 1999-2006  Brian Paul   All Rights Reserved.
+ * Copyright (C) 1999-2008  Brian Paul   All Rights Reserved.
  *
  * Permission is hereby granted, free of charge, to any person obtaining a
  * copy of this software and associated documentation files (the &quot;Software&quot;),
@@ -341,12 +341,10 @@
    }
 
    if (ctx-&gt;RenderMode == GL_RENDER) {
-      if (bitmap) {
-         /* Truncate, to satisfy conformance tests (matches SGI's OpenGL). */
-         GLint x = IFLOOR(ctx-&gt;Current.RasterPos[0] - xorig);
-         GLint y = IFLOOR(ctx-&gt;Current.RasterPos[1] - yorig);
-         ctx-&gt;Driver.Bitmap( ctx, x, y, width, height, &amp;ctx-&gt;Unpack, bitmap );
-      }
+      /* Truncate, to satisfy conformance tests (matches SGI's OpenGL). */
+      GLint x = IFLOOR(ctx-&gt;Current.RasterPos[0] - xorig);
+      GLint y = IFLOOR(ctx-&gt;Current.RasterPos[1] - yorig);
+      ctx-&gt;Driver.Bitmap( ctx, x, y, width, height, &amp;ctx-&gt;Unpack, bitmap );
    }
 #if _HAVE_FULL_GL
    else if (ctx-&gt;RenderMode == GL_FEEDBACK) {

Modified: haiku/trunk/src/kits/opengl/mesa/main/enable.c
===================================================================
--- haiku/trunk/src/kits/opengl/mesa/main/enable.c	2008-04-26 16:20:39 UTC (rev 25188)
+++ haiku/trunk/src/kits/opengl/mesa/main/enable.c	2008-04-26 16:33:15 UTC (rev 25189)
@@ -5,9 +5,9 @@
 
 /*
  * Mesa 3-D graphics library
- * Version:  6.5.1
+ * Version:  7.0.3
  *
- * Copyright (C) 1999-2006  Brian Paul   All Rights Reserved.
+ * Copyright (C) 1999-2007  Brian Paul   All Rights Reserved.
  *
  * Permission is hereby granted, free of charge, to any person obtaining a
  * copy of this software and associated documentation files (the &quot;Software&quot;),
@@ -364,12 +364,12 @@
       case GL_LIGHTING:
          if (ctx-&gt;Light.Enabled == state)
             return;
+         FLUSH_VERTICES(ctx, _NEW_LIGHT);
+         ctx-&gt;Light.Enabled = state;
          if (ctx-&gt;Light.Enabled &amp;&amp; ctx-&gt;Light.Model.TwoSide)
             ctx-&gt;_TriangleCaps |= DD_TRI_LIGHT_TWOSIDE;
          else
             ctx-&gt;_TriangleCaps &amp;= ~DD_TRI_LIGHT_TWOSIDE;
-         FLUSH_VERTICES(ctx, _NEW_LIGHT);
-         ctx-&gt;Light.Enabled = state;
          break;
       case GL_LINE_SMOOTH:
          if (ctx-&gt;Line.SmoothFlag == state)

Modified: haiku/trunk/src/kits/opengl/mesa/main/fbobject.c
===================================================================
--- haiku/trunk/src/kits/opengl/mesa/main/fbobject.c	2008-04-26 16:20:39 UTC (rev 25188)
+++ haiku/trunk/src/kits/opengl/mesa/main/fbobject.c	2008-04-26 16:33:15 UTC (rev 25189)
@@ -302,7 +302,7 @@
             /* OK */
          }
          else if (ctx-&gt;Extensions.EXT_packed_depth_stencil &amp;&amp;
-                  att-&gt;Renderbuffer-&gt;_BaseFormat == GL_DEPTH_STENCIL_EXT) {
+                  texImage-&gt;TexFormat-&gt;BaseFormat == GL_DEPTH_STENCIL_EXT) {
             /* OK */
          }
          else {

Modified: haiku/trunk/src/kits/opengl/mesa/main/get.c
===================================================================
--- haiku/trunk/src/kits/opengl/mesa/main/get.c	2008-04-26 16:20:39 UTC (rev 25188)
+++ haiku/trunk/src/kits/opengl/mesa/main/get.c	2008-04-26 16:33:15 UTC (rev 25189)
@@ -1864,6 +1864,10 @@
          CHECK_EXT1(EXT_framebuffer_object, &quot;GetBooleanv&quot;);
          params[0] = INT_TO_BOOLEAN(ctx-&gt;Const.MaxRenderbufferSize);
          break;
+      case GL_READ_FRAMEBUFFER_BINDING_EXT:
+         CHECK_EXT1(EXT_framebuffer_blit, &quot;GetBooleanv&quot;);
+         params[0] = INT_TO_BOOLEAN(ctx-&gt;ReadBuffer-&gt;Name);
+         break;
       case GL_MAX_FRAGMENT_UNIFORM_COMPONENTS_ARB:
          CHECK_EXT1(ARB_fragment_shader, &quot;GetBooleanv&quot;);
          params[0] = INT_TO_BOOLEAN(ctx-&gt;Const.FragmentProgram.MaxUniformComponents);
@@ -3695,6 +3699,10 @@
          CHECK_EXT1(EXT_framebuffer_object, &quot;GetFloatv&quot;);
          params[0] = (GLfloat)(ctx-&gt;Const.MaxRenderbufferSize);
          break;
+      case GL_READ_FRAMEBUFFER_BINDING_EXT:
+         CHECK_EXT1(EXT_framebuffer_blit, &quot;GetFloatv&quot;);
+         params[0] = (GLfloat)(ctx-&gt;ReadBuffer-&gt;Name);
+         break;
       case GL_MAX_FRAGMENT_UNIFORM_COMPONENTS_ARB:
          CHECK_EXT1(ARB_fragment_shader, &quot;GetFloatv&quot;);
          params[0] = (GLfloat)(ctx-&gt;Const.FragmentProgram.MaxUniformComponents);
@@ -5526,6 +5534,10 @@
          CHECK_EXT1(EXT_framebuffer_object, &quot;GetIntegerv&quot;);
          params[0] = ctx-&gt;Const.MaxRenderbufferSize;
          break;
+      case GL_READ_FRAMEBUFFER_BINDING_EXT:
+         CHECK_EXT1(EXT_framebuffer_blit, &quot;GetIntegerv&quot;);
+         params[0] = ctx-&gt;ReadBuffer-&gt;Name;
+         break;
       case GL_MAX_FRAGMENT_UNIFORM_COMPONENTS_ARB:
          CHECK_EXT1(ARB_fragment_shader, &quot;GetIntegerv&quot;);
          params[0] = ctx-&gt;Const.FragmentProgram.MaxUniformComponents;

Modified: haiku/trunk/src/kits/opengl/mesa/main/glheader.h
===================================================================
--- haiku/trunk/src/kits/opengl/mesa/main/glheader.h	2008-04-26 16:20:39 UTC (rev 25188)
+++ haiku/trunk/src/kits/opengl/mesa/main/glheader.h	2008-04-26 16:33:15 UTC (rev 25189)
@@ -237,7 +237,7 @@
 #endif
 
 
-#if (!defined(__GNUC__) || __GNUC__ &lt; 3) &amp;&amp; !defined(__IBMC__)
+#if (!defined(__GNUC__) || __GNUC__ &lt; 3) &amp;&amp; (!defined(__IBMC__) || __IBMC__ &lt; 900)
 #  define __builtin_expect(x, y) x
 #endif
 

Modified: haiku/trunk/src/kits/opengl/mesa/main/imports.h
===================================================================
--- haiku/trunk/src/kits/opengl/mesa/main/imports.h	2008-04-26 16:20:39 UTC (rev 25188)
+++ haiku/trunk/src/kits/opengl/mesa/main/imports.h	2008-04-26 16:33:15 UTC (rev 25189)
@@ -1,8 +1,8 @@
 /*
  * Mesa 3-D graphics library
- * Version:  6.5.2
+ * Version:  7.0.3
  *
- * Copyright (C) 1999-2006  Brian Paul   All Rights Reserved.
+ * Copyright (C) 1999-2008  Brian Paul   All Rights Reserved.
  *
  * Permission is hereby granted, free of charge, to any person obtaining a
  * copy of this software and associated documentation files (the &quot;Software&quot;),
@@ -159,7 +159,7 @@
  ***/
 #if defined(__i386__) || defined(__386__) || defined(__sparc__) || \
     defined(__s390x__) || defined(__powerpc__) || \
-    defined(__amd64__) || \
+    defined(__amd64__) || defined(__x86_64__) || \
     defined(ia64) || defined(__ia64__) || \
     defined(__hppa__) || defined(hpux) || \
     defined(__mips) || defined(_MIPS_ARCH) || \

Modified: haiku/trunk/src/kits/opengl/mesa/main/mtypes.h
===================================================================
--- haiku/trunk/src/kits/opengl/mesa/main/mtypes.h	2008-04-26 16:20:39 UTC (rev 25188)
+++ haiku/trunk/src/kits/opengl/mesa/main/mtypes.h	2008-04-26 16:33:15 UTC (rev 25189)
@@ -7,7 +7,7 @@
 
 /*
  * Mesa 3-D graphics library
- * Version:  6.5.3
+ * Version:  7.0.3
  *
  * Copyright (C) 1999-2007  Brian Paul   All Rights Reserved.
  *
@@ -1063,7 +1063,7 @@
 {
    GLboolean SmoothFlag;	/**&lt; True if GL_POINT_SMOOTH is enabled */
    GLfloat Size;		/**&lt; User-specified point size */
-   GLfloat _Size;		/**&lt; Size clamped to Const.Min/MaxPointSize */
+   GLfloat _Size;		/**&lt; Size clamped to user limits */
    GLfloat Params[3];		/**&lt; GL_EXT_point_parameters */
    GLfloat MinSize, MaxSize;	/**&lt; GL_EXT_point_parameters */
    GLfloat Threshold;		/**&lt; GL_EXT_point_parameters */
@@ -3032,12 +3032,6 @@
 
    struct gl_list_extensions ListExt; /**&lt; driver dlist extensions */
 
-
-   GLuint _Facing; /**&lt; This is a hack for 2-sided stencil test.
-		    *
-		    * We don't have a better way to communicate this value from
-		    * swrast_setup to swrast. */
-
    /** \name For debugging/development only */
    /*@{*/
    GLboolean FirstTimeCurrent;

Modified: haiku/trunk/src/kits/opengl/mesa/main/points.c
===================================================================
--- haiku/trunk/src/kits/opengl/mesa/main/points.c	2008-04-26 16:20:39 UTC (rev 25188)
+++ haiku/trunk/src/kits/opengl/mesa/main/points.c	2008-04-26 16:33:15 UTC (rev 25189)
@@ -5,7 +5,7 @@
 
 /*
  * Mesa 3-D graphics library
- * Version:  7.0.1
+ * Version:  7.0.3
  *
  * Copyright (C) 1999-2007  Brian Paul   All Rights Reserved.
  *
@@ -57,6 +57,7 @@
 
    FLUSH_VERTICES(ctx, _NEW_POINT);
    ctx-&gt;Point.Size = size;
+   /* _Size is only used for non-attenuated path */
    ctx-&gt;Point._Size = CLAMP(ctx-&gt;Point.Size,
 			    ctx-&gt;Point.MinSize,
 			    ctx-&gt;Point.MaxSize);
@@ -150,6 +151,10 @@
                return;
             FLUSH_VERTICES(ctx, _NEW_POINT);
             ctx-&gt;Point.MinSize = params[0];
+            /* re-clamp _Size */
+            ctx-&gt;Point._Size = CLAMP(ctx-&gt;Point.Size,
+                                     ctx-&gt;Point.MinSize,
+                                     ctx-&gt;Point.MaxSize);
          }
          else {
             _mesa_error(ctx, GL_INVALID_ENUM,
@@ -168,6 +173,10 @@
                return;
             FLUSH_VERTICES(ctx, _NEW_POINT);
             ctx-&gt;Point.MaxSize = params[0];
+            /* re-clamp _Size */
+            ctx-&gt;Point._Size = CLAMP(ctx-&gt;Point.Size,
+                                     ctx-&gt;Point.MinSize,
+                                     ctx-&gt;Point.MaxSize);
          }
          else {
             _mesa_error(ctx, GL_INVALID_ENUM,

Modified: haiku/trunk/src/kits/opengl/mesa/main/state.c
===================================================================
--- haiku/trunk/src/kits/opengl/mesa/main/state.c	2008-04-26 16:20:39 UTC (rev 25188)
+++ haiku/trunk/src/kits/opengl/mesa/main/state.c	2008-04-26 16:33:15 UTC (rev 25189)
@@ -960,7 +960,7 @@
    ctx-&gt;FragmentProgram._Enabled = ctx-&gt;FragmentProgram.Enabled
       &amp;&amp; ctx-&gt;FragmentProgram.Current-&gt;Base.Instructions;
    ctx-&gt;ATIFragmentShader._Enabled = ctx-&gt;ATIFragmentShader.Enabled
-      &amp;&amp; ctx-&gt;ATIFragmentShader.Current-&gt;Instructions;
+      &amp;&amp; ctx-&gt;ATIFragmentShader.Current-&gt;Instructions[0];
 
    /*
     * Set the ctx-&gt;VertexProgram._Current and ctx-&gt;FragmentProgram._Current

Modified: haiku/trunk/src/kits/opengl/mesa/main/texenvprogram.c
===================================================================
--- haiku/trunk/src/kits/opengl/mesa/main/texenvprogram.c	2008-04-26 16:20:39 UTC (rev 25188)
+++ haiku/trunk/src/kits/opengl/mesa/main/texenvprogram.c	2008-04-26 16:33:15 UTC (rev 25189)
@@ -199,8 +199,8 @@
 
    for (i=0;i&lt;MAX_TEXTURE_UNITS;i++) {
       const struct gl_texture_unit *texUnit = &amp;ctx-&gt;Texture.Unit[i];
-		
-      if (!texUnit-&gt;_ReallyEnabled)
+
+      if (!texUnit-&gt;_ReallyEnabled || !texUnit-&gt;Enabled)
          continue;
 
       key-&gt;unit[i].enabled = 1;

Modified: haiku/trunk/src/kits/opengl/mesa/main/teximage.c
===================================================================
--- haiku/trunk/src/kits/opengl/mesa/main/teximage.c	2008-04-26 16:20:39 UTC (rev 25188)
+++ haiku/trunk/src/kits/opengl/mesa/main/teximage.c	2008-04-26 16:33:15 UTC (rev 25189)
@@ -1,8 +1,8 @@
 /*
  * Mesa 3-D graphics library
- * Version:  7.0.1
+ * Version:  7.0.3
  *
- * Copyright (C) 1999-2007  Brian Paul   All Rights Reserved.
+ * Copyright (C) 1999-2008  Brian Paul   All Rights Reserved.
  *
  * Permission is hereby granted, free of charge, to any person obtaining a
  * copy of this software and associated documentation files (the &quot;Software&quot;),
@@ -2177,9 +2177,6 @@
       return;
    }
 
-   if (!pixels)
-      return;
-
    _mesa_lock_texture(ctx, texObj);
    {
       texImage = _mesa_select_tex_image(ctx, texObj, target, level);
@@ -2554,8 +2551,8 @@
       }
       else {
          /* no error, set the tex image parameters */
-         _mesa_init_teximage_fields(ctx, target, texImage, width, height, 1,
-                                    border, internalFormat);
+         _mesa_init_teximage_fields(ctx, target, texImage, width, height,
+                                    depth, border, internalFormat);
          texImage-&gt;TexFormat = (*ctx-&gt;Driver.ChooseTextureFormat)(ctx,
                                           internalFormat, format, type);
       }

Modified: haiku/trunk/src/kits/opengl/mesa/main/texobj.c
===================================================================
--- haiku/trunk/src/kits/opengl/mesa/main/texobj.c	2008-04-26 16:20:39 UTC (rev 25188)
+++ haiku/trunk/src/kits/opengl/mesa/main/texobj.c	2008-04-26 16:33:15 UTC (rev 25189)
@@ -854,7 +854,8 @@
             newTexObj = ctx-&gt;Shared-&gt;DefaultRect;
             break;
          default:
-            ; /* Bad targets are caught above */
+            _mesa_error(ctx, GL_INVALID_ENUM, &quot;glBindTexture(target)&quot;);
+            return;
       }
    }
    else {
@@ -926,6 +927,7 @@
          _mesa_reference_texobj(&amp;texUnit-&gt;CurrentRect, newTexObj);
          break;
       default:
+         /* Bad target should be caught above */
          _mesa_problem(ctx, &quot;bad target in BindTexture&quot;);
          return;
    }

Modified: haiku/trunk/src/kits/opengl/mesa/main/texstore.c
===================================================================
--- haiku/trunk/src/kits/opengl/mesa/main/texstore.c	2008-04-26 16:20:39 UTC (rev 25188)
+++ haiku/trunk/src/kits/opengl/mesa/main/texstore.c	2008-04-26 16:33:15 UTC (rev 25189)
@@ -809,6 +809,7 @@
 /*    _mesa_printf(&quot;map %d %d %d %d\n&quot;, map[0], map[1], map[2], map[3]);  */
 
    if (srcRowStride == dstRowStride &amp;&amp;
+       srcComponents == dstComponents &amp;&amp;
        srcRowStride == srcWidth * srcComponents &amp;&amp;
        dimensions &lt; 3) {
       /* 1 and 2D images only */

Modified: haiku/trunk/src/kits/opengl/mesa/main/varray.c
===================================================================
--- haiku/trunk/src/kits/opengl/mesa/main/varray.c	2008-04-26 16:20:39 UTC (rev 25188)
+++ haiku/trunk/src/kits/opengl/mesa/main/varray.c	2008-04-26 16:33:15 UTC (rev 25189)
@@ -443,7 +443,7 @@
 _mesa_VertexAttribPointerNV(GLuint index, GLint size, GLenum type,
                             GLsizei stride, const GLvoid *ptr)
 {
-   const GLboolean normalized = GL_FALSE;
+   GLboolean normalized = GL_FALSE;
    GLsizei elementSize;
    GET_CURRENT_CONTEXT(ctx);
    ASSERT_OUTSIDE_BEGIN_END(ctx);
@@ -471,6 +471,7 @@
    /* check for valid 'type' and compute StrideB right away */
    switch (type) {
       case GL_UNSIGNED_BYTE:
+         normalized = GL_TRUE;
          elementSize = size * sizeof(GLubyte);
          break;
       case GL_SHORT:

Modified: haiku/trunk/src/kits/opengl/mesa/main/version.h
===================================================================
--- haiku/trunk/src/kits/opengl/mesa/main/version.h	2008-04-26 16:20:39 UTC (rev 25188)
+++ haiku/trunk/src/kits/opengl/mesa/main/version.h	2008-04-26 16:33:15 UTC (rev 25189)
@@ -1,8 +1,8 @@
 /*
  * Mesa 3-D graphics library
- * Version:  7.0.2
+ * Version:  7.0.3
  *
- * Copyright (C) 1999-2007  Brian Paul   All Rights Reserved.
+ * Copyright (C) 1999-2008  Brian Paul   All Rights Reserved.
  *
  * Permission is hereby granted, free of charge, to any person obtaining a
  * copy of this software and associated documentation files (the &quot;Software&quot;),
@@ -30,8 +30,8 @@
 /* Mesa version */
 #define MESA_MAJOR 7
 #define MESA_MINOR 0
-#define MESA_PATCH 2
-#define MESA_VERSION_STRING &quot;7.0.2&quot;
+#define MESA_PATCH 3
+#define MESA_VERSION_STRING &quot;7.0.3&quot;
 
 /* To make version comparison easy */
 #define MESA_VERSION(a,b,c) (((a) &lt;&lt; 16) + ((b) &lt;&lt; 8) + (c))

Modified: haiku/trunk/src/kits/opengl/mesa/shader/arbprogparse.c
===================================================================
--- haiku/trunk/src/kits/opengl/mesa/shader/arbprogparse.c	2008-04-26 16:20:39 UTC (rev 25188)
+++ haiku/trunk/src/kits/opengl/mesa/shader/arbprogparse.c	2008-04-26 16:33:15 UTC (rev 25189)
@@ -1609,8 +1609,6 @@
       program_error(ctx, Program-&gt;Position, &quot;Bad attribute binding&quot;);
    }
 
-   Program-&gt;Base.InputsRead |= (1 &lt;&lt; *inputReg);
-
    return err;
 }
 
@@ -1759,7 +1757,7 @@
 {
    GLint idx;
    GLuint err = 0;
-   gl_state_index state_tokens[STATE_LENGTH];
+   gl_state_index state_tokens[STATE_LENGTH] = {0, 0, 0, 0, 0};
    GLfloat const_values[4];
 
    switch (*(*inst)++) {
@@ -2565,6 +2563,11 @@
          return 1;
    }
 
+   /* Add attributes to InputsRead only if they are used the program.
+    * This avoids the handling of unused ATTRIB declarations in the drivers. */
+   if (*File == PROGRAM_INPUT)
+      Program-&gt;Base.InputsRead |= (1 &lt;&lt; *Index);
+
    return 0;
 }
 
@@ -3916,7 +3919,7 @@
    ASSERT(target == GL_VERTEX_PROGRAM_ARB);
 
    if (!_mesa_parse_arb_program(ctx, target, (const GLubyte*) str, len, &amp;ap)) {
-      /* Error in the program. Just return. */
+      _mesa_error(ctx, GL_INVALID_OPERATION, &quot;glProgramString(bad program)&quot;);
       return;
    }
 

Modified: haiku/trunk/src/kits/opengl/mesa/shader/arbprogram.c
===================================================================
--- haiku/trunk/src/kits/opengl/mesa/shader/arbprogram.c	2008-04-26 16:20:39 UTC (rev 25188)
+++ haiku/trunk/src/kits/opengl/mesa/shader/arbprogram.c	2008-04-26 16:33:15 UTC (rev 25189)
@@ -229,7 +229,7 @@
       struct gl_vertex_program *prog = ctx-&gt;VertexProgram.Current;
       _mesa_parse_arb_vertex_program(ctx, target, string, len, prog);
       
-      if (ctx-&gt;Driver.ProgramStringNotify)
+      if (ctx-&gt;Program.ErrorPos == -1 &amp;&amp; ctx-&gt;Driver.ProgramStringNotify)
 	 ctx-&gt;Driver.ProgramStringNotify( ctx, target, &amp;prog-&gt;Base );
    }
    else if (target == GL_FRAGMENT_PROGRAM_ARB
@@ -237,7 +237,7 @@
       struct gl_fragment_program *prog = ctx-&gt;FragmentProgram.Current;
       _mesa_parse_arb_fragment_program(ctx, target, string, len, prog);
 
-      if (ctx-&gt;Driver.ProgramStringNotify)
+      if (ctx-&gt;Program.ErrorPos == -1 &amp;&amp; ctx-&gt;Driver.ProgramStringNotify)
 	 ctx-&gt;Driver.ProgramStringNotify( ctx, target, &amp;prog-&gt;Base );
    }
    else {

Modified: haiku/trunk/src/kits/opengl/mesa/shader/arbprogram_syn.h
===================================================================
--- haiku/trunk/src/kits/opengl/mesa/shader/arbprogram_syn.h	2008-04-26 16:20:39 UTC (rev 25188)
+++ haiku/trunk/src/kits/opengl/mesa/shader/arbprogram_syn.h	2008-04-26 16:33:15 UTC (rev 25189)
@@ -905,6 +905,8 @@
 &quot;stateTexEnvProperty\n&quot;
 &quot; \&quot;color\&quot; .emit TEX_ENV_COLOR;\n&quot;
 &quot;optLegacyTexUnitNum\n&quot;
+&quot; optLegacyTexUnitNum_1 .or .true .emit 0x00;\n&quot;
+&quot;optLegacyTexUnitNum_1\n&quot;
 &quot; lbracket_ne .and legacyTexUnitNum .and rbracket;\n&quot;
 &quot;legacyTexUnitNum\n&quot;
 &quot; integer;\n&quot;
@@ -1221,11 +1223,11 @@
 &quot;white_char\n&quot;
 &quot; ' ' .or '\\t' .or '\\n' .or '\\r';\n&quot;
 &quot;comment_block\n&quot;
-&quot; '#' .and .loop comment_char .and new_line;\n&quot;
+&quot; '#' .and .loop comment_char .and optional_new_line;\n&quot;
 &quot;comment_char\n&quot;
 &quot; '\\x0E'-'\\xFF' .or '\\x01'-'\\x09' .or '\\x0B'-'\\x0C';\n&quot;
-&quot;new_line\n&quot;
-&quot; '\\n' .or crlf .or '\\0';\n&quot;
+&quot;optional_new_line\n&quot;
+&quot; '\\n' .or crlf .or .true;\n&quot;
 &quot;crlf\n&quot;
 &quot; '\\r' .and '\\n';\n&quot;
 &quot;semicolon\n&quot;

Modified: haiku/trunk/src/kits/opengl/mesa/shader/prog_execute.c
===================================================================
--- haiku/trunk/src/kits/opengl/mesa/shader/prog_execute.c	2008-04-26 16:20:39 UTC (rev 25188)
+++ haiku/trunk/src/kits/opengl/mesa/shader/prog_execute.c	2008-04-26 16:33:15 UTC (rev 25189)
@@ -1,6 +1,6 @@
 /*
  * Mesa 3-D graphics library
- * Version:  6.5.3
+ * Version:  7.0.3
  *
  * Copyright (C) 1999-2007  Brian Paul   All Rights Reserved.
  *
@@ -46,9 +46,6 @@
 #include &quot;slang_library_noise.h&quot;
 
 
-/* See comments below for info about this */
-#define LAMBDA_ZERO 1
-
 /* debug predicate */
 #define DEBUG_PROG 0
 
@@ -303,6 +300,36 @@
 
 
 /**
+ * Fetch texel from texture.  Use partial derivatives when possible.
+ */
+static INLINE void
+fetch_texel(GLcontext *ctx,
+            const struct gl_program_machine *machine,
+            const struct prog_instruction *inst,
+            const GLfloat texcoord[4], GLfloat lodBias,
+            GLfloat color[4])
+{
+   /* Note: we only have the right derivatives for fragment input attribs.
+    */
+   if (machine-&gt;NumDeriv &gt; 0 &amp;&amp;
+       inst-&gt;SrcReg[0].File == PROGRAM_INPUT &amp;&amp;
+       inst-&gt;SrcReg[0].Index == FRAG_ATTRIB_TEX0 + inst-&gt;TexSrcUnit) {
+      /* simple texture fetch for which we should have derivatives */
+      GLuint attr = inst-&gt;SrcReg[0].Index;
+      machine-&gt;FetchTexelDeriv(ctx, texcoord,
+                               machine-&gt;DerivX[attr],
+                               machine-&gt;DerivY[attr],
+                               lodBias,
+                               inst-&gt;TexSrcUnit, color);
+   }
+   else {
+      machine-&gt;FetchTexelLod(ctx, texcoord, lodBias,
+                             inst-&gt;TexSrcUnit, color);
+   }
+}
+
+
+/**
  * Test value against zero and return GT, LT, EQ or UN if NaN.
  */
 static INLINE GLuint
@@ -1306,33 +1333,18 @@
          }
          break;
       case OPCODE_TEX:         /* Both ARB and NV frag prog */
-         /* Texel lookup */
+         /* Simple texel lookup */
          {
-            /* Note: only use the precomputed lambda value when we're
-             * sampling texture unit [K] with texcoord[K].
-             * Otherwise, the lambda value may have no relation to the
-             * instruction's texcoord or texture image.  Using the wrong
-             * lambda is usually bad news.
-             * The rest of the time, just use zero (until we get a more
-             * sophisticated way of computing lambda).
-             */
-            GLfloat coord[4], color[4], lambda;
-#if 0
-            if (inst-&gt;SrcReg[0].File == PROGRAM_INPUT &amp;&amp;
-                inst-&gt;SrcReg[0].Index == FRAG_ATTRIB_TEX0 + inst-&gt;TexSrcUnit)
-               lambda = span-&gt;array-&gt;lambda[inst-&gt;TexSrcUnit][column];
-            else
-#endif
-               lambda = 0.0;
-            fetch_vector4(&amp;inst-&gt;SrcReg[0], machine, coord);
-            machine-&gt;FetchTexelLod(ctx, coord, lambda, inst-&gt;TexSrcUnit,
-                                   color);
+            GLfloat texcoord[4], color[4];
+            fetch_vector4(&amp;inst-&gt;SrcReg[0], machine, texcoord);
+
+            fetch_texel(ctx, machine, inst, texcoord, 0.0, color);
+
             if (DEBUG_PROG) {
-               printf(&quot;TEX (%g, %g, %g, %g) = texture[%d][%g, %g, %g, %g], &quot;
-                      &quot;lod %f\n&quot;,
+               printf(&quot;TEX (%g, %g, %g, %g) = texture[%d][%g, %g, %g, %g]\n&quot;,
                       color[0], color[1], color[2], color[3],
                       inst-&gt;TexSrcUnit,
-                      coord[0], coord[1], coord[2], coord[3], lambda);
+                      texcoord[0], texcoord[1], texcoord[2], texcoord[3]);
             }
             store_vector4(inst, machine, color);
          }
@@ -1342,21 +1354,18 @@
          {
             const struct gl_texture_unit *texUnit
                = &amp;ctx-&gt;Texture.Unit[inst-&gt;TexSrcUnit];
-            GLfloat coord[4], color[4], lambda, bias;
-#if 0
-            if (inst-&gt;SrcReg[0].File == PROGRAM_INPUT &amp;&amp;
-                inst-&gt;SrcReg[0].Index == FRAG_ATTRIB_TEX0 + inst-&gt;TexSrcUnit)
-               lambda = span-&gt;array-&gt;lambda[inst-&gt;TexSrcUnit][column];
-            else
-#endif
-               lambda = 0.0;
-            fetch_vector4(&amp;inst-&gt;SrcReg[0], machine, coord);
-            /* coord[3] is the bias to add to lambda */
-            bias = texUnit-&gt;LodBias + coord[3];
-            if (texUnit-&gt;_Current)
-               bias += texUnit-&gt;_Current-&gt;LodBias;
-            machine-&gt;FetchTexelLod(ctx, coord, lambda + bias,
-                                   inst-&gt;TexSrcUnit, color);
+            GLfloat texcoord[4], color[4], lodBias;
+
+            fetch_vector4(&amp;inst-&gt;SrcReg[0], machine, texcoord);
+
+            /* texcoord[3] is the bias to add to lambda */
+            lodBias = texUnit-&gt;LodBias + texcoord[3];
+            if (texUnit-&gt;_Current) {
+               lodBias += texUnit-&gt;_Current-&gt;LodBias;
+            }
+
+            fetch_texel(ctx, machine, inst, texcoord, lodBias, color);
+
             store_vector4(inst, machine, color);
          }
          break;
@@ -1368,6 +1377,7 @@
             fetch_vector4(&amp;inst-&gt;SrcReg[1], machine, dtdx);
             fetch_vector4(&amp;inst-&gt;SrcReg[2], machine, dtdy);
             machine-&gt;FetchTexelDeriv(ctx, texcoord, dtdx, dtdy,
+                                     0.0, /* lodBias */
                                      inst-&gt;TexSrcUnit, color);
             store_vector4(inst, machine, color);
          }
@@ -1375,14 +1385,8 @@
       case OPCODE_TXP:         /* GL_ARB_fragment_program only */
          /* Texture lookup w/ projective divide */
          {
-            GLfloat texcoord[4], color[4], lambda;
-#if 0
-            if (inst-&gt;SrcReg[0].File == PROGRAM_INPUT &amp;&amp;
-                inst-&gt;SrcReg[0].Index == FRAG_ATTRIB_TEX0 + inst-&gt;TexSrcUnit)
-               lambda = span-&gt;array-&gt;lambda[inst-&gt;TexSrcUnit][column];
-            else
-#endif
-               lambda = 0.0;
+            GLfloat texcoord[4], color[4];
+
             fetch_vector4(&amp;inst-&gt;SrcReg[0], machine, texcoord);
             /* Not so sure about this test - if texcoord[3] is
              * zero, we'd probably be fine except for an ASSERT in
@@ -1393,22 +1397,19 @@
                texcoord[1] /= texcoord[3];
                texcoord[2] /= texcoord[3];
             }
-            machine-&gt;FetchTexelLod(ctx, texcoord, lambda,
-                                   inst-&gt;TexSrcUnit, color);
+
+            fetch_texel(ctx, machine, inst, texcoord, 0.0, color);
+
             store_vector4(inst, machine, color);
          }
          break;
       case OPCODE_TXP_NV:      /* GL_NV_fragment_program only */
-         /* Texture lookup w/ projective divide */
+         /* Texture lookup w/ projective divide, as above, but do not
+          * do the divide by w if sampling from a cube map.
+          */
          {
-            GLfloat texcoord[4], color[4], lambda;
-#if 0
-            if (inst-&gt;SrcReg[0].File == PROGRAM_INPUT &amp;&amp;
-                inst-&gt;SrcReg[0].Index == FRAG_ATTRIB_TEX0 + inst-&gt;TexSrcUnit)
-               lambda = span-&gt;array-&gt;lambda[inst-&gt;TexSrcUnit][column];
-            else
-#endif
-               lambda = 0.0;
+            GLfloat texcoord[4], color[4];
+
             fetch_vector4(&amp;inst-&gt;SrcReg[0], machine, texcoord);
             if (inst-&gt;TexSrcTarget != TEXTURE_CUBE_INDEX &amp;&amp;
                 texcoord[3] != 0.0) {
@@ -1416,8 +1417,9 @@
                texcoord[1] /= texcoord[3];
                texcoord[2] /= texcoord[3];
             }
-            machine-&gt;FetchTexelLod(ctx, texcoord, lambda,
-                                   inst-&gt;TexSrcUnit, color);
+
+            fetch_texel(ctx, machine, inst, texcoord, 0.0, color);
+
             store_vector4(inst, machine, color);
          }
          break;

Modified: haiku/trunk/src/kits/opengl/mesa/shader/prog_execute.h
===================================================================
--- haiku/trunk/src/kits/opengl/mesa/shader/prog_execute.h	2008-04-26 16:20:39 UTC (rev 25188)
+++ haiku/trunk/src/kits/opengl/mesa/shader/prog_execute.h	2008-04-26 16:33:15 UTC (rev 25189)
@@ -1,6 +1,6 @@
 /*
  * Mesa 3-D graphics library
- * Version:  6.5.3
+ * Version:  7.0.3
  *
  * Copyright (C) 1999-2007  Brian Paul   All Rights Reserved.
  *
@@ -32,6 +32,7 @@
 typedef void (*FetchTexelDerivFunc)(GLcontext *ctx, const GLfloat texcoord[4],
                                     const GLfloat texdx[4],
                                     const GLfloat texdy[4],
+                                    GLfloat lodBias,
                                     GLuint unit, GLfloat color[4]);
 
 

Modified: haiku/trunk/src/kits/opengl/mesa/shader/prog_parameter.c
===================================================================
--- haiku/trunk/src/kits/opengl/mesa/shader/prog_parameter.c	2008-04-26 16:20:39 UTC (rev 25188)
+++ haiku/trunk/src/kits/opengl/mesa/shader/prog_parameter.c	2008-04-26 16:33:15 UTC (rev 25189)
@@ -384,7 +384,7 @@
  *    PARAM ambient = state.material.front.ambient;
  *
  * \param paramList  the parameter list
- * \param state  an array of 6 (STATE_LENGTH) state tokens
+ * \param stateTokens  an array of 5 (STATE_LENGTH) state tokens
  * \return index of the new parameter.
  */
 GLint

Modified: haiku/trunk/src/kits/opengl/mesa/shader/prog_statevars.c
===================================================================
--- haiku/trunk/src/kits/opengl/mesa/shader/prog_statevars.c	2008-04-26 16:20:39 UTC (rev 25188)
+++ haiku/trunk/src/kits/opengl/mesa/shader/prog_statevars.c	2008-04-26 16:33:15 UTC (rev 25189)
@@ -1,6 +1,6 @@
 /*
  * Mesa 3-D graphics library
- * Version:  7.0
+ * Version:  7.1
  *
  * Copyright (C) 1999-2007  Brian Paul   All Rights Reserved.
  *
@@ -181,7 +181,7 @@
                      ctx-&gt;Light.Material.Attrib[MAT_ATTRIB_FRONT_AMBIENT+face][i];
                }
                /* [3] = material alpha */
-               value[3] = ctx-&gt;Light.Material.Attrib[MAT_ATTRIB_FRONT_DIFFUSE+face][3];
+               value[3] = ctx-&gt;Light.Material.Attrib[MAT_ATTRIB_FRONT_AMBIENT+face][3];
                return;
             case STATE_DIFFUSE:
                for (i = 0; i &lt; 3; i++) {
@@ -197,7 +197,7 @@
                      ctx-&gt;Light.Material.Attrib[MAT_ATTRIB_FRONT_SPECULAR+face][i];
                }
                /* [3] = material alpha */
-               value[3] = ctx-&gt;Light.Material.Attrib[MAT_ATTRIB_FRONT_DIFFUSE+face][3];
+               value[3] = ctx-&gt;Light.Material.Attrib[MAT_ATTRIB_FRONT_SPECULAR+face][3];
                return;
             default:
                _mesa_problem(ctx, &quot;Invalid lightprod state in fetch_state&quot;);
@@ -349,7 +349,7 @@
       value[0] = ctx-&gt;Viewport.Near;                     /* near       */
       value[1] = ctx-&gt;Viewport.Far;                      /* far        */
       value[2] = ctx-&gt;Viewport.Far - ctx-&gt;Viewport.Near; /* far - near */
-      value[3] = 0;
+      value[3] = 1.0;
       return;
    case STATE_FRAGMENT_PROGRAM:
       {
@@ -824,3 +824,94 @@
    }
 }
 
+
+/**
+ * Copy the 16 elements of a matrix into four consecutive program
+ * registers starting at 'pos'.
+ */
+static void
+load_matrix(GLfloat registers[][4], GLuint pos, const GLfloat mat[16])
+{
+   GLuint i;
+   for (i = 0; i &lt; 4; i++) {
+      registers[pos + i][0] = mat[0 + i];
+      registers[pos + i][1] = mat[4 + i];
+      registers[pos + i][2] = mat[8 + i];
+      registers[pos + i][3] = mat[12 + i];
+   }
+}
+
+
+/**
+ * As above, but transpose the matrix.
+ */
+static void
+load_transpose_matrix(GLfloat registers[][4], GLuint pos,
+                      const GLfloat mat[16])
+{
+   MEMCPY(registers[pos], mat, 16 * sizeof(GLfloat));
+}
+
+
+/**

[... truncated: 2669 lines follow ...]

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="008226.html">[Haiku-commits] r25188 - haiku/vendor/mesa
</A></li>
	<LI>Next message: <A HREF="008228.html">[Haiku-commits] r25190 - in haiku/trunk: build/jam data data/bin
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#8227">[ date ]</a>
              <a href="thread.html#8227">[ thread ]</a>
              <a href="subject.html#8227">[ subject ]</a>
              <a href="author.html#8227">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/haiku-commits">More information about the Haiku-commits
mailing list</a><br>
</body></html>
