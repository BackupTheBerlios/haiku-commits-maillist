<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Haiku-commits] r24758 - in haiku/trunk: headers/libs/png	src/libs/png
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/haiku-commits/2008-April/index.html" >
   <LINK REL="made" HREF="mailto:haiku-commits%40lists.berlios.de?Subject=Re%3A%20%5BHaiku-commits%5D%20r24758%20-%20in%20haiku/trunk%3A%20headers/libs/png%0A%09src/libs/png&In-Reply-To=%3C200804022058.m32KwtUN003855%40sheep.berlios.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="007396.html">
   <LINK REL="Next"  HREF="007399.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Haiku-commits] r24758 - in haiku/trunk: headers/libs/png	src/libs/png</H1>
    <B>korli at BerliOS</B> 
    <A HREF="mailto:haiku-commits%40lists.berlios.de?Subject=Re%3A%20%5BHaiku-commits%5D%20r24758%20-%20in%20haiku/trunk%3A%20headers/libs/png%0A%09src/libs/png&In-Reply-To=%3C200804022058.m32KwtUN003855%40sheep.berlios.de%3E"
       TITLE="[Haiku-commits] r24758 - in haiku/trunk: headers/libs/png	src/libs/png">korli at mail.berlios.de
       </A><BR>
    <I>Wed Apr  2 22:58:55 CEST 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="007396.html">[Haiku-commits] r24757 - in haiku/trunk: . build/jam
</A></li>
        <LI>Next message: <A HREF="007399.html">[Haiku-commits] r24759 - haiku/trunk/src/system/kernel/fs
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#7398">[ date ]</a>
              <a href="thread.html#7398">[ thread ]</a>
              <a href="subject.html#7398">[ subject ]</a>
              <a href="author.html#7398">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: korli
Date: 2008-04-02 22:58:54 +0200 (Wed, 02 Apr 2008)
New Revision: 24758
ViewCVS: <A HREF="http://svn.berlios.de/viewcvs/haiku?rev=24758&amp;view=rev">http://svn.berlios.de/viewcvs/haiku?rev=24758&amp;view=rev</A>

Modified:
   haiku/trunk/headers/libs/png/png.h
   haiku/trunk/headers/libs/png/pngconf.h
   haiku/trunk/src/libs/png/png.c
   haiku/trunk/src/libs/png/pngerror.c
   haiku/trunk/src/libs/png/pngmem.c
   haiku/trunk/src/libs/png/pngpread.c
   haiku/trunk/src/libs/png/pngread.c
   haiku/trunk/src/libs/png/pngrtran.c
   haiku/trunk/src/libs/png/pngrutil.c
   haiku/trunk/src/libs/png/pngset.c
   haiku/trunk/src/libs/png/pngwrite.c
   haiku/trunk/src/libs/png/pngwutil.c
Log:
updated libpng to 1.2.26


Modified: haiku/trunk/headers/libs/png/png.h
===================================================================
--- haiku/trunk/headers/libs/png/png.h	2008-04-02 20:29:43 UTC (rev 24757)
+++ haiku/trunk/headers/libs/png/png.h	2008-04-02 20:58:54 UTC (rev 24758)
@@ -1,15 +1,15 @@
 
 /* png.h - header file for PNG reference library
  *
- * libpng version 1.2.22 - October 13, 2007
- * Copyright (c) 1998-2007 Glenn Randers-Pehrson
+ * libpng version 1.2.26 - April 2, 2008
+ * Copyright (c) 1998-2008 Glenn Randers-Pehrson
  * (Version 0.96 Copyright (c) 1996, 1997 Andreas Dilger)
  * (Version 0.88 Copyright (c) 1995, 1996 Guy Eric Schalnat, Group 42, Inc.)
  *
  * Authors and maintainers:
  *  libpng versions 0.71, May 1995, through 0.88, January 1996: Guy Schalnat
  *  libpng versions 0.89c, June 1996, through 0.96, May 1997: Andreas Dilger
- *  libpng versions 0.97, January 1998, through 1.2.22 - October 13, 2007: Glenn
+ *  libpng versions 0.97, January 1998, through 1.2.26 - April 2, 2008: Glenn
  *  See also &quot;Contributing Authors&quot;, below.
  *
  * Note about libpng version numbers:
@@ -169,6 +169,18 @@
  *    1.2.22rc1               13    10222  12.so.0.22[.0]
  *    1.0.30                  10    10030  10.so.0.30[.0]
  *    1.2.22                  13    10222  12.so.0.22[.0]
+ *    1.2.23beta01-05         13    10223  12.so.0.23[.0]
+ *    1.2.23rc01              13    10223  12.so.0.23[.0]
+ *    1.2.23                  13    10223  12.so.0.23[.0]
+ *    1.2.24beta01-02         13    10224  12.so.0.24[.0]
+ *    1.2.24rc01              13    10224  12.so.0.24[.0]
+ *    1.2.24                  13    10224  12.so.0.24[.0]
+ *    1.2.25beta01-06         13    10225  12.so.0.25[.0]
+ *    1.2.25rc01-02           13    10225  12.so.0.25[.0]
+ *    1.0.31                  10    10031  10.so.0.31[.0]
+ *    1.2.25                  13    10225  12.so.0.25[.0]
+ *    1.2.26beta01-06         13    10226  12.so.0.26[.0]
+ *    1.2.26rc01              13    10226  12.so.0.26[.0]
  *
  *    Henceforth the source version will match the shared-library major
  *    and minor numbers; the shared-library major version number will be
@@ -198,8 +210,8 @@
  * If you modify libpng you may insert additional notices immediately following
  * this sentence.
  *
- * libpng versions 1.2.6, August 15, 2004, through 1.2.22, October 13, 2007, are
- * Copyright (c) 2004, 2006-2007 Glenn Randers-Pehrson, and are
+ * libpng versions 1.2.6, August 15, 2004, through 1.2.26, April 2, 2008, are
+ * Copyright (c) 2004, 2006-2008 Glenn Randers-Pehrson, and are
  * distributed according to the same disclaimer and license as libpng-1.2.5
  * with the following individual added to the list of Contributing Authors:
  *
@@ -310,13 +322,13 @@
  * Y2K compliance in libpng:
  * =========================
  *
- *    October 13, 2007
+ *    April 2, 2008
  *
  *    Since the PNG Development group is an ad-hoc body, we can't make
  *    an official declaration.
  *
  *    This is your unofficial assurance that libpng from version 0.71 and
- *    upward through 1.2.22 are Y2K compliant.  It is my belief that earlier
+ *    upward through 1.2.26 are Y2K compliant.  It is my belief that earlier
  *    versions were also Y2K compliant.
  *
  *    Libpng only has three year fields.  One is a 2-byte unsigned integer
@@ -372,9 +384,9 @@
  */
 
 /* Version information for png.h - this should match the version in png.c */
-#define PNG_LIBPNG_VER_STRING &quot;1.2.22&quot;
+#define PNG_LIBPNG_VER_STRING &quot;1.2.26&quot;
 #define PNG_HEADER_VERSION_STRING \
-   &quot; libpng version 1.2.22 - October 13, 2007\n&quot;
+   &quot; libpng version 1.2.26 - April 2, 2008\n&quot;
 
 #define PNG_LIBPNG_VER_SONUM   0
 #define PNG_LIBPNG_VER_DLLNUM  13
@@ -382,7 +394,7 @@
 /* These should match the first 3 components of PNG_LIBPNG_VER_STRING: */
 #define PNG_LIBPNG_VER_MAJOR   1
 #define PNG_LIBPNG_VER_MINOR   2
-#define PNG_LIBPNG_VER_RELEASE 22
+#define PNG_LIBPNG_VER_RELEASE 26
 /* This should match the numeric part of the final component of
  * PNG_LIBPNG_VER_STRING, omitting any leading zero: */
 
@@ -410,7 +422,7 @@
  * Versions 0.7 through 1.0.0 were in the range 0 to 100 here (only
  * version 1.0.0 was mis-numbered 100 instead of 10000).  From
  * version 1.0.1 it's    xxyyzz, where x=major, y=minor, z=release */
-#define PNG_LIBPNG_VER 10222 /* 1.2.22 */
+#define PNG_LIBPNG_VER 10226 /* 1.2.26 */
 
 #ifndef PNG_VERSION_INFO_ONLY
 /* include the compression library's header */
@@ -651,9 +663,10 @@
  * up private chunks for output even though the library doesn't actually
  * know about their semantics.
  */
+#define PNG_CHUNK_NAME_LENGTH 5
 typedef struct png_unknown_chunk_t
 {
-    png_byte name[5];
+    png_byte name[PNG_CHUNK_NAME_LENGTH];
     png_byte *data;
     png_size_t size;
 
@@ -1180,10 +1193,12 @@
    png_uint_32 row_number;    /* current row in interlace pass */
    png_bytep prev_row;        /* buffer to save previous (unfiltered) row */
    png_bytep row_buf;         /* buffer to save current (unfiltered) row */
+#ifndef PNG_NO_WRITE_FILTERING
    png_bytep sub_row;         /* buffer to save &quot;sub&quot; row when filtering */
    png_bytep up_row;          /* buffer to save &quot;up&quot; row when filtering */
    png_bytep avg_row;         /* buffer to save &quot;avg&quot; row when filtering */
    png_bytep paeth_row;       /* buffer to save &quot;Paeth&quot; row when filtering */
+#endif
    png_row_info row_info;     /* used for transformation routines */
 
    png_uint_32 idat_size;     /* current IDAT size for read */
@@ -1415,13 +1430,16 @@
    /* storage for unknown chunk that the library doesn't recognize. */
    png_unknown_chunk unknown_chunk;
 #endif
+
+/* New members added in libpng-1.2.26 */
+  png_uint_32 old_big_row_buf_size, old_prev_row_size;
 };
 
 
 /* This triggers a compiler error in png.c, if png.c and png.h
  * do not agree upon the version number.
  */
-typedef png_structp version_1_2_22;
+typedef png_structp version_1_2_26;
 
 typedef png_struct FAR * FAR * png_structpp;
 

Modified: haiku/trunk/headers/libs/png/pngconf.h
===================================================================
--- haiku/trunk/headers/libs/png/pngconf.h	2008-04-02 20:29:43 UTC (rev 24757)
+++ haiku/trunk/headers/libs/png/pngconf.h	2008-04-02 20:58:54 UTC (rev 24758)
@@ -1,9 +1,9 @@
 
 /* pngconf.h - machine configurable file for libpng
  *
- * libpng version 1.2.22 - October 13, 2007
+ * libpng version 1.2.26 - April 2, 2008
  * For conditions of distribution and use, see copyright notice in png.h
- * Copyright (c) 1998-2007 Glenn Randers-Pehrson
+ * Copyright (c) 1998-2008 Glenn Randers-Pehrson
  * (Version 0.96 Copyright (c) 1996, 1997 Andreas Dilger)
  * (Version 0.88 Copyright (c) 1995, 1996 Guy Eric Schalnat, Group 42, Inc.)
  */
@@ -323,7 +323,7 @@
      /* If you encounter a compiler error here, see the explanation
       * near the end of INSTALL.
       */
-         __png.h__ already includes setjmp.h;
+         __pngconf.h__ already includes setjmp.h;
          __dont__ include it again.;
 #    endif
 #  endif /* __linux__ */
@@ -333,7 +333,9 @@
 
 #  ifdef __linux__
 #    ifdef PNG_SAVE_BSD_SOURCE
-#      define _BSD_SOURCE
+#      ifndef _BSD_SOURCE
+#        define _BSD_SOURCE
+#      endif
 #      undef PNG_SAVE_BSD_SOURCE
 #    endif
 #  endif /* __linux__ */
@@ -1430,8 +1432,6 @@
 #  define CVT_PTR(ptr) (png_far_to_near(png_ptr,ptr,CHECK))
 #  define CVT_PTR_NOCHECK(ptr) (png_far_to_near(png_ptr,ptr,NOCHECK))
 #  define png_snprintf _fsnprintf   /* Added to v 1.2.19 */
-#  define png_strcpy  _fstrcpy
-#  define png_strncpy _fstrncpy   /* Added to v 1.2.6 */
 #  define png_strlen  _fstrlen
 #  define png_memcmp  _fmemcmp    /* SJT: added */
 #  define png_memcpy  _fmemcpy
@@ -1460,8 +1460,6 @@
 #    define png_snprintf6(s1,n,fmt,x1,x2,x3,x4,x5,x6) \
         sprintf(s1,fmt,x1,x2,x3,x4,x5,x6)
 #  endif
-#  define png_strcpy  strcpy
-#  define png_strncpy strncpy     /* Added to v 1.2.6 */
 #  define png_strlen  strlen
 #  define png_memcmp  memcmp      /* SJT: added */
 #  define png_memcpy  memcpy

Modified: haiku/trunk/src/libs/png/png.c
===================================================================
--- haiku/trunk/src/libs/png/png.c	2008-04-02 20:29:43 UTC (rev 24757)
+++ haiku/trunk/src/libs/png/png.c	2008-04-02 20:58:54 UTC (rev 24758)
@@ -13,7 +13,7 @@
 #include &quot;png.h&quot;
 
 /* Generate a compiler error if there is an old png.h in the search path. */
-typedef version_1_2_22 Your_png_h_is_not_version_1_2_22;
+typedef version_1_2_26 Your_png_h_is_not_version_1_2_26;
 
 /* Version information for C files.  This had better match the version
  * string defined in png.h.  */
@@ -693,8 +693,8 @@
 png_get_copyright(png_structp png_ptr)
 {
    png_ptr = png_ptr;  /* silence compiler warning about unused png_ptr */
-   return ((png_charp) &quot;\n libpng version 1.2.22 - October 13, 2007\n\
-   Copyright (c) 1998-2007 Glenn Randers-Pehrson\n\
+   return ((png_charp) &quot;\n libpng version 1.2.26 - April 2, 2008\n\
+   Copyright (c) 1998-2008 Glenn Randers-Pehrson\n\
    Copyright (c) 1996-1997 Andreas Dilger\n\
    Copyright (c) 1995-1996 Guy Eric Schalnat, Group 42, Inc.\n&quot;);
 }

Modified: haiku/trunk/src/libs/png/pngerror.c
===================================================================
--- haiku/trunk/src/libs/png/pngerror.c	2008-04-02 20:29:43 UTC (rev 24757)
+++ haiku/trunk/src/libs/png/pngerror.c	2008-04-02 20:58:54 UTC (rev 24758)
@@ -136,6 +136,8 @@
    'A', 'B', 'C', 'D', 'E', 'F'
 };
 
+#define PNG_MAX_ERROR_TEXT 64
+
 #if !defined(PNG_NO_WARNINGS) || !defined(PNG_NO_ERROR_TEXT)
 static void /* PRIVATE */
 png_format_buffer(png_structp png_ptr, png_charp buffer, png_const_charp
@@ -165,8 +167,8 @@
    {
       buffer[iout++] = ':';
       buffer[iout++] = ' ';
-      png_strncpy(buffer+iout, error_message, 63);
-      buffer[iout+63] = '\0';
+      png_memcpy(buffer+iout, error_message, PNG_MAX_ERROR_TEXT);
+      buffer[iout+PNG_MAX_ERROR_TEXT-1] = '\0';
    }
 }
 
@@ -174,7 +176,7 @@
 void PNGAPI
 png_chunk_error(png_structp png_ptr, png_const_charp error_message)
 {
-   char msg[18+64];
+   char msg[18+PNG_MAX_ERROR_TEXT];
    if (png_ptr == NULL)
      png_error(png_ptr, error_message);
    else
@@ -190,7 +192,7 @@
 void PNGAPI
 png_chunk_warning(png_structp png_ptr, png_const_charp warning_message)
 {
-   char msg[18+64];
+   char msg[18+PNG_MAX_ERROR_TEXT];
    if (png_ptr == NULL)
      png_warning(png_ptr, warning_message);
    else

Modified: haiku/trunk/src/libs/png/pngmem.c
===================================================================
--- haiku/trunk/src/libs/png/pngmem.c	2008-04-02 20:29:43 UTC (rev 24757)
+++ haiku/trunk/src/libs/png/pngmem.c	2008-04-02 20:58:54 UTC (rev 24758)
@@ -1,9 +1,9 @@
 
 /* pngmem.c - stub functions for memory allocation
  *
- * Last changed in libpng 1.2.13 November 13, 2006
+ * Last changed in libpng 1.2.26 [April 2, 2008]
  * For conditions of distribution and use, see copyright notice in png.h
- * Copyright (c) 1998-2006 Glenn Randers-Pehrson
+ * Copyright (c) 1998-2008 Glenn Randers-Pehrson
  * (Version 0.96 Copyright (c) 1996, 1997 Andreas Dilger)
  * (Version 0.88 Copyright (c) 1995, 1996 Guy Eric Schalnat, Group 42, Inc.)
  *
@@ -456,7 +456,7 @@
    if (size &gt; (png_uint_32)65536L)
    {
 #ifndef PNG_USER_MEM_SUPPORTED
-      if(png_ptr-&gt;flags&amp;PNG_FLAG_MALLOC_NULL_MEM_OK) == 0)
+      if ((png_ptr-&gt;flags&amp;PNG_FLAG_MALLOC_NULL_MEM_OK) == 0)
          png_error(png_ptr, &quot;Cannot Allocate &gt; 64K&quot;);
       else
 #endif

Modified: haiku/trunk/src/libs/png/pngpread.c
===================================================================
--- haiku/trunk/src/libs/png/pngpread.c	2008-04-02 20:29:43 UTC (rev 24757)
+++ haiku/trunk/src/libs/png/pngpread.c	2008-04-02 20:58:54 UTC (rev 24758)
@@ -1,9 +1,9 @@
 
 /* pngpread.c - read a png file in push mode
  *
- * Last changed in libpng 1.2.22 [October 13, 2007]
+ * Last changed in libpng 1.2.26 [April 2, 2008]
  * For conditions of distribution and use, see copyright notice in png.h
- * Copyright (c) 1998-2007 Glenn Randers-Pehrson
+ * Copyright (c) 1998-2008 Glenn Randers-Pehrson
  * (Version 0.96 Copyright (c) 1996, 1997 Andreas Dilger)
  * (Version 0.88 Copyright (c) 1995, 1996 Guy Eric Schalnat, Group 42, Inc.)
  */
@@ -28,7 +28,7 @@
 png_process_data(png_structp png_ptr, png_infop info_ptr,
    png_bytep buffer, png_size_t buffer_size)
 {
-   if(png_ptr == NULL) return;
+   if(png_ptr == NULL || info_ptr == NULL) return;
    png_push_restore_buffer(png_ptr, buffer, buffer_size);
 
    while (png_ptr-&gt;buffer_size)
@@ -224,6 +224,8 @@
    {
       if (png_ptr-&gt;push_length + 4 &gt; png_ptr-&gt;buffer_size)
       {
+         if (png_ptr-&gt;push_length != 13)
+            png_error(png_ptr, &quot;Invalid IHDR length&quot;);
          png_push_save_buffer(png_ptr);
          return;
       }
@@ -1018,33 +1020,38 @@
          png_ptr-&gt;rowbytes + 1);
       do
       {
-         png_ptr-&gt;pass++;
-         if ((png_ptr-&gt;pass == 1 &amp;&amp; png_ptr-&gt;width &lt; 5) ||
-             (png_ptr-&gt;pass == 3 &amp;&amp; png_ptr-&gt;width &lt; 3) ||
-             (png_ptr-&gt;pass == 5 &amp;&amp; png_ptr-&gt;width &lt; 2))
-           png_ptr-&gt;pass++;
+         int pass;
+         pass = png_ptr-&gt;pass;
+         pass++;
+         if ((pass == 1 &amp;&amp; png_ptr-&gt;width &lt; 5) ||
+             (pass == 3 &amp;&amp; png_ptr-&gt;width &lt; 3) ||
+             (pass == 5 &amp;&amp; png_ptr-&gt;width &lt; 2))
+           pass++;
 
-         if (png_ptr-&gt;pass &gt; 7)
-            png_ptr-&gt;pass--;
-         if (png_ptr-&gt;pass &gt;= 7)
-            break;
+         if (pass &gt; 7)
+            pass--;
+         png_ptr-&gt;pass = (png_byte) pass;
+         if (pass &lt; 7)
+           {
+             png_ptr-&gt;iwidth = (png_ptr-&gt;width +
+                png_pass_inc[pass] - 1 -
+                png_pass_start[pass]) /
+                png_pass_inc[pass];
 
-         png_ptr-&gt;iwidth = (png_ptr-&gt;width +
-            png_pass_inc[png_ptr-&gt;pass] - 1 -
-            png_pass_start[png_ptr-&gt;pass]) /
-            png_pass_inc[png_ptr-&gt;pass];
+             png_ptr-&gt;irowbytes = PNG_ROWBYTES(png_ptr-&gt;pixel_depth,
+                png_ptr-&gt;iwidth) + 1;
 
-         png_ptr-&gt;irowbytes = PNG_ROWBYTES(png_ptr-&gt;pixel_depth,
-            png_ptr-&gt;iwidth) + 1;
+             if (png_ptr-&gt;transformations &amp; PNG_INTERLACE)
+                break;
 
-         if (png_ptr-&gt;transformations &amp; PNG_INTERLACE)
-            break;
+             png_ptr-&gt;num_rows = (png_ptr-&gt;height +
+                png_pass_yinc[pass] - 1 -
+                png_pass_ystart[pass]) /
+                png_pass_yinc[pass];
+           }
+         else
+           break;
 
-         png_ptr-&gt;num_rows = (png_ptr-&gt;height +
-            png_pass_yinc[png_ptr-&gt;pass] - 1 -
-            png_pass_ystart[png_ptr-&gt;pass]) /
-            png_pass_yinc[png_ptr-&gt;pass];
-
       } while (png_ptr-&gt;iwidth == 0 || png_ptr-&gt;num_rows == 0);
    }
 }
@@ -1490,9 +1497,11 @@
           length = (png_uint_32)65535L;
       }
 #endif
-      png_strncpy((png_charp)png_ptr-&gt;unknown_chunk.name,
-	 (png_charp)png_ptr-&gt;chunk_name, 4);
-      png_ptr-&gt;unknown_chunk.name[4] = '\0';
+      png_memcpy((png_charp)png_ptr-&gt;unknown_chunk.name,
+                 (png_charp)png_ptr-&gt;chunk_name, 
+                 png_sizeof(png_ptr-&gt;unknown_chunk.name));
+      png_ptr-&gt;unknown_chunk.name[png_sizeof(png_ptr-&gt;unknown_chunk.name)-1]='\0';
+
       png_ptr-&gt;unknown_chunk.data = (png_bytep)png_malloc(png_ptr, length);
       png_ptr-&gt;unknown_chunk.size = (png_size_t)length;
       png_crc_read(png_ptr, (png_bytep)png_ptr-&gt;unknown_chunk.data, length);
@@ -1515,9 +1524,9 @@
                &amp;png_ptr-&gt;unknown_chunk, 1);
          }
       }
-#else
-      png_set_unknown_chunks(png_ptr, info_ptr, &amp;png_ptr-&gt;unknown_chunk, 1);
+      else
 #endif
+        png_set_unknown_chunks(png_ptr, info_ptr, &amp;png_ptr-&gt;unknown_chunk, 1);
       png_free(png_ptr, png_ptr-&gt;unknown_chunk.data);
       png_ptr-&gt;unknown_chunk.data = NULL;
    }

Modified: haiku/trunk/src/libs/png/pngread.c
===================================================================
--- haiku/trunk/src/libs/png/pngread.c	2008-04-02 20:29:43 UTC (rev 24757)
+++ haiku/trunk/src/libs/png/pngread.c	2008-04-02 20:58:54 UTC (rev 24758)
@@ -1,9 +1,9 @@
 
 /* pngread.c - read a PNG file
  *
- * Last changed in libpng 1.2.20 September 7, 2007
+ * Last changed in libpng 1.2.25 [February 18, 2008]
  * For conditions of distribution and use, see copyright notice in png.h
- * Copyright (c) 1998-2007 Glenn Randers-Pehrson
+ * Copyright (c) 1998-2008 Glenn Randers-Pehrson
  * (Version 0.96 Copyright (c) 1996, 1997 Andreas Dilger)
  * (Version 0.88 Copyright (c) 1995, 1996 Guy Eric Schalnat, Group 42, Inc.)
  *
@@ -89,12 +89,18 @@
 
    png_set_error_fn(png_ptr, error_ptr, error_fn, warn_fn);
 
-   i=0;
-   do
+   if(user_png_ver)
    {
-     if(user_png_ver[i] != png_libpng_ver[i])
+     i=0;
+     do
+     {
+       if(user_png_ver[i] != png_libpng_ver[i])
+          png_ptr-&gt;flags |= PNG_FLAG_LIBRARY_MISMATCH;
+     } while (png_libpng_ver[i++]);
+   }
+   else
         png_ptr-&gt;flags |= PNG_FLAG_LIBRARY_MISMATCH;
-   } while (png_libpng_ver[i++]);
+   
 
    if (png_ptr-&gt;flags &amp; PNG_FLAG_LIBRARY_MISMATCH)
    {
@@ -318,7 +324,7 @@
 void PNGAPI
 png_read_info(png_structp png_ptr, png_infop info_ptr)
 {
-   if(png_ptr == NULL) return;
+   if(png_ptr == NULL || info_ptr == NULL) return;
    png_debug(1, &quot;in png_read_info\n&quot;);
    /* If we haven't checked all of the PNG signature bytes, do so now. */
    if (png_ptr-&gt;sig_bytes &lt; 8)
@@ -1099,25 +1105,29 @@
    png_structp png_ptr = NULL;
    png_infop info_ptr = NULL, end_info_ptr = NULL;
 #ifdef PNG_USER_MEM_SUPPORTED
-   png_free_ptr free_fn;
-   png_voidp mem_ptr;
+   png_free_ptr free_fn = NULL;
+   png_voidp mem_ptr = NULL;
 #endif
 
    png_debug(1, &quot;in png_destroy_read_struct\n&quot;);
    if (png_ptr_ptr != NULL)
+   {
       png_ptr = *png_ptr_ptr;
+   }
+   if (png_ptr == NULL)
+      return;
 
+#ifdef PNG_USER_MEM_SUPPORTED
+   free_fn = png_ptr-&gt;free_fn;
+   mem_ptr = png_ptr-&gt;mem_ptr;
+#endif
+
    if (info_ptr_ptr != NULL)
       info_ptr = *info_ptr_ptr;
 
    if (end_info_ptr_ptr != NULL)
       end_info_ptr = *end_info_ptr_ptr;
 
-#ifdef PNG_USER_MEM_SUPPORTED
-   free_fn = png_ptr-&gt;free_fn;
-   mem_ptr = png_ptr-&gt;mem_ptr;
-#endif
-
    png_read_destroy(png_ptr, info_ptr, end_info_ptr);
 
    if (info_ptr != NULL)
@@ -1149,16 +1159,13 @@
       *end_info_ptr_ptr = NULL;
    }
 
-   if (png_ptr != NULL)
-   {
 #ifdef PNG_USER_MEM_SUPPORTED
-      png_destroy_struct_2((png_voidp)png_ptr, (png_free_ptr)free_fn,
-          (png_voidp)mem_ptr);
+   png_destroy_struct_2((png_voidp)png_ptr, (png_free_ptr)free_fn,
+       (png_voidp)mem_ptr);
 #else
-      png_destroy_struct((png_voidp)png_ptr);
+   png_destroy_struct((png_voidp)png_ptr);
 #endif
-      *png_ptr_ptr = NULL;
-   }
+   *png_ptr_ptr = NULL;
 }
 
 /* free all memory used by the read (old method) */

Modified: haiku/trunk/src/libs/png/pngrtran.c
===================================================================
--- haiku/trunk/src/libs/png/pngrtran.c	2008-04-02 20:29:43 UTC (rev 24757)
+++ haiku/trunk/src/libs/png/pngrtran.c	2008-04-02 20:58:54 UTC (rev 24758)
@@ -1,9 +1,9 @@
 
 /* pngrtran.c - transforms the data in a row for PNG readers
  *
- * Last changed in libpng 1.2.22 [October 13, 2007]
+ * Last changed in libpng 1.2.25 [February 18, 2008]
  * For conditions of distribution and use, see copyright notice in png.h
- * Copyright (c) 1998-2007 Glenn Randers-Pehrson
+ * Copyright (c) 1998-2008 Glenn Randers-Pehrson
  * (Version 0.96 Copyright (c) 1996, 1997 Andreas Dilger)
  * (Version 0.88 Copyright (c) 1995, 1996 Guy Eric Schalnat, Group 42, Inc.)
  *
@@ -964,6 +964,14 @@
                   palette[i].blue = png_ptr-&gt;gamma_table[palette[i].blue];
                }
             }
+	    /* Prevent the transformations being done again, and make sure
+	     * that the now spurious alpha channel is stripped - the code
+	     * has just reduced background composition and gamma correction
+	     * to a simply alpha channel strip.
+	     */
+	    png_ptr-&gt;transformations &amp;= ~PNG_BACKGROUND;
+	    png_ptr-&gt;transformations &amp;= ~PNG_GAMMA;
+	    png_ptr-&gt;transformations |= PNG_STRIP_ALPHA;
          }
          /* if (png_ptr-&gt;background_gamma_type!=PNG_BACKGROUND_GAMMA_UNKNOWN) */
          else
@@ -1038,6 +1046,9 @@
             palette[i].green = png_ptr-&gt;gamma_table[palette[i].green];
             palette[i].blue = png_ptr-&gt;gamma_table[palette[i].blue];
          }
+
+	 /* Done the gamma correction. */
+	 png_ptr-&gt;transformations &amp;= ~PNG_GAMMA;
       }
    }
 #if defined(PNG_READ_BACKGROUND_SUPPORTED)
@@ -1075,6 +1086,10 @@
                png_ptr-&gt;trans[i], back.blue);
          }
       }
+
+      /* Handled alpha, still need to strip the channel. */
+      png_ptr-&gt;transformations &amp;= ~PNG_BACKGROUND;
+      png_ptr-&gt;transformations |= PNG_STRIP_ALPHA;
    }
 #endif /* PNG_READ_BACKGROUND_SUPPORTED */
 

Modified: haiku/trunk/src/libs/png/pngrutil.c
===================================================================
--- haiku/trunk/src/libs/png/pngrutil.c	2008-04-02 20:29:43 UTC (rev 24757)
+++ haiku/trunk/src/libs/png/pngrutil.c	2008-04-02 20:58:54 UTC (rev 24758)
@@ -1,9 +1,9 @@
 
 /* pngrutil.c - utilities to read a PNG file
  *
- * Last changed in libpng 1.2.22 [October 13, 2007]
+ * Last changed in libpng 1.2.26 [April 2, 2008]
  * For conditions of distribution and use, see copyright notice in png.h
- * Copyright (c) 1998-2007 Glenn Randers-Pehrson
+ * Copyright (c) 1998-2008 Glenn Randers-Pehrson
  * (Version 0.96 Copyright (c) 1996, 1997 Andreas Dilger)
  * (Version 0.88 Copyright (c) 1995, 1996 Guy Eric Schalnat, Group 42, Inc.)
  *
@@ -230,7 +230,7 @@
             text_size = (png_size_t)(chunklength - (text - chunkdata) - 1);
             text_size = png_sizeof(msg) &gt; text_size ? text_size :
                png_sizeof(msg);
-            png_memcpy(text + prefix_size, msg, text_size + 1);
+            png_memcpy(text + prefix_size, msg, text_size);
             break;
          }
          if (!png_ptr-&gt;zstream.avail_out || ret == Z_STREAM_END)
@@ -1393,7 +1393,7 @@
    if (png_ptr-&gt;color_type == PNG_COLOR_TYPE_PALETTE)
    {
       png_ptr-&gt;background.index = buf[0];
-      if(info_ptr-&gt;num_palette)
+      if (info_ptr &amp;&amp; info_ptr-&gt;num_palette)
       {
           if(buf[0] &gt; info_ptr-&gt;num_palette)
           {
@@ -1792,7 +1792,7 @@
 #else
 #ifdef PNG_FIXED_POINT_SUPPORTED
    sheight = (png_charp)png_malloc_warn(png_ptr, png_strlen(ep) + 1);
-   if (swidth == NULL)
+   if (sheight == NULL)
      {
        png_warning(png_ptr, &quot;Out of memory while processing sCAL chunk height&quot;);
        return;
@@ -2223,9 +2223,10 @@
            length = (png_uint_32)65535L;
        }
 #endif
-       png_strncpy((png_charp)png_ptr-&gt;unknown_chunk.name,
-	 (png_charp)png_ptr-&gt;chunk_name, 4);
-       png_ptr-&gt;unknown_chunk.name[4] = '\0';
+       png_memcpy((png_charp)png_ptr-&gt;unknown_chunk.name,
+                  (png_charp)png_ptr-&gt;chunk_name, 
+                  png_sizeof(png_ptr-&gt;unknown_chunk.name));
+       png_ptr-&gt;unknown_chunk.name[png_sizeof(png_ptr-&gt;unknown_chunk.name)-1] = '\0';
        png_ptr-&gt;unknown_chunk.data = (png_bytep)png_malloc(png_ptr, length);
        png_ptr-&gt;unknown_chunk.size = (png_size_t)length;
        png_crc_read(png_ptr, (png_bytep)png_ptr-&gt;unknown_chunk.data, length);
@@ -2248,9 +2249,9 @@
                &amp;png_ptr-&gt;unknown_chunk, 1);
           }
        }
-#else
-       png_set_unknown_chunks(png_ptr, info_ptr, &amp;png_ptr-&gt;unknown_chunk, 1);
+       else
 #endif
+         png_set_unknown_chunks(png_ptr, info_ptr, &amp;png_ptr-&gt;unknown_chunk, 1);
        png_free(png_ptr, png_ptr-&gt;unknown_chunk.data);
        png_ptr-&gt;unknown_chunk.data = NULL;
    }
@@ -2850,6 +2851,7 @@
 png_read_finish_row(png_structp png_ptr)
 {
 #ifdef PNG_USE_LOCAL_ARRAYS
+#ifdef PNG_READ_INTERLACING_SUPPORTED
    /* arrays to facilitate easy interlacing - use pass (0 - 6) as index */
 
    /* start of interlace block */
@@ -2863,6 +2865,7 @@
 
    /* offset to next interlace block in the y direction */
    PNG_CONST int png_pass_yinc[7] = {8, 8, 8, 4, 4, 2, 2};
+#endif /* PNG_READ_INTERLACING_SUPPORTED */
 #endif
 
    png_debug(1, &quot;in png_read_finish_row\n&quot;);
@@ -2870,6 +2873,7 @@
    if (png_ptr-&gt;row_number &lt; png_ptr-&gt;num_rows)
       return;
 
+#ifdef PNG_READ_INTERLACING_SUPPORTED
    if (png_ptr-&gt;interlaced)
    {
       png_ptr-&gt;row_number = 0;
@@ -2904,6 +2908,7 @@
       if (png_ptr-&gt;pass &lt; 7)
          return;
    }
+#endif /* PNG_READ_INTERLACING_SUPPORTED */
 
    if (!(png_ptr-&gt;flags &amp; PNG_FLAG_ZLIB_FINISHED))
    {
@@ -2978,6 +2983,7 @@
 png_read_start_row(png_structp png_ptr)
 {
 #ifdef PNG_USE_LOCAL_ARRAYS
+#ifdef PNG_READ_INTERLACING_SUPPORTED
    /* arrays to facilitate easy interlacing - use pass (0 - 6) as index */
 
    /* start of interlace block */
@@ -2992,6 +2998,7 @@
    /* offset to next interlace block in the y direction */
    PNG_CONST int png_pass_yinc[7] = {8, 8, 8, 4, 4, 2, 2};
 #endif
+#endif
 
    int max_pixel_depth;
    png_uint_32 row_bytes;
@@ -2999,6 +3006,7 @@
    png_debug(1, &quot;in png_read_start_row\n&quot;);
    png_ptr-&gt;zstream.avail_in = 0;
    png_init_read_transformations(png_ptr);
+#ifdef PNG_READ_INTERLACING_SUPPORTED
    if (png_ptr-&gt;interlaced)
    {
       if (!(png_ptr-&gt;transformations &amp; PNG_INTERLACE))
@@ -3019,6 +3027,7 @@
             png_error(png_ptr, &quot;Rowbytes overflow in png_read_start_row&quot;);
    }
    else
+#endif /* PNG_READ_INTERLACING_SUPPORTED */
    {
       png_ptr-&gt;num_rows = png_ptr-&gt;height;
       png_ptr-&gt;iwidth = png_ptr-&gt;width;
@@ -3137,18 +3146,32 @@
    if (row_bytes &gt; (png_uint_32)65536L)
       png_error(png_ptr, &quot;This image requires a row greater than 64KB&quot;);
 #endif
-   png_ptr-&gt;big_row_buf = (png_bytep)png_malloc(png_ptr, row_bytes+64);
-   png_ptr-&gt;row_buf = png_ptr-&gt;big_row_buf+32;
 
+   if(row_bytes + 64 &gt; png_ptr-&gt;old_big_row_buf_size)
+   {
+     if (png_ptr-&gt;big_row_buf)
+        png_free(png_ptr,png_ptr-&gt;big_row_buf);
+     png_ptr-&gt;big_row_buf = (png_bytep)png_malloc(png_ptr, row_bytes+64);
+     png_ptr-&gt;row_buf = png_ptr-&gt;big_row_buf+32;
+     png_ptr-&gt;old_big_row_buf_size = row_bytes+64;
+   }
+
 #ifdef PNG_MAX_MALLOC_64K
    if ((png_uint_32)png_ptr-&gt;rowbytes + 1 &gt; (png_uint_32)65536L)
       png_error(png_ptr, &quot;This image requires a row greater than 64KB&quot;);
 #endif
    if ((png_uint_32)png_ptr-&gt;rowbytes &gt; (png_uint_32)(PNG_SIZE_MAX - 1))
       png_error(png_ptr, &quot;Row has too many bytes to allocate in memory.&quot;);
-   png_ptr-&gt;prev_row = (png_bytep)png_malloc(png_ptr, (png_uint_32)(
-      png_ptr-&gt;rowbytes + 1));
 
+   if(png_ptr-&gt;rowbytes+1 &gt; png_ptr-&gt;old_prev_row_size)
+   {
+     if (png_ptr-&gt;prev_row)
+        png_free(png_ptr,png_ptr-&gt;prev_row);
+     png_ptr-&gt;prev_row = (png_bytep)png_malloc(png_ptr, (png_uint_32)(
+        png_ptr-&gt;rowbytes + 1));
+     png_ptr-&gt;old_prev_row_size = png_ptr-&gt;rowbytes+1;
+   }
+
    png_memset_check(png_ptr, png_ptr-&gt;prev_row, 0, png_ptr-&gt;rowbytes + 1);
 
    png_debug1(3, &quot;width = %lu,\n&quot;, png_ptr-&gt;width);

Modified: haiku/trunk/src/libs/png/pngset.c
===================================================================
--- haiku/trunk/src/libs/png/pngset.c	2008-04-02 20:29:43 UTC (rev 24757)
+++ haiku/trunk/src/libs/png/pngset.c	2008-04-02 20:58:54 UTC (rev 24758)
@@ -1,9 +1,9 @@
 
 /* pngset.c - storage of image information into info struct
  *
- * Last changed in libpng 1.2.22 [October 13, 2007]
+ * Last changed in libpng 1.2.25 [February 18, 2008]
  * For conditions of distribution and use, see copyright notice in png.h
- * Copyright (c) 1998-2007 Glenn Randers-Pehrson
+ * Copyright (c) 1998-2008 Glenn Randers-Pehrson
  * (Version 0.96 Copyright (c) 1996, 1997 Andreas Dilger)
  * (Version 0.88 Copyright (c) 1995, 1996 Guy Eric Schalnat, Group 42, Inc.)
  *
@@ -41,7 +41,13 @@
    png_debug1(1, &quot;in %s storage function\n&quot;, &quot;cHRM&quot;);
    if (png_ptr == NULL || info_ptr == NULL)
       return;
-
+   if (!(white_x || white_y || red_x || red_y || green_x || green_y ||
+       blue_x || blue_y))
+   {
+      png_warning(png_ptr,
+        &quot;Ignoring attempt to set all-zero chromaticity values&quot;);
+      return;
+   }
    if (white_x &lt; 0.0 || white_y &lt; 0.0 ||
          red_x &lt; 0.0 ||   red_y &lt; 0.0 ||
        green_x &lt; 0.0 || green_y &lt; 0.0 ||
@@ -93,6 +99,13 @@
    if (png_ptr == NULL || info_ptr == NULL)
       return;
 
+   if (!(white_x || white_y || red_x || red_y || green_x || green_y ||
+       blue_x || blue_y))
+   {
+      png_warning(png_ptr,
+        &quot;Ignoring attempt to set all-zero chromaticity values&quot;);
+      return;
+   }
    if (white_x &lt; 0 || white_y &lt; 0 ||
          red_x &lt; 0 ||   red_y &lt; 0 ||
        green_x &lt; 0 || green_y &lt; 0 ||
@@ -102,25 +115,14 @@
         &quot;Ignoring attempt to set negative chromaticity value&quot;);
       return;
    }
-#ifdef PNG_FLOATING_POINT_SUPPORTED
-   if (white_x &gt; (double) PNG_UINT_31_MAX ||
-       white_y &gt; (double) PNG_UINT_31_MAX ||
-         red_x &gt; (double) PNG_UINT_31_MAX ||
-         red_y &gt; (double) PNG_UINT_31_MAX ||
-       green_x &gt; (double) PNG_UINT_31_MAX ||
-       green_y &gt; (double) PNG_UINT_31_MAX ||
-        blue_x &gt; (double) PNG_UINT_31_MAX ||
-        blue_y &gt; (double) PNG_UINT_31_MAX)
-#else
-   if (white_x &gt; (png_fixed_point) PNG_UINT_31_MAX/100000L ||
-       white_y &gt; (png_fixed_point) PNG_UINT_31_MAX/100000L ||
-         red_x &gt; (png_fixed_point) PNG_UINT_31_MAX/100000L ||
-         red_y &gt; (png_fixed_point) PNG_UINT_31_MAX/100000L ||
-       green_x &gt; (png_fixed_point) PNG_UINT_31_MAX/100000L ||
-       green_y &gt; (png_fixed_point) PNG_UINT_31_MAX/100000L ||
-        blue_x &gt; (png_fixed_point) PNG_UINT_31_MAX/100000L ||
-        blue_y &gt; (png_fixed_point) PNG_UINT_31_MAX/100000L)
-#endif
+   if (white_x &gt; (png_fixed_point) PNG_UINT_31_MAX ||
+       white_y &gt; (png_fixed_point) PNG_UINT_31_MAX ||
+         red_x &gt; (png_fixed_point) PNG_UINT_31_MAX ||
+         red_y &gt; (png_fixed_point) PNG_UINT_31_MAX ||
+       green_x &gt; (png_fixed_point) PNG_UINT_31_MAX ||
+       green_y &gt; (png_fixed_point) PNG_UINT_31_MAX ||
+        blue_x &gt; (png_fixed_point) PNG_UINT_31_MAX ||
+        blue_y &gt; (png_fixed_point) PNG_UINT_31_MAX )
    {
       png_warning(png_ptr,
         &quot;Ignoring attempt to set chromaticity value exceeding 21474.83&quot;);
@@ -486,6 +488,7 @@
    {
       png_warning(png_ptr,
        &quot;Memory allocation failed while processing sCAL.&quot;);
+      return;
    }
    png_memcpy(info_ptr-&gt;scal_s_width, swidth, (png_size_t)length);
 
@@ -497,9 +500,9 @@
       png_free (png_ptr, info_ptr-&gt;scal_s_width);
       png_warning(png_ptr,
        &quot;Memory allocation failed while processing sCAL.&quot;);
+      return;
    }
    png_memcpy(info_ptr-&gt;scal_s_height, sheight, (png_size_t)length);
-
    info_ptr-&gt;valid |= PNG_INFO_sCAL;
 #ifdef PNG_FREE_ME_SUPPORTED
    info_ptr-&gt;free_me |= PNG_FREE_SCAL;
@@ -679,19 +682,20 @@
 {
    png_charp new_iccp_name;
    png_charp new_iccp_profile;
+   png_uint_32 length;
 
    png_debug1(1, &quot;in %s storage function\n&quot;, &quot;iCCP&quot;);
    if (png_ptr == NULL || info_ptr == NULL || name == NULL || profile == NULL)
       return;
 
-   new_iccp_name = (png_charp)png_malloc_warn(png_ptr, png_strlen(name)+1);
+   length = png_strlen(name)+1;
+   new_iccp_name = (png_charp)png_malloc_warn(png_ptr, length);
    if (new_iccp_name == NULL)
    {
       png_warning(png_ptr, &quot;Insufficient memory to process iCCP chunk.&quot;);
       return;
    }
-   png_strncpy(new_iccp_name, name, png_strlen(name));
-   new_iccp_name[png_strlen(name)] = '\0';
+   png_memcpy(new_iccp_name, name, length);
    new_iccp_profile = (png_charp)png_malloc_warn(png_ptr, proflen);
    if (new_iccp_profile == NULL)
    {
@@ -972,29 +976,29 @@
     {
         png_sPLT_tp to = np + info_ptr-&gt;splt_palettes_num + i;
         png_sPLT_tp from = entries + i;
+        png_uint_32 length;
 
-        to-&gt;name = (png_charp)png_malloc_warn(png_ptr,
-          png_strlen(from-&gt;name) + 1);
+        length = png_strlen(from-&gt;name) + 1;
+        to-&gt;name = (png_charp)png_malloc_warn(png_ptr, length);
         if (to-&gt;name == NULL)
         {
            png_warning(png_ptr,
              &quot;Out of memory while processing sPLT chunk&quot;);
+           continue;
         }
-        /* TODO: use png_malloc_warn */
-        png_strncpy(to-&gt;name, from-&gt;name, png_strlen(from-&gt;name));
-        to-&gt;name[png_strlen(from-&gt;name)] = '\0';
+        png_memcpy(to-&gt;name, from-&gt;name, length);
         to-&gt;entries = (png_sPLT_entryp)png_malloc_warn(png_ptr,
             from-&gt;nentries * png_sizeof(png_sPLT_entry));
-        /* TODO: use png_malloc_warn */
-        png_memcpy(to-&gt;entries, from-&gt;entries,
-            from-&gt;nentries * png_sizeof(png_sPLT_entry));
         if (to-&gt;entries == NULL)
         {
            png_warning(png_ptr,
              &quot;Out of memory while processing sPLT chunk&quot;);
            png_free(png_ptr,to-&gt;name);
            to-&gt;name = NULL;
+           continue;
         }
+        png_memcpy(to-&gt;entries, from-&gt;entries,
+            from-&gt;nentries * png_sizeof(png_sPLT_entry));
         to-&gt;nentries = from-&gt;nentries;
         to-&gt;depth = from-&gt;depth;
     }
@@ -1039,8 +1043,11 @@
         png_unknown_chunkp to = np + info_ptr-&gt;unknown_chunks_num + i;
         png_unknown_chunkp from = unknowns + i;
 
-        png_strncpy((png_charp)to-&gt;name, (png_charp)from-&gt;name, 4);
-        to-&gt;name[4] = '\0';
+        png_memcpy((png_charp)to-&gt;name, 
+                   (png_charp)from-&gt;name, 
+                   png_sizeof(from-&gt;name));
+        to-&gt;name[png_sizeof(to-&gt;name)-1] = '\0';
+
         to-&gt;data = (png_bytep)png_malloc_warn(png_ptr, from-&gt;size);
         if (to-&gt;data == NULL)
         {

Modified: haiku/trunk/src/libs/png/pngwrite.c
===================================================================
--- haiku/trunk/src/libs/png/pngwrite.c	2008-04-02 20:29:43 UTC (rev 24757)
+++ haiku/trunk/src/libs/png/pngwrite.c	2008-04-02 20:58:54 UTC (rev 24758)
@@ -1,9 +1,9 @@
 
 /* pngwrite.c - general routines to write a PNG file
  *
- * Last changed in libpng 1.2.15 January 5, 2007
+ * Last changed in libpng 1.2.25 [February 18, 2008]
  * For conditions of distribution and use, see copyright notice in png.h
- * Copyright (c) 1998-2007 Glenn Randers-Pehrson
+ * Copyright (c) 1998-2008 Glenn Randers-Pehrson
  * (Version 0.96 Copyright (c) 1996, 1997 Andreas Dilger)
  * (Version 0.88 Copyright (c) 1995, 1996 Guy Eric Schalnat, Group 42, Inc.)
  */
@@ -482,12 +482,15 @@
 #endif /* PNG_USER_MEM_SUPPORTED */
    png_set_error_fn(png_ptr, error_ptr, error_fn, warn_fn);
 
-   i=0;
-   do
+   if(user_png_ver)
    {
-     if(user_png_ver[i] != png_libpng_ver[i])
-        png_ptr-&gt;flags |= PNG_FLAG_LIBRARY_MISMATCH;
-   } while (png_libpng_ver[i++]);
+     i=0;
+     do
+     {
+       if(user_png_ver[i] != png_libpng_ver[i])
+          png_ptr-&gt;flags |= PNG_FLAG_LIBRARY_MISMATCH;
+     } while (png_libpng_ver[i++]);
+   }
 
    if (png_ptr-&gt;flags &amp; PNG_FLAG_LIBRARY_MISMATCH)
    {
@@ -1000,21 +1003,32 @@
 #endif
    }
 
+#ifdef PNG_USER_MEM_SUPPORTED
+   if (png_ptr != NULL)
+   {
+      free_fn = png_ptr-&gt;free_fn;
+      mem_ptr = png_ptr-&gt;mem_ptr;
+   }
+#endif
+
    if (info_ptr_ptr != NULL)
       info_ptr = *info_ptr_ptr;
 
    if (info_ptr != NULL)
    {
-      png_free_data(png_ptr, info_ptr, PNG_FREE_ALL, -1);
+      if (png_ptr != NULL)
+      {
+        png_free_data(png_ptr, info_ptr, PNG_FREE_ALL, -1);
 
 #if defined(PNG_UNKNOWN_CHUNKS_SUPPORTED)
-      if (png_ptr-&gt;num_chunk_list)
-      {
-         png_free(png_ptr, png_ptr-&gt;chunk_list);
-         png_ptr-&gt;chunk_list=NULL;
-         png_ptr-&gt;num_chunk_list=0;
+        if (png_ptr-&gt;num_chunk_list)
+        {
+           png_free(png_ptr, png_ptr-&gt;chunk_list);
+           png_ptr-&gt;chunk_list=NULL;
+           png_ptr-&gt;num_chunk_list=0;
+        }
+#endif
       }
-#endif
 
 #ifdef PNG_USER_MEM_SUPPORTED
       png_destroy_struct_2((png_voidp)info_ptr, (png_free_ptr)free_fn,
@@ -1060,11 +1074,13 @@
    /* free our memory.  png_free checks NULL for us. */

[... truncated: 63 lines follow ...]

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="007396.html">[Haiku-commits] r24757 - in haiku/trunk: . build/jam
</A></li>
	<LI>Next message: <A HREF="007399.html">[Haiku-commits] r24759 - haiku/trunk/src/system/kernel/fs
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#7398">[ date ]</a>
              <a href="thread.html#7398">[ thread ]</a>
              <a href="subject.html#7398">[ subject ]</a>
              <a href="author.html#7398">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/haiku-commits">More information about the Haiku-commits
mailing list</a><br>
</body></html>
