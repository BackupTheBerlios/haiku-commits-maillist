<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Haiku-commits] r22643 - in haiku/trunk: headers/os/drivers	headers/posix headers/posix/netinet headers/posix/sys	headers/private/net src/add-ons/kernel/network/protocols/tcp	src/add-ons/kernel/network/socket	src/add-ons/kernel/network/stack src/kits/network	src/kits/network/dns/dst src/kits/network/dns/inet	src/kits/network/dns/irs src/kits/network/dns/resolv src/servers/net
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/haiku-commits/2007-October/index.html" >
   <LINK REL="made" HREF="mailto:haiku-commits%40lists.berlios.de?Subject=Re%3A%20%5BHaiku-commits%5D%20r22643%20-%20in%20haiku/trunk%3A%20headers/os/drivers%0A%09headers/posix%20headers/posix/netinet%20headers/posix/sys%0A%09headers/private/net%20src/add-ons/kernel/network/protocols/tcp%0A%09src/add-ons/kernel/network/socket%0A%09src/add-ons/kernel/network/stack%20src/kits/network%0A%09src/kits/network/dns/dst%20src/kits/network/dns/inet%0A%09src/kits/network/dns/irs%20src/kits/network/dns/resolv%20src/servers/net&In-Reply-To=%3C200710212010.l9LKAjsD007517%40sheep.berlios.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="004375.html">
   <LINK REL="Next"  HREF="004377.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Haiku-commits] r22643 - in haiku/trunk: headers/os/drivers	headers/posix headers/posix/netinet headers/posix/sys	headers/private/net src/add-ons/kernel/network/protocols/tcp	src/add-ons/kernel/network/socket	src/add-ons/kernel/network/stack src/kits/network	src/kits/network/dns/dst src/kits/network/dns/inet	src/kits/network/dns/irs src/kits/network/dns/resolv src/servers/net</H1>
    <B>axeld at BerliOS</B> 
    <A HREF="mailto:haiku-commits%40lists.berlios.de?Subject=Re%3A%20%5BHaiku-commits%5D%20r22643%20-%20in%20haiku/trunk%3A%20headers/os/drivers%0A%09headers/posix%20headers/posix/netinet%20headers/posix/sys%0A%09headers/private/net%20src/add-ons/kernel/network/protocols/tcp%0A%09src/add-ons/kernel/network/socket%0A%09src/add-ons/kernel/network/stack%20src/kits/network%0A%09src/kits/network/dns/dst%20src/kits/network/dns/inet%0A%09src/kits/network/dns/irs%20src/kits/network/dns/resolv%20src/servers/net&In-Reply-To=%3C200710212010.l9LKAjsD007517%40sheep.berlios.de%3E"
       TITLE="[Haiku-commits] r22643 - in haiku/trunk: headers/os/drivers	headers/posix headers/posix/netinet headers/posix/sys	headers/private/net src/add-ons/kernel/network/protocols/tcp	src/add-ons/kernel/network/socket	src/add-ons/kernel/network/stack src/kits/network	src/kits/network/dns/dst src/kits/network/dns/inet	src/kits/network/dns/irs src/kits/network/dns/resolv src/servers/net">axeld at mail.berlios.de
       </A><BR>
    <I>Sun Oct 21 22:10:45 CEST 2007</I>
    <P><UL>
        <LI>Previous message: <A HREF="004375.html">[Haiku-commits] r22642 - in haiku/trunk/src/kits: . bluetooth
</A></li>
        <LI>Next message: <A HREF="004377.html">[Haiku-commits] r22644 -	haiku/trunk/src/add-ons/kernel/file_systems/nfs
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4376">[ date ]</a>
              <a href="thread.html#4376">[ thread ]</a>
              <a href="subject.html#4376">[ subject ]</a>
              <a href="author.html#4376">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: axeld
Date: 2007-10-21 22:10:43 +0200 (Sun, 21 Oct 2007)
New Revision: 22643
ViewCVS: <A HREF="http://svn.berlios.de/viewcvs/haiku?rev=22643&amp;view=rev">http://svn.berlios.de/viewcvs/haiku?rev=22643&amp;view=rev</A>

Modified:
   haiku/trunk/headers/os/drivers/socket_interface.h
   haiku/trunk/headers/posix/netinet/in.h
   haiku/trunk/headers/posix/stdint.h
   haiku/trunk/headers/posix/sys/socket.h
   haiku/trunk/headers/private/net/ProtocolUtilities.h
   haiku/trunk/headers/private/net/net_socket.h
   haiku/trunk/headers/private/net/net_stack.h
   haiku/trunk/src/add-ons/kernel/network/protocols/tcp/EndpointManager.cpp
   haiku/trunk/src/add-ons/kernel/network/protocols/tcp/TCPEndpoint.cpp
   haiku/trunk/src/add-ons/kernel/network/protocols/tcp/tcp.cpp
   haiku/trunk/src/add-ons/kernel/network/protocols/tcp/tcp.h
   haiku/trunk/src/add-ons/kernel/network/socket/socket.cpp
   haiku/trunk/src/add-ons/kernel/network/stack/net_socket.cpp
   haiku/trunk/src/add-ons/kernel/network/stack/utility.cpp
   haiku/trunk/src/kits/network/dns/dst/dst_api.c
   haiku/trunk/src/kits/network/dns/dst/support.c
   haiku/trunk/src/kits/network/dns/inet/inet_addr.c
   haiku/trunk/src/kits/network/dns/inet/inet_ntop.c
   haiku/trunk/src/kits/network/dns/irs/getnameinfo.c
   haiku/trunk/src/kits/network/dns/resolv/res_debug.c
   haiku/trunk/src/kits/network/socket.cpp
   haiku/trunk/src/servers/net/DHCPClient.cpp
Log:
* int32_t, uint32_t are now of type &quot;int&quot;, and no longer of type &quot;long&quot;.
  This should help to reduce the number of warnings imported code will throw
  during compilation (helps a lot with tcpdump, for example).
* Since long is 64 bit on 64 bit platforms, we might want to think about doing
  that change for the Haiku types int32 and uint32 as well.
* Fixed several occurences of hidden type problems.
* Fixed build of the stack and TCP under BeOS.
* Fixed incorrect typedef in socket_interface.h.
* Minor cleanup.


Modified: haiku/trunk/headers/os/drivers/socket_interface.h
===================================================================
--- haiku/trunk/headers/os/drivers/socket_interface.h	2007-10-21 17:58:38 UTC (rev 22642)
+++ haiku/trunk/headers/os/drivers/socket_interface.h	2007-10-21 20:10:43 UTC (rev 22643)
@@ -14,7 +14,7 @@
 
 #define B_SOCKET_MODULE_NAME &quot;network/socket/v1&quot;
 
-typedef struct socket_module_info {
+struct socket_module_info {
 	struct module_info	info;
 
 	int 	(*accept)(int socket, struct sockaddr *address, socklen_t *_addressLength);

Modified: haiku/trunk/headers/posix/netinet/in.h
===================================================================
--- haiku/trunk/headers/posix/netinet/in.h	2007-10-21 17:58:38 UTC (rev 22642)
+++ haiku/trunk/headers/posix/netinet/in.h	2007-10-21 20:10:43 UTC (rev 22643)
@@ -22,7 +22,8 @@
  * and we are not allowed to import all the BeOS types here.
  */
 #ifndef htonl
-	extern uint32_t __swap_int32(uint32_t);	/* private */
+//	extern uint32_t __swap_int32(uint32_t);	/* private */
+	extern unsigned long __swap_int32(unsigned long);	/* private */
 	extern uint16_t __swap_int16(uint16_t);	/* private */
 	#if 	BYTE_ORDER == LITTLE_ENDIAN
 		#define htonl(x) __swap_int32(x)

Modified: haiku/trunk/headers/posix/stdint.h
===================================================================
--- haiku/trunk/headers/posix/stdint.h	2007-10-21 17:58:38 UTC (rev 22642)
+++ haiku/trunk/headers/posix/stdint.h	2007-10-21 20:10:43 UTC (rev 22643)
@@ -1,6 +1,7 @@
-/* 
-** Distributed under the terms of the Haiku License.
-*/
+/*
+ * Copyright 2003-2007, Haiku Inc. All Rights Reserved.
+ * Distributed under the terms of the MIT License.
+ */
 #ifndef _STDINT_H_
 #define _STDINT_H_
 
@@ -27,8 +28,8 @@
 #define INT32_MIN 	(-INT32_MAX-1)
 #define UINT32_MAX	(4294967295UL)
 
-typedef signed long int32_t;
-typedef unsigned long uint32_t;
+typedef signed int int32_t;
+typedef unsigned int uint32_t;
 
 #define INT64_MAX	(9223372036854775807LL)
 #define INT64_MIN	(-INT64_MAX-1)

Modified: haiku/trunk/headers/posix/sys/socket.h
===================================================================
--- haiku/trunk/headers/posix/sys/socket.h	2007-10-21 17:58:38 UTC (rev 22642)
+++ haiku/trunk/headers/posix/sys/socket.h	2007-10-21 20:10:43 UTC (rev 22643)
@@ -83,13 +83,12 @@
 	uint8_t		sa_data[30];
 };
 
-/* this can hold ANY sockaddr we care to throw at it! */
 struct sockaddr_storage {
-	uint8_t       ss_len;		/* total length */
-	uint8_t       ss_family;	/* address family */
-	uint8_t       __ss_pad1[6];	/* align to quad */
-	uint64_t      __ss_pad2;	/* force alignment for stupid compilers */
-	uint8_t       __ss_pad3[112]; /* pad to a total of 128 bytes */
+	uint8_t		ss_len;			/* total length */
+	uint8_t		ss_family;		/* address family */
+	uint8_t		__ss_pad1[6];	/* align to quad */
+	uint64_t	__ss_pad2;		/* force alignment to 64 bit */
+	uint8_t		__ss_pad3[112];	/* pad to a total of 128 bytes */
 };
 
 struct msghdr {

Modified: haiku/trunk/headers/private/net/ProtocolUtilities.h
===================================================================
--- haiku/trunk/headers/private/net/ProtocolUtilities.h	2007-10-21 17:58:38 UTC (rev 22642)
+++ haiku/trunk/headers/private/net/ProtocolUtilities.h	2007-10-21 20:10:43 UTC (rev 22643)
@@ -5,20 +5,21 @@
  * Authors:
  *      Hugo Santos, <A HREF="https://lists.berlios.de/mailman/listinfo/haiku-commits">hugosantos at gmail.com</A>
  */
-
 #ifndef PROTOCOL_UTILITIES_H
 #define PROTOCOL_UTILITIES_H
 
+
 #include &lt;lock.h&gt;
+#include &lt;Select.h&gt;
 #include &lt;util/AutoLock.h&gt;
 #include &lt;util/DoublyLinkedList.h&gt;
 
+#include &lt;AddressUtilities.h&gt;
 #include &lt;net_buffer.h&gt;
 #include &lt;net_protocol.h&gt;
 #include &lt;net_socket.h&gt;
 #include &lt;net_stack.h&gt;
 
-#include &lt;AddressUtilities.h&gt;
 
 class BenaphoreLocking {
 public:

Modified: haiku/trunk/headers/private/net/net_socket.h
===================================================================
--- haiku/trunk/headers/private/net/net_socket.h	2007-10-21 17:58:38 UTC (rev 22642)
+++ haiku/trunk/headers/private/net/net_socket.h	2007-10-21 20:10:43 UTC (rev 22643)
@@ -1,5 +1,5 @@
 /*
- * Copyright 2006, Haiku, Inc. All Rights Reserved.
+ * Copyright 2006-2007, Haiku, Inc. All Rights Reserved.
  * Distributed under the terms of the MIT License.
  */
 #ifndef NET_SOCKET_H
@@ -9,10 +9,11 @@
 #include &lt;net_buffer.h&gt;
 #include &lt;sys/socket.h&gt;
 
-#include &lt;Select.h&gt;
 #include &lt;lock.h&gt;
 
+struct selectsync;
 
+
 #define NET_SOCKET_MODULE_NAME &quot;network/stack/socket/v1&quot;
 
 typedef struct net_socket {
@@ -42,32 +43,36 @@
 struct net_socket_module_info {
 	struct module_info info;
 
-	status_t	(*open_socket)(int family, int type, int protocol, net_socket **_socket);
+	status_t	(*open_socket)(int family, int type, int protocol,
+					net_socket **_socket);
 	status_t	(*close)(net_socket *socket);
 	status_t	(*free)(net_socket *socket);
 
-	status_t	(*readv)(net_socket *socket, const iovec *vecs, size_t vecCount,
-					size_t *_length);
-	status_t	(*writev)(net_socket *socket, const iovec *vecs, size_t vecCount,
-					size_t *_length);
-	status_t	(*control)(net_socket *socket, int32 op, void *data, size_t length);
+	status_t	(*readv)(net_socket *socket, const iovec *vecs,
+					size_t vecCount, size_t *_length);
+	status_t	(*writev)(net_socket *socket, const iovec *vecs,
+					size_t vecCount, size_t *_length);
+	status_t	(*control)(net_socket *socket, int32 op, void *data,
+					size_t length);
 
 	ssize_t		(*read_avail)(net_socket *socket);
 	ssize_t		(*send_avail)(net_socket *socket);
 
 	status_t	(*send_data)(net_socket *socket, net_buffer *buffer);
-	status_t	(*receive_data)(net_socket *socket, size_t length, uint32 flags,
-					net_buffer **_buffer);
+	status_t	(*receive_data)(net_socket *socket, size_t length,
+					uint32 flags, net_buffer **_buffer);
 
 	status_t	(*get_option)(net_socket *socket, int level, int option,
 					void *value, int *_length);
 	status_t	(*set_option)(net_socket *socket, int level, int option,
 					const void *value, int length);
 
-	status_t	(*get_next_stat)(uint32 *cookie, int family, struct net_stat *stat);
+	status_t	(*get_next_stat)(uint32 *cookie, int family,
+					struct net_stat *stat);
 
 	// connections
-	status_t	(*spawn_pending_socket)(net_socket *parent, net_socket **_socket);
+	status_t	(*spawn_pending_socket)(net_socket *parent,
+					net_socket **_socket);
 	void		(*delete_socket)(net_socket *socket);
 	status_t	(*dequeue_connected)(net_socket *parent, net_socket **_socket);
 	ssize_t		(*count_connected)(net_socket *parent);
@@ -75,10 +80,10 @@
 	status_t	(*set_connected)(net_socket *socket);
 
 	// notifications
-	status_t	(*request_notification)(net_socket *socket, uint8 event, uint32 ref,
-					selectsync *sync);
+	status_t	(*request_notification)(net_socket *socket, uint8 event,
+					uint32 ref, struct selectsync *sync);
 	status_t	(*cancel_notification)(net_socket *socket, uint8 event,
-					selectsync *sync);
+					struct selectsync *sync);
 	status_t	(*notify)(net_socket *socket, uint8 event, int32 value);
 
 	// standard socket API

Modified: haiku/trunk/headers/private/net/net_stack.h
===================================================================
--- haiku/trunk/headers/private/net/net_stack.h	2007-10-21 17:58:38 UTC (rev 22642)
+++ haiku/trunk/headers/private/net/net_stack.h	2007-10-21 20:10:43 UTC (rev 22643)
@@ -78,9 +78,10 @@
 	status_t (*register_domain_receiving_protocol)(int family, int type,
 					const char *moduleName);
 
-	status_t (*get_domain_receiving_protocol)(struct net_domain *domain, uint32 type,
-					struct net_protocol_module_info **_module);
-	status_t (*put_domain_receiving_protocol)(struct net_domain *domain, uint32 type);
+	status_t (*get_domain_receiving_protocol)(struct net_domain *domain,
+					uint32 type, struct net_protocol_module_info **_module);
+	status_t (*put_domain_receiving_protocol)(struct net_domain *domain,
+					uint32 type);
 
 	// devices
 	status_t (*register_device_deframer)(struct net_device *device,
@@ -94,33 +95,37 @@
 	status_t (*unregister_device_handler)(struct net_device *device, int32 type);
 
 	status_t (*register_device_monitor)(struct net_device *device,
-		struct net_device_monitor *monitor);
+					struct net_device_monitor *monitor);
 	status_t (*unregister_device_monitor)(struct net_device *device,
-		struct net_device_monitor *monitor);
+					struct net_device_monitor *monitor);
 
 	status_t (*device_link_changed)(struct net_device *device);
 	status_t (*device_removed)(struct net_device *device);
 
 	status_t (*device_enqueue_buffer)(struct net_device *device,
-				struct net_buffer *buffer);
+					struct net_buffer *buffer);
 
 	// Utility Functions
 
 	// notification
-	status_t	(*notify_socket)(struct net_socket *socket, uint8 event, int32 value);
+	status_t (*notify_socket)(struct net_socket *socket, uint8 event,
+					int32 value);
 
 	// checksum
 	uint16 (*checksum)(uint8 *buffer, size_t length);
 
 	// fifo
-	status_t (*init_fifo)(struct net_fifo *fifo, const char *name, size_t maxBytes);
+	status_t (*init_fifo)(struct net_fifo *fifo, const char *name,
+					size_t maxBytes);
 	void (*uninit_fifo)(struct net_fifo *fifo);
-	status_t (*fifo_enqueue_buffer)(struct net_fifo *fifo, struct net_buffer *buffer);
+	status_t (*fifo_enqueue_buffer)(struct net_fifo *fifo,
+					struct net_buffer *buffer);
 	ssize_t (*fifo_dequeue_buffer)(struct net_fifo *fifo, uint32 flags,
 					bigtime_t timeout, struct net_buffer **_buffer);
 	status_t (*clear_fifo)(struct net_fifo *fifo);
-	status_t (*fifo_socket_enqueue_buffer)(struct net_fifo *, struct net_socket *,
-					uint8 event, struct net_buffer *);
+	status_t (*fifo_socket_enqueue_buffer)(struct net_fifo *fifo,
+					struct net_socket *socket, uint8 event,
+					struct net_buffer *buffer);
 
 	// timer
 	void (*init_timer)(struct net_timer *timer, net_timer_func hook, void *data);

Modified: haiku/trunk/src/add-ons/kernel/network/protocols/tcp/EndpointManager.cpp
===================================================================
--- haiku/trunk/src/add-ons/kernel/network/protocols/tcp/EndpointManager.cpp	2007-10-21 17:58:38 UTC (rev 22642)
+++ haiku/trunk/src/add-ons/kernel/network/protocols/tcp/EndpointManager.cpp	2007-10-21 20:10:43 UTC (rev 22643)
@@ -9,13 +9,15 @@
 
 
 #include &quot;EndpointManager.h&quot;
-#include &quot;TCPEndpoint.h&quot;
 
+#include &lt;unistd.h&gt;
+
+#include &lt;KernelExport.h&gt;
+
 #include &lt;NetUtilities.h&gt;
-
 #include &lt;util/AutoLock.h&gt;
 
-#include &lt;KernelExport.h&gt;
+#include &quot;TCPEndpoint.h&quot;
 
 
 //#define TRACE_ENDPOINT_MANAGER

Modified: haiku/trunk/src/add-ons/kernel/network/protocols/tcp/TCPEndpoint.cpp
===================================================================
--- haiku/trunk/src/add-ons/kernel/network/protocols/tcp/TCPEndpoint.cpp	2007-10-21 17:58:38 UTC (rev 22642)
+++ haiku/trunk/src/add-ons/kernel/network/protocols/tcp/TCPEndpoint.cpp	2007-10-21 20:10:43 UTC (rev 22643)
@@ -24,6 +24,7 @@
 #include &lt;util/list.h&gt;
 
 #include &lt;KernelExport.h&gt;
+#include &lt;Select.h&gt;
 
 #include &lt;netinet/in.h&gt;
 #include &lt;netinet/ip.h&gt;
@@ -196,9 +197,10 @@
 
 	status_t status = B_OK;
 
-	while (status == B_OK &amp;&amp; !atomic_test_and_set(&amp;fCondition, 0, 1))
+	while (status == B_OK &amp;&amp; !atomic_test_and_set(&amp;fCondition, 0, 1)) {
 		status = acquire_sem_etc(fSem, 1, B_ABSOLUTE_TIMEOUT | B_CAN_INTERRUPT,
 			timeout);
+	}
 
 	locker.Lock();
 	if (status == B_OK &amp;&amp; wakeNext)
@@ -212,7 +214,13 @@
 WaitList::Signal()
 {
 	atomic_or(&amp;fCondition, 1);
+#ifdef __HAIKU__
 	release_sem_etc(fSem, 1, B_DO_NOT_RESCHEDULE | B_RELEASE_IF_WAITING_ONLY);
+#else
+	int32 count;
+	if (get_sem_count(fSem, &amp;count) == B_OK &amp;&amp; count &lt; 0)
+		release_sem_etc(fSem, 1, B_DO_NOT_RESCHEDULE);
+#endif
 }
 
 

Modified: haiku/trunk/src/add-ons/kernel/network/protocols/tcp/tcp.cpp
===================================================================
--- haiku/trunk/src/add-ons/kernel/network/protocols/tcp/tcp.cpp	2007-10-21 17:58:38 UTC (rev 22642)
+++ haiku/trunk/src/add-ons/kernel/network/protocols/tcp/tcp.cpp	2007-10-21 20:10:43 UTC (rev 22643)
@@ -1,10 +1,11 @@
 /*
- * Copyright 2006, Haiku, Inc. All Rights Reserved.
+ * Copyright 2006-2007, Haiku, Inc. All Rights Reserved.
  * Distributed under the terms of the MIT License.
  *
  * Authors:
  *		Axel D&#246;rfler, <A HREF="https://lists.berlios.de/mailman/listinfo/haiku-commits">axeld at pinc-software.de</A>
  *		Andrew Galante, <A HREF="https://lists.berlios.de/mailman/listinfo/haiku-commits">haiku.galante at gmail.com</A>
+ *		Hugo Santos, <A HREF="https://lists.berlios.de/mailman/listinfo/haiku-commits">hugosantos at gmail.com</A>
  */
 
 
@@ -134,9 +135,9 @@
 		bump_option(option, length);
 		option-&gt;kind = TCP_OPTION_TIMESTAMP;
 		option-&gt;length = 10;
-		option-&gt;timestamp.timestamp_value = htonl(segment.timestamp_value);
+		option-&gt;timestamp.value = htonl(segment.timestamp_value);
 		// TSecr is opaque to us, we send it as we received it.
-		option-&gt;timestamp.timestamp_reply = segment.timestamp_reply;
+		option-&gt;timestamp.reply = segment.timestamp_reply;
 		bump_option(option, length);
 	}
 
@@ -307,9 +308,9 @@
 			case TCP_OPTION_TIMESTAMP:
 				if (option-&gt;length == 10 &amp;&amp; (size - 10) &gt;= 0) {
 					segment.options |= TCP_HAS_TIMESTAMPS;
-					segment.timestamp_value = option-&gt;timestamp.timestamp_value;
+					segment.timestamp_value = option-&gt;timestamp.value;
 					segment.timestamp_reply =
-						ntohl(option-&gt;timestamp.timestamp_reply);
+						ntohl(option-&gt;timestamp.reply);
 				}
 				break;
 			case TCP_OPTION_SACK_PERMITTED:
@@ -386,6 +387,33 @@
 #endif
 
 
+static int
+dump_endpoints(int argc, char *argv[])
+{
+	EndpointManagerList::Iterator it = sEndpointManagers.GetIterator();
+
+	while (it.HasNext())
+		it.Next()-&gt;DumpEndpoints();
+
+	return 0;
+}
+
+
+static int
+dump_endpoint(int argc, char *argv[])
+{
+	if (argc &lt; 2) {
+		kprintf(&quot;usage: tcp_endpoint [address]\n&quot;);
+		return 0;
+	}
+
+	TCPEndpoint *endpoint = (TCPEndpoint *)strtoul(argv[1], NULL, 16);
+	endpoint-&gt;DumpInternalState();
+
+	return 0;
+}
+
+
 //	#pragma mark - protocol API
 
 
@@ -674,33 +702,6 @@
 }
 
 
-static int
-dump_endpoints(int argc, char *argv[])
-{
-	EndpointManagerList::Iterator it = sEndpointManagers.GetIterator();
-
-	while (it.HasNext())
-		it.Next()-&gt;DumpEndpoints();
-
-	return 0;
-}
-
-
-static int
-dump_endpoint(int argc, char *argv[])
-{
-	if (argc &lt; 2) {
-		kprintf(&quot;usage: tcp_endpoint [address]\n&quot;);
-		return 0;
-	}
-
-	TCPEndpoint *endpoint = (TCPEndpoint *)strtoul(argv[1], NULL, 16);
-	endpoint-&gt;DumpInternalState();
-
-	return 0;
-}
-
-
 //	#pragma mark -
 
 

Modified: haiku/trunk/src/add-ons/kernel/network/protocols/tcp/tcp.h
===================================================================
--- haiku/trunk/src/add-ons/kernel/network/protocols/tcp/tcp.h	2007-10-21 17:58:38 UTC (rev 22642)
+++ haiku/trunk/src/add-ons/kernel/network/protocols/tcp/tcp.h	2007-10-21 20:10:43 UTC (rev 22643)
@@ -1,9 +1,11 @@
 /*
- * Copyright 2006, Haiku, Inc. All Rights Reserved.
+ * Copyright 2006-2007, Haiku, Inc. All Rights Reserved.
  * Distributed under the terms of the MIT License.
  *
  * Authors:
+ *		Axel D&#246;rfler, <A HREF="https://lists.berlios.de/mailman/listinfo/haiku-commits">axeld at pinc-software.de</A>
  *		Andrew Galante, <A HREF="https://lists.berlios.de/mailman/listinfo/haiku-commits">haiku.galante at gmail.com</A>
+ *		Hugo Santos, <A HREF="https://lists.berlios.de/mailman/listinfo/haiku-commits">hugosantos at gmail.com</A>
  */
 #ifndef TCP_H
 #define TCP_H
@@ -115,13 +117,13 @@
 	uint8	kind;
 	uint8	length;
 	union {
-		uint8	window_shift;
-		uint16	max_segment_size;
+		uint8		window_shift;
+		uint16		max_segment_size;
 		struct {
-			uint32 timestamp_value;
-			uint32 timestamp_reply;
-		} timestamp;
-		tcp_sack sack[0];
+			uint32	value;
+			uint32	reply;
+		}			timestamp;
+		tcp_sack	sack[0];
 	};
 } _PACKED;
 

Modified: haiku/trunk/src/add-ons/kernel/network/socket/socket.cpp
===================================================================
--- haiku/trunk/src/add-ons/kernel/network/socket/socket.cpp	2007-10-21 17:58:38 UTC (rev 22642)
+++ haiku/trunk/src/add-ons/kernel/network/socket/socket.cpp	2007-10-21 20:10:43 UTC (rev 22643)
@@ -221,7 +221,7 @@
 
 
 int
-getsockopt(int socket, int level, int option, void *value, size_t *_length)
+getsockopt(int socket, int level, int option, void *value, socklen_t *_length)
 {
 	sockopt_args args;
 	args.level = level;
@@ -240,7 +240,7 @@
 
 
 int
-setsockopt(int socket, int level, int option, const void *value, size_t length)
+setsockopt(int socket, int level, int option, const void *value, socklen_t length)
 {
 	sockopt_args args;
 	args.level = level;

Modified: haiku/trunk/src/add-ons/kernel/network/stack/net_socket.cpp
===================================================================
--- haiku/trunk/src/add-ons/kernel/network/stack/net_socket.cpp	2007-10-21 17:58:38 UTC (rev 22642)
+++ haiku/trunk/src/add-ons/kernel/network/stack/net_socket.cpp	2007-10-21 20:10:43 UTC (rev 22643)
@@ -14,6 +14,7 @@
 #include &lt;net_stat.h&gt;
 
 #include &lt;KernelExport.h&gt;
+#include &lt;Select.h&gt;
 #include &lt;team.h&gt;
 #include &lt;util/AutoLock.h&gt;
 #include &lt;util/list.h&gt;

Modified: haiku/trunk/src/add-ons/kernel/network/stack/utility.cpp
===================================================================
--- haiku/trunk/src/add-ons/kernel/network/stack/utility.cpp	2007-10-21 17:58:38 UTC (rev 22642)
+++ haiku/trunk/src/add-ons/kernel/network/stack/utility.cpp	2007-10-21 20:10:43 UTC (rev 22643)
@@ -91,9 +91,13 @@
 		return NULL;
 	}
 
+#ifdef _KERNEL_MODE
 	fStatus = user_memcpy(fBuffer, source, length);
 	if (fStatus &lt; B_OK)
 		return NULL;
+#else
+	memcpy(fBuffer, source, length);
+#endif
 
 	void *current = fBuffer;
 
@@ -242,7 +246,11 @@
 void
 Fifo::WakeAll()
 {
+#ifdef __HAIKU__
 	release_sem_etc(notify, 0, B_RELEASE_ALL);
+#else
+	release_sem_etc(notify, 0, waiting);
+#endif
 }
 
 

Modified: haiku/trunk/src/kits/network/dns/dst/dst_api.c
===================================================================
--- haiku/trunk/src/kits/network/dns/dst/dst_api.c	2007-10-21 17:58:38 UTC (rev 22642)
+++ haiku/trunk/src/kits/network/dns/dst/dst_api.c	2007-10-21 20:10:43 UTC (rev 22643)
@@ -611,7 +611,7 @@
 		b64_ntop(&amp;out_key[6], len - 6, enc_key, sizeof(enc_key));
 	else
 		b64_ntop(&amp;out_key[4], len - 4, enc_key, sizeof(enc_key));
-	fprintf(fp, &quot;%s IN KEY %ld %d %d %s\n&quot;,
+	fprintf(fp, &quot;%s IN KEY %d %d %d %s\n&quot;,
 		key-&gt;dk_key_name,
 		key-&gt;dk_flags, key-&gt;dk_proto, key-&gt;dk_alg, enc_key);
 	fclose(fp);

Modified: haiku/trunk/src/kits/network/dns/dst/support.c
===================================================================
--- haiku/trunk/src/kits/network/dns/dst/support.c	2007-10-21 17:58:38 UTC (rev 22642)
+++ haiku/trunk/src/kits/network/dns/dst/support.c	2007-10-21 20:10:43 UTC (rev 22643)
@@ -280,7 +280,7 @@
 	if (filename_length &lt; 1 + strlen(name) + 4 + 6 + 1 + strlen(suffix))
 		return (-1);
 	my_id = id;
-	sprintf(filename, &quot;K%s+%03d+%05ld.%s&quot;, name, alg, my_id,
+	sprintf(filename, &quot;K%s+%03d+%05d.%s&quot;, name, alg, my_id,
 		(const char *) suffix);
 	if (strrchr(filename, '/'))
 		return (-1);

Modified: haiku/trunk/src/kits/network/dns/inet/inet_addr.c
===================================================================
--- haiku/trunk/src/kits/network/dns/inet/inet_addr.c	2007-10-21 17:58:38 UTC (rev 22642)
+++ haiku/trunk/src/kits/network/dns/inet/inet_addr.c	2007-10-21 20:10:43 UTC (rev 22643)
@@ -89,7 +89,7 @@
  * Ascii internet address interpretation routine.
  * The value returned is in network order.
  */
-u_long
+in_addr_t
 inet_addr(const char *cp) {
 	struct in_addr val;
 

Modified: haiku/trunk/src/kits/network/dns/inet/inet_ntop.c
===================================================================
--- haiku/trunk/src/kits/network/dns/inet/inet_ntop.c	2007-10-21 17:58:38 UTC (rev 22642)
+++ haiku/trunk/src/kits/network/dns/inet/inet_ntop.c	2007-10-21 20:10:43 UTC (rev 22643)
@@ -46,8 +46,8 @@
  * sizeof(int) &lt; 4.  sizeof(int) &gt; 4 is fine; all the world's not a VAX.
  */
 
-static const char *inet_ntop4 __P((const u_char *src, char *dst, size_t size));
-static const char *inet_ntop6 __P((const u_char *src, char *dst, size_t size));
+static const char *inet_ntop4 __P((const u_char *src, char *dst, socklen_t size));
+static const char *inet_ntop6 __P((const u_char *src, char *dst, socklen_t size));
 
 /* char *
  * inet_ntop(af, src, dst, size)
@@ -62,7 +62,7 @@
 	int af;
 	const void *src;
 	char *dst;
-	size_t size;
+	socklen_t size;
 {
 	switch (af) {
 	case AF_INET:
@@ -91,7 +91,7 @@
 inet_ntop4(src, dst, size)
 	const u_char *src;
 	char *dst;
-	size_t size;
+	socklen_t size;
 {
 	static const char fmt[] = &quot;%u.%u.%u.%u&quot;;
 	char tmp[sizeof &quot;255.255.255.255&quot;];
@@ -114,7 +114,7 @@
 inet_ntop6(src, dst, size)
 	const u_char *src;
 	char *dst;
-	size_t size;
+	socklen_t size;
 {
 	/*
 	 * Note that int32_t and int16_t need only be &quot;at least&quot; large enough
@@ -194,7 +194,7 @@
 	/*
 	 * Check for overflow, copy, and we're done.
 	 */
-	if ((size_t)(tp - tmp) &gt; size) {
+	if ((socklen_t)(tp - tmp) &gt; size) {
 		errno = ENOSPC;
 		return (NULL);
 	}

Modified: haiku/trunk/src/kits/network/dns/irs/getnameinfo.c
===================================================================
--- haiku/trunk/src/kits/network/dns/irs/getnameinfo.c	2007-10-21 17:58:38 UTC (rev 22642)
+++ haiku/trunk/src/kits/network/dns/irs/getnameinfo.c	2007-10-21 20:10:43 UTC (rev 22643)
@@ -89,11 +89,11 @@
 int
 getnameinfo(sa, salen, host, hostlen, serv, servlen, flags)
 	const struct sockaddr *sa;
-	size_t salen;
+	socklen_t salen;
 	char *host;
-	size_t hostlen;
+	socklen_t hostlen;
 	char *serv;
-	size_t servlen;
+	socklen_t servlen;
 	int flags;
 {
 	struct afd *afd;

Modified: haiku/trunk/src/kits/network/dns/resolv/res_debug.c
===================================================================
--- haiku/trunk/src/kits/network/dns/resolv/res_debug.c	2007-10-21 17:58:38 UTC (rev 22642)
+++ haiku/trunk/src/kits/network/dns/resolv/res_debug.c	2007-10-21 20:10:43 UTC (rev 22643)
@@ -190,7 +190,7 @@
 		else if (section == ns_s_ar &amp;&amp; ns_rr_type(rr) == ns_t_opt) {
 			u_int32_t ttl = ns_rr_ttl(rr);
 			fprintf(file,
-				&quot;; EDNS: version: %lu, udp=%u, flags=%04lx\n&quot;,
+				&quot;; EDNS: version: %u, udp=%u, flags=%04x\n&quot;,
 				(ttl&gt;&gt;16)&amp;0xff, ns_rr_class(rr), ttl&amp;0xffff);
 		} else {
 			n = ns_sprintrr(handle, &amp;rr, NULL, NULL,
@@ -642,7 +642,7 @@
 	static char nbuf[40];		/* XXX nonreentrant */
 
 	if (ns_format_ttl(value, nbuf, sizeof nbuf) &lt; 0)
-		sprintf(nbuf, &quot;%lu&quot;, value);
+		sprintf(nbuf, &quot;%u&quot;, value);
 	return (nbuf);
 }
 

Modified: haiku/trunk/src/kits/network/socket.cpp
===================================================================
--- haiku/trunk/src/kits/network/socket.cpp	2007-10-21 17:58:38 UTC (rev 22642)
+++ haiku/trunk/src/kits/network/socket.cpp	2007-10-21 20:10:43 UTC (rev 22643)
@@ -418,7 +418,7 @@
 
 
 extern &quot;C&quot; int
-getsockopt(int socket, int level, int option, void *value, size_t *_length)
+getsockopt(int socket, int level, int option, void *value, socklen_t *_length)
 {
 	if (check_r5_compatibility()) {
 		if (option == R5_SO_FIONREAD) {
@@ -447,7 +447,8 @@
 
 
 extern &quot;C&quot; int
-setsockopt(int socket, int level, int option, const void *value, size_t length)
+setsockopt(int socket, int level, int option, const void *value,
+	socklen_t length)
 {
 	if (check_r5_compatibility())
 		convert_from_r5_sockopt(level, option);

Modified: haiku/trunk/src/servers/net/DHCPClient.cpp
===================================================================
--- haiku/trunk/src/servers/net/DHCPClient.cpp	2007-10-21 17:58:38 UTC (rev 22642)
+++ haiku/trunk/src/servers/net/DHCPClient.cpp	2007-10-21 20:10:43 UTC (rev 22643)
@@ -80,7 +80,13 @@
 };
 
 struct dhcp_option_cookie {
-	dhcp_option_cookie() : state(0), file_has_options(false), server_name_has_options(false) {}
+	dhcp_option_cookie()
+		:
+		state(0),
+		file_has_options(false),
+		server_name_has_options(false)
+	{
+	}
 
 	const uint8* next;
 	uint8	state;
@@ -122,7 +128,8 @@
 	uint8* PutOption(uint8* options, message_option option, uint8 data);
 	uint8* PutOption(uint8* options, message_option option, uint16 data);
 	uint8* PutOption(uint8* options, message_option option, uint32 data);
-	uint8* PutOption(uint8* options, message_option option, const uint8* data, uint32 size);
+	uint8* PutOption(uint8* options, message_option option, const uint8* data,
+		uint32 size);
 	uint8* FinishOptions(uint8 *);
 } _PACKED;
 
@@ -263,7 +270,8 @@
 {
 	uint8 *next = options;
 	next = PutOption(next, OPTION_MESSAGE_TYPE, type);
-	next = PutOption(next, OPTION_MESSAGE_SIZE, (uint16)htons(sizeof(dhcp_message)));
+	next = PutOption(next, OPTION_MESSAGE_SIZE,
+		(uint16)htons(sizeof(dhcp_message)));
 	return next;
 }
 
@@ -298,7 +306,8 @@
 
 
 uint8*
-dhcp_message::PutOption(uint8* options, message_option option, const uint8* data, uint32 size)
+dhcp_message::PutOption(uint8* options, message_option option,
+	const uint8* data, uint32 size)
 {
 	options[0] = option;
 	options[1] = size;
@@ -438,9 +447,10 @@
 
 			if (state == INIT)
 				status = _SendMessage(socket, discover, broadcast);
-			else
+			else {
 				status = _SendMessage(socket, request, state != RENEWAL
 					? broadcast : fServer);
+			}
 
 			if (status &lt; B_OK)
 				break;
@@ -490,13 +500,15 @@
 				_PrepareMessage(request, state);
 
 				status = _SendMessage(socket, request, broadcast);
-					// we're sending a broadcast so that all potential offers get an answer
+					// we're sending a broadcast so that all potential offers
+					// get an answer
 				break;
 			}
 
 			case DHCP_ACK:
 			{
-				if (state != REQUESTING &amp;&amp; state != REBINDING &amp;&amp; state != RENEWAL)
+				if (state != REQUESTING &amp;&amp; state != REBINDING
+					&amp;&amp; state != RENEWAL)
 					continue;
 
 				// TODO: we might want to configure the stuff, don't we?
@@ -520,7 +532,8 @@
 				if (state != REQUESTING)
 					continue;
 
-				// try again (maybe we should prefer other servers if this happens more than once)
+				// try again (maybe we should prefer other servers if this
+				// happens more than once)
 				status = _SendMessage(socket, discover, broadcast);
 				if (status == B_OK)
 					state = INIT;
@@ -591,8 +604,10 @@
 				FILE* file = fopen(&quot;/etc/resolv.conf&quot;, &quot;w&quot;);
 				for (uint32 i = 0; i &lt; size / 4; i++) {
 					printf(&quot;DNS: %s\n&quot;, _ToString(&amp;data[i*4]).String());
-					if (file != NULL)
-						fprintf(file, &quot;nameserver %s\n&quot;, _ToString(&amp;data[i*4]).String());
+					if (file != NULL) {
+						fprintf(file, &quot;nameserver %s\n&quot;,
+							_ToString(&amp;data[i*4]).String());
+					}
 				}
 				fclose(file);
 				break;
@@ -652,7 +667,8 @@
 	message.hardware_type = ARP_HARDWARE_TYPE_ETHER;
 	message.hardware_address_length = 6;
 	message.transaction_id = htonl(fTransactionID);
-	message.seconds_since_start = htons(min_c((fStartTime - system_time()) / 1000000LL, 65535));
+	message.seconds_since_start = htons(min_c((fStartTime - system_time())
+		/ 1000000LL, 65535));
 	memcpy(message.mac_address, fMAC, 6);
 
 	message_type type = message.Type();
@@ -669,9 +685,10 @@
 			// In RENEWAL or REBINDING state, we must set the client_address field, and not
 			// use OPTION_REQUEST_IP_ADDRESS for DHCP_REQUEST messages
 			if (type == DHCP_REQUEST &amp;&amp; (state == INIT || state == REQUESTING)) {
-				next = message.PutOption(next, OPTION_REQUEST_IP_ADDRESS, fAssignedAddress);
+				next = message.PutOption(next, OPTION_REQUEST_IP_ADDRESS,
+					(uint32)fAssignedAddress);
 				next = message.PutOption(next, OPTION_REQUEST_PARAMETERS,
-										 kRequiredParameters, sizeof(kRequiredParameters));
+					kRequiredParameters, sizeof(kRequiredParameters));
 			} else
 				message.client_address = fAssignedAddress;
 
@@ -683,7 +700,7 @@
 		{
 			uint8 *next = message.PrepareMessage(type);
 			next = message.PutOption(next, OPTION_REQUEST_PARAMETERS,
-									 kRequiredParameters, sizeof(kRequiredParameters));
+				kRequiredParameters, sizeof(kRequiredParameters));
 			message.FinishOptions(next);
 			break;
 		}


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="004375.html">[Haiku-commits] r22642 - in haiku/trunk/src/kits: . bluetooth
</A></li>
	<LI>Next message: <A HREF="004377.html">[Haiku-commits] r22644 -	haiku/trunk/src/add-ons/kernel/file_systems/nfs
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4376">[ date ]</a>
              <a href="thread.html#4376">[ thread ]</a>
              <a href="subject.html#4376">[ subject ]</a>
              <a href="author.html#4376">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/haiku-commits">More information about the Haiku-commits
mailing list</a><br>
</body></html>
