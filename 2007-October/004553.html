<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Haiku-commits] r22781 - in haiku/trunk: headers/private/kernel	headers/private/kernel/disk_device_manager	headers/private/storage src/kits/storage/disk_device	src/kits/storage/disk_device/jobs	src/system/kernel/disk_device_manager
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/haiku-commits/2007-October/index.html" >
   <LINK REL="made" HREF="mailto:haiku-commits%40lists.berlios.de?Subject=Re%3A%20%5BHaiku-commits%5D%20r22781%20-%20in%20haiku/trunk%3A%20headers/private/kernel%0A%09headers/private/kernel/disk_device_manager%0A%09headers/private/storage%20src/kits/storage/disk_device%0A%09src/kits/storage/disk_device/jobs%0A%09src/system/kernel/disk_device_manager&In-Reply-To=%3C200710312116.l9VLGN22004264%40sheep.berlios.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="004552.html">
   
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Haiku-commits] r22781 - in haiku/trunk: headers/private/kernel	headers/private/kernel/disk_device_manager	headers/private/storage src/kits/storage/disk_device	src/kits/storage/disk_device/jobs	src/system/kernel/disk_device_manager</H1>
    <B>bonefish at BerliOS</B> 
    <A HREF="mailto:haiku-commits%40lists.berlios.de?Subject=Re%3A%20%5BHaiku-commits%5D%20r22781%20-%20in%20haiku/trunk%3A%20headers/private/kernel%0A%09headers/private/kernel/disk_device_manager%0A%09headers/private/storage%20src/kits/storage/disk_device%0A%09src/kits/storage/disk_device/jobs%0A%09src/system/kernel/disk_device_manager&In-Reply-To=%3C200710312116.l9VLGN22004264%40sheep.berlios.de%3E"
       TITLE="[Haiku-commits] r22781 - in haiku/trunk: headers/private/kernel	headers/private/kernel/disk_device_manager	headers/private/storage src/kits/storage/disk_device	src/kits/storage/disk_device/jobs	src/system/kernel/disk_device_manager">bonefish at mail.berlios.de
       </A><BR>
    <I>Wed Oct 31 22:16:23 CET 2007</I>
    <P><UL>
        <LI>Previous message: <A HREF="004552.html">[Haiku-commits] r22780 - in haiku/trunk:	headers/private/graphics/intel_extreme	src/add-ons/accelerants/intel_extreme
</A></li>
        
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4553">[ date ]</a>
              <a href="thread.html#4553">[ thread ]</a>
              <a href="subject.html#4553">[ subject ]</a>
              <a href="author.html#4553">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: bonefish
Date: 2007-10-31 22:16:22 +0100 (Wed, 31 Oct 2007)
New Revision: 22781
ViewCVS: <A HREF="http://svn.berlios.de/viewcvs/haiku?rev=22781&amp;view=rev">http://svn.berlios.de/viewcvs/haiku?rev=22781&amp;view=rev</A>

Modified:
   haiku/trunk/headers/private/kernel/disk_device_manager/ddm_userland_interface.h
   haiku/trunk/headers/private/kernel/syscalls.h
   haiku/trunk/headers/private/storage/PartitioningInfo.h
   haiku/trunk/src/kits/storage/disk_device/PartitionReference.cpp
   haiku/trunk/src/kits/storage/disk_device/PartitionReference.h
   haiku/trunk/src/kits/storage/disk_device/PartitioningInfo.cpp
   haiku/trunk/src/kits/storage/disk_device/jobs/CreateChildJob.cpp
   haiku/trunk/src/kits/storage/disk_device/jobs/DefragmentJob.cpp
   haiku/trunk/src/kits/storage/disk_device/jobs/DeleteChildJob.cpp
   haiku/trunk/src/kits/storage/disk_device/jobs/InitializeJob.cpp
   haiku/trunk/src/kits/storage/disk_device/jobs/MoveJob.cpp
   haiku/trunk/src/kits/storage/disk_device/jobs/RepairJob.cpp
   haiku/trunk/src/kits/storage/disk_device/jobs/ResizeJob.cpp
   haiku/trunk/src/kits/storage/disk_device/jobs/SetStringJob.cpp
   haiku/trunk/src/kits/storage/disk_device/jobs/UninitializeJob.cpp
   haiku/trunk/src/system/kernel/disk_device_manager/ddm_userland_interface.cpp
Log:
* Removed no longer needed disk device related syscalls
  (_kern_{supports,validate}_*(), etc.).
* Adjusted the prototypes of the disk device modification syscalls.
  Commented out their implementations for the time -- they'll mostly
  have to be rewritten completely.
* Implemented the userland disk device jobs.


Modified: haiku/trunk/headers/private/kernel/disk_device_manager/ddm_userland_interface.h
===================================================================
--- haiku/trunk/headers/private/kernel/disk_device_manager/ddm_userland_interface.h	2007-10-31 19:23:59 UTC (rev 22780)
+++ haiku/trunk/headers/private/kernel/disk_device_manager/ddm_userland_interface.h	2007-10-31 21:16:22 UTC (rev 22781)
@@ -86,134 +86,49 @@
 										 user_disk_system_info *info);
 status_t _user_find_disk_system(const char *name, user_disk_system_info *info);
 
-bool _user_supports_defragmenting_partition(partition_id partitionID,
-											int32 changeCounter,
-											bool *whileMounted);
-bool _user_supports_repairing_partition(partition_id partitionID,
-										int32 changeCounter, bool checkOnly,
-										bool *whileMounted);
-bool _user_supports_resizing_partition(partition_id partitionID,
-									   int32 changeCounter,
-									   bool *canResizeContents,
-									   bool *whileMounted);
-bool _user_supports_moving_partition(partition_id partitionID,
-									 int32 changeCounter,
-									 partition_id *unmovable,
-									 partition_id *needUnmounting,
-									 size_t bufferSize);
-bool _user_supports_setting_partition_name(partition_id partitionID,
-										   int32 changeCounter);
-bool _user_supports_setting_partition_content_name(partition_id partitionID,
-												   int32 changeCounter,
-												   bool *whileMounted);
-bool _user_supports_setting_partition_type(partition_id partitionID,
-										   int32 changeCounter);
-bool _user_supports_setting_partition_parameters(partition_id partitionID,
-												 int32 changeCounter);
-bool _user_supports_setting_partition_content_parameters(
-	partition_id partitionID, int32 changeCounter, bool *whileMounted);
-bool _user_supports_initializing_partition(partition_id partitionID,
-										   int32 changeCounter,
-										   const char *diskSystemName);
-bool _user_supports_creating_child_partition(partition_id partitionID,
-											 int32 changeCounter);
-bool _user_supports_deleting_child_partition(partition_id partitionID,
-											 int32 changeCounter);
-bool _user_is_sub_disk_system_for(disk_system_id diskSystemID,
-								  partition_id partitionID,
-								  int32 changeCounter);
-
-status_t _user_validate_resize_partition(partition_id partitionID,
-										 int32 changeCounter, off_t *size);
-status_t _user_validate_move_partition(partition_id partitionID,
-									   int32 changeCounter, off_t *newOffset);
-status_t _user_validate_set_partition_name(partition_id partitionID,
-										   int32 changeCounter, char *name);
-status_t _user_validate_set_partition_content_name(partition_id partitionID,
-												   int32 changeCounter,
-												   char *name);
-status_t _user_validate_set_partition_type(partition_id partitionID,
-										   int32 changeCounter,
-										   const char *type);
-status_t _user_validate_initialize_partition(partition_id partitionID,
-											 int32 changeCounter,
-											 const char *diskSystemName,
-											 char *name,
-											 const char *parameters,
-											 size_t parametersSize);
-status_t _user_validate_create_child_partition(partition_id partitionID,
-											   int32 changeCounter,
-											   off_t *offset, off_t *size,
-											   const char *type,
-											   const char *parameters,
-											   size_t parametersSize);
-status_t _user_get_partitionable_spaces(partition_id partitionID,
-										int32 changeCounter,
-										partitionable_space_data *buffer,
-										int32 count, int32 *actualCount);
-status_t _user_get_next_supported_partition_type(partition_id partitionID,
-												 int32 changeCounter,
-												 int32 *cookie, char *type);
-status_t _user_get_partition_type_for_content_type(disk_system_id diskSystemID,
-												   const char *contentType,
-												   char *type);
-
 // disk device modification
-status_t _user_prepare_disk_device_modifications(partition_id deviceID);
-status_t _user_commit_disk_device_modifications(partition_id deviceID,
-												port_id port, int32 token,
-												bool completeProgress);
-status_t _user_cancel_disk_device_modifications(partition_id deviceID);
-bool _user_is_disk_device_modified(partition_id deviceID);
-
 status_t _user_defragment_partition(partition_id partitionID,
-									int32 changeCounter);
-status_t _user_repair_partition(partition_id partitionID, int32 changeCounter,
-								bool checkOnly);
-status_t _user_resize_partition(partition_id partitionID, int32 changeCounter,
-								off_t size);
-status_t _user_move_partition(partition_id partitionID, int32 changeCounter,
-							  off_t newOffset);
+				int32* changeCounter);
+status_t _user_repair_partition(partition_id partitionID, int32* changeCounter,
+				bool checkOnly);
+status_t _user_resize_partition(partition_id partitionID, int32* changeCounter,
+				partition_id childID, int32* childChangeCounter, off_t size,
+				off_t contentSize);
+status_t _user_move_partition(partition_id partitionID, int32* changeCounter,
+				partition_id childID, int32* childChangeCounter,
+				off_t newOffset, partition_id* descendantIDs,
+				int32* descendantChangeCounters, int32 descendantCount);
 status_t _user_set_partition_name(partition_id partitionID,
-								  int32 changeCounter, const char *name);
+				int32* changeCounter, partition_id childID,
+				int32* childChangeCounter, const char* name);
 status_t _user_set_partition_content_name(partition_id partitionID,
-										  int32 changeCounter,
-										  const char *name);
+				int32* changeCounter, const char* name);
 status_t _user_set_partition_type(partition_id partitionID,
-								  int32 changeCounter, const char *type);
+				int32* changeCounter, partition_id childID,
+				int32* childChangeCounter, const char* type);
 status_t _user_set_partition_parameters(partition_id partitionID,
-										int32 changeCounter,
-										const char *parameters,
-										size_t parametersSize);
+				int32* changeCounter, partition_id childID,
+				int32* childChangeCounter, const char* parameters,
+				size_t parametersSize);
 status_t _user_set_partition_content_parameters(partition_id partitionID,
-												int32 changeCounter,
-												const char *parameters,
-												size_t parametersSize);
+				int32* changeCounter, const char* parameters,
+				size_t parametersSize);
 status_t _user_initialize_partition(partition_id partitionID,
-									int32 changeCounter,
-									const char *diskSystemName,
-									const char *name, const char *parameters,
-									size_t parametersSize);
+				int32* changeCounter, const char* diskSystemName,
+				const char* name, const char* parameters,
+				size_t parametersSize);
 status_t _user_uninitialize_partition(partition_id partitionID,
-									  int32 changeCounter);
+				int32* changeCounter);
+
 status_t _user_create_child_partition(partition_id partitionID,
-									  int32 changeCounter, off_t offset,
-									  off_t size, const char *type,
-									  const char *parameters,
-									  size_t parametersSize,
-									  partition_id *childID);
-status_t _user_delete_partition(partition_id partitionID, int32 changeCounter);
+				int32* changeCounter, off_t offset, off_t size,
+				const char* type, const char* name, const char* parameters,
+				size_t parametersSize, partition_id* childID,
+				int32* childChangeCounter);
+status_t _user_delete_child_partition(partition_id partitionID,
+				int32* changeCounter, partition_id childID,
+				int32 childChangeCounter);
 
-// jobs
-status_t _user_get_next_disk_device_job_info(int32 *cookie,
-											 user_disk_device_job_info *info);
-status_t _user_get_disk_device_job_info(disk_job_id id,
-										user_disk_device_job_info *info);
-status_t _user_get_disk_device_job_progress_info(disk_job_id id,
-	disk_device_job_progress_info *info);
-status_t _user_pause_disk_device_job(disk_job_id id);
-status_t _user_cancel_disk_device_job(disk_job_id id, bool reverse);
-
 #ifdef __cplusplus
 }
 #endif

Modified: haiku/trunk/headers/private/kernel/syscalls.h
===================================================================
--- haiku/trunk/headers/private/kernel/syscalls.h	2007-10-31 19:23:59 UTC (rev 22780)
+++ haiku/trunk/headers/private/kernel/syscalls.h	2007-10-31 21:16:22 UTC (rev 22781)
@@ -340,108 +340,51 @@
 						struct user_disk_system_info *info);
 extern status_t		_kern_find_disk_system(const char *name,
 						struct user_disk_system_info *info);
-extern bool			_kern_supports_defragmenting_partition(partition_id partitionID,
-						int32 changeCounter, bool *whileMounted);
-extern bool			_kern_supports_repairing_partition(partition_id partitionID,
-						int32 changeCounter, bool checkOnly, bool *whileMounted);
-extern bool			_kern_supports_resizing_partition(partition_id partitionID,
-						int32 changeCounter, bool *canResizeContents, bool *whileMounted);
-extern bool			_kern_supports_moving_partition(partition_id partitionID,
-						int32 changeCounter, partition_id *unmovable,
-						partition_id *needUnmounting, size_t bufferSize);
-extern bool			_kern_supports_setting_partition_name(partition_id partitionID,
-						int32 changeCounter);
-extern bool			_kern_supports_setting_partition_content_name(partition_id partitionID,
-						int32 changeCounter, bool *whileMounted);
-extern bool			_kern_supports_setting_partition_type(partition_id partitionID,
-						int32 changeCounter);
-extern bool			_kern_supports_setting_partition_parameters(partition_id partitionID,
-						int32 changeCounter);
-extern bool			_kern_supports_setting_partition_content_parameters(
-						partition_id partitionID, int32 changeCounter, bool *whileMounted);
-extern bool			_kern_supports_initializing_partition(partition_id partitionID,
-						int32 changeCounter, const char *diskSystemName);
-extern bool			_kern_supports_creating_child_partition(partition_id partitionID,
-						int32 changeCounter);
-extern bool			_kern_supports_deleting_child_partition(partition_id partitionID,
-						int32 changeCounter);
-extern bool			_kern_is_sub_disk_system_for(disk_system_id diskSystemID,
-						partition_id partitionID, int32 changeCounter);
 
-extern status_t		_kern_validate_resize_partition(partition_id partitionID,
-						int32 changeCounter, off_t *size);
-extern status_t		_kern_validate_move_partition(partition_id partitionID,
-						int32 changeCounter, off_t *newOffset);
-extern status_t		_kern_validate_set_partition_name(partition_id partitionID,
-						int32 changeCounter, char *name);
-extern status_t		_kern_validate_set_partition_content_name(partition_id partitionID,
-						int32 changeCounter, char *name);
-extern status_t		_kern_validate_set_partition_type(partition_id partitionID,
-						int32 changeCounter, const char *type);
-extern status_t		_kern_validate_initialize_partition(partition_id partitionID,
-						int32 changeCounter, const char *diskSystemName,
-						char *name, const char *parameters, size_t parametersSize);
-extern status_t		_kern_validate_create_child_partition(partition_id partitionID,
-						int32 changeCounter, off_t *offset, off_t *size,
-						const char *type, const char *parameters,
-						size_t parametersSize);
-extern status_t		_kern_get_partitionable_spaces(partition_id partitionID,
-						int32 changeCounter,
-						struct partitionable_space_data *buffer, int32 count,
-						int32 *actualCount);
-extern status_t		_kern_get_next_supported_partition_type(partition_id partitionID,
-						int32 changeCounter, int32 *cookie, char *type);
-extern status_t		_kern_get_partition_type_for_content_type(disk_system_id diskSystemID,
-						const char *contentType, char *type);
-
 // disk device modification
-extern status_t		_kern_prepare_disk_device_modifications(partition_id deviceID);
-extern status_t		_kern_commit_disk_device_modifications(partition_id deviceID,
-						port_id port, int32 token, bool completeProgress);
-extern status_t		_kern_cancel_disk_device_modifications(partition_id deviceID);
-extern bool			_kern_is_disk_device_modified(partition_id deviceID);
 extern status_t		_kern_defragment_partition(partition_id partitionID,
-						int32 changeCounter);
-extern status_t		_kern_repair_partition(partition_id partitionID, int32 changeCounter,
-						bool checkOnly);
-extern status_t		_kern_resize_partition(partition_id partitionID, int32 changeCounter,
-						off_t size);
-extern status_t		_kern_move_partition(partition_id partitionID, int32 changeCounter,
-						off_t newOffset);
+						int32* changeCounter);
+extern status_t		_kern_repair_partition(partition_id partitionID,
+						int32* changeCounter, bool checkOnly);
+extern status_t		_kern_resize_partition(partition_id partitionID,
+						int32* changeCounter, partition_id childID,
+						int32* childChangeCounter, off_t size,
+						off_t contentSize);
+extern status_t		_kern_move_partition(partition_id partitionID,
+						int32* changeCounter, partition_id childID,
+						int32* childChangeCounter, off_t newOffset,
+						partition_id* descendantIDs,
+						int32* descendantChangeCounters, int32 descendantCount);
 extern status_t		_kern_set_partition_name(partition_id partitionID,
-						int32 changeCounter, const char *name);
+						int32* changeCounter, partition_id childID,
+						int32* childChangeCounter, const char* name);
 extern status_t		_kern_set_partition_content_name(partition_id partitionID,
-						int32 changeCounter, const char *name);
+						int32* changeCounter, const char* name);
 extern status_t		_kern_set_partition_type(partition_id partitionID,
-						int32 changeCounter, const char *type);
+						int32* changeCounter, partition_id childID,
+						int32* childChangeCounter, const char* type);
 extern status_t		_kern_set_partition_parameters(partition_id partitionID,
-						int32 changeCounter, const char *parameters,
+						int32* changeCounter, partition_id childID,
+						int32* childChangeCounter, const char* parameters,
 						size_t parametersSize);
-extern status_t		_kern_set_partition_content_parameters(partition_id partitionID,
-						int32 changeCounter, const char *parameters,
-						size_t parametersSize);
+extern status_t		_kern_set_partition_content_parameters(
+						partition_id partitionID, int32* changeCounter,
+						const char* parameters, size_t parametersSize);
 extern status_t		_kern_initialize_partition(partition_id partitionID,
-						int32 changeCounter, const char *diskSystemName,
-						const char *name, const char *parameters,
+						int32* changeCounter, const char* diskSystemName,
+						const char* name, const char* parameters,
 						size_t parametersSize);
 extern status_t		_kern_uninitialize_partition(partition_id partitionID,
-						int32 changeCounter);
+						int32* changeCounter);
 extern status_t		_kern_create_child_partition(partition_id partitionID,
-						int32 changeCounter, off_t offset, off_t size, const char *type,
-						const char *parameters, size_t parametersSize,
-						partition_id *childID);
-extern status_t		_kern_delete_partition(partition_id partitionID, int32 changeCounter);
+						int32* changeCounter, off_t offset, off_t size,
+						const char* type, const char* name,
+						const char* parameters, size_t parametersSize,
+						partition_id* childID, int32* childChangeCounter);
+extern status_t		_kern_delete_child_partition(partition_id partitionID,
+						int32* changeCounter, partition_id childID,
+						int32 childChangeCounter);
 
-// jobs
-extern status_t		_kern_get_next_disk_device_job_info(int32 *cookie,
-						struct user_disk_device_job_info *info);
-extern status_t		_kern_get_disk_device_job_info(disk_job_id id,
-						struct user_disk_device_job_info *info);
-extern status_t		_kern_get_disk_device_job_progress_info(disk_job_id id,
-						struct disk_device_job_progress_info *info);
-extern status_t		_kern_pause_disk_device_job(disk_job_id id);
-extern status_t		_kern_cancel_disk_device_job(disk_job_id id, bool reverse);
-
 #if 0
 
 // watching

Modified: haiku/trunk/headers/private/storage/PartitioningInfo.h
===================================================================
--- haiku/trunk/headers/private/storage/PartitioningInfo.h	2007-10-31 19:23:59 UTC (rev 22780)
+++ haiku/trunk/headers/private/storage/PartitioningInfo.h	2007-10-31 21:16:22 UTC (rev 22781)
@@ -29,9 +29,6 @@
 			int32				CountPartitionableSpaces() const;
 
 private:
-			status_t			_SetTo(partition_id partition,
-									int32 changeCounter);
-
 			status_t			_InsertSpaces(int32 index, int32 count);
 			void				_RemoveSpaces(int32 index, int32 count);
 

Modified: haiku/trunk/src/kits/storage/disk_device/PartitionReference.cpp
===================================================================
--- haiku/trunk/src/kits/storage/disk_device/PartitionReference.cpp	2007-10-31 19:23:59 UTC (rev 22780)
+++ haiku/trunk/src/kits/storage/disk_device/PartitionReference.cpp	2007-10-31 21:16:22 UTC (rev 22781)
@@ -7,7 +7,7 @@
 
 
 // constructor
-PartitionReference::PartitionReference(partition_id id, uint32 changeCounter)
+PartitionReference::PartitionReference(partition_id id, int32 changeCounter)
 	: Referenceable(true),	// delete when unreferenced
 	  fID(id),
 	  fChangeCounter(changeCounter)
@@ -21,6 +21,15 @@
 }
 
 
+// SetTo
+void
+PartitionReference::SetTo(partition_id id, int32 changeCounter)
+{
+	fID = id;
+	fChangeCounter = changeCounter;
+}
+
+
 // PartitionID
 partition_id
 PartitionReference::PartitionID() const
@@ -38,7 +47,7 @@
 
 
 // ChangeCounter
-uint32
+int32
 PartitionReference::ChangeCounter() const
 {
 	return fChangeCounter;
@@ -47,7 +56,7 @@
 
 // SetChangeCounter
 void
-PartitionReference::SetChangeCounter(uint32 counter)
+PartitionReference::SetChangeCounter(int32 counter)
 {
 	fChangeCounter = counter;
 }

Modified: haiku/trunk/src/kits/storage/disk_device/PartitionReference.h
===================================================================
--- haiku/trunk/src/kits/storage/disk_device/PartitionReference.h	2007-10-31 19:23:59 UTC (rev 22780)
+++ haiku/trunk/src/kits/storage/disk_device/PartitionReference.h	2007-10-31 21:16:22 UTC (rev 22781)
@@ -16,18 +16,20 @@
 class PartitionReference : public Referenceable {
 public:
 								PartitionReference(partition_id id = -1,
-									uint32 changeCounter = 0);
+									int32 changeCounter = 0);
 								~PartitionReference();
 
+			void				SetTo(partition_id id, int32 changeCounter);
+
 			partition_id		PartitionID() const;
 			void				SetPartitionID(partition_id id);
 
-			uint32				ChangeCounter() const;
-			void				SetChangeCounter(uint32 counter);
+			int32				ChangeCounter() const;
+			void				SetChangeCounter(int32 counter);
 
 private:
 			partition_id		fID;
-			uint32				fChangeCounter;
+			int32				fChangeCounter;
 };
 
 

Modified: haiku/trunk/src/kits/storage/disk_device/PartitioningInfo.cpp
===================================================================
--- haiku/trunk/src/kits/storage/disk_device/PartitioningInfo.cpp	2007-10-31 19:23:59 UTC (rev 22780)
+++ haiku/trunk/src/kits/storage/disk_device/PartitioningInfo.cpp	2007-10-31 21:16:22 UTC (rev 22781)
@@ -170,45 +170,6 @@
 }
 
 
-// _SetTo
-status_t
-BPartitioningInfo::_SetTo(partition_id partition, int32 changeCounter)
-{
-	Unset();
-
-	status_t error = B_OK;
-	partitionable_space_data* buffer = NULL;
-	int32 count = 0;
-	int32 actualCount = 0;
-	while (true) {
-		error = _kern_get_partitionable_spaces(partition, changeCounter,
-			buffer, count, &amp;actualCount);
-		if (error != B_BUFFER_OVERFLOW)
-			break;
-
-		// buffer too small re-allocate it
-		delete[] buffer;
-		buffer = new(nothrow) partitionable_space_data[actualCount];
-		if (!buffer) {
-			error = B_NO_MEMORY;
-			break;
-		}
-
-		count = actualCount;
-	}
-
-	// set data / cleanup on failure
-	if (error == B_OK) {
-		fPartitionID = partition;
-		fSpaces = buffer;
-		fCount = actualCount;
-	} else if (buffer)
-		delete[] buffer;
-
-	return error;
-}
-
-
 // _InsertSpaces
 status_t
 BPartitioningInfo::_InsertSpaces(int32 index, int32 count)

Modified: haiku/trunk/src/kits/storage/disk_device/jobs/CreateChildJob.cpp
===================================================================
--- haiku/trunk/src/kits/storage/disk_device/jobs/CreateChildJob.cpp	2007-10-31 19:23:59 UTC (rev 22780)
+++ haiku/trunk/src/kits/storage/disk_device/jobs/CreateChildJob.cpp	2007-10-31 21:16:22 UTC (rev 22781)
@@ -5,6 +5,8 @@
 
 #include &quot;CreateChildJob.h&quot;
 
+#include &lt;syscalls.h&gt;
+
 #include &quot;DiskDeviceUtils.h&quot;
 #include &quot;PartitionReference.h&quot;
 
@@ -51,7 +53,18 @@
 status_t
 CreateChildJob::Do()
 {
-// Implement!
-	return B_BAD_VALUE;
+	int32 changeCounter = fPartition-&gt;ChangeCounter();
+	partition_id childID;
+	int32 childChangeCounter;
+	status_t error = _kern_create_child_partition(fPartition-&gt;PartitionID(),
+		&amp;changeCounter, fOffset, fSize, fType, fName, fParameters,
+		fParameters ? strlen(fParameters) : 0, &amp;childID, &amp;childChangeCounter);
+	if (error != B_OK)
+		return error;
+
+	fPartition-&gt;SetChangeCounter(changeCounter);
+	fChild-&gt;SetTo(childID, childChangeCounter);
+
+	return B_OK;
 }
 

Modified: haiku/trunk/src/kits/storage/disk_device/jobs/DefragmentJob.cpp
===================================================================
--- haiku/trunk/src/kits/storage/disk_device/jobs/DefragmentJob.cpp	2007-10-31 19:23:59 UTC (rev 22780)
+++ haiku/trunk/src/kits/storage/disk_device/jobs/DefragmentJob.cpp	2007-10-31 21:16:22 UTC (rev 22781)
@@ -5,6 +5,8 @@
 
 #include &quot;DefragmentJob.h&quot;
 
+#include &lt;syscalls.h&gt;
+
 #include &quot;PartitionReference.h&quot;
 
 
@@ -25,7 +27,14 @@
 status_t
 DefragmentJob::Do()
 {
-// Implement!
-	return B_BAD_VALUE;
+	int32 changeCounter = fPartition-&gt;ChangeCounter();
+	status_t error = _kern_defragment_partition(fPartition-&gt;PartitionID(),
+		&amp;changeCounter);
+	if (error != B_OK)
+		return error;
+
+	fPartition-&gt;SetChangeCounter(changeCounter);
+
+	return B_OK;
 }
 

Modified: haiku/trunk/src/kits/storage/disk_device/jobs/DeleteChildJob.cpp
===================================================================
--- haiku/trunk/src/kits/storage/disk_device/jobs/DeleteChildJob.cpp	2007-10-31 19:23:59 UTC (rev 22780)
+++ haiku/trunk/src/kits/storage/disk_device/jobs/DeleteChildJob.cpp	2007-10-31 21:16:22 UTC (rev 22781)
@@ -5,6 +5,8 @@
 
 #include &quot;DeleteChildJob.h&quot;
 
+#include &lt;syscalls.h&gt;
+
 #include &quot;DiskDeviceUtils.h&quot;
 #include &quot;PartitionReference.h&quot;
 
@@ -27,7 +29,15 @@
 status_t
 DeleteChildJob::Do()
 {
-// Implement!
-	return B_BAD_VALUE;
+	int32 changeCounter = fPartition-&gt;ChangeCounter();
+	status_t error = _kern_delete_child_partition(fPartition-&gt;PartitionID(),
+		&amp;changeCounter, fChild-&gt;PartitionID(), fChild-&gt;ChangeCounter());
+	if (error != B_OK)
+		return error;
+
+	fPartition-&gt;SetChangeCounter(changeCounter);
+	fChild-&gt;SetTo(-1, 0);
+
+	return B_OK;
 }
 

Modified: haiku/trunk/src/kits/storage/disk_device/jobs/InitializeJob.cpp
===================================================================
--- haiku/trunk/src/kits/storage/disk_device/jobs/InitializeJob.cpp	2007-10-31 19:23:59 UTC (rev 22780)
+++ haiku/trunk/src/kits/storage/disk_device/jobs/InitializeJob.cpp	2007-10-31 21:16:22 UTC (rev 22781)
@@ -5,6 +5,8 @@
 
 #include &quot;InitializeJob.h&quot;
 
+#include &lt;syscalls.h&gt;
+
 #include &quot;DiskDeviceUtils.h&quot;
 #include &quot;PartitionReference.h&quot;
 
@@ -45,7 +47,16 @@
 status_t
 InitializeJob::Do()
 {
-// Implement!
-	return B_BAD_VALUE;
+	int32 changeCounter = fPartition-&gt;ChangeCounter();
+	status_t error = _kern_initialize_partition(fPartition-&gt;PartitionID(),
+		&amp;changeCounter, fDiskSystem, fName, fParameters,
+		fParameters ? strlen(fParameters) : 0);
+
+	if (error != B_OK)
+		return error;
+
+	fPartition-&gt;SetChangeCounter(changeCounter);
+
+	return B_OK;
 }
 

Modified: haiku/trunk/src/kits/storage/disk_device/jobs/MoveJob.cpp
===================================================================
--- haiku/trunk/src/kits/storage/disk_device/jobs/MoveJob.cpp	2007-10-31 19:23:59 UTC (rev 22780)
+++ haiku/trunk/src/kits/storage/disk_device/jobs/MoveJob.cpp	2007-10-31 21:16:22 UTC (rev 22781)
@@ -3,10 +3,14 @@
  * Distributed under the terms of the MIT License.
  */
 
+#include &quot;MoveJob.h&quot;
+
 #include &lt;new&gt;
 
-#include &quot;MoveJob.h&quot;
+#include &lt;AutoDeleter.h&gt;
 
+#include &lt;syscalls.h&gt;
+
 #include &quot;DiskDeviceUtils.h&quot;
 #include &quot;PartitionReference.h&quot;
 
@@ -58,7 +62,35 @@
 status_t
 MoveJob::Do()
 {
-// Implement!
-	return B_BAD_VALUE;
+	int32 changeCounter = fPartition-&gt;ChangeCounter();
+	int32 childChangeCounter = fChild-&gt;ChangeCounter();
+
+	partition_id* descendantIDs = new(nothrow) partition_id[fContentsCount];
+	int32* descendantChangeCounters = new(nothrow) int32[fContentsCount];
+	ArrayDeleter&lt;partition_id&gt; _(descendantIDs);
+	ArrayDeleter&lt;int32&gt; _2(descendantChangeCounters);
+
+	if (!descendantIDs || !descendantChangeCounters)
+		return B_NO_MEMORY;
+
+	for (int32 i = 0; i &lt; fContentsCount; i++) {
+		descendantIDs[i] = fContents[i]-&gt;PartitionID();
+		descendantChangeCounters[i] = fContents[i]-&gt;ChangeCounter();
+	}
+
+	status_t error = _kern_move_partition(fPartition-&gt;PartitionID(),
+		&amp;changeCounter, fChild-&gt;PartitionID(), &amp;childChangeCounter, fOffset,
+		descendantIDs, descendantChangeCounters, fContentsCount);
+
+	if (error != B_OK)
+		return error;
+
+	fPartition-&gt;SetChangeCounter(changeCounter);
+	fChild-&gt;SetChangeCounter(childChangeCounter);
+
+	for (int32 i = 0; i &lt; fContentsCount; i++)
+		fContents[i]-&gt;SetChangeCounter(descendantChangeCounters[i]);
+
+	return B_OK;
 }
 

Modified: haiku/trunk/src/kits/storage/disk_device/jobs/RepairJob.cpp
===================================================================
--- haiku/trunk/src/kits/storage/disk_device/jobs/RepairJob.cpp	2007-10-31 19:23:59 UTC (rev 22780)
+++ haiku/trunk/src/kits/storage/disk_device/jobs/RepairJob.cpp	2007-10-31 21:16:22 UTC (rev 22781)
@@ -5,6 +5,8 @@
 
 #include &quot;RepairJob.h&quot;
 
+#include &lt;syscalls.h&gt;
+
 #include &quot;PartitionReference.h&quot;
 
 
@@ -26,7 +28,14 @@
 status_t
 RepairJob::Do()
 {
-// Implement!
-	return B_BAD_VALUE;
+	int32 changeCounter = fPartition-&gt;ChangeCounter();
+	status_t error = _kern_repair_partition(fPartition-&gt;PartitionID(),
+		&amp;changeCounter, fCheckOnly);
+	if (error != B_OK)
+		return error;
+
+	fPartition-&gt;SetChangeCounter(changeCounter);
+
+	return B_OK;
 }
 

Modified: haiku/trunk/src/kits/storage/disk_device/jobs/ResizeJob.cpp
===================================================================
--- haiku/trunk/src/kits/storage/disk_device/jobs/ResizeJob.cpp	2007-10-31 19:23:59 UTC (rev 22780)
+++ haiku/trunk/src/kits/storage/disk_device/jobs/ResizeJob.cpp	2007-10-31 21:16:22 UTC (rev 22781)
@@ -5,6 +5,8 @@
 
 #include &quot;ResizeJob.h&quot;
 
+#include &lt;syscalls.h&gt;
+
 #include &quot;DiskDeviceUtils.h&quot;
 #include &quot;PartitionReference.h&quot;
 
@@ -29,7 +31,17 @@
 status_t
 ResizeJob::Do()
 {
-// Implement!
-	return B_BAD_VALUE;
+	int32 changeCounter = fPartition-&gt;ChangeCounter();
+	int32 childChangeCounter = fChild-&gt;ChangeCounter();
+	status_t error = _kern_resize_partition(fPartition-&gt;PartitionID(),
+		&amp;changeCounter, fChild-&gt;PartitionID(), &amp;childChangeCounter, fSize,
+		fContentSize);
+	if (error != B_OK)
+		return error;
+
+	fPartition-&gt;SetChangeCounter(changeCounter);
+	fChild-&gt;SetChangeCounter(childChangeCounter);
+
+	return B_OK;
 }
 

Modified: haiku/trunk/src/kits/storage/disk_device/jobs/SetStringJob.cpp
===================================================================
--- haiku/trunk/src/kits/storage/disk_device/jobs/SetStringJob.cpp	2007-10-31 19:23:59 UTC (rev 22780)
+++ haiku/trunk/src/kits/storage/disk_device/jobs/SetStringJob.cpp	2007-10-31 21:16:22 UTC (rev 22781)
@@ -5,6 +5,8 @@
 
 #include &quot;SetStringJob.h&quot;
 
+#include &lt;syscalls.h&gt;
+
 #include &quot;DiskDeviceUtils.h&quot;
 #include &quot;PartitionReference.h&quot;
 
@@ -51,7 +53,50 @@
 status_t
 SetStringJob::Do()
 {
-// Implement!
-	return B_BAD_VALUE;
+	int32 changeCounter = fPartition-&gt;ChangeCounter();
+	int32 childChangeCounter = (fChild ? fChild-&gt;ChangeCounter() : 0);
+	status_t error;
+	bool updateChildChangeCounter = false;
+
+	switch (fJobType) {
+		case B_DISK_DEVICE_JOB_SET_NAME:
+			error = _kern_set_partition_name(fPartition-&gt;PartitionID(),
+				&amp;changeCounter, fChild-&gt;PartitionID(), &amp;childChangeCounter,
+				fString);
+			updateChildChangeCounter = true;
+			break;
+		case B_DISK_DEVICE_JOB_SET_CONTENT_NAME:
+			error = _kern_set_partition_content_name(fPartition-&gt;PartitionID(),
+				&amp;changeCounter, fString);
+			break;
+		case B_DISK_DEVICE_JOB_SET_TYPE:
+			error = _kern_set_partition_type(fPartition-&gt;PartitionID(),
+				&amp;changeCounter, fChild-&gt;PartitionID(), &amp;childChangeCounter,
+				fString);
+			updateChildChangeCounter = true;
+			break;
+		case B_DISK_DEVICE_JOB_SET_PARAMETERS:
+			error = _kern_set_partition_parameters(fPartition-&gt;PartitionID(),
+				&amp;changeCounter, fChild-&gt;PartitionID(), &amp;childChangeCounter,
+				fString, fString ? strlen(fString) : 0);
+			updateChildChangeCounter = true;
+			break;
+		case B_DISK_DEVICE_JOB_SET_CONTENT_PARAMETERS:
+			error = _kern_set_partition_content_parameters(
+				fPartition-&gt;PartitionID(), &amp;changeCounter, fString,
+				fString ? strlen(fString) : 0);
+			break;
+		default:
+			return B_BAD_VALUE;
+	}
+
+	if (error != B_OK)
+		return error;
+
+	fPartition-&gt;SetChangeCounter(changeCounter);
+	if (updateChildChangeCounter)
+		fChild-&gt;SetChangeCounter(childChangeCounter);
+
+	return B_OK;
 }
 

Modified: haiku/trunk/src/kits/storage/disk_device/jobs/UninitializeJob.cpp
===================================================================
--- haiku/trunk/src/kits/storage/disk_device/jobs/UninitializeJob.cpp	2007-10-31 19:23:59 UTC (rev 22780)
+++ haiku/trunk/src/kits/storage/disk_device/jobs/UninitializeJob.cpp	2007-10-31 21:16:22 UTC (rev 22781)
@@ -5,6 +5,8 @@
 
 #include &quot;UninitializeJob.h&quot;
 
+#include &lt;syscalls.h&gt;
+
 #include &quot;PartitionReference.h&quot;
 
 
@@ -25,7 +27,15 @@
 status_t
 UninitializeJob::Do()
 {
-// Implement!
-	return B_BAD_VALUE;
+	int32 changeCounter = fPartition-&gt;ChangeCounter();
+	status_t error = _kern_uninitialize_partition(fPartition-&gt;PartitionID(),
+		&amp;changeCounter);
+
+	if (error != B_OK)
+		return error;
+
+	fPartition-&gt;SetChangeCounter(changeCounter);
+
+	return B_OK;
 }
 

Modified: haiku/trunk/src/system/kernel/disk_device_manager/ddm_userland_interface.cpp
===================================================================
--- haiku/trunk/src/system/kernel/disk_device_manager/ddm_userland_interface.cpp	2007-10-31 19:23:59 UTC (rev 22780)
+++ haiku/trunk/src/system/kernel/disk_device_manager/ddm_userland_interface.cpp	2007-10-31 21:16:22 UTC (rev 22781)
@@ -448,848 +448,11 @@
 }
 
 
-// _user_supports_defragmenting_partition
-bool
-_user_supports_defragmenting_partition(partition_id partitionID,
-	int32 changeCounter, bool *_whileMounted)
-{
-	KDiskDeviceManager *manager = KDiskDeviceManager::Default();
-	// get the partition
-	KPartition *partition = manager-&gt;ReadLockPartition(partitionID);
-	if (!partition)
-		return false;
-	PartitionRegistrar registrar1(partition, true);
-	PartitionRegistrar registrar2(partition-&gt;Device(), true);
-	DeviceReadLocker locker(partition-&gt;Device(), true);
-	bool whileMounted;
-	bool result = validate_defragment_partition(partition, changeCounter,
-		&amp;whileMounted) == B_OK;
-	if (result &amp;&amp; _whileMounted)
-		user_memcpy(_whileMounted, &amp;whileMounted, sizeof(whileMounted));
-	return result;										   
-}
-
-
-// _user_supports_repairing_partition
-bool
-_user_supports_repairing_partition(partition_id partitionID,
-	int32 changeCounter, bool checkOnly, bool *_whileMounted)
-{
-	KDiskDeviceManager *manager = KDiskDeviceManager::Default();
-	// get the partition
-	KPartition *partition = manager-&gt;ReadLockPartition(partitionID);
-	if (!partition)
-		return false;
-	PartitionRegistrar registrar1(partition, true);
-	PartitionRegistrar registrar2(partition-&gt;Device(), true);
-	DeviceReadLocker locker(partition-&gt;Device(), true);
-	bool whileMounted;
-	bool result = validate_repair_partition(partition, changeCounter, checkOnly,
-		&amp;whileMounted) == B_OK;
-	if (result &amp;&amp; _whileMounted)
-		user_memcpy(_whileMounted, &amp;whileMounted, sizeof(whileMounted));
-	return result;										   
-}
-
-
-// _user_supports_resizing_partition
-bool
-_user_supports_resizing_partition(partition_id partitionID, int32 changeCounter,
-	bool *_canResizeContents, bool *_whileMounted)
-{
-	KDiskDeviceManager *manager = KDiskDeviceManager::Default();
-
-	// get the partition
-	KPartition *partition = manager-&gt;ReadLockPartition(partitionID);
-	if (!partition)
-		return false;
-	PartitionRegistrar registrar1(partition, true);
-	PartitionRegistrar registrar2(partition-&gt;Device(), true);
-	DeviceReadLocker locker(partition-&gt;Device(), true);
-	if (!check_shadow_partition(partition, changeCounter)
-		|| !partition-&gt;Parent()) {
-		return false;
-	}
-	if (partition-&gt;Parent()-&gt;IsBusy()
-		|| partition-&gt;Parent()-&gt;IsDescendantBusy()) {
-		return false;
-	}
-
-	// get the parent disk system
-	KDiskSystem *parentDiskSystem = partition-&gt;Parent()-&gt;DiskSystem();
-	if (!parentDiskSystem)
-		return false;
-	bool result = parentDiskSystem-&gt;SupportsChildOperations(partition,
-		B_DISK_SYSTEM_SUPPORTS_RESIZING_CHILD);
-	if (!result)
-		return false;
-
-	// get the child disk system
-	KDiskSystem *childDiskSystem = partition-&gt;DiskSystem();
-	if (_canResizeContents) {
-		bool canResizeContents = false;
-		bool whileMounted = false;
-		if (childDiskSystem) {
-			uint32 operations = childDiskSystem-&gt;GetSupportedOperations(
-				partition, B_DISK_SYSTEM_SUPPORTS_RESIZING
-					| B_DISK_SYSTEM_SUPPORTS_RESIZING_WHILE_MOUNTED);
-
-			if (operations &amp; B_DISK_SYSTEM_SUPPORTS_RESIZING) {
-				canResizeContents = true;
-				if (operations &amp; B_DISK_SYSTEM_SUPPORTS_RESIZING_WHILE_MOUNTED)
-					whileMounted = true;
-			}
-		}
-
-		user_memcpy(_canResizeContents, &amp;canResizeContents, sizeof(canResizeContents));
-		if (_whileMounted)
-			user_memcpy(_whileMounted, &amp;whileMounted, sizeof(whileMounted));
-	}
-// TODO: Currently we report that we cannot resize the contents, if the
-// partition's disk system is unknown. I found this more logical. It doesn't
-// really matter, though, since the API user can check for this situation.
-	return result;
-}
-
-
-// _user_supports_moving_partition
-bool
-_user_supports_moving_partition(partition_id partitionID, int32 changeCounter,
-	partition_id *_unmovable, partition_id *_needUnmounting, size_t bufferSize)
-{
-	if ((!_unmovable || !_needUnmounting) &amp;&amp; bufferSize &gt; 0)
-		return false;
-	partition_id *unmovable = NULL; 
-	partition_id *needUnmounting = NULL;
-	if (bufferSize &gt; 0) {
-		unmovable = static_cast&lt;partition_id*&gt;(malloc(bufferSize));	
-		needUnmounting = static_cast&lt;partition_id*&gt;(malloc(bufferSize));
-		if (unmovable &amp;&amp; needUnmounting) {
-			user_memcpy(unmovable, _unmovable, bufferSize);
-			user_memcpy(needUnmounting, _needUnmounting, bufferSize);
-		} else {
-			free(unmovable);
-			free(needUnmounting);
-			return false;
-		}
-	}	
-	KDiskDeviceManager *manager = KDiskDeviceManager::Default();
-	// get the partition
-	KPartition *partition = manager-&gt;ReadLockPartition(partitionID);
-	bool result = partition;
-	if (result) {
-		PartitionRegistrar registrar1(partition, true);
-		PartitionRegistrar registrar2(partition-&gt;Device(), true);
-		DeviceReadLocker locker(partition-&gt;Device(), true);
-		result = check_shadow_partition(partition, changeCounter)
-			&amp;&amp; partition-&gt;Parent();
-		if (result) {
-			result = !partition-&gt;Parent()-&gt;IsBusy()
-				&amp;&amp; !partition-&gt;Parent()-&gt;IsDescendantBusy();
-		}
-		if (result) {
-			// get the parent disk system
-			KDiskSystem *parentDiskSystem = partition-&gt;Parent()-&gt;DiskSystem();
-			result = parentDiskSystem;
-			if (result) {
-				result = parentDiskSystem-&gt;SupportsChildOperations(partition,
-					B_DISK_SYSTEM_SUPPORTS_MOVING_CHILD);
-			}
-
-			if (result) {
-				// check the movability of the descendants' contents
-				size_t unmovableSize = bufferSize; 
-				size_t needUnmountingSize = bufferSize; 
-				result = get_unmovable_descendants(partition, unmovable,
-					unmovableSize, needUnmounting, needUnmountingSize);
-			}
-		}
-	}
-	if (result &amp;&amp; bufferSize &gt; 0) {
-		user_memcpy(_unmovable, unmovable, bufferSize);
-		user_memcpy(_needUnmounting, needUnmounting, bufferSize);
-	}
-	free(unmovable);
-	free(needUnmounting);
-	return result;
-}
-
-
-// _user_supports_setting_partition_name
-bool
-_user_supports_setting_partition_name(partition_id partitionID,
-	int32 changeCounter)
-{
-	KDiskDeviceManager *manager = KDiskDeviceManager::Default();
-	// get the partition
-	KPartition *partition = manager-&gt;ReadLockPartition(partitionID);
-	if (!partition)

[... truncated: 1043 lines follow ...]

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="004552.html">[Haiku-commits] r22780 - in haiku/trunk:	headers/private/graphics/intel_extreme	src/add-ons/accelerants/intel_extreme
</A></li>
	
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4553">[ date ]</a>
              <a href="thread.html#4553">[ thread ]</a>
              <a href="subject.html#4553">[ subject ]</a>
              <a href="author.html#4553">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/haiku-commits">More information about the Haiku-commits
mailing list</a><br>
</body></html>
