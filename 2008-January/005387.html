<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Haiku-commits] r23423 - in haiku/trunk:	headers/private/storage/mime src/kits/storage	src/kits/storage/mime src/servers/registrar	src/servers/registrar/mime
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/haiku-commits/2008-January/index.html" >
   <LINK REL="made" HREF="mailto:haiku-commits%40lists.berlios.de?Subject=Re%3A%20%5BHaiku-commits%5D%20r23423%20-%20in%20haiku/trunk%3A%0A%09headers/private/storage/mime%20src/kits/storage%0A%09src/kits/storage/mime%20src/servers/registrar%0A%09src/servers/registrar/mime&In-Reply-To=%3C200801112245.m0BMj8IT031090%40sheep.berlios.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="005386.html">
   <LINK REL="Next"  HREF="005388.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Haiku-commits] r23423 - in haiku/trunk:	headers/private/storage/mime src/kits/storage	src/kits/storage/mime src/servers/registrar	src/servers/registrar/mime</H1>
    <B>mmlr at BerliOS</B> 
    <A HREF="mailto:haiku-commits%40lists.berlios.de?Subject=Re%3A%20%5BHaiku-commits%5D%20r23423%20-%20in%20haiku/trunk%3A%0A%09headers/private/storage/mime%20src/kits/storage%0A%09src/kits/storage/mime%20src/servers/registrar%0A%09src/servers/registrar/mime&In-Reply-To=%3C200801112245.m0BMj8IT031090%40sheep.berlios.de%3E"
       TITLE="[Haiku-commits] r23423 - in haiku/trunk:	headers/private/storage/mime src/kits/storage	src/kits/storage/mime src/servers/registrar	src/servers/registrar/mime">mmlr at mail.berlios.de
       </A><BR>
    <I>Fri Jan 11 23:45:08 CET 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="005386.html">[Haiku-commits] r23422 -	haiku/trunk/src/add-ons/kernel/drivers/input/usb_hid
</A></li>
        <LI>Next message: <A HREF="005388.html">[Haiku-commits] r23424 - haiku/trunk/src/kits/interface
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5387">[ date ]</a>
              <a href="thread.html#5387">[ thread ]</a>
              <a href="subject.html#5387">[ subject ]</a>
              <a href="author.html#5387">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: mmlr
Date: 2008-01-11 23:45:06 +0100 (Fri, 11 Jan 2008)
New Revision: 23423
ViewCVS: <A HREF="http://svn.berlios.de/viewcvs/haiku?rev=23423&amp;view=rev">http://svn.berlios.de/viewcvs/haiku?rev=23423&amp;view=rev</A>

Added:
   haiku/trunk/src/servers/registrar/mime/
   haiku/trunk/src/servers/registrar/mime/AssociatedTypes.h
   haiku/trunk/src/servers/registrar/mime/CreateAppMetaMimeThread.h
   haiku/trunk/src/servers/registrar/mime/Database.h
   haiku/trunk/src/servers/registrar/mime/InstalledTypes.h
   haiku/trunk/src/servers/registrar/mime/MimeSnifferAddonManager.h
   haiku/trunk/src/servers/registrar/mime/MimeUpdateThread.h
   haiku/trunk/src/servers/registrar/mime/SnifferRules.h
   haiku/trunk/src/servers/registrar/mime/Supertype.h
   haiku/trunk/src/servers/registrar/mime/SupportingApps.h
   haiku/trunk/src/servers/registrar/mime/UpdateMimeInfoThread.h
Removed:
   haiku/trunk/headers/private/storage/mime/AssociatedTypes.h
   haiku/trunk/headers/private/storage/mime/CreateAppMetaMimeThread.h
   haiku/trunk/headers/private/storage/mime/Database.h
   haiku/trunk/headers/private/storage/mime/InstalledTypes.h
   haiku/trunk/headers/private/storage/mime/MimeSnifferAddonManager.h
   haiku/trunk/headers/private/storage/mime/MimeUpdateThread.h
   haiku/trunk/headers/private/storage/mime/SnifferRules.h
   haiku/trunk/headers/private/storage/mime/Supertype.h
   haiku/trunk/headers/private/storage/mime/SupportingApps.h
   haiku/trunk/headers/private/storage/mime/UpdateMimeInfoThread.h
   haiku/trunk/src/kits/storage/mime/AssociatedTypes.cpp
   haiku/trunk/src/kits/storage/mime/CreateAppMetaMimeThread.cpp
   haiku/trunk/src/kits/storage/mime/Database.cpp
   haiku/trunk/src/kits/storage/mime/InstalledTypes.cpp
   haiku/trunk/src/kits/storage/mime/MimeSnifferAddon.cpp
   haiku/trunk/src/kits/storage/mime/MimeSnifferAddonManager.cpp
   haiku/trunk/src/kits/storage/mime/MimeUpdateThread.cpp
   haiku/trunk/src/kits/storage/mime/SnifferRules.cpp
   haiku/trunk/src/kits/storage/mime/Supertype.cpp
   haiku/trunk/src/kits/storage/mime/SupportingApps.cpp
   haiku/trunk/src/kits/storage/mime/UpdateMimeInfoThread.cpp
   haiku/trunk/src/servers/registrar/mime/database_access.cpp
   haiku/trunk/src/servers/registrar/mime/database_support.cpp
Modified:
   haiku/trunk/src/kits/storage/Jamfile
   haiku/trunk/src/servers/registrar/Jamfile
   haiku/trunk/src/servers/registrar/MIMEManager.cpp
   haiku/trunk/src/servers/registrar/MIMEManager.h
   haiku/trunk/src/servers/registrar/mime/AssociatedTypes.cpp
   haiku/trunk/src/servers/registrar/mime/CreateAppMetaMimeThread.cpp
   haiku/trunk/src/servers/registrar/mime/Database.cpp
   haiku/trunk/src/servers/registrar/mime/InstalledTypes.cpp
   haiku/trunk/src/servers/registrar/mime/MimeSnifferAddon.cpp
   haiku/trunk/src/servers/registrar/mime/MimeSnifferAddonManager.cpp
   haiku/trunk/src/servers/registrar/mime/MimeUpdateThread.cpp
   haiku/trunk/src/servers/registrar/mime/SnifferRules.cpp
   haiku/trunk/src/servers/registrar/mime/Supertype.cpp
   haiku/trunk/src/servers/registrar/mime/SupportingApps.cpp
   haiku/trunk/src/servers/registrar/mime/UpdateMimeInfoThread.cpp
Log:
bonefish+mmlr:
* Move most of MIME database support out of libbe and into registrar
* Use the (async) MessageDeliverer instead of a synchronous SendMessage in _SendMonitorUpdate

This fixes a deadlock when the message port of a MIME database watching
application gets full as documented in bug #1311.

Deleted: haiku/trunk/headers/private/storage/mime/AssociatedTypes.h

Deleted: haiku/trunk/headers/private/storage/mime/CreateAppMetaMimeThread.h

Deleted: haiku/trunk/headers/private/storage/mime/Database.h

Deleted: haiku/trunk/headers/private/storage/mime/InstalledTypes.h

Deleted: haiku/trunk/headers/private/storage/mime/MimeSnifferAddonManager.h

Deleted: haiku/trunk/headers/private/storage/mime/MimeUpdateThread.h

Deleted: haiku/trunk/headers/private/storage/mime/SnifferRules.h

Deleted: haiku/trunk/headers/private/storage/mime/Supertype.h

Deleted: haiku/trunk/headers/private/storage/mime/SupportingApps.h

Deleted: haiku/trunk/headers/private/storage/mime/UpdateMimeInfoThread.h

Modified: haiku/trunk/src/kits/storage/Jamfile
===================================================================
--- haiku/trunk/src/kits/storage/Jamfile	2008-01-11 22:25:41 UTC (rev 23422)
+++ haiku/trunk/src/kits/storage/Jamfile	2008-01-11 22:45:06 UTC (rev 23423)
@@ -45,17 +45,6 @@
 	storage_support.cpp
 
 	# mime
-	AssociatedTypes.cpp
-	CreateAppMetaMimeThread.cpp
-	Database.cpp
-	InstalledTypes.cpp
-	MimeSnifferAddon.cpp
-	MimeSnifferAddonManager.cpp
-	MimeUpdateThread.cpp
-	SnifferRules.cpp
-	Supertype.cpp
-	SupportingApps.cpp
-	UpdateMimeInfoThread.cpp
 	database_access.cpp
 	database_support.cpp
 

Deleted: haiku/trunk/src/kits/storage/mime/AssociatedTypes.cpp

Deleted: haiku/trunk/src/kits/storage/mime/CreateAppMetaMimeThread.cpp

Deleted: haiku/trunk/src/kits/storage/mime/Database.cpp

Deleted: haiku/trunk/src/kits/storage/mime/InstalledTypes.cpp

Deleted: haiku/trunk/src/kits/storage/mime/MimeSnifferAddon.cpp

Deleted: haiku/trunk/src/kits/storage/mime/MimeSnifferAddonManager.cpp

Deleted: haiku/trunk/src/kits/storage/mime/MimeUpdateThread.cpp

Deleted: haiku/trunk/src/kits/storage/mime/SnifferRules.cpp

Deleted: haiku/trunk/src/kits/storage/mime/Supertype.cpp

Deleted: haiku/trunk/src/kits/storage/mime/SupportingApps.cpp

Deleted: haiku/trunk/src/kits/storage/mime/UpdateMimeInfoThread.cpp

Modified: haiku/trunk/src/servers/registrar/Jamfile
===================================================================
--- haiku/trunk/src/servers/registrar/Jamfile	2008-01-11 22:25:41 UTC (rev 23422)
+++ haiku/trunk/src/servers/registrar/Jamfile	2008-01-11 22:45:06 UTC (rev 23423)
@@ -7,6 +7,8 @@
 UsePrivateHeaders tracker ;
 UseArchHeaders $(TARGET_ARCH) ;
 
+SEARCH_SOURCE += [ FDirName $(SUBDIR) mime ] ;
+
 Server registrar
  	:
 	AppInfoList.cpp
@@ -33,6 +35,19 @@
 	TRoster.cpp
 	Watcher.cpp
 	WatchingService.cpp
+
+	# mime
+	AssociatedTypes.cpp
+	CreateAppMetaMimeThread.cpp
+	Database.cpp
+	InstalledTypes.cpp
+	MimeSnifferAddon.cpp
+	MimeSnifferAddonManager.cpp
+	MimeUpdateThread.cpp
+	SnifferRules.cpp
+	Supertype.cpp
+	SupportingApps.cpp
+	UpdateMimeInfoThread.cpp
 	:
 	be
 	$(TARGET_LIBSTDC++)

Modified: haiku/trunk/src/servers/registrar/MIMEManager.cpp
===================================================================
--- haiku/trunk/src/servers/registrar/MIMEManager.cpp	2008-01-11 22:25:41 UTC (rev 23422)
+++ haiku/trunk/src/servers/registrar/MIMEManager.cpp	2008-01-11 22:45:06 UTC (rev 23423)
@@ -1,26 +1,27 @@
 // MIMEManager.cpp
 
+#include &quot;MIMEManager.h&quot;
+
+#include &lt;stdio.h&gt;
+#include &lt;string&gt;
+
 #include &lt;Bitmap.h&gt;
 #include &lt;ClassInfo.h&gt;
 #include &lt;Message.h&gt;
 #include &lt;Messenger.h&gt;
-#include &lt;mime/CreateAppMetaMimeThread.h&gt;
-#include &lt;mime/MimeSnifferAddonManager.h&gt;
-#include &lt;mime/UpdateMimeInfoThread.h&gt;
 #include &lt;Path.h&gt;
 #include &lt;RegistrarDefs.h&gt;
 #include &lt;String.h&gt;
 #include &lt;TypeConstants.h&gt;
 
-#include &lt;stdio.h&gt;
-#include &lt;string&gt;
+#include &quot;CreateAppMetaMimeThread.h&quot;
+#include &quot;MimeSnifferAddonManager.h&quot;
+#include &quot;TextSnifferAddon.h&quot;
+#include &quot;UpdateMimeInfoThread.h&quot;
 
 using namespace std;
 using namespace BPrivate;
 
-#include &quot;MIMEManager.h&quot;
-#include &quot;TextSnifferAddon.h&quot;
-
 /*!
 	\class MIMEManager
 	\brief MIMEManager handles communication between BMimeType and the system-wide

Modified: haiku/trunk/src/servers/registrar/MIMEManager.h
===================================================================
--- haiku/trunk/src/servers/registrar/MIMEManager.h	2008-01-11 22:25:41 UTC (rev 23422)
+++ haiku/trunk/src/servers/registrar/MIMEManager.h	2008-01-11 22:45:06 UTC (rev 23423)
@@ -4,9 +4,10 @@
 #define MIME_MANAGER_H
 
 #include &lt;Looper.h&gt;
-#include &lt;mime/Database.h&gt;
 #include &lt;RegistrarThreadManager.h&gt;
 
+#include &quot;Database.h&quot;
+
 class MIMEManager : public BLooper {
 public:
 	MIMEManager();

Copied: haiku/trunk/src/servers/registrar/mime (from rev 23399, haiku/trunk/src/kits/storage/mime)

Modified: haiku/trunk/src/servers/registrar/mime/AssociatedTypes.cpp
===================================================================
--- haiku/trunk/src/kits/storage/mime/AssociatedTypes.cpp	2008-01-11 14:17:17 UTC (rev 23399)
+++ haiku/trunk/src/servers/registrar/mime/AssociatedTypes.cpp	2008-01-11 22:45:06 UTC (rev 23423)
@@ -7,7 +7,8 @@
 	AssociatedTypes class implementation
 */
 
-#include &quot;mime/AssociatedTypes.h&quot;
+#include &quot;AssociatedTypes.h&quot;
+#include &quot;MimeSnifferAddonManager.h&quot;
 
 #include &lt;Directory.h&gt;
 #include &lt;Entry.h&gt;
@@ -16,7 +17,6 @@
 #include &lt;Path.h&gt;
 #include &lt;String.h&gt;
 #include &lt;mime/database_support.h&gt;
-#include &lt;mime/MimeSnifferAddonManager.h&gt;
 #include &lt;storage_support.h&gt;
 
 #include &lt;new&gt;

Copied: haiku/trunk/src/servers/registrar/mime/AssociatedTypes.h (from rev 23399, haiku/trunk/headers/private/storage/mime/AssociatedTypes.h)

Modified: haiku/trunk/src/servers/registrar/mime/CreateAppMetaMimeThread.cpp
===================================================================
--- haiku/trunk/src/kits/storage/mime/CreateAppMetaMimeThread.cpp	2008-01-11 14:17:17 UTC (rev 23399)
+++ haiku/trunk/src/servers/registrar/mime/CreateAppMetaMimeThread.cpp	2008-01-11 22:45:06 UTC (rev 23423)
@@ -8,9 +8,10 @@
  */
 
 
-#include &quot;mime/CreateAppMetaMimeThread.h&quot;
-#include &quot;mime/database_support.h&quot;
+#include &quot;CreateAppMetaMimeThread.h&quot;
 
+#include &lt;stdio.h&gt;
+
 #include &lt;AppFileInfo.h&gt;
 #include &lt;Bitmap.h&gt;
 #include &lt;fs_attr.h&gt;
@@ -19,9 +20,8 @@
 #include &lt;Path.h&gt;
 #include &lt;String.h&gt;
 
-#include &lt;stdio.h&gt;
+#include &lt;mime/database_support.h&gt;
 
-
 namespace BPrivate {
 namespace Storage {
 namespace Mime {

Copied: haiku/trunk/src/servers/registrar/mime/CreateAppMetaMimeThread.h (from rev 23399, haiku/trunk/headers/private/storage/mime/CreateAppMetaMimeThread.h)
===================================================================
--- haiku/trunk/headers/private/storage/mime/CreateAppMetaMimeThread.h	2008-01-11 14:17:17 UTC (rev 23399)
+++ haiku/trunk/src/servers/registrar/mime/CreateAppMetaMimeThread.h	2008-01-11 22:45:06 UTC (rev 23423)
@@ -0,0 +1,31 @@
+//----------------------------------------------------------------------
+//  This software is part of the OpenBeOS distribution and is covered 
+//  by the OpenBeOS license.
+//---------------------------------------------------------------------
+/*!
+	\file CreateAppMetaMimeThread.h
+	CreateAppMetaMimeThread interface declaration 
+*/
+
+#ifndef _CREATE_APP_META_MIME_THREAD_H
+#define _CREATE_APP_META_MIME_THREAD_H
+
+#include &quot;MimeUpdateThread.h&quot;
+
+namespace BPrivate {
+namespace Storage {
+namespace Mime {
+
+class CreateAppMetaMimeThread : public MimeUpdateThread {
+public:
+	CreateAppMetaMimeThread(const char *name, int32 priority,
+		BMessenger managerMessenger, const entry_ref *root, bool recursive,
+		int32 force, BMessage *replyee);
+	status_t DoMimeUpdate(const entry_ref *entry, bool *entryIsDir);
+};
+	
+}	// namespace Mime
+}	// namespace Storage
+}	// namespace BPrivate
+
+#endif	// _CREATE_APP_META_MIME_THREAD_H

Modified: haiku/trunk/src/servers/registrar/mime/Database.cpp
===================================================================
--- haiku/trunk/src/kits/storage/mime/Database.cpp	2008-01-11 14:17:17 UTC (rev 23399)
+++ haiku/trunk/src/servers/registrar/mime/Database.cpp	2008-01-11 22:45:06 UTC (rev 23423)
@@ -8,7 +8,7 @@
  */
 
 
-#include &lt;mime/Database.h&gt;
+#include &quot;Database.h&quot;
 
 #include &lt;mime/database_access.h&gt;
 #include &lt;mime/database_support.h&gt;
@@ -34,6 +34,7 @@
 #include &lt;stdio.h&gt;
 #include &lt;string&gt;
 
+#include &quot;MessageDeliverer.h&quot;
 
 //#define DBG(x) x
 #define DBG(x)
@@ -1374,9 +1375,9 @@
 	status_t err;
 	std::set&lt;BMessenger&gt;::const_iterator i;
 	for (i = fMonitorMessengers.begin(); i != fMonitorMessengers.end(); i++) {
-		status_t err = (*i).SendMessage(&amp;msg, (BHandler*)NULL);
+		status_t err =  MessageDeliverer::Default()-&gt;DeliverMessage(&amp;msg, *i);
 		if (err) {
-			DBG(OUT(&quot;Database::_SendMonitorUpdate(BMessage&amp;): BMessenger::SendMessage failed, 0x%lx\n&quot;, err));
+			DBG(OUT(&quot;Database::_SendMonitorUpdate(BMessage&amp;): DeliverMessage failed, 0x%lx\n&quot;, err));
 		}
 	}
 //	DBG(OUT(&quot;Database::_SendMonitorUpdate(BMessage&amp;) done\n&quot;));

Copied: haiku/trunk/src/servers/registrar/mime/Database.h (from rev 23399, haiku/trunk/headers/private/storage/mime/Database.h)
===================================================================
--- haiku/trunk/headers/private/storage/mime/Database.h	2008-01-11 14:17:17 UTC (rev 23399)
+++ haiku/trunk/src/servers/registrar/mime/Database.h	2008-01-11 22:45:06 UTC (rev 23423)
@@ -0,0 +1,136 @@
+/*
+ * Copyright 2002-2006, Haiku.
+ * Distributed under the terms of the MIT License.
+ *
+ * Authors:
+ *		Tyler Dauwalder
+ */
+#ifndef _MIME_DATABASE_H
+#define _MIME_DATABASE_H
+
+#include &lt;map&gt;
+#include &lt;set&gt;
+#include &lt;string&gt;
+
+#include &lt;Mime.h&gt;
+#include &lt;Messenger.h&gt;
+#include &lt;StorageDefs.h&gt;
+
+#include &lt;mime/database_access.h&gt;
+
+#include &quot;AssociatedTypes.h&quot;
+#include &quot;InstalledTypes.h&quot;
+#include &quot;SnifferRules.h&quot;
+#include &quot;SupportingApps.h&quot;
+
+
+class BNode;
+class BBitmap;
+class BMessage;
+class BString;
+
+struct entry_ref;
+
+namespace BPrivate {
+namespace Storage {
+namespace Mime {
+
+// types of mime update functions that may be run asynchronously
+typedef enum {
+	B_REG_UPDATE_MIME_INFO,
+	B_REG_CREATE_APP_META_MIME,
+} mime_update_function;
+
+class Database {
+	public:
+		Database();
+		~Database();
+	
+		status_t InitCheck() const;
+
+		// Type management
+		status_t Install(const char *type);
+		status_t Delete(const char *type);
+	
+		// Set()
+		status_t SetAppHint(const char *type, const entry_ref *ref);
+		status_t SetAttrInfo(const char *type, const BMessage *info);
+		status_t SetShortDescription(const char *type, const char *description);	
+		status_t SetLongDescription(const char *type, const char *description);
+		status_t SetFileExtensions(const char *type, const BMessage *extensions);
+		status_t SetIcon(const char *type, const void *data, size_t dataSize,
+					icon_size which);
+		status_t SetIcon(const char *type, const void *data, size_t dataSize);
+		status_t SetIconForType(const char *type, const char *fileType,
+					const void *data, size_t dataSize, icon_size which);
+		status_t SetIconForType(const char *type, const char *fileType,
+					const void *data, size_t dataSize);
+		status_t SetPreferredApp(const char *type, const char *signature,
+					app_verb verb = B_OPEN);
+		status_t SetSnifferRule(const char *type, const char *rule);
+		status_t SetSupportedTypes(const char *type, const BMessage *types, bool fullSync);
+
+		// Non-atomic Get()
+		status_t GetInstalledSupertypes(BMessage *super_types);
+		status_t GetInstalledTypes(BMessage *types);
+		status_t GetInstalledTypes(const char *super_type,
+					BMessage *subtypes);
+		status_t GetSupportingApps(const char *type, BMessage *signatures);
+		status_t GetAssociatedTypes(const char *extension, BMessage *types);
+
+		// Sniffer
+		status_t GuessMimeType(const entry_ref *file, BString *result);
+		status_t GuessMimeType(const void *buffer, int32 length, BString *result);
+		status_t GuessMimeType(const char *filename, BString *result);
+
+		// Monitor
+		status_t StartWatching(BMessenger target);
+		status_t StopWatching(BMessenger target);
+
+		// Delete()
+		status_t DeleteAppHint(const char *type);
+		status_t DeleteAttrInfo(const char *type);
+		status_t DeleteShortDescription(const char *type);
+		status_t DeleteLongDescription(const char *type);
+		status_t DeleteFileExtensions(const char *type);
+		status_t DeleteIcon(const char *type, icon_size size);
+		status_t DeleteIcon(const char *type);
+		status_t DeleteIconForType(const char *type, const char *fileType,
+					icon_size which);
+		status_t DeleteIconForType(const char *type, const char *fileType);
+		status_t DeletePreferredApp(const char *type, app_verb verb = B_OPEN);
+		status_t DeleteSnifferRule(const char *type);
+		status_t DeleteSupportedTypes(const char *type, bool fullSync);
+
+	private:
+		status_t _SetStringValue(const char *type, int32 what,
+					const char* attribute, type_code attributeType,
+					size_t maxLength, const char *value);
+
+		// Functions to send monitor notifications
+		status_t _SendInstallNotification(const char *type);
+		status_t _SendDeleteNotification(const char *type);	
+		status_t _SendMonitorUpdate(int32 which, const char *type,
+					const char *extraType, bool largeIcon, int32 action);
+		status_t _SendMonitorUpdate(int32 which, const char *type,
+					const char *extraType, int32 action);
+		status_t _SendMonitorUpdate(int32 which, const char *type,
+					bool largeIcon, int32 action);
+		status_t _SendMonitorUpdate(int32 which, const char *type,
+					int32 action);
+		status_t _SendMonitorUpdate(BMessage &amp;msg);
+
+	private:
+		status_t fStatus;
+		std::set&lt;BMessenger&gt; fMonitorMessengers;
+		AssociatedTypes fAssociatedTypes;
+		InstalledTypes fInstalledTypes;
+		SnifferRules fSnifferRules;
+		SupportingApps fSupportingApps;
+};
+
+} // namespace Mime
+} // namespace Storage
+} // namespace BPrivate
+
+#endif	// _MIME_DATABASE_H

Modified: haiku/trunk/src/servers/registrar/mime/InstalledTypes.cpp
===================================================================
--- haiku/trunk/src/kits/storage/mime/InstalledTypes.cpp	2008-01-11 14:17:17 UTC (rev 23399)
+++ haiku/trunk/src/servers/registrar/mime/InstalledTypes.cpp	2008-01-11 22:45:06 UTC (rev 23423)
@@ -9,7 +9,8 @@
  */
 
 
-#include &quot;mime/InstalledTypes.h&quot;
+#include &quot;InstalledTypes.h&quot;
+
 #include &lt;mime/database_support.h&gt;
 #include &lt;storage_support.h&gt;
 

Copied: haiku/trunk/src/servers/registrar/mime/InstalledTypes.h (from rev 23399, haiku/trunk/headers/private/storage/mime/InstalledTypes.h)
===================================================================
--- haiku/trunk/headers/private/storage/mime/InstalledTypes.h	2008-01-11 14:17:17 UTC (rev 23399)
+++ haiku/trunk/src/servers/registrar/mime/InstalledTypes.h	2008-01-11 22:45:06 UTC (rev 23423)
@@ -0,0 +1,65 @@
+/*
+ * Copyright 2002-2006, Haiku.
+ * Distributed under the terms of the MIT License.
+ *
+ * Authors:
+ *		Tyler Dauwalder
+ *		Ingo Weinhold, <A HREF="https://lists.berlios.de/mailman/listinfo/haiku-commits">bonefish at users.sf.net</A>
+ *		Axel D&#246;rfler, <A HREF="https://lists.berlios.de/mailman/listinfo/haiku-commits">axeld at pinc-software.de</A>
+ */
+#ifndef _MIME_INSTALLED_TYPES_H
+#define _MIME_INSTALLED_TYPES_H
+
+#include &quot;Supertype.h&quot;
+#include &lt;SupportDefs.h&gt;
+
+#include &lt;string&gt;
+#include &lt;map&gt;
+
+class BMessage;
+
+namespace BPrivate {
+namespace Storage {
+namespace Mime {
+
+class InstalledTypes {
+	public:
+		InstalledTypes();
+		~InstalledTypes();
+
+		status_t GetInstalledTypes(BMessage *types);
+		status_t GetInstalledTypes(const char *supertype, BMessage *types);
+		status_t GetInstalledSupertypes(BMessage *types);
+
+		status_t AddType(const char *type);
+		status_t RemoveType(const char *type);
+
+	private:
+		status_t _AddSupertype(const char *super,
+					std::map&lt;std::string, Supertype&gt;::iterator &amp;i);
+		status_t _AddSubtype(const char *super, const char *sub);		
+		status_t _AddSubtype(Supertype &amp;super, const char *sub);
+
+		status_t _RemoveSupertype(const char *super);
+		status_t _RemoveSubtype(const char *super, const char *sub);		
+
+		void _Unset();
+		void _ClearCachedMessages();
+
+		status_t _CreateMessageWithTypes(BMessage **result) const;
+		status_t _CreateMessageWithSupertypes(BMessage **result) const;
+		void _FillMessageWithSupertypes(BMessage *msg);
+
+		status_t _BuildInstalledTypesList();
+
+		std::map&lt;std::string, Supertype&gt; fSupertypes;
+		BMessage *fCachedMessage;	
+		BMessage *fCachedSupertypesMessage;
+		bool fHaveDoneFullBuild;
+};
+
+} // namespace Mime
+} // namespace Storage
+} // namespace BPrivate
+
+#endif	// _MIME_INSTALLED_TYPES_H

Modified: haiku/trunk/src/servers/registrar/mime/MimeSnifferAddon.cpp
===================================================================
--- haiku/trunk/src/kits/storage/mime/MimeSnifferAddon.cpp	2008-01-11 14:17:17 UTC (rev 23399)
+++ haiku/trunk/src/servers/registrar/mime/MimeSnifferAddon.cpp	2008-01-11 22:45:06 UTC (rev 23423)
@@ -3,7 +3,7 @@
  * All rights reserved. Distributed under the terms of the MIT License.
  */
 
-#include &lt;MimeSnifferAddon.h&gt;
+#include &quot;MimeSnifferAddon.h&quot;
 
 // constructor
 BMimeSnifferAddon::BMimeSnifferAddon()

Modified: haiku/trunk/src/servers/registrar/mime/MimeSnifferAddonManager.cpp
===================================================================
--- haiku/trunk/src/kits/storage/mime/MimeSnifferAddonManager.cpp	2008-01-11 14:17:17 UTC (rev 23399)
+++ haiku/trunk/src/servers/registrar/mime/MimeSnifferAddonManager.cpp	2008-01-11 22:45:06 UTC (rev 23423)
@@ -3,14 +3,15 @@
  * All rights reserved. Distributed under the terms of the MIT License.
  */
 
-#include &lt;mime/MimeSnifferAddonManager.h&gt;
+#include &quot;MimeSnifferAddonManager.h&quot;
 
 #include &lt;new&gt;
 
 #include &lt;Autolock.h&gt;
-#include &lt;MimeSnifferAddon.h&gt;
 #include &lt;MimeType.h&gt;
 
+#include &quot;MimeSnifferAddon.h&quot;
+
 using std::nothrow;
 
 

Copied: haiku/trunk/src/servers/registrar/mime/MimeSnifferAddonManager.h (from rev 23399, haiku/trunk/headers/private/storage/mime/MimeSnifferAddonManager.h)

Modified: haiku/trunk/src/servers/registrar/mime/MimeUpdateThread.cpp
===================================================================
--- haiku/trunk/src/kits/storage/mime/MimeUpdateThread.cpp	2008-01-11 14:17:17 UTC (rev 23399)
+++ haiku/trunk/src/servers/registrar/mime/MimeUpdateThread.cpp	2008-01-11 22:45:06 UTC (rev 23423)
@@ -12,6 +12,8 @@
 	MimeUpdateThread implementation
 */
 
+#include &quot;MimeUpdateThread.h&quot;
+
 #include &lt;stdio.h&gt;
 
 #include &lt;Directory.h&gt;
@@ -21,7 +23,6 @@
 #include &lt;Volume.h&gt;
 
 #include &lt;storage_support.h&gt;
-#include &quot;mime/MimeUpdateThread.h&quot;
 
 //#define DBG(x) x
 #define DBG(x)

Copied: haiku/trunk/src/servers/registrar/mime/MimeUpdateThread.h (from rev 23399, haiku/trunk/headers/private/storage/mime/MimeUpdateThread.h)

Modified: haiku/trunk/src/servers/registrar/mime/SnifferRules.cpp
===================================================================
--- haiku/trunk/src/kits/storage/mime/SnifferRules.cpp	2008-01-11 14:17:17 UTC (rev 23399)
+++ haiku/trunk/src/servers/registrar/mime/SnifferRules.cpp	2008-01-11 22:45:06 UTC (rev 23423)
@@ -12,22 +12,23 @@
 	SnifferRules class implementation
 */
 
-#include &quot;mime/SnifferRules.h&quot;
+#include &quot;SnifferRules.h&quot;
 
+#include &lt;stdio.h&gt;
+#include &lt;sys/stat.h&gt;
+
 #include &lt;Directory.h&gt;
 #include &lt;Entry.h&gt;
 #include &lt;File.h&gt;
 #include &lt;MimeType.h&gt;
 #include &lt;mime/database_support.h&gt;
-#include &lt;mime/MimeSnifferAddonManager.h&gt;
 #include &lt;sniffer/Parser.h&gt;
 #include &lt;sniffer/Rule.h&gt;
 #include &lt;StorageDefs.h&gt;
 #include &lt;storage_support.h&gt;
 #include &lt;String.h&gt;
 
-#include &lt;stdio.h&gt;
-#include &lt;sys/stat.h&gt;
+#include &quot;MimeSnifferAddonManager.h&quot;
 
 #define DBG(x) x
 //#define DBG(x)

Copied: haiku/trunk/src/servers/registrar/mime/SnifferRules.h (from rev 23399, haiku/trunk/headers/private/storage/mime/SnifferRules.h)

Modified: haiku/trunk/src/servers/registrar/mime/Supertype.cpp
===================================================================
--- haiku/trunk/src/kits/storage/mime/Supertype.cpp	2008-01-11 14:17:17 UTC (rev 23399)
+++ haiku/trunk/src/servers/registrar/mime/Supertype.cpp	2008-01-11 22:45:06 UTC (rev 23423)
@@ -7,7 +7,7 @@
 	Supertype class implementation
 */
 
-#include &quot;mime/Supertype.h&quot;
+#include &quot;Supertype.h&quot;
 
 #include &lt;Message.h&gt;
 #include &lt;mime/database_support.h&gt;

Copied: haiku/trunk/src/servers/registrar/mime/Supertype.h (from rev 23399, haiku/trunk/headers/private/storage/mime/Supertype.h)

Modified: haiku/trunk/src/servers/registrar/mime/SupportingApps.cpp
===================================================================
--- haiku/trunk/src/kits/storage/mime/SupportingApps.cpp	2008-01-11 14:17:17 UTC (rev 23399)
+++ haiku/trunk/src/servers/registrar/mime/SupportingApps.cpp	2008-01-11 22:45:06 UTC (rev 23423)
@@ -9,7 +9,7 @@
  */
 
 
-#include &lt;mime/SupportingApps.h&gt;
+#include &quot;SupportingApps.h&quot;
 #include &lt;mime/database_support.h&gt;
 
 #include &lt;storage_support.h&gt;

Copied: haiku/trunk/src/servers/registrar/mime/SupportingApps.h (from rev 23399, haiku/trunk/headers/private/storage/mime/SupportingApps.h)

Modified: haiku/trunk/src/servers/registrar/mime/UpdateMimeInfoThread.cpp
===================================================================
--- haiku/trunk/src/kits/storage/mime/UpdateMimeInfoThread.cpp	2008-01-11 14:17:17 UTC (rev 23399)
+++ haiku/trunk/src/servers/registrar/mime/UpdateMimeInfoThread.cpp	2008-01-11 22:45:06 UTC (rev 23423)
@@ -7,7 +7,7 @@
 	UpdateMimeInfoThread implementation
 */
 
-#include &quot;mime/UpdateMimeInfoThread.h&quot;
+#include &quot;UpdateMimeInfoThread.h&quot;
 
 #include &lt;AppFileInfo.h&gt;
 #include &lt;Bitmap.h&gt;

Copied: haiku/trunk/src/servers/registrar/mime/UpdateMimeInfoThread.h (from rev 23399, haiku/trunk/headers/private/storage/mime/UpdateMimeInfoThread.h)
===================================================================
--- haiku/trunk/headers/private/storage/mime/UpdateMimeInfoThread.h	2008-01-11 14:17:17 UTC (rev 23399)
+++ haiku/trunk/src/servers/registrar/mime/UpdateMimeInfoThread.h	2008-01-11 22:45:06 UTC (rev 23423)
@@ -0,0 +1,31 @@
+//----------------------------------------------------------------------
+//  This software is part of the OpenBeOS distribution and is covered 
+//  by the OpenBeOS license.
+//---------------------------------------------------------------------
+/*!
+	\file UpdateMimeInfoThread.h
+	UpdateMimeInfoThread interface declaration 
+*/
+
+#ifndef _MIME_UPDATE_MIME_INFO_THREAD_H
+#define _MIME_UPDATE_MIME_INFO_THREAD_H
+
+#include &quot;MimeUpdateThread.h&quot;
+
+namespace BPrivate {
+namespace Storage {
+namespace Mime {
+
+class UpdateMimeInfoThread : public MimeUpdateThread {
+public:
+	UpdateMimeInfoThread(const char *name, int32 priority,
+		BMessenger managerMessenger, const entry_ref *root, bool recursive,
+		int32 force, BMessage *replyee);
+	status_t DoMimeUpdate(const entry_ref *entry, bool *entryIsDir);
+};
+	
+}	// namespace Mime
+}	// namespace Storage
+}	// namespace BPrivate
+
+#endif	// _MIME_UPDATE_MIME_INFO_THREAD_H

Deleted: haiku/trunk/src/servers/registrar/mime/database_access.cpp

Deleted: haiku/trunk/src/servers/registrar/mime/database_support.cpp


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="005386.html">[Haiku-commits] r23422 -	haiku/trunk/src/add-ons/kernel/drivers/input/usb_hid
</A></li>
	<LI>Next message: <A HREF="005388.html">[Haiku-commits] r23424 - haiku/trunk/src/kits/interface
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5387">[ date ]</a>
              <a href="thread.html#5387">[ thread ]</a>
              <a href="subject.html#5387">[ subject ]</a>
              <a href="author.html#5387">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/haiku-commits">More information about the Haiku-commits
mailing list</a><br>
</body></html>
