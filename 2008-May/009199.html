<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Haiku-commits] r25725 - in haiku/trunk/src/apps/mediaplayer: .	interface media_node_framework media_node_framework/audio	media_node_framework/video supplier support
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/haiku-commits/2008-May/index.html" >
   <LINK REL="made" HREF="mailto:haiku-commits%40lists.berlios.de?Subject=Re%3A%20%5BHaiku-commits%5D%20r25725%20-%20in%20haiku/trunk/src/apps/mediaplayer%3A%20.%0A%09interface%20media_node_framework%20media_node_framework/audio%0A%09media_node_framework/video%20supplier%20support&In-Reply-To=%3C200805301900.m4UJ0ICt022681%40sheep.berlios.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="009198.html">
   <LINK REL="Next"  HREF="009200.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Haiku-commits] r25725 - in haiku/trunk/src/apps/mediaplayer: .	interface media_node_framework media_node_framework/audio	media_node_framework/video supplier support</H1>
    <B>stippi at BerliOS</B> 
    <A HREF="mailto:haiku-commits%40lists.berlios.de?Subject=Re%3A%20%5BHaiku-commits%5D%20r25725%20-%20in%20haiku/trunk/src/apps/mediaplayer%3A%20.%0A%09interface%20media_node_framework%20media_node_framework/audio%0A%09media_node_framework/video%20supplier%20support&In-Reply-To=%3C200805301900.m4UJ0ICt022681%40sheep.berlios.de%3E"
       TITLE="[Haiku-commits] r25725 - in haiku/trunk/src/apps/mediaplayer: .	interface media_node_framework media_node_framework/audio	media_node_framework/video supplier support">stippi at mail.berlios.de
       </A><BR>
    <I>Fri May 30 21:00:18 CEST 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="009198.html">[Haiku-commits] r25724 -	haiku/trunk/src/system/kernel/device_manager
</A></li>
        <LI>Next message: <A HREF="009200.html">[Haiku-commits] r25725 - in haiku/trunk/src/apps/mediaplayer: .	interface media_node_framework media_node_framework/audio	media_node_framework/video supplier support
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9199">[ date ]</a>
              <a href="thread.html#9199">[ thread ]</a>
              <a href="subject.html#9199">[ subject ]</a>
              <a href="author.html#9199">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: stippi
Date: 2008-05-30 20:59:36 +0200 (Fri, 30 May 2008)
New Revision: 25725
ViewCVS: <A HREF="http://svn.berlios.de/viewcvs/haiku?rev=25725&amp;view=rev">http://svn.berlios.de/viewcvs/haiku?rev=25725&amp;view=rev</A>

Added:
   haiku/trunk/src/apps/mediaplayer/interface/
   haiku/trunk/src/apps/mediaplayer/interface/ButtonBitmaps.h
   haiku/trunk/src/apps/mediaplayer/interface/DrawingTidbits.cpp
   haiku/trunk/src/apps/mediaplayer/interface/DrawingTidbits.h
   haiku/trunk/src/apps/mediaplayer/interface/SeekSlider.cpp
   haiku/trunk/src/apps/mediaplayer/interface/SeekSlider.h
   haiku/trunk/src/apps/mediaplayer/interface/TransportButton.cpp
   haiku/trunk/src/apps/mediaplayer/interface/TransportButton.h
   haiku/trunk/src/apps/mediaplayer/interface/VolumeSlider.cpp
   haiku/trunk/src/apps/mediaplayer/interface/VolumeSlider.h
   haiku/trunk/src/apps/mediaplayer/media_node_framework/
   haiku/trunk/src/apps/mediaplayer/media_node_framework/NodeManager.cpp
   haiku/trunk/src/apps/mediaplayer/media_node_framework/NodeManager.h
   haiku/trunk/src/apps/mediaplayer/media_node_framework/PlaybackLOAdapter.cpp
   haiku/trunk/src/apps/mediaplayer/media_node_framework/PlaybackLOAdapter.h
   haiku/trunk/src/apps/mediaplayer/media_node_framework/PlaybackListener.cpp
   haiku/trunk/src/apps/mediaplayer/media_node_framework/PlaybackListener.h
   haiku/trunk/src/apps/mediaplayer/media_node_framework/PlaybackManager.cpp
   haiku/trunk/src/apps/mediaplayer/media_node_framework/PlaybackManager.h
   haiku/trunk/src/apps/mediaplayer/media_node_framework/audio/
   haiku/trunk/src/apps/mediaplayer/media_node_framework/audio/AudioAdapter.cpp
   haiku/trunk/src/apps/mediaplayer/media_node_framework/audio/AudioAdapter.h
   haiku/trunk/src/apps/mediaplayer/media_node_framework/audio/AudioChannelConverter.cpp
   haiku/trunk/src/apps/mediaplayer/media_node_framework/audio/AudioChannelConverter.h
   haiku/trunk/src/apps/mediaplayer/media_node_framework/audio/AudioFormatConverter.cpp
   haiku/trunk/src/apps/mediaplayer/media_node_framework/audio/AudioFormatConverter.h
   haiku/trunk/src/apps/mediaplayer/media_node_framework/audio/AudioProducer.cpp
   haiku/trunk/src/apps/mediaplayer/media_node_framework/audio/AudioProducer.h
   haiku/trunk/src/apps/mediaplayer/media_node_framework/audio/AudioReader.cpp
   haiku/trunk/src/apps/mediaplayer/media_node_framework/audio/AudioReader.h
   haiku/trunk/src/apps/mediaplayer/media_node_framework/audio/AudioResampler.cpp
   haiku/trunk/src/apps/mediaplayer/media_node_framework/audio/AudioResampler.h
   haiku/trunk/src/apps/mediaplayer/media_node_framework/audio/AudioSupplier.cpp
   haiku/trunk/src/apps/mediaplayer/media_node_framework/audio/AudioSupplier.h
   haiku/trunk/src/apps/mediaplayer/media_node_framework/audio/SampleBuffer.h
   haiku/trunk/src/apps/mediaplayer/media_node_framework/video/
   haiku/trunk/src/apps/mediaplayer/media_node_framework/video/VideoConsumer.cpp
   haiku/trunk/src/apps/mediaplayer/media_node_framework/video/VideoConsumer.h
   haiku/trunk/src/apps/mediaplayer/media_node_framework/video/VideoProducer.cpp
   haiku/trunk/src/apps/mediaplayer/media_node_framework/video/VideoProducer.h
   haiku/trunk/src/apps/mediaplayer/media_node_framework/video/VideoSupplier.cpp
   haiku/trunk/src/apps/mediaplayer/media_node_framework/video/VideoSupplier.h
   haiku/trunk/src/apps/mediaplayer/media_node_framework/video/VideoTarget.cpp
   haiku/trunk/src/apps/mediaplayer/media_node_framework/video/VideoTarget.h
   haiku/trunk/src/apps/mediaplayer/supplier/AudioTrackSupplier.cpp
   haiku/trunk/src/apps/mediaplayer/supplier/AudioTrackSupplier.h
   haiku/trunk/src/apps/mediaplayer/supplier/ProxyAudioSupplier.cpp
   haiku/trunk/src/apps/mediaplayer/supplier/ProxyAudioSupplier.h
   haiku/trunk/src/apps/mediaplayer/supplier/ProxyVideoSupplier.cpp
   haiku/trunk/src/apps/mediaplayer/supplier/ProxyVideoSupplier.h
   haiku/trunk/src/apps/mediaplayer/supplier/VideoTrackSupplier.cpp
   haiku/trunk/src/apps/mediaplayer/supplier/VideoTrackSupplier.h
   haiku/trunk/src/apps/mediaplayer/support/Event.cpp
   haiku/trunk/src/apps/mediaplayer/support/Event.h
   haiku/trunk/src/apps/mediaplayer/support/EventQueue.cpp
   haiku/trunk/src/apps/mediaplayer/support/EventQueue.h
   haiku/trunk/src/apps/mediaplayer/support/MessageEvent.cpp
   haiku/trunk/src/apps/mediaplayer/support/MessageEvent.h
Removed:
   haiku/trunk/src/apps/mediaplayer/ButtonBitmaps.h
   haiku/trunk/src/apps/mediaplayer/DrawingTidbits.cpp
   haiku/trunk/src/apps/mediaplayer/DrawingTidbits.h
   haiku/trunk/src/apps/mediaplayer/SeekSlider.cpp
   haiku/trunk/src/apps/mediaplayer/SeekSlider.h
   haiku/trunk/src/apps/mediaplayer/SoundOutput.cpp
   haiku/trunk/src/apps/mediaplayer/SoundOutput.h
   haiku/trunk/src/apps/mediaplayer/TransportButton.cpp
   haiku/trunk/src/apps/mediaplayer/TransportButton.h
   haiku/trunk/src/apps/mediaplayer/VolumeSlider.cpp
   haiku/trunk/src/apps/mediaplayer/VolumeSlider.h
   haiku/trunk/src/apps/mediaplayer/supplier/AudioSupplier.cpp
   haiku/trunk/src/apps/mediaplayer/supplier/AudioSupplier.h
   haiku/trunk/src/apps/mediaplayer/supplier/VideoSupplier.cpp
   haiku/trunk/src/apps/mediaplayer/supplier/VideoSupplier.h
   haiku/trunk/src/apps/mediaplayer/support/AutoLocker.h
Modified:
   haiku/trunk/src/apps/mediaplayer/Controller.cpp
   haiku/trunk/src/apps/mediaplayer/Controller.h
   haiku/trunk/src/apps/mediaplayer/InfoWin.cpp
   haiku/trunk/src/apps/mediaplayer/Jamfile
   haiku/trunk/src/apps/mediaplayer/MainApp.cpp
   haiku/trunk/src/apps/mediaplayer/MainWin.cpp
   haiku/trunk/src/apps/mediaplayer/VideoView.cpp
   haiku/trunk/src/apps/mediaplayer/VideoView.h
   haiku/trunk/src/apps/mediaplayer/supplier/MediaTrackAudioSupplier.cpp
   haiku/trunk/src/apps/mediaplayer/supplier/MediaTrackAudioSupplier.h
   haiku/trunk/src/apps/mediaplayer/supplier/MediaTrackVideoSupplier.cpp
   haiku/trunk/src/apps/mediaplayer/supplier/MediaTrackVideoSupplier.h
Log:
* Moved a bunch of non-primary interface classes into a new subfolder
&quot;interface&quot;

* Complete reimplementation of the playback engine using Media Nodes:
- Seeking video files does not appear to lockup the playback anymore, but
works on a frame accurate level even for keyframe based streams. There is
currently a problem with certain container formats, the audio track reports
a &quot;Device Seek Error&quot; in certain conditions. In that case audio goes silent,
and can be restarted by going back to the beginnings of the stream.
- Video overlays are now supported.
- It would be possible to connect the output of the MediaPlayer to other
applications or dormant media nodes.

* Known regressions:
- The volume slider has currently no effect anymore.
- Switching the audio track during playback has a known race condition and
can crash the player.
- The new engine is not as &quot;light weight&quot; as the old one. I tagged the
previous implementation in tags/components/mediaplayer-engine-v1. It does
not seem to have any noticable effect though.



Deleted: haiku/trunk/src/apps/mediaplayer/ButtonBitmaps.h

Modified: haiku/trunk/src/apps/mediaplayer/Controller.cpp
===================================================================
--- haiku/trunk/src/apps/mediaplayer/Controller.cpp	2008-05-30 17:45:27 UTC (rev 25724)
+++ haiku/trunk/src/apps/mediaplayer/Controller.cpp	2008-05-30 18:59:36 UTC (rev 25725)
@@ -2,7 +2,7 @@
  * Controller.cpp - Media Player for the Haiku Operating System
  *
  * Copyright (C) 2006 Marcus Overhagen &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/haiku-commits">marcus at overhagen.de</A>&gt;
- * Copyright (C) 2007 Stephan A&#223;mus &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/haiku-commits">superstippi at gmx.de</A>&gt;
+ * Copyright (C) 2007-2008 Stephan A&#223;mus &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/haiku-commits">superstippi at gmx.de</A>&gt; (MIT Ok)
  * Copyright (C) 2007 Fredrik Mod&#233;en &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/haiku-commits">fredrik at modeen.se</A>&gt;
  *
  * This program is free software; you can redistribute it and/or
@@ -33,25 +33,22 @@
 #include &lt;Path.h&gt;
 #include &lt;Window.h&gt; // for debugging only
 
+#include &quot;AutoDeleter.h&quot;
 #include &quot;ControllerView.h&quot;
 #include &quot;PlaybackState.h&quot;
-#include &quot;SoundOutput.h&quot;
 #include &quot;VideoView.h&quot;
 
 // suppliers
-#include &quot;AudioSupplier.h&quot;
+#include &quot;AudioTrackSupplier.h&quot;
 #include &quot;MediaTrackAudioSupplier.h&quot;
 #include &quot;MediaTrackVideoSupplier.h&quot;
-#include &quot;VideoSupplier.h&quot;
+#include &quot;ProxyAudioSupplier.h&quot;
+#include &quot;ProxyVideoSupplier.h&quot;
+#include &quot;VideoTrackSupplier.h&quot;
 
 using std::nothrow;
 
 
-#define AUDIO_PLAY_PRIORITY		110
-#define VIDEO_PLAY_PRIORITY		20
-#define AUDIO_DECODE_PRIORITY	13
-#define VIDEO_DECODE_PRIORITY	13
-
 void 
 HandleError(const char *text, status_t err)
 {
@@ -63,7 +60,7 @@
 }
 
 
-// #pragma mark -
+// #pragma mark - Controller::Listener
 
 
 Controller::Listener::Listener() {}
@@ -80,163 +77,128 @@
 void Controller::Listener::MutedChanged(bool) {}
 
 
-// #pragma mark -
+// #pragma mark - Controller
 
 
 Controller::Controller()
- :	fVideoView(NULL)
- ,	fPaused(false)
- ,	fStopped(true)
+ :	NodeManager()
+ ,	fVideoView(NULL)
  ,	fVolume(1.0)
  ,	fMuted(false)
 
  ,	fRef()
- ,	fMediaFile(0)
- ,	fDataLock(&quot;controller data lock&quot;)
+ ,	fMediaFile(NULL)
 
- ,	fVideoSupplier(NULL)
- ,	fAudioSupplier(NULL)
+ ,	fVideoSupplier(new ProxyVideoSupplier())
+ ,	fAudioSupplier(new ProxyAudioSupplier(this))
+ ,	fVideoTrackSupplier(NULL)
+ ,	fAudioTrackSupplier(NULL)
 
- ,	fVideoSupplierLock(&quot;video supplier lock&quot;)
- ,	fAudioSupplierLock(&quot;audio supplier lock&quot;)
+ ,	fAudioTrackList(4)
+ ,	fVideoTrackList(2)
 
- ,	fAudioTrackList(new BList)
- ,	fVideoTrackList(new BList)
- ,	fAudioDecodeSem(-1)
- ,	fVideoDecodeSem(-1)
- ,	fAudioPlaySem(-1)
- ,	fVideoPlaySem(-1)
- ,	fAudioDecodeThread(-1)
- ,	fVideoDecodeThread(-1)
- ,	fAudioPlayThread(-1)
- ,	fVideoPlayThread(-1)
- ,	fSoundOutput(NULL)
- ,	fSeekAudio(false)
- ,	fSeekVideo(false)
- ,	fSeekPosition(0)
  ,	fPosition(0)
  ,	fDuration(0)
- ,	fAudioBufferCount(MAX_AUDIO_BUFFERS)
- ,	fAudioBufferReadIndex(0)
- ,	fAudioBufferWriteIndex(0)
- ,	fVideoBufferCount(MAX_VIDEO_BUFFERS)
- ,	fVideoBufferReadIndex(0)
- ,	fVideoBufferWriteIndex(0)
- ,	fTimeSourceLock(&quot;time source lock&quot;)
- ,	fTimeSourceSysTime(0)
- ,	fTimeSourcePerfTime(0)
+ ,	fVideoFrameRate(25.0)
+
  ,	fAutoplay(true)
  ,	fPauseAtEndOfStream(false)
  ,	fSeekToStartAfterPause(false)
- ,	fCurrentBitmap(NULL)
- ,	fBitmapLock(&quot;bitmap lock&quot;)
+
  ,	fListeners(4)
 {
-	for (int i = 0; i &lt; MAX_AUDIO_BUFFERS; i++) {
-		fAudioBuffer[i].bitmap = NULL;
-		fAudioBuffer[i].buffer = NULL;
-		fAudioBuffer[i].sizeMax = 0;
-		fAudioBuffer[i].formatChanged = false;
-		fAudioBuffer[i].endOfStream = false;
-	}
-	for (int i = 0; i &lt; MAX_VIDEO_BUFFERS; i++) {
-		fVideoBuffer[i].bitmap = NULL;
-		fVideoBuffer[i].buffer = NULL;
-		fVideoBuffer[i].sizeMax = 0;
-		fVideoBuffer[i].formatChanged = false;
-		fVideoBuffer[i].endOfStream = false;
-	}
-
 	fStopped = fAutoplay ? false : true;
-
-	_StartThreads();
 }
 
 
 Controller::~Controller()
 {
-	_StopThreads();
-
 	if (fMediaFile)
 		fMediaFile-&gt;ReleaseAllTracks();
 	delete fMediaFile;
-	delete fAudioTrackList;
-	delete fVideoTrackList;
-
-	delete fSoundOutput;
 }
 
 
-// #pragma mark -
+// #pragma mark - NodeManager interface
 
 
-bool
-Controller::Lock()
+int64
+Controller::Duration()
 {
-	return fDataLock.Lock();
+	return (int64)((double)fDuration * fVideoFrameRate / 1000000.0);
 }
 
 
-status_t
-Controller::LockWithTimeout(bigtime_t timeout)
+VideoTarget*
+Controller::CreateVideoTarget()
 {
-	return fDataLock.LockWithTimeout(timeout);
+	return fVideoView;
 }
 
 
-void
-Controller::Unlock()
+VideoSupplier*
+Controller::CreateVideoSupplier()
 {
-	return fDataLock.Unlock();
+	return fVideoSupplier;
 }
 
 
+AudioSupplier*
+Controller::CreateAudioSupplier()
+{
+	return fAudioSupplier;
+}
+
+
 // #pragma mark -
 
 
 status_t
 Controller::SetTo(const entry_ref &amp;ref)
 {
-	BAutolock dl(fDataLock);
-	BAutolock al(fVideoSupplierLock);
-	BAutolock vl(fAudioSupplierLock);
+	BAutolock _(this);
 
-	if (fRef == ref)
+	if (fRef == ref) {
+		SetCurrentFrame(0);
+		StartPlaying();
 		return B_OK;
+	}
 
 	fRef = ref;
 
-	fAudioTrackList-&gt;MakeEmpty();
-	fVideoTrackList-&gt;MakeEmpty();
-	if (fMediaFile)
-		fMediaFile-&gt;ReleaseAllTracks();
-	delete fMediaFile;
-	fMediaFile = NULL;
-	delete fVideoSupplier;
-	fVideoSupplier = NULL;
-	delete fAudioSupplier;
-	fAudioSupplier = NULL;
+	fAudioSupplier-&gt;SetSupplier(NULL, fVideoFrameRate);
+	fVideoSupplier-&gt;SetSupplier(NULL);
+
+	fAudioTrackList.MakeEmpty();
+	fVideoTrackList.MakeEmpty();
 	
-	fSeekAudio = true;
-	fSeekVideo = true;
-	fSeekPosition = 0;
-	fPaused = false;
-	fStopped = fAutoplay ? false : true;
+	ObjectDeleter&lt;BMediaFile&gt; oldMediaFileDeleter(fMediaFile);
+		// BMediaFile destructor will call ReleaseAllTracks()
+	fMediaFile = NULL;
+
+	// Do not delete the supplier chain until after we called
+	// NodeManager::Init() to setup a new media node chain
+	ObjectDeleter&lt;VideoTrackSupplier&gt; videoSupplierDeleter(
+		fVideoTrackSupplier);
+	ObjectDeleter&lt;AudioTrackSupplier&gt; audioSupplierDeleter(
+		fAudioTrackSupplier);
+
+	fVideoTrackSupplier = NULL;
+	fAudioTrackSupplier = NULL;
+
 	fPauseAtEndOfStream = false;
 	fSeekToStartAfterPause = false;
-	fTimeSourceSysTime = system_time();
-	fTimeSourcePerfTime = 0;
 	fDuration = 0;
+	fVideoFrameRate = 25.0;
 
-	_UpdatePosition(0);
-
 	status_t err;
 	
 	BMediaFile *mf = new BMediaFile(&amp;ref);
+	ObjectDeleter&lt;BMediaFile&gt; mediaFileDeleter(mf);
+
 	err = mf-&gt;InitCheck();
 	if (err != B_OK) {
 		printf(&quot;Controller::SetTo: initcheck failed\n&quot;);
-		delete mf;
 		_NotifyFileChanged();
 		return err;
 	}
@@ -244,7 +206,6 @@
 	int trackcount = mf-&gt;CountTracks();
 	if (trackcount &lt;= 0) {
 		printf(&quot;Controller::SetTo: trackcount %d\n&quot;, trackcount);
-		delete mf;
 		_NotifyFileChanged();
 		return B_MEDIA_NO_HANDLER;
 	}
@@ -260,9 +221,9 @@
 			continue;
 		}
 		if (f.IsAudio()) {
-			fAudioTrackList-&gt;AddItem(t);
+			fAudioTrackList.AddItem(t);
 		} else if (f.IsVideo()) {
-			fVideoTrackList-&gt;AddItem(t);
+			fVideoTrackList.AddItem(t);
 		} else {
 			printf(&quot;Controller::SetTo: track index %d has unknown type\n&quot;, i);
 			mf-&gt;ReleaseTrack(t);
@@ -271,20 +232,34 @@
 
 	if (AudioTrackCount() == 0 &amp;&amp; VideoTrackCount() == 0) {
 		printf(&quot;Controller::SetTo: no audio or video tracks found\n&quot;);
-		delete mf;
 		_NotifyFileChanged();
 		return B_MEDIA_NO_HANDLER;
 	}
 
-	printf(&quot;Controller::SetTo: %d audio track, %d video track\n&quot;, AudioTrackCount(), VideoTrackCount());
+	printf(&quot;Controller::SetTo: %d audio track, %d video track\n&quot;,
+		AudioTrackCount(), VideoTrackCount());
 
+	mediaFileDeleter.Detach();
 	fMediaFile = mf;
 
 	SelectAudioTrack(0);
 	SelectVideoTrack(0);
 
+	fVideoView-&gt;DisableOverlay();
+
+	int width;
+	int height;
+	GetSize(&amp;width, &amp;height);
+
+	Init(BRect(0, 0, width - 1, height - 1), fVideoFrameRate,
+		LOOPING_ALL, false);
+
+	SetCurrentFrame(0);
+
+	if (fAutoplay)
+		StartPlaying(true);
+
 	_NotifyFileChanged();
-	_NotifyPlaybackStateChanged();
 
 	return B_OK;
 }
@@ -293,16 +268,16 @@
 void
 Controller::GetSize(int *width, int *height)
 {
-	BAutolock _(fVideoSupplierLock);
+	BAutolock _(this);
 
-	if (fVideoSupplier) {
-		media_format format = fVideoSupplier-&gt;Format();
+	if (fVideoTrackSupplier) {
+		media_format format = fVideoTrackSupplier-&gt;Format();
 		// TODO: take aspect ratio into account!
 		*height = format.u.raw_video.display.line_count;
 		*width = format.u.raw_video.display.line_width;
 	} else {
-		*height = 480;
-		*width = 640;
+		*height = 0;
+		*width = 0;
 	}
 }
 
@@ -310,37 +285,45 @@
 int
 Controller::AudioTrackCount()
 {
-	BAutolock _(fDataLock);
+	BAutolock _(this);
 
-	return fAudioTrackList-&gt;CountItems();
+	return fAudioTrackList.CountItems();
 }
 
 
 int
 Controller::VideoTrackCount()
 {
-	BAutolock _(fDataLock);
+	BAutolock _(this);
 
-	return fVideoTrackList-&gt;CountItems();
+	return fVideoTrackList.CountItems();
 }
 
 
 status_t
 Controller::SelectAudioTrack(int n)
 {	
-	BAutolock _(fAudioSupplierLock);
+	BAutolock _(this);
 
-	BMediaTrack* track = (BMediaTrack *)fAudioTrackList-&gt;ItemAt(n);
+	BMediaTrack* track = (BMediaTrack *)fAudioTrackList.ItemAt(n);
 	if (!track)
 		return B_ERROR;
 
-	delete fAudioSupplier;
-	fAudioSupplier = new MediaTrackAudioSupplier(track);
+	ObjectDeleter&lt;AudioTrackSupplier&gt; deleter(fAudioTrackSupplier);
+	fAudioTrackSupplier = new MediaTrackAudioSupplier(track);
 
-	bigtime_t a = fAudioSupplier-&gt;Duration();
-	bigtime_t v = fVideoSupplier ? fVideoSupplier-&gt;Duration() : 0;;
+	bigtime_t a = fAudioTrackSupplier-&gt;Duration();
+	bigtime_t v = fVideoTrackSupplier ? fVideoTrackSupplier-&gt;Duration() : 0;;
 	fDuration = max_c(a, v);
+	DurationChanged();
+	// TODO: notify duration changed!
 
+	// TODO: Not good, because the ProxyAudioSupplier currently
+	// uses the supplier without locking the Controller!
+	// This is only a problem when selecting a different audio track
+	// from the interface menu.
+	fAudioSupplier-&gt;SetSupplier(fAudioTrackSupplier, fVideoFrameRate);
+
 	_NotifyAudioTrackChanged(n);
 	return B_OK;
 }
@@ -349,20 +332,25 @@
 status_t
 Controller::SelectVideoTrack(int n)
 {
-	BAutolock _(fVideoSupplierLock);
+	BAutolock _(this);
 
-	BMediaTrack* track = (BMediaTrack *)fVideoTrackList-&gt;ItemAt(n);
+	BMediaTrack* track = (BMediaTrack *)fVideoTrackList.ItemAt(n);
 	if (!track)
 		return B_ERROR;
 
-	delete fVideoSupplier;
-	fVideoSupplier = new MediaTrackVideoSupplier(track,
+	ObjectDeleter&lt;VideoTrackSupplier&gt; deleter(fVideoTrackSupplier);
+	fVideoTrackSupplier = new MediaTrackVideoSupplier(track,
 		IsOverlayActive() ? B_YCbCr422 : B_RGB32);
 
-	bigtime_t a = fAudioSupplier ? fAudioSupplier-&gt;Duration() : 0;
-	bigtime_t v = fVideoSupplier-&gt;Duration();
+	bigtime_t a = fAudioTrackSupplier ? fAudioTrackSupplier-&gt;Duration() : 0;
+	bigtime_t v = fVideoTrackSupplier-&gt;Duration();
 	fDuration = max_c(a, v);
+	fVideoFrameRate = fVideoTrackSupplier-&gt;Format().u.raw_video.field_rate;
+	DurationChanged();
+	// TODO: notify duration changed!
 
+	fVideoSupplier-&gt;SetSupplier(fVideoTrackSupplier);
+
 	_NotifyVideoTrackChanged(n);
 	return B_OK;
 }
@@ -376,20 +364,10 @@
 {
 	printf(&quot;Controller::Stop\n&quot;);
 
-	BAutolock _(fDataLock);
+	BAutolock _(this);
 
-	if (fStopped)
-		return;
-	
-	fPaused = false;
-	fStopped = true;
-	
-	fSeekAudio = true;
-	fSeekVideo = true;
-	fSeekPosition = 0;
-
-	_NotifyPlaybackStateChanged();
-	_UpdatePosition(0, false, true);
+	StopPlaying();
+	SetCurrentFrame(0);
 }
 
 
@@ -398,21 +376,15 @@
 {
 	printf(&quot;Controller::Play\n&quot;);
 
-	BAutolock _(fDataLock);
+	BAutolock _(this);
 	
-	if (!fPaused &amp;&amp; !fStopped)
-		return;
-
-	fStopped = false;
-	fPaused = false;
-
 	if (fSeekToStartAfterPause) {
 printf(&quot;seeking to start after pause\n&quot;);
 		SetPosition(0);
 		fSeekToStartAfterPause = false;
 	}
 
-	_NotifyPlaybackStateChanged();
+	StartPlaying();
 }
 
 
@@ -421,73 +393,45 @@
 {
 	printf(&quot;Controller::Pause\n&quot;);
 
-	BAutolock _(fDataLock);
+	BAutolock _(this);
 
-	if (fStopped || fPaused)
-		return;
-
-	fPaused = true;
-
-	_NotifyPlaybackStateChanged();
+	PausePlaying();
 }
 
 
 void
 Controller::TogglePlaying()
 {
-	BAutolock _(fDataLock);
+	printf(&quot;Controller::TogglePlaying\n&quot;);
 
-	if (IsPaused() || IsStopped())
-		Play();
-	else
-		Pause();
-}
+	BAutolock _(this);
 
-
-bool
-Controller::IsPaused() const
-{
-	BAutolock _(fDataLock);
-
-	return fPaused;
+	NodeManager::TogglePlaying();
 }
 
 
-bool
-Controller::IsStopped() const
-{
-	BAutolock _(fDataLock);
-
-	return fStopped;
-}
-
-
 uint32
-Controller::PlaybackState() const
+Controller::PlaybackState()
 {
-	BAutolock _(fDataLock);
+	BAutolock _(this);
 
-	if (fStopped)
-		return PLAYBACK_STATE_STOPPED;
-	if (fPaused)
-		return PLAYBACK_STATE_PAUSED;
-	return PLAYBACK_STATE_PLAYING;
+	return _PlaybackState(PlaybackManager::PlayMode());
 }
 
 
 bigtime_t
-Controller::Duration()
+Controller::TimeDuration()
 {
-	BAutolock _(fDataLock);
+	BAutolock _(this);
 
 	return fDuration;
 }
 
 
 bigtime_t
-Controller::Position()
+Controller::TimePosition()
 {
-	BAutolock _(fDataLock);
+	BAutolock _(this);
 
 	return fPosition;
 }
@@ -507,8 +451,9 @@
 			ToggleMute();
 
 		fVolume = value;
-		if (fSoundOutput)
-			fSoundOutput-&gt;SetVolume(fVolume);
+// TODO: apply to AutioProducer node
+//		if (fSoundOutput)
+//			fSoundOutput-&gt;SetVolume(fVolume);
 
 		_NotifyVolumeChanged(fVolume);
 	}
@@ -537,14 +482,15 @@
 		return;
 
 	fMuted = !fMuted;
-	
-	if (fSoundOutput) {
-		if (fMuted)
-			fSoundOutput-&gt;SetVolume(0.0);
-		else
-			fSoundOutput-&gt;SetVolume(fVolume);
-	}
 
+// TODO: apply to AudioProducer node	
+//	if (fSoundOutput) {
+//		if (fMuted)
+//			fSoundOutput-&gt;SetVolume(0.0);
+//		else
+//			fSoundOutput-&gt;SetVolume(fVolume);
+//	}
+
 	_NotifyMutedChanged(fMuted);
 
 	Unlock();
@@ -552,9 +498,9 @@
 
 
 float
-Controller::Volume() const
+Controller::Volume()
 {
-	BAutolock _(fDataLock);
+	BAutolock _(this);
 
 	return fVolume;	
 }
@@ -563,18 +509,11 @@
 void
 Controller::SetPosition(float value)
 {
-	printf(&quot;Controller::SetPosition %.4f\n&quot;, value);
+	BAutolock _(this);
 
-	BAutolock _(fDataLock);
+	SetCurrentFrame(Duration() * value);
 
-	fSeekPosition = bigtime_t(value * Duration());
-	fSeekAudio = true;
-	fSeekVideo = true;
-
 	fSeekToStartAfterPause = false;
-
-//	release_sem(fAudioWaitSem);
-//	release_sem(fVideoWaitSem);
 }
 
 
@@ -641,8 +580,8 @@
 Controller::GetEncodedVideoFormat(media_format* format)
 {
 	// you need to hold the data lock
-	if (fVideoSupplier)
-		return fVideoSupplier-&gt;GetEncodedFormat(format);
+	if (fVideoTrackSupplier)
+		return fVideoTrackSupplier-&gt;GetEncodedFormat(format);
 	return B_NO_INIT;
 }
 
@@ -651,8 +590,8 @@
 Controller::GetVideoCodecInfo(media_codec_info* info)
 {
 	// you need to hold the data lock
-	if (fVideoSupplier)
-		return fVideoSupplier-&gt;GetCodecInfo(info);
+	if (fVideoTrackSupplier)
+		return fVideoTrackSupplier-&gt;GetCodecInfo(info);
 	return B_NO_INIT;
 }
 
@@ -661,8 +600,8 @@
 Controller::GetEncodedAudioFormat(media_format* format)
 {
 	// you need to hold the data lock
-	if (fAudioSupplier)
-		return fAudioSupplier-&gt;GetEncodedFormat(format);
+	if (fAudioTrackSupplier)
+		return fAudioTrackSupplier-&gt;GetEncodedFormat(format);
 	return B_NO_INIT;
 }
 
@@ -671,8 +610,8 @@
 Controller::GetAudioCodecInfo(media_codec_info* info)
 {
 	// you need to hold the data lock
-	if (fAudioSupplier)
-		return fAudioSupplier-&gt;GetCodecInfo(info);
+	if (fAudioTrackSupplier)
+		return fAudioTrackSupplier-&gt;GetCodecInfo(info);
 	return B_NO_INIT;
 }
 
@@ -683,49 +622,29 @@
 void
 Controller::SetVideoView(VideoView *view)
 {
-	BAutolock _(fDataLock);
+	BAutolock _(this);
 
 	fVideoView = view;
-	fVideoView-&gt;SetController(this);
 }
 
 
 bool
 Controller::IsOverlayActive()
 {
-//	return true;
+	if (fVideoView)
+		return fVideoView-&gt;IsOverlayActive();
+
 	return false;
 }
 
 
-bool
-Controller::LockBitmap()
-{
-	return fBitmapLock.Lock();
-}
-
-
-void
-Controller::UnlockBitmap()
-{
-	fBitmapLock.Unlock();
-}
-
-
-BBitmap *
-Controller::Bitmap()
-{
-	return fCurrentBitmap;
-}
-
-
 // #pragma mark -
 
 
 bool
 Controller::AddListener(Listener* listener)
 {
-	BAutolock _(fDataLock);
+	BAutolock _(this);
 
 	if (listener &amp;&amp; !fListeners.HasItem(listener))
 		return fListeners.AddItem(listener);
@@ -736,473 +655,44 @@
 void
 Controller::RemoveListener(Listener* listener)
 {
-	BAutolock _(fDataLock);
+	BAutolock _(this);
 
 	fListeners.RemoveItem(listener);
 }
 
 
-// #pragma mark -
+// #pragma mark - Private
 
 
-void
-Controller::_AudioDecodeThread()
+uint32
+Controller::_PlaybackState(int32 playingMode) const
 {
-	AudioSupplier* lastSupplier = NULL;
-	size_t bufferSize = 0;
-	size_t frameSize = 0;
-	bool decodeError = false;
-	
-printf(&quot;audio decode start\n&quot;);	
-
-	while (acquire_sem(fAudioDecodeSem) == B_OK) {
-//printf(&quot;audio decoding..\n&quot;);	
-		buffer_info *buffer = &amp;fAudioBuffer[fAudioBufferWriteIndex];
-		fAudioBufferWriteIndex = (fAudioBufferWriteIndex + 1) % fAudioBufferCount;
-
-		if (!fAudioSupplierLock.Lock())
-			return;
-
-		buffer-&gt;formatChanged = lastSupplier != fAudioSupplier;
-		lastSupplier = fAudioSupplier;
-
-		if (!lastSupplier) {
-			// no audio supplier
-			buffer-&gt;sizeUsed = 0;
-			buffer-&gt;startTime = 0;
-
-			fAudioSupplierLock.Unlock();
-			snooze(10000);
-			release_sem(fAudioPlaySem);
-			continue;
-		}
-
-		if (buffer-&gt;formatChanged) {
-printf(&quot;audio format changed\n&quot;);
-			buffer-&gt;mediaFormat = lastSupplier-&gt;Format();
-			bufferSize = buffer-&gt;mediaFormat.u.raw_audio.buffer_size;
-			frameSize = (buffer-&gt;mediaFormat.u.raw_audio.format &amp; 0xf)
-				* buffer-&gt;mediaFormat.u.raw_audio.channel_count;
-		}
-
-		if (buffer-&gt;sizeMax &lt; bufferSize) {
-			delete[] buffer-&gt;buffer;
-			buffer-&gt;buffer = new char [bufferSize];
-			buffer-&gt;sizeMax = bufferSize;
-		}
-
-		if (fSeekAudio) {
-			bigtime_t pos = fSeekPosition;
-			lastSupplier-&gt;SeekToTime(&amp;pos);
-			fSeekAudio = false;
-			decodeError = false;
-		}
-
-		int64 frames;
-		if (!decodeError) {
-			buffer-&gt;endOfStream = false;
-			status_t ret = lastSupplier-&gt;ReadFrames(buffer-&gt;buffer,
-				&amp;frames, &amp;buffer-&gt;startTime);
-			decodeError = B_OK != ret;
-if (ret != B_OK)
-printf(&quot;audio decode error: %s\n&quot;, strerror(ret));
-			if (ret == B_LAST_BUFFER_ERROR) {
-				_EndOfStreamReached();
-				buffer-&gt;endOfStream = true;
-			}
-		}
-		if (!decodeError) {
-			buffer-&gt;sizeUsed = frames * frameSize;
-		} else {
-			buffer-&gt;sizeUsed = 0;
-			buffer-&gt;startTime = 0;
-
-			fAudioSupplierLock.Unlock();
-			snooze(10000);
-			release_sem(fAudioPlaySem);
-			continue;
-		}
-
-		fAudioSupplierLock.Unlock();
-
-		release_sem(fAudioPlaySem);
-	}
-}
-
-
-void
-Controller::_AudioPlayThread()
-{
-	bigtime_t bufferDuration = 0;
-	bigtime_t audioLatency = 0;
-	status_t status;
-
-printf(&quot;audio play start\n&quot;);	
-
-	while (acquire_sem(fAudioPlaySem) == B_OK) {
-//printf(&quot;audio playing..\n&quot;);	
-		buffer_info *buffer = &amp;fAudioBuffer[fAudioBufferReadIndex];
-		fAudioBufferReadIndex = (fAudioBufferReadIndex + 1) % fAudioBufferCount;
-		wait:
-		if (fPaused || fStopped) {
-//printf(&quot;waiting..\n&quot;);	
-			status = acquire_sem_etc(fVideoWaitSem, 1, B_RELATIVE_TIMEOUT, 50000);
-			if (status != B_OK &amp;&amp; status != B_TIMED_OUT)
-				break;
-			goto wait;
-		}
-
-		if (!fDataLock.Lock())
-			return;
-
-		if (buffer-&gt;sizeUsed == 0) {
-			bool pause = fPauseAtEndOfStream &amp;&amp; buffer-&gt;endOfStream;
-			fDataLock.Unlock();
-			release_sem(fAudioDecodeSem);
-			if (pause) {
-				fPauseAtEndOfStream = false;
-				fSeekToStartAfterPause = true;
-				Pause();
-			} else
-				snooze(25000);
-			continue;
-		}
-
-		if (!fSoundOutput || buffer-&gt;formatChanged) {
-			if (!fSoundOutput
-				|| !(fSoundOutput-&gt;Format() == buffer-&gt;mediaFormat.u.raw_audio)) {
-				delete fSoundOutput;
-				fSoundOutput = new (nothrow) SoundOutput(fRef.name,
-					buffer-&gt;mediaFormat.u.raw_audio);
-				fSoundOutput-&gt;SetVolume(fVolume);
-bufferDuration = bigtime_t(1000000.0
-	* (buffer-&gt;mediaFormat.u.raw_audio.buffer_size
-	/ (buffer-&gt;mediaFormat.u.raw_audio.channel_count
-	* (buffer-&gt;mediaFormat.u.raw_audio.format &amp; 0xf)))
-	/ buffer-&gt;mediaFormat.u.raw_audio.frame_rate);
-printf(&quot;audio format changed, new buffer duration %Ld\n&quot;, bufferDuration);
-			}
-		}
-
-		// TODO: fix performance time update (in case no audio)
-		if (fTimeSourceLock.Lock()) {
-			audioLatency = fSoundOutput ? fSoundOutput-&gt;Latency() : 0;
-			fTimeSourceSysTime = system_time() + audioLatency - bufferDuration;
-			fTimeSourcePerfTime = buffer-&gt;startTime;
-			fTimeSourceLock.Unlock();
-		}
-//		printf(&quot;timesource: sys: %Ld perf: %Ld\n&quot;, fTimeSourceSysTime,
-//			fTimeSourcePerfTime);
-
-		if (fSoundOutput) {
-			if (fSoundOutput-&gt;InitCheck() &gt;= B_OK)
-				fSoundOutput-&gt;Play(buffer-&gt;buffer, buffer-&gt;sizeUsed);
-			_UpdatePosition(buffer-&gt;startTime);
-		}
-
-
-		fDataLock.Unlock();
-
-		release_sem(fAudioDecodeSem);
-	}
-}
-
-
-// #pragma mark -
-
-
-void
-Controller::_VideoDecodeThread()
-{
-	VideoSupplier* lastSupplier = NULL;
-	size_t bufferSize = 0;
-	size_t bytePerRow = 0;
-	int lineWidth = 0;
-	int lineCount = 0;
-	bool decodeError = false;
-	status_t status;
-
-printf(&quot;video decode start\n&quot;);	
-
-	while (acquire_sem(fVideoDecodeSem) == B_OK) {
-		buffer_info *buffer = &amp;fVideoBuffer[fVideoBufferWriteIndex];
-		fVideoBufferWriteIndex = (fVideoBufferWriteIndex + 1) % fVideoBufferCount;
-
-		if (!fVideoSupplierLock.Lock())
-			return;
-
-		buffer-&gt;formatChanged = lastSupplier != fVideoSupplier;
-		lastSupplier = fVideoSupplier;
-
-		if (!lastSupplier) {
-			// no video supplier
-			buffer-&gt;sizeUsed = 0;
-			buffer-&gt;startTime = 0;
-
-			fVideoSupplierLock.Unlock();
-			snooze(10000);
-			release_sem(fVideoDecodeSem);
-			continue;
-		}
-		
-		
-		if (buffer-&gt;formatChanged) {
-//printf(&quot;Video track changed\n&quot;);
-			buffer-&gt;mediaFormat = lastSupplier-&gt;Format();
-
-			bytePerRow = buffer-&gt;mediaFormat.u.raw_video.display.bytes_per_row;
-			lineWidth = buffer-&gt;mediaFormat.u.raw_video.display.line_width;
-			lineCount = buffer-&gt;mediaFormat.u.raw_video.display.line_count;
-			bufferSize = lineCount * bytePerRow;
-		}
-
-		if (buffer-&gt;sizeMax != bufferSize) {
-			LockBitmap();
-
-			BRect r(0, 0, lineWidth - 1, lineCount - 1);
-			if (buffer-&gt;bitmap == fCurrentBitmap)
-				fCurrentBitmap = NULL;
-			delete buffer-&gt;bitmap;
-printf(&quot;allocating bitmap #%ld %d %d %ld\n&quot;,
-	fVideoBufferWriteIndex, lineWidth, lineCount, bytePerRow);
-			if (buffer-&gt;mediaFormat.u.raw_video.display.format == B_YCbCr422) {
-				buffer-&gt;bitmap = new BBitmap(r, B_BITMAP_WILL_OVERLAY
-					| (fVideoBufferWriteIndex == 0) ?
-						B_BITMAP_RESERVE_OVERLAY_CHANNEL : 0,
-					B_YCbCr422, bytePerRow);
-			} else {
-				buffer-&gt;bitmap = new BBitmap(r, 0, B_RGB32, bytePerRow);
-			}
-			status = buffer-&gt;bitmap-&gt;InitCheck();
-			if (status != B_OK) {
-				printf(&quot;bitmap init status %08lx %s\n&quot;, status, strerror(status));
-				return;
-			}
-			buffer-&gt;buffer = (char *)buffer-&gt;bitmap-&gt;Bits();
-			buffer-&gt;sizeMax = bufferSize;
-
-			UnlockBitmap();
-		}

[... truncated: 10972 lines follow ...]

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="009198.html">[Haiku-commits] r25724 -	haiku/trunk/src/system/kernel/device_manager
</A></li>
	<LI>Next message: <A HREF="009200.html">[Haiku-commits] r25725 - in haiku/trunk/src/apps/mediaplayer: .	interface media_node_framework media_node_framework/audio	media_node_framework/video supplier support
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9199">[ date ]</a>
              <a href="thread.html#9199">[ thread ]</a>
              <a href="subject.html#9199">[ subject ]</a>
              <a href="author.html#9199">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/haiku-commits">More information about the Haiku-commits
mailing list</a><br>
</body></html>
