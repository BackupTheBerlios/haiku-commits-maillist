<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Haiku-commits] r22043 - in haiku/trunk: headers/os/drivers	headers/os/storage headers/private/fs_shell	headers/private/kernel/disk_device_manager	src/add-ons/kernel/file_systems/bfs	src/add-ons/kernel/file_systems/cdda	src/add-ons/kernel/file_systems/dos	src/add-ons/kernel/file_systems/googlefs	src/add-ons/kernel/file_systems/iso9660	src/add-ons/kernel/file_systems/nfs	src/add-ons/kernel/file_systems/ntfs	src/add-ons/kernel/file_systems/ramfs	src/add-ons/kernel/file_systems/reiserfs	src/add-ons/kernel/file_systems/userlandfs/kernel_add_on	src/add-ons/kernel/partitioning_systems/intel	src/add-ons/kernel/partitioning_systems/session	src/system/kernel/disk_device_manager src/system/kernel/fs	src/tools/fs_shell
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/haiku-commits/2007-August/index.html" >
   <LINK REL="made" HREF="mailto:haiku-commits%40lists.berlios.de?Subject=Re%3A%20%5BHaiku-commits%5D%20r22043%20-%20in%20haiku/trunk%3A%20headers/os/drivers%0A%09headers/os/storage%20headers/private/fs_shell%0A%09headers/private/kernel/disk_device_manager%0A%09src/add-ons/kernel/file_systems/bfs%0A%09src/add-ons/kernel/file_systems/cdda%0A%09src/add-ons/kernel/file_systems/dos%0A%09src/add-ons/kernel/file_systems/googlefs%0A%09src/add-ons/kernel/file_systems/iso9660%0A%09src/add-ons/kernel/file_systems/nfs%0A%09src/add-ons/kernel/file_systems/ntfs%0A%09src/add-ons/kernel/file_systems/ramfs%0A%09src/add-ons/kernel/file_systems/reiserfs%0A%09src/add-ons/kernel/file_systems/userlandfs/kernel_add_on%0A%09src/add-ons/kernel/partitioning_systems/intel%0A%09src/add-ons/kernel/partitioning_systems/session%0A%09src/system/kernel/disk_device_manager%20src/system/kernel/fs%0A%09src/tools/fs_shell&In-Reply-To=%3C200708222121.l7MLLcMt027999%40sheep.berlios.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="003658.html">
   <LINK REL="Next"  HREF="003660.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Haiku-commits] r22043 - in haiku/trunk: headers/os/drivers	headers/os/storage headers/private/fs_shell	headers/private/kernel/disk_device_manager	src/add-ons/kernel/file_systems/bfs	src/add-ons/kernel/file_systems/cdda	src/add-ons/kernel/file_systems/dos	src/add-ons/kernel/file_systems/googlefs	src/add-ons/kernel/file_systems/iso9660	src/add-ons/kernel/file_systems/nfs	src/add-ons/kernel/file_systems/ntfs	src/add-ons/kernel/file_systems/ramfs	src/add-ons/kernel/file_systems/reiserfs	src/add-ons/kernel/file_systems/userlandfs/kernel_add_on	src/add-ons/kernel/partitioning_systems/intel	src/add-ons/kernel/partitioning_systems/session	src/system/kernel/disk_device_manager src/system/kernel/fs	src/tools/fs_shell</H1>
    <B>bonefish at BerliOS</B> 
    <A HREF="mailto:haiku-commits%40lists.berlios.de?Subject=Re%3A%20%5BHaiku-commits%5D%20r22043%20-%20in%20haiku/trunk%3A%20headers/os/drivers%0A%09headers/os/storage%20headers/private/fs_shell%0A%09headers/private/kernel/disk_device_manager%0A%09src/add-ons/kernel/file_systems/bfs%0A%09src/add-ons/kernel/file_systems/cdda%0A%09src/add-ons/kernel/file_systems/dos%0A%09src/add-ons/kernel/file_systems/googlefs%0A%09src/add-ons/kernel/file_systems/iso9660%0A%09src/add-ons/kernel/file_systems/nfs%0A%09src/add-ons/kernel/file_systems/ntfs%0A%09src/add-ons/kernel/file_systems/ramfs%0A%09src/add-ons/kernel/file_systems/reiserfs%0A%09src/add-ons/kernel/file_systems/userlandfs/kernel_add_on%0A%09src/add-ons/kernel/partitioning_systems/intel%0A%09src/add-ons/kernel/partitioning_systems/session%0A%09src/system/kernel/disk_device_manager%20src/system/kernel/fs%0A%09src/tools/fs_shell&In-Reply-To=%3C200708222121.l7MLLcMt027999%40sheep.berlios.de%3E"
       TITLE="[Haiku-commits] r22043 - in haiku/trunk: headers/os/drivers	headers/os/storage headers/private/fs_shell	headers/private/kernel/disk_device_manager	src/add-ons/kernel/file_systems/bfs	src/add-ons/kernel/file_systems/cdda	src/add-ons/kernel/file_systems/dos	src/add-ons/kernel/file_systems/googlefs	src/add-ons/kernel/file_systems/iso9660	src/add-ons/kernel/file_systems/nfs	src/add-ons/kernel/file_systems/ntfs	src/add-ons/kernel/file_systems/ramfs	src/add-ons/kernel/file_systems/reiserfs	src/add-ons/kernel/file_systems/userlandfs/kernel_add_on	src/add-ons/kernel/partitioning_systems/intel	src/add-ons/kernel/partitioning_systems/session	src/system/kernel/disk_device_manager src/system/kernel/fs	src/tools/fs_shell">bonefish at mail.berlios.de
       </A><BR>
    <I>Wed Aug 22 23:21:38 CEST 2007</I>
    <P><UL>
        <LI>Previous message: <A HREF="003658.html">[Haiku-commits] r22042 - haiku/trunk/src/apps/terminal
</A></li>
        <LI>Next message: <A HREF="003660.html">[Haiku-commits] r22044 - in haiku/trunk: headers/private/storage	src/kits/storage
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3659">[ date ]</a>
              <a href="thread.html#3659">[ thread ]</a>
              <a href="subject.html#3659">[ subject ]</a>
              <a href="author.html#3659">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: bonefish
Date: 2007-08-22 23:21:30 +0200 (Wed, 22 Aug 2007)
New Revision: 22043
ViewCVS: <A HREF="http://svn.berlios.de/viewcvs/haiku?rev=22043&amp;view=rev">http://svn.berlios.de/viewcvs/haiku?rev=22043&amp;view=rev</A>

Modified:
   haiku/trunk/headers/os/drivers/fs_interface.h
   haiku/trunk/headers/os/storage/DiskDeviceDefs.h
   haiku/trunk/headers/private/fs_shell/fssh_api_wrapper.h
   haiku/trunk/headers/private/fs_shell/fssh_disk_device_defs.h
   haiku/trunk/headers/private/fs_shell/fssh_fs_interface.h
   haiku/trunk/headers/private/kernel/disk_device_manager/KDiskSystem.h
   haiku/trunk/headers/private/kernel/disk_device_manager/KFileSystem.h
   haiku/trunk/headers/private/kernel/disk_device_manager/KPartitioningSystem.h
   haiku/trunk/headers/private/kernel/disk_device_manager/ddm_modules.h
   haiku/trunk/src/add-ons/kernel/file_systems/bfs/kernel_interface.cpp
   haiku/trunk/src/add-ons/kernel/file_systems/cdda/kernel_interface.cpp
   haiku/trunk/src/add-ons/kernel/file_systems/dos/dosfs.c
   haiku/trunk/src/add-ons/kernel/file_systems/googlefs/googlefs.c
   haiku/trunk/src/add-ons/kernel/file_systems/iso9660/kernel_interface.cpp
   haiku/trunk/src/add-ons/kernel/file_systems/nfs/nfs_add_on.c
   haiku/trunk/src/add-ons/kernel/file_systems/ntfs/kernel_interface.c
   haiku/trunk/src/add-ons/kernel/file_systems/ramfs/kernel_interface.cpp
   haiku/trunk/src/add-ons/kernel/file_systems/reiserfs/kernel_interface.cpp
   haiku/trunk/src/add-ons/kernel/file_systems/userlandfs/kernel_add_on/kernel_interface.cpp
   haiku/trunk/src/add-ons/kernel/partitioning_systems/intel/intel.cpp
   haiku/trunk/src/add-ons/kernel/partitioning_systems/session/session.cpp
   haiku/trunk/src/system/kernel/disk_device_manager/KDiskSystem.cpp
   haiku/trunk/src/system/kernel/disk_device_manager/KFileSystem.cpp
   haiku/trunk/src/system/kernel/disk_device_manager/KPartitioningSystem.cpp
   haiku/trunk/src/system/kernel/disk_device_manager/ddm_operation_validation.cpp
   haiku/trunk/src/system/kernel/disk_device_manager/ddm_userland_interface.cpp
   haiku/trunk/src/system/kernel/fs/devfs.cpp
   haiku/trunk/src/system/kernel/fs/pipefs.cpp
   haiku/trunk/src/system/kernel/fs/rootfs.c
   haiku/trunk/src/tools/fs_shell/rootfs.cpp
Log:
* Added disk system flags for whether a partition name and partition
  content name are supported.
* Added file_system_module_info::flags (analogously to
  partition_module_info::flags) which indicate which disk device
  features the FS supports.
* Replaced the
  file_system_module_info/partition_module_info::supports_*()
  hooks by a get_supported_operations() hook and for partitioning
  systems additionally a get_supported_child_operations() hook.
* Updated file and partitioning systems accordingly.
* Updated fs_shell accordingly.
* Updated the DDM accordingly. The syscall interface remains unchanged,
  though.
* _user_supports_initializing_partition() also checks whether the parent
  partitioning system is content now.


Modified: haiku/trunk/headers/os/drivers/fs_interface.h
===================================================================
--- haiku/trunk/headers/os/drivers/fs_interface.h	2007-08-22 20:29:40 UTC (rev 22042)
+++ haiku/trunk/headers/os/drivers/fs_interface.h	2007-08-22 21:21:30 UTC (rev 22043)
@@ -55,7 +55,8 @@
 
 typedef struct file_system_module_info {
 	struct module_info	info;
-	const char			*pretty_name;
+	const char*			pretty_name;
+	uint32				flags;	// DDM flags
 
 	/* scanning (the device is write locked) */
 	float (*identify_partition)(int fd, partition_data *partition,
@@ -205,19 +206,7 @@
 	status_t (*rewind_query)(fs_volume fs, fs_cookie cookie);
 
 	/* capability querying (the device is read locked) */
-	// ToDo: this will probably be combined to a single call
-	bool (*supports_defragmenting)(partition_data *partition,
-				bool *whileMounted);
-	bool (*supports_repairing)(partition_data *partition,
-				bool checkOnly, bool *whileMounted);
-	bool (*supports_resizing)(partition_data *partition,
-				bool *whileMounted);
-	bool (*supports_moving)(partition_data *partition, bool *isNoOp);
-	bool (*supports_setting_content_name)(partition_data *partition,
-				bool *whileMounted);
-	bool (*supports_setting_content_parameters)(partition_data *partition, 
-				bool *whileMounted);
-	bool (*supports_initializing)(partition_data *partition);
+	uint32 (*get_supported_operations)(partition_data* partition, uint32 mask);
 
 	bool (*validate_resize)(partition_data *partition, off_t *size);
 	bool (*validate_move)(partition_data *partition, off_t *start);

Modified: haiku/trunk/headers/os/storage/DiskDeviceDefs.h
===================================================================
--- haiku/trunk/headers/os/storage/DiskDeviceDefs.h	2007-08-22 20:29:40 UTC (rev 22042)
+++ haiku/trunk/headers/os/storage/DiskDeviceDefs.h	2007-08-22 21:21:30 UTC (rev 22043)
@@ -67,35 +67,37 @@
 
 // disk system flags
 enum {
-	B_DISK_SYSTEM_IS_FILE_SYSTEM								= 0x0001,
+	B_DISK_SYSTEM_IS_FILE_SYSTEM								= 0x000001,
 
 	// flags common for both file and partitioning systems
-	B_DISK_SYSTEM_SUPPORTS_CHECKING								= 0x0002,
-	B_DISK_SYSTEM_SUPPORTS_REPAIRING							= 0x0004,
-	B_DISK_SYSTEM_SUPPORTS_RESIZING								= 0x0008,
-	B_DISK_SYSTEM_SUPPORTS_MOVING								= 0x0010,
-	B_DISK_SYSTEM_SUPPORTS_SETTING_CONTENT_NAME					= 0x0020,
-	B_DISK_SYSTEM_SUPPORTS_SETTING_CONTENT_PARAMETERS			= 0x0040,
+	B_DISK_SYSTEM_SUPPORTS_CHECKING								= 0x000002,
+	B_DISK_SYSTEM_SUPPORTS_REPAIRING							= 0x000004,
+	B_DISK_SYSTEM_SUPPORTS_RESIZING								= 0x000008,
+	B_DISK_SYSTEM_SUPPORTS_MOVING								= 0x000010,
+	B_DISK_SYSTEM_SUPPORTS_SETTING_CONTENT_NAME					= 0x000020,
+	B_DISK_SYSTEM_SUPPORTS_SETTING_CONTENT_PARAMETERS			= 0x000040,
+	B_DISK_SYSTEM_SUPPORTS_INITIALIZING							= 0x000080,
+	B_DISK_SYSTEM_SUPPORTS_CONTENT_NAME							= 0x000100,
 
 	// file system specific flags
-	B_DISK_SYSTEM_SUPPORTS_DEFRAGMENTING						= 0x0100,
-	B_DISK_SYSTEM_SUPPORTS_DEFRAGMENTING_WHILE_MOUNTED			= 0x0200,
-	B_DISK_SYSTEM_SUPPORTS_CHECKING_WHILE_MOUNTED				= 0x0400,
-	B_DISK_SYSTEM_SUPPORTS_REPAIRING_WHILE_MOUNTED				= 0x0800,
-	B_DISK_SYSTEM_SUPPORTS_RESIZING_WHILE_MOUNTED				= 0x1000,
-	B_DISK_SYSTEM_SUPPORTS_MOVING_WHILE_MOUNTED					= 0x2000,
-	B_DISK_SYSTEM_SUPPORTS_SETTING_CONTENT_NAME_WHILE_MOUNTED	= 0x4000,
-	B_DISK_SYSTEM_SUPPORTS_SETTING_CONTENT_PARAMETERS_WHILE_MOUNTED	= 0x8000,
+	B_DISK_SYSTEM_SUPPORTS_DEFRAGMENTING						= 0x001000,
+	B_DISK_SYSTEM_SUPPORTS_DEFRAGMENTING_WHILE_MOUNTED			= 0x002000,
+	B_DISK_SYSTEM_SUPPORTS_CHECKING_WHILE_MOUNTED				= 0x004000,
+	B_DISK_SYSTEM_SUPPORTS_REPAIRING_WHILE_MOUNTED				= 0x008000,
+	B_DISK_SYSTEM_SUPPORTS_RESIZING_WHILE_MOUNTED				= 0x010000,
+	B_DISK_SYSTEM_SUPPORTS_MOVING_WHILE_MOUNTED					= 0x020000,
+	B_DISK_SYSTEM_SUPPORTS_SETTING_CONTENT_NAME_WHILE_MOUNTED	= 0x040000,
+	B_DISK_SYSTEM_SUPPORTS_SETTING_CONTENT_PARAMETERS_WHILE_MOUNTED	= 0x080000,
 
 	// partitioning system specific flags
-	B_DISK_SYSTEM_SUPPORTS_RESIZING_CHILD						= 0x0100,
-	B_DISK_SYSTEM_SUPPORTS_MOVING_CHILD							= 0x0200,
-	B_DISK_SYSTEM_SUPPORTS_SETTING_NAME							= 0x0400,
-	B_DISK_SYSTEM_SUPPORTS_SETTING_TYPE							= 0x0800,
-	B_DISK_SYSTEM_SUPPORTS_SETTING_PARAMETERS					= 0x1000,
-	B_DISK_SYSTEM_SUPPORTS_CREATING_CHILD						= 0x2000,
-	B_DISK_SYSTEM_SUPPORTS_DELETING_CHILD						= 0x4000,
-	B_DISK_SYSTEM_SUPPORTS_INITIALIZING							= 0x8000,
+	B_DISK_SYSTEM_SUPPORTS_RESIZING_CHILD						= 0x001000,
+	B_DISK_SYSTEM_SUPPORTS_MOVING_CHILD							= 0x002000,
+	B_DISK_SYSTEM_SUPPORTS_SETTING_NAME							= 0x004000,
+	B_DISK_SYSTEM_SUPPORTS_SETTING_TYPE							= 0x008000,
+	B_DISK_SYSTEM_SUPPORTS_SETTING_PARAMETERS					= 0x010000,
+	B_DISK_SYSTEM_SUPPORTS_CREATING_CHILD						= 0x020000,
+	B_DISK_SYSTEM_SUPPORTS_DELETING_CHILD						= 0x040000,
+	B_DISK_SYSTEM_SUPPORTS_NAME									= 0x080000,
 };
 
 // disk device job types

Modified: haiku/trunk/headers/private/fs_shell/fssh_api_wrapper.h
===================================================================
--- haiku/trunk/headers/private/fs_shell/fssh_api_wrapper.h	2007-08-22 20:29:40 UTC (rev 22042)
+++ haiku/trunk/headers/private/fs_shell/fssh_api_wrapper.h	2007-08-22 21:21:30 UTC (rev 22043)
@@ -229,6 +229,8 @@
 #define B_DISK_SYSTEM_SUPPORTS_MOVING						FSSH_B_DISK_SYSTEM_SUPPORTS_MOVING
 #define B_DISK_SYSTEM_SUPPORTS_SETTING_CONTENT_NAME			FSSH_B_DISK_SYSTEM_SUPPORTS_SETTING_CONTENT_NAME
 #define B_DISK_SYSTEM_SUPPORTS_SETTING_CONTENT_PARAMETERS	FSSH_B_DISK_SYSTEM_SUPPORTS_SETTING_CONTENT_PARAMETERS
+#define B_DISK_SYSTEM_SUPPORTS_INITIALIZING					FSSH_B_DISK_SYSTEM_SUPPORTS_INITIALIZING
+#define B_DISK_SYSTEM_SUPPORTS_CONTENT_NAME					FSSH_B_DISK_SYSTEM_SUPPORTS_CONTENT_NAME
 
 // file system specific flags
 #define B_DISK_SYSTEM_SUPPORTS_DEFRAGMENTING							FSSH_B_DISK_SYSTEM_SUPPORTS_DEFRAGMENTING
@@ -248,7 +250,7 @@
 #define B_DISK_SYSTEM_SUPPORTS_SETTING_PARAMETERS	FSSH_B_DISK_SYSTEM_SUPPORTS_SETTING_PARAMETERS
 #define B_DISK_SYSTEM_SUPPORTS_CREATING_CHILD		FSSH_B_DISK_SYSTEM_SUPPORTS_CREATING_CHILD
 #define B_DISK_SYSTEM_SUPPORTS_DELETING_CHILD		FSSH_B_DISK_SYSTEM_SUPPORTS_DELETING_CHILD
-#define B_DISK_SYSTEM_SUPPORTS_INITIALIZING			FSSH_B_DISK_SYSTEM_SUPPORTS_INITIALIZING
+#define B_DISK_SYSTEM_SUPPORTS_NAME					FSSH_B_DISK_SYSTEM_SUPPORTS_NAME
 
 // disk device job types
 #define B_DISK_DEVICE_JOB_BAD_TYPE				FSSH_B_DISK_DEVICE_JOB_BAD_TYPE

Modified: haiku/trunk/headers/private/fs_shell/fssh_disk_device_defs.h
===================================================================
--- haiku/trunk/headers/private/fs_shell/fssh_disk_device_defs.h	2007-08-22 20:29:40 UTC (rev 22042)
+++ haiku/trunk/headers/private/fs_shell/fssh_disk_device_defs.h	2007-08-22 21:21:30 UTC (rev 22043)
@@ -67,35 +67,37 @@
 
 // disk system flags
 enum {
-	FSSH_B_DISK_SYSTEM_IS_FILE_SYSTEM							= 0x0001,
+	FSSH_B_DISK_SYSTEM_IS_FILE_SYSTEM								= 0x000001,
 
 	// flags common for both file and partitioning systems
-	FSSH_B_DISK_SYSTEM_SUPPORTS_CHECKING							= 0x0002,
-	FSSH_B_DISK_SYSTEM_SUPPORTS_REPAIRING							= 0x0004,
-	FSSH_B_DISK_SYSTEM_SUPPORTS_RESIZING							= 0x0008,
-	FSSH_B_DISK_SYSTEM_SUPPORTS_MOVING								= 0x0010,
-	FSSH_B_DISK_SYSTEM_SUPPORTS_SETTING_CONTENT_NAME				= 0x0020,
-	FSSH_B_DISK_SYSTEM_SUPPORTS_SETTING_CONTENT_PARAMETERS			= 0x0040,
+	FSSH_B_DISK_SYSTEM_SUPPORTS_CHECKING							= 0x000002,
+	FSSH_B_DISK_SYSTEM_SUPPORTS_REPAIRING							= 0x000004,
+	FSSH_B_DISK_SYSTEM_SUPPORTS_RESIZING							= 0x000008,
+	FSSH_B_DISK_SYSTEM_SUPPORTS_MOVING								= 0x000010,
+	FSSH_B_DISK_SYSTEM_SUPPORTS_SETTING_CONTENT_NAME				= 0x000020,
+	FSSH_B_DISK_SYSTEM_SUPPORTS_SETTING_CONTENT_PARAMETERS			= 0x000040,
+	FSSH_B_DISK_SYSTEM_SUPPORTS_INITIALIZING						= 0x000080,
+	FSSH_B_DISK_SYSTEM_SUPPORTS_CONTENT_NAME						= 0x000100,
 
 	// file system specific flags
-	FSSH_B_DISK_SYSTEM_SUPPORTS_DEFRAGMENTING						= 0x0100,
-	FSSH_B_DISK_SYSTEM_SUPPORTS_DEFRAGMENTING_WHILE_MOUNTED			= 0x0200,
-	FSSH_B_DISK_SYSTEM_SUPPORTS_CHECKING_WHILE_MOUNTED				= 0x0400,
-	FSSH_B_DISK_SYSTEM_SUPPORTS_REPAIRING_WHILE_MOUNTED				= 0x0800,
-	FSSH_B_DISK_SYSTEM_SUPPORTS_RESIZING_WHILE_MOUNTED				= 0x1000,
-	FSSH_B_DISK_SYSTEM_SUPPORTS_MOVING_WHILE_MOUNTED				= 0x2000,
-	FSSH_B_DISK_SYSTEM_SUPPORTS_SETTING_CONTENT_NAME_WHILE_MOUNTED	= 0x4000,
-	FSSH_B_DISK_SYSTEM_SUPPORTS_SETTING_CONTENT_PARAMETERS_WHILE_MOUNTED	= 0x8000,
+	FSSH_B_DISK_SYSTEM_SUPPORTS_DEFRAGMENTING						= 0x001000,
+	FSSH_B_DISK_SYSTEM_SUPPORTS_DEFRAGMENTING_WHILE_MOUNTED			= 0x002000,
+	FSSH_B_DISK_SYSTEM_SUPPORTS_CHECKING_WHILE_MOUNTED				= 0x004000,
+	FSSH_B_DISK_SYSTEM_SUPPORTS_REPAIRING_WHILE_MOUNTED				= 0x008000,
+	FSSH_B_DISK_SYSTEM_SUPPORTS_RESIZING_WHILE_MOUNTED				= 0x010000,
+	FSSH_B_DISK_SYSTEM_SUPPORTS_MOVING_WHILE_MOUNTED				= 0x020000,
+	FSSH_B_DISK_SYSTEM_SUPPORTS_SETTING_CONTENT_NAME_WHILE_MOUNTED	= 0x040000,
+	FSSH_B_DISK_SYSTEM_SUPPORTS_SETTING_CONTENT_PARAMETERS_WHILE_MOUNTED	= 0x080000,
 
 	// partitioning system specific flags
-	FSSH_B_DISK_SYSTEM_SUPPORTS_RESIZING_CHILD						= 0x0100,
-	FSSH_B_DISK_SYSTEM_SUPPORTS_MOVING_CHILD						= 0x0200,
-	FSSH_B_DISK_SYSTEM_SUPPORTS_SETTING_NAME						= 0x0400,
-	FSSH_B_DISK_SYSTEM_SUPPORTS_SETTING_TYPE						= 0x0800,
-	FSSH_B_DISK_SYSTEM_SUPPORTS_SETTING_PARAMETERS					= 0x1000,
-	FSSH_B_DISK_SYSTEM_SUPPORTS_CREATING_CHILD						= 0x2000,
-	FSSH_B_DISK_SYSTEM_SUPPORTS_DELETING_CHILD						= 0x4000,
-	FSSH_B_DISK_SYSTEM_SUPPORTS_INITIALIZING						= 0x8000,
+	FSSH_B_DISK_SYSTEM_SUPPORTS_RESIZING_CHILD						= 0x001000,
+	FSSH_B_DISK_SYSTEM_SUPPORTS_MOVING_CHILD						= 0x002000,
+	FSSH_B_DISK_SYSTEM_SUPPORTS_SETTING_NAME						= 0x004000,
+	FSSH_B_DISK_SYSTEM_SUPPORTS_SETTING_TYPE						= 0x008000,
+	FSSH_B_DISK_SYSTEM_SUPPORTS_SETTING_PARAMETERS					= 0x010000,
+	FSSH_B_DISK_SYSTEM_SUPPORTS_CREATING_CHILD						= 0x020000,
+	FSSH_B_DISK_SYSTEM_SUPPORTS_DELETING_CHILD						= 0x040000,
+	FSSH_B_DISK_SYSTEM_SUPPORTS_NAME								= 0x080000,
 };
 
 // disk device job types

Modified: haiku/trunk/headers/private/fs_shell/fssh_fs_interface.h
===================================================================
--- haiku/trunk/headers/private/fs_shell/fssh_fs_interface.h	2007-08-22 20:29:40 UTC (rev 22042)
+++ haiku/trunk/headers/private/fs_shell/fssh_fs_interface.h	2007-08-22 21:21:30 UTC (rev 22043)
@@ -54,7 +54,8 @@
 
 typedef struct fssh_file_system_module_info {
 	struct fssh_module_info	info;
-	const char				*pretty_name;
+	const char*				pretty_name;
+	uint32_t				flags;	// DDM flags
 
 	/* scanning (the device is write locked) */
 	float (*identify_partition)(int fd, fssh_partition_data *partition,
@@ -239,19 +240,8 @@
 	fssh_status_t (*rewind_query)(fssh_fs_volume fs, fssh_fs_cookie cookie);
 
 	/* capability querying (the device is read locked) */
-	// ToDo: this will probably be combined to a single call
-	bool (*supports_defragmenting)(fssh_partition_data *partition,
-				bool *whileMounted);
-	bool (*supports_repairing)(fssh_partition_data *partition,
-				bool checkOnly, bool *whileMounted);
-	bool (*supports_resizing)(fssh_partition_data *partition,
-				bool *whileMounted);
-	bool (*supports_moving)(fssh_partition_data *partition, bool *isNoOp);
-	bool (*supports_setting_content_name)(fssh_partition_data *partition,
-				bool *whileMounted);
-	bool (*supports_setting_content_parameters)(fssh_partition_data *partition, 
-				bool *whileMounted);
-	bool (*supports_initializing)(fssh_partition_data *partition);
+	uint32_t (*get_supported_operations)(fssh_partition_data* partition,
+				uint32_t mask);
 
 	bool (*validate_resize)(fssh_partition_data *partition, fssh_off_t *size);
 	bool (*validate_move)(fssh_partition_data *partition, fssh_off_t *start);

Modified: haiku/trunk/headers/private/kernel/disk_device_manager/KDiskSystem.h
===================================================================
--- haiku/trunk/headers/private/kernel/disk_device_manager/KDiskSystem.h	2007-08-22 20:29:40 UTC (rev 22042)
+++ haiku/trunk/headers/private/kernel/disk_device_manager/KDiskSystem.h	2007-08-22 21:21:30 UTC (rev 22043)
@@ -54,26 +54,19 @@
 	// Querying
 	// Device must be read locked.
 
-	virtual bool SupportsDefragmenting(KPartition *partition,
-									   bool *whileMounted);
-	virtual bool SupportsRepairing(KPartition *partition, bool checkOnly,
-								   bool *whileMounted);
-	virtual bool SupportsResizing(KPartition *partition, bool *whileMounted);
-	virtual bool SupportsResizingChild(KPartition *child);
-	virtual bool SupportsMoving(KPartition *partition, bool *isNoOp);
-	virtual bool SupportsMovingChild(KPartition *child);
-	virtual bool SupportsSettingName(KPartition *partition);
-	virtual bool SupportsSettingContentName(KPartition *partition,
-											bool *whileMounted);
-	virtual bool SupportsSettingType(KPartition *partition);
-	virtual bool SupportsSettingParameters(KPartition *partition);
-	virtual bool SupportsSettingContentParameters(KPartition *partition,
-												  bool *whileMounted);
-	virtual bool SupportsInitializing(KPartition *partition);
+	virtual uint32 GetSupportedOperations(KPartition* partition, uint32 mask);
+	virtual uint32 GetSupportedChildOperations(KPartition* child, uint32 mask);
+
+	// for convenience
+	bool SupportsOperations(KPartition* partition, uint32 operations)
+		{ return (GetSupportedOperations(partition, operations) &amp; operations)
+			== operations; }
+	bool SupportsChildOperations(KPartition* child, uint32 operations)
+		{ return (GetSupportedChildOperations(child, operations) &amp; operations)
+			== operations; }
+
 	virtual bool SupportsInitializingChild(KPartition *child,
-										   const char *diskSystem);
-	virtual bool SupportsCreatingChild(KPartition *partition);
-	virtual bool SupportsDeletingChild(KPartition *child);
+		const char *diskSystem);
 	virtual bool IsSubSystemFor(KPartition *partition);
 
 	virtual bool ValidateResize(KPartition *partition, off_t *size);

Modified: haiku/trunk/headers/private/kernel/disk_device_manager/KFileSystem.h
===================================================================
--- haiku/trunk/headers/private/kernel/disk_device_manager/KFileSystem.h	2007-08-22 20:29:40 UTC (rev 22042)
+++ haiku/trunk/headers/private/kernel/disk_device_manager/KFileSystem.h	2007-08-22 21:21:30 UTC (rev 22043)
@@ -35,17 +35,7 @@
 
 	// Querying
 
-	virtual bool SupportsDefragmenting(KPartition *partition,
-									   bool *whileMounted);
-	virtual bool SupportsRepairing(KPartition *partition, bool checkOnly,
-								   bool *whileMounted);
-	virtual bool SupportsResizing(KPartition *partition, bool *whileMounted);
-	virtual bool SupportsMoving(KPartition *partition, bool *isNoOp);
-	virtual bool SupportsSettingContentName(KPartition *partition,
-											bool *whileMounted);
-	virtual bool SupportsSettingContentParameters(KPartition *partition,
-												  bool *whileMounted);
-	virtual bool SupportsInitializing(KPartition *partition);
+	virtual uint32 GetSupportedOperations(KPartition* partition, uint32 mask);
 
 	virtual bool ValidateResize(KPartition *partition, off_t *size);
 	virtual bool ValidateMove(KPartition *partition, off_t *start);

Modified: haiku/trunk/headers/private/kernel/disk_device_manager/KPartitioningSystem.h
===================================================================
--- haiku/trunk/headers/private/kernel/disk_device_manager/KPartitioningSystem.h	2007-08-22 20:29:40 UTC (rev 22042)
+++ haiku/trunk/headers/private/kernel/disk_device_manager/KPartitioningSystem.h	2007-08-22 21:21:30 UTC (rev 22043)
@@ -29,9 +29,7 @@
 
 	// Scanning
 
-	//! Try to identify a given partition
 	virtual float Identify(KPartition *partition, void **cookie);
-	//! Scan the partition
 	virtual status_t Scan(KPartition *partition, void *cookie);
 	virtual void FreeIdentifyCookie(KPartition *partition, void *cookie);
 	virtual void FreeCookie(KPartition *partition);
@@ -39,132 +37,75 @@
 
 	// Querying
 
-	//! Check whether the add-on supports repairing this partition.
-	virtual bool SupportsRepairing(KPartition *partition, bool checkOnly,
-								   bool *whileMounted);
-	//! Check whether the add-on supports resizing this partition.
-	virtual bool SupportsResizing(KPartition *partition, bool *whileMounted);
-	//! Check whether the add-on supports resizing children of this partition.
-	virtual bool SupportsResizingChild(KPartition *child);
-	//! Check whether the add-on supports moving this partition.
-	virtual bool SupportsMoving(KPartition *partition, bool *isNoOp);
-	//! Check whether the add-on supports moving children of this partition.
-	virtual bool SupportsMovingChild(KPartition *child);
-	//! Check whether the add-on supports setting name of this partition.
-	virtual bool SupportsSettingName(KPartition *partition);
-	//! Check whether the add-on supports setting name to content of this partition.
-	virtual bool SupportsSettingContentName(KPartition *partition,
-											bool *whileMounted);
-	//! Check whether the add-on supports setting type of this partition.
-	virtual bool SupportsSettingType(KPartition *partition);
-	//! Check whether the add-on supports setting parameters of this partition.
-	virtual bool SupportsSettingParameters(KPartition *partition);
-	//! Check whether the add-on supports setting parameters to content of this partition.
-	virtual bool SupportsSettingContentParameters(KPartition *partition,
-												  bool *whileMounted);
-	//! Check whether the add-on supports initializing this partition.
-	virtual bool SupportsInitializing(KPartition *partition);
-	//! Check whether the add-on supports initializing a child of this partition.
+	virtual uint32 GetSupportedOperations(KPartition* partition, uint32 mask);
+	virtual uint32 GetSupportedChildOperations(KPartition* child, uint32 mask);
+
 	virtual bool SupportsInitializingChild(KPartition *child,
-										   const char *diskSystem);
-	//! Check whether the add-on supports creating children of this partition.
-	virtual bool SupportsCreatingChild(KPartition *partition);
-	//! Check whether the add-on supports deleting children of this partition.
-	virtual bool SupportsDeletingChild(KPartition *child);
-	//! Check whether the add-on is a subsystem for a given partition.
+		const char *diskSystem);
 	virtual bool IsSubSystemFor(KPartition *partition);
 
-	//! Validates parameters for resizing a partition
 	virtual bool ValidateResize(KPartition *partition, off_t *size);
-	//! Validates parameters for resizing a child partition
 	virtual bool ValidateResizeChild(KPartition *child, off_t *size);
-	//! Validates parameters for moving a partition
 	virtual bool ValidateMove(KPartition *partition, off_t *start);
-	//! Validates parameters for moving a child partition
 	virtual bool ValidateMoveChild(KPartition *child, off_t *start);
-	//! Validates parameters for setting name of a partition
 	virtual bool ValidateSetName(KPartition *partition, char *name);
-	//! Validates parameters for setting name to content of a partition
 	virtual bool ValidateSetContentName(KPartition *partition, char *name);
-	//! Validates parameters for setting type of a partition
 	virtual bool ValidateSetType(KPartition *partition, const char *type);
-	//! Validates parameters for setting parameters of a partition
 	virtual bool ValidateSetParameters(KPartition *partition,
 									   const char *parameters);
-	//! Validates parameters for setting parameters to content of a partition
 	virtual bool ValidateSetContentParameters(KPartition *parameters,
 											  const char *parameters);
-	//! Validates parameters for initializing a partition
 	virtual bool ValidateInitialize(KPartition *partition, char *name,
 									const char *parameters);
-	//! Validates parameters for creating child of a partition
 	virtual bool ValidateCreateChild(KPartition *partition, off_t *start,
 									 off_t *size, const char *type,
 									 const char *parameters, int32 *index);
-	//! Counts partitionable spaces on a partition
 	virtual int32 CountPartitionableSpaces(KPartition *partition);
-	//! Retrieves a list of partitionable spaces on a partition
 	virtual status_t GetPartitionableSpaces(KPartition *partition,
 											partitionable_space_data *buffer,
 											int32 count,
 											int32 *actualCount = NULL);
 
-	//! Iterates through supported partition types
 	virtual status_t GetNextSupportedType(KPartition *partition, int32 *cookie,
 										  char *type);
-	//! Translates the &quot;pretty&quot; content type to an internal type
 	virtual status_t GetTypeForContentType(const char *contentType,
 										   char *type);
 
 	// Shadow partition modification
 
-	//! Calls for additional modifications when shadow partition is changed
 	virtual status_t ShadowPartitionChanged(KPartition *partition,
 											uint32 operation);
 
 	// Writing
 
-	//! Repairs a partition
 	virtual status_t Repair(KPartition *partition, bool checkOnly,
 							KDiskDeviceJob *job);
-	//! Resizes a partition
 	virtual status_t Resize(KPartition *partition, off_t size,
 							KDiskDeviceJob *job);
-	//! Resizes child of a partition
 	virtual status_t ResizeChild(KPartition *child, off_t size,
 								 KDiskDeviceJob *job);
-	//! Moves a partition
 	virtual status_t Move(KPartition *partition, off_t offset,
 						  KDiskDeviceJob *job);
-	//! Moves child of a partition
 	virtual status_t MoveChild(KPartition *child, off_t offset,
 							   KDiskDeviceJob *job);
-	//! Sets name of a partition
 	virtual status_t SetName(KPartition *partition, char *name,
 							 KDiskDeviceJob *job);
-	//! Sets name of the content of a partition
 	virtual status_t SetContentName(KPartition *partition, char *name,
 									KDiskDeviceJob *job);
-	//! Sets type of a partition
 	virtual status_t SetType(KPartition *partition, char *type,
 							 KDiskDeviceJob *job);
-	//! Sets parameters of a partition
 	virtual status_t SetParameters(KPartition *partition,
 								   const char *parameters,
 								   KDiskDeviceJob *job);
-	//! Sets parameters to content of a partition
 	virtual status_t SetContentParameters(KPartition *partition,
 										  const char *parameters,
 										  KDiskDeviceJob *job);
-	//! Creates a child partition
 	virtual status_t CreateChild(KPartition *partition, off_t offset,
 								 off_t size, const char *type,
 								 const char *parameters, KDiskDeviceJob *job,
 								 KPartition **child = NULL,
 								 partition_id childID = -1);
-	//! Deletes a child partition
 	virtual status_t DeleteChild(KPartition *child, KDiskDeviceJob *job);
-	//! Initializes a partition with this partitioning system
 	virtual status_t Initialize(KPartition *partition, const char *name,
 								const char *parameters, KDiskDeviceJob *job);
 

Modified: haiku/trunk/headers/private/kernel/disk_device_manager/ddm_modules.h
===================================================================
--- haiku/trunk/headers/private/kernel/disk_device_manager/ddm_modules.h	2007-08-22 20:29:40 UTC (rev 22042)
+++ haiku/trunk/headers/private/kernel/disk_device_manager/ddm_modules.h	2007-08-22 21:21:30 UTC (rev 22043)
@@ -1,6 +1,6 @@
 // ddm_modules.h
 //
-// Interface to be implemented by partition modules.
+// Interface to be implemented by partitioning modules.
 
 #ifndef _K_DISK_DEVICE_MODULES_H
 #define _K_DISK_DEVICE_MODULES_H
@@ -9,180 +9,99 @@
 #include &lt;module.h&gt;
 #include &lt;SupportDefs.h&gt;
 
-// partition module interface
 
-// scanning
-// (the device is write locked)
-typedef float (*partition_identify_partition)(int fd,
-	partition_data *partition, void **cookie);
-typedef status_t (*partition_scan_partition)(int fd,
-	partition_data *partition, void *identifyCookie);
-typedef void (*partition_free_identify_partition_cookie)(
-	partition_data *partition, void *cookie);
-typedef void (*partition_free_partition_cookie)(partition_data *partition);
-typedef void (*partition_free_partition_content_cookie)(
-	partition_data *partition);
-
-// querying
-// (the device is read locked)
-typedef bool (*partition_supports_repairing)(partition_data *partition,
-	bool checkOnly);
-typedef bool (*partition_supports_resizing)(partition_data *partition);
-typedef bool (*partition_supports_resizing_child)(partition_data *partition,
-	partition_data *child);
-typedef bool (*partition_supports_moving)(partition_data *partition,
-	bool *isNoOp);
-typedef bool (*partition_supports_moving_child)(partition_data *partition,
-	partition_data *child);
-typedef bool (*partition_supports_setting_name)(partition_data *partition);
-typedef bool (*partition_supports_setting_content_name)(
-	partition_data *partition);
-typedef bool (*partition_supports_setting_type)(partition_data *partition);
-typedef bool (*partition_supports_setting_parameters)(
-	partition_data *partition);
-typedef bool (*partition_supports_setting_content_parameters)(
-	partition_data *partition);
-typedef bool (*partition_supports_initializing)(partition_data *partition);
-typedef bool (*partition_supports_initializing_child)(
-	partition_data *partition, const char *system);
-typedef bool (*partition_supports_creating_child)(partition_data *partition);
-typedef bool (*partition_supports_deleting_child)(partition_data *partition,
-	partition_data *child);
-typedef bool (*partition_is_sub_system_for)(partition_data *partition);
-
-typedef bool (*partition_validate_resize)(partition_data *partition,
-	off_t *size);
-typedef bool (*partition_validate_resize_child)(partition_data *partition,
-	partition_data *child, off_t *size);
-typedef bool (*partition_validate_move)(partition_data *partition,
-	off_t *start);
-typedef bool (*partition_validate_move_child)(partition_data *partition,
-	partition_data *child, off_t *start);
-typedef bool (*partition_validate_set_name)(partition_data *partition,
-											char *name);
-typedef bool (*partition_validate_set_content_name)(partition_data *partition,
-													char *name);
-typedef bool (*partition_validate_set_type)(partition_data *partition,
-											const char *type);
-typedef bool (*partition_validate_set_parameters)(partition_data *partition,
-	const char *parameters);
-typedef bool (*partition_validate_set_content_parameters)(
-	partition_data *partition, const char *parameters);
-typedef bool (*partition_validate_initialize)(partition_data *partition,
-	char *name, const char *parameters);
-typedef bool (*partition_validate_create_child)(partition_data *partition,
-	off_t *start, off_t *size, const char *type, const char *parameters,
-	int32 *index);
-typedef status_t (*partition_get_partitionable_spaces)(
-	partition_data *partition, partitionable_space_data *buffer, int32 count,
-	int32 *actualCount);
-	// When not implemented, a standard algorithm is used.
-
-typedef status_t (*partition_get_next_supported_type)(
-	partition_data *partition, int32 *cookie, char *type);
-typedef status_t (*partition_get_type_for_content_type)(
-	const char *contentType, char *type);
-
-// shadow partition modification
-// (device is write locked)
-typedef status_t (*partition_shadow_changed)(partition_data *partition,
-	uint32 operation);
-
-// writing
-// (device is NOT locked)
-typedef status_t (*partition_repair)(int fd, partition_id partition,
-	bool checkOnly, disk_job_id job);
-typedef status_t (*partition_resize)(int fd, partition_id partition,
-	off_t size, disk_job_id job);
-typedef status_t (*partition_resize_child)(int fd, partition_id partition,
-	off_t size, disk_job_id job);
-typedef status_t (*partition_move)(int fd, partition_id partition,
-	off_t offset, disk_job_id job);
-typedef status_t (*partition_move_child)(int fd, partition_id partition,
-	partition_id child, off_t offset, disk_job_id job);
-typedef status_t (*partition_set_name)(int fd, partition_id partition,
-	const char *name, disk_job_id job);
-typedef status_t (*partition_set_content_name)(int fd, partition_id partition,
-	const char *name, disk_job_id job);
-typedef status_t (*partition_set_type)(int fd, partition_id partition,
-	const char *type, disk_job_id job);
-typedef status_t (*partition_set_parameters)(int fd, partition_id partition,
-	const char *parameters, disk_job_id job);
-typedef status_t (*partition_set_content_parameters)(int fd,
-	partition_id partition, const char *parameters, disk_job_id job);
-typedef status_t (*partition_initialize)(int fd, partition_id partition,
-	const char *name, const char *parameters, disk_job_id job);
-typedef status_t (*partition_create_child)(int fd, partition_id partition,
-	off_t offset, off_t size, const char *type, const char *parameters,
-	disk_job_id job, partition_id *childID);
-	// childID is used for the return value, but is also an optional input
-	// parameter -- -1 to be ignored
-typedef status_t (*partition_delete_child)(int fd, partition_id partition,
-	partition_id child, disk_job_id job);
-
 typedef struct partition_module_info {
 	module_info									module;
-	const char									*pretty_name;
+	const char*									pretty_name;
 	uint32										flags;
 
 	// scanning
-	partition_identify_partition				identify_partition;
-	partition_scan_partition					scan_partition;
-	partition_free_identify_partition_cookie	free_identify_partition_cookie;
-	partition_free_partition_cookie				free_partition_cookie;
-	partition_free_partition_content_cookie		free_partition_content_cookie;
+	// (the device is write locked)
+	float (*identify_partition)(int fd, partition_data* partition,
+				void** cookie);
+	status_t (*scan_partition)(int fd, partition_data* partition,
+				void* identifyCookie);
+	void (*free_identify_partition_cookie)(partition_data* partition,
+				void* cookie);
+	void (*free_partition_cookie)(partition_data* partition);
+	void (*free_partition_content_cookie)(partition_data* partition);
 
+
 	// querying
-	partition_supports_repairing				supports_repairing;
-	partition_supports_resizing					supports_resizing;
-	partition_supports_resizing_child			supports_resizing_child;
-	partition_supports_moving					supports_moving;
-	partition_supports_moving_child				supports_moving_child;
-	partition_supports_setting_name				supports_setting_name;
-	partition_supports_setting_content_name		supports_setting_content_name;
-	partition_supports_setting_type				supports_setting_type;
-	partition_supports_setting_parameters		supports_setting_parameters;
-	partition_supports_setting_content_parameters
-			supports_setting_content_parameters;
-	partition_supports_initializing				supports_initializing;
-	partition_supports_initializing_child		supports_initializing_child;
-	partition_supports_creating_child			supports_creating_child;
-	partition_supports_deleting_child			supports_deleting_child;
-	partition_is_sub_system_for					is_sub_system_for;
+	// (the device is read locked)
+	uint32 (*get_supported_operations)(partition_data* partition, uint32 mask);
+	uint32 (*get_supported_child_operations)(partition_data* partition,
+				partition_data* child, uint32 mask);
 
-	partition_validate_resize					validate_resize;
-	partition_validate_resize_child				validate_resize_child;
-	partition_validate_move						validate_move;
-	partition_validate_move_child				validate_move_child;
-	partition_validate_set_name					validate_set_name;
-	partition_validate_set_content_name			validate_set_content_name;
-	partition_validate_set_type					validate_set_type;
-	partition_validate_set_parameters			validate_set_parameters;
-	partition_validate_set_content_parameters
-			validate_set_content_parameters;
-	partition_validate_initialize				validate_initialize;
-	partition_validate_create_child				validate_create_child;
-	partition_get_partitionable_spaces			get_partitionable_spaces;
-	partition_get_next_supported_type			get_next_supported_type;
-	partition_get_type_for_content_type			get_type_for_content_type;
+	bool (*supports_initializing_child)(partition_data* partition,
+				const char* system);
+	bool (*is_sub_system_for)(partition_data* partition);
 
+	bool (*validate_resize)(partition_data* partition, off_t* size);
+	bool (*validate_resize_child)(partition_data* partition,
+				partition_data* child, off_t* size);
+	bool (*validate_move)(partition_data* partition, off_t* start);
+	bool (*validate_move_child)(partition_data* partition,
+				partition_data* child, off_t* start);
+	bool (*validate_set_name)(partition_data* partition, char* name);
+	bool (*validate_set_content_name)(partition_data* partition, char* name);
+	bool (*validate_set_type)(partition_data* partition, const char* type);
+	bool (*validate_set_parameters)(partition_data* partition,
+				const char* parameters);
+
+	bool (*validate_set_content_parameters)(partition_data* partition,
+				const char* parameters);
+	bool (*validate_initialize)(partition_data* partition, char* name,
+				const char* parameters);
+	bool (*validate_create_child)(partition_data* partition, off_t* start,
+				off_t* size, const char* type, const char* parameters,
+				int32* index);
+	status_t (*get_partitionable_spaces)(partition_data* partition,
+				partitionable_space_data* buffer, int32 count,
+				int32* actualCount);
+		// When not implemented, a standard algorithm is used.
+
+	status_t (*get_next_supported_type)(partition_data* partition,
+				int32* cookie, char* type);
+	status_t (*get_type_for_content_type)(const char* contentType, char* type);
+
+
 	// shadow partition modification
-	partition_shadow_changed					shadow_changed;
+	// (device is write locked)
+	status_t (*shadow_changed)(partition_data* partition, uint32 operation);
 
+
 	// writing
-	partition_repair							repair;
-	partition_resize							resize;
-	partition_resize_child						resize_child;
-	partition_move								move;
-	partition_move_child						move_child;
-	partition_set_name							set_name;
-	partition_set_content_name					set_content_name;
-	partition_set_type							set_type;
-	partition_set_parameters					set_parameters;
-	partition_set_content_parameters			set_content_parameters;
-	partition_initialize						initialize;
-	partition_create_child						create_child;
-	partition_delete_child						delete_child;
+	// (device is NOT locked)
+	status_t (*repair)(int fd, partition_id partition, bool checkOnly,
+				disk_job_id job);
+	status_t (*resize)(int fd, partition_id partition, off_t size,
+				disk_job_id job);
+	status_t (*resize_child)(int fd, partition_id partition, off_t size,
+				disk_job_id job);
+	status_t (*move)(int fd, partition_id partition, off_t offset,
+				disk_job_id job);
+	status_t (*move_child)(int fd, partition_id partition, partition_id child,
+				off_t offset, disk_job_id job);
+	status_t (*set_name)(int fd, partition_id partition, const char* name,
+				disk_job_id job);
+	status_t (*set_content_name)(int fd, partition_id partition,
+				const char* name, disk_job_id job);
+	status_t (*set_type)(int fd, partition_id partition, const char* type,
+				disk_job_id job);
+	status_t (*set_parameters)(int fd, partition_id partition,
+				const char* parameters, disk_job_id job);
+	status_t (*set_content_parameters)(int fd, partition_id partition,
+				const char* parameters, disk_job_id job);
+	status_t (*initialize)(int fd, partition_id partition, const char* name,
+				const char *parameters, disk_job_id job);
+	status_t (*create_child)(int fd, partition_id partition, off_t offset,
+				off_t size, const char* type, const char* parameters,
+				disk_job_id job, partition_id* childID);
+		// childID is used for the return value, but is also an optional input
+		// parameter -- -1 to be ignored
+	status_t (*delete_child)(int fd, partition_id partition, partition_id child,
+				disk_job_id job);
 } partition_module_info;
 
 #endif	// _K_DISK_DEVICE_MODULES_H

Modified: haiku/trunk/src/add-ons/kernel/file_systems/bfs/kernel_interface.cpp
===================================================================
--- haiku/trunk/src/add-ons/kernel/file_systems/bfs/kernel_interface.cpp	2007-08-22 20:29:40 UTC (rev 22042)
+++ haiku/trunk/src/add-ons/kernel/file_systems/bfs/kernel_interface.cpp	2007-08-22 21:21:30 UTC (rev 22043)
@@ -2020,15 +2020,16 @@
 //	#pragma mark -
 
 
-bool
-bfs_supports_initializing(partition_data *partition)
+static uint32
+bfs_get_supported_operations(partition_data* partition, uint32 mask)
 {
 	// TODO: We should at least check the partition size.
-	return true;
+	return B_DISK_SYSTEM_SUPPORTS_INITIALIZING
+		| B_DISK_SYSTEM_SUPPORTS_CONTENT_NAME;
 }
 
 
-bool
+static bool
 bfs_validate_initialize(partition_data *partition, char *name,
 	const char *parameters)
 {
@@ -2037,7 +2038,7 @@
 }
 
 
-status_t
+static status_t
 bfs_initialize(int fd, partition_id partition, const char *name,
 	const char *parameters, disk_job_id job)
 {
@@ -2125,6 +2126,26 @@
 
 	&quot;Be File System&quot;,
 
+	// DDM flags
+	0
+//	| B_DISK_SYSTEM_SUPPORTS_CHECKING
+//	| B_DISK_SYSTEM_SUPPORTS_REPAIRING
+//	| B_DISK_SYSTEM_SUPPORTS_RESIZING
+//	| B_DISK_SYSTEM_SUPPORTS_MOVING
+//	| B_DISK_SYSTEM_SUPPORTS_SETTING_CONTENT_NAME
+//	| B_DISK_SYSTEM_SUPPORTS_SETTING_CONTENT_PARAMETERS
+	| B_DISK_SYSTEM_SUPPORTS_INITIALIZING
+	| B_DISK_SYSTEM_SUPPORTS_CONTENT_NAME
+//	| B_DISK_SYSTEM_SUPPORTS_DEFRAGMENTING
+//	| B_DISK_SYSTEM_SUPPORTS_DEFRAGMENTING_WHILE_MOUNTED
+//	| B_DISK_SYSTEM_SUPPORTS_CHECKING_WHILE_MOUNTED
+//	| B_DISK_SYSTEM_SUPPORTS_REPAIRING_WHILE_MOUNTED
+//	| B_DISK_SYSTEM_SUPPORTS_RESIZING_WHILE_MOUNTED
+//	| B_DISK_SYSTEM_SUPPORTS_MOVING_WHILE_MOUNTED
+//	| B_DISK_SYSTEM_SUPPORTS_SETTING_CONTENT_NAME_WHILE_MOUNTED
+//	| B_DISK_SYSTEM_SUPPORTS_SETTING_CONTENT_PARAMETERS_WHILE_MOUNTED
+	,
+
 	// scanning
 	bfs_identify_partition,
 	bfs_scan_partition,
@@ -2224,13 +2245,7 @@
 	&amp;bfs_rewind_query,
 
 	/* capability querying operations */
-	NULL,	// supports_defragmenting
-	NULL,	// supports_repairing
-	NULL,	// supports_resizing
-	NULL,	// supports_moving
-	NULL,	// supports_setting_content_name
-	NULL,	// supports_setting_content_parameters
-	&amp;bfs_supports_initializing,
+	&amp;bfs_get_supported_operations,
 
 	NULL,	// validate_resize
 	NULL,	// validate_move

Modified: haiku/trunk/src/add-ons/kernel/file_systems/cdda/kernel_interface.cpp
===================================================================
--- haiku/trunk/src/add-ons/kernel/file_systems/cdda/kernel_interface.cpp	2007-08-22 20:29:40 UTC (rev 22042)
+++ haiku/trunk/src/add-ons/kernel/file_systems/cdda/kernel_interface.cpp	2007-08-22 21:21:30 UTC (rev 22043)
@@ -2007,6 +2007,7 @@
 	},
 
 	&quot;CDDA File System&quot;,
+	0,	// DDM flags
 
 	cdda_identify_partition,
 	cdda_scan_partition,

Modified: haiku/trunk/src/add-ons/kernel/file_systems/dos/dosfs.c
===================================================================
--- haiku/trunk/src/add-ons/kernel/file_systems/dos/dosfs.c	2007-08-22 20:29:40 UTC (rev 22042)
+++ haiku/trunk/src/add-ons/kernel/file_systems/dos/dosfs.c	2007-08-22 21:21:30 UTC (rev 22043)
@@ -1192,6 +1192,7 @@
 	},
 
 	&quot;FAT32 File System&quot;,
+	0,	// DDM flags
 
 	// scanning
 	dosfs_identify_partition,

Modified: haiku/trunk/src/add-ons/kernel/file_systems/googlefs/googlefs.c
===================================================================
--- haiku/trunk/src/add-ons/kernel/file_systems/googlefs/googlefs.c	2007-08-22 20:29:40 UTC (rev 22042)
+++ haiku/trunk/src/add-ons/kernel/file_systems/googlefs/googlefs.c	2007-08-22 21:21:30 UTC (rev 22043)
@@ -1620,6 +1620,7 @@
 	},
 
 	GOOGLEFS_PRETTY_NAME,
+	0,	// DDM flags
 
 	// scanning
 	NULL,	// fs_identify_partition,

Modified: haiku/trunk/src/add-ons/kernel/file_systems/iso9660/kernel_interface.cpp
===================================================================
--- haiku/trunk/src/add-ons/kernel/file_systems/iso9660/kernel_interface.cpp	2007-08-22 20:29:40 UTC (rev 22042)
+++ haiku/trunk/src/add-ons/kernel/file_systems/iso9660/kernel_interface.cpp	2007-08-22 21:21:30 UTC (rev 22043)
@@ -972,6 +972,7 @@
 	},
 
 	&quot;ISO9660 File System&quot;,
+	0,	// DDM flags
 
 	// scanning
 	fs_identify_partition,

Modified: haiku/trunk/src/add-ons/kernel/file_systems/nfs/nfs_add_on.c
===================================================================
--- haiku/trunk/src/add-ons/kernel/file_systems/nfs/nfs_add_on.c	2007-08-22 20:29:40 UTC (rev 22042)
+++ haiku/trunk/src/add-ons/kernel/file_systems/nfs/nfs_add_on.c	2007-08-22 21:21:30 UTC (rev 22043)
@@ -2430,6 +2430,7 @@
 	},
 
 	&quot;Network File System v2&quot;,
+	0,	// DDM flags
 
 	// scanning
 	NULL,	// fs_identify_partition,

Modified: haiku/trunk/src/add-ons/kernel/file_systems/ntfs/kernel_interface.c
===================================================================
--- haiku/trunk/src/add-ons/kernel/file_systems/ntfs/kernel_interface.c	2007-08-22 20:29:40 UTC (rev 22042)
+++ haiku/trunk/src/add-ons/kernel/file_systems/ntfs/kernel_interface.c	2007-08-22 21:21:30 UTC (rev 22043)
@@ -85,6 +85,7 @@
 	},
 
 	&quot;ntfs File System&quot;,
+	0,	// DDM flags
 
 	// scanning
 	fs_identify_partition,

Modified: haiku/trunk/src/add-ons/kernel/file_systems/ramfs/kernel_interface.cpp
===================================================================
--- haiku/trunk/src/add-ons/kernel/file_systems/ramfs/kernel_interface.cpp	2007-08-22 20:29:40 UTC (rev 22042)
+++ haiku/trunk/src/add-ons/kernel/file_systems/ramfs/kernel_interface.cpp	2007-08-22 21:21:30 UTC (rev 22043)
@@ -2070,6 +2070,7 @@
 	},
 
 	&quot;RAM File System&quot;,
+	0,	// DDM flags
 
 	// scanning
 	NULL,	// identify_partition()

Modified: haiku/trunk/src/add-ons/kernel/file_systems/reiserfs/kernel_interface.cpp
===================================================================
--- haiku/trunk/src/add-ons/kernel/file_systems/reiserfs/kernel_interface.cpp	2007-08-22 20:29:40 UTC (rev 22042)
+++ haiku/trunk/src/add-ons/kernel/file_systems/reiserfs/kernel_interface.cpp	2007-08-22 21:21:30 UTC (rev 22043)
@@ -650,6 +650,7 @@
 	},
 
 	&quot;Reiser File System&quot;,
+	0,	// DDM flags
 
 	// scanning
 	NULL,	// identify_partition()

Modified: haiku/trunk/src/add-ons/kernel/file_systems/userlandfs/kernel_add_on/kernel_interface.cpp
===================================================================
--- haiku/trunk/src/add-ons/kernel/file_systems/userlandfs/kernel_add_on/kernel_interface.cpp	2007-08-22 20:29:40 UTC (rev 22042)
+++ haiku/trunk/src/add-ons/kernel/file_systems/userlandfs/kernel_add_on/kernel_interface.cpp	2007-08-22 21:21:30 UTC (rev 22043)
@@ -1034,6 +1034,7 @@
 	},
 
 	&quot;Userland File System&quot;,
+	0,	// DDM flags
 
 	// scanning
 	NULL,	// identify_partition()

Modified: haiku/trunk/src/add-ons/kernel/partitioning_systems/intel/intel.cpp
===================================================================
--- haiku/trunk/src/add-ons/kernel/partitioning_systems/intel/intel.cpp	2007-08-22 20:29:40 UTC (rev 22042)
+++ haiku/trunk/src/add-ons/kernel/partitioning_systems/intel/intel.cpp	2007-08-22 21:21:30 UTC (rev 22043)
@@ -264,129 +264,40 @@
 // #pragma mark - Intel Partition Map - support functions
 
 
-// pm_supports_resizing
-static bool
-pm_supports_resizing(partition_data *partition)
+// pm_get_supported_operations
+static uint32
+pm_get_supported_operations(partition_data* partition, uint32 mask = ~0)
 {
-	TRACE((&quot;intel: pm_supports_resizing(%ld: %lld, %lld, %ld, %s)\n&quot;,
-		partition-&gt;id, partition-&gt;offset, partition-&gt;size,
-		partition-&gt;block_size, partition-&gt;content_type));
-	
-	return (partition &amp;&amp; partition-&gt;content_type
-		&amp;&amp; !strcmp(partition-&gt;content_type, kPartitionTypeIntel));
-}
+	uint32 flags = B_DISK_SYSTEM_SUPPORTS_RESIZING
+		| B_DISK_SYSTEM_SUPPORTS_MOVING
+		| B_DISK_SYSTEM_SUPPORTS_SETTING_CONTENT_PARAMETERS
+		| B_DISK_SYSTEM_SUPPORTS_INITIALIZING;
 
-// pm_supports_resizing_child
-static bool
-pm_supports_resizing_child(partition_data *partition, partition_data *child)
-{
-	TRACE((&quot;intel: pm_supports_resizing_child(%ld: %lld, %lld, %ld, %s)\n&quot;,
-		partition-&gt;id, partition-&gt;offset, partition-&gt;size,
-		partition-&gt;block_size, partition-&gt;content_type));
-	
-	return (partition &amp;&amp; child &amp;&amp; partition-&gt;content_type
-			&amp;&amp; !strcmp(partition-&gt;content_type, kPartitionTypeIntel));
-}
+	// creating child
+	int32 countSpaces = 0;
+	if (partition-&gt;child_count &lt; 4
+		// free space check
+		&amp;&amp; pm_get_partitionable_spaces(partition, NULL, 0, &amp;countSpaces) == B_OK
+		&amp;&amp; countSpaces &gt; 0) {
+		flags |= B_DISK_SYSTEM_SUPPORTS_CREATING_CHILD;
+	}
 
-// pm_supports_moving
-static bool
-pm_supports_moving(partition_data *partition, bool *isNoOp)
-{
-	TRACE((&quot;intel: pm_supports_moving(%ld: %lld, %lld, %ld, %s)\n&quot;,
-		partition-&gt;id, partition-&gt;offset, partition-&gt;size,
-		partition-&gt;block_size, partition-&gt;content_type));
-	
-	*isNoOp = true;
-	return (partition &amp;&amp; partition-&gt;content_type
-		&amp;&amp; !strcmp(partition-&gt;content_type, kPartitionTypeIntel));
+	return flags;
 }
 
-// pm_supports_moving_child
-static bool
-pm_supports_moving_child(partition_data *partition, partition_data *child)
-{
-	TRACE((&quot;intel: pm_supports_moving_child(%ld: %lld, %lld, %ld, %s)\n&quot;,
-		partition-&gt;id, partition-&gt;offset, partition-&gt;size,
-		partition-&gt;block_size, partition-&gt;content_type));
-	
-	return (partition &amp;&amp; child &amp;&amp; partition-&gt;content_type
-		&amp;&amp; !strcmp(partition-&gt;content_type, kPartitionTypeIntel));
-}
 
-// pm_supports_setting_name
-static bool
-pm_supports_setting_name(partition_data *partition)
+// pm_get_supported_child_operations
+static uint32
+pm_get_supported_child_operations(partition_data* partition,
+	partition_data* child, uint32 mask = ~0)
 {
-	return false;
+	return B_DISK_SYSTEM_SUPPORTS_RESIZING_CHILD
+		| B_DISK_SYSTEM_SUPPORTS_MOVING_CHILD

[... truncated: 2354 lines follow ...]

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="003658.html">[Haiku-commits] r22042 - haiku/trunk/src/apps/terminal
</A></li>
	<LI>Next message: <A HREF="003660.html">[Haiku-commits] r22044 - in haiku/trunk: headers/private/storage	src/kits/storage
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3659">[ date ]</a>
              <a href="thread.html#3659">[ thread ]</a>
              <a href="subject.html#3659">[ subject ]</a>
              <a href="author.html#3659">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/haiku-commits">More information about the Haiku-commits
mailing list</a><br>
</body></html>
