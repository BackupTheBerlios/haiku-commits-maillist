<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Haiku-commits] r31321 - in haiku/trunk/src/apps/debugger: . arch	arch/x86/disasm debug_info debugger_interface dwarf elf	gui/team_window model types
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/haiku-commits/2009-June/index.html" >
   <LINK REL="made" HREF="mailto:haiku-commits%40lists.berlios.de?Subject=Re%3A%20%5BHaiku-commits%5D%20r31321%20-%20in%20haiku/trunk/src/apps/debugger%3A%20.%20arch%0A%09arch/x86/disasm%20debug_info%20debugger_interface%20dwarf%20elf%0A%09gui/team_window%20model%20types&In-Reply-To=%3C200906292238.n5TMcKqR011018%40sheep.berlios.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="017582.html">
   <LINK REL="Next"  HREF="017589.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Haiku-commits] r31321 - in haiku/trunk/src/apps/debugger: . arch	arch/x86/disasm debug_info debugger_interface dwarf elf	gui/team_window model types</H1>
    <B>bonefish at BerliOS</B> 
    <A HREF="mailto:haiku-commits%40lists.berlios.de?Subject=Re%3A%20%5BHaiku-commits%5D%20r31321%20-%20in%20haiku/trunk/src/apps/debugger%3A%20.%20arch%0A%09arch/x86/disasm%20debug_info%20debugger_interface%20dwarf%20elf%0A%09gui/team_window%20model%20types&In-Reply-To=%3C200906292238.n5TMcKqR011018%40sheep.berlios.de%3E"
       TITLE="[Haiku-commits] r31321 - in haiku/trunk/src/apps/debugger: . arch	arch/x86/disasm debug_info debugger_interface dwarf elf	gui/team_window model types">bonefish at mail.berlios.de
       </A><BR>
    <I>Tue Jun 30 00:38:20 CEST 2009</I>
    <P><UL>
        <LI>Previous message: <A HREF="017582.html">[Haiku-commits] r31320 -	haiku/trunk/src/add-ons/media/media-add-ons/firewire_dv
</A></li>
        <LI>Next message: <A HREF="017589.html">[Haiku-commits] r31302 - haiku/trunk/src/apps/mediaplayer
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#17583">[ date ]</a>
              <a href="thread.html#17583">[ thread ]</a>
              <a href="subject.html#17583">[ subject ]</a>
              <a href="author.html#17583">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: bonefish
Date: 2009-06-30 00:38:15 +0200 (Tue, 30 Jun 2009)
New Revision: 31321
ViewCVS: <A HREF="http://svn.berlios.de/viewcvs/haiku?rev=31321&amp;view=rev">http://svn.berlios.de/viewcvs/haiku?rev=31321&amp;view=rev</A>

Added:
   haiku/trunk/src/apps/debugger/debug_info/DwarfFunctionDebugInfo.cpp
   haiku/trunk/src/apps/debugger/debug_info/DwarfFunctionDebugInfo.h
   haiku/trunk/src/apps/debugger/dwarf/DwarfUtils.cpp
   haiku/trunk/src/apps/debugger/dwarf/DwarfUtils.h
   haiku/trunk/src/apps/debugger/types/
   haiku/trunk/src/apps/debugger/types/SourceLocation.h
   haiku/trunk/src/apps/debugger/types/TargetAddressRange.h
   haiku/trunk/src/apps/debugger/types/TargetAddressRangeList.cpp
   haiku/trunk/src/apps/debugger/types/TargetAddressRangeList.h
   haiku/trunk/src/apps/debugger/types/Types.h
Removed:
   haiku/trunk/src/apps/debugger/arch/ArchitectureTypes.h
   haiku/trunk/src/apps/debugger/arch/TargetAddressRange.h
   haiku/trunk/src/apps/debugger/model/SourceLocation.h
Modified:
   haiku/trunk/src/apps/debugger/Array.h
   haiku/trunk/src/apps/debugger/Jamfile
   haiku/trunk/src/apps/debugger/arch/Architecture.h
   haiku/trunk/src/apps/debugger/arch/CpuState.h
   haiku/trunk/src/apps/debugger/arch/InstructionInfo.h
   haiku/trunk/src/apps/debugger/arch/x86/disasm/DisassemblerX86.h
   haiku/trunk/src/apps/debugger/arch/x86/disasm/Jamfile
   haiku/trunk/src/apps/debugger/debug_info/DwarfImageDebugInfo.cpp
   haiku/trunk/src/apps/debugger/debug_info/DwarfImageDebugInfo.h
   haiku/trunk/src/apps/debugger/debug_info/FunctionDebugInfo.h
   haiku/trunk/src/apps/debugger/debug_info/ImageDebugInfo.h
   haiku/trunk/src/apps/debugger/debug_info/SpecificImageDebugInfo.h
   haiku/trunk/src/apps/debugger/debugger_interface/DebugEvent.h
   haiku/trunk/src/apps/debugger/dwarf/AttributeValue.h
   haiku/trunk/src/apps/debugger/dwarf/DebugInfoEntries.cpp
   haiku/trunk/src/apps/debugger/dwarf/DebugInfoEntries.h
   haiku/trunk/src/apps/debugger/dwarf/DebugInfoEntry.cpp
   haiku/trunk/src/apps/debugger/dwarf/DebugInfoEntry.h
   haiku/trunk/src/apps/debugger/dwarf/DwarfFile.cpp
   haiku/trunk/src/apps/debugger/dwarf/DwarfFile.h
   haiku/trunk/src/apps/debugger/dwarf/Jamfile
   haiku/trunk/src/apps/debugger/elf/ElfFile.cpp
   haiku/trunk/src/apps/debugger/elf/ElfFile.h
   haiku/trunk/src/apps/debugger/gui/team_window/SourceView.h
   haiku/trunk/src/apps/debugger/model/Breakpoint.h
   haiku/trunk/src/apps/debugger/model/ImageInfo.h
   haiku/trunk/src/apps/debugger/model/StackFrame.h
   haiku/trunk/src/apps/debugger/model/Statement.h
   haiku/trunk/src/apps/debugger/model/SymbolInfo.h
Log:
* Renamed ArchitectureTypes.h to Types.h.
* Created &quot;types&quot; subdirectory for basic types and moved Types.h,
  SourceLocation, TargetAddressRange there.
* Added TargetAddressRangeList, representing a list of address ranges.
* Array: Added copy constructor and assignment operator.
* Added DwarfFunctionDebugInfo.
* ElfFile: Also read the program headers and provide access to the segment
  information.
* DWARF:
  - Some work on DIECompileUnitBase and DIESubprogram to handle attributes we
    need.
  - Added DwarfUtils class which provides static utility methods. Currently some
    to get DIE names. Only provisionally implemented yet.
  - Read range list attribute values from the .debug_ranges section. Extended
    AttributeValue to handle them correctly (ref-counting).
* DwarfImageDebugInfo:
  - Implemented GetFunctions() for real, i.e. we return functions for all
    subprogram debug info entries we find (those that refer to actual
    functions, that is).
  - Implemented the fallback part of LoadSourceCode() (reading the code from the
    file and disassembling it).

Things should hopefully work as before, just a bit slower and with less accurate
function names, if DWARF debug info is available. Promising, eh? ;-)


Modified: haiku/trunk/src/apps/debugger/Array.h
===================================================================
--- haiku/trunk/src/apps/debugger/Array.h	2009-06-29 22:12:20 UTC (rev 31320)
+++ haiku/trunk/src/apps/debugger/Array.h	2009-06-29 22:38:15 UTC (rev 31321)
@@ -14,6 +14,7 @@
 class Array {
 public:
 	inline						Array();
+								Array(const Array&lt;Element&gt;&amp; other);
 								~Array();
 
 	inline	int					Size() const		{ return fSize; }
@@ -34,6 +35,8 @@
 	inline	Element&amp;			operator[](int index);
 	inline	const Element&amp;		operator[](int index) const;
 
+			Array&lt;Element&gt;&amp;		operator=(const Array&lt;Element&gt;&amp; other);
+
 private:
 	static	const int			kMinCapacity = 8;
 
@@ -57,6 +60,17 @@
 
 
 template&lt;typename Element&gt;
+Array&lt;Element&gt;::Array(const Array&lt;Element&gt;&amp; other)
+	:
+	fElements(NULL),
+	fSize(0),
+	fCapacity(0)
+{
+	*this = other;
+}
+
+
+template&lt;typename Element&gt;
 Array&lt;Element&gt;::~Array()
 {
 	free(fElements);
@@ -178,6 +192,21 @@
 
 
 template&lt;typename Element&gt;
+Array&lt;Element&gt;&amp;
+Array&lt;Element&gt;::operator=(const Array&lt;Element&gt;&amp; other)
+{
+	Clear();
+
+	if (other.fSize &gt; 0 &amp;&amp; _Resize(0, other.fSize)) {
+		fSize = other.fSize;
+		memcpy(fElements, other.fElements, fSize * sizeof(Element));
+	}
+
+	return *this;
+}
+
+
+template&lt;typename Element&gt;
 bool
 Array&lt;Element&gt;::_Resize(int index, int delta)
 {

Modified: haiku/trunk/src/apps/debugger/Jamfile
===================================================================
--- haiku/trunk/src/apps/debugger/Jamfile	2009-06-29 22:12:20 UTC (rev 31320)
+++ haiku/trunk/src/apps/debugger/Jamfile	2009-06-29 22:38:15 UTC (rev 31321)
@@ -13,6 +13,7 @@
 SEARCH_SOURCE += [ FDirName $(SUBDIR) elf ] ;
 SEARCH_SOURCE += [ FDirName $(SUBDIR) gui team_window ] ;
 SEARCH_SOURCE += [ FDirName $(SUBDIR) model ] ;
+SEARCH_SOURCE += [ FDirName $(SUBDIR) types ] ;
 
 local debugAnalyzerSources
 	= [ FDirName $(HAIKU_TOP) src apps debuganalyzer ] ;
@@ -22,6 +23,7 @@
 SubDirHdrs [ FDirName $(debugAnalyzerSources) gui ] ;
 
 SourceHdrs
+	DwarfFunctionDebugInfo.cpp
 	DwarfImageDebugInfo.cpp
 	DwarfTeamDebugInfo.cpp
 	: [ FDirName $(SUBDIR) dwarf ]
@@ -49,6 +51,7 @@
 	BasicFunctionDebugInfo.cpp
 	DebuggerImageDebugInfo.cpp
 	DebuggerTeamDebugInfo.cpp
+	DwarfFunctionDebugInfo.cpp
 	DwarfImageDebugInfo.cpp
 	DwarfTeamDebugInfo.cpp
 	FunctionDebugInfo.cpp
@@ -90,6 +93,9 @@
 	Thread.cpp
 	ThreadInfo.cpp
 
+	# types
+	TargetAddressRangeList.cpp
+
 	:
 	&lt;nogrist&gt;Debugger_demangler.o
 	&lt;nogrist&gt;Debugger_disasm_x86.o

Modified: haiku/trunk/src/apps/debugger/arch/Architecture.h
===================================================================
--- haiku/trunk/src/apps/debugger/arch/Architecture.h	2009-06-29 22:12:20 UTC (rev 31320)
+++ haiku/trunk/src/apps/debugger/arch/Architecture.h	2009-06-29 22:38:15 UTC (rev 31321)
@@ -9,7 +9,7 @@
 
 #include &lt;Referenceable.h&gt;
 
-#include &quot;ArchitectureTypes.h&quot;
+#include &quot;Types.h&quot;
 
 
 class CpuState;

Deleted: haiku/trunk/src/apps/debugger/arch/ArchitectureTypes.h

Modified: haiku/trunk/src/apps/debugger/arch/CpuState.h
===================================================================
--- haiku/trunk/src/apps/debugger/arch/CpuState.h	2009-06-29 22:12:20 UTC (rev 31320)
+++ haiku/trunk/src/apps/debugger/arch/CpuState.h	2009-06-29 22:38:15 UTC (rev 31321)
@@ -10,7 +10,7 @@
 #include &lt;Referenceable.h&gt;
 #include &lt;Variant.h&gt;
 
-#include &quot;ArchitectureTypes.h&quot;
+#include &quot;Types.h&quot;
 
 
 class Register;

Modified: haiku/trunk/src/apps/debugger/arch/InstructionInfo.h
===================================================================
--- haiku/trunk/src/apps/debugger/arch/InstructionInfo.h	2009-06-29 22:12:20 UTC (rev 31320)
+++ haiku/trunk/src/apps/debugger/arch/InstructionInfo.h	2009-06-29 22:38:15 UTC (rev 31321)
@@ -7,7 +7,7 @@
 
 #include &lt;String.h&gt;
 
-#include &quot;ArchitectureTypes.h&quot;
+#include &quot;Types.h&quot;
 
 
 enum instruction_type {

Deleted: haiku/trunk/src/apps/debugger/arch/TargetAddressRange.h

Modified: haiku/trunk/src/apps/debugger/arch/x86/disasm/DisassemblerX86.h
===================================================================
--- haiku/trunk/src/apps/debugger/arch/x86/disasm/DisassemblerX86.h	2009-06-29 22:12:20 UTC (rev 31320)
+++ haiku/trunk/src/apps/debugger/arch/x86/disasm/DisassemblerX86.h	2009-06-29 22:38:15 UTC (rev 31321)
@@ -7,7 +7,7 @@
 
 #include &lt;String.h&gt;
 
-#include &quot;ArchitectureTypes.h&quot;
+#include &quot;Types.h&quot;
 
 
 class DisassemblerX86 {

Modified: haiku/trunk/src/apps/debugger/arch/x86/disasm/Jamfile
===================================================================
--- haiku/trunk/src/apps/debugger/arch/x86/disasm/Jamfile	2009-06-29 22:12:20 UTC (rev 31320)
+++ haiku/trunk/src/apps/debugger/arch/x86/disasm/Jamfile	2009-06-29 22:38:15 UTC (rev 31321)
@@ -7,6 +7,7 @@
 UseHeaders [ LibraryHeaders [ FDirName udis86 libudis86 ] ] ;
 
 SubDirHdrs [ FDirName $(SUBDIR) $(DOTDOT) $(DOTDOT) ] ;
+SubDirHdrs [ FDirName $(SUBDIR) $(DOTDOT) $(DOTDOT) $(DOTDOT) types ] ;
 
 
 MergeObject Debugger_disasm_x86.o

Added: haiku/trunk/src/apps/debugger/debug_info/DwarfFunctionDebugInfo.cpp
===================================================================
--- haiku/trunk/src/apps/debugger/debug_info/DwarfFunctionDebugInfo.cpp	2009-06-29 22:12:20 UTC (rev 31320)
+++ haiku/trunk/src/apps/debugger/debug_info/DwarfFunctionDebugInfo.cpp	2009-06-29 22:38:15 UTC (rev 31321)
@@ -0,0 +1,86 @@
+/*
+ * Copyright 2009, Ingo Weinhold, <A HREF="https://lists.berlios.de/mailman/listinfo/haiku-commits">ingo_weinhold at gmx.de.</A>
+ * Distributed under the terms of the MIT License.
+ */
+
+#include &quot;DwarfFunctionDebugInfo.h&quot;
+
+#include &quot;DebugInfoEntries.h&quot;
+#include &quot;DwarfImageDebugInfo.h&quot;
+#include &quot;TargetAddressRangeList.h&quot;
+
+
+DwarfFunctionDebugInfo::DwarfFunctionDebugInfo(
+	DwarfImageDebugInfo* imageDebugInfo, DIESubprogram* subprogramEntry,
+	TargetAddressRangeList* addressRanges, const BString&amp; name)
+	:
+	fImageDebugInfo(imageDebugInfo),
+	fAddressRanges(addressRanges),
+	fName(name)
+{
+	fImageDebugInfo-&gt;AddReference();
+	fAddressRanges-&gt;AddReference();
+}
+
+
+DwarfFunctionDebugInfo::~DwarfFunctionDebugInfo()
+{
+	fAddressRanges-&gt;RemoveReference();
+	fImageDebugInfo-&gt;RemoveReference();
+}
+
+
+SpecificImageDebugInfo*
+DwarfFunctionDebugInfo::GetSpecificImageDebugInfo() const
+{
+	return fImageDebugInfo;
+}
+
+
+target_addr_t
+DwarfFunctionDebugInfo::Address() const
+{
+	return fAddressRanges-&gt;LowestAddress() + fImageDebugInfo-&gt;RelocationDelta();
+}
+
+
+target_size_t
+DwarfFunctionDebugInfo::Size() const
+{
+	return fAddressRanges-&gt;CoveringRange().Size();
+}
+
+
+const char*
+DwarfFunctionDebugInfo::Name() const
+{
+	return fName.String();
+}
+
+
+const char*
+DwarfFunctionDebugInfo::PrettyName() const
+{
+	return fName.String();
+}
+
+
+const char*
+DwarfFunctionDebugInfo::SourceFileName() const
+{
+	return NULL;
+}
+
+
+SourceLocation
+DwarfFunctionDebugInfo::SourceStartLocation() const
+{
+	return SourceLocation();
+}
+
+
+SourceLocation
+DwarfFunctionDebugInfo::SourceEndLocation() const
+{
+	return SourceLocation();
+}

Added: haiku/trunk/src/apps/debugger/debug_info/DwarfFunctionDebugInfo.h
===================================================================
--- haiku/trunk/src/apps/debugger/debug_info/DwarfFunctionDebugInfo.h	2009-06-29 22:12:20 UTC (rev 31320)
+++ haiku/trunk/src/apps/debugger/debug_info/DwarfFunctionDebugInfo.h	2009-06-29 22:38:15 UTC (rev 31321)
@@ -0,0 +1,44 @@
+/*
+ * Copyright 2009, Ingo Weinhold, <A HREF="https://lists.berlios.de/mailman/listinfo/haiku-commits">ingo_weinhold at gmx.de.</A>
+ * Distributed under the terms of the MIT License.
+ */
+#ifndef DWARF_FUNCTION_DEBUG_INFO_H
+#define DWARF_FUNCTION_DEBUG_INFO_H
+
+#include &lt;String.h&gt;
+
+#include &quot;FunctionDebugInfo.h&quot;
+
+
+class DIESubprogram;
+class DwarfImageDebugInfo;
+class TargetAddressRangeList;
+
+
+class DwarfFunctionDebugInfo : public FunctionDebugInfo {
+public:
+								DwarfFunctionDebugInfo(
+									DwarfImageDebugInfo* imageDebugInfo,
+									DIESubprogram* subprogramEntry,
+									TargetAddressRangeList* addressRanges,
+									const BString&amp; name);
+	virtual						~DwarfFunctionDebugInfo();
+
+	virtual	SpecificImageDebugInfo* GetSpecificImageDebugInfo() const;
+	virtual	target_addr_t		Address() const;
+	virtual	target_size_t		Size() const;
+	virtual	const char*			Name() const;
+	virtual	const char*			PrettyName() const;
+
+	virtual	const char*			SourceFileName() const;
+	virtual	SourceLocation		SourceStartLocation() const;
+	virtual	SourceLocation		SourceEndLocation() const;
+
+private:
+			DwarfImageDebugInfo* fImageDebugInfo;
+			TargetAddressRangeList* fAddressRanges;
+			const BString		fName;
+};
+
+
+#endif	// DWARF_FUNCTION_DEBUG_INFO_H

Modified: haiku/trunk/src/apps/debugger/debug_info/DwarfImageDebugInfo.cpp
===================================================================
--- haiku/trunk/src/apps/debugger/debug_info/DwarfImageDebugInfo.cpp	2009-06-29 22:12:20 UTC (rev 31320)
+++ haiku/trunk/src/apps/debugger/debug_info/DwarfImageDebugInfo.cpp	2009-06-29 22:38:15 UTC (rev 31321)
@@ -6,6 +6,7 @@
 #include &quot;DwarfImageDebugInfo.h&quot;
 
 #include &lt;stdio.h&gt;
+#include &lt;unistd.h&gt;
 
 #include &lt;new&gt;
 
@@ -16,6 +17,9 @@
 #include &quot;DebugInfoEntries.h&quot;
 #include &quot;Dwarf.h&quot;
 #include &quot;DwarfFile.h&quot;
+#include &quot;DwarfFunctionDebugInfo.h&quot;
+#include &quot;DwarfUtils.h&quot;
+#include &quot;ElfFile.h&quot;
 
 
 DwarfImageDebugInfo::DwarfImageDebugInfo(const ImageInfo&amp; imageInfo,
@@ -23,7 +27,9 @@
 	:
 	fImageInfo(imageInfo),
 	fArchitecture(architecture),
-	fFile(file)
+	fFile(file),
+	fTextSegment(NULL),
+	fRelocationDelta(0)
 {
 }
 
@@ -36,6 +42,12 @@
 status_t
 DwarfImageDebugInfo::Init()
 {
+	fTextSegment = fFile-&gt;GetElfFile()-&gt;TextSegment();
+	if (fTextSegment == NULL)
+		return B_ENTRY_NOT_FOUND;
+
+	fRelocationDelta = fImageInfo.TextBase() - fTextSegment-&gt;LoadAddress();
+
 	return B_OK;
 }
 
@@ -48,22 +60,94 @@
 
 	for (int32 i = 0; CompilationUnit* unit = fFile-&gt;CompilationUnitAt(i);
 			i++) {
-		printf(&quot;  %s:\n&quot;, unit-&gt;UnitEntry()-&gt;Name());
+		DIECompileUnitBase* unitEntry = unit-&gt;UnitEntry();
+//		printf(&quot;  %s:\n&quot;, unitEntry-&gt;Name());
+//		printf(&quot;    address ranges:\n&quot;);
+//		TargetAddressRangeList* rangeList = unitEntry-&gt;AddressRanges();
+//		if (rangeList != NULL) {
+//			int32 count = rangeList-&gt;CountRanges();
+//			for (int32 i = 0; i &lt; count; i++) {
+//				TargetAddressRange range = rangeList-&gt;RangeAt(i);
+//				printf(&quot;      %#llx - %#llx\n&quot;, range.Start(), range.End());
+//			}
+//		} else {
+//			printf(&quot;      %#llx - %#llx\n&quot;, (target_addr_t)unitEntry-&gt;LowPC(),
+//				(target_addr_t)unitEntry-&gt;HighPC());
+//		}
 
+//		printf(&quot;    functions:\n&quot;);
 		for (DebugInfoEntryList::ConstIterator it
-					= unit-&gt;UnitEntry()-&gt;OtherChildren().GetIterator();
+					= unitEntry-&gt;OtherChildren().GetIterator();
 				DebugInfoEntry* entry = it.Next();) {
 			if (entry-&gt;Tag() != DW_TAG_subprogram)
 				continue;
 
 			DIESubprogram* subprogramEntry = static_cast&lt;DIESubprogram*&gt;(entry);
-			printf(&quot;    subprogram entry: %p, name: %s, declaration: %d\n&quot;,
-				subprogramEntry, subprogramEntry-&gt;Name(),
-				subprogramEntry-&gt;IsDeclaration());
+
+			// ignore declarations, prototypes, and inlined functions
+			if (subprogramEntry-&gt;IsDeclaration()
+				|| subprogramEntry-&gt;IsPrototyped()
+				|| subprogramEntry-&gt;Inline() == DW_INL_inlined
+				|| subprogramEntry-&gt;Inline() == DW_INL_declared_inlined
+				|| subprogramEntry-&gt;AbstractOrigin() != NULL) {
+				continue;
+			}
+
+			// get the name
+			BString name;
+			DwarfUtils::GetFullyQualifiedDIEName(subprogramEntry, name);
+			if (name.Length() == 0)
+				continue;
+
+			// get the address ranges
+			TargetAddressRangeList* rangeList
+				= subprogramEntry-&gt;AddressRanges();
+			Reference&lt;TargetAddressRangeList&gt; rangeListReference(rangeList);
+			if (rangeList == NULL) {
+				target_addr_t lowPC = subprogramEntry-&gt;LowPC();
+				target_addr_t highPC = subprogramEntry-&gt;HighPC();
+				if (lowPC &gt;= highPC)
+					continue;
+
+				rangeList = new(std::nothrow) TargetAddressRangeList(
+					TargetAddressRange(lowPC, highPC - lowPC));
+				if (rangeList == NULL)
+					return B_NO_MEMORY;
+						// TODO: Clean up already added functions!
+				rangeListReference.SetTo(rangeList, true);
+			}
+
+			// create and add the functions
+			DwarfFunctionDebugInfo* function
+				= new(std::nothrow) DwarfFunctionDebugInfo(this,
+					subprogramEntry, rangeList, name);
+			if (function == NULL || !functions.AddItem(function)) {
+				delete function;
+				return B_NO_MEMORY;
+					// TODO: Clean up already added functions!
+			}
+
+//			BString name;
+//			DwarfUtils::GetFullyQualifiedDIEName(subprogramEntry, name);
+//			printf(&quot;      subprogram entry: %p, name: %s, declaration: %d\n&quot;,
+//				subprogramEntry, name.String(),
+//				subprogramEntry-&gt;IsDeclaration());
+//
+//			rangeList = subprogramEntry-&gt;AddressRanges();
+//			if (rangeList != NULL) {
+//				int32 count = rangeList-&gt;CountRanges();
+//				for (int32 i = 0; i &lt; count; i++) {
+//					TargetAddressRange range = rangeList-&gt;RangeAt(i);
+//					printf(&quot;        %#llx - %#llx\n&quot;, range.Start(), range.End());
+//				}
+//			} else {
+//				printf(&quot;        %#llx - %#llx\n&quot;,
+//					(target_addr_t)subprogramEntry-&gt;LowPC(),
+//					(target_addr_t)subprogramEntry-&gt;HighPC());
+//			}
 		}
 	}
 
-	// TODO:...
 	return B_OK;
 }
 
@@ -82,8 +166,25 @@
 DwarfImageDebugInfo::LoadSourceCode(FunctionDebugInfo* function,
 	SourceCode*&amp; _sourceCode)
 {
-	// TODO:...
-	return B_UNSUPPORTED;
+	// TODO: Load the actual source code!
+
+	static const target_size_t kMaxBufferSize = 64 * 1024;
+	target_size_t bufferSize = std::min(function-&gt;Size(), kMaxBufferSize);
+	void* buffer = malloc(bufferSize);
+	if (buffer == NULL)
+		return B_NO_MEMORY;
+	MemoryDeleter bufferDeleter(buffer);
+
+	// read the function code
+	target_addr_t functionOffset = function-&gt;Address() - fRelocationDelta
+		- fTextSegment-&gt;LoadAddress() + fTextSegment-&gt;FileOffset();
+	ssize_t bytesRead = pread(fFile-&gt;GetElfFile()-&gt;FD(), buffer, bufferSize,
+		functionOffset);
+	if (bytesRead &lt; 0)
+		return bytesRead;
+
+	return fArchitecture-&gt;DisassembleCode(function, buffer, bytesRead,
+		_sourceCode);
 }
 
 

Modified: haiku/trunk/src/apps/debugger/debug_info/DwarfImageDebugInfo.h
===================================================================
--- haiku/trunk/src/apps/debugger/debug_info/DwarfImageDebugInfo.h	2009-06-29 22:12:20 UTC (rev 31320)
+++ haiku/trunk/src/apps/debugger/debug_info/DwarfImageDebugInfo.h	2009-06-29 22:38:15 UTC (rev 31321)
@@ -11,6 +11,7 @@
 
 class Architecture;
 class DwarfFile;
+class ElfSegment;
 
 
 class DwarfImageDebugInfo : public SpecificImageDebugInfo {
@@ -22,6 +23,9 @@
 
 			status_t			Init();
 
+			target_addr_t		RelocationDelta() const
+									{ return fRelocationDelta; }
+
 	virtual	status_t			GetFunctions(
 									BObjectList&lt;FunctionDebugInfo&gt;&amp; functions);
 	virtual	status_t			CreateFrame(Image* image,
@@ -39,6 +43,8 @@
 			ImageInfo			fImageInfo;
 			Architecture*		fArchitecture;
 			DwarfFile*			fFile;
+			ElfSegment*			fTextSegment;
+			target_addr_t		fRelocationDelta;
 };
 
 

Modified: haiku/trunk/src/apps/debugger/debug_info/FunctionDebugInfo.h
===================================================================
--- haiku/trunk/src/apps/debugger/debug_info/FunctionDebugInfo.h	2009-06-29 22:12:20 UTC (rev 31320)
+++ haiku/trunk/src/apps/debugger/debug_info/FunctionDebugInfo.h	2009-06-29 22:38:15 UTC (rev 31321)
@@ -8,8 +8,8 @@
 #include &lt;Referenceable.h&gt;
 #include &lt;util/DoublyLinkedList.h&gt;
 
-#include &quot;ArchitectureTypes.h&quot;
 #include &quot;SourceLocation.h&quot;
+#include &quot;Types.h&quot;
 
 
 enum function_source_state {

Modified: haiku/trunk/src/apps/debugger/debug_info/ImageDebugInfo.h
===================================================================
--- haiku/trunk/src/apps/debugger/debug_info/ImageDebugInfo.h	2009-06-29 22:12:20 UTC (rev 31320)
+++ haiku/trunk/src/apps/debugger/debug_info/ImageDebugInfo.h	2009-06-29 22:38:15 UTC (rev 31321)
@@ -10,8 +10,8 @@
 #include &lt;ObjectList.h&gt;
 #include &lt;Referenceable.h&gt;
 
-#include &quot;ArchitectureTypes.h&quot;
 #include &quot;ImageInfo.h&quot;
+#include &quot;Types.h&quot;
 
 
 class Architecture;

Modified: haiku/trunk/src/apps/debugger/debug_info/SpecificImageDebugInfo.h
===================================================================
--- haiku/trunk/src/apps/debugger/debug_info/SpecificImageDebugInfo.h	2009-06-29 22:12:20 UTC (rev 31320)
+++ haiku/trunk/src/apps/debugger/debug_info/SpecificImageDebugInfo.h	2009-06-29 22:38:15 UTC (rev 31321)
@@ -8,7 +8,7 @@
 #include &lt;ObjectList.h&gt;
 #include &lt;Referenceable.h&gt;
 
-#include &quot;ArchitectureTypes.h&quot;
+#include &quot;Types.h&quot;
 
 
 class Architecture;

Modified: haiku/trunk/src/apps/debugger/debugger_interface/DebugEvent.h
===================================================================
--- haiku/trunk/src/apps/debugger/debugger_interface/DebugEvent.h	2009-06-29 22:12:20 UTC (rev 31320)
+++ haiku/trunk/src/apps/debugger/debugger_interface/DebugEvent.h	2009-06-29 22:38:15 UTC (rev 31321)
@@ -7,8 +7,8 @@
 
 #include &lt;debugger.h&gt;
 
-#include &quot;ArchitectureTypes.h&quot;
 #include &quot;ImageInfo.h&quot;
+#include &quot;Types.h&quot;
 
 
 class CpuState;

Modified: haiku/trunk/src/apps/debugger/dwarf/AttributeValue.h
===================================================================
--- haiku/trunk/src/apps/debugger/dwarf/AttributeValue.h	2009-06-29 22:12:20 UTC (rev 31320)
+++ haiku/trunk/src/apps/debugger/dwarf/AttributeValue.h	2009-06-29 22:38:15 UTC (rev 31321)
@@ -7,6 +7,7 @@
 
 #include &quot;AttributeClasses.h&quot;
 #include &quot;DwarfTypes.h&quot;
+#include &quot;TargetAddressRangeList.h&quot;
 
 
 class DebugInfoEntry;
@@ -21,6 +22,7 @@
 		}					block;
 		uint64				constant;
 		bool				flag;
+		TargetAddressRangeList*	rangeList;
 		dwarf_off_t			pointer;
 		DebugInfoEntry*		reference;
 		const char*			string;
@@ -30,6 +32,100 @@
 	uint8				attributeClass;
 	bool				isSigned;
 
+	AttributeValue()
+		:
+		attributeClass(ATTRIBUTE_CLASS_UNKNOWN)
+	{
+	}
+
+	~AttributeValue()
+	{
+		Unset();
+	}
+
+	void SetToAddress(dwarf_addr_t address)
+	{
+		Unset();
+		attributeClass = ATTRIBUTE_CLASS_ADDRESS;
+		this-&gt;address = address;
+	}
+
+	void SetToBlock(const void* data, dwarf_size_t length)
+	{
+		Unset();
+		attributeClass = ATTRIBUTE_CLASS_BLOCK;
+		block.data = data;
+		block.length = length;
+	}
+
+	void SetToConstant(uint64 value, bool isSigned)
+	{
+		Unset();
+		attributeClass = ATTRIBUTE_CLASS_CONSTANT;
+		this-&gt;constant = value;
+		this-&gt;isSigned = isSigned;
+	}
+
+	void SetToFlag(bool value)
+	{
+		Unset();
+		attributeClass = ATTRIBUTE_CLASS_FLAG;
+		this-&gt;flag = value;
+	}
+
+	void SetToLinePointer(dwarf_off_t value)
+	{
+		Unset();
+		attributeClass = ATTRIBUTE_CLASS_LINEPTR;
+		this-&gt;pointer = value;
+	}
+
+	void SetToLocationListPointer(dwarf_off_t value)
+	{
+		Unset();
+		attributeClass = ATTRIBUTE_CLASS_LOCLISTPTR;
+		this-&gt;pointer = value;
+	}
+
+	void SetToMacroPointer(dwarf_off_t value)
+	{
+		Unset();
+		attributeClass = ATTRIBUTE_CLASS_MACPTR;
+		this-&gt;pointer = value;
+	}
+
+	void SetToRangeList(TargetAddressRangeList* rangeList)
+	{
+		Unset();
+		attributeClass = ATTRIBUTE_CLASS_RANGELISTPTR;
+		this-&gt;rangeList = rangeList;
+		if (rangeList != NULL)
+			rangeList-&gt;AddReference();
+	}
+
+	void SetToReference(DebugInfoEntry* entry)
+	{
+		Unset();
+		attributeClass = ATTRIBUTE_CLASS_REFERENCE;
+		this-&gt;reference = entry;
+	}
+
+	void SetToString(const char* string)
+	{
+		Unset();
+		attributeClass = ATTRIBUTE_CLASS_STRING;
+		this-&gt;string = string;
+	}
+
+	void Unset()
+	{
+		if (attributeClass == ATTRIBUTE_CLASS_RANGELISTPTR
+			&amp;&amp; rangeList != NULL) {
+			rangeList-&gt;RemoveReference();
+		}
+		attributeClass = ATTRIBUTE_CLASS_UNKNOWN;
+	}
+
 	const char* ToString(char* buffer, size_t size);
 };
 

Modified: haiku/trunk/src/apps/debugger/dwarf/DebugInfoEntries.cpp
===================================================================
--- haiku/trunk/src/apps/debugger/dwarf/DebugInfoEntries.cpp	2009-06-29 22:12:20 UTC (rev 31320)
+++ haiku/trunk/src/apps/debugger/dwarf/DebugInfoEntries.cpp	2009-06-29 22:38:15 UTC (rev 31321)
@@ -24,6 +24,7 @@
 	fStatementListOffset(0),
 	fMacroInfoOffset(0),
 		// TODO: Is 0 a good invalid offset?
+	fAddressRanges(NULL),
 	fBaseTypesUnit(NULL),
 	fLanguage(0),
 	fIdentifierCase(0),
@@ -32,6 +33,13 @@
 }
 
 
+DIECompileUnitBase::~DIECompileUnitBase()
+{
+	if (fAddressRanges != NULL)
+		fAddressRanges-&gt;RemoveReference();
+}
+
+
 status_t
 DIECompileUnitBase::InitAfterAttributes(DebugInfoEntryInitInfo&amp; info)
 {
@@ -65,6 +73,16 @@
 }
 
 
+dwarf_addr_t
+DIECompileUnitBase::AddressRangeBase() const
+{
+	if (fAddressRanges != NULL)
+		return fAddressRanges-&gt;LowestAddress();
+
+	return fLowPC;
+}
+
+
 status_t
 DIECompileUnitBase::AddChild(DebugInfoEntry* child)
 {
@@ -175,6 +193,22 @@
 }
 
 
+status_t
+DIECompileUnitBase::AddAttribute_ranges(uint16 attributeName,
+	const AttributeValue&amp; value)
+{
+	if (fAddressRanges != NULL)
+		fAddressRanges-&gt;RemoveReference();
+
+	fAddressRanges = value.rangeList;
+
+	if (fAddressRanges != NULL)
+		fAddressRanges-&gt;AddReference();
+
+	return B_OK;
+}
+
+
 // #pragma mark - DIEType
 
 
@@ -285,6 +319,13 @@
 }
 
 
+DebugInfoEntry*
+DIEDeclaredType::AbstractOrigin() const
+{
+	return fAbstractOrigin;
+}
+
+
 status_t
 DIEDeclaredType::AddAttribute_accessibility(uint16 attributeName,
 	const AttributeValue&amp; value)
@@ -359,6 +400,20 @@
 }
 
 
+bool
+DIECompoundType::IsNamespace() const
+{
+	return true;
+}
+
+
+DebugInfoEntry*
+DIECompoundType::Specification() const
+{
+	return fSpecification;
+}
+
+
 status_t
 DIECompoundType::AddChild(DebugInfoEntry* child)
 {
@@ -569,6 +624,13 @@
 }
 
 
+DebugInfoEntry*
+DIEArrayType::Specification() const
+{
+	return fSpecification;
+}
+
+
 status_t
 DIEArrayType::AddChild(DebugInfoEntry* child)
 {
@@ -672,6 +734,13 @@
 }
 
 
+DebugInfoEntry*
+DIEEnumerationType::Specification() const
+{
+	return fSpecification;
+}
+
+
 status_t
 DIEEnumerationType::AddChild(DebugInfoEntry* child)
 {
@@ -809,6 +878,13 @@
 }
 
 
+DebugInfoEntry*
+DIEPointerType::Specification() const
+{
+	return fSpecification;
+}
+
+
 status_t
 DIEPointerType::AddAttribute_specification(uint16 attributeName,
 	const AttributeValue&amp; value)
@@ -1461,10 +1537,27 @@
 
 
 DIESubprogram::DIESubprogram()
+	:
+	fLowPC(0),
+	fHighPC(0),
+	fAddressRanges(NULL),
+	fSpecification(NULL),
+	fAbstractOrigin(NULL),
+	fReturnType(NULL),
+	fAddressClass(0),
+	fPrototyped(false),
+	fInline(DW_INL_not_inlined)
 {
 }
 
 
+DIESubprogram::~DIESubprogram()
+{
+	if (fAddressRanges != NULL)
+		fAddressRanges-&gt;RemoveReference();
+}
+
+
 uint16
 DIESubprogram::Tag() const
 {
@@ -1472,6 +1565,111 @@
 }
 
 
+DebugInfoEntry*
+DIESubprogram::Specification() const
+{
+	return fSpecification;
+}
+
+
+
+DebugInfoEntry*
+DIESubprogram::AbstractOrigin() const
+{
+	return fAbstractOrigin;
+}
+
+
+status_t
+DIESubprogram::AddAttribute_low_pc(uint16 attributeName,
+	const AttributeValue&amp; value)
+{
+	fLowPC = value.address;
+	return B_OK;
+}
+
+
+status_t
+DIESubprogram::AddAttribute_high_pc(uint16 attributeName,
+	const AttributeValue&amp; value)
+{
+	fHighPC = value.address;
+	return B_OK;
+}
+
+
+status_t
+DIESubprogram::AddAttribute_ranges(uint16 attributeName,
+	const AttributeValue&amp; value)
+{
+	if (fAddressRanges != NULL)
+		fAddressRanges-&gt;RemoveReference();
+
+	fAddressRanges = value.rangeList;
+
+	if (fAddressRanges != NULL)
+		fAddressRanges-&gt;AddReference();
+
+	return B_OK;
+}
+
+
+status_t
+DIESubprogram::AddAttribute_specification(uint16 attributeName,
+	const AttributeValue&amp; value)
+{
+	fSpecification = dynamic_cast&lt;DIESubprogram*&gt;(value.reference);
+	return fSpecification != NULL ? B_OK : B_BAD_DATA;
+}
+
+
+status_t
+DIESubprogram::AddAttribute_address_class(uint16 attributeName,
+	const AttributeValue&amp; value)
+{
+// TODO: How is the address class handled?
+	fAddressClass = value.constant;
+	return B_OK;
+}
+
+
+status_t
+DIESubprogram::AddAttribute_prototyped(uint16 attributeName,
+	const AttributeValue&amp; value)
+{
+	fPrototyped = value.flag;
+	return B_OK;
+}
+
+
+status_t
+DIESubprogram::AddAttribute_type(uint16 attributeName,
+	const AttributeValue&amp; value)
+{
+	fReturnType = dynamic_cast&lt;DIEType*&gt;(value.reference);
+	return fReturnType != NULL ? B_OK : B_BAD_DATA;
+}
+
+
+status_t
+DIESubprogram::AddAttribute_inline(uint16 attributeName,
+	const AttributeValue&amp; value)
+{
+// TODO: How is the address class handled?
+	fInline = value.constant;
+	return B_OK;
+}
+
+
+status_t
+DIESubprogram::AddAttribute_abstract_origin(uint16 attributeName,
+	const AttributeValue&amp; value)
+{
+	fAbstractOrigin = dynamic_cast&lt;DIESubprogram*&gt;(value.reference);
+	return fAbstractOrigin != NULL ? B_OK : B_BAD_DATA;
+}
+
+
 // #pragma mark - DIETemplateTypeParameter
 
 
@@ -1664,6 +1862,21 @@
 }
 
 
+bool
+DIENamespace::IsNamespace() const
+{
+	return true;
+}
+
+
+status_t

[... truncated: 1266 lines follow ...]

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="017582.html">[Haiku-commits] r31320 -	haiku/trunk/src/add-ons/media/media-add-ons/firewire_dv
</A></li>
	<LI>Next message: <A HREF="017589.html">[Haiku-commits] r31302 - haiku/trunk/src/apps/mediaplayer
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#17583">[ date ]</a>
              <a href="thread.html#17583">[ thread ]</a>
              <a href="subject.html#17583">[ subject ]</a>
              <a href="author.html#17583">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/haiku-commits">More information about the Haiku-commits
mailing list</a><br>
</body></html>
