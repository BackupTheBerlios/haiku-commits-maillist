<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Haiku-commits] r31195 - haiku/trunk/src/bin/keymap
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/haiku-commits/2009-June/index.html" >
   <LINK REL="made" HREF="mailto:haiku-commits%40lists.berlios.de?Subject=Re%3A%20%5BHaiku-commits%5D%20r31195%20-%20haiku/trunk/src/bin/keymap&In-Reply-To=%3C200906230944.n5N9iWqK009349%40sheep.berlios.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="017411.html">
   <LINK REL="Next"  HREF="017413.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Haiku-commits] r31195 - haiku/trunk/src/bin/keymap</H1>
    <B>axeld at BerliOS</B> 
    <A HREF="mailto:haiku-commits%40lists.berlios.de?Subject=Re%3A%20%5BHaiku-commits%5D%20r31195%20-%20haiku/trunk/src/bin/keymap&In-Reply-To=%3C200906230944.n5N9iWqK009349%40sheep.berlios.de%3E"
       TITLE="[Haiku-commits] r31195 - haiku/trunk/src/bin/keymap">axeld at mail.berlios.de
       </A><BR>
    <I>Tue Jun 23 11:44:32 CEST 2009</I>
    <P><UL>
        <LI>Previous message: <A HREF="017411.html">[Haiku-commits] r31194 - in haiku/trunk: headers/private/kernel	src/system/kernel src/system/kernel/debug
</A></li>
        <LI>Next message: <A HREF="017413.html">[Haiku-commits] r31196 - haiku/trunk/src/bin/keymap
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#17412">[ date ]</a>
              <a href="thread.html#17412">[ thread ]</a>
              <a href="subject.html#17412">[ subject ]</a>
              <a href="author.html#17412">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: axeld
Date: 2009-06-23 11:44:31 +0200 (Tue, 23 Jun 2009)
New Revision: 31195
ViewCVS: <A HREF="http://svn.berlios.de/viewcvs/haiku?rev=31195&amp;view=rev">http://svn.berlios.de/viewcvs/haiku?rev=31195&amp;view=rev</A>

Modified:
   haiku/trunk/src/bin/keymap/Keymap.cpp
   haiku/trunk/src/bin/keymap/Keymap.h
   haiku/trunk/src/bin/keymap/main.cpp
Log:
* More or less rewrote main.cpp to use getopt_long() instead of the self-made
  argument evaluation. Also separated the evaluation from performing the
  options, solving a TODO, and added long versions for the options.
* Changed Keymap methods to work on a path instead of entry_refs - this
  simplifies the code a bit over the place.
* Added new option to load a source keymap directly (-s, --load-source).
* Renamed some methods to make clearer what they do.
* Added a way to directly write a source keymap to a file (by specifying the
  -o option together with -d).
* Coding style cleanup, ordered Keymap methods in the order they are declared.


Modified: haiku/trunk/src/bin/keymap/Keymap.cpp
===================================================================
--- haiku/trunk/src/bin/keymap/Keymap.cpp	2009-06-23 01:39:51 UTC (rev 31194)
+++ haiku/trunk/src/bin/keymap/Keymap.cpp	2009-06-23 09:44:31 UTC (rev 31195)
@@ -1,28 +1,164 @@
 /*
- *	Copyright (c) 2004-2006, Haiku, Inc.
+ * Copyright 2004-2009, Haiku, Inc. All Rights Reserved.
+ * Distributed under the terms of the MIT License.
  *
- *  This software is part of the Haiku distribution and is covered 
- *  by the Haiku license.
- *
- *  Author: J&#233;r&#244;me Duval
+ * Authors:
+ *		J&#233;r&#244;me Duval
+ *		Axel D&#246;rfler, <A HREF="https://lists.berlios.de/mailman/listinfo/haiku-commits">axeld at pinc-software.de.</A>
  */
 
 
 #include &quot;Keymap.h&quot;
 
+#include &lt;errno.h&gt;
+#include &lt;stdlib.h&gt;
+#include &lt;string.h&gt;
+
 #include &lt;ByteOrder.h&gt;
 #include &lt;File.h&gt;
 #include &lt;FindDirectory.h&gt;
 #include &lt;Path.h&gt;
 #include &lt;String.h&gt;
 
-#include &lt;stdlib.h&gt;
-#include &lt;string.h&gt;
 
-
 #define CHARS_TABLE_MAXSIZE  10000
 
 
+extern status_t _restore_key_map_();
+
+
+// i couldn't put patterns and pattern bufs on the stack without segfaulting
+// regexp patterns
+const char versionPattern[]
+	= &quot;Version[[:space:]]+=[[:space:]]+\\([[:digit:]]+\\)&quot;;
+const char capslockPattern[]
+	= &quot;CapsLock[[:space:]]+=[[:space:]]+\\([[:alnum:]]+\\)&quot;;
+const char scrolllockPattern[]
+	= &quot;ScrollLock[[:space:]]+=[[:space:]]+\\([[:alnum:]]+\\)&quot;;
+const char numlockPattern[]
+	= &quot;NumLock[[:space:]]+=[[:space:]]+\\([[:alnum:]]+\\)&quot;;
+const char lshiftPattern[] = &quot;LShift[[:space:]]+=[[:space:]]+\\([[:alnum:]]+\\)&quot;;
+const char rshiftPattern[] = &quot;RShift[[:space:]]+=[[:space:]]+\\([[:alnum:]]+\\)&quot;;
+const char lcommandPattern[]
+	= &quot;LCommand[[:space:]]+=[[:space:]]+\\([[:alnum:]]+\\)&quot;;
+const char rcommandPattern[]
+	= &quot;RCommand[[:space:]]+=[[:space:]]+\\([[:alnum:]]+\\)&quot;;
+const char lcontrolPattern[]
+	= &quot;LControl[[:space:]]+=[[:space:]]+\\([[:alnum:]]+\\)&quot;;
+const char rcontrolPattern[]
+	= &quot;RControl[[:space:]]+=[[:space:]]+\\([[:alnum:]]+\\)&quot;;
+const char loptionPattern[]
+	= &quot;LOption[[:space:]]+=[[:space:]]+\\([[:alnum:]]+\\)&quot;;
+const char roptionPattern[]
+	= &quot;ROption[[:space:]]+=[[:space:]]+\\([[:alnum:]]+\\)&quot;;
+const char menuPattern[] = &quot;Menu[[:space:]]+=[[:space:]]+\\([[:alnum:]]+\\)&quot;;
+const char locksettingsPattern[]
+	= &quot;LockSettings[[:space:]]+=[[:space:]]+\\([[:alnum:]]*\\)&quot;
+		&quot;[[:space:]]*\\([[:alnum:]]*\\)&quot;
+		&quot;[[:space:]]*\\([[:alnum:]]*\\)[[:space:]]*&quot;;
+const char keyPattern[] = &quot;Key[[:space:]]+\\([[:alnum:]]+\\)[[:space:]]+=&quot;
+	&quot;[[:space:]]+\\([[:alnum:]]+\\|'.*'\\)&quot;
+	&quot;[[:space:]]+\\([[:alnum:]]+\\|'.*'\\)&quot;
+	&quot;[[:space:]]+\\([[:alnum:]]+\\|'.*'\\)&quot;
+	&quot;[[:space:]]+\\([[:alnum:]]+\\|'.*'\\)&quot;
+	&quot;[[:space:]]+\\([[:alnum:]]+\\|'.*'\\)&quot;
+	&quot;[[:space:]]+\\([[:alnum:]]+\\|'.*'\\)&quot;
+	&quot;[[:space:]]+\\([[:alnum:]]+\\|'.*'\\)&quot;
+	&quot;[[:space:]]+\\([[:alnum:]]+\\|'.*'\\)&quot;
+	&quot;[[:space:]]+\\([[:alnum:]]+\\|'.*'\\)&quot;
+	&quot;[[:space:]]+&quot;;
+
+
+const char acutePattern[] = &quot;Acute[[:space:]]+\\([[:alnum:]]+\\|'.*'\\)&quot;
+	&quot;[[:space:]]+=[[:space:]]+\\([[:alnum:]]+\\|'.*'\\)[[:space:]]+&quot;;
+const char gravePattern[] = &quot;Grave[[:space:]]+\\([[:alnum:]]+\\|'.*'\\)&quot;
+	&quot;[[:space:]]+=[[:space:]]+\\([[:alnum:]]+\\|'.*'\\)[[:space:]]+&quot;;
+const char circumflexPattern[] = &quot;Circumflex[[:space:]]+\\([[:alnum:]]&quot;
+	&quot;+\\|'.*'\\)[[:space:]]+=[[:space:]]+\\([[:alnum:]]+\\|'.*'\\)[[:space:]]+&quot;;
+const char diaeresisPattern[] = &quot;Diaeresis[[:space:]]+\\([[:alnum:]]+\\|'.*'\\)&quot;
+	&quot;[[:space:]]+=[[:space:]]+\\([[:alnum:]]+\\|'.*'\\)[[:space:]]+&quot;;
+const char tildePattern[] = &quot;Tilde[[:space:]]+\\([[:alnum:]]+\\|'.*'\\)&quot;
+	&quot;[[:space:]]+=[[:space:]]+\\([[:alnum:]]+\\|'.*'\\)[[:space:]]+&quot;;
+const char acutetabPattern[] = &quot;AcuteTab[[:space:]]+=&quot;
+	&quot;[[:space:]]+\\([[:alnum:]-]*\\)&quot;
+	&quot;[[:space:]]*\\([[:alnum:]-]*\\)&quot;
+	&quot;[[:space:]]*\\([[:alnum:]-]*\\)&quot;
+	&quot;[[:space:]]*\\([[:alnum:]-]*\\)&quot;
+	&quot;[[:space:]]*\\([[:alnum:]-]*\\)&quot;
+	&quot;[[:space:]]*\\([[:alnum:]-]*\\)&quot;
+	&quot;[[:space:]]*\\([[:alnum:]-]*\\)&quot;
+	&quot;[[:space:]]*\\([[:alnum:]-]*\\)&quot;
+	&quot;[[:space:]]*\\([[:alnum:]-]*\\)[[:space:]]*&quot; ;
+const char gravetabPattern[] = &quot;GraveTab[[:space:]]+=&quot;
+	&quot;[[:space:]]+\\([[:alnum:]-]*\\)&quot;
+	&quot;[[:space:]]*\\([[:alnum:]-]*\\)&quot;
+	&quot;[[:space:]]*\\([[:alnum:]-]*\\)&quot;
+	&quot;[[:space:]]*\\([[:alnum:]-]*\\)&quot;
+	&quot;[[:space:]]*\\([[:alnum:]-]*\\)&quot;
+	&quot;[[:space:]]*\\([[:alnum:]-]*\\)&quot;
+	&quot;[[:space:]]*\\([[:alnum:]-]*\\)&quot;
+	&quot;[[:space:]]*\\([[:alnum:]-]*\\)&quot;
+	&quot;[[:space:]]*\\([[:alnum:]-]*\\)[[:space:]]*&quot; ;
+const char circumflextabPattern[] = &quot;CircumflexTab[[:space:]]+=&quot;
+	&quot;[[:space:]]+\\([[:alnum:]-]*\\)&quot;
+	&quot;[[:space:]]*\\([[:alnum:]-]*\\)&quot;
+	&quot;[[:space:]]*\\([[:alnum:]-]*\\)&quot;
+	&quot;[[:space:]]*\\([[:alnum:]-]*\\)&quot;
+	&quot;[[:space:]]*\\([[:alnum:]-]*\\)&quot;
+	&quot;[[:space:]]*\\([[:alnum:]-]*\\)&quot;
+	&quot;[[:space:]]*\\([[:alnum:]-]*\\)&quot;
+	&quot;[[:space:]]*\\([[:alnum:]-]*\\)&quot;
+	&quot;[[:space:]]*\\([[:alnum:]-]*\\)[[:space:]]*&quot; ;
+const char diaeresistabPattern[] = &quot;DiaeresisTab[[:space:]]+=&quot;
+	&quot;[[:space:]]+\\([[:alnum:]-]*\\)&quot;
+	&quot;[[:space:]]*\\([[:alnum:]-]*\\)&quot;
+	&quot;[[:space:]]*\\([[:alnum:]-]*\\)&quot;
+	&quot;[[:space:]]*\\([[:alnum:]-]*\\)&quot;
+	&quot;[[:space:]]*\\([[:alnum:]-]*\\)&quot;
+	&quot;[[:space:]]*\\([[:alnum:]-]*\\)&quot;
+	&quot;[[:space:]]*\\([[:alnum:]-]*\\)&quot;
+	&quot;[[:space:]]*\\([[:alnum:]-]*\\)&quot;
+	&quot;[[:space:]]*\\([[:alnum:]-]*\\)[[:space:]]*&quot; ;
+const char tildetabPattern[] = &quot;TildeTab[[:space:]]+=&quot;
+	&quot;[[:space:]]+\\([[:alnum:]-]*\\)&quot;
+	&quot;[[:space:]]*\\([[:alnum:]-]*\\)&quot;
+	&quot;[[:space:]]*\\([[:alnum:]-]*\\)&quot;
+	&quot;[[:space:]]*\\([[:alnum:]-]*\\)&quot;
+	&quot;[[:space:]]*\\([[:alnum:]-]*\\)&quot;
+	&quot;[[:space:]]*\\([[:alnum:]-]*\\)&quot;
+	&quot;[[:space:]]*\\([[:alnum:]-]*\\)&quot;
+	&quot;[[:space:]]*\\([[:alnum:]-]*\\)&quot;
+	&quot;[[:space:]]*\\([[:alnum:]-]*\\)[[:space:]]*&quot; ;
+
+
+// re_pattern_buffer buffers
+struct re_pattern_buffer versionBuf;
+struct re_pattern_buffer capslockBuf;
+struct re_pattern_buffer scrolllockBuf;
+struct re_pattern_buffer numlockBuf;
+struct re_pattern_buffer lshiftBuf;
+struct re_pattern_buffer rshiftBuf;
+struct re_pattern_buffer lcommandBuf;
+struct re_pattern_buffer rcommandBuf;
+struct re_pattern_buffer lcontrolBuf;
+struct re_pattern_buffer rcontrolBuf;
+struct re_pattern_buffer loptionBuf;
+struct re_pattern_buffer roptionBuf;
+struct re_pattern_buffer menuBuf;
+struct re_pattern_buffer locksettingsBuf;
+struct re_pattern_buffer keyBuf;
+struct re_pattern_buffer acuteBuf;
+struct re_pattern_buffer graveBuf;
+struct re_pattern_buffer circumflexBuf;
+struct re_pattern_buffer diaeresisBuf;
+struct re_pattern_buffer tildeBuf;
+struct re_pattern_buffer acutetabBuf;
+struct re_pattern_buffer gravetabBuf;
+struct re_pattern_buffer circumflextabBuf;
+struct re_pattern_buffer diaeresistabBuf;
+struct re_pattern_buffer tildetabBuf;
+
+
 void
 dump_map(FILE* file, const char* name, int32* map)
 {
@@ -73,205 +209,11 @@
 }
 
 
-void
-Keymap::GetKey(char *chars, int32 offset, char* string) 
-{
-	int size = chars[offset++];
-	char str[32];
-	memset(str, 0, 32);
-	memset(string, 0, 32);
-
-	switch (size) {
-		case 0:
-			// Not mapped 
-			sprintf(str, &quot;''&quot;);
-			break; 
-
-		case 1:
-			// 1-byte UTF-8/ASCII character
-			if ((uint8)chars[offset] &lt; 0x20
-				|| (uint8)chars[offset] &gt; 0x7e)
-				sprintf(str, &quot;0x%02x&quot;, (uint8)chars[offset]);
-			else
-				sprintf(str, &quot;'%s%c'&quot;, 
-					(chars[offset] == '\\' || chars[offset] == '\'') ? &quot;\\&quot; : &quot;&quot;, chars[offset]);
-			break; 
-
-		default:
-			// n-byte UTF-8/ASCII character
-			sprintf(str, &quot;0x&quot;);
-			for (int i = 0; i &lt; size; i++) {
-				sprintf(str + 2*(i+1), &quot;%02x&quot;, (uint8)chars[offset+i]);
-			}
-			break;
-	}
-
-	strncpy(string, str, strlen(str) &lt; 12 ? strlen(str) : 12);
-		// TODO: Huh?
-}
-
-
-void
-Keymap::Dump()
-{
-	printf(&quot;#!/bin/keymap -l\n&quot;
-		&quot;#\n&quot;
-		&quot;#\tRaw key numbering for 101 keyboard...\n&quot;
-		&quot;#                                                                                        [sys]       [brk]\n&quot;
-		&quot;#                                                                                         0x7e        0x7f\n&quot;
-		&quot;# [esc]       [ f1] [ f2] [ f3] [ f4] [ f5] [ f6] [ f7] [ f8] [ f9] [f10] [f11] [f12]    [prn] [scr] [pau]\n&quot;
-		&quot;#  0x01        0x02  0x03  0x04  0x05  0x06  0x07  0x08  0x09  0x0a  0x0b  0x0c  0x0d     0x0e  0x0f  0x10     K E Y P A D   K E Y S\n&quot;
-		&quot;#\n&quot;
-		&quot;# [ ` ] [ 1 ] [ 2 ] [ 3 ] [ 4 ] [ 5 ] [ 6 ] [ 7 ] [ 8 ] [ 9 ] [ 0 ] [ - ] [ = ] [bck]    [ins] [hme] [pup]    [num] [ / ] [ * ] [ - ]\n&quot;
-		&quot;#  0x11  0x12  0x13  0x14  0x15  0x16  0x17  0x18  0x19  0x1a  0x1b  0x1c  0x1d  0x1e     0x1f  0x20  0x21     0x22  0x23  0x24  0x25\n&quot;
-		&quot;#\n&quot;
-		&quot;# [tab] [ q ] [ w ] [ e ] [ r ] [ t ] [ y ] [ u ] [ i ] [ o ] [ p ] [ [ ] [ ] ] [ \\ ]    [del] [end] [pdn]    [ 7 ] [ 8 ] [ 9 ] [ + ]\n&quot;
-		&quot;#  0x26  0x27  0x28  0x29  0x2a  0x2b  0x2c  0x2d  0x2e  0x2f  0x30  0x31  0x32  0x33     0x34  0x35  0x36     0x37  0x38  0x39  0x3a\n&quot;
-		&quot;#\n&quot;
-		&quot;# [cap] [ a ] [ s ] [ d ] [ f ] [ g ] [ h ] [ j ] [ k ] [ l ] [ ; ] [ ' ] [  enter  ]                         [ 4 ] [ 5 ] [ 6 ]\n&quot;
-		&quot;#  0x3b  0x3c  0x3d  0x3e  0x3f  0x40  0x41  0x42  0x43  0x44  0x45  0x46     0x47                             0x48  0x49  0x4a\n&quot;
-		&quot;#\n&quot;
-		&quot;# [shift]     [ z ] [ x ] [ c ] [ v ] [ b ] [ n ] [ m ] [ , ] [ . ] [ / ]     [shift]          [ up]          [ 1 ] [ 2 ] [ 3 ] [ent]\n&quot;
-		&quot;#   0x4b       0x4c  0x4d  0x4e  0x4f  0x50  0x51  0x52  0x53  0x54  0x55       0x56            0x57           0x58  0x59  0x5a  0x5b\n&quot;
-		&quot;#\n&quot;
-		&quot;# [ctr]             [cmd]             [  space  ]             [cmd]             [ctr]    [lft] [dwn] [rgt]    [ 0 ] [ . ]\n&quot;
-		&quot;#  0x5c              0x5d                 0x5e                 0x5f              0x60     0x61  0x62  0x63     0x64  0x65\n&quot;
-		&quot;#\n&quot;
-		&quot;#\tNOTE: On a Microsoft Natural Keyboard:\n&quot;
-		&quot;#\t\t\tleft option  = 0x66\n&quot;
-		&quot;#\t\t\tright option = 0x67\n&quot;
-		&quot;#\t\t\tmenu key     = 0x68\n&quot;
-		&quot;#\tNOTE: On an Apple Extended Keyboard:\n&quot;
-		&quot;#\t\t\tleft option  = 0x66\n&quot;
-		&quot;#\t\t\tright option = 0x67\n&quot;
-		&quot;#\t\t\tkeypad '='   = 0x6a\n&quot;
-		&quot;#\t\t\tpower key    = 0x6b\n&quot;);
-
-	printf(&quot;Version = %ld\n&quot;, fKeys.version);
-	printf(&quot;CapsLock = 0x%02lx\n&quot;, fKeys.caps_key);
-	printf(&quot;ScrollLock = 0x%02lx\n&quot;, fKeys.scroll_key);
-	printf(&quot;NumLock = 0x%02lx\n&quot;, fKeys.num_key);
-	printf(&quot;LShift = 0x%02lx\n&quot;, fKeys.left_shift_key);
-	printf(&quot;RShift = 0x%02lx\n&quot;, fKeys.right_shift_key);
-	printf(&quot;LCommand = 0x%02lx\n&quot;, fKeys.left_command_key);
-	printf(&quot;RCommand = 0x%02lx\n&quot;, fKeys.right_command_key);
-	printf(&quot;LControl = 0x%02lx\n&quot;, fKeys.left_control_key);
-	printf(&quot;RControl = 0x%02lx\n&quot;, fKeys.right_control_key);
-	printf(&quot;LOption = 0x%02lx\n&quot;, fKeys.left_option_key);
-	printf(&quot;ROption = 0x%02lx\n&quot;, fKeys.right_option_key);
-	printf(&quot;Menu = 0x%02lx\n&quot;, fKeys.menu_key);
-	printf(&quot;#\n&quot;
-		&quot;# Lock settings\n&quot;
-		&quot;# To set NumLock, do the following:\n&quot;
-		&quot;#   LockSettings = NumLock\n&quot;
-		&quot;#\n&quot;
-		&quot;# To set everything, do the following:\n&quot;
-		&quot;#   LockSettings = CapsLock NumLock ScrollLock\n&quot;
-		&quot;#\n&quot;);
-	printf(&quot;LockSettings = &quot;);
-	if (fKeys.lock_settings &amp; B_CAPS_LOCK)
-		printf(&quot;CapsLock &quot;);
-	if (fKeys.lock_settings &amp; B_NUM_LOCK)
-		printf(&quot;NumLock &quot;);
-	if (fKeys.lock_settings &amp; B_SCROLL_LOCK)
-		printf(&quot;ScrollLock &quot;);
-	printf(&quot;\n&quot;);
-	printf(&quot;# Legend:\n&quot;
-		&quot;#   n = Normal\n&quot;
-		&quot;#   s = Shift\n&quot;
-		&quot;#   c = Control\n&quot;
-		&quot;#   C = CapsLock\n&quot;
-		&quot;#   o = Option\n&quot;
-		&quot;# Key      n        s        c        o        os       C        Cs       Co       Cos     \n&quot;);
-
-	for (int idx = 0; idx &lt; 128; idx++) {
-		char normalKey[32];
-		char shiftKey[32];
-		char controlKey[32];
-		char optionKey[32];
-		char optionShiftKey[32];
-		char capsKey[32];
-		char capsShiftKey[32];
-		char optionCapsKey[32];
-		char optionCapsShiftKey[32];
-
-		GetKey(fChars, fKeys.normal_map[idx], normalKey);
-		GetKey(fChars, fKeys.shift_map[idx], shiftKey); 
-		GetKey(fChars, fKeys.control_map[idx], controlKey); 
-		GetKey(fChars, fKeys.option_map[idx], optionKey); 
-		GetKey(fChars, fKeys.option_shift_map[idx], optionShiftKey); 
-		GetKey(fChars, fKeys.caps_map[idx], capsKey); 
-		GetKey(fChars, fKeys.caps_shift_map[idx], capsShiftKey); 
-		GetKey(fChars, fKeys.option_caps_map[idx], optionCapsKey); 
-		GetKey(fChars, fKeys.option_caps_shift_map[idx], optionCapsShiftKey);
-
-		printf(&quot;Key 0x%02x = %-9s%-9s%-9s%-9s%-9s%-9s%-9s%-9s%-9s\n&quot;, idx, normalKey, shiftKey, controlKey,
-			optionKey, optionShiftKey, capsKey, capsShiftKey, optionCapsKey, optionCapsShiftKey); 
-	}
-
-	int32* deadOffsets[] = {
-		fKeys.acute_dead_key,
-		fKeys.grave_dead_key,
-		fKeys.circumflex_dead_key,
-		fKeys.dieresis_dead_key,
-		fKeys.tilde_dead_key
-	};
-
-	char labels[][12] = {
-		&quot;Acute&quot;,
-		&quot;Grave&quot;,
-		&quot;Circumflex&quot;,
-		&quot;Diaeresis&quot;,
-		&quot;Tilde&quot;
-	};
-
-	uint32 deadTables[] = {
-		fKeys.acute_tables,
-		fKeys.grave_tables,
-		fKeys.circumflex_tables,
-		fKeys.dieresis_tables,
-		fKeys.tilde_tables
-	};
-
-	for (int i = 0; i&lt;5; i++) {
-		for (int idx = 0; idx &lt; 32; idx++ ) {
-			char deadKey[32];
-			char secondKey[32];
-			GetKey(fChars, deadOffsets[i][idx++], deadKey);
-			GetKey(fChars, deadOffsets[i][idx], secondKey); 
-			printf(&quot;%s %-9s = %-9s\n&quot;, labels[i], deadKey, secondKey);
-		}
-
-		printf(&quot;%sTab = &quot;, labels[i]);
-
-		if (deadTables[i] &amp; B_NORMAL_TABLE)
-			printf(&quot;Normal &quot;);
-		if (deadTables[i] &amp; B_SHIFT_TABLE)
-			printf(&quot;Shift &quot;);
-		if (deadTables[i] &amp; B_CONTROL_TABLE)
-			printf(&quot;Control &quot;);
-		if (deadTables[i] &amp; B_OPTION_TABLE)
-			printf(&quot;Option &quot;);
-		if (deadTables[i] &amp; B_OPTION_SHIFT_TABLE)
-			printf(&quot;Option-Shift &quot;);
-		if (deadTables[i] &amp; B_CAPS_TABLE)
-			printf(&quot;CapsLock &quot;);
-		if (deadTables[i] &amp; B_CAPS_SHIFT_TABLE)
-			printf(&quot;CapsLock-Shift &quot;);
-		if (deadTables[i] &amp; B_OPTION_CAPS_TABLE)
-			printf(&quot;CapsLock-Option &quot;);
-		if (deadTables[i] &amp; B_OPTION_CAPS_SHIFT_TABLE)
-			printf(&quot;CapsLock-Option-Shift &quot;);
-		printf(&quot;\n&quot;);
-	}
-}
-
-
 status_t
 Keymap::LoadCurrent()
 {
 #if (defined(__BEOS__) || defined(__HAIKU__))
-	key_map *keys = NULL;
+	key_map* keys = NULL;
 	get_key_map(&amp;keys, &amp;fChars);
 	if (!keys)
 		return B_ERROR;
@@ -279,7 +221,6 @@
 	memcpy(&amp;fKeys, keys, sizeof(fKeys));
 	free(keys);
 	return B_OK;
-
 #else	// ! __BEOS__
 	fprintf(stderr, &quot;Unsupported operation on this platform!\n&quot;);
 	exit(1);
@@ -287,26 +228,32 @@
 }
 
 
-/*!
-	Load a map from a file.
+/*!	Load a map from a file.
 
 	file format in big endian:
 		struct key_map
 		uint32 size of following charset
-		charset (offsets go into this with size of character followed by character)
+		charset (offsets go into this with size of character followed by
+		  character)
 */
-status_t 
-Keymap::Load(entry_ref &amp;ref)
+status_t
+Keymap::Load(const char* name)
 {
-	status_t err;
+	FILE* file = fopen(name, &quot;r&quot;);
+	if (file == NULL)
+		return errno;
 
-	BFile file(&amp;ref, B_READ_ONLY);
-	if ((err = file.InitCheck()) != B_OK)
-		return err;
+	return Load(file);
+}
 
-	if (file.Read(&amp;fKeys, sizeof(fKeys)) &lt; (ssize_t)sizeof(fKeys))
+
+status_t
+Keymap::Load(FILE* file)
+{
+	if (fread(&amp;fKeys, sizeof(fKeys), 1, file) &lt; 1)
 		return B_BAD_VALUE;
 
+	// convert from big-endian
 	for (uint32 i = 0; i &lt; sizeof(fKeys) / 4; i++) {
 		((uint32*)&amp;fKeys)[i] = B_BENDIAN_TO_HOST_INT32(((uint32*)&amp;fKeys)[i]);
 	}
@@ -314,225 +261,59 @@
 	if (fKeys.version != 3)
 		return KEYMAP_ERROR_UNKNOWN_VERSION;
 
-	if (file.Read(&amp;fCharsSize, sizeof(uint32)) &lt; (ssize_t)sizeof(uint32))
+	if (fread(&amp;fCharsSize, sizeof(uint32), 1, file) &lt; 1)
 		return B_BAD_VALUE;
 
 	fCharsSize = B_BENDIAN_TO_HOST_INT32(fCharsSize);
-	if (!fChars)
-		delete[] fChars;
+	if (fCharsSize &gt; 16 * 1024)
+		return B_BAD_DATA;
+
+	delete[] fChars;
 	fChars = new char[fCharsSize];
-	if ((unsigned)file.Read(fChars, fCharsSize) != fCharsSize)
+
+	if (fread(fChars, 1, fCharsSize, file) != fCharsSize)
 		return B_BAD_VALUE;
 
 	return B_OK;
 }
 
 
-void
-Keymap::ComputeChars(const char *buffer, struct re_registers &amp;regs, int i, int &amp;offset)
+status_t
+Keymap::LoadSource(const char* name)
 {
-	char *current = &amp;fChars[offset + 1];
-	char hexChars[12];
-	uint32 length = 0;
-	if (strncmp(buffer + regs.start[i], &quot;''&quot;, regs.end[i] - regs.start[i]) == 0)
-		length = 0;
-	else if (sscanf(buffer + regs.start[i], &quot;'%s'&quot;, current) &gt; 0) {
-		if (current[0] == '\\')
-			current[0] = current[1];
-		else if (current[0] == '\'')
-			current[0] = ' ';
-		length = 1;
-	} else if (sscanf(buffer + regs.start[i], &quot;0x%s&quot;, hexChars) &gt; 0) {
-		length = strlen(hexChars) / 2;
-		for (uint32 j = 0; j &lt; length; j++)
-			sscanf(hexChars + 2*j, &quot;%02hhx&quot;, current + j);
-	}
-	fChars[offset] = length;
-	offset += length + 1;
-}
+	FILE* file = fopen(name, &quot;r&quot;);
+	if (file == NULL)
+		return errno;
 
+	status_t status = LoadSource(file);
+	fclose(file);
 
-void
-Keymap::ComputeTables(const char *buffer, struct re_registers &amp;regs, uint32 &amp;table)
-{
-	for (int32 i=1; i&lt;=9; i++) {
-		if (regs.end[i] - regs.start[i] &lt;= 0)
-			break;
-		if (strncmp(buffer + regs.start[i], &quot;Normal&quot;, regs.end[i] - regs.start[i]) == 0)
-			table |= B_NORMAL_TABLE;
-		else if (strncmp(buffer + regs.start[i], &quot;Shift&quot;, regs.end[i] - regs.start[i]) == 0)
-			table |= B_SHIFT_TABLE;
-		else if (strncmp(buffer + regs.start[i], &quot;Control&quot;, regs.end[i] - regs.start[i]) == 0)
-			table |= B_CONTROL_TABLE;
-		else if (strncmp(buffer + regs.start[i], &quot;Option&quot;, regs.end[i] - regs.start[i]) == 0)
-			table |= B_OPTION_TABLE;
-		else if (strncmp(buffer + regs.start[i], &quot;Option-Shift&quot;, regs.end[i] - regs.start[i]) == 0)
-			table |= B_OPTION_SHIFT_TABLE;
-		else if (strncmp(buffer + regs.start[i], &quot;CapsLock&quot;, regs.end[i] - regs.start[i]) == 0)
-			table |= B_CAPS_TABLE;
-		else if (strncmp(buffer + regs.start[i], &quot;CapsLock-Shift&quot;, regs.end[i] - regs.start[i]) == 0)
-			table |= B_CAPS_SHIFT_TABLE;
-		else if (strncmp(buffer + regs.start[i], &quot;CapsLock-Option&quot;, regs.end[i] - regs.start[i]) == 0)
-			table |= B_OPTION_CAPS_TABLE;
-		else if (strncmp(buffer + regs.start[i], &quot;CapsLock-Option-Shift&quot;, regs.end[i] - regs.start[i]) == 0)
-			table |= B_OPTION_CAPS_SHIFT_TABLE;
-	}
+	return status;
 }
 
 
-status_t 
-Keymap::LoadSourceFromRef(entry_ref &amp;ref)
+status_t
+Keymap::LoadSource(FILE* file)
 {
-	status_t err;
-	
-	BFile file(&amp;ref, B_READ_ONLY);
-	if ((err = file.InitCheck()) != B_OK)
-		return err;
-	
-	int fd = file.Dup();
-	FILE* f = fdopen(fd, &quot;r&quot;);
-	if (f != NULL) {
-		err = LoadSource(f);
-		fclose(f);
-	} else
-		err = B_FILE_ERROR;
+	// Setup regexp parser
 
-	return err;
-}
-
-
-// i couldn't put patterns and pattern bufs on the stack without segfaulting
-// regexp patterns
-const char versionPattern[] = &quot;Version[[:space:]]+=[[:space:]]+\\([[:digit:]]+\\)&quot;;
-const char capslockPattern[] = &quot;CapsLock[[:space:]]+=[[:space:]]+\\([[:alnum:]]+\\)&quot;;
-const char scrolllockPattern[] = &quot;ScrollLock[[:space:]]+=[[:space:]]+\\([[:alnum:]]+\\)&quot;;
-const char numlockPattern[] = &quot;NumLock[[:space:]]+=[[:space:]]+\\([[:alnum:]]+\\)&quot;;
-const char lshiftPattern[] = &quot;LShift[[:space:]]+=[[:space:]]+\\([[:alnum:]]+\\)&quot;;
-const char rshiftPattern[] = &quot;RShift[[:space:]]+=[[:space:]]+\\([[:alnum:]]+\\)&quot;;
-const char lcommandPattern[] = &quot;LCommand[[:space:]]+=[[:space:]]+\\([[:alnum:]]+\\)&quot;;
-const char rcommandPattern[] = &quot;RCommand[[:space:]]+=[[:space:]]+\\([[:alnum:]]+\\)&quot;;
-const char lcontrolPattern[] = &quot;LControl[[:space:]]+=[[:space:]]+\\([[:alnum:]]+\\)&quot;;
-const char rcontrolPattern[] = &quot;RControl[[:space:]]+=[[:space:]]+\\([[:alnum:]]+\\)&quot;;
-const char loptionPattern[] = &quot;LOption[[:space:]]+=[[:space:]]+\\([[:alnum:]]+\\)&quot;;
-const char roptionPattern[] = &quot;ROption[[:space:]]+=[[:space:]]+\\([[:alnum:]]+\\)&quot;;
-const char menuPattern[] = &quot;Menu[[:space:]]+=[[:space:]]+\\([[:alnum:]]+\\)&quot;;
-const char locksettingsPattern[] = &quot;LockSettings[[:space:]]+=[[:space:]]+\\([[:alnum:]]*\\)&quot;
-						&quot;[[:space:]]*\\([[:alnum:]]*\\)&quot;
-						&quot;[[:space:]]*\\([[:alnum:]]*\\)[[:space:]]*&quot;;
-const char keyPattern[] = &quot;Key[[:space:]]+\\([[:alnum:]]+\\)[[:space:]]+=&quot;
-						&quot;[[:space:]]+\\([[:alnum:]]+\\|'.*'\\)&quot;
-						&quot;[[:space:]]+\\([[:alnum:]]+\\|'.*'\\)&quot;
-						&quot;[[:space:]]+\\([[:alnum:]]+\\|'.*'\\)&quot;
-						&quot;[[:space:]]+\\([[:alnum:]]+\\|'.*'\\)&quot;
-						&quot;[[:space:]]+\\([[:alnum:]]+\\|'.*'\\)&quot;
-						&quot;[[:space:]]+\\([[:alnum:]]+\\|'.*'\\)&quot;
-						&quot;[[:space:]]+\\([[:alnum:]]+\\|'.*'\\)&quot;
-						&quot;[[:space:]]+\\([[:alnum:]]+\\|'.*'\\)&quot;
-						&quot;[[:space:]]+\\([[:alnum:]]+\\|'.*'\\)&quot;
-						&quot;[[:space:]]+&quot;;
-
-
-const char acutePattern[] = &quot;Acute[[:space:]]+\\([[:alnum:]]+\\|'.*'\\)[[:space:]]+=[[:space:]]+\\([[:alnum:]]+\\|'.*'\\)[[:space:]]+&quot;;
-const char gravePattern[] = &quot;Grave[[:space:]]+\\([[:alnum:]]+\\|'.*'\\)[[:space:]]+=[[:space:]]+\\([[:alnum:]]+\\|'.*'\\)[[:space:]]+&quot;;
-const char circumflexPattern[] = &quot;Circumflex[[:space:]]+\\([[:alnum:]]+\\|'.*'\\)[[:space:]]+=[[:space:]]+\\([[:alnum:]]+\\|'.*'\\)[[:space:]]+&quot;;
-const char diaeresisPattern[] = &quot;Diaeresis[[:space:]]+\\([[:alnum:]]+\\|'.*'\\)[[:space:]]+=[[:space:]]+\\([[:alnum:]]+\\|'.*'\\)[[:space:]]+&quot;;
-const char tildePattern[] = &quot;Tilde[[:space:]]+\\([[:alnum:]]+\\|'.*'\\)[[:space:]]+=[[:space:]]+\\([[:alnum:]]+\\|'.*'\\)[[:space:]]+&quot;;
-const char acutetabPattern[] = &quot;AcuteTab[[:space:]]+=&quot;
-						&quot;[[:space:]]+\\([[:alnum:]-]*\\)&quot;
-						&quot;[[:space:]]*\\([[:alnum:]-]*\\)&quot;
-						&quot;[[:space:]]*\\([[:alnum:]-]*\\)&quot;
-						&quot;[[:space:]]*\\([[:alnum:]-]*\\)&quot;
-						&quot;[[:space:]]*\\([[:alnum:]-]*\\)&quot;
-						&quot;[[:space:]]*\\([[:alnum:]-]*\\)&quot;
-						&quot;[[:space:]]*\\([[:alnum:]-]*\\)&quot;
-						&quot;[[:space:]]*\\([[:alnum:]-]*\\)&quot;
-						&quot;[[:space:]]*\\([[:alnum:]-]*\\)[[:space:]]*&quot; ;
-const char gravetabPattern[] = &quot;GraveTab[[:space:]]+=&quot;
-						&quot;[[:space:]]+\\([[:alnum:]-]*\\)&quot;
-						&quot;[[:space:]]*\\([[:alnum:]-]*\\)&quot;
-						&quot;[[:space:]]*\\([[:alnum:]-]*\\)&quot;
-						&quot;[[:space:]]*\\([[:alnum:]-]*\\)&quot;
-						&quot;[[:space:]]*\\([[:alnum:]-]*\\)&quot;
-						&quot;[[:space:]]*\\([[:alnum:]-]*\\)&quot;
-						&quot;[[:space:]]*\\([[:alnum:]-]*\\)&quot;
-						&quot;[[:space:]]*\\([[:alnum:]-]*\\)&quot;
-						&quot;[[:space:]]*\\([[:alnum:]-]*\\)[[:space:]]*&quot; ;
-const char circumflextabPattern[] = &quot;CircumflexTab[[:space:]]+=&quot;
-						&quot;[[:space:]]+\\([[:alnum:]-]*\\)&quot;
-						&quot;[[:space:]]*\\([[:alnum:]-]*\\)&quot;
-						&quot;[[:space:]]*\\([[:alnum:]-]*\\)&quot;
-						&quot;[[:space:]]*\\([[:alnum:]-]*\\)&quot;
-						&quot;[[:space:]]*\\([[:alnum:]-]*\\)&quot;
-						&quot;[[:space:]]*\\([[:alnum:]-]*\\)&quot;
-						&quot;[[:space:]]*\\([[:alnum:]-]*\\)&quot;
-						&quot;[[:space:]]*\\([[:alnum:]-]*\\)&quot;
-						&quot;[[:space:]]*\\([[:alnum:]-]*\\)[[:space:]]*&quot; ;
-const char diaeresistabPattern[] = &quot;DiaeresisTab[[:space:]]+=&quot;
-						&quot;[[:space:]]+\\([[:alnum:]-]*\\)&quot;
-						&quot;[[:space:]]*\\([[:alnum:]-]*\\)&quot;
-						&quot;[[:space:]]*\\([[:alnum:]-]*\\)&quot;
-						&quot;[[:space:]]*\\([[:alnum:]-]*\\)&quot;
-						&quot;[[:space:]]*\\([[:alnum:]-]*\\)&quot;
-						&quot;[[:space:]]*\\([[:alnum:]-]*\\)&quot;
-						&quot;[[:space:]]*\\([[:alnum:]-]*\\)&quot;
-						&quot;[[:space:]]*\\([[:alnum:]-]*\\)&quot;
-						&quot;[[:space:]]*\\([[:alnum:]-]*\\)[[:space:]]*&quot; ;
-const char tildetabPattern[] = &quot;TildeTab[[:space:]]+=&quot;
-						&quot;[[:space:]]+\\([[:alnum:]-]*\\)&quot;
-						&quot;[[:space:]]*\\([[:alnum:]-]*\\)&quot;
-						&quot;[[:space:]]*\\([[:alnum:]-]*\\)&quot;
-						&quot;[[:space:]]*\\([[:alnum:]-]*\\)&quot;
-						&quot;[[:space:]]*\\([[:alnum:]-]*\\)&quot;
-						&quot;[[:space:]]*\\([[:alnum:]-]*\\)&quot;
-						&quot;[[:space:]]*\\([[:alnum:]-]*\\)&quot;
-						&quot;[[:space:]]*\\([[:alnum:]-]*\\)&quot;
-						&quot;[[:space:]]*\\([[:alnum:]-]*\\)[[:space:]]*&quot; ;
-
-
-// re_pattern_buffer buffers
-struct re_pattern_buffer versionBuf;
-struct re_pattern_buffer capslockBuf;
-struct re_pattern_buffer scrolllockBuf;
-struct re_pattern_buffer numlockBuf;
-struct re_pattern_buffer lshiftBuf;
-struct re_pattern_buffer rshiftBuf;
-struct re_pattern_buffer lcommandBuf;
-struct re_pattern_buffer rcommandBuf;
-struct re_pattern_buffer lcontrolBuf;
-struct re_pattern_buffer rcontrolBuf;
-struct re_pattern_buffer loptionBuf;
-struct re_pattern_buffer roptionBuf;
-struct re_pattern_buffer menuBuf;
-struct re_pattern_buffer locksettingsBuf;
-struct re_pattern_buffer keyBuf;
-struct re_pattern_buffer acuteBuf;
-struct re_pattern_buffer graveBuf;
-struct re_pattern_buffer circumflexBuf;
-struct re_pattern_buffer diaeresisBuf;
-struct re_pattern_buffer tildeBuf;
-struct re_pattern_buffer acutetabBuf;
-struct re_pattern_buffer gravetabBuf;
-struct re_pattern_buffer circumflextabBuf;
-struct re_pattern_buffer diaeresistabBuf;
-struct re_pattern_buffer tildetabBuf;
-	
-status_t
-Keymap::LoadSource(FILE * f)
-{
 	reg_syntax_t syntax = RE_CHAR_CLASSES;
 	re_set_syntax(syntax);
-	
-	const char* error; 
-	error = re_compile_pattern(versionPattern, strlen(versionPattern), &amp;versionBuf);
+
+	const char* error = re_compile_pattern(versionPattern,
+		strlen(versionPattern), &amp;versionBuf);
 	if (error)
 		fprintf(stderr, error);
-	error = re_compile_pattern(capslockPattern, strlen(capslockPattern), &amp;capslockBuf);
+	error = re_compile_pattern(capslockPattern, strlen(capslockPattern),
+		&amp;capslockBuf);
 	if (error)
 		fprintf(stderr, error);
-	error = re_compile_pattern(scrolllockPattern, strlen(scrolllockPattern), &amp;scrolllockBuf);
+	error = re_compile_pattern(scrolllockPattern, strlen(scrolllockPattern),
+		&amp;scrolllockBuf);
 	if (error)
 		fprintf(stderr, error);
-	error = re_compile_pattern(numlockPattern, strlen(numlockPattern), &amp;numlockBuf);
+	error = re_compile_pattern(numlockPattern, strlen(numlockPattern),
+		&amp;numlockBuf);
 	if (error)
 		fprintf(stderr, error);
 	error = re_compile_pattern(lshiftPattern, strlen(lshiftPattern), &amp;lshiftBuf);
@@ -541,28 +322,35 @@
 	error = re_compile_pattern(rshiftPattern, strlen(rshiftPattern), &amp;rshiftBuf);
 	if (error)
 		fprintf(stderr, error);
-	error = re_compile_pattern(lcommandPattern, strlen(lcommandPattern), &amp;lcommandBuf);
+	error = re_compile_pattern(lcommandPattern, strlen(lcommandPattern),
+		&amp;lcommandBuf);
 	if (error)
 		fprintf(stderr, error);
-	error = re_compile_pattern(rcommandPattern, strlen(rcommandPattern), &amp;rcommandBuf);
+	error = re_compile_pattern(rcommandPattern, strlen(rcommandPattern),
+		&amp;rcommandBuf);
 	if (error)
 		fprintf(stderr, error);
-	error = re_compile_pattern(lcontrolPattern, strlen(lcontrolPattern), &amp;lcontrolBuf);
+	error = re_compile_pattern(lcontrolPattern, strlen(lcontrolPattern),
+		&amp;lcontrolBuf);
 	if (error)
 		fprintf(stderr, error);
-	error = re_compile_pattern(rcontrolPattern, strlen(rcontrolPattern), &amp;rcontrolBuf);
+	error = re_compile_pattern(rcontrolPattern, strlen(rcontrolPattern),
+		&amp;rcontrolBuf);
 	if (error)
 		fprintf(stderr, error);
-	error = re_compile_pattern(loptionPattern, strlen(loptionPattern), &amp;loptionBuf);
+	error = re_compile_pattern(loptionPattern, strlen(loptionPattern),
+		&amp;loptionBuf);
 	if (error)
 		fprintf(stderr, error);
-	error = re_compile_pattern(roptionPattern, strlen(roptionPattern), &amp;roptionBuf);
+	error = re_compile_pattern(roptionPattern, strlen(roptionPattern),
+		&amp;roptionBuf);
 	if (error)
 		fprintf(stderr, error);
 	error = re_compile_pattern(menuPattern, strlen(menuPattern), &amp;menuBuf);
 	if (error)
 		fprintf(stderr, error);
-	error = re_compile_pattern(locksettingsPattern, strlen(locksettingsPattern), &amp;locksettingsBuf);
+	error = re_compile_pattern(locksettingsPattern, strlen(locksettingsPattern),
+		&amp;locksettingsBuf);
 	if (error)
 		fprintf(stderr, error);
 	error = re_compile_pattern(keyPattern, strlen(keyPattern), &amp;keyBuf);
@@ -574,32 +362,39 @@
 	error = re_compile_pattern(gravePattern, strlen(gravePattern), &amp;graveBuf);
 	if (error)
 		fprintf(stderr, error);
-	error = re_compile_pattern(circumflexPattern, strlen(circumflexPattern), &amp;circumflexBuf);
+	error = re_compile_pattern(circumflexPattern, strlen(circumflexPattern),
+		&amp;circumflexBuf);
 	if (error)
 		fprintf(stderr, error);
-	error = re_compile_pattern(diaeresisPattern, strlen(diaeresisPattern), &amp;diaeresisBuf);
+	error = re_compile_pattern(diaeresisPattern, strlen(diaeresisPattern),
+		&amp;diaeresisBuf);
 	if (error)
 		fprintf(stderr, error);
 	error = re_compile_pattern(tildePattern, strlen(tildePattern), &amp;tildeBuf);
 	if (error)
 		fprintf(stderr, error);
-	error = re_compile_pattern(acutetabPattern, strlen(acutetabPattern), &amp;acutetabBuf);
+	error = re_compile_pattern(acutetabPattern, strlen(acutetabPattern),
+		&amp;acutetabBuf);
 	if (error)
 		fprintf(stderr, error);
-	error = re_compile_pattern(gravetabPattern, strlen(gravetabPattern), &amp;gravetabBuf);
+	error = re_compile_pattern(gravetabPattern, strlen(gravetabPattern),
+		&amp;gravetabBuf);
 	if (error)
 		fprintf(stderr, error);
-	error = re_compile_pattern(circumflextabPattern, strlen(circumflextabPattern), &amp;circumflextabBuf);
+	error = re_compile_pattern(circumflextabPattern,
+		strlen(circumflextabPattern), &amp;circumflextabBuf);
 	if (error)
 		fprintf(stderr, error);
-	error = re_compile_pattern(diaeresistabPattern, strlen(diaeresistabPattern), &amp;diaeresistabBuf);
+	error = re_compile_pattern(diaeresistabPattern, strlen(diaeresistabPattern),
+		&amp;diaeresistabBuf);
 	if (error)
 		fprintf(stderr, error);
-	error = re_compile_pattern(tildetabPattern, strlen(tildetabPattern), &amp;tildetabBuf);
+	error = re_compile_pattern(tildetabPattern, strlen(tildetabPattern),
+		&amp;tildetabBuf);
 	if (error)
 		fprintf(stderr, error);
 
-	char buffer[1024];
+	// Read file
 
 	delete[] fChars;
 	fChars = new char[CHARS_TABLE_MAXSIZE];
@@ -611,7 +406,7 @@
 	int diaeresisOffset = 0;
 	int tildeOffset = 0;
 
-	int32 *maps[] = {
+	int32* maps[] = {
 		fKeys.normal_map,
 		fKeys.shift_map,
 		fKeys.control_map,
@@ -623,93 +418,118 @@
 		fKeys.option_caps_shift_map
 	};
 
-	while (fgets(buffer, 1024-1, f) != NULL) {
+	char buffer[1024];
+
+	while (fgets(buffer, sizeof(buffer) - 1, file) != NULL) {
 		if (buffer[0] == '#' || buffer[0] == '\n')
 			continue;
 
+		size_t length = strlen(buffer);
+
 		struct re_registers regs;
-		if (re_search(&amp;versionBuf, buffer, strlen(buffer), 0, strlen(buffer), &amp;regs) &gt;= 0) {
+		if (re_search(&amp;versionBuf, buffer, length, 0, length, &amp;regs) &gt;= 0) {
 			sscanf(buffer + regs.start[1], &quot;%ld&quot;, &amp;fKeys.version);
-		} else if (re_search(&amp;capslockBuf, buffer, strlen(buffer), 0, strlen(buffer), &amp;regs) &gt;= 0) {
+		} else if (re_search(&amp;capslockBuf, buffer, length, 0, length, &amp;regs)
+				&gt;= 0) {
 			sscanf(buffer + regs.start[1], &quot;0x%lx&quot;, &amp;fKeys.caps_key);
-		} else if (re_search(&amp;scrolllockBuf, buffer, strlen(buffer), 0, strlen(buffer), &amp;regs) &gt;= 0) {
+		} else if (re_search(&amp;scrolllockBuf, buffer, length, 0, length, &amp;regs)
+				&gt;= 0) {
 			sscanf(buffer + regs.start[1], &quot;0x%lx&quot;, &amp;fKeys.scroll_key);
-		} else if (re_search(&amp;numlockBuf, buffer, strlen(buffer), 0, strlen(buffer), &amp;regs) &gt;= 0) {
+		} else if (re_search(&amp;numlockBuf, buffer, length, 0, length, &amp;regs)
+				&gt;= 0) {
 			sscanf(buffer + regs.start[1], &quot;0x%lx&quot;, &amp;fKeys.num_key);
-		} else if (re_search(&amp;lshiftBuf, buffer, strlen(buffer), 0, strlen(buffer), &amp;regs) &gt;= 0) {
+		} else if (re_search(&amp;lshiftBuf, buffer, length, 0, length, &amp;regs)
+				&gt;= 0) {
 			sscanf(buffer + regs.start[1], &quot;0x%lx&quot;, &amp;fKeys.left_shift_key);
-		} else if (re_search(&amp;rshiftBuf, buffer, strlen(buffer), 0, strlen(buffer), &amp;regs) &gt;= 0) {
+		} else if (re_search(&amp;rshiftBuf, buffer, length, 0, length, &amp;regs)
+				&gt;= 0) {
 			sscanf(buffer + regs.start[1], &quot;0x%lx&quot;, &amp;fKeys.right_shift_key);
-		} else if (re_search(&amp;lcommandBuf, buffer, strlen(buffer), 0, strlen(buffer), &amp;regs) &gt;= 0) {
+		} else if (re_search(&amp;lcommandBuf, buffer, length, 0, length, &amp;regs)
+				&gt;= 0) {
 			sscanf(buffer + regs.start[1], &quot;0x%lx&quot;, &amp;fKeys.left_command_key);
-		} else if (re_search(&amp;rcommandBuf, buffer, strlen(buffer), 0, strlen(buffer), &amp;regs) &gt;= 0) {
+		} else if (re_search(&amp;rcommandBuf, buffer, length, 0, length, &amp;regs)
+				&gt;= 0) {
 			sscanf(buffer + regs.start[1], &quot;0x%lx&quot;, &amp;fKeys.right_command_key);
-		} else if (re_search(&amp;lcontrolBuf, buffer, strlen(buffer), 0, strlen(buffer), &amp;regs) &gt;= 0) {
+		} else if (re_search(&amp;lcontrolBuf, buffer, length, 0, length, &amp;regs)
+				&gt;= 0) {
 			sscanf(buffer + regs.start[1], &quot;0x%lx&quot;, &amp;fKeys.left_control_key);
-		} else if (re_search(&amp;rcontrolBuf, buffer, strlen(buffer), 0, strlen(buffer), &amp;regs) &gt;= 0) {
+		} else if (re_search(&amp;rcontrolBuf, buffer, length, 0, length, &amp;regs)
+				&gt;= 0) {
 			sscanf(buffer + regs.start[1], &quot;0x%lx&quot;, &amp;fKeys.right_control_key);
-		} else if (re_search(&amp;loptionBuf, buffer, strlen(buffer), 0, strlen(buffer), &amp;regs) &gt;= 0) {
+		} else if (re_search(&amp;loptionBuf, buffer, length, 0, length, &amp;regs)
+				&gt;= 0) {
 			sscanf(buffer + regs.start[1], &quot;0x%lx&quot;, &amp;fKeys.left_option_key);
-		} else if (re_search(&amp;roptionBuf, buffer, strlen(buffer), 0, strlen(buffer), &amp;regs) &gt;= 0) {
+		} else if (re_search(&amp;roptionBuf, buffer, length, 0, length, &amp;regs)
+				&gt;= 0) {
 			sscanf(buffer + regs.start[1], &quot;0x%lx&quot;, &amp;fKeys.right_option_key);
-		} else if (re_search(&amp;menuBuf, buffer, strlen(buffer), 0, strlen(buffer), &amp;regs) &gt;= 0) {
+		} else if (re_search(&amp;menuBuf, buffer, length, 0, length, &amp;regs) &gt;= 0) {
 			sscanf(buffer + regs.start[1], &quot;0x%lx&quot;, &amp;fKeys.menu_key);
-		} else if (re_search(&amp;locksettingsBuf, buffer, strlen(buffer), 0, strlen(buffer), &amp;regs) &gt;= 0) {
+		} else if (re_search(&amp;locksettingsBuf, buffer, length, 0, length, &amp;regs)
+				&gt;= 0) {
 			fKeys.lock_settings = 0;
 			for (int32 i = 1; i &lt;= 3; i++) {
-				if (regs.end[i] - regs.start[i] &lt;= 0)
+				const char* start = buffer + regs.start[i];
+				length = regs.end[i] - regs.start[i];
+				if (length == 0)
 					break;
 
-				if (strncmp(buffer + regs.start[i], &quot;CapsLock&quot;, regs.end[i] - regs.start[i]) == 0)
+				if (!strncmp(start, &quot;CapsLock&quot;, length))
 					fKeys.lock_settings |= B_CAPS_LOCK;
-				else if (strncmp(buffer + regs.start[i], &quot;NumLock&quot;, regs.end[i] - regs.start[i]) == 0)
+				else if (!strncmp(start, &quot;NumLock&quot;, length))
 					fKeys.lock_settings |= B_NUM_LOCK;
-				else if (strncmp(buffer + regs.start[i], &quot;ScrollLock&quot;, regs.end[i] - regs.start[i]) == 0)
+				else if (!strncmp(start, &quot;ScrollLock&quot;, length))
 					fKeys.lock_settings |= B_SCROLL_LOCK;
 			}
-		} else if (re_search(&amp;keyBuf, buffer, strlen(buffer), 0, strlen(buffer), &amp;regs) &gt;= 0) {
-			uint32 keyCode; 
+		} else if (re_search(&amp;keyBuf, buffer, length, 0, length, &amp;regs) &gt;= 0) {
+			uint32 keyCode;
 			if (sscanf(buffer + regs.start[1], &quot;0x%lx&quot;, &amp;keyCode) &gt; 0) {
 				for (int i = 2; i &lt;= 10; i++) {
 					maps[i - 2][keyCode] = offset;
-					ComputeChars(buffer, regs, i, offset);
+					_ComputeChars(buffer, regs, i, offset);
 				}
 			}
-		} else if (re_search(&amp;acuteBuf, buffer, strlen(buffer), 0, strlen(buffer), &amp;regs) &gt;= 0) {
+		} else if (re_search(&amp;acuteBuf, buffer, length, 0, length, &amp;regs) &gt;= 0) {
 			for (int i = 1; i &lt;= 2; i++) {
-				fKeys.acute_dead_key[acuteOffset++] = offset;		
-				ComputeChars(buffer, regs, i, offset);
+				fKeys.acute_dead_key[acuteOffset++] = offset;
+				_ComputeChars(buffer, regs, i, offset);
 			}
-		} else if (re_search(&amp;graveBuf, buffer, strlen(buffer), 0, strlen(buffer), &amp;regs) &gt;= 0) {
+		} else if (re_search(&amp;graveBuf, buffer, length, 0, length, &amp;regs) &gt;= 0) {
 			for (int i = 1; i &lt;= 2; i++) {
-				fKeys.grave_dead_key[graveOffset++] = offset;		
-				ComputeChars(buffer, regs, i, offset);
+				fKeys.grave_dead_key[graveOffset++] = offset;
+				_ComputeChars(buffer, regs, i, offset);
 			}
-		} else if (re_search(&amp;circumflexBuf, buffer, strlen(buffer), 0, strlen(buffer), &amp;regs) &gt;= 0) {
+		} else if (re_search(&amp;circumflexBuf, buffer, length, 0, length, &amp;regs)
+				&gt;= 0) {
 			for (int i = 1; i &lt;= 2; i++) {
-				fKeys.circumflex_dead_key[circumflexOffset++] = offset;		
-				ComputeChars(buffer, regs, i, offset);
+				fKeys.circumflex_dead_key[circumflexOffset++] = offset;
+				_ComputeChars(buffer, regs, i, offset);
 			}
-		} else if (re_search(&amp;diaeresisBuf, buffer, strlen(buffer), 0, strlen(buffer), &amp;regs) &gt;= 0) {
+		} else if (re_search(&amp;diaeresisBuf, buffer, length, 0, length, &amp;regs)
+				&gt;= 0) {
 			for (int i = 1; i &lt;= 2; i++) {
-				fKeys.dieresis_dead_key[diaeresisOffset++] = offset;		
-				ComputeChars(buffer, regs, i, offset);
+				fKeys.dieresis_dead_key[diaeresisOffset++] = offset;
+				_ComputeChars(buffer, regs, i, offset);
 			}
-		} else if (re_search(&amp;tildeBuf, buffer, strlen(buffer), 0, strlen(buffer), &amp;regs) &gt;= 0) {
+		} else if (re_search(&amp;tildeBuf, buffer, length, 0, length, &amp;regs) &gt;= 0) {
 			for (int i = 1; i &lt;= 2; i++) {
-				fKeys.tilde_dead_key[tildeOffset++] = offset;		
-				ComputeChars(buffer, regs, i, offset);
+				fKeys.tilde_dead_key[tildeOffset++] = offset;
+				_ComputeChars(buffer, regs, i, offset);
 			}
-		} else if (re_search(&amp;acutetabBuf, buffer, strlen(buffer), 0, strlen(buffer), &amp;regs) &gt;= 0) {
-			ComputeTables(buffer, regs, fKeys.acute_tables);
-		} else if (re_search(&amp;gravetabBuf, buffer, strlen(buffer), 0, strlen(buffer), &amp;regs) &gt;= 0) {
-			ComputeTables(buffer, regs, fKeys.grave_tables);
-		} else if (re_search(&amp;circumflextabBuf, buffer, strlen(buffer), 0, strlen(buffer), &amp;regs) &gt;= 0) {
-			ComputeTables(buffer, regs, fKeys.circumflex_tables);
-		} else if (re_search(&amp;diaeresistabBuf, buffer, strlen(buffer), 0, strlen(buffer), &amp;regs) &gt;= 0) {
-			ComputeTables(buffer, regs, fKeys.dieresis_tables);
-		} else if (re_search(&amp;tildetabBuf, buffer, strlen(buffer), 0, strlen(buffer), &amp;regs) &gt;= 0) {
-			ComputeTables(buffer, regs, fKeys.tilde_tables);
+		} else if (re_search(&amp;acutetabBuf, buffer, length, 0, length, &amp;regs)
+				&gt;= 0) {
+			_ComputeTables(buffer, regs, fKeys.acute_tables);
+		} else if (re_search(&amp;gravetabBuf, buffer, length, 0, length, &amp;regs)
+				&gt;= 0) {
+			_ComputeTables(buffer, regs, fKeys.grave_tables);
+		} else if (re_search(&amp;circumflextabBuf, buffer, length, 0, length, &amp;regs)
+				&gt;= 0) {
+			_ComputeTables(buffer, regs, fKeys.circumflex_tables);
+		} else if (re_search(&amp;diaeresistabBuf, buffer, length, 0, length, &amp;regs)
+				&gt;= 0) {
+			_ComputeTables(buffer, regs, fKeys.dieresis_tables);
+		} else if (re_search(&amp;tildetabBuf, buffer, length, 0, length, &amp;regs)
+				&gt;= 0) {
+			_ComputeTables(buffer, regs, fKeys.tilde_tables);
 		}
 	}
 
@@ -720,18 +540,42 @@
 
 	return B_OK;
 }
-	
 
-//! we save a map to a file
-status_t 
-Keymap::Save(entry_ref &amp;ref)
+
+status_t
+Keymap::SaveAsCurrent()
 {
-	status_t err;
+#if (defined(__BEOS__) || defined(__HAIKU__))
+	BPath path;
+	status_t status = find_directory(B_USER_SETTINGS_DIRECTORY, &amp;path, true);
+	if (status != B_OK)
+		return status;
 
-	BFile file(&amp;ref, B_WRITE_ONLY | B_CREATE_FILE | B_ERASE_FILE );
-	if ((err = file.InitCheck()) != B_OK)
-		return err;
+	path.Append(&quot;Key_map&quot;);
 
+	status = Save(path.Path());
+	if (status != B_OK)
+		return status;
+
+	Use();
+	return B_OK;
+#else	// ! __BEOS__
+	fprintf(stderr, &quot;Unsupported operation on this platform!\n&quot;);
+	exit(1);
+#endif	// ! __BEOS__
+}
+
+
+//! Save a binary keymap to a file.
+status_t
+Keymap::Save(const char* name)
+{
+	BFile file;
+	status_t status = file.SetTo(name,
+		B_WRITE_ONLY | B_CREATE_FILE | B_ERASE_FILE);
+	if (status != B_OK)

[... truncated: 1088 lines follow ...]

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="017411.html">[Haiku-commits] r31194 - in haiku/trunk: headers/private/kernel	src/system/kernel src/system/kernel/debug
</A></li>
	<LI>Next message: <A HREF="017413.html">[Haiku-commits] r31196 - haiku/trunk/src/bin/keymap
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#17412">[ date ]</a>
              <a href="thread.html#17412">[ thread ]</a>
              <a href="subject.html#17412">[ subject ]</a>
              <a href="author.html#17412">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/haiku-commits">More information about the Haiku-commits
mailing list</a><br>
</body></html>
