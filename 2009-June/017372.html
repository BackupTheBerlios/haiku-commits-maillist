<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Haiku-commits] r31164 - in haiku/branches/components/gallium3d:	build/jam src/add-ons/opengl src/add-ons/opengl/softpipe	src/add-ons/opengl/trace
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/haiku-commits/2009-June/index.html" >
   <LINK REL="made" HREF="mailto:haiku-commits%40lists.berlios.de?Subject=Re%3A%20%5BHaiku-commits%5D%20r31164%20-%20in%20haiku/branches/components/gallium3d%3A%0A%09build/jam%20src/add-ons/opengl%20src/add-ons/opengl/softpipe%0A%09src/add-ons/opengl/trace&In-Reply-To=%3C200906212130.n5LLUa25031684%40sheep.berlios.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="017371.html">
   <LINK REL="Next"  HREF="017373.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Haiku-commits] r31164 - in haiku/branches/components/gallium3d:	build/jam src/add-ons/opengl src/add-ons/opengl/softpipe	src/add-ons/opengl/trace</H1>
    <B>aljen at mail.berlios.de</B> 
    <A HREF="mailto:haiku-commits%40lists.berlios.de?Subject=Re%3A%20%5BHaiku-commits%5D%20r31164%20-%20in%20haiku/branches/components/gallium3d%3A%0A%09build/jam%20src/add-ons/opengl%20src/add-ons/opengl/softpipe%0A%09src/add-ons/opengl/trace&In-Reply-To=%3C200906212130.n5LLUa25031684%40sheep.berlios.de%3E"
       TITLE="[Haiku-commits] r31164 - in haiku/branches/components/gallium3d:	build/jam src/add-ons/opengl src/add-ons/opengl/softpipe	src/add-ons/opengl/trace">aljen at mail.berlios.de
       </A><BR>
    <I>Sun Jun 21 23:30:36 CEST 2009</I>
    <P><UL>
        <LI>Previous message: <A HREF="017371.html">[Haiku-commits] r31163 - in haiku/branches/components/gallium3d: headers/os/opengl/GL headers/private/opengl/GL/internal src/kits/opengl src/kits/opengl/mesa src/kits/opengl/mesa/drivers/common src/kits/opengl/mesa/gallium src/kits/opengl/mesa/gallium/auxiliary src/kits/opengl/mesa/gallium/auxiliary/cso_cache src/kits/opengl/mesa/gallium/auxiliary/draw src/kits/opengl/mesa/gallium/auxiliary/gallivm src/kits/opengl/mesa/gallium/auxiliary/indices src/kits/opengl/mesa/gallium/auxiliary/pipebuffer src/kits/opengl/mesa/gallium/auxiliary/rtasm src/kits/opengl/mesa/gallium/auxiliary/sct src/kits/opengl/mesa/gallium/auxiliary/tgsi src/kits/opengl/mesa/gallium/auxiliary/translate src/kits/opengl/mesa/gallium/auxiliary/util src/kits/opengl/mesa/gallium/include src/kits/opengl/mesa/gallium/include/pipe src/kits/opengl/mesa/gallium/include/pipe/internal src/kits/opengl/mesa/gallium/include/state_tracker src/kits/opengl/mesa/glapi src/kits/opengl/mesa/main src/kits/opengl/mesa/math src/kits/ope! ngl/mesa/ppc src/kits/opengl/mesa/shader src/kits/opengl/mesa/shader/slang src/kits/opengl/mesa/shader/slang/library src/kits/opengl/mesa/sparc src/kits/opengl/mesa/state_tracker src/kits/opengl/mesa/swrast src/kits/opengl/mesa/swrast_setup src/kits/opengl/mesa/tnl src/kits/opengl/mesa/tnl_dd src/kits/opengl/mesa/vbo src/kits/opengl/mesa/x86 src/kits/opengl/mesa/x86/rtasm src/kits/opengl/mesa/x86-64
</A></li>
        <LI>Next message: <A HREF="017373.html">[Haiku-commits] r31165 - in haiku/trunk/src/servers/app: .	drawing/Painter
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#17372">[ date ]</a>
              <a href="thread.html#17372">[ thread ]</a>
              <a href="subject.html#17372">[ subject ]</a>
              <a href="author.html#17372">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: aljen
Date: 2009-06-21 23:29:57 +0200 (Sun, 21 Jun 2009)
New Revision: 31164
ViewCVS: <A HREF="http://svn.berlios.de/viewcvs/haiku?rev=31164&amp;view=rev">http://svn.berlios.de/viewcvs/haiku?rev=31164&amp;view=rev</A>

Added:
   haiku/branches/components/gallium3d/src/add-ons/opengl/softpipe/
   haiku/branches/components/gallium3d/src/add-ons/opengl/softpipe/Jamfile
   haiku/branches/components/gallium3d/src/add-ons/opengl/softpipe/SoftPipeRenderer.cpp
   haiku/branches/components/gallium3d/src/add-ons/opengl/softpipe/SoftPipeRenderer.h
   haiku/branches/components/gallium3d/src/add-ons/opengl/softpipe/haiku_softpipe_winsys.c
   haiku/branches/components/gallium3d/src/add-ons/opengl/softpipe/haiku_softpipe_winsys.h
   haiku/branches/components/gallium3d/src/add-ons/opengl/softpipe/hsp_bitmap_wrapper.cpp
   haiku/branches/components/gallium3d/src/add-ons/opengl/softpipe/hsp_bitmap_wrapper.h
   haiku/branches/components/gallium3d/src/add-ons/opengl/softpipe/hsp_context.c
   haiku/branches/components/gallium3d/src/add-ons/opengl/softpipe/hsp_context.h
   haiku/branches/components/gallium3d/src/add-ons/opengl/softpipe/hsp_device.c
   haiku/branches/components/gallium3d/src/add-ons/opengl/softpipe/hsp_device.h
   haiku/branches/components/gallium3d/src/add-ons/opengl/softpipe/hsp_framebuffer.c
   haiku/branches/components/gallium3d/src/add-ons/opengl/softpipe/hsp_framebuffer.h
   haiku/branches/components/gallium3d/src/add-ons/opengl/softpipe/hsp_getprocaddress.c
   haiku/branches/components/gallium3d/src/add-ons/opengl/softpipe/hsp_public.h
   haiku/branches/components/gallium3d/src/add-ons/opengl/softpipe/hsp_winsys.h
   haiku/branches/components/gallium3d/src/add-ons/opengl/softpipe/sp_clear.c
   haiku/branches/components/gallium3d/src/add-ons/opengl/softpipe/sp_clear.h
   haiku/branches/components/gallium3d/src/add-ons/opengl/softpipe/sp_context.c
   haiku/branches/components/gallium3d/src/add-ons/opengl/softpipe/sp_context.h
   haiku/branches/components/gallium3d/src/add-ons/opengl/softpipe/sp_draw_arrays.c
   haiku/branches/components/gallium3d/src/add-ons/opengl/softpipe/sp_flush.c
   haiku/branches/components/gallium3d/src/add-ons/opengl/softpipe/sp_flush.h
   haiku/branches/components/gallium3d/src/add-ons/opengl/softpipe/sp_fs.h
   haiku/branches/components/gallium3d/src/add-ons/opengl/softpipe/sp_fs_exec.c
   haiku/branches/components/gallium3d/src/add-ons/opengl/softpipe/sp_fs_llvm.c
   haiku/branches/components/gallium3d/src/add-ons/opengl/softpipe/sp_fs_sse.c
   haiku/branches/components/gallium3d/src/add-ons/opengl/softpipe/sp_prim_setup.c
   haiku/branches/components/gallium3d/src/add-ons/opengl/softpipe/sp_prim_setup.h
   haiku/branches/components/gallium3d/src/add-ons/opengl/softpipe/sp_prim_vbuf.c
   haiku/branches/components/gallium3d/src/add-ons/opengl/softpipe/sp_prim_vbuf.h
   haiku/branches/components/gallium3d/src/add-ons/opengl/softpipe/sp_quad.h
   haiku/branches/components/gallium3d/src/add-ons/opengl/softpipe/sp_quad_alpha_test.c
   haiku/branches/components/gallium3d/src/add-ons/opengl/softpipe/sp_quad_blend.c
   haiku/branches/components/gallium3d/src/add-ons/opengl/softpipe/sp_quad_bufloop.c
   haiku/branches/components/gallium3d/src/add-ons/opengl/softpipe/sp_quad_colormask.c
   haiku/branches/components/gallium3d/src/add-ons/opengl/softpipe/sp_quad_coverage.c
   haiku/branches/components/gallium3d/src/add-ons/opengl/softpipe/sp_quad_depth_test.c
   haiku/branches/components/gallium3d/src/add-ons/opengl/softpipe/sp_quad_earlyz.c
   haiku/branches/components/gallium3d/src/add-ons/opengl/softpipe/sp_quad_fs.c
   haiku/branches/components/gallium3d/src/add-ons/opengl/softpipe/sp_quad_occlusion.c
   haiku/branches/components/gallium3d/src/add-ons/opengl/softpipe/sp_quad_output.c
   haiku/branches/components/gallium3d/src/add-ons/opengl/softpipe/sp_quad_pipe.c
   haiku/branches/components/gallium3d/src/add-ons/opengl/softpipe/sp_quad_pipe.h
   haiku/branches/components/gallium3d/src/add-ons/opengl/softpipe/sp_quad_stencil.c
   haiku/branches/components/gallium3d/src/add-ons/opengl/softpipe/sp_quad_stipple.c
   haiku/branches/components/gallium3d/src/add-ons/opengl/softpipe/sp_query.c
   haiku/branches/components/gallium3d/src/add-ons/opengl/softpipe/sp_query.h
   haiku/branches/components/gallium3d/src/add-ons/opengl/softpipe/sp_screen.c
   haiku/branches/components/gallium3d/src/add-ons/opengl/softpipe/sp_screen.h
   haiku/branches/components/gallium3d/src/add-ons/opengl/softpipe/sp_setup.c
   haiku/branches/components/gallium3d/src/add-ons/opengl/softpipe/sp_setup.h
   haiku/branches/components/gallium3d/src/add-ons/opengl/softpipe/sp_state.h
   haiku/branches/components/gallium3d/src/add-ons/opengl/softpipe/sp_state_blend.c
   haiku/branches/components/gallium3d/src/add-ons/opengl/softpipe/sp_state_clip.c
   haiku/branches/components/gallium3d/src/add-ons/opengl/softpipe/sp_state_derived.c
   haiku/branches/components/gallium3d/src/add-ons/opengl/softpipe/sp_state_fs.c
   haiku/branches/components/gallium3d/src/add-ons/opengl/softpipe/sp_state_rasterizer.c
   haiku/branches/components/gallium3d/src/add-ons/opengl/softpipe/sp_state_sampler.c
   haiku/branches/components/gallium3d/src/add-ons/opengl/softpipe/sp_state_surface.c
   haiku/branches/components/gallium3d/src/add-ons/opengl/softpipe/sp_state_vertex.c
   haiku/branches/components/gallium3d/src/add-ons/opengl/softpipe/sp_surface.c
   haiku/branches/components/gallium3d/src/add-ons/opengl/softpipe/sp_surface.h
   haiku/branches/components/gallium3d/src/add-ons/opengl/softpipe/sp_tex_sample.c
   haiku/branches/components/gallium3d/src/add-ons/opengl/softpipe/sp_tex_sample.h
   haiku/branches/components/gallium3d/src/add-ons/opengl/softpipe/sp_texture.c
   haiku/branches/components/gallium3d/src/add-ons/opengl/softpipe/sp_texture.h
   haiku/branches/components/gallium3d/src/add-ons/opengl/softpipe/sp_tile_cache.c
   haiku/branches/components/gallium3d/src/add-ons/opengl/softpipe/sp_tile_cache.h
   haiku/branches/components/gallium3d/src/add-ons/opengl/softpipe/sp_winsys.h
   haiku/branches/components/gallium3d/src/add-ons/opengl/trace/
   haiku/branches/components/gallium3d/src/add-ons/opengl/trace/tr_buffer.c
   haiku/branches/components/gallium3d/src/add-ons/opengl/trace/tr_buffer.h
   haiku/branches/components/gallium3d/src/add-ons/opengl/trace/tr_context.c
   haiku/branches/components/gallium3d/src/add-ons/opengl/trace/tr_context.h
   haiku/branches/components/gallium3d/src/add-ons/opengl/trace/tr_dump.c
   haiku/branches/components/gallium3d/src/add-ons/opengl/trace/tr_dump.h
   haiku/branches/components/gallium3d/src/add-ons/opengl/trace/tr_dump_state.c
   haiku/branches/components/gallium3d/src/add-ons/opengl/trace/tr_dump_state.h
   haiku/branches/components/gallium3d/src/add-ons/opengl/trace/tr_rbug.c
   haiku/branches/components/gallium3d/src/add-ons/opengl/trace/tr_screen.c
   haiku/branches/components/gallium3d/src/add-ons/opengl/trace/tr_screen.h
   haiku/branches/components/gallium3d/src/add-ons/opengl/trace/tr_state.c
   haiku/branches/components/gallium3d/src/add-ons/opengl/trace/tr_state.h
   haiku/branches/components/gallium3d/src/add-ons/opengl/trace/tr_texture.c
   haiku/branches/components/gallium3d/src/add-ons/opengl/trace/tr_texture.h
Removed:
   haiku/branches/components/gallium3d/src/add-ons/opengl/mesa_software_renderer/
   haiku/branches/components/gallium3d/src/add-ons/opengl/nvidia/
   haiku/branches/components/gallium3d/src/add-ons/opengl/radeon/
Modified:
   haiku/branches/components/gallium3d/build/jam/HaikuImage
   haiku/branches/components/gallium3d/src/add-ons/opengl/Jamfile
Log:
Added software renderer and enable it by default.

Notice: remove old /boot/system/add-ons/opengl/Mesa\ Software\ Renderer



Modified: haiku/branches/components/gallium3d/build/jam/HaikuImage
===================================================================
--- haiku/branches/components/gallium3d/build/jam/HaikuImage	2009-06-21 21:15:24 UTC (rev 31163)
+++ haiku/branches/components/gallium3d/build/jam/HaikuImage	2009-06-21 21:29:57 UTC (rev 31164)
@@ -456,7 +456,7 @@
 AddFilesToHaikuImage system add-ons accelerants
 	: $(SYSTEM_ADD_ONS_ACCELERANTS) ;
 AddFilesToHaikuImage system add-ons opengl
-	: Mesa\ Software\ Renderer ;
+	: SoftPipe ;
 AddFilesToHaikuHybridImage system add-ons Translators
 	: $(SYSTEM_ADD_ONS_TRANSLATORS) : : true ;
 AddFilesToHaikuImage system add-ons mail_daemon inbound_protocols : POP3 IMAP ;

Modified: haiku/branches/components/gallium3d/src/add-ons/opengl/Jamfile
===================================================================
--- haiku/branches/components/gallium3d/src/add-ons/opengl/Jamfile	2009-06-21 21:15:24 UTC (rev 31163)
+++ haiku/branches/components/gallium3d/src/add-ons/opengl/Jamfile	2009-06-21 21:29:57 UTC (rev 31164)
@@ -1,6 +1,3 @@
 SubDir HAIKU_TOP src add-ons opengl ;
 
-SubInclude HAIKU_TOP src add-ons opengl mesa_software_renderer ;
-# SubInclude HAIKU_TOP src add-ons opengl nvidia ;
-# SubInclude HAIKU_TOP src add-ons opengl radeon ;
-
+SubInclude HAIKU_TOP src add-ons opengl softpipe ;
\ No newline at end of file

Added: haiku/branches/components/gallium3d/src/add-ons/opengl/softpipe/Jamfile
===================================================================
--- haiku/branches/components/gallium3d/src/add-ons/opengl/softpipe/Jamfile	2009-06-21 21:15:24 UTC (rev 31163)
+++ haiku/branches/components/gallium3d/src/add-ons/opengl/softpipe/Jamfile	2009-06-21 21:29:57 UTC (rev 31164)
@@ -0,0 +1,85 @@
+SubDir HAIKU_TOP src add-ons opengl softpipe ;
+
+SetSubDirSupportedPlatformsBeOSCompatible ;
+
+if $(TARGET_PLATFORM) != haiku {
+	UseHeaders [ FDirName $(HAIKU_TOP) headers os opengl ] : true ;
+		# We need our public GL headers also when not compiling for Haiku.
+}
+
+
+{
+	local defines ;
+	defines = BEOS_THREADS GNU_ASSEMBLER ;
+
+	if $(TARGET_ARCH) = x86 {
+		defines += USE_X86_ASM USE_MMX_ASM USE_3DNOW_ASM USE_SSE_ASM ; 
+	} else {
+		# Not yet supported, as current Mesa3D PPC assembly is Linux-dependent!
+		# defines += USE_PPC_ASM ;
+	}
+
+	SubDirC++Flags [ FDefines $(defines) ] ;
+}
+
+UsePrivateHeaders interface opengl ;
+
+UseHeaders [ FDirName $(HAIKU_TOP) src add-ons opengl trace ] ;
+UseHeaders [ FDirName $(HAIKU_TOP) src kits opengl hgl ] ;
+UseHeaders [ FDirName $(HAIKU_TOP) src kits opengl mesa ] ;
+UseHeaders [ FDirName $(HAIKU_TOP) src kits opengl mesa main ] ;
+UseHeaders [ FDirName $(HAIKU_TOP) src kits opengl mesa gallium include ] ;
+UseHeaders [ FDirName $(HAIKU_TOP) src kits opengl mesa gallium auxiliary ] ;
+UseHeaders [ FDirName $(HAIKU_TOP) src kits opengl mesa glapi ] ;
+UseHeaders [ FDirName $(HAIKU_TOP) src kits opengl mesa tnl ] ;
+UseHeaders [ FDirName $(HAIKU_TOP) src kits opengl mesa x86 ] ;
+UseHeaders [ FDirName $(HAIKU_TOP) src kits opengl mesa ppc ] ;
+
+Addon SoftPipe :
+	SoftPipeRenderer.cpp
+	hsp_bitmap_wrapper.cpp
+	haiku_softpipe_winsys.c
+	hsp_context.c
+	hsp_device.c
+	hsp_framebuffer.c
+	hsp_getprocaddress.c
+#	hsp_pixelformat.c
+	sp_clear.c
+	sp_context.c
+	sp_draw_arrays.c
+	sp_flush.c
+	sp_fs_exec.c
+	sp_fs_llvm.c
+	sp_fs_sse.c
+	sp_prim_setup.c
+	sp_prim_vbuf.c
+	sp_quad_alpha_test.c
+	sp_quad_blend.c
+#	sp_quad_bufloop.c
+	sp_quad_colormask.c
+	sp_quad_coverage.c
+	sp_quad_depth_test.c
+	sp_quad_earlyz.c
+	sp_quad_fs.c
+	sp_quad_occlusion.c
+	sp_quad_output.c
+	sp_quad_pipe.c
+	sp_quad_stencil.c
+	sp_quad_stipple.c
+	sp_query.c
+	sp_screen.c
+	sp_setup.c
+	sp_state_blend.c
+	sp_state_clip.c
+	sp_state_derived.c
+	sp_state_fs.c
+	sp_state_rasterizer.c
+	sp_state_sampler.c
+	sp_state_surface.c
+	sp_state_vertex.c
+	sp_surface.c
+	sp_tex_sample.c
+	sp_texture.c
+	sp_tile_cache.c
+	: libGL.so libmesa.a be 
+;

Added: haiku/branches/components/gallium3d/src/add-ons/opengl/softpipe/SoftPipeRenderer.cpp
===================================================================
--- haiku/branches/components/gallium3d/src/add-ons/opengl/softpipe/SoftPipeRenderer.cpp	2009-06-21 21:15:24 UTC (rev 31163)
+++ haiku/branches/components/gallium3d/src/add-ons/opengl/softpipe/SoftPipeRenderer.cpp	2009-06-21 21:29:57 UTC (rev 31164)
@@ -0,0 +1,344 @@
+/*
+ * Copyright 2006-2009, Haiku. All rights reserved.
+ * Distributed under the terms of the MIT License.
+ *
+ * Authors:
+ *		J&#233;r&#244;me Duval, <A HREF="https://lists.berlios.de/mailman/listinfo/haiku-commits">korli at users.berlios.de</A>
+ *		Philippe Houdoin, <A HREF="https://lists.berlios.de/mailman/listinfo/haiku-commits">philippe.houdoin at free.fr</A>
+ *		Artur Wyszynski, <A HREF="https://lists.berlios.de/mailman/listinfo/haiku-commits">harakash at gmail.com</A>
+ */
+/*
+ * Mesa 3-D graphics library
+ * Version:  7.5
+ *
+ * Copyright (C) 1999-2004  Brian Paul   All Rights Reserved.
+ */
+
+#include &quot;SoftPipeRenderer.h&quot;
+
+#include &lt;Autolock.h&gt;
+#include &lt;DirectWindowPrivate.h&gt;
+#include &lt;GraphicsDefs.h&gt;
+#include &lt;Screen.h&gt;
+#include &lt;sys/time.h&gt;
+
+#define TRACE_SOFTPIPE
+#ifdef TRACE_SOFTPIPE
+#	define TRACE(x...)	fprintf(stderr, x);
+#	define CALLED()		TRACE(&quot;CALLED: %s\n&quot;, __FUNCTION__);
+#else
+#	define TRACE(x...)
+#	define CALLED()
+#endif
+
+extern &quot;C&quot; {
+#include &quot;hsp_public.h&quot;
+#include &quot;hsp_winsys.h&quot;
+#include &quot;haiku_softpipe_winsys.h&quot;
+}
+
+extern const char* color_space_name(color_space space);
+
+extern &quot;C&quot; _EXPORT BGLRenderer*
+instantiate_gl_renderer(BGLView *view, ulong opts, BGLDispatcher *dispatcher)
+{
+	return new SoftPipeRenderer(view, opts, dispatcher);
+}
+
+
+SoftPipeRenderer::SoftPipeRenderer(BGLView *view, ulong options,
+		BGLDispatcher* dispatcher)
+	: BGLRenderer(view, options, dispatcher),
+	fBitmap(NULL),
+	fDirectModeEnabled(false),
+	fInfo(NULL),
+	fInfoLocker(&quot;info locker&quot;),
+	fOptions(options),
+	fColorSpace(B_NO_COLOR_SPACE)
+{
+	CALLED();
+	time_t beg, end;
+	beg = time(NULL);
+	hsp_init(options);
+	end = time(NULL);
+	TRACE(&quot;hsp_init time: %f.\n&quot;, difftime(end, beg));
+	BRect b = GLView()-&gt;Bounds();
+	fColorSpace = B_RGBA32;
+	if (fDirectModeEnabled &amp;&amp; fInfo != NULL) {
+		fColorSpace = BScreen(GLView()-&gt;Window()).ColorSpace();
+	}
+	int32 width = b.IntegerWidth();// + 1;
+	int32 height = b.IntegerHeight();// + 1;
+	TRACE(&quot;ColorSpace:\t%s\n&quot;, color_space_name(fColorSpace));
+	fBitmap = new BBitmap(BRect(0.f, 0.f, width /*- 1*/, height /*- 1*/), fColorSpace);
+	fWidth = width;
+	fHeight = height;
+	beg = time(NULL);
+	fContext = hsp_create_layer_context(fBitmap, 0);
+	TRACE(&quot;context:\t%d\n&quot;, (int)fContext);
+	end = time(NULL);
+	TRACE(&quot;hsp_create_layer_context time: %f.\n&quot;, difftime(end, beg));
+	if (!hsp_get_current_context())
+		LockGL();
+}
+
+SoftPipeRenderer::~SoftPipeRenderer()
+{
+	CALLED();
+	if (fContext)
+		hsp_delete_context(fContext);
+	hsp_cleanup();
+	delete fBitmap;
+}
+
+
+void
+SoftPipeRenderer::LockGL()
+{
+//	CALLED();
+	BGLRenderer::LockGL();
+	hsp_make_current(fBitmap, fContext);
+
+}
+
+
+void
+SoftPipeRenderer::UnlockGL()
+{
+//	CALLED();
+//	hsp_make_current(NULL, fContext);
+	if ((fOptions &amp; BGL_DOUBLE) == 0) {
+		SwapBuffers();
+	}
+	hsp_make_current(NULL, fContext);
+	BGLRenderer::UnlockGL();
+}
+
+
+void
+SoftPipeRenderer::SwapBuffers(bool vsync)
+{
+//	CALLED();
+	hsp_swap_buffers(fContext);
+	if (!fDirectModeEnabled || fInfo == NULL) {
+		GLView()-&gt;LockLooper();
+		GLView()-&gt;DrawBitmap(fBitmap);
+		GLView()-&gt;UnlockLooper();
+	} else {
+		BAutolock lock(fInfoLocker);
+		uint8 bytesPerPixel = fInfo-&gt;bits_per_pixel / 8;
+		uint32 bytesPerRow = fBitmap-&gt;BytesPerRow();
+		for (uint32 i = 0; i &lt; fInfo-&gt;clip_list_count; i++) {
+			clipping_rect *clip = &amp;fInfo-&gt;clip_list[i];
+			int32 height = clip-&gt;bottom - clip-&gt;top + 1;
+			int32 bytesWidth 
+				= (clip-&gt;right - clip-&gt;left + 1) * bytesPerPixel;
+			uint8 *p = (uint8 *)fInfo-&gt;bits + clip-&gt;top
+				* fInfo-&gt;bytes_per_row + clip-&gt;left * bytesPerPixel;
+			uint8 *b = (uint8 *)fBitmap-&gt;Bits()
+				+ (clip-&gt;top - fInfo-&gt;window_bounds.top) * bytesPerRow
+				+ (clip-&gt;left - fInfo-&gt;window_bounds.left) * bytesPerPixel;
+
+			for (int y = 0; y &lt; height; y++) {
+				memcpy(p, b, bytesWidth);
+				p += fInfo-&gt;bytes_per_row;
+				b += bytesPerRow;
+			}
+		}
+	}
+}
+
+
+void
+SoftPipeRenderer::Draw(BRect updateRect)
+{
+	CALLED();
+	if (!fDirectModeEnabled || fInfo == NULL)
+		GLView()-&gt;DrawBitmap(fBitmap, updateRect, updateRect);
+}
+
+
+status_t
+SoftPipeRenderer::CopyPixelsOut(BPoint location, BBitmap *bitmap)
+{
+	CALLED();
+	color_space scs = fBitmap-&gt;ColorSpace();
+	color_space dcs = bitmap-&gt;ColorSpace();
+
+	if (scs != dcs &amp;&amp; (scs != B_RGBA32 || dcs != B_RGB32)) {
+		fprintf(stderr, &quot;%s::CopyPixelsOut(): incompatible color space: %s != %s\n&quot;,
+			__FUNCTION__, color_space_name(scs), color_space_name(dcs));
+		return B_BAD_TYPE;
+	}
+
+	BRect sr = fBitmap-&gt;Bounds();
+	BRect dr = bitmap-&gt;Bounds();
+
+//	int32 w1 = sr.IntegerWidth();
+//	int32 h1 = sr.IntegerHeight();
+//	int32 w2 = dr.IntegerWidth();
+//	int32 h2 = dr.IntegerHeight();
+
+	sr = sr &amp; dr.OffsetBySelf(location);
+	dr = sr.OffsetByCopy(-location.x, -location.y);
+
+	uint8 *ps = (uint8 *) fBitmap-&gt;Bits();
+	uint8 *pd = (uint8 *) bitmap-&gt;Bits();
+	uint32 *s, *d;
+	uint32 y;
+	for (y = (uint32) sr.top; y &lt;= (uint32) sr.bottom; y++) {
+		s = (uint32 *)(ps + y * fBitmap-&gt;BytesPerRow());
+		s += (uint32) sr.left;
+
+		d = (uint32 *)(pd + (y + (uint32)(dr.top - sr.top))
+			* bitmap-&gt;BytesPerRow());
+		d += (uint32) dr.left;
+		memcpy(d, s, dr.IntegerWidth() * 4);
+	}
+
+	return B_OK;
+}
+
+
+status_t
+SoftPipeRenderer::CopyPixelsIn(BBitmap *bitmap, BPoint location)
+{
+	CALLED();
+
+	color_space scs = bitmap-&gt;ColorSpace();
+	color_space dcs = fBitmap-&gt;ColorSpace();
+
+	if (scs != dcs &amp;&amp; (dcs != B_RGBA32 || scs != B_RGB32)) {
+		fprintf(stderr, &quot;%s::CopyPixelsIn(): incompatible color space: %s != %s\n&quot;,
+			__FUNCTION__, color_space_name(scs), color_space_name(dcs));
+		return B_BAD_TYPE;
+	}
+
+	BRect sr = bitmap-&gt;Bounds();
+	BRect dr = fBitmap-&gt;Bounds();
+
+	sr = sr &amp; dr.OffsetBySelf(location);
+	dr = sr.OffsetByCopy(-location.x, -location.y);
+
+	uint8 *ps = (uint8 *) bitmap-&gt;Bits();
+	uint8 *pd = (uint8 *) fBitmap-&gt;Bits();
+	uint32 *s, *d;
+	uint32 y;
+
+	for (y = (uint32) sr.top; y &lt;= (uint32) sr.bottom; y++) {
+		s = (uint32 *)(ps + y * bitmap-&gt;BytesPerRow());
+		s += (uint32) sr.left;
+
+		d = (uint32 *)(pd + (y + (uint32)(dr.top - sr.top))
+			* fBitmap-&gt;BytesPerRow());
+		d += (uint32) dr.left;
+
+		memcpy(d, s, dr.IntegerWidth() * 4);
+	}
+
+	return B_OK;
+}
+
+
+void
+SoftPipeRenderer::EnableDirectMode(bool enabled)
+{
+//	TRACE(&quot;SoftPipeRenderer::%s(enabled: %d)\n&quot;, __FUNCTION__, enabled);
+	fDirectModeEnabled = enabled;
+}
+
+
+void
+SoftPipeRenderer::DirectConnected(direct_buffer_info *info)
+{
+	CALLED();
+	BAutolock lock(fInfoLocker);
+	if (info) {
+		if (!fInfo) {
+			fInfo = (direct_buffer_info *)calloc(1, DIRECT_BUFFER_INFO_AREA_SIZE);
+		}
+		memcpy(fInfo, info, DIRECT_BUFFER_INFO_AREA_SIZE);
+	} else if (fInfo) {
+		free(fInfo);
+		fInfo = NULL;
+	}
+}
+
+
+// #pragma mark - static
+
+
+void
+SoftPipeRenderer::Error(GLcontext *ctx)
+{
+	CALLED();
+}
+
+
+const GLubyte *
+SoftPipeRenderer::GetString(GLcontext *ctx, GLenum name)
+{
+	CALLED();
+	return NULL;
+}
+
+
+void
+SoftPipeRenderer::Viewport(GLcontext *ctx, GLint x, GLint y, GLsizei w,
+		GLsizei h)
+{
+	CALLED();
+}
+
+
+void
+SoftPipeRenderer::UpdateState(GLcontext *ctx, GLuint new_state)
+{
+	CALLED();
+}
+
+
+void
+SoftPipeRenderer::ClearIndex(GLcontext *ctx, GLuint index)
+{
+	CALLED();
+}
+
+
+void
+SoftPipeRenderer::ClearColor(GLcontext *ctx, const GLfloat color[4])
+{
+	CALLED();
+}
+
+
+void
+SoftPipeRenderer::Clear(GLcontext *ctx, GLbitfield mask)
+{
+	CALLED();
+}
+
+
+void
+SoftPipeRenderer::ClearFront(GLcontext *ctx)
+{
+	CALLED();
+}
+
+
+GLboolean
+SoftPipeRenderer::RenderbufferStorage(GLcontext* ctx,
+		struct gl_renderbuffer* render, GLenum internalFormat,
+		GLuint width, GLuint height)
+{
+	CALLED();
+	return GL_TRUE;
+}
+
+
+void
+SoftPipeRenderer::Flush(GLcontext *ctx)
+{
+	CALLED();
+}
+

Added: haiku/branches/components/gallium3d/src/add-ons/opengl/softpipe/SoftPipeRenderer.h
===================================================================
--- haiku/branches/components/gallium3d/src/add-ons/opengl/softpipe/SoftPipeRenderer.h	2009-06-21 21:15:24 UTC (rev 31163)
+++ haiku/branches/components/gallium3d/src/add-ons/opengl/softpipe/SoftPipeRenderer.h	2009-06-21 21:29:57 UTC (rev 31164)
@@ -0,0 +1,82 @@
+/*
+ * Copyright 2006-2008, Haiku. All rights reserved.
+ * Distributed under the terms of the MIT License.
+ *
+ * Authors:
+ *		J&#233;r&#244;me Duval, <A HREF="https://lists.berlios.de/mailman/listinfo/haiku-commits">korli at users.berlios.de</A>
+ * 		Philippe Houdoin, <A HREF="https://lists.berlios.de/mailman/listinfo/haiku-commits">philippe.houdoin at free.fr</A>
+ * 		Artur Wyszynski, <A HREF="https://lists.berlios.de/mailman/listinfo/haiku-commits">harakash at gmail.com</A>
+ */
+/*
+ * Mesa 3-D graphics library
+ * Version:  7.5
+ *
+ * Copyright (C) 1999-2004  Brian Paul   All Rights Reserved.
+ */
+
+#ifndef SOFTPIPERENDERER_H
+#define SOFTPIPERENDERER_H
+
+#include &quot;GLRenderer.h&quot;
+
+extern &quot;C&quot; {
+#include &quot;hsp_public.h&quot;
+#include &quot;context.h&quot;
+}
+
+class SoftPipeRenderer : public BGLRenderer {
+public:
+	SoftPipeRenderer(BGLView *view, ulong bgl_options,
+		BGLDispatcher *dispatcher);
+	virtual	~SoftPipeRenderer();
+
+	virtual	void LockGL();
+	virtual	void UnlockGL();
+
+	virtual	void SwapBuffers(bool vsync = false);
+	virtual	void Draw(BRect updateRect);
+	virtual	status_t CopyPixelsOut(BPoint source, BBitmap *dest);
+	virtual	status_t CopyPixelsIn(BBitmap *source, BPoint dest);
+	GLvoid** GetRows() { return fRowAddr; }
+
+	virtual	void EnableDirectMode(bool enabled);
+	virtual	void DirectConnected(direct_buffer_info *info);
+
+private:
+	static void Error(GLcontext *ctx);
+	static const GLubyte* GetString(GLcontext *ctx, GLenum name);
+	static void Viewport(GLcontext *ctx, GLint x, GLint y, GLsizei w, GLsizei h);
+	static void UpdateState(GLcontext *ctx, GLuint newState);
+	static void ClearFront(GLcontext *ctx);
+	static void ClearIndex(GLcontext *ctx, GLuint index);
+	static void ClearColor(GLcontext *ctx, const GLfloat color[4]);
+	static void Clear(GLcontext *ctx, GLbitfield mask);
+	static GLboolean RenderbufferStorage(GLcontext *ctx,
+			struct gl_renderbuffer *render, GLenum internalFormat,
+			GLuint width, GLuint height);
+	static void Flush(GLcontext *ctx);
+
+	BBitmap *fBitmap;
+	bool fDirectModeEnabled;
+	direct_buffer_info *fInfo;
+	BLocker fInfoLocker;
+	ulong fOptions;
+
+	uint64 fContext;
+//	GLcontext *fContext;
+//	GLvisual *fVisual;
+//	GLframebuffer *fFrameBuffer;
+//	struct gl_renderbuffer *fRenderBuffer;
+
+//	GLchan fClearColor[4];	// buffer clear color
+//	GLuint fClearIndex;	// buffer clear color index
+	GLuint fWidth;
+	GLuint fHeight;
+	color_space fColorSpace;
+
+	GLvoid *fRowAddr[MAX_HEIGHT];
+		// address of first pixel in each image row
+};
+
+#endif	// SOFTPIPERENDERER_H
+

Added: haiku/branches/components/gallium3d/src/add-ons/opengl/softpipe/haiku_softpipe_winsys.c
===================================================================
--- haiku/branches/components/gallium3d/src/add-ons/opengl/softpipe/haiku_softpipe_winsys.c	2009-06-21 21:15:24 UTC (rev 31163)
+++ haiku/branches/components/gallium3d/src/add-ons/opengl/softpipe/haiku_softpipe_winsys.c	2009-06-21 21:29:57 UTC (rev 31164)
@@ -0,0 +1,252 @@
+/*
+ * Copyright 2009, Haiku, Inc. All Rights Reserved.
+ * Distributed under the terms of the MIT License.
+ *
+ * Based on gallium gdi winsys
+ *
+ * Authors:
+ * 	Artur Wyszynski &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/haiku-commits">harakash at gmail.com</A>&gt;
+ */
+
+#include &quot;haiku_softpipe_winsys.h&quot;
+#include &quot;hsp_device.h&quot;
+
+//#define TRACE_HAIKU_SOFTPIPE
+#if defined(TRACE_HAIKU_SOFTPIPE)
+#	define TRACE(x...)	fprintf(stderr, x);
+#else
+#	define TRACE(x...)
+#endif
+
+static INLINE struct haiku_softpipe_buffer*
+haiku_softpipe_buffer(struct pipe_buffer *buf)
+{
+	return (struct haiku_softpipe_buffer*)buf;
+}
+
+//static
+void*
+haiku_softpipe_buffer_map(struct pipe_winsys *winsys, struct pipe_buffer *buf,
+	unsigned flags)
+{
+	TRACE(&quot;%s(winsys: %p buf: %p flags: %d)\n&quot;, __FUNCTION__,
+		winsys, buf, flags);
+	struct haiku_softpipe_buffer *haiku_softpipe_buf = haiku_softpipe_buffer(buf);
+	haiku_softpipe_buf-&gt;mapped = haiku_softpipe_buf-&gt;data;
+	return haiku_softpipe_buf-&gt;mapped;
+}
+
+//static
+void
+haiku_softpipe_buffer_unmap(struct pipe_winsys *winsys, struct pipe_buffer *buf)
+{
+	TRACE(&quot;%s(winsys: %p buf: %p)\n&quot;, __FUNCTION__, winsys, buf);
+	struct haiku_softpipe_buffer *haiku_softpipe_buf = haiku_softpipe_buffer(buf);
+	haiku_softpipe_buf-&gt;mapped = NULL;
+}
+
+//static
+void
+haiku_softpipe_buffer_destroy(struct pipe_buffer *buf)
+{
+	TRACE(&quot;%s(buf: %p)\n&quot;, __FUNCTION__, buf);
+	struct haiku_softpipe_buffer *oldBuf = haiku_softpipe_buffer(buf);
+
+	if (oldBuf-&gt;data) {
+		if (!oldBuf-&gt;user_buffer)
+			align_free(oldBuf-&gt;data);
+		oldBuf-&gt;data = NULL;
+	}
+	FREE(oldBuf);
+}
+
+//static
+const char*
+haiku_softpipe_get_name(struct pipe_winsys *winsys)
+{
+	TRACE(&quot;%s(winsys: %p)\n&quot;, __FUNCTION__, winsys);
+	return &quot;Haiku SoftPipe&quot;;
+}
+
+//static
+struct pipe_buffer*
+haiku_softpipe_buffer_create(struct pipe_winsys *winsys, unsigned alignment,
+	unsigned usage, unsigned size)
+{
+	TRACE(&quot;%s(winsys: %p alignment: %d usage: %d size: %d)\n&quot;,
+		__FUNCTION__, winsys, alignment, usage, size);
+	struct haiku_softpipe_buffer *buffer = CALLOC_STRUCT(haiku_softpipe_buffer);
+
+	pipe_reference_init(&amp;buffer-&gt;base.reference, 1);
+	buffer-&gt;base.alignment = alignment;
+	buffer-&gt;base.usage = usage;
+	buffer-&gt;base.size = size;
+
+	buffer-&gt;data = align_malloc(size, alignment);
+
+	return &amp;buffer-&gt;base;
+}
+
+//static
+struct pipe_buffer*
+haiku_softpipe_user_buffer_create(struct pipe_winsys *winsys, void *ptr,
+	unsigned bytes)
+{
+	TRACE(&quot;%s(winsys: %p ptr: %p bytes: %d)\n&quot;, __FUNCTION__,
+		winsys, ptr, bytes);
+	struct haiku_softpipe_buffer *buffer;
+
+	buffer = CALLOC_STRUCT(haiku_softpipe_buffer);
+
+	if (!buffer)
+		return NULL;
+
+	pipe_reference_init(&amp;buffer-&gt;base.reference, 1);
+	buffer-&gt;base.size = bytes;
+	buffer-&gt;user_buffer = true;
+	buffer-&gt;data = ptr;
+
+	return &amp;buffer-&gt;base;
+}
+
+static INLINE unsigned
+round_up(unsigned n, unsigned multiple)
+{
+	return (n + multiple - 1) &amp; ~(multiple - 1);
+}
+
+//static
+struct pipe_buffer*
+haiku_softpipe_surface_buffer_create(struct pipe_winsys *winsys,
+	unsigned width, unsigned height, enum pipe_format format,
+	unsigned usage, unsigned *stride)
+{
+	TRACE(&quot;%s(winsys: %p width: %d height: %d format: %d usage: %d &quot;
+		&quot;stride: %p)\n&quot;, __FUNCTION__, winsys, width, height, format,
+		usage, stride);
+	const unsigned alignment = 32;
+	struct pipe_format_block block;
+	unsigned nblocksx, nblocksy;
+
+	pf_get_block(format, &amp;block);
+	nblocksx = pf_get_nblocksx(&amp;block, width);
+	nblocksy = pf_get_nblocksy(&amp;block, height);
+	*stride = round_up(nblocksx * block.size, alignment);
+
+	return winsys-&gt;buffer_create(winsys, alignment, usage, *stride * nblocksy);
+}
+
+//static
+void
+haiku_softpipe_dummy_flush_frontbuffer(struct pipe_winsys *winsys,
+	struct pipe_surface *surface, void *context_private)
+{
+	TRACE(&quot;%s(winsys: %p surface: %p context: %p)\n&quot;, __FUNCTION__,
+		winsys, surface, context_private);
+	assert(0);
+}
+
+//static
+void
+haiku_softpipe_fence_reference(struct pipe_winsys *winsys,
+	struct pipe_fence_handle **ptr, struct pipe_fence_handle *fence)
+{
+	TRACE(&quot;%s(winsys: %p ptr: %p fence: %p)\n&quot;, __FUNCTION__,
+		winsys, ptr, fence);
+}
+
+//static
+int
+haiku_softpipe_fence_signalled(struct pipe_winsys *winsys,
+	struct pipe_fence_handle *fence, unsigned flag)
+{
+	TRACE(&quot;%s(winsys: %p fence: %p flag: %d)\n&quot;, __FUNCTION__,
+		winsys, fence, flag);
+	return 0;
+}
+
+//static
+int
+haiku_softpipe_fence_finish(struct pipe_winsys *winsys,
+	struct pipe_fence_handle *fence, unsigned flag)
+{
+	TRACE(&quot;%s(winsys: %p fence: %p flag: %d)\n&quot;, __FUNCTION__,
+		winsys, fence, flag);
+	return 0;
+}
+
+//static
+void
+haiku_softpipe_destroy(struct pipe_winsys *winsys)
+{
+	TRACE(&quot;%s(winsys: %p)\n&quot;, __FUNCTION__, winsys);
+	FREE(winsys);
+}
+
+//static
+struct pipe_screen*
+haiku_softpipe_screen_create(void)
+{
+	TRACE(&quot;%s\n&quot;, __FUNCTION__);
+	static struct pipe_winsys *winsys;
+	struct pipe_screen *screen;
+
+	winsys = CALLOC_STRUCT(pipe_winsys);
+	
+	if (!winsys) {
+		TRACE(&quot;%s&gt; can't alloc winsys!\n&quot;, __FUNCTION__);
+		return NULL;
+	}
+
+	winsys-&gt;destroy = haiku_softpipe_destroy;
+	winsys-&gt;buffer_create = haiku_softpipe_buffer_create;
+	winsys-&gt;user_buffer_create = haiku_softpipe_user_buffer_create;
+	winsys-&gt;buffer_map = haiku_softpipe_buffer_map;
+	winsys-&gt;buffer_unmap = haiku_softpipe_buffer_unmap;
+	winsys-&gt;buffer_destroy = haiku_softpipe_buffer_destroy;
+	winsys-&gt;surface_buffer_create = haiku_softpipe_surface_buffer_create;
+	winsys-&gt;fence_reference = haiku_softpipe_fence_reference;
+	winsys-&gt;fence_signalled = haiku_softpipe_fence_signalled;
+	winsys-&gt;fence_finish = haiku_softpipe_fence_finish;
+	winsys-&gt;flush_frontbuffer = haiku_softpipe_dummy_flush_frontbuffer;
+	winsys-&gt;get_name = haiku_softpipe_get_name;
+
+	TRACE(&quot;%s&gt; @softpipe_create_screen(winsys: %p)\n&quot;, __FUNCTION__,
+		winsys);
+
+	screen = softpipe_create_screen(winsys);
+
+	if (!screen) {
+		TRACE(&quot;%s&gt; can't create screen!\n&quot;, __FUNCTION__);
+		haiku_softpipe_destroy(winsys);
+	}
+
+	return screen;
+}
+
+//static
+struct pipe_context*
+haiku_softpipe_context_create(struct pipe_screen *screen)
+{
+	TRACE(&quot;haiku_softpipe_context_create&gt; screen = %p\n&quot;, screen);
+	struct pipe_context *pipe = softpipe_create(screen);
+	return pipe;
+}
+
+//static
+void
+haiku_softpipe_flush_frontbuffer(struct pipe_screen *screen,
+	struct pipe_surface *surface, Bitmap* bitmap)
+{
+	TRACE(&quot;haiku_softpipe_flush_frontbuffer&gt; screen = %p, &quot;
+		&quot;surface = %p, bitmap = %p\n&quot;, screen, surface, bitmap);
+	struct softpipe_texture *texture;
+	struct haiku_softpipe_buffer *buffer;
+
+	texture = softpipe_texture(surface-&gt;texture);
+
+	buffer = haiku_softpipe_buffer(texture-&gt;buffer);
+
+	int32 bitsLength = get_bitmap_bits_length(bitmap);
+	copy_bitmap_bits(bitmap, buffer-&gt;data, bitsLength);
+}

Added: haiku/branches/components/gallium3d/src/add-ons/opengl/softpipe/haiku_softpipe_winsys.h
===================================================================
--- haiku/branches/components/gallium3d/src/add-ons/opengl/softpipe/haiku_softpipe_winsys.h	2009-06-21 21:15:24 UTC (rev 31163)
+++ haiku/branches/components/gallium3d/src/add-ons/opengl/softpipe/haiku_softpipe_winsys.h	2009-06-21 21:29:57 UTC (rev 31164)
@@ -0,0 +1,106 @@
+/*
+ * Copyright 2009, Haiku, Inc. All Rights Reserved.
+ * Distributed under the terms of the MIT License.
+ *
+ * Based on gallium gdi winsys
+ *
+ * Authors:
+ * 	Artur Wyszynski &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/haiku-commits">harakash at gmail.com</A>&gt;
+ */
+
+#ifndef __HAIKU_SOFTPIPE_H__
+#define __HAIKU_SOFTPIPE_H__
+
+#include &lt;stdio.h&gt;
+#include &quot;pipe/internal/p_winsys_screen.h&quot;
+#include &quot;pipe/p_format.h&quot;
+#include &quot;pipe/p_context.h&quot;
+#include &quot;util/u_math.h&quot;
+#include &quot;util/u_memory.h&quot;
+#include &quot;sp_winsys.h&quot;
+#include &quot;sp_texture.h&quot;
+#include &quot;hsp_bitmap_wrapper.h&quot;
+#include &quot;hsp_winsys.h&quot;
+
+struct haiku_softpipe_buffer {
+	struct pipe_buffer base;
+	bool user_buffer;
+	void *data;
+	void *mapped;
+};
+
+static INLINE struct haiku_softpipe_buffer*
+haiku_softpipe_buffer(struct pipe_buffer *buf);
+
+//static
+void*
+haiku_softpipe_buffer_map(struct pipe_winsys *winsys, struct pipe_buffer *buf,
+	unsigned flags);
+
+//static
+void
+haiku_softpipe_buffer_unmap(struct pipe_winsys *winsys, struct pipe_buffer *buf);
+
+//static
+void
+haiku_softpipe_buffer_destroy(struct pipe_buffer *buf);
+
+//static
+const char*
+haiku_softpipe_get_name(struct pipe_winsys *winsys);
+
+//static
+struct pipe_buffer*
+haiku_softpipe_buffer_create(struct pipe_winsys *winsys, unsigned alignment,
+	unsigned usage, unsigned size);
+
+//static
+struct pipe_buffer*
+haiku_softpipe_user_buffer_create(struct pipe_winsys *winsys, void *ptr,
+	unsigned bytes);
+
+//static
+struct pipe_buffer*
+haiku_softpipe_surface_buffer_create(struct pipe_winsys *winsys,
+	unsigned width, unsigned height, enum pipe_format format,
+	unsigned usage, unsigned *stride);
+
+//static
+void
+haiku_softpipe_dummy_flush_frontbuffer(struct pipe_winsys *winsys,
+	struct pipe_surface *surface, void *context_private);
+
+//static
+void
+haiku_softpipe_fence_reference(struct pipe_winsys *winsys,
+	struct pipe_fence_handle **ptr, struct pipe_fence_handle *fence);
+
+//static
+int
+haiku_softpipe_fence_signalled(struct pipe_winsys *winsys,
+	struct pipe_fence_handle *fence, unsigned flag);
+
+//static
+int
+haiku_softpipe_fence_finish(struct pipe_winsys *winsys,
+	struct pipe_fence_handle *fence, unsigned flag);
+
+//static
+void
+haiku_softpipe_destroy(struct pipe_winsys *winsys);
+
+//static
+struct pipe_screen*
+haiku_softpipe_screen_create(void);
+
+//static
+struct pipe_context*
+haiku_softpipe_context_create(struct pipe_screen *screen);
+
+//static
+void
+haiku_softpipe_flush_frontbuffer(struct pipe_screen *screen,
+	struct pipe_surface *surface, Bitmap* bitmap);
+
+#endif /* __HAIKU_SOFTPIPE_WINSYS_H__ */
+

Added: haiku/branches/components/gallium3d/src/add-ons/opengl/softpipe/hsp_bitmap_wrapper.cpp
===================================================================
--- haiku/branches/components/gallium3d/src/add-ons/opengl/softpipe/hsp_bitmap_wrapper.cpp	2009-06-21 21:15:24 UTC (rev 31163)
+++ haiku/branches/components/gallium3d/src/add-ons/opengl/softpipe/hsp_bitmap_wrapper.cpp	2009-06-21 21:29:57 UTC (rev 31164)
@@ -0,0 +1,82 @@
+/*
+ * Copyright 2009, Haiku, Inc. All Rights Reserved.
+ * Distributed under the terms of the MIT License.
+ *
+ * Based on gallium gdi winsys
+ *
+ * Authors:
+ * 	Artur Wyszynski &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/haiku-commits">harakash at gmail.com</A>&gt;
+ */
+
+#include &lt;stdio.h&gt;
+#include &lt;interface/Bitmap.h&gt;
+#include &quot;hsp_bitmap_wrapper.h&quot;
+
+extern &quot;C&quot; {
+
+Bitmap*
+create_bitmap(int32 width, int32 height, color_space colorSpace)
+{
+	BBitmap *bb = new BBitmap(BRect(0, 0, width, height), colorSpace);
+	if (bb)
+		return (Bitmap*)bb;
+	return NULL;
+}
+
+void
+get_bitmap_size(const Bitmap *bitmap, int32 *width, int32 *height)
+{
+	BBitmap *bb = (BBitmap*)bitmap;
+	if (bb &amp;&amp; width &amp;&amp; height) {
+		uint32 w = bb-&gt;Bounds().Width();
+		uint32 h = bb-&gt;Bounds().Height();
+		*width = w;
+		*height = h;
+	}
+}
+
+color_space
+get_bitmap_color_space(const Bitmap *bitmap)
+{
+	BBitmap *bb = (BBitmap*)bitmap;
+	if (bb)
+		return bb-&gt;ColorSpace();
+	return B_NO_COLOR_SPACE;
+}
+
+void
+copy_bitmap_bits(const Bitmap *bitmap, void *data, int32 length)
+{
+	BBitmap *bb = (BBitmap*)bitmap;
+	if (bb) {
+		color_space cs = bb-&gt;ColorSpace();
+		bb-&gt;ImportBits(data, bb-&gt;BitsLength(), bb-&gt;BytesPerRow(), 0, cs);
+	}
+}
+
+void
+delete_bitmap(Bitmap *bitmap)
+{
+	BBitmap *bb = (BBitmap*)bitmap;
+	delete bb;
+}
+
+int32
+get_bitmap_bytes_per_row(const Bitmap *bitmap)
+{
+	BBitmap *bb = (BBitmap*)bitmap;
+	if (bb)

[... truncated: 17601 lines follow ...]

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="017371.html">[Haiku-commits] r31163 - in haiku/branches/components/gallium3d: headers/os/opengl/GL headers/private/opengl/GL/internal src/kits/opengl src/kits/opengl/mesa src/kits/opengl/mesa/drivers/common src/kits/opengl/mesa/gallium src/kits/opengl/mesa/gallium/auxiliary src/kits/opengl/mesa/gallium/auxiliary/cso_cache src/kits/opengl/mesa/gallium/auxiliary/draw src/kits/opengl/mesa/gallium/auxiliary/gallivm src/kits/opengl/mesa/gallium/auxiliary/indices src/kits/opengl/mesa/gallium/auxiliary/pipebuffer src/kits/opengl/mesa/gallium/auxiliary/rtasm src/kits/opengl/mesa/gallium/auxiliary/sct src/kits/opengl/mesa/gallium/auxiliary/tgsi src/kits/opengl/mesa/gallium/auxiliary/translate src/kits/opengl/mesa/gallium/auxiliary/util src/kits/opengl/mesa/gallium/include src/kits/opengl/mesa/gallium/include/pipe src/kits/opengl/mesa/gallium/include/pipe/internal src/kits/opengl/mesa/gallium/include/state_tracker src/kits/opengl/mesa/glapi src/kits/opengl/mesa/main src/kits/opengl/mesa/math src/kits/ope! ngl/mesa/ppc src/kits/opengl/mesa/shader src/kits/opengl/mesa/shader/slang src/kits/opengl/mesa/shader/slang/library src/kits/opengl/mesa/sparc src/kits/opengl/mesa/state_tracker src/kits/opengl/mesa/swrast src/kits/opengl/mesa/swrast_setup src/kits/opengl/mesa/tnl src/kits/opengl/mesa/tnl_dd src/kits/opengl/mesa/vbo src/kits/opengl/mesa/x86 src/kits/opengl/mesa/x86/rtasm src/kits/opengl/mesa/x86-64
</A></li>
	<LI>Next message: <A HREF="017373.html">[Haiku-commits] r31165 - in haiku/trunk/src/servers/app: .	drawing/Painter
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#17372">[ date ]</a>
              <a href="thread.html#17372">[ thread ]</a>
              <a href="subject.html#17372">[ subject ]</a>
              <a href="author.html#17372">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/haiku-commits">More information about the Haiku-commits
mailing list</a><br>
</body></html>
