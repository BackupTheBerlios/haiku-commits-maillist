<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Haiku-commits] r20271 - in haiku/trunk:	headers/private/graphics/radeon src/add-ons/accelerants/radeon	src/add-ons/kernel/drivers/graphics/radeon
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/haiku-commits/2007-March/index.html" >
   <LINK REL="made" HREF="mailto:haiku-commits%40lists.berlios.de?Subject=Re%3A%20%5BHaiku-commits%5D%20r20271%20-%20in%20haiku/trunk%3A%0A%09headers/private/graphics/radeon%20src/add-ons/accelerants/radeon%0A%09src/add-ons/kernel/drivers/graphics/radeon&In-Reply-To=%3C200703010900.l2190qj6031149%40sheep.berlios.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000971.html">
   <LINK REL="Next"  HREF="000973.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Haiku-commits] r20271 - in haiku/trunk:	headers/private/graphics/radeon src/add-ons/accelerants/radeon	src/add-ons/kernel/drivers/graphics/radeon</H1>
    <B>axeld at BerliOS</B> 
    <A HREF="mailto:haiku-commits%40lists.berlios.de?Subject=Re%3A%20%5BHaiku-commits%5D%20r20271%20-%20in%20haiku/trunk%3A%0A%09headers/private/graphics/radeon%20src/add-ons/accelerants/radeon%0A%09src/add-ons/kernel/drivers/graphics/radeon&In-Reply-To=%3C200703010900.l2190qj6031149%40sheep.berlios.de%3E"
       TITLE="[Haiku-commits] r20271 - in haiku/trunk:	headers/private/graphics/radeon src/add-ons/accelerants/radeon	src/add-ons/kernel/drivers/graphics/radeon">axeld at mail.berlios.de
       </A><BR>
    <I>Thu Mar  1 10:00:52 CET 2007</I>
    <P><UL>
        <LI>Previous message: <A HREF="000971.html">[Haiku-commits] r20270 -	haiku/trunk/src/tests/kits/interface/picture
</A></li>
        <LI>Next message: <A HREF="000973.html">[Haiku-commits] r20272 - in haiku/trunk:	headers/private/graphics/radeon	src/add-ons/kernel/drivers/graphics/radeon
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#972">[ date ]</a>
              <a href="thread.html#972">[ thread ]</a>
              <a href="subject.html#972">[ subject ]</a>
              <a href="author.html#972">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: axeld
Date: 2007-03-01 10:00:49 +0100 (Thu, 01 Mar 2007)
New Revision: 20271
ViewCVS: <A HREF="http://svn.berlios.de/viewcvs/haiku?rev=20271&amp;view=rev">http://svn.berlios.de/viewcvs/haiku?rev=20271&amp;view=rev</A>

Modified:
   haiku/trunk/headers/private/graphics/radeon/2d_regs.h
   haiku/trunk/headers/private/graphics/radeon/buscntrl_regs.h
   haiku/trunk/headers/private/graphics/radeon/config_regs.h
   haiku/trunk/headers/private/graphics/radeon/fp_regs.h
   haiku/trunk/headers/private/graphics/radeon/memcntrl_regs.h
   haiku/trunk/headers/private/graphics/radeon/overlay_regs.h
   haiku/trunk/headers/private/graphics/radeon/pll_access.h
   haiku/trunk/headers/private/graphics/radeon/pll_regs.h
   haiku/trunk/headers/private/graphics/radeon/radeon_interface.h
   haiku/trunk/headers/private/graphics/radeon/version.h
   haiku/trunk/src/add-ons/accelerants/radeon/ProposeDisplayMode.c
   haiku/trunk/src/add-ons/accelerants/radeon/SetDisplayMode.c
   haiku/trunk/src/add-ons/accelerants/radeon/crtc.c
   haiku/trunk/src/add-ons/accelerants/radeon/dpms.c
   haiku/trunk/src/add-ons/accelerants/radeon/driver_wrapper.c
   haiku/trunk/src/add-ons/accelerants/radeon/flat_panel.c
   haiku/trunk/src/add-ons/accelerants/radeon/internal_tv_out.c
   haiku/trunk/src/add-ons/accelerants/radeon/monitor_detection.c
   haiku/trunk/src/add-ons/accelerants/radeon/monitor_routing.c
   haiku/trunk/src/add-ons/accelerants/radeon/overlay_management.c
   haiku/trunk/src/add-ons/accelerants/radeon/palette.c
   haiku/trunk/src/add-ons/accelerants/radeon/pll.c
   haiku/trunk/src/add-ons/accelerants/radeon/radeon_accelerant.h
   haiku/trunk/src/add-ons/accelerants/radeon/set_mode.h
   haiku/trunk/src/add-ons/kernel/drivers/graphics/radeon/CP_setup.c
   haiku/trunk/src/add-ons/kernel/drivers/graphics/radeon/bios.c
   haiku/trunk/src/add-ons/kernel/drivers/graphics/radeon/detect.c
   haiku/trunk/src/add-ons/kernel/drivers/graphics/radeon/driver.c
   haiku/trunk/src/add-ons/kernel/drivers/graphics/radeon/init.c
   haiku/trunk/src/add-ons/kernel/drivers/graphics/radeon/mem_controller.c
   haiku/trunk/src/add-ons/kernel/drivers/graphics/radeon/pll_access.c
   haiku/trunk/src/add-ons/kernel/drivers/graphics/radeon/radeon_driver.h
Log:
First of a set of patches by Euan Kirkhope:
 * Headers updated
 * PLL errata workarounds
 * Radeon asic type overhaul (consolidated)
 * Device IDs Updated.
 * support for X-series devices with legacy bios type
 * minor tidy ups / compiler warnings (casts)


Modified: haiku/trunk/headers/private/graphics/radeon/2d_regs.h
===================================================================
--- haiku/trunk/headers/private/graphics/radeon/2d_regs.h	2007-03-01 08:47:05 UTC (rev 20270)
+++ haiku/trunk/headers/private/graphics/radeon/2d_regs.h	2007-03-01 09:00:49 UTC (rev 20271)
@@ -183,7 +183,7 @@
 #define RADEON_DST_LINE_START               0x1600
 #define RADEON_DST_LINE_END                 0x1604
 #define RADEON_DST_LINE_PATCOUNT            0x1608
-
+#		define RADEON_BRES_CNTL_SHIFT		8
 #define RADEON_DEFAULT_OFFSET               0x16e0
 #define RADEON_DEFAULT_PITCH                0x16e4
 

Modified: haiku/trunk/headers/private/graphics/radeon/buscntrl_regs.h
===================================================================
--- haiku/trunk/headers/private/graphics/radeon/buscntrl_regs.h	2007-03-01 08:47:05 UTC (rev 20270)
+++ haiku/trunk/headers/private/graphics/radeon/buscntrl_regs.h	2007-03-01 09:00:49 UTC (rev 20271)
@@ -56,6 +56,6 @@
 
 #define RADEON_HOST_PATH_CNTL               0x0130
 #       define RADEON_HDP_SOFT_RESET        (1 &lt;&lt; 26)
+#       define RADEON_HDP_APER_CNTL         (1 &lt;&lt; 23)
 
-
 #endif

Modified: haiku/trunk/headers/private/graphics/radeon/config_regs.h
===================================================================
--- haiku/trunk/headers/private/graphics/radeon/config_regs.h	2007-03-01 08:47:05 UTC (rev 20270)
+++ haiku/trunk/headers/private/graphics/radeon/config_regs.h	2007-03-01 09:00:49 UTC (rev 20271)
@@ -11,9 +11,16 @@
 #define _CONFIG_REGS_H
 
 // mmio registers
+#define RADEON_CONFIG_APER_0_BASE           0x0100
+#define RADEON_CONFIG_APER_1_BASE           0x0104
+#define RADEON_CONFIG_APER_SIZE             0x0108
+
 #define RADEON_CONFIG_CNTL                  0x00e0
-#define		RADEON_CFG_ATI_REV_ID_SHIFT		16
-#define		RADEON_CFG_ATI_REV_ID_MASK		(0xf &lt;&lt; 16)
+#       define RADEON_CFG_ATI_REV_A11       (0   &lt;&lt; 16)
+#       define RADEON_CFG_ATI_REV_A12       (1   &lt;&lt; 16)
+#       define RADEON_CFG_ATI_REV_A13       (2   &lt;&lt; 16)
+#       define RADEON_CFG_ATI_REV_ID_MASK   (0xf &lt;&lt; 16)
+#define	RADEON_CFG_ATI_REV_ID_SHIFT		16
 #define RADEON_CONFIG_MEMSIZE               0x00f8
 #       define RADEON_CONFIG_MEMSIZE_MASK   0x1ff00000
 

Modified: haiku/trunk/headers/private/graphics/radeon/fp_regs.h
===================================================================
--- haiku/trunk/headers/private/graphics/radeon/fp_regs.h	2007-03-01 08:47:05 UTC (rev 20270)
+++ haiku/trunk/headers/private/graphics/radeon/fp_regs.h	2007-03-01 09:00:49 UTC (rev 20271)
@@ -108,5 +108,13 @@
 
 #define RADEON_FP_V2_SYNC_STRT_WID          0x03c8
 
+#define RADEON_BIOS_0_SCRATCH 0x0010
+#define RADEON_BIOS_1_SCRATCH 0x0014
+#define RADEON_BIOS_2_SCRATCH 0x0018
+#define RADEON_BIOS_3_SCRATCH 0x001c
+#define RADEON_BIOS_4_SCRATCH 0x0020
+#define RADEON_BIOS_5_SCRATCH 0x0024
+#define RADEON_BIOS_6_SCRATCH 0x0028
+#define RADEON_BIOS_7_SCRATCH 0x002c
 
 #endif

Modified: haiku/trunk/headers/private/graphics/radeon/memcntrl_regs.h
===================================================================
--- haiku/trunk/headers/private/graphics/radeon/memcntrl_regs.h	2007-03-01 08:47:05 UTC (rev 20270)
+++ haiku/trunk/headers/private/graphics/radeon/memcntrl_regs.h	2007-03-01 09:00:49 UTC (rev 20271)
@@ -12,7 +12,11 @@
 
 #define RADEON_AGP_BASE                     0x0170
 #define RADEON_MEM_CNTL                     0x0140
-
+#       define RADEON_MEM_NUM_CHANNELS_MASK 0x01
+#       define RADEON_MEM_USE_B_CH_ONLY     (1&lt;&lt;1)
+#       define RV100_HALF_MODE              (1&lt;&lt;3)
+#       define R300_MEM_NUM_CHANNELS_MASK   0x03
+#       define R300_MEM_USE_CD_CH_ONLY      (1&lt;&lt;2)
 #define RADEON_MC_AGP_LOCATION              0x014c
 #define RADEON_MC_FB_LOCATION               0x0148
 #define RADEON_MEM_INIT_LAT_TIMER           0x0154
@@ -20,7 +24,7 @@
 #       define RADEON_MEM_CFG_TYPE_MASK     (1 &lt;&lt; 30)
 #       define RADEON_MEM_CFG_SDR           (0 &lt;&lt; 30)
 #       define RADEON_MEM_CFG_DDR           (1 &lt;&lt; 30)
-#define	RADEON_GC_NB_TOM					0x015c
+#define	RADEON_NB_TOM					0x015c
 #define	RADEON_DISPLAY_BASE_ADDRESS			0x023c
 #define	RADEON_CRTC2_DISPLAY_BASE_ADDRESS	0x033c
 #define	RADEON_OV0_BASE_ADDRESS				0x043c

Modified: haiku/trunk/headers/private/graphics/radeon/overlay_regs.h
===================================================================
--- haiku/trunk/headers/private/graphics/radeon/overlay_regs.h	2007-03-01 08:47:05 UTC (rev 20270)
+++ haiku/trunk/headers/private/graphics/radeon/overlay_regs.h	2007-03-01 09:00:49 UTC (rev 20271)
@@ -40,14 +40,14 @@
 #       define  RADEON_SCALER_ADAPTIVE_DEINT       0x00001000L
 #       define  R200_SCALER_TEMPORAL_DEINT         0x00002000L
 #       define  RADEON_SCALER_CRTC_SEL             0x00004000L
-//#       define  RADEON_SCALER_SMART_SWITCH         0x00008000L
+#       define  RADEON_SCALER_SMART_SWITCH         0x00008000L
 #       define  RADEON_SCALER_BURST_PER_PLANE      0x007F0000L
 #       define  RADEON_SCALER_DOUBLE_BUFFER        0x01000000L
 #       define  RADEON_SCALER_DIS_LIMIT            0x08000000L
+#		define  RADEON_SCALER_LIN_TRANS_BYPASS	   0x10000000L
 #       define  RADEON_SCALER_INT_EMU              0x20000000L
 #       define  RADEON_SCALER_ENABLE               0x40000000L
 #       define  RADEON_SCALER_SOFT_RESET           0x80000000L
-#       define  RADEON_SCALER_ADAPTIVE_DEINT       0x00001000L
 #define RADEON_OV0_V_INC                    0x0424
 #define RADEON_OV0_P1_V_ACCUM_INIT          0x0428
 #       define  RADEON_OV0_P1_MAX_LN_IN_PER_LN_OUT 0x00000003L

Modified: haiku/trunk/headers/private/graphics/radeon/pll_access.h
===================================================================
--- haiku/trunk/headers/private/graphics/radeon/pll_access.h	2007-03-01 08:47:05 UTC (rev 20270)
+++ haiku/trunk/headers/private/graphics/radeon/pll_access.h	2007-03-01 09:00:49 UTC (rev 20271)
@@ -13,11 +13,16 @@
 #include &quot;mmio.h&quot;
 
 
-// r300: to be called after each CLOCK_CNTL_INDEX access;
+// to be called after each CLOCK_CNTL_INDEX access;
 // all functions declared in this header take care of that
 // (hardware bug fix suggested by XFree86)
-void R300_PLLFix( vuint8 *regs, radeon_type asic );
+void RADEONPllErrataAfterIndex( vuint8 *regs, radeon_type asic );
 
+// to be called after each CLOCK_CNTL_DATA access;
+// all functions declared in this header take care of that
+// (hardware bug fix suggested by XFree86)
+void RADEONPllErrataAfterData( vuint8 *regs, radeon_type asic );
+
 // in general:
 // - the PLL is connected via special port
 // - you need first to choose the PLL register and then write/read its value

Modified: haiku/trunk/headers/private/graphics/radeon/pll_regs.h
===================================================================
--- haiku/trunk/headers/private/graphics/radeon/pll_regs.h	2007-03-01 08:47:05 UTC (rev 20270)
+++ haiku/trunk/headers/private/graphics/radeon/pll_regs.h	2007-03-01 09:00:49 UTC (rev 20271)
@@ -19,7 +19,18 @@
 #       define RADEON_PLL_DIV_SEL_DIV1      (1 &lt;&lt; 8)
 #       define RADEON_PLL_DIV_SEL_DIV2      (2 &lt;&lt; 8)
 #       define RADEON_PLL_DIV_SEL_DIV3      (3 &lt;&lt; 8)
+#define RADEON_CLK_PIN_CNTL                 0x0001 /* PLL */
+#       define RADEON_SCLK_DYN_START_CNTL   (1 &lt;&lt; 15)
 
+// PLL Power management registers
+#define RADEON_CLK_PWRMGT_CNTL              0x0014
+#       define RADEON_ENGIN_DYNCLK_MODE     (1 &lt;&lt; 12)
+#       define RADEON_ACTIVE_HILO_LAT_MASK  (3 &lt;&lt; 13)
+#       define RADEON_ACTIVE_HILO_LAT_SHIFT 13
+#       define RADEON_DISP_DYN_STOP_LAT_MASK (1 &lt;&lt; 12)
+#       define RADEON_DYN_STOP_MODE_MASK    (7 &lt;&lt; 21)
+#define RADEON_PLL_PWRMGT_CNTL              0x0015
+#       define RADEON_TCL_BYPASS_DISABLE    (1 &lt;&lt; 20)
 
 // indirect PLL registers
 #define RADEON_CLK_PIN_CNTL                 0x0001
@@ -55,12 +66,46 @@
 #       define RADEON_ECP_DIV_VCLK_2        (1 &lt;&lt; 8)
 #		define RADEON_VCLK_ECP_CNTL_BYTE_CLK_POST_DIV_SHIFT 16
 #		define RADEON_VCLK_ECP_CNTL_BYTE_CLK_POST_DIV_MASK (3 &lt;&lt; 16)
+#       define R300_DISP_DAC_PIXCLK_DAC_BLANK_OFF (1&lt;&lt;23)
+
 #define RADEON_HTOTAL_CNTL                  0x0009
-#define RADEON_SCLK_CNTL                    0x000d
+#define RADEON_SCLK_CNTL                    0x000d /* PLL */
+#       define RADEON_SCLK_SRC_SEL_MASK     0x0007
 #       define RADEON_DYN_STOP_LAT_MASK     0x00007ff8
 #       define RADEON_CP_MAX_DYN_STOP_LAT   0x0008
 #       define RADEON_SCLK_FORCEON_MASK     0xffff8000
-#define RADEON_SCLK_MORE_CNTL               0x0035
+#       define RADEON_SCLK_FORCE_DISP2      (1&lt;&lt;15)
+#       define RADEON_SCLK_FORCE_CP         (1&lt;&lt;16)
+#       define RADEON_SCLK_FORCE_HDP        (1&lt;&lt;17)
+#       define RADEON_SCLK_FORCE_DISP1      (1&lt;&lt;18)
+#       define RADEON_SCLK_FORCE_TOP        (1&lt;&lt;19)
+#       define RADEON_SCLK_FORCE_E2         (1&lt;&lt;20)
+#       define RADEON_SCLK_FORCE_SE         (1&lt;&lt;21)
+#       define RADEON_SCLK_FORCE_IDCT       (1&lt;&lt;22)
+#       define RADEON_SCLK_FORCE_VIP        (1&lt;&lt;23)
+#       define RADEON_SCLK_FORCE_RE         (1&lt;&lt;24)
+#       define RADEON_SCLK_FORCE_PB         (1&lt;&lt;25)
+#       define RADEON_SCLK_FORCE_TAM        (1&lt;&lt;26)
+#       define RADEON_SCLK_FORCE_TDM        (1&lt;&lt;27)
+#       define RADEON_SCLK_FORCE_RB         (1&lt;&lt;28)
+#       define RADEON_SCLK_FORCE_TV_SCLK    (1&lt;&lt;29)
+#       define RADEON_SCLK_FORCE_SUBPIC     (1&lt;&lt;30)
+#       define RADEON_SCLK_FORCE_OV0        (1&lt;&lt;31)
+#       define R300_SCLK_FORCE_VAP          (1&lt;&lt;21)
+#       define R300_SCLK_FORCE_SR           (1&lt;&lt;25)
+#       define R300_SCLK_FORCE_PX           (1&lt;&lt;26)
+#       define R300_SCLK_FORCE_TX           (1&lt;&lt;27)
+#       define R300_SCLK_FORCE_US           (1&lt;&lt;28)
+#       define R300_SCLK_FORCE_SU           (1&lt;&lt;30)
+#define R300_SCLK_CNTL2                     0x1e   /* PLL */
+#       define R300_SCLK_TCL_MAX_DYN_STOP_LAT (1&lt;&lt;10)
+#       define R300_SCLK_GA_MAX_DYN_STOP_LAT  (1&lt;&lt;11)
+#       define R300_SCLK_CBA_MAX_DYN_STOP_LAT (1&lt;&lt;12)
+#       define R300_SCLK_FORCE_TCL          (1&lt;&lt;13)
+#       define R300_SCLK_FORCE_CBA          (1&lt;&lt;14)
+#       define R300_SCLK_FORCE_GA           (1&lt;&lt;15)
+#define RADEON_SCLK_MORE_CNTL               0x0035 /* PLL */
+#       define RADEON_SCLK_MORE_MAX_DYN_STOP_LAT 0x0007
 #       define RADEON_SCLK_MORE_FORCEON     0x0700
 #define RADEON_MCLK_CNTL                    0x0012
 #       define RADEON_FORCEON_MCLKA         (1 &lt;&lt; 16)
@@ -69,6 +114,13 @@
 #       define RADEON_FORCEON_YCLKB         (1 &lt;&lt; 19)
 #       define RADEON_FORCEON_MC            (1 &lt;&lt; 20)
 #       define RADEON_FORCEON_AIC           (1 &lt;&lt; 21)
+#       define R300_DISABLE_MC_MCLKA        (1 &lt;&lt; 21)
+#       define R300_DISABLE_MC_MCLKB        (1 &lt;&lt; 21)
+#define RADEON_MCLK_MISC                    0x001f /* PLL */
+#       define RADEON_MC_MCLK_MAX_DYN_STOP_LAT (1&lt;&lt;12)
+#       define RADEON_IO_MCLK_MAX_DYN_STOP_LAT (1&lt;&lt;13)
+#       define RADEON_MC_MCLK_DYN_ENABLE    (1 &lt;&lt; 14)
+#       define RADEON_IO_MCLK_DYN_ENABLE    (1 &lt;&lt; 15)
 #define RADEON_P2PLL_CNTL                   0x002a
 #       define RADEON_P2PLL_RESET               (1 &lt;&lt;  0)
 #       define RADEON_P2PLL_SLEEP               (1 &lt;&lt;  1)
@@ -90,8 +142,23 @@
 #       define RADEON_PIXCLK_TV_SRC_SEL_MASK     (1 &lt;&lt; 8)
 #       define RADEON_PIXCLK_TV_SRC_SEL_PIXCLK   (0 &lt;&lt; 8)
 #       define RADEON_PIXCLK_TV_SRC_SEL_PIX2CLK  (1 &lt;&lt; 8)
+#       define RADEON_PIX2CLK_SRC_SEL_BYTECLK  0x02
+#       define RADEON_PIX2CLK_ALWAYS_ONb       (1&lt;&lt;6)
+#       define RADEON_PIX2CLK_DAC_ALWAYS_ONb   (1&lt;&lt;7)
+#       define RADEON_PIXCLK_TV_SRC_SEL        (1 &lt;&lt; 8)
+#       define RADEON_DISP_TVOUT_PIXCLK_TV_ALWAYS_ONb (1 &lt;&lt; 9)
+#       define R300_DVOCLK_ALWAYS_ONb          (1 &lt;&lt; 10)
+#       define RADEON_PIXCLK_BLEND_ALWAYS_ONb  (1 &lt;&lt; 11)
+#       define RADEON_PIXCLK_GV_ALWAYS_ONb     (1 &lt;&lt; 12)
+#       define RADEON_PIXCLK_DIG_TMDS_ALWAYS_ONb (1 &lt;&lt; 13)
+#       define R300_PIXCLK_DVO_ALWAYS_ONb      (1 &lt;&lt; 13)
 #       define RADEON_PIXCLK_LVDS_ALWAYS_ONb   (1 &lt;&lt; 14)
 #       define RADEON_PIXCLK_TMDS_ALWAYS_ONb   (1 &lt;&lt; 15)
+#       define R300_PIXCLK_TRANS_ALWAYS_ONb    (1 &lt;&lt; 16)
+#       define R300_PIXCLK_TVO_ALWAYS_ONb      (1 &lt;&lt; 17)
+#       define R300_P2G2CLK_ALWAYS_ONb         (1 &lt;&lt; 18)
+#       define R300_P2G2CLK_DAC_ALWAYS_ONb     (1 &lt;&lt; 19)
+#       define R300_DISP_DAC_PIXCLK_DAC2_BLANK_OFF (1 &lt;&lt; 23)
 #define RADEON_HTOTAL2_CNTL                  0x002e
 
 

Modified: haiku/trunk/headers/private/graphics/radeon/radeon_interface.h
===================================================================
--- haiku/trunk/headers/private/graphics/radeon/radeon_interface.h	2007-03-01 08:47:05 UTC (rev 20270)
+++ haiku/trunk/headers/private/graphics/radeon/radeon_interface.h	2007-03-01 09:00:49 UTC (rev 20271)
@@ -17,8 +17,8 @@
 #include &lt;OS.h&gt;
 #include &quot;video_overlay.h&quot;
 #include &quot;benaphore.h&quot;
+#include &quot;ddc.h&quot;
 
-
 // magic code for ioctls
 #define RADEON_PRIVATE_DATA_MAGIC	'TKRA'
 
@@ -94,31 +94,46 @@
 // type of ASIC
 typedef enum {
 	rt_r100,		// original Radeon
-	rt_ve,			// original VE version
-	rt_m6,			// original mobile Radeon
+	rt_rv100,		// original VE version
 	rt_rs100,		// IGP 320M
 	rt_rv200,		// Radeon 7500
-	rt_m7,			// mobile Radeon 7500
 	rt_rs200,		// IGP 330M/340M/350M
 	rt_r200,		// Radeon 8500/9100
 	rt_rv250,		// Radeon 9000
-	rt_m9,			// mobile Radeon 9000
-	rt_rv280,		// Radeon 9200
-	rt_m9plus,		// mobile Radeon 9200
-	
-	// from here on, r300 and up must be located as ATI modified the PLL
-	// with r300 and the code only tests for &gt;= rt_r300
+	rt_rs300,		// IGP rs300
+	rt_rv280,		// Radeon 9200	
+	// from here on, r300 and up must be located as ATI modified the 
+	// PLL design and the PLL code only tests for &gt;= rt_r300
 	rt_r300,		// Radeon 9700
-	rt_r300_4p,		// Radeon 9500
+	rt_r350,		// Radeon 9800
 	rt_rv350,		// Radeon 9600
-	rt_m10,			// mobile Radeon 9600
-	rt_rv360,		// Radeon 9600
-	rt_r350,		// Radeon 9800
-	rt_r360,		// Radeon 9800
-	rt_m11			// Radeon 9700 Mobility
+	rt_rv380,		// X600
+	rt_r420			// X800
 } radeon_type;
 
+#define IS_RV100_VARIANT ( \
+		(ai-&gt;si-&gt;asic == rt_rv100)  ||  \
+        (ai-&gt;si-&gt;asic == rt_rv200)  ||  \
+        (ai-&gt;si-&gt;asic == rt_rs100)  ||  \
+        (ai-&gt;si-&gt;asic == rt_rs200)  ||  \
+        (ai-&gt;si-&gt;asic == rt_rv250)  ||  \
+        (ai-&gt;si-&gt;asic == rt_rv280)  ||  \
+        (ai-&gt;si-&gt;asic == rt_rs300))
 
+#define IS_DI_R300_VARIANT ( \
+		(di-&gt;asic == rt_r300)  ||  \
+        (di-&gt;asic == rt_r350)  || \
+        (di-&gt;asic == rt_rv350) || \
+        (di-&gt;asic == rt_rv380) || \
+        (di-&gt;asic == rt_r420))
+        
+#define IS_R300_VARIANT ( \
+		(ai-&gt;si-&gt;asic == rt_r300)  ||  \
+        (ai-&gt;si-&gt;asic == rt_r350)  || \
+        (ai-&gt;si-&gt;asic == rt_rv350) || \
+        (ai-&gt;si-&gt;asic == rt_rv380) || \
+        (ai-&gt;si-&gt;asic == rt_r420))
+        
 // TV standard
 typedef enum {
 	ts_off,
@@ -390,22 +405,25 @@
 		benaphore	lock;		// engine lock
 	} engine;	
 
-	uint16		vendor_id;	// PCI vendor id
-	uint16		device_id;	// PCI device id
-	uint8		revision;	// PCI device revision
+	uint16		vendor_id;		// PCI vendor id
+	uint16		device_id;		// PCI device id
+	uint8		revision;		// PCI device revision
 	
-	//bool 		has_crtc2;	// has second CRTC
-	radeon_type	asic;		// ASIC version
-	bool		is_mobility; // mobility version
-	tv_chip_type tv_chip;	// type of TV-Out encoder
-	bool		new_pll;	// r300 style PLL
-	
-	uint8		theatre_channel;	// VIP channel of Rage Theatre (if applicable)
+	//bool 		has_crtc2;		// has second CRTC
+	radeon_type	asic;			// ASIC version
+	bool		is_mobility;	// mobility version
+	bool		is_igp;			//	might need to know if it's an integrated chip
+	bool		is_atombios;
+	tv_chip_type tv_chip;		// type of TV-Out encoder
+	bool		new_pll;		// r300 style PLL
+	bool		has_no_i2c; 	// I2C is broken
+	uint16		panel_pwr_delay;// delay for LCD backlight to stabilise
+	uint8		theatre_channel;// VIP channel of Rage Theatre (if applicable)
 		
 	general_pll_info	pll;
 	
-	area_id		regs_area;	// area of memory mapped registers
-	area_id		ROM_area;	// area of ROM
+	area_id		regs_area;		// area of memory mapped registers
+	area_id		ROM_area;		// area of ROM
 	//area_id		fb_area;	// area of frame buffer
 	void		*framebuffer_pci;	// physical address of frame buffer (aka local memory)
 								// this is a hack needed by BeOS

Modified: haiku/trunk/headers/private/graphics/radeon/version.h
===================================================================
--- haiku/trunk/headers/private/graphics/radeon/version.h	2007-03-01 08:47:05 UTC (rev 20270)
+++ haiku/trunk/headers/private/graphics/radeon/version.h	2007-03-01 09:00:49 UTC (rev 20271)
@@ -8,4 +8,4 @@
 */
 
 // current version
-#define RADEON_DRIVER_VERSION &quot;Version: 5.1.0.1&quot;
+#define RADEON_DRIVER_VERSION &quot;Version: 5.1.1.1&quot;

Modified: haiku/trunk/src/add-ons/accelerants/radeon/ProposeDisplayMode.c
===================================================================
--- haiku/trunk/src/add-ons/accelerants/radeon/ProposeDisplayMode.c	2007-03-01 08:47:05 UTC (rev 20270)
+++ haiku/trunk/src/add-ons/accelerants/radeon/ProposeDisplayMode.c	2007-03-01 09:00:49 UTC (rev 20271)
@@ -62,6 +62,8 @@
 { { 108000, 1280, 1376, 1488, 1800, 960, 961, 964, 1000, T_POSITIVE_SYNC}, B_CMAP8, 1152, 864, 0, 0, MODE_FLAGS}, /* <A HREF="https://lists.berlios.de/mailman/listinfo/haiku-commits">Vesa_Monitor_ at 60Hz_</A>(1280X960X8.Z1) - not in Be's list */
 { { 148500, 1280, 1344, 1504, 1728, 960, 961, 964, 1011, T_POSITIVE_SYNC}, B_CMAP8, 1152, 864, 0, 0, MODE_FLAGS}, /* <A HREF="https://lists.berlios.de/mailman/listinfo/haiku-commits">Vesa_Monitor_ at 85Hz_</A>(1280X960X8.Z1) - not in Be's list */
 
+{ { 147100, 1680, 1784, 1968, 2256, 1050, 1051, 1054, 1087, T_POSITIVE_SYNC}, B_CMAP8, 1680, 1050, 0, 0, MODE_FLAGS}, /* <A HREF="https://lists.berlios.de/mailman/listinfo/haiku-commits">Vesa_Monitor_ at 60Hz_</A>(1680X1050) */
+
 { { 108000, 1280, 1328, 1440, 1688, 1024, 1025, 1028, 1066, T_POSITIVE_SYNC}, B_CMAP8, 1280, 1024, 0, 0, MODE_FLAGS}, /* <A HREF="https://lists.berlios.de/mailman/listinfo/haiku-commits">Vesa_Monitor_ at 60Hz_</A>(1280X1024X8.Z1) */
 { { 135000, 1280, 1296, 1440, 1688, 1024, 1025, 1028, 1066, T_POSITIVE_SYNC}, B_CMAP8, 1280, 1024, 0, 0, MODE_FLAGS}, /* <A HREF="https://lists.berlios.de/mailman/listinfo/haiku-commits">Vesa_Monitor_ at 75Hz_</A>(1280X1024X8.Z1) */
 { { 157500, 1280, 1344, 1504, 1728, 1024, 1025, 1028, 1072, T_POSITIVE_SYNC}, B_CMAP8, 1280, 1024, 0, 0, MODE_FLAGS}, /* <A HREF="https://lists.berlios.de/mailman/listinfo/haiku-commits">Vesa_Monitor_ at 85Hz_</A>(1280X1024X8.Z1) */

Modified: haiku/trunk/src/add-ons/accelerants/radeon/SetDisplayMode.c
===================================================================
--- haiku/trunk/src/add-ons/accelerants/radeon/SetDisplayMode.c	2007-03-01 08:47:05 UTC (rev 20270)
+++ haiku/trunk/src/add-ons/accelerants/radeon/SetDisplayMode.c	2007-03-01 09:00:49 UTC (rev 20271)
@@ -20,11 +20,15 @@
 #include &quot;overlay_regs.h&quot;
 #include &quot;rbbm_regs.h&quot;
 #include &quot;dac_regs.h&quot;
+#include &quot;fp_regs.h&quot;
+#include &quot;gpiopad_regs.h&quot;
 
 #include &quot;set_mode.h&quot;
 
 #include &lt;string.h&gt;
 
+void Radeon_SetMode( 
+	accelerator_info *ai, crtc_info *crtc, display_mode *mode, impactv_params *tv_params );
 
 // round virtual width up to next valid size
 uint32 Radeon_RoundVWidth( 

Modified: haiku/trunk/src/add-ons/accelerants/radeon/crtc.c
===================================================================
--- haiku/trunk/src/add-ons/accelerants/radeon/crtc.c	2007-03-01 08:47:05 UTC (rev 20270)
+++ haiku/trunk/src/add-ons/accelerants/radeon/crtc.c	2007-03-01 09:00:49 UTC (rev 20271)
@@ -12,6 +12,7 @@
 #include &quot;crtc_regs.h&quot;
 #include &quot;GlobalData.h&quot;
 #include &quot;set_mode.h&quot;
+#include &quot;generic.h&quot;
 
 
 // hammer CRTC registers

Modified: haiku/trunk/src/add-ons/accelerants/radeon/dpms.c
===================================================================
--- haiku/trunk/src/add-ons/accelerants/radeon/dpms.c	2007-03-01 08:47:05 UTC (rev 20270)
+++ haiku/trunk/src/add-ons/accelerants/radeon/dpms.c	2007-03-01 09:00:49 UTC (rev 20271)
@@ -16,6 +16,7 @@
 #include &quot;tv_out_regs.h&quot;
 #include &quot;theatre_regs.h&quot;
 #include &quot;GlobalData.h&quot;
+#include &quot;generic.h&quot;
 
 
 // public function: set DPMS mode
@@ -78,13 +79,13 @@
 		old_pixclks_cntl = Radeon_INPLL( ai-&gt;regs, ai-&gt;si-&gt;asic, RADEON_PIXCLKS_CNTL);
 		
 		// ASIC bug: when LVDS_ON is reset, LVDS_ALWAYS_ON must be zero
-		if( ai-&gt;si-&gt;is_mobility || ai-&gt;si-&gt;asic == rt_rs100 ) 
+		if( ai-&gt;si-&gt;is_mobility || ai-&gt;si-&gt;is_igp ) 
 			Radeon_OUTPLLP( ai-&gt;regs, ai-&gt;si-&gt;asic, RADEON_PIXCLKS_CNTL, 0, ~RADEON_PIXCLK_LVDS_ALWAYS_ONb );
 
 		OUTREGP( regs, RADEON_LVDS_GEN_CNTL, RADEON_LVDS_DISPLAY_DIS,
 			~(RADEON_LVDS_DISPLAY_DIS | RADEON_LVDS_BLON | RADEON_LVDS_ON) );
 			
-		if( ai-&gt;si-&gt;is_mobility || ai-&gt;si-&gt;asic == rt_rs100 ) 
+		if( ai-&gt;si-&gt;is_mobility || ai-&gt;si-&gt;is_igp ) 
 			Radeon_OUTPLL( ai-&gt;regs, ai-&gt;si-&gt;asic, RADEON_PIXCLKS_CNTL, old_pixclks_cntl );
 
 		break; }

Modified: haiku/trunk/src/add-ons/accelerants/radeon/driver_wrapper.c
===================================================================
--- haiku/trunk/src/add-ons/accelerants/radeon/driver_wrapper.c	2007-03-01 08:47:05 UTC (rev 20270)
+++ haiku/trunk/src/add-ons/accelerants/radeon/driver_wrapper.c	2007-03-01 09:00:49 UTC (rev 20271)
@@ -9,7 +9,10 @@
 
 #include &quot;radeon_accelerant.h&quot;
 #include &lt;sys/ioctl.h&gt;
+#include &quot;rbbm_regs.h&quot;
+#include &quot;mmio.h&quot;
 
+
 status_t Radeon_WaitForIdle( accelerator_info *ai, bool keep_lock )
 {
 	radeon_wait_for_idle wfi;

Modified: haiku/trunk/src/add-ons/accelerants/radeon/flat_panel.c
===================================================================
--- haiku/trunk/src/add-ons/accelerants/radeon/flat_panel.c	2007-03-01 08:47:05 UTC (rev 20270)
+++ haiku/trunk/src/add-ons/accelerants/radeon/flat_panel.c	2007-03-01 09:00:49 UTC (rev 20271)
@@ -13,6 +13,8 @@
 #include &quot;memcntrl_regs.h&quot;
 #include &quot;utils.h&quot;
 #include &quot;set_mode.h&quot;
+#include &quot;pll_regs.h&quot;
+#include &quot;pll_access.h&quot;
 
 
 void Radeon_ReadRMXRegisters( 
@@ -125,7 +127,7 @@
 	values-&gt;fp2_h_sync_strt_wid = INREG( regs, RADEON_FP_H2_SYNC_STRT_WID );
 	values-&gt;fp2_v_sync_strt_wid = INREG( regs, RADEON_FP_V2_SYNC_STRT_WID );
 
-    SHOW_FLOW( 2, &quot;before: fp_gen_cntl=%lx, horz=%lx, vert=%lx, lvds_gen_cntl=%lx&quot;,
+    SHOW_FLOW( 2, &quot;before: fp_gen_cntl=%08lx, horz=%08lx, vert=%08lx, lvds_gen_cntl=%08lx&quot;,
     	values-&gt;fp_gen_cntl, values-&gt;fp_horz_stretch, values-&gt;fp_vert_stretch, 
     	values-&gt;lvds_gen_cntl );
 }
@@ -185,7 +187,7 @@
 			values-&gt;fp2_gen_cntl |= RADEON_FP2_DV0_EN;
 	}
 		
-    SHOW_FLOW( 2, &quot;after: fp_gen_cntl=%lx, horz=%lx, vert=%lx, lvds_gen_cntl=%lx&quot;,
+    SHOW_FLOW( 2, &quot;after: fp_gen_cntl=%08lx, horz=%08lx, vert=%08lx, lvds_gen_cntl=%08lx&quot;,
     	values-&gt;fp_gen_cntl, values-&gt;fp_horz_stretch, values-&gt;fp_vert_stretch, 
     	values-&gt;lvds_gen_cntl );
 }

Modified: haiku/trunk/src/add-ons/accelerants/radeon/internal_tv_out.c
===================================================================
--- haiku/trunk/src/add-ons/accelerants/radeon/internal_tv_out.c	2007-03-01 08:47:05 UTC (rev 20270)
+++ haiku/trunk/src/add-ons/accelerants/radeon/internal_tv_out.c	2007-03-01 09:00:49 UTC (rev 20271)
@@ -122,6 +122,7 @@
 
 
 // read timing FIFO
+#if 0
 static uint32 Radeon_InternalTVOutReadFIFO( 
 	accelerator_info *ai, uint16 addr )
 {
@@ -151,8 +152,8 @@
 	
 	return res;
 }
+#endif
 
-
 // write to timing FIFO
 static void Radeon_InternalTVOutWriteFIFO( 
 	accelerator_info *ai, uint16 addr, uint32 value )

Modified: haiku/trunk/src/add-ons/accelerants/radeon/monitor_detection.c
===================================================================
--- haiku/trunk/src/add-ons/accelerants/radeon/monitor_detection.c	2007-03-01 08:47:05 UTC (rev 20270)
+++ haiku/trunk/src/add-ons/accelerants/radeon/monitor_detection.c	2007-03-01 09:00:49 UTC (rev 20271)
@@ -16,11 +16,13 @@
 #include &quot;config_regs.h&quot;
 #include &quot;ddc_regs.h&quot;
 #include &quot;gpiopad_regs.h&quot;
+#include &quot;fp_regs.h&quot;
 #include &quot;pll_access.h&quot;
 #include &quot;theatre_regs.h&quot;
 #include &quot;set_mode.h&quot;
 #include &quot;ddc.h&quot;
 #include &lt;malloc.h&gt;
+#include &quot;string.h&quot;
 
 typedef struct {
 	accelerator_info *ai;
@@ -294,34 +296,31 @@
 // check whether there is a CRT connected to TV-DAC
 static bool Radeon_DetectTVCRT( accelerator_info *ai )
 {
+	if (ai-&gt;si-&gt;is_mobility)
+		return dd_none;
+		
 	switch( ai-&gt;si-&gt;asic ) {
 	case rt_r100:
-	case rt_m6:
-	case rt_m7:
-	case rt_m9:
-	case rt_m9plus:
-	case rt_m10:
 		// original Radeons have pure DVI only and mobility chips
 		// have no DVI connector
 		// TBD: can they have a docking station for CRT on TV-DAC?
 		return dd_none;
 		
-	case rt_ve:
+	case rt_rv100:
 	case rt_rv200:
 	case rt_rv250:
 	case rt_rv280:
 	// IGP is guessed
 	case rt_rs100:
 	case rt_rs200:
+	case rt_rs300:
 		return Radeon_DetectTVCRT_RV200( ai );
 		
 	case rt_r300:
-	case rt_r300_4p:
-	case rt_rv350:
-	case rt_rv360:
 	case rt_r350:
-	case rt_r360:
-	case rt_m11:
+	case rt_rv350:
+	case rt_rv380:
+	case rt_r420:
 		return Radeon_DetectTVCRT_R300( ai );
 		
 	case rt_r200:
@@ -662,27 +661,21 @@
 	case rt_r200:
 		return Radeon_DetectTV_Theatre( ai );
 		
-	case rt_ve:
-	case rt_m6:
+	case rt_rv100:
 	case rt_rv200:
-	case rt_m7:
 	case rt_rv250:
-	case rt_m9:
 	case rt_rv280:
-	case rt_m9plus:
 	// IGP method is guessed
 	case rt_rs100:
 	case rt_rs200:
+	case rt_rs300:
 		return Radeon_DetectTV_RV200( ai, tv_crt_found );
 		
 	case rt_r300:
-	case rt_r300_4p:
-	case rt_rv350:
-	case rt_rv360:
-	case rt_m10:
-	case rt_m11:
 	case rt_r350:
-	case rt_r360:
+	case rt_rv350:
+	case rt_rv380:
+	case rt_r420:
 		return Radeon_DetectTV_R300( ai );
 	}
 			
@@ -812,8 +805,8 @@
 	fp_info *fp = &amp;ai-&gt;si-&gt;flatpanels[0];
 	uint32 max_hsize, max_vsize;
 
-	SHOW_FLOW0( 2, &quot;EDID data read from DVI port via DDC2:&quot; );
-	edid_dump( edid );
+	//SHOW_FLOW0( 2, &quot;EDID data read from DVI port via DDC2:&quot; );
+	//edid_dump( edid );
 
 	// find detailed timing with maximum resolution
 	max_hsize = max_vsize = 0;

Modified: haiku/trunk/src/add-ons/accelerants/radeon/monitor_routing.c
===================================================================
--- haiku/trunk/src/add-ons/accelerants/radeon/monitor_routing.c	2007-03-01 08:47:05 UTC (rev 20270)
+++ haiku/trunk/src/add-ons/accelerants/radeon/monitor_routing.c	2007-03-01 09:00:49 UTC (rev 20271)
@@ -37,16 +37,13 @@
 	values-&gt;vclk_ecp_cntl = Radeon_INPLL( ai-&gt;regs, ai-&gt;si-&gt;asic, RADEON_VCLK_ECP_CNTL );
 	
 	switch( ai-&gt;si-&gt;asic ) {
-	case rt_ve:
-	case rt_m6:
+	case rt_rv100:
 	case rt_rv200:	
-	case rt_m7:
 	case rt_rv250:
-	case rt_m9:
 	case rt_rv280:
-	case rt_m9plus:
 	case rt_rs100:
 	case rt_rs200:
+	case rt_rs300:
 		values-&gt;disp_hw_debug = INREG( regs, RADEON_DISP_HW_DEBUG );
 		break;
 
@@ -55,13 +52,10 @@
 		break;
 
 	case rt_r300:
-	case rt_r300_4p:
 	case rt_rv350:
-	case rt_m10:
-	case rt_rv360:
 	case rt_r350:
-	case rt_r360:
-	case rt_m11:
+	case rt_rv380:
+	case rt_r420:
 		values-&gt;gpiopad_a = INREG( regs, RADEON_GPIOPAD_A );
 		break;
 		
@@ -137,29 +131,23 @@
 		values-&gt;crtc_ext_cntl |= RADEON_CRTC_CRT_ON;
 
 		switch( ai-&gt;si-&gt;asic ) {
-		case rt_ve:
-		case rt_m6:
-		case rt_rv200:	
-		case rt_m7:
+		case rt_rv100:
+		case rt_rv200:
 		case rt_rv250:
-		case rt_m9:
 		case rt_rv280:
-		case rt_m9plus:
 		case rt_rs100:
 		case rt_rs200:
+		case rt_rs300:
 			values-&gt;dac_cntl2 &amp;= ~RADEON_DAC_CLK_SEL_MASK;
 			values-&gt;dac_cntl2 |= crtc_idx == 0 ? 0 : RADEON_DAC_CLK_SEL_CRTC2;
 			break;
 
 		case rt_r200:
 		case rt_r300:
-		case rt_r300_4p:
 		case rt_rv350:
-		case rt_m10:
-		case rt_m11:
-		case rt_rv360:
 		case rt_r350:
-		case rt_r360:
+		case rt_rv380:
+		case rt_r420:
 			values-&gt;disp_output_cntl &amp;= ~RADEON_DISP_DAC_SOURCE_MASK;
 			values-&gt;disp_output_cntl |=
 				(crtc_idx == 0 ? 0 : RADEON_DISP_DAC_SOURCE_CRTC2);
@@ -203,22 +191,9 @@
 			(2 &lt;&lt; RADEON_TV_DAC_CNTL_DACADJ_SHIFT);
 		
 		// at least r300 needs magic bit set to switch between TV-CRT and TV-Out
-		switch( ai-&gt;si-&gt;asic ) {
-			case rt_r200:
-			case rt_r300:
-			case rt_r300_4p:
-			case rt_rv350:
-			case rt_m10:
-			case rt_m11:
-			case rt_rv360:
-			case rt_r350:
-			case rt_r360:
+		if (IS_R300_VARIANT)
 				values-&gt;gpiopad_a |= 1;
-				break;
-			default:
-				;
-		}
-		
+				
 	} else if( (controlled_devices &amp; dd_tv_crt) != 0 ) {
 		values-&gt;crtc2_gen_cntl &amp;= ~RADEON_CRTC2_CRT2_ON;
 	}
@@ -239,22 +214,10 @@
 		values-&gt;dac_cntl2 |= RADEON_DAC2_CLK_SEL_TV;
 		
 		// at least r300 needs magic bit set to switch between TV-CRT and TV-Out
-		switch( ai-&gt;si-&gt;asic ) {
-			case rt_r200:
-			case rt_r300:
-			case rt_r300_4p:
-			case rt_rv350:
-			case rt_rv360:
-			case rt_m10:
-			case rt_m11:
-			case rt_r350:
-			case rt_r360:
+		if(IS_R300_VARIANT)
 				values-&gt;gpiopad_a &amp;= ~1;
-				break;
-			default:
-				;
-		}
 		
+		
 		// the TV-DAC itself is under control of the TV-Out code
 		values-&gt;skip_tv_dac = true;
 		
@@ -330,17 +293,14 @@
 		int crtc_idx = (display_devices[1] &amp; (dd_tv_crt | dd_ctv | dd_stv)) != 0;
 		
 		switch( ai-&gt;si-&gt;asic ) {
-		case rt_ve:
-		case rt_m6:
+		case rt_rv100:
 		case rt_rv200:	
-		case rt_m7:
 		case rt_rv250:
-		case rt_m9:
 		case rt_rv280:
-		case rt_m9plus:
 		case rt_rs100:
 		case rt_rs200:
-			values-&gt;disp_hw_debug &amp;= ~RADEON_CRT2_DISP1_SEL;
+		case rt_rs300:
+					values-&gt;disp_hw_debug &amp;= ~RADEON_CRT2_DISP1_SEL;
 			// warning: meaning is wrong way around - 0 means crtc2, 1 means crtc1
 			values-&gt;disp_hw_debug |= crtc_idx == 0 ? RADEON_CRT2_DISP1_SEL : 0;
 			break;
@@ -354,13 +314,10 @@
 			break;
 
 		case rt_r300:
-		case rt_r300_4p:
 		case rt_rv350:
-		case rt_m10:
-		case rt_m11:
-		case rt_rv360:
 		case rt_r350:
-		case rt_r360:
+		case rt_rv380:
+		case rt_r420:
 			values-&gt;disp_output_cntl &amp;= ~RADEON_DISP_TVDAC_SOURCE_MASK;
 			values-&gt;disp_output_cntl |=
 				crtc_idx == 0 ? 0 : RADEON_DISP_TVDAC_SOURCE_CRTC2;
@@ -444,7 +401,8 @@
 		case rt_r300:
 		case rt_r350:
 		case rt_rv350:	
-		case rt_m10:
+		case rt_rv380:
+		case rt_r420:
 			values-&gt;fp2_gen_cntl &amp;= ~RADEON_FP2_SOURCE_SEL_CRTC2;
 		    values-&gt;fp2_gen_cntl |= 
 		    	crtc_idx == 0 ? 0 : RADEON_FP2_SOURCE_SEL_CRTC2;
@@ -470,16 +428,13 @@
 	OUTREG( regs, RADEON_DISP_OUTPUT_CNTL, values-&gt;disp_output_cntl );
 
 	switch( ai-&gt;si-&gt;asic ) {
-	case rt_ve:
-	case rt_m6:
+	case rt_rv100:
 	case rt_rv200:	
-	case rt_m7:
 	case rt_rv250:
-	case rt_m9:
 	case rt_rv280:
-	case rt_m9plus:
 	case rt_rs100:
 	case rt_rs200:
+	case rt_rs300:
 		OUTREG( regs, RADEON_DISP_HW_DEBUG, values-&gt;disp_hw_debug );
 		break;
 		
@@ -488,13 +443,10 @@
 		break;
 
 	case rt_r300:
-	case rt_r300_4p:
 	case rt_rv350:
-	case rt_m10:
-	case rt_m11:
-	case rt_rv360:
 	case rt_r350:
-	case rt_r360:
+	case rt_rv380:
+	case rt_r420:
 		OUTREGP( regs, RADEON_GPIOPAD_A, values-&gt;gpiopad_a, ~1 );
 		break;
 		
@@ -589,7 +541,7 @@
 
 // internal version of SetupDefaultMonitorRouting;
 // input and output are written to local variables
-void assignDefaultMonitorRoute( 
+static void assignDefaultMonitorRoute( 
 	accelerator_info *ai,
 	display_device_e display_devices, int whished_num_heads, bool use_laptop_panel,
 	display_device_e *crtc1, display_device_e *crtc2 )

Modified: haiku/trunk/src/add-ons/accelerants/radeon/overlay_management.c
===================================================================
--- haiku/trunk/src/add-ons/accelerants/radeon/overlay_management.c	2007-03-01 08:47:05 UTC (rev 20270)
+++ haiku/trunk/src/add-ons/accelerants/radeon/overlay_management.c	2007-03-01 09:00:49 UTC (rev 20271)
@@ -14,6 +14,7 @@
 #include &lt;sys/ioctl.h&gt;
 #include &lt;string.h&gt;
 #include &quot;overlay_regs.h&quot;
+#include &quot;generic.h&quot;
 
 // we could add support of planar modes and YUV modes
 // but I neither know how planar modes are defined nor
@@ -148,7 +149,7 @@
 	node-&gt;mem_handle = am.handle;
 	node-&gt;mem_offset = am.offset;
 	buffer-&gt;buffer = si-&gt;local_mem + am.offset;
-	buffer-&gt;buffer_dma = si-&gt;framebuffer_pci + am.offset;
+	buffer-&gt;buffer_dma = (void *) ((unsigned long) si-&gt;framebuffer_pci + am.offset);
 	
 	// add to list of overlays
 	node-&gt;next = vc-&gt;overlay_buffers;

Modified: haiku/trunk/src/add-ons/accelerants/radeon/palette.c
===================================================================
--- haiku/trunk/src/add-ons/accelerants/radeon/palette.c	2007-03-01 08:47:05 UTC (rev 20270)
+++ haiku/trunk/src/add-ons/accelerants/radeon/palette.c	2007-03-01 09:00:49 UTC (rev 20271)
@@ -14,8 +14,8 @@
 #include &quot;GlobalData.h&quot;
 #include &quot;dac_regs.h&quot;
 #include &quot;CP.h&quot;
+#include &quot;generic.h&quot;
 
-
 // Radeon's DACs share same public registers, this function
 // selects the DAC you'll talk to
 #define selectPalette( crtc_idx ) \

Modified: haiku/trunk/src/add-ons/accelerants/radeon/pll.c
===================================================================
--- haiku/trunk/src/add-ons/accelerants/radeon/pll.c	2007-03-01 08:47:05 UTC (rev 20270)
+++ haiku/trunk/src/add-ons/accelerants/radeon/pll.c	2007-03-01 09:00:49 UTC (rev 20271)
@@ -477,6 +477,8 @@
     OUTREGP( regs, RADEON_CLOCK_CNTL_INDEX,
 	    RADEON_PLL_DIV_SEL_DIV3,
 	    ~RADEON_PLL_DIV_SEL_MASK );
+	   
+	RADEONPllErrataAfterIndex(regs, asic);
 
 	if( ai-&gt;si-&gt;new_pll &amp;&amp; crtc_idx == 0 ) {
 		// starting with r300, the reference divider of the first PLL was 

Modified: haiku/trunk/src/add-ons/accelerants/radeon/radeon_accelerant.h
===================================================================
--- haiku/trunk/src/add-ons/accelerants/radeon/radeon_accelerant.h	2007-03-01 08:47:05 UTC (rev 20270)
+++ haiku/trunk/src/add-ons/accelerants/radeon/radeon_accelerant.h	2007-03-01 09:00:49 UTC (rev 20271)
@@ -78,8 +78,8 @@
 // SetDisplayMode.c
 uint32 Radeon_RoundVWidth( int virtual_width, int bpp );
 status_t Radeon_MoveDisplay( accelerator_info *ai, uint16 h_display_start, uint16 v_display_start );
+void Radeon_EnableIRQ( accelerator_info *ai, bool enable );
 
-
 // multimon.c
 void Radeon_HideMultiMode( virtual_card *vc, display_mode *mode );
 void Radeon_DetectMultiMode( virtual_card *vc, display_mode *mode );
@@ -130,14 +130,15 @@
 // overlay.c
 void Radeon_HideOverlay( accelerator_info *ai );
 status_t Radeon_UpdateOverlay( accelerator_info *ai );
+void Radeon_InitOverlay( accelerator_info *ai, int crtc_idx );
 
-
 // EngineManagement.c
 void Radeon_Spin( uint32 delay );
 
 
 // monitor_detection.c
 void Radeon_DetectDisplays( accelerator_info *ai );
+bool Radeon_ReadEDID( accelerator_info *ai, uint32 ddc_port, edid1_info *edid );
 
 
 // palette.c

Modified: haiku/trunk/src/add-ons/accelerants/radeon/set_mode.h
===================================================================
--- haiku/trunk/src/add-ons/accelerants/radeon/set_mode.h	2007-03-01 08:47:05 UTC (rev 20270)
+++ haiku/trunk/src/add-ons/accelerants/radeon/set_mode.h	2007-03-01 09:00:49 UTC (rev 20271)
@@ -25,19 +25,19 @@
 // TV-timing
 typedef struct {
 	uint32 freq;				// TV sub carrier frequency x12
-    uint16 h_total;
-    uint16 h_sync_len;
-    uint16 h_genclk_delay;
-    uint16 h_setup_delay;
-    uint16 h_active_delay;
-    uint16 h_active_len;
-    uint16 v_total;
-    uint16 v_active_lines;
-    uint16 v_field_total;
-    uint16 v_fields;
-    uint16 f_total;
-    uint16 frame_size_adjust;
-    uint32 scale;
+	uint16 h_total;
+	uint16 h_sync_len;
+	uint16 h_genclk_delay;
+	uint16 h_setup_delay;
+	uint16 h_active_delay;
+	uint16 h_active_len;
+	uint16 v_total;
+	uint16 v_active_lines;
+	uint16 v_field_total;
+	uint16 v_fields;
+	uint16 f_total;
+	uint16 frame_size_adjust;
+	uint32 scale;
 } tv_timing;
 
 
@@ -64,7 +64,7 @@
 	pll_dividers	tv_dividers;
 	pll_dividers	crt_dividers;
 	
-	tv_timing timing;
+	tv_timing		timing;
 } impactv_params;
 
 
@@ -88,9 +88,9 @@
 	
 	// pure information
 	uint32		dot_clock_freq;	// in 10 kHz
-    uint32		pll_output_freq;// in 10 kHz
-    int			feedback_div;
-    int			post_div;
+	uint32		pll_output_freq;// in 10 kHz
+	int			feedback_div;
+	int			post_div;
 } pll_regs;
 
 

Modified: haiku/trunk/src/add-ons/kernel/drivers/graphics/radeon/CP_setup.c
===================================================================
--- haiku/trunk/src/add-ons/kernel/drivers/graphics/radeon/CP_setup.c	2007-03-01 08:47:05 UTC (rev 20270)
+++ haiku/trunk/src/add-ons/kernel/drivers/graphics/radeon/CP_setup.c	2007-03-01 09:00:49 UTC (rev 20271)
@@ -27,6 +27,8 @@
 #include &quot;pll_regs.h&quot;
 #include &quot;rbbm_regs.h&quot;

[... truncated: 969 lines follow ...]

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000971.html">[Haiku-commits] r20270 -	haiku/trunk/src/tests/kits/interface/picture
</A></li>
	<LI>Next message: <A HREF="000973.html">[Haiku-commits] r20272 - in haiku/trunk:	headers/private/graphics/radeon	src/add-ons/kernel/drivers/graphics/radeon
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#972">[ date ]</a>
              <a href="thread.html#972">[ thread ]</a>
              <a href="subject.html#972">[ subject ]</a>
              <a href="author.html#972">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/haiku-commits">More information about the Haiku-commits
mailing list</a><br>
</body></html>
