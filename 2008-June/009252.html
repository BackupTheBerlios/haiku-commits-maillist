<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Haiku-commits] r25752 - in haiku/trunk: headers/os/drivers	headers/private/kernel headers/private/system	src/add-ons/kernel/bus_managers/ide	src/add-ons/kernel/bus_managers/pci/arch/x86	src/add-ons/kernel/bus_managers/ps2	src/add-ons/kernel/bus_managers/scsi	src/add-ons/kernel/busses/scsi/ahci src/add-ons/kernel/busses/usb	src/add-ons/kernel/drivers/audio/ac97/auich	src/add-ons/kernel/drivers/audio/ac97/auvia	src/add-ons/kernel/drivers/audio/emuxki	src/add-ons/kernel/drivers/graphics/radeon	src/add-ons/kernel/drivers/network/rtl8169	src/add-ons/kernel/generic/dpc src/add-ons/kernel/generic/mpu401	src/libs/compat/freebsd_network src/system/kernel	src/system/kernel/arch/m68k src/system/kernel/arch/x86	src/system/kernel/debug
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/haiku-commits/2008-June/index.html" >
   <LINK REL="made" HREF="mailto:haiku-commits%40lists.berlios.de?Subject=Re%3A%20%5BHaiku-commits%5D%20r25752%20-%20in%20haiku/trunk%3A%20headers/os/drivers%0A%09headers/private/kernel%20headers/private/system%0A%09src/add-ons/kernel/bus_managers/ide%0A%09src/add-ons/kernel/bus_managers/pci/arch/x86%0A%09src/add-ons/kernel/bus_managers/ps2%0A%09src/add-ons/kernel/bus_managers/scsi%0A%09src/add-ons/kernel/busses/scsi/ahci%20src/add-ons/kernel/busses/usb%0A%09src/add-ons/kernel/drivers/audio/ac97/auich%0A%09src/add-ons/kernel/drivers/audio/ac97/auvia%0A%09src/add-ons/kernel/drivers/audio/emuxki%0A%09src/add-ons/kernel/drivers/graphics/radeon%0A%09src/add-ons/kernel/drivers/network/rtl8169%0A%09src/add-ons/kernel/generic/dpc%20src/add-ons/kernel/generic/mpu401%0A%09src/libs/compat/freebsd_network%20src/system/kernel%0A%09src/system/kernel/arch/m68k%20src/system/kernel/arch/x86%0A%09src/system/kernel/debug&In-Reply-To=%3C200806020204.m5224IeL027525%40sheep.berlios.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="009251.html">
   <LINK REL="Next"  HREF="009270.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Haiku-commits] r25752 - in haiku/trunk: headers/os/drivers	headers/private/kernel headers/private/system	src/add-ons/kernel/bus_managers/ide	src/add-ons/kernel/bus_managers/pci/arch/x86	src/add-ons/kernel/bus_managers/ps2	src/add-ons/kernel/bus_managers/scsi	src/add-ons/kernel/busses/scsi/ahci src/add-ons/kernel/busses/usb	src/add-ons/kernel/drivers/audio/ac97/auich	src/add-ons/kernel/drivers/audio/ac97/auvia	src/add-ons/kernel/drivers/audio/emuxki	src/add-ons/kernel/drivers/graphics/radeon	src/add-ons/kernel/drivers/network/rtl8169	src/add-ons/kernel/generic/dpc src/add-ons/kernel/generic/mpu401	src/libs/compat/freebsd_network src/system/kernel	src/system/kernel/arch/m68k src/system/kernel/arch/x86	src/system/kernel/debug</H1>
    <B>bonefish at BerliOS</B> 
    <A HREF="mailto:haiku-commits%40lists.berlios.de?Subject=Re%3A%20%5BHaiku-commits%5D%20r25752%20-%20in%20haiku/trunk%3A%20headers/os/drivers%0A%09headers/private/kernel%20headers/private/system%0A%09src/add-ons/kernel/bus_managers/ide%0A%09src/add-ons/kernel/bus_managers/pci/arch/x86%0A%09src/add-ons/kernel/bus_managers/ps2%0A%09src/add-ons/kernel/bus_managers/scsi%0A%09src/add-ons/kernel/busses/scsi/ahci%20src/add-ons/kernel/busses/usb%0A%09src/add-ons/kernel/drivers/audio/ac97/auich%0A%09src/add-ons/kernel/drivers/audio/ac97/auvia%0A%09src/add-ons/kernel/drivers/audio/emuxki%0A%09src/add-ons/kernel/drivers/graphics/radeon%0A%09src/add-ons/kernel/drivers/network/rtl8169%0A%09src/add-ons/kernel/generic/dpc%20src/add-ons/kernel/generic/mpu401%0A%09src/libs/compat/freebsd_network%20src/system/kernel%0A%09src/system/kernel/arch/m68k%20src/system/kernel/arch/x86%0A%09src/system/kernel/debug&In-Reply-To=%3C200806020204.m5224IeL027525%40sheep.berlios.de%3E"
       TITLE="[Haiku-commits] r25752 - in haiku/trunk: headers/os/drivers	headers/private/kernel headers/private/system	src/add-ons/kernel/bus_managers/ide	src/add-ons/kernel/bus_managers/pci/arch/x86	src/add-ons/kernel/bus_managers/ps2	src/add-ons/kernel/bus_managers/scsi	src/add-ons/kernel/busses/scsi/ahci src/add-ons/kernel/busses/usb	src/add-ons/kernel/drivers/audio/ac97/auich	src/add-ons/kernel/drivers/audio/ac97/auvia	src/add-ons/kernel/drivers/audio/emuxki	src/add-ons/kernel/drivers/graphics/radeon	src/add-ons/kernel/drivers/network/rtl8169	src/add-ons/kernel/generic/dpc src/add-ons/kernel/generic/mpu401	src/libs/compat/freebsd_network src/system/kernel	src/system/kernel/arch/m68k src/system/kernel/arch/x86	src/system/kernel/debug">bonefish at mail.berlios.de
       </A><BR>
    <I>Mon Jun  2 04:04:18 CEST 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="009251.html">[Haiku-commits] r25704 - in haiku/trunk: headers/private/kernel src/system/kernel
</A></li>
        <LI>Next message: <A HREF="009270.html">[Haiku-commits] r25752 - in haiku/trunk: headers/os/drivers headers/private/kernel  headers/private/system src/add-ons/kernel/bus_managers/ide src/add-ons/kernel/bus_managers/pci/arch/x86 src/add-ons/kernel/bus_managers/ps2 src/add-ons/kernel/bus_managers/scsi src/add-ons/kernel/busses/scsi/ahci  src/add-ons/kernel/busses/usb src/add-ons/kernel/drivers/audio/ac97/auich src/add-ons/kernel/drivers/audio/ac97/auvia src/add-ons/kernel/drivers/audio/emuxki src/add-ons/kernel/drivers/graphics/radeon src/add-ons/kernel/drivers/network/rtl8169 src/add-ons/kernel/generic/dpc  src/add-ons/kernel/generic/mpu401 src/libs/compat/freebsd_network src/system/kernel src/system/kernel/arch/m68k src/system/kernel/arch/x86 src/system/kernel/debug
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9252">[ date ]</a>
              <a href="thread.html#9252">[ thread ]</a>
              <a href="subject.html#9252">[ subject ]</a>
              <a href="author.html#9252">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: bonefish
Date: 2008-06-02 04:04:12 +0200 (Mon, 02 Jun 2008)
New Revision: 25752
ViewCVS: <A HREF="http://svn.berlios.de/viewcvs/haiku?rev=25752&amp;view=rev">http://svn.berlios.de/viewcvs/haiku?rev=25752&amp;view=rev</A>

Added:
   haiku/trunk/headers/private/system/spinlock_contention.h
Modified:
   haiku/trunk/headers/os/drivers/KernelExport.h
   haiku/trunk/headers/private/kernel/smp.h
   haiku/trunk/src/add-ons/kernel/bus_managers/ide/ide_sim.c
   haiku/trunk/src/add-ons/kernel/bus_managers/pci/arch/x86/pci_controller.c
   haiku/trunk/src/add-ons/kernel/bus_managers/ps2/packet_buffer.cpp
   haiku/trunk/src/add-ons/kernel/bus_managers/scsi/scsi_lock.h
   haiku/trunk/src/add-ons/kernel/busses/scsi/ahci/ahci_port.cpp
   haiku/trunk/src/add-ons/kernel/busses/usb/ehci.cpp
   haiku/trunk/src/add-ons/kernel/busses/usb/ohci.cpp
   haiku/trunk/src/add-ons/kernel/busses/usb/uhci.cpp
   haiku/trunk/src/add-ons/kernel/drivers/audio/ac97/auich/util.c
   haiku/trunk/src/add-ons/kernel/drivers/audio/ac97/auvia/util.c
   haiku/trunk/src/add-ons/kernel/drivers/audio/emuxki/util.c
   haiku/trunk/src/add-ons/kernel/drivers/graphics/radeon/irq.c
   haiku/trunk/src/add-ons/kernel/drivers/network/rtl8169/device.c
   haiku/trunk/src/add-ons/kernel/drivers/network/rtl8169/timer.c
   haiku/trunk/src/add-ons/kernel/generic/dpc/dpc.c
   haiku/trunk/src/add-ons/kernel/generic/mpu401/mpu401.c
   haiku/trunk/src/libs/compat/freebsd_network/taskqueue.c
   haiku/trunk/src/system/kernel/arch/m68k/arch_vm_translation_map_impl.cpp
   haiku/trunk/src/system/kernel/arch/x86/arch_debug_console.c
   haiku/trunk/src/system/kernel/arch/x86/arch_vm_translation_map.cpp
   haiku/trunk/src/system/kernel/debug/debug.cpp
   haiku/trunk/src/system/kernel/debug/debug_commands.cpp
   haiku/trunk/src/system/kernel/debug/user_debugger.cpp
   haiku/trunk/src/system/kernel/int.c
   haiku/trunk/src/system/kernel/main.cpp
   haiku/trunk/src/system/kernel/port.cpp
   haiku/trunk/src/system/kernel/sem.cpp
   haiku/trunk/src/system/kernel/smp.c
   haiku/trunk/src/system/kernel/team.cpp
   haiku/trunk/src/system/kernel/thread.cpp
Log:
* Added optional spinlock contention measurement feature. Enabled when
  B_DEBUG_SPINLOCK_CONTENTION is defined to 1. It typedefs spinlock to a
  structure (thus breaking BeOS binary compatibility), containing a
  counter which is incremented whenever a thread has to wait for the
  spinlock.
* Added macros for spinlock initialization and access and changed
  code using spinlocks accordingly. This breaks compilation for BeOS --
  the macros should be defined in the respective compatibility wrappers.
* Added generic syscall to get the spinlock counters for the thread and
  the team spinlocks.


Modified: haiku/trunk/headers/os/drivers/KernelExport.h
===================================================================
--- haiku/trunk/headers/os/drivers/KernelExport.h	2008-06-01 21:18:08 UTC (rev 25751)
+++ haiku/trunk/headers/os/drivers/KernelExport.h	2008-06-02 02:04:12 UTC (rev 25752)
@@ -13,8 +13,33 @@
 /* interrupts and spinlocks */
 
 typedef ulong cpu_status;
-typedef vint32 spinlock;
 
+// WARNING: For Haiku debugging only! This changes the spinlock type in a
+// binary incompatible way!
+//#define B_DEBUG_SPINLOCK_CONTENTION	1
+
+#if B_DEBUG_SPINLOCK_CONTENTION
+	typedef struct {
+		vint32	lock;
+		vint32	count_low;
+		vint32	count_high;
+	} spinlock;
+
+#	define B_SPINLOCK_INITIALIZER { 0, 0, 0 }
+#	define B_INITIALIZE_SPINLOCK(spinlock)	do {	\
+			(spinlock)-&gt;lock = 0;					\
+			(spinlock)-&gt;count_low = 0;				\
+			(spinlock)-&gt;count_high = 0;				\
+		} while (false)
+#	define B_SPINLOCK_IS_LOCKED(spinlock)	((spinlock)-&gt;lock &gt; 0)
+#else
+	typedef vint32 spinlock;
+
+#	define B_SPINLOCK_INITIALIZER 0
+#	define B_INITIALIZE_SPINLOCK(lock)	do { *(lock) = 0; } while (false)
+#	define B_SPINLOCK_IS_LOCKED(lock)	(*(lock) &gt; 0)
+#endif
+
 /* interrupt handling support for device drivers */
 
 typedef int32 (*interrupt_handler)(void *data);

Modified: haiku/trunk/headers/private/kernel/smp.h
===================================================================
--- haiku/trunk/headers/private/kernel/smp.h	2008-06-01 21:18:08 UTC (rev 25751)
+++ haiku/trunk/headers/private/kernel/smp.h	2008-06-02 02:04:12 UTC (rev 25752)
@@ -40,6 +40,7 @@
 
 status_t smp_init(struct kernel_args *args);
 status_t smp_per_cpu_init(struct kernel_args *args, int32 cpu);
+status_t smp_init_post_generic_syscalls(void);
 bool smp_trap_non_boot_cpus(int32 cpu);
 void smp_wake_up_non_boot_cpus(void);
 void smp_cpu_rendezvous(volatile uint32 *var, int current_cpu);

Added: haiku/trunk/headers/private/system/spinlock_contention.h
===================================================================
--- haiku/trunk/headers/private/system/spinlock_contention.h	2008-06-01 21:18:08 UTC (rev 25751)
+++ haiku/trunk/headers/private/system/spinlock_contention.h	2008-06-02 02:04:12 UTC (rev 25752)
@@ -0,0 +1,21 @@
+/*
+ * Copyright 2008, Ingo Weinhold, <A HREF="https://lists.berlios.de/mailman/listinfo/haiku-commits">ingo_weinhold at gmx.de.</A>
+ * Distributed under the terms of the MIT License.
+ */
+#ifndef _SYSTEM_SPINLOCK_CONTENTION_H
+#define _SYSTEM_SPINLOCK_CONTENTION_H
+
+#include &lt;OS.h&gt;
+
+
+#define SPINLOCK_CONTENTION				&quot;spinlock contention&quot;
+#define GET_SPINLOCK_CONTENTION_INFO	0x01
+
+
+typedef struct spinlock_contention_info {
+	uint64	thread_spinlock_counter;
+	uint64	team_spinlock_counter;
+} spinlock_contention_info;
+
+
+#endif	/* _SYSTEM_SPINLOCK_CONTENTION_H */

Modified: haiku/trunk/src/add-ons/kernel/bus_managers/ide/ide_sim.c
===================================================================
--- haiku/trunk/src/add-ons/kernel/bus_managers/ide/ide_sim.c	2008-06-01 21:18:08 UTC (rev 25751)
+++ haiku/trunk/src/add-ons/kernel/bus_managers/ide/ide_sim.c	2008-06-02 02:04:12 UTC (rev 25752)
@@ -521,7 +521,7 @@
 
 	memset(bus, 0, sizeof(*bus));
 	bus-&gt;node = node;
-	bus-&gt;lock = 0;
+	B_INITIALIZE_SPINLOCK(&amp;bus-&gt;lock);
 	bus-&gt;num_running_reqs = 0;
 	bus-&gt;active_qrequest = NULL;
 	bus-&gt;disconnected = false;

Modified: haiku/trunk/src/add-ons/kernel/bus_managers/pci/arch/x86/pci_controller.c
===================================================================
--- haiku/trunk/src/add-ons/kernel/bus_managers/pci/arch/x86/pci_controller.c	2008-06-01 21:18:08 UTC (rev 25751)
+++ haiku/trunk/src/add-ons/kernel/bus_managers/pci/arch/x86/pci_controller.c	2008-06-02 02:04:12 UTC (rev 25752)
@@ -32,7 +32,7 @@
        restore_interrupts(cpu_status);		\
 }
 
-spinlock sConfigLock = 0;
+spinlock sConfigLock = B_SPINLOCK_INITIALIZER;
 
 static status_t
 pci_mech1_read_config(void *cookie, uint8 bus, uint8 device, uint8 function,

Modified: haiku/trunk/src/add-ons/kernel/bus_managers/ps2/packet_buffer.cpp
===================================================================
--- haiku/trunk/src/add-ons/kernel/bus_managers/ps2/packet_buffer.cpp	2008-06-01 21:18:08 UTC (rev 25751)
+++ haiku/trunk/src/add-ons/kernel/bus_managers/ps2/packet_buffer.cpp	2008-06-02 02:04:12 UTC (rev 25752)
@@ -40,7 +40,7 @@
 		free(buffer);
 		return NULL;
 	}
-	buffer-&gt;lock = 0;
+	B_INITIALIZE_SPINLOCK(&amp;buffer-&gt;lock);
 
 	return buffer;
 }

Modified: haiku/trunk/src/add-ons/kernel/bus_managers/scsi/scsi_lock.h
===================================================================
--- haiku/trunk/src/add-ons/kernel/bus_managers/scsi/scsi_lock.h	2008-06-01 21:18:08 UTC (rev 25751)
+++ haiku/trunk/src/add-ons/kernel/bus_managers/scsi/scsi_lock.h	2008-06-02 02:04:12 UTC (rev 25752)
@@ -29,7 +29,7 @@
 static inline void
 spinlock_irq_init(spinlock_irq *lock)
 {
-	lock-&gt;lock = 0;
+	B_INITIALIZE_SPINLOCK(&amp;lock-&gt;lock);
 }
 
 static inline void

Modified: haiku/trunk/src/add-ons/kernel/busses/scsi/ahci/ahci_port.cpp
===================================================================
--- haiku/trunk/src/add-ons/kernel/busses/scsi/ahci/ahci_port.cpp	2008-06-01 21:18:08 UTC (rev 25751)
+++ haiku/trunk/src/add-ons/kernel/busses/scsi/ahci/ahci_port.cpp	2008-06-02 02:04:12 UTC (rev 25752)
@@ -30,7 +30,6 @@
 	, fIndex(index)
 	, fRegs(&amp;controller-&gt;fRegs-&gt;port[index])
 	, fArea(-1)
-	, fSpinlock(0)
 	, fCommandsActive(0)
 	, fRequestSem(-1)
 	, fResponseSem(-1)
@@ -42,6 +41,7 @@
 	, fResetPort(false)
 	, fError(false)
 {
+	B_INITIALIZE_SPINLOCK(&amp;fSpinlock);
 	fRequestSem = create_sem(1, &quot;ahci request&quot;);
 	fResponseSem = create_sem(0, &quot;ahci response&quot;);
 }

Modified: haiku/trunk/src/add-ons/kernel/busses/usb/ehci.cpp
===================================================================
--- haiku/trunk/src/add-ons/kernel/busses/usb/ehci.cpp	2008-06-01 21:18:08 UTC (rev 25751)
+++ haiku/trunk/src/add-ons/kernel/busses/usb/ehci.cpp	2008-06-02 02:04:12 UTC (rev 25752)
@@ -782,7 +782,7 @@
 int32
 EHCI::Interrupt()
 {
-	static spinlock lock = 0;
+	static spinlock lock = B_SPINLOCK_INITIALIZER;
 	acquire_spinlock(&amp;lock);
 
 	// check if any interrupt was generated

Modified: haiku/trunk/src/add-ons/kernel/busses/usb/ohci.cpp
===================================================================
--- haiku/trunk/src/add-ons/kernel/busses/usb/ohci.cpp	2008-06-01 21:18:08 UTC (rev 25751)
+++ haiku/trunk/src/add-ons/kernel/busses/usb/ohci.cpp	2008-06-02 02:04:12 UTC (rev 25752)
@@ -694,7 +694,7 @@
 int32
 OHCI::_Interrupt()
 {
-	static spinlock lock = 0;
+	static spinlock lock = B_SPINLOCK_INITIALIZER;
 	acquire_spinlock(&amp;lock);
 
 	uint32 status = 0;

Modified: haiku/trunk/src/add-ons/kernel/busses/usb/uhci.cpp
===================================================================
--- haiku/trunk/src/add-ons/kernel/busses/usb/uhci.cpp	2008-06-01 21:18:08 UTC (rev 25751)
+++ haiku/trunk/src/add-ons/kernel/busses/usb/uhci.cpp	2008-06-02 02:04:12 UTC (rev 25752)
@@ -1531,7 +1531,7 @@
 int32
 UHCI::Interrupt()
 {
-	static spinlock lock = 0;
+	static spinlock lock = B_SPINLOCK_INITIALIZER;
 	acquire_spinlock(&amp;lock);
 
 	// Check if we really had an interrupt

Modified: haiku/trunk/src/add-ons/kernel/drivers/audio/ac97/auich/util.c
===================================================================
--- haiku/trunk/src/add-ons/kernel/drivers/audio/ac97/auich/util.c	2008-06-01 21:18:08 UTC (rev 25751)
+++ haiku/trunk/src/add-ons/kernel/drivers/audio/ac97/auich/util.c	2008-06-02 02:04:12 UTC (rev 25752)
@@ -34,7 +34,7 @@
 #include &quot;debug.h&quot;
 #include &quot;util.h&quot;
 
-spinlock slock = 0;
+spinlock slock = B_SPINLOCK_INITIALIZER;
 
 uint32 round_to_pagesize(uint32 size);
 

Modified: haiku/trunk/src/add-ons/kernel/drivers/audio/ac97/auvia/util.c
===================================================================
--- haiku/trunk/src/add-ons/kernel/drivers/audio/ac97/auvia/util.c	2008-06-01 21:18:08 UTC (rev 25751)
+++ haiku/trunk/src/add-ons/kernel/drivers/audio/ac97/auvia/util.c	2008-06-02 02:04:12 UTC (rev 25752)
@@ -34,7 +34,7 @@
 #include &quot;debug.h&quot;
 #include &quot;util.h&quot;
 
-spinlock slock = 0;
+spinlock slock = B_SPINLOCK_INITIALIZER;
 
 uint32 round_to_pagesize(uint32 size);
 

Modified: haiku/trunk/src/add-ons/kernel/drivers/audio/emuxki/util.c
===================================================================
--- haiku/trunk/src/add-ons/kernel/drivers/audio/emuxki/util.c	2008-06-01 21:18:08 UTC (rev 25751)
+++ haiku/trunk/src/add-ons/kernel/drivers/audio/emuxki/util.c	2008-06-02 02:04:12 UTC (rev 25752)
@@ -34,7 +34,7 @@
 #include &quot;debug.h&quot;
 #include &quot;util.h&quot;
 
-spinlock slock = 0;
+spinlock slock = B_SPINLOCK_INITIALIZER;
 
 uint32 round_to_pagesize(uint32 size);
 

Modified: haiku/trunk/src/add-ons/kernel/drivers/graphics/radeon/irq.c
===================================================================
--- haiku/trunk/src/add-ons/kernel/drivers/graphics/radeon/irq.c	2008-06-01 21:18:08 UTC (rev 25751)
+++ haiku/trunk/src/add-ons/kernel/drivers/graphics/radeon/irq.c	2008-06-02 02:04:12 UTC (rev 25752)
@@ -237,7 +237,7 @@
 		goto err3;
 	}
 
-	di-&gt;cap_spinlock = 0;
+	B_INITIALIZE_SPINLOCK(&amp;di-&gt;cap_spinlock);
 
 	sprintf(buffer, &quot;%04X_%04X_%02X%02X%02X DMA I&quot;,
 		di-&gt;pcii.vendor_id, di-&gt;pcii.device_id,

Modified: haiku/trunk/src/add-ons/kernel/drivers/network/rtl8169/device.c
===================================================================
--- haiku/trunk/src/add-ons/kernel/drivers/network/rtl8169/device.c	2008-06-01 21:18:08 UTC (rev 25751)
+++ haiku/trunk/src/add-ons/kernel/drivers/network/rtl8169/device.c	2008-06-02 02:04:12 UTC (rev 25752)
@@ -467,7 +467,7 @@
 	read_settings(device);
 
 	device-&gt;rxBuf = (void **)malloc(sizeof(void *) * device-&gt;rxBufferCount);
-	device-&gt;rxSpinlock = 0;
+	B_INITIALIZE_SPINLOCK(&amp;device-&gt;rxSpinlock);
 	device-&gt;rxNextIndex = 0;
 	device-&gt;rxIntIndex = 0;
 	device-&gt;rxFree = device-&gt;rxBufferCount;
@@ -475,7 +475,7 @@
 	set_sem_owner(device-&gt;rxReadySem, B_SYSTEM_TEAM);
 	
 	device-&gt;txBuf = (void **)malloc(sizeof(void *) * device-&gt;txBufferCount);
-	device-&gt;txSpinlock = 0;
+	B_INITIALIZE_SPINLOCK(&amp;device-&gt;txSpinlock);
 	device-&gt;txNextIndex = 0;
 	device-&gt;txIntIndex = 0;
 	device-&gt;txUsed = 0;

Modified: haiku/trunk/src/add-ons/kernel/drivers/network/rtl8169/timer.c
===================================================================
--- haiku/trunk/src/add-ons/kernel/drivers/network/rtl8169/timer.c	2008-06-01 21:18:08 UTC (rev 25751)
+++ haiku/trunk/src/add-ons/kernel/drivers/network/rtl8169/timer.c	2008-06-02 02:04:12 UTC (rev 25752)
@@ -187,7 +187,7 @@
 {
 	sTimerCount = 0;
 	sTimerNextId = 1;
-	sTimerSpinlock = 0;
+	B_INITIALIZE_SPINLOCK(&amp;sTimerSpinlock);
 	
 	sTimerThread = spawn_kernel_thread(timer_thread, &quot;rtl8169 timer&quot;, 80, 0);
 	sTimerSem = create_sem(0, &quot;rtl8169 timer&quot;);

Modified: haiku/trunk/src/add-ons/kernel/generic/dpc/dpc.c
===================================================================
--- haiku/trunk/src/add-ons/kernel/generic/dpc/dpc.c	2008-06-01 21:18:08 UTC (rev 25751)
+++ haiku/trunk/src/add-ons/kernel/generic/dpc/dpc.c	2008-06-02 02:04:12 UTC (rev 25752)
@@ -91,7 +91,7 @@
 	queue-&gt;head = queue-&gt;tail = 0;
 	queue-&gt;size = DPC_QUEUE_SIZE;
 	queue-&gt;count = 0;
-	queue-&gt;lock = 0;	// Init the spinlock
+	B_INITIALIZE_SPINLOCK(&amp;queue-&gt;lock);	// Init the spinlock
 
 #ifdef __HAIKU__
 	snprintf(str, sizeof(str), &quot;%.*s_wakeup_sem&quot;, 

Modified: haiku/trunk/src/add-ons/kernel/generic/mpu401/mpu401.c
===================================================================
--- haiku/trunk/src/add-ons/kernel/generic/mpu401/mpu401.c	2008-06-01 21:18:08 UTC (rev 25751)
+++ haiku/trunk/src/add-ons/kernel/generic/mpu401/mpu401.c	2008-06-02 02:04:12 UTC (rev 25752)
@@ -480,7 +480,7 @@
 	NULL
 };
 
-spinlock locked = 0;
+spinlock locked = B_SPINLOCK_INITIALIZER;
 cpu_status 
 lock(void)
 {

Modified: haiku/trunk/src/libs/compat/freebsd_network/taskqueue.c
===================================================================
--- haiku/trunk/src/libs/compat/freebsd_network/taskqueue.c	2008-06-01 21:18:08 UTC (rev 25751)
+++ haiku/trunk/src/libs/compat/freebsd_network/taskqueue.c	2008-06-02 02:04:12 UTC (rev 25752)
@@ -20,7 +20,7 @@
 	taskqueue_enqueue_fn tq_enqueue;
 	void *tq_arg;
 	int tq_fast;
-	int32 tq_spinlock;
+	spinlock tq_spinlock;
 	sem_id tq_sem;
 	thread_id *tq_threads;
 	thread_id tq_thread_storage;
@@ -43,7 +43,7 @@
 	tq-&gt;tq_fast = fast;
 
 	if (fast) {
-		tq-&gt;tq_spinlock = 0;
+		B_INITIALIZE_SPINLOCK(&amp;tq-&gt;tq_spinlock);
 	} else {
 		mutex_init_etc(&amp;tq-&gt;tq_mutex, name, MUTEX_FLAG_CLONE_NAME);
 	}

Modified: haiku/trunk/src/system/kernel/arch/m68k/arch_vm_translation_map_impl.cpp
===================================================================
--- haiku/trunk/src/system/kernel/arch/m68k/arch_vm_translation_map_impl.cpp	2008-06-01 21:18:08 UTC (rev 25751)
+++ haiku/trunk/src/system/kernel/arch/m68k/arch_vm_translation_map_impl.cpp	2008-06-02 02:04:12 UTC (rev 25752)
@@ -1180,7 +1180,7 @@
 
 	sQueryDesc.type = DT_INVALID;
 
-	tmap_list_lock = 0;
+	B_INITIALIZE_SPINLOCK(&amp;tmap_list_lock);
 	tmap_list = NULL;
 
 	// allocate some space to hold physical page mapping info

Modified: haiku/trunk/src/system/kernel/arch/x86/arch_debug_console.c
===================================================================
--- haiku/trunk/src/system/kernel/arch/x86/arch_debug_console.c	2008-06-01 21:18:08 UTC (rev 25751)
+++ haiku/trunk/src/system/kernel/arch/x86/arch_debug_console.c	2008-06-02 02:04:12 UTC (rev 25752)
@@ -99,7 +99,7 @@
 static bool sBochsOutput = false;
 #endif
 
-static spinlock sSerialOutputSpinlock = 0;
+static spinlock sSerialOutputSpinlock = B_SPINLOCK_INITIALIZER;
 
 
 static void

Modified: haiku/trunk/src/system/kernel/arch/x86/arch_vm_translation_map.cpp
===================================================================
--- haiku/trunk/src/system/kernel/arch/x86/arch_vm_translation_map.cpp	2008-06-01 21:18:08 UTC (rev 25751)
+++ haiku/trunk/src/system/kernel/arch/x86/arch_vm_translation_map.cpp	2008-06-02 02:04:12 UTC (rev 25752)
@@ -852,7 +852,7 @@
 	sKernelPhysicalPageDirectory = (page_directory_entry *)args-&gt;arch_args.phys_pgdir;
 	sKernelVirtualPageDirectory = (page_directory_entry *)args-&gt;arch_args.vir_pgdir;
 
-	tmap_list_lock = 0;
+	B_INITIALIZE_SPINLOCK(&amp;tmap_list_lock);
 	tmap_list = NULL;
 
 	// allocate some space to hold physical page mapping info

Modified: haiku/trunk/src/system/kernel/debug/debug.cpp
===================================================================
--- haiku/trunk/src/system/kernel/debug/debug.cpp	2008-06-01 21:18:08 UTC (rev 25751)
+++ haiku/trunk/src/system/kernel/debug/debug.cpp	2008-06-02 02:04:12 UTC (rev 25752)
@@ -54,7 +54,7 @@
 	// must always be false on startup
 static bool sDebugScreenEnabled = false;
 static bool sBlueScreenOutput = true;
-static spinlock sSpinlock = 0;
+static spinlock sSpinlock = B_SPINLOCK_INITIALIZER;
 static int32 sDebuggerOnCPU = -1;
 
 static sem_id sSyslogNotify = -1;

Modified: haiku/trunk/src/system/kernel/debug/debug_commands.cpp
===================================================================
--- haiku/trunk/src/system/kernel/debug/debug_commands.cpp	2008-06-01 21:18:08 UTC (rev 25751)
+++ haiku/trunk/src/system/kernel/debug/debug_commands.cpp	2008-06-02 02:04:12 UTC (rev 25752)
@@ -30,7 +30,7 @@
 static const int32 kMaxInvokeCommandDepth = 5;
 static const int32 kOutputBufferSize = 1024;
 
-static spinlock sSpinlock = 0;
+static spinlock sSpinlock = B_SPINLOCK_INITIALIZER;
 
 static struct debugger_command *sCommands;
 

Modified: haiku/trunk/src/system/kernel/debug/user_debugger.cpp
===================================================================
--- haiku/trunk/src/system/kernel/debug/user_debugger.cpp	2008-06-01 21:18:08 UTC (rev 25751)
+++ haiku/trunk/src/system/kernel/debug/user_debugger.cpp	2008-06-02 02:04:12 UTC (rev 25752)
@@ -219,7 +219,7 @@
 		info-&gt;debugger_write_lock = -1;
 
 		if (initLock)
-			info-&gt;lock = 0;
+			B_INITIALIZE_SPINLOCK(&amp;info-&gt;lock);
 	}
 }
 

Modified: haiku/trunk/src/system/kernel/int.c
===================================================================
--- haiku/trunk/src/system/kernel/int.c	2008-06-01 21:18:08 UTC (rev 25751)
+++ haiku/trunk/src/system/kernel/int.c	2008-06-02 02:04:12 UTC (rev 25752)
@@ -62,7 +62,7 @@
 	for (i = 0; i &lt; NUM_IO_VECTORS; i++) {
 		struct io_handler *io;
 
-		if (sVectors[i].vector_lock == 0
+		if (!B_SPINLOCK_IS_LOCKED(&amp;sVectors[i].vector_lock)
 			&amp;&amp; sVectors[i].enable_count == 0
 			&amp;&amp; sVectors[i].handled_count == 0
 			&amp;&amp; sVectors[i].unhandled_count == 0
@@ -72,7 +72,7 @@
 		kprintf(&quot;int %3d, enabled %ld, handled %8lld, unhandled %8lld%s%s\n&quot;,
 			i, sVectors[i].enable_count, sVectors[i].handled_count, 
 			sVectors[i].unhandled_count,
-			sVectors[i].vector_lock != 0 ? &quot;, ACTIVE&quot; : &quot;&quot;,
+			B_SPINLOCK_IS_LOCKED(&amp;sVectors[i].vector_lock) ? &quot;, ACTIVE&quot; : &quot;&quot;,
 			sVectors[i].handler_list.next == &amp;sVectors[i].handler_list
 				? &quot;, no handler&quot; : &quot;&quot;);
 
@@ -114,7 +114,7 @@
 
 	/* initialize the vector list */
 	for (i = 0; i &lt; NUM_IO_VECTORS; i++) {
-		sVectors[i].vector_lock = 0;			/* initialize spinlock */
+		B_INITIALIZE_SPINLOCK(&amp;sVectors[i].vector_lock);
 		sVectors[i].enable_count = 0;
 		sVectors[i].no_lock_vector = false;
 #ifdef DEBUG_INT

Modified: haiku/trunk/src/system/kernel/main.cpp
===================================================================
--- haiku/trunk/src/system/kernel/main.cpp	2008-06-01 21:18:08 UTC (rev 25751)
+++ haiku/trunk/src/system/kernel/main.cpp	2008-06-02 02:04:12 UTC (rev 25752)
@@ -160,6 +160,7 @@
 		driver_settings_init_post_sem(&amp;sKernelArgs);
 		TRACE(&quot;init generic syscall\n&quot;);
 		generic_syscall_init();
+		smp_init_post_generic_syscalls();
 		TRACE(&quot;init cbuf\n&quot;);
 		cbuf_init();
 		TRACE(&quot;init teams\n&quot;);

Modified: haiku/trunk/src/system/kernel/port.cpp
===================================================================
--- haiku/trunk/src/system/kernel/port.cpp	2008-06-01 21:18:08 UTC (rev 25751)
+++ haiku/trunk/src/system/kernel/port.cpp	2008-06-02 02:04:12 UTC (rev 25752)
@@ -72,7 +72,7 @@
 static port_id sNextPort = 1;
 static int32 sFirstFreeSlot = 1;
 
-static spinlock sPortSpinlock = 0;
+static spinlock sPortSpinlock = B_SPINLOCK_INITIALIZER;
 
 #define GRAB_PORT_LIST_LOCK() acquire_spinlock(&amp;sPortSpinlock)
 #define RELEASE_PORT_LIST_LOCK() release_spinlock(&amp;sPortSpinlock)

Modified: haiku/trunk/src/system/kernel/sem.cpp
===================================================================
--- haiku/trunk/src/system/kernel/sem.cpp	2008-06-01 21:18:08 UTC (rev 25751)
+++ haiku/trunk/src/system/kernel/sem.cpp	2008-06-02 02:04:12 UTC (rev 25752)
@@ -108,7 +108,7 @@
 static struct sem_entry	*sFreeSemsHead = NULL;
 static struct sem_entry	*sFreeSemsTail = NULL;
 
-static spinlock sem_spinlock = 0;
+static spinlock sem_spinlock = B_SPINLOCK_INITIALIZER;
 #define GRAB_SEM_LIST_LOCK()     acquire_spinlock(&amp;sem_spinlock)
 #define RELEASE_SEM_LIST_LOCK()  release_spinlock(&amp;sem_spinlock)
 #define GRAB_SEM_LOCK(s)         acquire_spinlock(&amp;(s).lock)

Modified: haiku/trunk/src/system/kernel/smp.c
===================================================================
--- haiku/trunk/src/system/kernel/smp.c	2008-06-01 21:18:08 UTC (rev 25751)
+++ haiku/trunk/src/system/kernel/smp.c	2008-06-02 02:04:12 UTC (rev 25752)
@@ -8,18 +8,22 @@
 
 /* Functionality for symetrical multi-processors */
 
-#include &lt;thread.h&gt;
-#include &lt;int.h&gt;
 #include &lt;smp.h&gt;
-#include &lt;cpu.h&gt;
-#include &lt;arch/cpu.h&gt;
-#include &lt;arch/smp.h&gt;
-#include &lt;arch/int.h&gt;
-#include &lt;arch/debug.h&gt;
 
 #include &lt;stdlib.h&gt;
 #include &lt;string.h&gt;
 
+#include &lt;arch/cpu.h&gt;
+#include &lt;arch/debug.h&gt;
+#include &lt;arch/int.h&gt;
+#include &lt;arch/smp.h&gt;
+#include &lt;cpu.h&gt;
+#include &lt;generic_syscall.h&gt;
+#include &lt;int.h&gt;
+#include &lt;spinlock_contention.h&gt;
+#include &lt;thread.h&gt;
+
+
 #define DEBUG_SPINLOCKS 1
 //#define TRACE_SMP
 
@@ -53,17 +57,17 @@
 #define MAILBOX_LOCAL 1
 #define MAILBOX_BCAST 2
 
-static spinlock boot_cpu_spin[SMP_MAX_CPUS] = { 0, };
+static spinlock boot_cpu_spin[SMP_MAX_CPUS] = { };
 
 static struct smp_msg *free_msgs = NULL;
 static volatile int free_msg_count = 0;
-static spinlock free_msg_spinlock = 0;
+static spinlock free_msg_spinlock = B_SPINLOCK_INITIALIZER;
 
 static struct smp_msg *smp_msgs[SMP_MAX_CPUS] = { NULL, };
-static spinlock cpu_msg_spinlock[SMP_MAX_CPUS] = { 0, };
+static spinlock cpu_msg_spinlock[SMP_MAX_CPUS];
 
 static struct smp_msg *smp_broadcast_msgs = NULL;
-static spinlock broadcast_msg_spinlock = 0;
+static spinlock broadcast_msg_spinlock = B_SPINLOCK_INITIALIZER;
 
 static bool sICIEnabled = false;
 static int32 sNumCPUs = 1;
@@ -115,6 +119,10 @@
 		int currentCPU = smp_get_current_cpu();
 		if (are_interrupts_enabled())
 			panic(&quot;acquire_spinlock: attempt to acquire lock %p with interrupts enabled\n&quot;, lock);
+#if B_DEBUG_SPINLOCK_CONTENTION
+		while (atomic_add(&amp;lock-&gt;lock, 1) != 0)
+			process_pending_ici(currentCPU);
+#else
 		while (1) {
 			while (*lock != 0) {
 				process_pending_ici(currentCPU);
@@ -123,6 +131,7 @@
 			if (atomic_set((int32 *)lock, 1) == 0)
 				break;
 		}
+#endif
 	} else {
 #if DEBUG_SPINLOCKS
 		int32 oldValue;
@@ -148,12 +157,17 @@
 		if (are_interrupts_enabled())
 			panic(&quot;acquire_spinlock_nocheck: attempt to acquire lock %p with interrupts enabled\n&quot;, lock);
 #endif
+#if B_DEBUG_SPINLOCK_CONTENTION
+		while (atomic_add(&amp;lock-&gt;lock, 1) != 0) {
+		}
+#else
 		while (1) {
 			while(*lock != 0)
 				PAUSE();
 			if (atomic_set((int32 *)lock, 1) == 0)
 				break;
 		}
+#endif
 	} else {
 #if DEBUG_SPINLOCKS
 		if (are_interrupts_enabled())
@@ -171,8 +185,23 @@
 	if (sNumCPUs &gt; 1) {
 		if (are_interrupts_enabled())
 			panic(&quot;release_spinlock: attempt to release lock %p with interrupts enabled\n&quot;, lock);
+#if B_DEBUG_SPINLOCK_CONTENTION
+		{
+			int32 count = atomic_set(&amp;lock-&gt;lock, 0) - 1;
+			if (count &lt; 0) {
+				panic(&quot;release_spinlock: lock %p was already released\n&quot;, lock);
+			} else {
+				// add to the total count -- deal with carry manually
+				if ((uint32)atomic_add(&amp;lock-&gt;count_low, count) + count
+						&lt; (uint32)count) {
+					atomic_add(&amp;lock-&gt;count_high, 1);
+				}
+			}
+		}
+#else
 		if (atomic_set((int32 *)lock, 0) != 1)
 			panic(&quot;release_spinlock: lock %p was already released\n&quot;, lock);
+#endif
 	} else {
 		#if DEBUG_SPINLOCKS
 			if (are_interrupts_enabled())
@@ -405,6 +434,48 @@
 }
 
 
+#if B_DEBUG_SPINLOCK_CONTENTION
+
+static uint64
+get_spinlock_counter(spinlock* lock)
+{
+	uint32 high;
+	uint32 low;
+	do {
+		high = (uint32)atomic_get(&amp;lock-&gt;count_high);
+		low = (uint32)atomic_get(&amp;lock-&gt;count_low);
+	} while (high != atomic_get(&amp;lock-&gt;count_high));
+
+	return ((uint64)high &lt;&lt; 32) | low;
+}
+
+
+static status_t
+spinlock_contention_syscall(const char* subsystem, uint32 function,
+	void* buffer, size_t bufferSize)
+{
+	spinlock_contention_info info;
+
+	if (function != GET_SPINLOCK_CONTENTION_INFO)
+		return B_BAD_VALUE;
+
+	if (bufferSize &lt; sizeof(spinlock_contention_info))
+		return B_BAD_VALUE;
+
+	info.thread_spinlock_counter = get_spinlock_counter(&amp;thread_spinlock);
+	info.team_spinlock_counter = get_spinlock_counter(&amp;team_spinlock);
+
+	if (!IS_USER_ADDRESS(buffer)
+		|| user_memcpy(buffer, &amp;info, sizeof(info)) != B_OK) {
+		return B_BAD_ADDRESS;
+	}
+
+	return B_OK;
+}
+
+#endif	// B_DEBUG_SPINLOCK_CONTENTION
+
+
 //	#pragma mark -
 
 
@@ -553,7 +624,11 @@
 smp_trap_non_boot_cpus(int32 cpu)
 {
 	if (cpu &gt; 0) {
+#if B_DEBUG_SPINLOCK_CONTENTION
+		boot_cpu_spin[cpu].lock = 1;
+#else
 		boot_cpu_spin[cpu] = 1;
+#endif
 		acquire_spinlock_nocheck(&amp;boot_cpu_spin[cpu]);
 		return false;
 	}
@@ -624,6 +699,18 @@
 }
 
 
+status_t
+smp_init_post_generic_syscalls(void)
+{
+#if B_DEBUG_SPINLOCK_CONTENTION
+	return register_generic_syscall(SPINLOCK_CONTENTION,
+		&amp;spinlock_contention_syscall, 0, 0);
+#else
+	return B_OK;
+#endif
+}
+
+
 void
 smp_set_num_cpus(int32 numCPUs)
 {

Modified: haiku/trunk/src/system/kernel/team.cpp
===================================================================
--- haiku/trunk/src/system/kernel/team.cpp	2008-06-01 21:18:08 UTC (rev 25751)
+++ haiku/trunk/src/system/kernel/team.cpp	2008-06-02 02:04:12 UTC (rev 25752)
@@ -89,7 +89,7 @@
 static int32 sMaxTeams = 2048;
 static int32 sUsedTeams = 1;
 
-spinlock team_spinlock = 0;
+spinlock team_spinlock = B_SPINLOCK_INITIALIZER;
 
 
 // #pragma mark - Tracing

Modified: haiku/trunk/src/system/kernel/thread.cpp
===================================================================
--- haiku/trunk/src/system/kernel/thread.cpp	2008-06-01 21:18:08 UTC (rev 25751)
+++ haiku/trunk/src/system/kernel/thread.cpp	2008-06-02 02:04:12 UTC (rev 25752)
@@ -60,7 +60,7 @@
 };
 
 // global
-spinlock thread_spinlock = 0;
+spinlock thread_spinlock = B_SPINLOCK_INITIALIZER;
 
 // thread list
 static struct thread sIdleThreads[B_MAX_CPU_COUNT];


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="009251.html">[Haiku-commits] r25704 - in haiku/trunk: headers/private/kernel src/system/kernel
</A></li>
	<LI>Next message: <A HREF="009270.html">[Haiku-commits] r25752 - in haiku/trunk: headers/os/drivers headers/private/kernel  headers/private/system src/add-ons/kernel/bus_managers/ide src/add-ons/kernel/bus_managers/pci/arch/x86 src/add-ons/kernel/bus_managers/ps2 src/add-ons/kernel/bus_managers/scsi src/add-ons/kernel/busses/scsi/ahci  src/add-ons/kernel/busses/usb src/add-ons/kernel/drivers/audio/ac97/auich src/add-ons/kernel/drivers/audio/ac97/auvia src/add-ons/kernel/drivers/audio/emuxki src/add-ons/kernel/drivers/graphics/radeon src/add-ons/kernel/drivers/network/rtl8169 src/add-ons/kernel/generic/dpc  src/add-ons/kernel/generic/mpu401 src/libs/compat/freebsd_network src/system/kernel src/system/kernel/arch/m68k src/system/kernel/arch/x86 src/system/kernel/debug
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#9252">[ date ]</a>
              <a href="thread.html#9252">[ thread ]</a>
              <a href="subject.html#9252">[ subject ]</a>
              <a href="author.html#9252">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/haiku-commits">More information about the Haiku-commits
mailing list</a><br>
</body></html>
