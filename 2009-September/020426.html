<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Haiku-commits] r32977 -	haiku/trunk/src/add-ons/kernel/generic/ata_adapter
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/haiku-commits/2009-September/index.html" >
   <LINK REL="made" HREF="mailto:haiku-commits%40lists.berlios.de?Subject=Re%3A%20%5BHaiku-commits%5D%20r32977%20-%0A%09haiku/trunk/src/add-ons/kernel/generic/ata_adapter&In-Reply-To=%3C200909070046.n870k4cA008631%40sheep.berlios.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="020435.html">
   <LINK REL="Next"  HREF="020427.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Haiku-commits] r32977 -	haiku/trunk/src/add-ons/kernel/generic/ata_adapter</H1>
    <B>marcusoverhagen at mail.berlios.de</B> 
    <A HREF="mailto:haiku-commits%40lists.berlios.de?Subject=Re%3A%20%5BHaiku-commits%5D%20r32977%20-%0A%09haiku/trunk/src/add-ons/kernel/generic/ata_adapter&In-Reply-To=%3C200909070046.n870k4cA008631%40sheep.berlios.de%3E"
       TITLE="[Haiku-commits] r32977 -	haiku/trunk/src/add-ons/kernel/generic/ata_adapter">marcusoverhagen at mail.berlios.de
       </A><BR>
    <I>Mon Sep  7 02:46:04 CEST 2009</I>
    <P><UL>
        <LI>Previous message: <A HREF="020435.html">[Haiku-commits] r32976 - haiku/trunk/src/system/kernel/fs
</A></li>
        <LI>Next message: <A HREF="020427.html">[Haiku-commits] r32978 -	haiku/trunk/src/add-ons/kernel/bus_managers/ata
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#20426">[ date ]</a>
              <a href="thread.html#20426">[ thread ]</a>
              <a href="subject.html#20426">[ subject ]</a>
              <a href="author.html#20426">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: marcusoverhagen
Date: 2009-09-07 02:46:02 +0200 (Mon, 07 Sep 2009)
New Revision: 32977
ViewCVS: <A HREF="http://svn.berlios.de/viewcvs/haiku?rev=32977&amp;view=rev">http://svn.berlios.de/viewcvs/haiku?rev=32977&amp;view=rev</A>

Modified:
   haiku/trunk/src/add-ons/kernel/generic/ata_adapter/ata_adapter.c
Log:
This should fix interrupt timeouts when using DMA mode.
Also ignore simplex bit for Intel controllers, and use
DMA for both channels.


Modified: haiku/trunk/src/add-ons/kernel/generic/ata_adapter/ata_adapter.c
===================================================================
--- haiku/trunk/src/add-ons/kernel/generic/ata_adapter/ata_adapter.c	2009-09-06 23:15:23 UTC (rev 32976)
+++ haiku/trunk/src/add-ons/kernel/generic/ata_adapter/ata_adapter.c	2009-09-07 00:46:02 UTC (rev 32977)
@@ -184,22 +184,28 @@
 	pci_device *device = channel-&gt;device;
 	uint8 statusATA, statusBM;
 
-	// this could be a spurious interrupt, so always read status
-	// register unconditionally to acknowledge those
-	statusATA = pci-&gt;read_io_8(device, channel-&gt;command_block_base + 7);
-
-	if (!channel-&gt;dmaing)
+	if (!channel-&gt;dmaing) {
+		// this could be a spurious interrupt, so read status
+		// register unconditionally to acknowledge those
+		pci-&gt;read_io_8(device, channel-&gt;command_block_base + 7);
 		return B_UNHANDLED_INTERRUPT;
+	}
 
-	// read bus master DMA status to test if the interrupt was
-	// really generated by our controller
+	// need to read bus master status first, because some controllers
+	// will clear the interrupt status bit once ATA status is read
 	statusBM = pci-&gt;read_io_8(device, channel-&gt;bus_master_base
 		+ ATA_BM_STATUS_REG);
 
+	// test if the interrupt was really generated by our controller
 	if (statusBM &amp; ATA_BM_STATUS_INTERRUPT) {
-		// clear pending PCI bus master DMA interrupt
+		// read ATA status register to acknowledge interrupt
+		statusATA = pci-&gt;read_io_8(device, channel-&gt;command_block_base + 7);
+
+		// clear pending PCI bus master DMA interrupt, for those 
+		// controllers who don't clear it themselves
 		pci-&gt;write_io_8(device, channel-&gt;bus_master_base + ATA_BM_STATUS_REG,
 			(statusBM &amp; 0xf8) | ATA_BM_STATUS_INTERRUPT);
+
 		// signal interrupt to ATA stack
 		return sATA-&gt;interrupt_handler(channel-&gt;ataChannel, statusATA);
 	} else {
@@ -484,6 +490,7 @@
 	uint8 api;
 	uint16 pcicmdOld;
 	uint16 pcicmdNew;
+	uint16 pciVendor;
 
 	SHOW_FLOW0( 3, &quot;&quot; );
 
@@ -539,9 +546,9 @@
 	}
 	if (pcicmdOld != pcicmdNew) {
 		pci-&gt;write_pci_config(pci_device, PCI_command, 2, pcicmdNew);
+		TRACE(&quot;PCI-ATA: pcicmd changed from 0x%04x to 0x%04x\n&quot;, 
+			pcicmdOld, pcicmdNew);
 	}
-	TRACE(&quot;PCI-ATA: pcicmd old 0x%04x, new 0x%04x\n&quot;, 
-		pcicmdOld, pcicmdNew);
 
 
 	if (supports_compatibility_mode) {
@@ -555,8 +562,16 @@
 			// better were to use a controller lock, but this had to be done in the IDE
 			// bus manager, and I don't see any reason to add extra code for old
 			// simplex controllers
-			TRACE(&quot;PCI-ATA: Simplex controller - disabling DMA of secondary channel\n&quot;);
-			controller_can_dma = false;
+
+			// Intel controllers use this bit for something else and are not simplex.
+			pciVendor = pci-&gt;read_pci_config(pci_device, PCI_vendor_id, 2);
+
+			if (pciVendor != 0x8086) {
+				TRACE(&quot;PCI-ATA: Simplex controller - disabling DMA of secondary channel\n&quot;);
+				controller_can_dma = false;
+			} else {
+				TRACE(&quot;PCI-ATA: Simplex bit ignored - Intel controller\n&quot;);
+			}
 		}
 	}
 


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="020435.html">[Haiku-commits] r32976 - haiku/trunk/src/system/kernel/fs
</A></li>
	<LI>Next message: <A HREF="020427.html">[Haiku-commits] r32978 -	haiku/trunk/src/add-ons/kernel/bus_managers/ata
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#20426">[ date ]</a>
              <a href="thread.html#20426">[ thread ]</a>
              <a href="subject.html#20426">[ subject ]</a>
              <a href="author.html#20426">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/haiku-commits">More information about the Haiku-commits
mailing list</a><br>
</body></html>
