<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Haiku-commits] r33068 - in haiku/branches/components/gallium3d:	build/config_headers build/scripts headers/os/app	headers/private/app src/add-ons/kernel/bus_managers/ata	src/add-ons/kernel/busses/scsi/ahci src/add-ons/kernel/drivers	src/add-ons/kernel/drivers/audio/ac97/es1370	src/add-ons/kernel/drivers/audio/hda	src/add-ons/kernel/drivers/printer	src/add-ons/kernel/drivers/printer/usb	src/add-ons/kernel/generic/ata_adapter src/bin/rc	src/kits/app src/servers/net src/system/kernel/vm
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/haiku-commits/2009-September/index.html" >
   <LINK REL="made" HREF="mailto:haiku-commits%40lists.berlios.de?Subject=Re%3A%20%5BHaiku-commits%5D%20r33068%20-%20in%20haiku/branches/components/gallium3d%3A%0A%09build/config_headers%20build/scripts%20headers/os/app%0A%09headers/private/app%20src/add-ons/kernel/bus_managers/ata%0A%09src/add-ons/kernel/busses/scsi/ahci%20src/add-ons/kernel/drivers%0A%09src/add-ons/kernel/drivers/audio/ac97/es1370%0A%09src/add-ons/kernel/drivers/audio/hda%0A%09src/add-ons/kernel/drivers/printer%0A%09src/add-ons/kernel/drivers/printer/usb%0A%09src/add-ons/kernel/generic/ata_adapter%20src/bin/rc%0A%09src/kits/app%20src/servers/net%20src/system/kernel/vm&In-Reply-To=%3C200909112106.n8BL6bSm012068%40sheep.berlios.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="020556.html">
   <LINK REL="Next"  HREF="020558.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Haiku-commits] r33068 - in haiku/branches/components/gallium3d:	build/config_headers build/scripts headers/os/app	headers/private/app src/add-ons/kernel/bus_managers/ata	src/add-ons/kernel/busses/scsi/ahci src/add-ons/kernel/drivers	src/add-ons/kernel/drivers/audio/ac97/es1370	src/add-ons/kernel/drivers/audio/hda	src/add-ons/kernel/drivers/printer	src/add-ons/kernel/drivers/printer/usb	src/add-ons/kernel/generic/ata_adapter src/bin/rc	src/kits/app src/servers/net src/system/kernel/vm</H1>
    <B>aljen at mail.berlios.de</B> 
    <A HREF="mailto:haiku-commits%40lists.berlios.de?Subject=Re%3A%20%5BHaiku-commits%5D%20r33068%20-%20in%20haiku/branches/components/gallium3d%3A%0A%09build/config_headers%20build/scripts%20headers/os/app%0A%09headers/private/app%20src/add-ons/kernel/bus_managers/ata%0A%09src/add-ons/kernel/busses/scsi/ahci%20src/add-ons/kernel/drivers%0A%09src/add-ons/kernel/drivers/audio/ac97/es1370%0A%09src/add-ons/kernel/drivers/audio/hda%0A%09src/add-ons/kernel/drivers/printer%0A%09src/add-ons/kernel/drivers/printer/usb%0A%09src/add-ons/kernel/generic/ata_adapter%20src/bin/rc%0A%09src/kits/app%20src/servers/net%20src/system/kernel/vm&In-Reply-To=%3C200909112106.n8BL6bSm012068%40sheep.berlios.de%3E"
       TITLE="[Haiku-commits] r33068 - in haiku/branches/components/gallium3d:	build/config_headers build/scripts headers/os/app	headers/private/app src/add-ons/kernel/bus_managers/ata	src/add-ons/kernel/busses/scsi/ahci src/add-ons/kernel/drivers	src/add-ons/kernel/drivers/audio/ac97/es1370	src/add-ons/kernel/drivers/audio/hda	src/add-ons/kernel/drivers/printer	src/add-ons/kernel/drivers/printer/usb	src/add-ons/kernel/generic/ata_adapter src/bin/rc	src/kits/app src/servers/net src/system/kernel/vm">aljen at mail.berlios.de
       </A><BR>
    <I>Fri Sep 11 23:06:37 CEST 2009</I>
    <P><UL>
        <LI>Previous message: <A HREF="020556.html">[Haiku-commits] r33067 -	haiku/branches/releases/r1alpha1/build/scripts
</A></li>
        <LI>Next message: <A HREF="020558.html">[Haiku-commits] r33069 - haiku/trunk/src/preferences/screensaver
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#20557">[ date ]</a>
              <a href="thread.html#20557">[ thread ]</a>
              <a href="subject.html#20557">[ subject ]</a>
              <a href="author.html#20557">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: aljen
Date: 2009-09-11 23:06:24 +0200 (Fri, 11 Sep 2009)
New Revision: 33068
ViewCVS: <A HREF="http://svn.berlios.de/viewcvs/haiku?rev=33068&amp;view=rev">http://svn.berlios.de/viewcvs/haiku?rev=33068&amp;view=rev</A>

Added:
   haiku/branches/components/gallium3d/src/add-ons/kernel/drivers/printer/
   haiku/branches/components/gallium3d/src/add-ons/kernel/drivers/printer/Jamfile
   haiku/branches/components/gallium3d/src/add-ons/kernel/drivers/printer/usb/
   haiku/branches/components/gallium3d/src/add-ons/kernel/drivers/printer/usb/Jamfile
   haiku/branches/components/gallium3d/src/add-ons/kernel/drivers/printer/usb/usb_printer.cpp
   haiku/branches/components/gallium3d/src/add-ons/kernel/drivers/printer/usb/usb_printer.h
Removed:
   haiku/branches/components/gallium3d/src/add-ons/kernel/drivers/printer/Jamfile
   haiku/branches/components/gallium3d/src/add-ons/kernel/drivers/printer/usb/
   haiku/branches/components/gallium3d/src/add-ons/kernel/drivers/printer/usb/Jamfile
   haiku/branches/components/gallium3d/src/add-ons/kernel/drivers/printer/usb/usb_printer.cpp
   haiku/branches/components/gallium3d/src/add-ons/kernel/drivers/printer/usb/usb_printer.h
Modified:
   haiku/branches/components/gallium3d/build/config_headers/tracing_config.h
   haiku/branches/components/gallium3d/build/scripts/build_haiku_cd
   haiku/branches/components/gallium3d/headers/os/app/Message.h
   haiku/branches/components/gallium3d/headers/private/app/MessagePrivate.h
   haiku/branches/components/gallium3d/src/add-ons/kernel/bus_managers/ata/ATAChannel.cpp
   haiku/branches/components/gallium3d/src/add-ons/kernel/bus_managers/ata/ATADevice.cpp
   haiku/branches/components/gallium3d/src/add-ons/kernel/bus_managers/ata/ATAHelper.cpp
   haiku/branches/components/gallium3d/src/add-ons/kernel/bus_managers/ata/ATAPrivate.h
   haiku/branches/components/gallium3d/src/add-ons/kernel/busses/scsi/ahci/ahci.c
   haiku/branches/components/gallium3d/src/add-ons/kernel/busses/scsi/ahci/ahci_port.cpp
   haiku/branches/components/gallium3d/src/add-ons/kernel/drivers/audio/ac97/es1370/es1370.c
   haiku/branches/components/gallium3d/src/add-ons/kernel/drivers/audio/hda/hda_controller.cpp
   haiku/branches/components/gallium3d/src/add-ons/kernel/generic/ata_adapter/ata_adapter.c
   haiku/branches/components/gallium3d/src/bin/rc/parser.y
   haiku/branches/components/gallium3d/src/kits/app/InitTerminateLibBe.cpp
   haiku/branches/components/gallium3d/src/kits/app/Message.cpp
   haiku/branches/components/gallium3d/src/servers/net/DHCPClient.cpp
   haiku/branches/components/gallium3d/src/system/kernel/vm/vm.cpp
Log:
merged changes from trunk r33038-r33067

Modified: haiku/branches/components/gallium3d/build/config_headers/tracing_config.h
===================================================================
--- haiku/branches/components/gallium3d/build/config_headers/tracing_config.h	2009-09-11 18:14:52 UTC (rev 33067)
+++ haiku/branches/components/gallium3d/build/config_headers/tracing_config.h	2009-09-11 21:06:24 UTC (rev 33068)
@@ -20,6 +20,7 @@
 
 #define AHCI_PORT_TRACING						0
 #define ATA_TRACING								0
+#define ATA_DMA_TRACING							0
 #define ATAPI_TRACING							0
 #define BFS_TRACING								0
 #define BLOCK_CACHE_BLOCK_TRACING				0

Modified: haiku/branches/components/gallium3d/build/scripts/build_haiku_cd
===================================================================
--- haiku/branches/components/gallium3d/build/scripts/build_haiku_cd	2009-09-11 18:14:52 UTC (rev 33067)
+++ haiku/branches/components/gallium3d/build/scripts/build_haiku_cd	2009-09-11 21:06:24 UTC (rev 33068)
@@ -147,7 +147,7 @@
 
 # build the iso image
 echo &quot;Building CD image ...&quot;
-mkisofs -b `basename $cdBootFloppy` -U -R -V &quot;$cdLabel&quot; -o &quot;$cdImagePath&quot; &quot;$tPrefix&quot;
+mkisofs -uid 0 -gid 0 -b `basename $cdBootFloppy` -U -R -V &quot;$cdLabel&quot; -o &quot;$cdImagePath&quot; &quot;$tPrefix&quot;
 
 # cleanup output dir
 $rmAttrs -rf &quot;$outputDir&quot;

Modified: haiku/branches/components/gallium3d/headers/os/app/Message.h
===================================================================
--- haiku/branches/components/gallium3d/headers/os/app/Message.h	2009-09-11 18:14:52 UTC (rev 33067)
+++ haiku/branches/components/gallium3d/headers/os/app/Message.h	2009-09-11 21:06:24 UTC (rev 33068)
@@ -339,6 +339,7 @@
 							port_id port, int32 token, bigtime_t timeout);
 
 		static void		_StaticInit();
+		static void		_StaticReInitForkedChild();
 		static void		_StaticCleanup();
 		static void		_StaticCacheCleanup();
 		static int32	_StaticGetCachedReplyPort();

Modified: haiku/branches/components/gallium3d/headers/private/app/MessagePrivate.h
===================================================================
--- haiku/branches/components/gallium3d/headers/private/app/MessagePrivate.h	2009-09-11 18:14:52 UTC (rev 33067)
+++ haiku/branches/components/gallium3d/headers/private/app/MessagePrivate.h	2009-09-11 21:06:24 UTC (rev 33068)
@@ -208,6 +208,12 @@
 		}
 
 		static void
+		StaticReInitForkedChild()
+		{
+			BMessage::_StaticReInitForkedChild();
+		}
+
+		static void
 		StaticCleanup()
 		{
 			BMessage::_StaticCleanup();

Modified: haiku/branches/components/gallium3d/src/add-ons/kernel/bus_managers/ata/ATAChannel.cpp
===================================================================
--- haiku/branches/components/gallium3d/src/add-ons/kernel/bus_managers/ata/ATAChannel.cpp	2009-09-11 18:14:52 UTC (rev 33067)
+++ haiku/branches/components/gallium3d/src/add-ons/kernel/bus_managers/ata/ATAChannel.cpp	2009-09-11 21:06:24 UTC (rev 33068)
@@ -405,6 +405,9 @@
 
 	_FlushAndWait(150 * 1000);
 
+	// read status to clear any pending interrupts
+	_Status();
+
 	return B_OK;
 }
 
@@ -564,7 +567,8 @@
 status_t
 ATAChannel::RecoverLostInterrupt()
 {
-	uint8 status = AltStatus();
+	// read status to clear any pending interrupts
+	uint8 status = _Status();
 	if (status &amp; (ATA_STATUS_BUSY | ATA_STATUS_DATA_REQUEST)) {
 		TRACE_ERROR(&quot;RecoverLostInterrupt: device busy, status 0x%02x\n&quot;, status);
 		return B_ERROR;
@@ -829,6 +833,16 @@
 }
 
 
+uint8
+ATAChannel::_Status()
+{
+	ata_task_file taskFile;
+	if (_ReadRegs(&amp;taskFile, ATA_MASK_STATUS) != B_OK)
+		return 0x01;
+	return taskFile.read.status;
+}
+
+
 status_t
 ATAChannel::_WriteControl(uint8 value)
 {

Modified: haiku/branches/components/gallium3d/src/add-ons/kernel/bus_managers/ata/ATADevice.cpp
===================================================================
--- haiku/branches/components/gallium3d/src/add-ons/kernel/bus_managers/ata/ATADevice.cpp	2009-09-11 18:14:52 UTC (rev 33067)
+++ haiku/branches/components/gallium3d/src/add-ons/kernel/bus_managers/ata/ATADevice.cpp	2009-09-11 21:06:24 UTC (rev 33068)
@@ -512,6 +512,22 @@
 		return B_ERROR;
 	}
 
+	if (1) {
+		// print device information
+		char modelNumber[sizeof(fInfoBlock.model_number) + 1];
+		char serialNumber[sizeof(fInfoBlock.serial_number) + 1];
+		char firmwareRev[sizeof(fInfoBlock.firmware_revision) + 1];
+		strlcpy(modelNumber, fInfoBlock.model_number, sizeof(modelNumber));
+		strlcpy(serialNumber, fInfoBlock.serial_number, sizeof(serialNumber));
+		strlcpy(firmwareRev, fInfoBlock.firmware_revision, sizeof(firmwareRev));
+		swap_words(modelNumber, sizeof(modelNumber) - 1);
+		swap_words(serialNumber, sizeof(serialNumber) - 1);
+		swap_words(firmwareRev, sizeof(firmwareRev) - 1);
+		TRACE_ALWAYS(&quot;model number: %s\n&quot;, modelNumber);
+		TRACE_ALWAYS(&quot;serial number: %s\n&quot;, serialNumber);
+  		TRACE_ALWAYS(&quot;firmware rev.: %s\n&quot;, firmwareRev);
+	}
+
 	return B_OK;
 }
 

Modified: haiku/branches/components/gallium3d/src/add-ons/kernel/bus_managers/ata/ATAHelper.cpp
===================================================================
--- haiku/branches/components/gallium3d/src/add-ons/kernel/bus_managers/ata/ATAHelper.cpp	2009-09-11 18:14:52 UTC (rev 33067)
+++ haiku/branches/components/gallium3d/src/add-ons/kernel/bus_managers/ata/ATAHelper.cpp	2009-09-11 21:06:24 UTC (rev 33068)
@@ -64,3 +64,15 @@
 
 	return size == 0;
 }
+
+
+void
+swap_words(void *data, size_t size)
+{
+	uint16 *word = (uint16 *)data;
+	size_t count = size / 2;
+	while (count--) {
+		*word = (*word &lt;&lt; 8) | (*word &gt;&gt; 8);
+		word++;
+	}
+}

Modified: haiku/branches/components/gallium3d/src/add-ons/kernel/bus_managers/ata/ATAPrivate.h
===================================================================
--- haiku/branches/components/gallium3d/src/add-ons/kernel/bus_managers/ata/ATAPrivate.h	2009-09-11 18:14:52 UTC (rev 33067)
+++ haiku/branches/components/gallium3d/src/add-ons/kernel/bus_managers/ata/ATAPrivate.h	2009-09-11 21:06:24 UTC (rev 33068)
@@ -55,7 +55,9 @@
 
 bool copy_sg_data(scsi_ccb *ccb, uint offset, uint allocationLength,
 	void *buffer, int size, bool toBuffer);
+void swap_words(void *data, size_t size);
 
+
 class ATAChannel {
 public:
 									ATAChannel(device_node *node);
@@ -120,6 +122,7 @@
 		status_t					_WriteRegs(ata_task_file *taskFile,
 										ata_reg_mask mask);
 		status_t					_WriteControl(uint8 value);
+		uint8						_Status();
 
 		void						_FlushAndWait(bigtime_t waitTime);
 

Modified: haiku/branches/components/gallium3d/src/add-ons/kernel/busses/scsi/ahci/ahci.c
===================================================================
--- haiku/branches/components/gallium3d/src/add-ons/kernel/busses/scsi/ahci/ahci.c	2009-09-11 18:14:52 UTC (rev 33067)
+++ haiku/branches/components/gallium3d/src/add-ons/kernel/busses/scsi/ahci/ahci.c	2009-09-11 21:06:24 UTC (rev 33068)
@@ -9,7 +9,7 @@
 #include &lt;string.h&gt;
 
 
-#define TRACE(a...) dprintf(&quot;\33[35mahci:\33[0m &quot; a)
+#define TRACE(a...) dprintf(&quot;ahci: &quot; a)
 #define FLOW(a...)	dprintf(&quot;ahci: &quot; a)
 
 #define AHCI_ID_GENERATOR &quot;ahci/id&quot;

Modified: haiku/branches/components/gallium3d/src/add-ons/kernel/busses/scsi/ahci/ahci_port.cpp
===================================================================
--- haiku/branches/components/gallium3d/src/add-ons/kernel/busses/scsi/ahci/ahci_port.cpp	2009-09-11 18:14:52 UTC (rev 33067)
+++ haiku/branches/components/gallium3d/src/add-ons/kernel/busses/scsi/ahci/ahci_port.cpp	2009-09-11 21:06:24 UTC (rev 33068)
@@ -632,7 +632,7 @@
 	swap_words(serialNumber, sizeof(serialNumber) - 1);
 	swap_words(firmwareRev, sizeof(firmwareRev) - 1);
 
-	TRACE(&quot;model number:  %s\n&quot;, modelNumber);
+	TRACE(&quot;model number: %s\n&quot;, modelNumber);
 	TRACE(&quot;serial number: %s\n&quot;, serialNumber);
   	TRACE(&quot;firmware rev.: %s\n&quot;, firmwareRev);
 

Modified: haiku/branches/components/gallium3d/src/add-ons/kernel/drivers/audio/ac97/es1370/es1370.c
===================================================================
--- haiku/branches/components/gallium3d/src/add-ons/kernel/drivers/audio/ac97/es1370/es1370.c	2009-09-11 18:14:52 UTC (rev 33067)
+++ haiku/branches/components/gallium3d/src/add-ons/kernel/drivers/audio/ac97/es1370/es1370.c	2009-09-11 21:06:24 UTC (rev 33068)
@@ -500,8 +500,8 @@
 	void *settings_handle;
 	pci_info info;
 	int ix = 0;
+	status_t err;
 	num_cards = 0;
-	status_t err;
 
 	PRINT((&quot;init_driver()\n&quot;));
 

Modified: haiku/branches/components/gallium3d/src/add-ons/kernel/drivers/audio/hda/hda_controller.cpp
===================================================================
--- haiku/branches/components/gallium3d/src/add-ons/kernel/drivers/audio/hda/hda_controller.cpp	2009-09-11 18:14:52 UTC (rev 33067)
+++ haiku/branches/components/gallium3d/src/add-ons/kernel/drivers/audio/hda/hda_controller.cpp	2009-09-11 21:06:24 UTC (rev 33068)
@@ -98,8 +98,13 @@
 
 	stream-&gt;Write8(HDAC_STREAM_STATUS, status);
 
+	if (status &amp; STATUS_FIFO_ERROR)
+		dprintf(&quot;hda: stream fifo error (id:%ld)\n&quot;, stream-&gt;id);
+	if (status &amp; STATUS_DESCRIPTOR_ERROR)
+		dprintf(&quot;hda: stream descriptor error (id:%ld)\n&quot;, stream-&gt;id);
+
 	if ((status &amp; STATUS_BUFFER_COMPLETED) == 0) {
-		dprintf(&quot;hda: stream status %x\n&quot;, status);
+		dprintf(&quot;hda: stream buffer not completed (id:%ld)\n&quot;, stream-&gt;id);
 		return;
 	}
 
@@ -114,13 +119,6 @@
 	stream-&gt;frames_count += stream-&gt;buffer_length;
 	stream-&gt;buffer_cycle = position / bufferSize;
 
-	// playback interrupts come early, offsets don't work on non intel
-	// TODO find out why
-	if (stream-&gt;type == STREAM_PLAYBACK
-		&amp;&amp; stream-&gt;controller-&gt;pci_info.vendor_id != INTEL_VENDORID) {
-		stream-&gt;buffer_cycle++;
-	}
-
 	release_spinlock(&amp;stream-&gt;lock);
 
 	release_sem_etc(controller-&gt;buffer_ready_sem, 1, B_DO_NOT_RESCHEDULE);
@@ -558,13 +556,18 @@
 	// TODO check on other vendors, see in stream_handle_interrupt()
 	// Tested only on Intel ICH8
 	uint32 offset = 0;
-	if (stream-&gt;type == STREAM_PLAYBACK &amp;&amp; stream-&gt;controller-&gt;pci_info.vendor_id == INTEL_VENDORID) {
-		if (stream-&gt;sample_size == 2)
-			offset = 6;
-		else if (stream-&gt;sample_size &gt; 2)
-			offset = 8;
+	if (stream-&gt;type == STREAM_PLAYBACK) {
+		if (stream-&gt;controller-&gt;pci_info.vendor_id == INTEL_VENDORID) {
+			if (stream-&gt;sample_size == 2)
+				offset = 3;
+			else if (stream-&gt;sample_size &gt; 2)
+				offset = 4;
+		} else {
+			offset = 11;	
+		}
+		offset *= 64;
+		offset = ALIGN(offset, 128);
 	}
-	offset *= 32;
 	
 	/* Calculate size of buffer (aligned to 128 bytes) */
 	bufferSize = stream-&gt;sample_size * stream-&gt;num_channels

Copied: haiku/branches/components/gallium3d/src/add-ons/kernel/drivers/printer (from rev 33067, haiku/trunk/src/add-ons/kernel/drivers/printer)

Deleted: haiku/branches/components/gallium3d/src/add-ons/kernel/drivers/printer/Jamfile

Copied: haiku/branches/components/gallium3d/src/add-ons/kernel/drivers/printer/Jamfile (from rev 33067, haiku/trunk/src/add-ons/kernel/drivers/printer/Jamfile)

Copied: haiku/branches/components/gallium3d/src/add-ons/kernel/drivers/printer/usb (from rev 33067, haiku/trunk/src/add-ons/kernel/drivers/printer/usb)

Deleted: haiku/branches/components/gallium3d/src/add-ons/kernel/drivers/printer/usb/Jamfile

Copied: haiku/branches/components/gallium3d/src/add-ons/kernel/drivers/printer/usb/Jamfile (from rev 33067, haiku/trunk/src/add-ons/kernel/drivers/printer/usb/Jamfile)

Deleted: haiku/branches/components/gallium3d/src/add-ons/kernel/drivers/printer/usb/usb_printer.cpp

Copied: haiku/branches/components/gallium3d/src/add-ons/kernel/drivers/printer/usb/usb_printer.cpp (from rev 33067, haiku/trunk/src/add-ons/kernel/drivers/printer/usb/usb_printer.cpp)

Deleted: haiku/branches/components/gallium3d/src/add-ons/kernel/drivers/printer/usb/usb_printer.h

Copied: haiku/branches/components/gallium3d/src/add-ons/kernel/drivers/printer/usb/usb_printer.h (from rev 33067, haiku/trunk/src/add-ons/kernel/drivers/printer/usb/usb_printer.h)

Modified: haiku/branches/components/gallium3d/src/add-ons/kernel/generic/ata_adapter/ata_adapter.c
===================================================================
--- haiku/branches/components/gallium3d/src/add-ons/kernel/generic/ata_adapter/ata_adapter.c	2009-09-11 18:14:52 UTC (rev 33067)
+++ haiku/branches/components/gallium3d/src/add-ons/kernel/generic/ata_adapter/ata_adapter.c	2009-09-11 21:06:24 UTC (rev 33068)
@@ -12,6 +12,7 @@
 #include &lt;string.h&gt;
 
 #include &lt;ata_adapter.h&gt;
+#include &lt;tracing.h&gt;
 
 #define debug_level_flow 0
 #define debug_level_error 3
@@ -25,13 +26,18 @@
 
 #define INTERRUPT_TRACING 0
 #if INTERRUPT_TRACING 
-	#include &lt;tracing.h&gt;
 	#define TRACE_INT(a...) 	ktrace_printf(a)
 #else
 	#define TRACE_INT(a...)
 #endif
 
 
+#if ATA_DMA_TRACING
+	#define TRACE_DMA(x...)		ktrace_printf(x)
+#else
+	#define TRACE_DMA(x...)
+#endif
+
 static ata_for_controller_interface *sATA;
 static device_manager_info *sDeviceManager;
 
@@ -240,12 +246,17 @@
 	prd_entry *prd = channel-&gt;prdt;
 	int i;
 
+	TRACE_DMA(&quot;ata_adapter: prepare_dma (%s) %u entrys:\n&quot;, 
+		writeToDevice ? &quot;write&quot; : &quot;read&quot;, sgListCount);
+
 	for (i = sgListCount - 1, prd = channel-&gt;prdt; i &gt;= 0; --i, ++prd, ++sgList) {
 		prd-&gt;address = B_HOST_TO_LENDIAN_INT32(pci-&gt;ram_address(device, sgList-&gt;address));
 		// 0 means 64K - this is done automatically be discarding upper 16 bits
 		prd-&gt;count = B_HOST_TO_LENDIAN_INT16((uint16)sgList-&gt;size);
 		prd-&gt;EOT = i == 0;
 
+		TRACE_DMA(&quot;ata_adapter: %p, %ld =&gt; 0x%08x, %d, %d\n&quot;, 
+			sgList-&gt;address, sgList-&gt;size, prd-&gt;address, prd-&gt;count, prd-&gt;EOT);
 		SHOW_FLOW( 4, &quot;%x, %x, %d&quot;, (int)prd-&gt;address, prd-&gt;count, prd-&gt;EOT);
 	}
 

Modified: haiku/branches/components/gallium3d/src/bin/rc/parser.y
===================================================================
--- haiku/branches/components/gallium3d/src/bin/rc/parser.y	2009-09-11 18:14:52 UTC (rev 33067)
+++ haiku/branches/components/gallium3d/src/bin/rc/parser.y	2009-09-11 21:06:24 UTC (rev 33068)
@@ -1758,20 +1758,20 @@
 	// it doesn't seem to hurt, and we only do it in DEBUG mode anyway.
 
 	for (sym_iter_t i = symbol_table.begin(); i != symbol_table.end(); ++i) {
-		free_mem(i-&gt;first);
+		free_mem((void*) i-&gt;first);
 	}
 
 	for (type_iter_t i = type_table.begin(); i != type_table.end(); ++i) {
-		free_mem(i-&gt;first);
+		free_mem((void*) i-&gt;first);
 		type_t type = i-&gt;second;
 
 		for (int32 t = 0; t &lt; type.count; ++t) {
-			free_mem(type.fields[t].name);
-			free_mem(type.fields[t].data.ptr);
+			free_mem((void*) type.fields[t].name);
+			free_mem((void*) type.fields[t].data.ptr);
 		}
-		free_mem(type.fields);
-		free_mem(type.name);
-		free_mem(type.def_name);
+		free_mem((void*) type.fields);
+		free_mem((void*) type.name);
+		free_mem((void*) type.def_name);
 	}
 #endif
 

Modified: haiku/branches/components/gallium3d/src/kits/app/InitTerminateLibBe.cpp
===================================================================
--- haiku/branches/components/gallium3d/src/kits/app/InitTerminateLibBe.cpp	2009-09-11 18:14:52 UTC (rev 33067)
+++ haiku/branches/components/gallium3d/src/kits/app/InitTerminateLibBe.cpp	2009-09-11 21:06:24 UTC (rev 33068)
@@ -10,6 +10,7 @@
 
 
 #include &lt;stdio.h&gt;
+#include &lt;stdlib.h&gt;
 
 #include &lt;ClipboardPrivate.h&gt;
 #include &lt;MessagePrivate.h&gt;
@@ -22,6 +23,17 @@
 #define OUT	printf
 
 
+static void
+initialize_forked_child()
+{
+	DBG(OUT(&quot;initialize_forked_child()\n&quot;));
+
+	BMessage::Private::StaticReInitForkedChild();
+
+	DBG(OUT(&quot;initialize_forked_child() done\n&quot;));
+}
+
+
 extern &quot;C&quot; void
 initialize_before()
 {
@@ -30,6 +42,8 @@
 	BMessage::Private::StaticInit();
 	BRoster::Private::InitBeRoster();
 
+	atfork(initialize_forked_child);
+
 	DBG(OUT(&quot;initialize_before() done\n&quot;));
 }
 

Modified: haiku/branches/components/gallium3d/src/kits/app/Message.cpp
===================================================================
--- haiku/branches/components/gallium3d/src/kits/app/Message.cpp	2009-09-11 18:14:52 UTC (rev 33067)
+++ haiku/branches/components/gallium3d/src/kits/app/Message.cpp	2009-09-11 21:06:24 UTC (rev 33068)
@@ -1972,6 +1972,22 @@
 
 
 void
+BMessage::_StaticReInitForkedChild()
+{
+	DEBUG_FUNCTION_ENTER2;
+
+	// overwrite the inherited ports with a set of our own
+	sReplyPorts[0] = create_port(1, &quot;tmp_rport0&quot;);
+	sReplyPorts[1] = create_port(1, &quot;tmp_rport1&quot;);
+	sReplyPorts[2] = create_port(1, &quot;tmp_rport2&quot;);
+
+	sReplyPortInUse[0] = 0;
+	sReplyPortInUse[1] = 0;
+	sReplyPortInUse[2] = 0;
+}
+
+
+void
 BMessage::_StaticCleanup()
 {
 	DEBUG_FUNCTION_ENTER2;

Modified: haiku/branches/components/gallium3d/src/servers/net/DHCPClient.cpp
===================================================================
--- haiku/branches/components/gallium3d/src/servers/net/DHCPClient.cpp	2009-09-11 18:14:52 UTC (rev 33067)
+++ haiku/branches/components/gallium3d/src/servers/net/DHCPClient.cpp	2009-09-11 21:06:24 UTC (rev 33068)
@@ -550,10 +550,9 @@
 
 				// configure interface
 				BMessage reply;
-				Target().SendMessage(&amp;fConfiguration, &amp;reply);
-
-				if (reply.FindInt32(&quot;status&quot;, &amp;fStatus) != B_OK)
-					status = B_OK;
+				status = Target().SendMessage(&amp;fConfiguration, &amp;reply);
+				if (status == B_OK)
+					status = reply.FindInt32(&quot;status&quot;, &amp;fStatus);
 				break;
 			}
 

Modified: haiku/branches/components/gallium3d/src/system/kernel/vm/vm.cpp
===================================================================
--- haiku/branches/components/gallium3d/src/system/kernel/vm/vm.cpp	2009-09-11 18:14:52 UTC (rev 33067)
+++ haiku/branches/components/gallium3d/src/system/kernel/vm/vm.cpp	2009-09-11 21:06:24 UTC (rev 33068)
@@ -1094,6 +1094,12 @@
 }
 
 
+// verifies that an area with the given aligned base and size fits into
+// the spot defined by base and limit and does check for overflows
+#define IS_VALID_SPOT(base, alignedBase, size, limit) \
+	((alignedBase) &gt;= (base) &amp;&amp; (alignedBase) + ((size) - 1) &gt; (alignedBase) \
+		&amp;&amp; (alignedBase) + ((size) - 1) &lt;= (limit))
+
 /*!	Must be called with this address space's sem held */
 static status_t
 find_and_insert_area_slot(vm_address_space* addressSpace, addr_t start,
@@ -1157,10 +1163,11 @@
 			// find a hole big enough for a new area
 			if (last == NULL) {
 				// see if we can build it at the beginning of the virtual map
-				if (next == NULL || next-&gt;base &gt; ROUNDUP(addressSpace-&gt;base,
-						alignment) + (size - 1)) {
+				addr_t alignedBase = ROUNDUP(addressSpace-&gt;base, alignment);
+				if (IS_VALID_SPOT(addressSpace-&gt;base, alignedBase, size,
+						next == NULL ? end : next-&gt;base)) {
 					foundSpot = true;
-					area-&gt;base = ROUNDUP(addressSpace-&gt;base, alignment);
+					area-&gt;base = alignedBase;
 					break;
 				}
 
@@ -1170,9 +1177,11 @@
 
 			// keep walking
 			while (next != NULL) {
-				addr_t newBase = ROUNDUP(last-&gt;base + last-&gt;size, alignment);
-				if (next-&gt;base &gt; newBase &amp;&amp; next-&gt;base - newBase &gt;= size) {
-					// we found a spot (it'll be filled up below)
+				addr_t alignedBase = ROUNDUP(last-&gt;base + last-&gt;size, alignment);
+				if (IS_VALID_SPOT(last-&gt;base + (last-&gt;size - 1), alignedBase,
+						size, next-&gt;base)) {
+					foundSpot = true;
+					area-&gt;base = alignedBase;
 					break;
 				}
 
@@ -1180,13 +1189,15 @@
 				next = next-&gt;address_space_next;
 			}
 
-			addr_t newBase = ROUNDUP(last-&gt;base + last-&gt;size, alignment);
-			addr_t aspaceEnd = addressSpace-&gt;base + (addressSpace-&gt;size - 1);
-			if (next != NULL || (aspaceEnd &gt; newBase
-					&amp;&amp; aspaceEnd - (newBase - 1) &gt;= size)) {
+			if (foundSpot)
+				break;
+
+			addr_t alignedBase = ROUNDUP(last-&gt;base + last-&gt;size, alignment);
+			if (IS_VALID_SPOT(last-&gt;base + (last-&gt;size - 1), alignedBase,
+					size, end)) {
 				// got a spot
 				foundSpot = true;
-				area-&gt;base = newBase;
+				area-&gt;base = alignedBase;
 				break;
 			} else {
 				// We didn't find a free spot - if there were any reserved areas
@@ -1203,8 +1214,8 @@
 
 					// TODO: take free space after the reserved area into
 					// account!
-					if (next-&gt;base == ROUNDUP(next-&gt;base, alignment)
-						&amp;&amp; next-&gt;size == size) {
+					addr_t alignedBase = ROUNDUP(next-&gt;base, alignment);
+					if (next-&gt;base == alignedBase &amp;&amp; next-&gt;size == size) {
 						// The reserved area is entirely covered, and thus,
 						// removed
 						if (last)
@@ -1213,32 +1224,31 @@
 							addressSpace-&gt;areas = next-&gt;address_space_next;
 
 						foundSpot = true;
-						area-&gt;base = next-&gt;base;
+						area-&gt;base = alignedBase;
 						free(next);
 						break;
 					}
 
-					addr_t newBase = ROUNDUP(next-&gt;base, alignment);
-					if (newBase == next-&gt;base &amp;&amp; next-&gt;size &gt;= size) {
+					if (alignedBase == next-&gt;base &amp;&amp; next-&gt;size &gt;= size) {
 						// The new area will be placed at the beginning of the
 						// reserved area and the reserved area will be offset
 						// and resized
 						foundSpot = true;
 						next-&gt;base += size;
 						next-&gt;size -= size;
-						area-&gt;base = newBase;
+						area-&gt;base = alignedBase;
 						break;
 					}
 
-					if (newBase &lt;= next-&gt;base + (next-&gt;size - 1)
-						&amp;&amp; next-&gt;size - (newBase - next-&gt;base) &gt;= size) {
+					if (IS_VALID_SPOT(next-&gt;base, alignedBase, size,
+							next-&gt;base + (next-&gt;size - 1))) {
 						// The new area will be placed at the end of the
 						// reserved area, and the reserved area will be resized
 						// to make space
 						foundSpot = true;
-						next-&gt;size = newBase - next-&gt;base;
+						next-&gt;size = alignedBase - next-&gt;base;
 						last = next;
-						area-&gt;base = newBase;
+						area-&gt;base = alignedBase;
 						break;
 					}
 
@@ -1249,6 +1259,7 @@
 		}
 
 		case B_BASE_ADDRESS:
+		{
 			// find a hole big enough for a new area beginning with &quot;start&quot;
 			if (last == NULL) {
 				// see if we can build it at the beginning of the specified start
@@ -1273,14 +1284,14 @@
 				next = next-&gt;address_space_next;
 			}
 
-			if (next != NULL || addressSpace-&gt;base + (addressSpace-&gt;size - 1)
-					- last-&gt;base + (last-&gt;size - 1) &gt;= size) {
+			addr_t lastEnd = last-&gt;base + (last-&gt;size - 1);
+			if (next != NULL || end - lastEnd &gt;= size) {
 				// got a spot
 				foundSpot = true;
-				if (last-&gt;base + last-&gt;size &lt;= start)
+				if (lastEnd &lt; start)
 					area-&gt;base = start;
 				else
-					area-&gt;base = last-&gt;base + last-&gt;size;
+					area-&gt;base = lastEnd + 1;
 				break;
 			}
 
@@ -1290,6 +1301,7 @@
 			addressSpec = B_ANY_ADDRESS;
 			last = NULL;
 			goto second_chance;
+		}
 
 		case B_EXACT_ADDRESS:
 			// see if we can create it exactly here


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="020556.html">[Haiku-commits] r33067 -	haiku/branches/releases/r1alpha1/build/scripts
</A></li>
	<LI>Next message: <A HREF="020558.html">[Haiku-commits] r33069 - haiku/trunk/src/preferences/screensaver
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#20557">[ date ]</a>
              <a href="thread.html#20557">[ thread ]</a>
              <a href="subject.html#20557">[ subject ]</a>
              <a href="author.html#20557">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/haiku-commits">More information about the Haiku-commits
mailing list</a><br>
</body></html>
