<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Haiku-commits] r33176 - in haiku/trunk: build/jam data/system/boot	headers/build/os/app headers/libs headers/os/locale	headers/posix headers/private/locale headers/private/shared	src/add-ons/locale/catalogs src/add-ons/locale/catalogs/zeta	src/bin/locale src/build src/kits/locale src/libs	src/preferences/locale src/tests/kits/locale src/tools	src/tools/locale
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/haiku-commits/2009-September/index.html" >
   <LINK REL="made" HREF="mailto:haiku-commits%40lists.berlios.de?Subject=Re%3A%20%5BHaiku-commits%5D%20r33176%20-%20in%20haiku/trunk%3A%20build/jam%20data/system/boot%0A%09headers/build/os/app%20headers/libs%20headers/os/locale%0A%09headers/posix%20headers/private/locale%20headers/private/shared%0A%09src/add-ons/locale/catalogs%20src/add-ons/locale/catalogs/zeta%0A%09src/bin/locale%20src/build%20src/kits/locale%20src/libs%0A%09src/preferences/locale%20src/tests/kits/locale%20src/tools%0A%09src/tools/locale&In-Reply-To=%3C200909182224.n8IMOiaG006672%40sheep.berlios.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="020682.html">
   <LINK REL="Next"  HREF="020684.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Haiku-commits] r33176 - in haiku/trunk: build/jam data/system/boot	headers/build/os/app headers/libs headers/os/locale	headers/posix headers/private/locale headers/private/shared	src/add-ons/locale/catalogs src/add-ons/locale/catalogs/zeta	src/bin/locale src/build src/kits/locale src/libs	src/preferences/locale src/tests/kits/locale src/tools	src/tools/locale</H1>
    <B>zooey at BerliOS</B> 
    <A HREF="mailto:haiku-commits%40lists.berlios.de?Subject=Re%3A%20%5BHaiku-commits%5D%20r33176%20-%20in%20haiku/trunk%3A%20build/jam%20data/system/boot%0A%09headers/build/os/app%20headers/libs%20headers/os/locale%0A%09headers/posix%20headers/private/locale%20headers/private/shared%0A%09src/add-ons/locale/catalogs%20src/add-ons/locale/catalogs/zeta%0A%09src/bin/locale%20src/build%20src/kits/locale%20src/libs%0A%09src/preferences/locale%20src/tests/kits/locale%20src/tools%0A%09src/tools/locale&In-Reply-To=%3C200909182224.n8IMOiaG006672%40sheep.berlios.de%3E"
       TITLE="[Haiku-commits] r33176 - in haiku/trunk: build/jam data/system/boot	headers/build/os/app headers/libs headers/os/locale	headers/posix headers/private/locale headers/private/shared	src/add-ons/locale/catalogs src/add-ons/locale/catalogs/zeta	src/bin/locale src/build src/kits/locale src/libs	src/preferences/locale src/tests/kits/locale src/tools	src/tools/locale">zooey at mail.berlios.de
       </A><BR>
    <I>Sat Sep 19 00:24:44 CEST 2009</I>
    <P><UL>
        <LI>Previous message: <A HREF="020682.html">[Haiku-commits] r33175 -	haiku/trunk/src/tests/kits/net/preflet/StatusAddOn
</A></li>
        <LI>Next message: <A HREF="020684.html">[Haiku-commits] BOM: r33176 ...failed	Link	/objects/freebsd/_arch_/release/tools/icu/pkgdata/pkgdata ...
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#20683">[ date ]</a>
              <a href="thread.html#20683">[ thread ]</a>
              <a href="subject.html#20683">[ subject ]</a>
              <a href="author.html#20683">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: zooey
Date: 2009-09-19 00:23:34 +0200 (Sat, 19 Sep 2009)
New Revision: 33176
ViewCVS: <A HREF="http://svn.berlios.de/viewcvs/haiku?rev=33176&amp;view=rev">http://svn.berlios.de/viewcvs/haiku?rev=33176&amp;view=rev</A>

Added:
   haiku/trunk/headers/libs/icu/
   haiku/trunk/headers/posix/langinfo.h
   haiku/trunk/headers/posix/monetary.h
   haiku/trunk/headers/posix/nl_types.h
   haiku/trunk/headers/private/locale/DefaultCatalog.h
   haiku/trunk/headers/private/locale/HashMapCatalog.h
   haiku/trunk/headers/private/locale/ICUWrapper.h
   haiku/trunk/headers/private/locale/PlainTextCatalog.h
   haiku/trunk/src/add-ons/locale/catalogs/plaintext/
   haiku/trunk/src/build/icu/
   haiku/trunk/src/kits/locale/HashMapCatalog.cpp
   haiku/trunk/src/libs/icu/
   haiku/trunk/src/preferences/locale/TimeFormatSettingsView.cpp
   haiku/trunk/src/preferences/locale/TimeFormatSettingsView.h
   haiku/trunk/src/preferences/locale/fr.catkeys
   haiku/trunk/src/tests/kits/locale/ICUTest.cpp
   haiku/trunk/src/tools/icu/
   haiku/trunk/src/tools/locale/Catalog.cpp
   haiku/trunk/src/tools/locale/DefaultCatalog.cpp
   haiku/trunk/src/tools/locale/HashMapCatalog.cpp
   haiku/trunk/src/tools/locale/PlainTextCatalog.cpp
   haiku/trunk/src/tools/locale/adler32.c
   haiku/trunk/src/tools/locale/collectcatkeys.cpp
   haiku/trunk/src/tools/locale/genprops_beos/
   haiku/trunk/src/tools/locale/linkcatkeys.cpp
Removed:
   haiku/trunk/headers/os/locale/DefaultCatalog.h
   haiku/trunk/headers/private/locale/langinfo.h
   haiku/trunk/headers/private/locale/monetary.h
   haiku/trunk/headers/private/locale/nl_types.h
   haiku/trunk/src/tools/locale/genprops/
Modified:
   haiku/trunk/build/jam/BeOSRules
   haiku/trunk/build/jam/HaikuImage
   haiku/trunk/build/jam/HeadersRules
   haiku/trunk/data/system/boot/SetupEnvironment
   haiku/trunk/headers/build/os/app/Application.h
   haiku/trunk/headers/os/locale/Catalog.h
   haiku/trunk/headers/os/locale/Country.h
   haiku/trunk/headers/os/locale/Language.h
   haiku/trunk/headers/os/locale/Locale.h
   haiku/trunk/headers/os/locale/LocaleRoster.h
   haiku/trunk/headers/os/locale/LocaleStrings.h
   haiku/trunk/headers/private/locale/PropertyFile.h
   haiku/trunk/headers/private/shared/OpenHashTable.h
   haiku/trunk/src/add-ons/locale/catalogs/Jamfile
   haiku/trunk/src/add-ons/locale/catalogs/zeta/Catalog.cpp
   haiku/trunk/src/bin/locale/Jamfile
   haiku/trunk/src/bin/locale/collectcatkeys.cpp
   haiku/trunk/src/bin/locale/dumpcatalog.cpp
   haiku/trunk/src/bin/locale/linkcatkeys.cpp
   haiku/trunk/src/build/Jamfile
   haiku/trunk/src/kits/locale/Catalog.cpp
   haiku/trunk/src/kits/locale/Collator.cpp
   haiku/trunk/src/kits/locale/Country.cpp
   haiku/trunk/src/kits/locale/DefaultCatalog.cpp
   haiku/trunk/src/kits/locale/Jamfile
   haiku/trunk/src/kits/locale/Language.cpp
   haiku/trunk/src/kits/locale/LocaleRoster.cpp
   haiku/trunk/src/libs/Jamfile
   haiku/trunk/src/preferences/locale/Jamfile
   haiku/trunk/src/preferences/locale/Locale.cpp
   haiku/trunk/src/preferences/locale/LocaleWindow.cpp
   haiku/trunk/src/preferences/locale/LocaleWindow.h
   haiku/trunk/src/tests/kits/locale/Jamfile
   haiku/trunk/src/tests/kits/locale/catalogSpeed.cpp
   haiku/trunk/src/tests/kits/locale/catalogTest.cpp
   haiku/trunk/src/tests/kits/locale/catalogTestAddOn.cpp
   haiku/trunk/src/tools/Jamfile
   haiku/trunk/src/tools/locale/Jamfile
Log:
* reintegrated gsoc-locale-kit branch into trunk - there's more
  work to do, but it's about time to give this code more exposure.



Modified: haiku/trunk/build/jam/BeOSRules
===================================================================
--- haiku/trunk/build/jam/BeOSRules	2009-09-18 22:22:55 UTC (rev 33175)
+++ haiku/trunk/build/jam/BeOSRules	2009-09-18 22:23:34 UTC (rev 33176)
@@ -204,8 +204,10 @@
 
 	DEFINES on $(1) = $(defines) ;
 	CCDEFS on $(1) = [ FDefines $(defines) ] ;
-	HDRS on $(1) = [ FIncludes $(SEARCH_SOURCE) $(SUBDIRHDRS) $(HDRS) : $(localIncludesOption) ] ;
-	RCHDRS on $(1) = [ FIncludes $(SEARCH_SOURCE) $(SUBDIRHDRS) $(HDRS) : &quot;-I &quot; ] ;
+	HDRS on $(1) = [ FIncludes $(SEARCH_SOURCE) $(SUBDIRHDRS) $(HDRS) 
+		: $(localIncludesOption) ] ;
+	RCHDRS on $(1) = [ FIncludes $(SEARCH_SOURCE) $(SUBDIRHDRS) $(HDRS) 
+		: &quot;-I &quot; ] ;
 	CC on $(1) = $(cc) ;
 
 	# set up other vars
@@ -266,3 +268,116 @@
 	fi
 	$(2[1]) -O -o &quot;$(1)&quot; &quot;$(2[2-])&quot;
 }
+
+# Localization rules
+
+# Extract catalog entries from the sourcefile and put the output textfile in 
+# target. This output file is then used to create the binary catalog with 
+# linkcatkeys.
+rule ExtractCatalogEntries target : source : signature
+{
+# get compiler and defines for the platform
+	local headers ;
+	local sysHeaders ;
+	local cc ;
+	local defines ;
+	local localIncludesOption ;
+	local systemIncludesOption ;
+
+	on $(target) { # use on $(target) variable values
+		headers = $(HAIKU_CONFIG_HEADERS) $(SEARCH_SOURCE) $(SUBDIRHDRS)
+			$(HDRS) ;
+		sysHeaders = $(SUBDIRSYSHDRS) $(SYSHDRS) ;
+		defines = $(DEFINES) ;
+
+		if $(PLATFORM) = host {
+			sysHeaders += $(HOST_HDRS) ;
+			defines += $(HOST_DEFINES) ;
+
+			if $(USES_BE_API) {
+				sysHeaders += $(HOST_BE_API_HEADERS) ;
+			}
+
+			defines += $(HOST_DEFINES) ;
+			cc = $(HOST_CC) ;
+			localIncludesOption = $(HOST_LOCAL_INCLUDES_OPTION) ;
+			systemIncludesOption = $(HOST_SYSTEM_INCLUDES_OPTION) ;
+		} else {
+			sysHeaders += $(TARGET_HDRS) ;
+			defines += $(TARGET_DEFINES) ;
+			defines += $(TARGET_DEFINES) ;
+			cc = $(TARGET_CC) ;
+			localIncludesOption = $(TARGET_LOCAL_INCLUDES_OPTION) ;
+			systemIncludesOption = $(TARGET_SYSTEM_INCLUDES_OPTION) ;
+		}
+	}
+
+	DEFINES on $(target) = $(defines) ;
+	CCDEFS on $(target) = [ FDefines $(defines) ] ;
+	HDRS on $(target) = [ FIncludes $(headers) : $(localIncludesOption) ]
+		$(includesSeparator)
+		[ FSysIncludes $(sysHeaders) : $(systemIncludesOption) ] ;
+	CC on $(target) = $(cc) ;
+
+	LOCALE_KIT_SIGNATURE on $(target) = $(signature) ;
+
+	SEARCH on $(source) += $(SEARCH_SOURCE) ;
+
+	MakeLocatePlatform $(target) ;
+	Depends $(target) : $(source) &lt;build&gt;collectcatkeys ;
+	LocalClean clean : $(target) ;
+	ExtractCatalogEntries1 $(target) : &lt;build&gt;collectcatkeys $(source) ;
+}
+
+actions ExtractCatalogEntries1
+{
+	$(HOST_ADD_BUILD_COMPATIBILITY_LIB_DIR)
+		cat &quot;$(2[2-])&quot; | $(CC) -E $(CCDEFS) $(HDRS) - &gt; &quot;$(1)&quot;.pre 
+		$(2[1]) -s $(LOCALE_KIT_SIGNATURE) -p -o &quot;$(1)&quot; &quot;$(1)&quot;.pre
+}
+
+# Link catalog entries from given catkey file into output compiled catalog file.
+# Compiled catalog file will then be copied into the image, but only if the 
+# fingerprint matches the one from the untranslated catalog for the same file.
+rule LinkApplicationCatalog target : sources : signature : language
+{
+	MakeLocateArch $(target) ;
+	LOCALE_KIT_SIGNATURE on $(target) = $(signature) ;
+	Depends $(target) : $(sources) &lt;build&gt;linkcatkeys ;
+	LocalClean clean : $(target) ;
+	LinkApplicationCatalog1 $(target) 
+		: &lt;build&gt;linkcatkeys $(language) $(sources) ;
+}
+
+actions LinkApplicationCatalog1
+{
+	$(HOST_ADD_BUILD_COMPATIBILITY_LIB_DIR)
+		$(2[1]) &quot;$(2[3-])&quot; -l $(2[2]:B) -v -s $(LOCALE_KIT_SIGNATURE) -o &quot;$(1)&quot;
+}
+
+# General rules to invoke from jamfiles and that do (almost) everything related
+# to localization
+rule DoCatalogs appName	# Application name
+	: signature 		# Application MIME signature (must match the one
+						# declared in the sourcecode)
+	: sources 			# List of cpp files where to search keys
+	: generatedCatalog	# Name of the generated catalog (most probably
+						# english.catalog)
+	: translatedCatalogs # List of available translations
+{
+	genCat = [ FGristFiles $(generatedCatalog) ] ;
+	
+	ExtractCatalogEntries $(genCat:S=.catkeys) : $(sources) : $(signature) ;
+
+	LinkApplicationCatalog $(genCat) : $(genCat:S=.catkeys)
+		: $(signature) : $(genCat:B) ;
+	
+	for catalog in $(translatedCatalogs)
+	{
+		LinkApplicationCatalog $(catalog:B).catalog : $(catalog)
+			: $(signature) : $(catalog:B) ;
+	}
+	
+	AddFilesToHaikuImage system etc locale catalogs $(signature) :
+		$(genCat) $(translatedCatalogs:B).catalog ;
+}

Modified: haiku/trunk/build/jam/HaikuImage
===================================================================
--- haiku/trunk/build/jam/HaikuImage	2009-09-18 22:22:55 UTC (rev 33175)
+++ haiku/trunk/build/jam/HaikuImage	2009-09-18 22:23:34 UTC (rev 33176)
@@ -29,20 +29,18 @@
 
 SYSTEM_BIN = &quot;[&quot; addattr alert arp base64 basename bash bc beep bootman bzip2
 	cal cat catattr checkfs chgrp chmod chop chown chroot cksum clear
-	clockconfig cmp comm compress copyattr CortexAddOnHost cp
+	clockconfig cmp collectcatkeys comm compress copyattr CortexAddOnHost cp
 	csplit ctags cut date dc dd desklink df diff diff3 dircolors dirname
-	draggers driveinfo dstcheck du
+	draggers driveinfo dstcheck du dumpcatalog
 	echo eject env error expand expr
 	factor false fdinfo ffm filepanel find finddir fmt fold fortune frcode
-	ftp ftpd
-	funzip fwcontrol
+	ftp ftpd funzip fwcontrol
 	gawk $(X86_ONLY)gdb getlimits grep groups gzip gzexe
 	hd head hey hostname
 	id ident ifconfig &lt;bin&gt;install installsound iroster isvolume
 	$(IDE_ONLY)ideinfo $(IDE_ONLY)idestatus
-	join
-	keymap kill less lessecho lesskey link listarea listattr
-	listimage listdev
+	join keymap kill 
+	less lessecho lesskey link linkcatkeys listarea listattr listimage listdev
 	listport listres listsem listusb ln locate logger login logname ls lsindex
 	makebootable md5sum merge message mimeset mkdos mkdir mkfifo mkfs mkindex
 	modifiers mount mount_nfs mountvolume mv
@@ -71,19 +69,31 @@
 	ShowImage SoundRecorder StyledEdit Terminal TextSearch TV Workspaces
 ;
 SYSTEM_PREFERENCES = Appearance Backgrounds CPUFrequency DataTranslations E-mail
-	FileTypes Fonts Keyboard Keymap Media Mouse Network OpenGL Printers
+	FileTypes Fonts Keyboard Keymap Locale Media Mouse Network OpenGL Printers
 	Screen ScreenSaver Sounds Time Touchpad &lt;preference&gt;Tracker VirtualMemory
 ;
 SYSTEM_DEMOS = BSnow Chart Clock Cortex FontDemo
 	GLTeapot Haiku3d Mandelbrot Pairs Playground Pulse Sudoku Gradients
 ;
-SYSTEM_LIBS = libalm.so libbe.so libbsd.so libbnetapi.so libdebug.so
-	libdevice.so libfluidsynth.so libfreetype.so libgame.so libGL.so libgnu.so
-	libilmimf.so libjpeg.so liblinprog.so liblpsolve55.so libmail.so libmedia.so
-	libmidi.so libmidi2.so libnetwork.so libpng.so &lt;revisioned&gt;libroot.so
-	libscreensaver.so libtextencoding.so libtracker.so libtranslation.so
+ICU_LIBS = libicu-common.so libicu-data.so libicu-i18n.so
+;
+SYSTEM_LIBS = 
+	libalm.so 
+	libbe.so libbsd.so libbnetapi.so 
+	libdebug.so libdevice.so 
+	libfluidsynth.so libfreetype.so 
+	libgame.so libGL.so libgnu.so
+	libilmimf.so 
+	libjpeg.so 
+	liblinprog.so liblocale.so liblpsolve55.so 
+	libmail.so libmedia.so libmidi.so libmidi2.so 
+	libnetwork.so 
+	libpng.so 
+	&lt;revisioned&gt;libroot.so 
+	libscreensaver.so 
+	libtextencoding.so libtracker.so libtranslation.so 
 	libz.so
-	$(HAIKU_SHARED_LIBSTDC++) $(HAIKU_SHARED_LIBSUPC++)
+	$(HAIKU_SHARED_LIBSTDC++) $(HAIKU_SHARED_LIBSUPC++) $(ICU_LIBS)
 ;
 SYSTEM_SERVERS = app_server cddb_daemon debug_server input_server mail_daemon
 	media_addon_server media_server midi_server net_server print_server
@@ -109,6 +119,7 @@
 	RAWTranslator RTF-Translator SGITranslator STXTTranslator TGATranslator
 	TIFFTranslator WonderBrushTranslator
 ;
+SYSTEM_ADD_ONS_LOCALE_CATALOGS = &lt;catalog-addon&gt;zeta &lt;catalog-addon&gt;plaintext ;
 SYSTEM_ADD_ONS_MEDIA = cortex_audioadapter.media_addon cortex_flanger.media_addon
 	dvb.media_addon
 	hmulti_audio.media_addon
@@ -352,7 +363,8 @@
 AddDirectoryToHaikuImage system data sounds ;
 
 # Add mail provider infos.
-AddFilesToHaikuImage home config settings Mail ProviderInfo : $(HAIKU_PROVIDER_INFOS) ;
+AddFilesToHaikuImage home config settings Mail ProviderInfo : 
+	$(HAIKU_PROVIDER_INFOS) ;
 
 # Mail spell check dictionaries
 local spellFiles = words geekspeak ;
@@ -361,6 +373,11 @@
 	= [ FDirName $(HAIKU_TOP) src apps mail ] ;
 AddFilesToHaikuImage system etc word_dictionary : $(spellFiles) ;
 
+# Locale kit language files
+local languageDir = [ FDirName $(HAIKU_TOP) src data etc locale languages ] ;
+local languages = [ Glob $(languageDir) : *.language ] ;
+AddFilesToHaikuImage system data locale languages : $(languages) ;
+
 local etcFiles = bash_completion inputrc profile teapot.data ;
 etcFiles = $(etcFiles:G=etc) ;
 SEARCH on $(etcFiles) = [ FDirName $(HAIKU_TOP) data etc ] ;
@@ -462,6 +479,7 @@
 	: Mesa\ Software\ Renderer ;
 AddFilesToHaikuHybridImage system add-ons Translators
 	: $(SYSTEM_ADD_ONS_TRANSLATORS) : : true ;
+AddFilesToHaikuImage system add-ons locale catalogs : $(SYSTEM_ADD_ONS_LOCALE_CATALOGS) ;
 AddFilesToHaikuImage system add-ons mail_daemon inbound_protocols : POP3 IMAP ;
 AddFilesToHaikuImage system add-ons mail_daemon outbound_protocols : SMTP ;
 AddFilesToHaikuImage system add-ons mail_daemon inbound_filters : Match\ Header Spam\ Filter R5\ Daemon\ Filter ;

Modified: haiku/trunk/build/jam/HeadersRules
===================================================================
--- haiku/trunk/build/jam/HeadersRules	2009-09-18 22:22:55 UTC (rev 33175)
+++ haiku/trunk/build/jam/HeadersRules	2009-09-18 22:23:34 UTC (rev 33176)
@@ -354,8 +354,8 @@
 					   add-ons/input_server add-ons/registrar
 					   add-ons/screen_saver
 					   add-ons/tracker app device drivers game interface
-					   kernel media mail midi midi2 net opengl storage support
-					   translation ;
+					   kernel locale media mail midi midi2 net opengl storage
+					   support translation ;
 
 	return [ FDirName $(HAIKU_TOP) headers os ]
 		[ PublicHeaders $(osIncludes) ] ;
@@ -367,8 +367,8 @@
 					   add-ons/input_server add-ons/registrar
 					   add-ons/screen_saver
 					   add-ons/tracker app device drivers game interface
-					   kernel media mail midi midi2 net opengl storage support
-					   translation ;
+					   kernel locale media mail midi midi2 net opengl storage
+					   support translation ;
 
 	local headers = ;
 

Modified: haiku/trunk/data/system/boot/SetupEnvironment
===================================================================
--- haiku/trunk/data/system/boot/SetupEnvironment	2009-09-18 22:22:55 UTC (rev 33175)
+++ haiku/trunk/data/system/boot/SetupEnvironment	2009-09-18 22:23:34 UTC (rev 33176)
@@ -24,7 +24,7 @@
 
 BELIBRARIES=&quot;$BUILDHOME/abi/current/library-paths/common:$BUILDHOME/lib/$BE_HOST_CPU&quot;
 BH=$BUILDHOME/headers
-BEINCLUDES=&quot;$BH;$BH/be;$BH/posix;$BH/glibc;$BH/cpp;$BH/be/app;$BH/be/device;$BH/be/interface;$BH/be/media;$BH/be/midi;$BH/be/midi2;$BH/be/net;$BH/be/kernel;$BH/be/storage;$BH/be/support;$BH/be/game;$BH/be/opengl;$BH/be/drivers;$BH/gnu;$BH/be/mail;$BH/be/translation;$BH/be/devel;$BH/be/add-ons/graphics;$BH/be/be_apps/Deskbar;$BH/be/be_apps/NetPositive;$BH/be/be_apps/Tracker&quot;
+BEINCLUDES=&quot;$BH;$BH/be;$BH/posix;$BH/glibc;$BH/cpp;$BH/be/app;$BH/be/device;$BH/be/interface;$BH/be/locale;$BH/be/media;$BH/be/midi;$BH/be/midi2;$BH/be/net;$BH/be/kernel;$BH/be/storage;$BH/be/support;$BH/be/game;$BH/be/opengl;$BH/be/drivers;$BH/gnu;$BH/be/mail;$BH/be/translation;$BH/be/devel;$BH/be/add-ons/graphics;$BH/be/be_apps/Deskbar;$BH/be/be_apps/NetPositive;$BH/be/be_apps/Tracker&quot;
 
 export BUILDHOME
 export BETOOLS

Modified: haiku/trunk/headers/build/os/app/Application.h
===================================================================
--- haiku/trunk/headers/build/os/app/Application.h	2009-09-18 22:22:55 UTC (rev 33175)
+++ haiku/trunk/headers/build/os/app/Application.h	2009-09-18 22:23:34 UTC (rev 33176)
@@ -16,6 +16,8 @@
 							BApplication(const char* signature,
 										 status_t* error);
 	virtual					~BApplication();
+
+	status_t				GetAppInfo(app_info* info);
 };
 
 // Global Objects

Copied: haiku/trunk/headers/libs/icu (from rev 33174, haiku/branches/components/gsoc-locale-kit/headers/libs/icu)

Modified: haiku/trunk/headers/os/locale/Catalog.h
===================================================================
--- haiku/trunk/headers/os/locale/Catalog.h	2009-09-18 22:22:55 UTC (rev 33175)
+++ haiku/trunk/headers/os/locale/Catalog.h	2009-09-18 22:23:34 UTC (rev 33176)
@@ -15,7 +15,7 @@
 	public:
 		BCatalog();
 		BCatalog(const char *signature, const char *language = NULL,
-			int32 fingerprint = 0);
+			uint32 fingerprint = 0);
 		virtual ~BCatalog();
 
 		const char *GetString(const char *string, const char *context = NULL,
@@ -27,7 +27,7 @@
 
 		status_t GetSignature(BString *sig);
 		status_t GetLanguage(BString *lang);
-		status_t GetFingerprint(int32 *fp);
+		status_t GetFingerprint(uint32 *fp);
 
 		status_t InitCheck() const;
 		int32 CountItems() const;
@@ -143,7 +143,7 @@
 		friend class BLocaleRoster;
 	public:
 		BCatalogAddOn(const char *signature, const char *language,
-					  int32 fingerprint);
+					  uint32 fingerprint);
 		virtual ~BCatalogAddOn();
 
 		virtual const char *GetString(const char *string,
@@ -195,7 +195,7 @@
 		status_t 			fInitCheck;
 		BString 			fSignature;
 		BString 			fLanguageName;
-		int32				fFingerprint;
+		uint32				fFingerprint;
 		BCatalogAddOn 		*fNext;
 
 		friend class BCatalog;
@@ -206,7 +206,7 @@
 // ...the function that instantiates a catalog for this add-on-type...
 extern &quot;C&quot;
 BCatalogAddOn *instantiate_catalog(const char *signature,
-	const char *language, int32 fingerprint);
+	const char *language, uint32 fingerprint);
 // ...the function that creates an empty catalog for this add-on-type...
 extern &quot;C&quot;
 BCatalogAddOn *create_catalog(const char *signature,
@@ -243,7 +243,7 @@
 
 
 inline status_t
-BCatalog::GetFingerprint(int32 *fp)
+BCatalog::GetFingerprint(uint32 *fp)
 {
 	if (!fp)
 		return B_BAD_VALUE;

Modified: haiku/trunk/headers/os/locale/Country.h
===================================================================
--- haiku/trunk/headers/os/locale/Country.h	2009-09-18 22:22:55 UTC (rev 33175)
+++ haiku/trunk/headers/os/locale/Country.h	2009-09-18 22:23:34 UTC (rev 33176)
@@ -6,6 +6,13 @@
 #include &lt;LocaleStrings.h&gt;
 #include &lt;String.h&gt;
 
+#include &lt;unicode/locid.h&gt;
+
+namespace icu_4_2 {
+	class DateFormat;
+}
+
+
 enum {
 	B_METRIC = 0,
 	B_US
@@ -14,39 +21,46 @@
 
 class BCountry {
 	public:
-		BCountry();
+		BCountry(const char* languageCode, const char* countryCode);
+		BCountry(const char* languageAndCountryCode = &quot;en_US&quot;);
 		virtual ~BCountry();
 
-		virtual const char *Name() const;
+		virtual bool Name(BString&amp;) const;
+		const char* Code() const;
 
 		// see definitions below
 		const char *GetString(uint32 id) const;
 
 		// date &amp; time
 
-		virtual void	FormatDate(char *string,size_t maxSize,time_t time,bool longFormat);
-		virtual void	FormatDate(BString *string,time_t time,bool longFormat);
-		virtual void	FormatTime(char *string,size_t maxSize,time_t time,bool longFormat);
-		virtual void	FormatTime(BString *string,time_t time,bool longFormat);
+		virtual void FormatDate(char* string, size_t maxSize, time_t time,
+			bool longFormat);
+		virtual void FormatDate(BString* string, time_t time, bool longFormat);
+		virtual void FormatTime(char* string, size_t maxSize, time_t time,
+			bool longFormat);
+		virtual void FormatTime(BString* string, time_t time,
+			bool longFormat);
 
-		const char		*DateFormat(bool longFormat) const;
-		const char		*TimeFormat(bool longFormat) const;
-		const char		*DateSeparator() const;
-		const char		*TimeSeparator() const;
+		bool		DateFormat(BString&amp;, bool longFormat) const;
+		void		SetDateFormat(const char* formatString,
+						bool longFormat = true);
+		bool		TimeFormat(BString&amp;, bool longFormat) const;
+		const char*	DateSeparator() const;
+		const char*	TimeSeparator() const;
 
 		// numbers
 
-		virtual void	FormatNumber(char *string,size_t maxSize,double value);
-		virtual void	FormatNumber(BString *string,double value);
-		virtual void	FormatNumber(char *string,size_t maxSize,int32 value);
-		virtual void	FormatNumber(BString *string,int32 value);
+		virtual void FormatNumber(char* string, size_t maxSize, double value);
+		virtual UErrorCode FormatNumber(BString* string, double value);
+		virtual void FormatNumber(char* string, size_t maxSize, int32 value);
+		virtual void FormatNumber(BString* string, int32 value);
 
-		const char		*DecimalPoint() const;
-		const char		*ThousandsSeparator() const;
-		const char		*Grouping() const;
+		bool		DecimalPoint(BString&amp;) const;
+		bool		ThousandsSeparator(BString&amp;) const;
+		bool		Grouping(BString&amp;) const;
 
-		const char		*PositiveSign() const;
-		const char		*NegativeSign() const;
+		bool		PositiveSign(BString&amp;) const;
+		bool		NegativeSign(BString&amp;) const;
 
 		// measurements
 
@@ -54,21 +68,22 @@
 
 		// monetary
 
-		virtual ssize_t	FormatMonetary(char *string,size_t maxSize,char *format, ...);
-		virtual ssize_t	FormatMonetary(BString *string,char *format, ...);
+		virtual ssize_t	FormatMonetary(char* string, size_t maxSize,
+			double value);
+		virtual ssize_t	FormatMonetary(BString* string, double value);
 
-		const char		*CurrencySymbol() const;
-		const char		*InternationalCurrencySymbol() const;
-		const char		*MonDecimalPoint() const;
-		const char		*MonThousandsSeparator() const;
-		const char		*MonGrouping() const;
+		bool		CurrencySymbol(BString&amp;) const;
+		bool		InternationalCurrencySymbol(BString&amp;) const;
+		bool		MonDecimalPoint(BString&amp;) const;
+		bool		MonThousandsSeparator(BString&amp;) const;
+		bool		MonGrouping(BString&amp;) const;
 		virtual int32	MonFracDigits() const;
 
-	protected:
-		BCountry(const char **strings);
-
 	private:
-		const char	**fStrings;
+		icu_4_2::DateFormat* fICULongDateFormatter;
+		icu_4_2::DateFormat* fICUShortDateFormatter;
+		const char**	fStrings;
+		Locale fICULocale;
 };
 
 #endif	/* _COUNTRY_H_ */

Deleted: haiku/trunk/headers/os/locale/DefaultCatalog.h

Modified: haiku/trunk/headers/os/locale/Language.h
===================================================================
--- haiku/trunk/headers/os/locale/Language.h	2009-09-18 22:22:55 UTC (rev 33175)
+++ haiku/trunk/headers/os/locale/Language.h	2009-09-18 22:23:34 UTC (rev 33176)
@@ -1,3 +1,9 @@
+/*
+** Copyright 2003, Axel D&#246;rfler, <A HREF="https://lists.berlios.de/mailman/listinfo/haiku-commits">axeld at pinc-software.de.</A> All rights reserved.
+** Distributed under the terms of the MIT License.
+*/
+
+
 #ifndef _LANGUAGE_H_
 #define _LANGUAGE_H_
 

Modified: haiku/trunk/headers/os/locale/Locale.h
===================================================================
--- haiku/trunk/headers/os/locale/Locale.h	2009-09-18 22:22:55 UTC (rev 33175)
+++ haiku/trunk/headers/os/locale/Locale.h	2009-09-18 22:23:34 UTC (rev 33176)
@@ -25,7 +25,8 @@
 
 		void FormatString(char *target, size_t maxSize, char *fmt, ...);
 		void FormatString(BString *, char *fmt, ...);
-		void FormatDateTime(char *target, size_t maxSize, const char *fmt, time_t);
+		void FormatDateTime(char *target, size_t maxSize, const char *fmt,
+			time_t);
 		void FormatDateTime(BString *, const char *fmt, time_t);
 
 		// Country short-hands
@@ -37,8 +38,10 @@
 
 		// Collator short-hands
 
-		int StringCompare(const char *, const char *, int32 len = -1, int8 strength = B_COLLATE_DEFAULT) const;
-		int StringCompare(const BString *, const BString *, int32 len = -1, int8 strength = B_COLLATE_DEFAULT) const;
+		int StringCompare(const char *, const char *, int32 len = -1,
+			int8 strength = B_COLLATE_DEFAULT) const;
+		int StringCompare(const BString *, const BString *,
+			int32 len = -1, int8 strength = B_COLLATE_DEFAULT) const;
 
 		void GetSortKey(const char *string, BString *key);
 

Modified: haiku/trunk/headers/os/locale/LocaleRoster.h
===================================================================
--- haiku/trunk/headers/os/locale/LocaleRoster.h	2009-09-18 22:22:55 UTC (rev 33175)
+++ haiku/trunk/headers/os/locale/LocaleRoster.h	2009-09-18 22:23:34 UTC (rev 33176)
@@ -1,8 +1,10 @@
 #ifndef _LOCALE_ROSTER_H_
 #define _LOCALE_ROSTER_H_
 
+
 #include &lt;String.h&gt;
 
+
 class BLanguage;
 class BLocale;
 class BCollator;
@@ -10,6 +12,8 @@
 class BCatalog;
 class BCatalogAddOn;
 
+struct entry_ref;
+
 namespace BPrivate {
 	class EditableCatalog;
 };
@@ -18,6 +22,7 @@
 	B_LOCALE_CHANGED	= '_LCC',
 };
 
+
 class BLocaleRoster {
 
 	public:
@@ -28,11 +33,12 @@
 //		status_t GetCatalog(const char *mimeType, BCatalog *catalog);
 //		status_t SetCatalog(BLocale *,const char *mimeType, BCatalog *catalog);
 
-//		status_t GetLocaleFor(const char *langCode,const char *countryCode);
+//		status_t GetLocaleFor(const char *langCode, const char *countryCode);
 
 		status_t GetDefaultCollator(BCollator **) const;
 		status_t GetDefaultLanguage(BLanguage **) const;
 		status_t GetDefaultCountry(BCountry **) const;
+		void SetDefaultCountry(BCountry *) const;
 
 		status_t GetPreferredLanguages(BMessage *) const;
 		status_t SetPreferredLanguages(BMessage *);
@@ -43,36 +49,29 @@
 			// the message contains one or more 'language'-string-fields
 			// which contain the language-name(s)
 
-		status_t GetInstalledCatalogs(BMessage *,
-					const char* sigPattern = NULL,
-					const char* langPattern = NULL,
-					int32 fingerprint = 0) const;
+		status_t GetInstalledCatalogs(BMessage *, const char* sigPattern = NULL,
+			const char* langPattern = NULL,	int32 fingerprint = 0) const;
 			// the message contains...
 
-//		status_t GetDefaultLanguage(BLanguage *);
-//		status_t SetDefaultLanguage(BLanguage *);
-
 		static const char *kCatLangAttr;
 		static const char *kCatSigAttr;
 		static const char *kCatFingerprintAttr;
-		//
+
 		static const char *kCatManagerMimeType;
 		static const char *kCatEditorMimeType;
-		//
+
 		static const char *kEmbeddedCatAttr;
 		static int32 kEmbeddedCatResId;
 
 	private:
 
 		BCatalogAddOn* LoadCatalog(const char *signature,
-							const char *language = NULL,
-							int32 fingerprint = 0);
+			const char *language = NULL, int32 fingerprint = 0);
 		BCatalogAddOn* LoadEmbeddedCatalog(entry_ref *appOrAddOnRef);
 		status_t UnloadCatalog(BCatalogAddOn *addOn);
-		//
+
 		BCatalogAddOn* CreateCatalog(const char *type,
-							const char *signature,
-							const char *language);
+			const char *signature, const char *language);
 
 		friend class BCatalog;
 		friend class BPrivate::EditableCatalog;

Modified: haiku/trunk/headers/os/locale/LocaleStrings.h
===================================================================
--- haiku/trunk/headers/os/locale/LocaleStrings.h	2009-09-18 22:22:55 UTC (rev 33175)
+++ haiku/trunk/headers/os/locale/LocaleStrings.h	2009-09-18 22:23:34 UTC (rev 33176)
@@ -6,13 +6,9 @@
 	B_COUNTRY_STRINGS_BASE	= 0,
 
 	B_DATE_TIME_FORMAT		= B_COUNTRY_STRINGS_BASE,
-	B_DATE_FORMAT,
-	B_TIME_FORMAT,
 	B_TIME_AM_PM_FORMAT,
 
 	B_SHORT_DATE_TIME_FORMAT,
-	B_SHORT_DATE_FORMAT,
-	B_SHORT_TIME_FORMAT,
 	B_SHORT_TIME_AM_PM_FORMAT,
 
 	B_AM_STRING,
@@ -20,18 +16,7 @@
 
 	B_DATE_SEPARATOR,
 	B_TIME_SEPARATOR,
-	B_GROUPING,
-	B_DECIMAL_POINT,
-	B_THOUSANDS_SEPARATOR,
-	B_POSITIVE_SIGN,
-	B_NEGATIVE_SIGN,
 
-	B_CURRENCY_SYMBOL,
-	B_INT_CURRENCY_SYMBOL,
-	B_MON_GROUPING,
-	B_MON_DECIMAL_POINT,
-	B_MON_THOUSANDS_SEPARATOR,
-
 	B_NUM_COUNTRY_STRINGS,
 };
 

Copied: haiku/trunk/headers/posix/langinfo.h (from rev 33174, haiku/branches/components/gsoc-locale-kit/headers/posix/langinfo.h)

Copied: haiku/trunk/headers/posix/monetary.h (from rev 33174, haiku/branches/components/gsoc-locale-kit/headers/posix/monetary.h)

Copied: haiku/trunk/headers/posix/nl_types.h (from rev 33174, haiku/branches/components/gsoc-locale-kit/headers/posix/nl_types.h)

Copied: haiku/trunk/headers/private/locale/DefaultCatalog.h (from rev 33174, haiku/branches/components/gsoc-locale-kit/headers/private/locale/DefaultCatalog.h)

Copied: haiku/trunk/headers/private/locale/HashMapCatalog.h (from rev 33174, haiku/branches/components/gsoc-locale-kit/headers/private/locale/HashMapCatalog.h)

Copied: haiku/trunk/headers/private/locale/ICUWrapper.h (from rev 33174, haiku/branches/components/gsoc-locale-kit/headers/private/locale/ICUWrapper.h)

Copied: haiku/trunk/headers/private/locale/PlainTextCatalog.h (from rev 33174, haiku/branches/components/gsoc-locale-kit/headers/private/locale/PlainTextCatalog.h)

Modified: haiku/trunk/headers/private/locale/PropertyFile.h
===================================================================
--- haiku/trunk/headers/private/locale/PropertyFile.h	2009-09-18 22:22:55 UTC (rev 33175)
+++ haiku/trunk/headers/private/locale/PropertyFile.h	2009-09-18 22:23:34 UTC (rev 33176)
@@ -1,6 +1,6 @@
 /* 
 ** Copyright 2003, Axel D&#246;rfler, <A HREF="https://lists.berlios.de/mailman/listinfo/haiku-commits">axeld at pinc-software.de.</A> All rights reserved.
-** Distributed under the terms of the OpenBeOS License.
+** Distributed under the terms of the MIT License.
 */
 #ifndef PROPERTY_FILE_H
 #define PROPERTY_FILE_H

Deleted: haiku/trunk/headers/private/locale/langinfo.h

Deleted: haiku/trunk/headers/private/locale/monetary.h

Deleted: haiku/trunk/headers/private/locale/nl_types.h

Modified: haiku/trunk/headers/private/shared/OpenHashTable.h
===================================================================
--- haiku/trunk/headers/private/shared/OpenHashTable.h	2009-09-18 22:22:55 UTC (rev 33175)
+++ haiku/trunk/headers/private/shared/OpenHashTable.h	2009-09-18 22:23:34 UTC (rev 33176)
@@ -45,7 +45,7 @@
 #ifndef __OPEN_HASH_TABLE__
 #define __OPEN_HASH_TABLE__
 
-#include &lt;malloc.h&gt;
+#include &lt;stdlib.h&gt;
 #include &lt;new&gt;
 
 // don't include &lt;Debug.h&gt;

Modified: haiku/trunk/src/add-ons/locale/catalogs/Jamfile
===================================================================
--- haiku/trunk/src/add-ons/locale/catalogs/Jamfile	2009-09-18 22:22:55 UTC (rev 33175)
+++ haiku/trunk/src/add-ons/locale/catalogs/Jamfile	2009-09-18 22:23:34 UTC (rev 33176)
@@ -4,7 +4,9 @@
 NotFile LocaleKitCatalogAddons ;
 Depends LocaleKitCatalogAddons
 	:
+	&lt;catalog-addon&gt;plaintext
 	&lt;catalog-addon&gt;zeta
 	;
 
+SubInclude HAIKU_TOP src add-ons locale catalogs plaintext ;
 SubInclude HAIKU_TOP src add-ons locale catalogs zeta ;

Copied: haiku/trunk/src/add-ons/locale/catalogs/plaintext (from rev 33174, haiku/branches/components/gsoc-locale-kit/src/add-ons/locale/catalogs/plaintext)

Modified: haiku/trunk/src/add-ons/locale/catalogs/zeta/Catalog.cpp
===================================================================
--- haiku/trunk/src/add-ons/locale/catalogs/zeta/Catalog.cpp	2009-09-18 22:22:55 UTC (rev 33175)
+++ haiku/trunk/src/add-ons/locale/catalogs/zeta/Catalog.cpp	2009-09-18 22:23:34 UTC (rev 33176)
@@ -1,8 +1,10 @@
-/* 
+/*
 ** Copyright 2003, Oliver Tappe, <A HREF="https://lists.berlios.de/mailman/listinfo/haiku-commits">zooey at hirschkaefer.de.</A> All rights reserved.
 ** Distributed under the terms of the OpenBeOS License.
 */
 
+#include &lt;new&gt;
+
 #include &lt;syslog.h&gt;
 
 #include &lt;Application.h&gt;
@@ -23,8 +25,8 @@
 class ZetaCatalog : public BCatalogAddOn {
 
 	public:
-		ZetaCatalog(const char *signature, const char *language, 
-			int32 fingerprint);
+		ZetaCatalog(const char *signature, const char *language,
+			uint32 fingerprint);
 		~ZetaCatalog();
 
 		const char *GetString(const char *string, const char *context=NULL,
@@ -35,22 +37,22 @@
 
 };
 
-ZetaCatalog::ZetaCatalog(const char *signature, const char *language, 
-	int32 fingerprint)
+ZetaCatalog::ZetaCatalog(const char *signature, const char *language,
+	uint32 fingerprint)
 	:
 	BCatalogAddOn(signature, language, fingerprint)
 {
 	app_info appInfo;
-	be_app-&gt;GetAppInfo(&amp;appInfo); 
+	be_app-&gt;GetAppInfo(&amp;appInfo);
 	node_ref nref;
 	nref.device = appInfo.ref.device;
 	nref.node = appInfo.ref.directory;
 	BDirectory appDir( &amp;nref);
 
-	// ToDo: implement loading of zeta-catalog 
+	// ToDo: implement loading of zeta-catalog
 	fInitCheck = EOPNOTSUPP;
 
-	log_team(LOG_DEBUG, 
+	log_team(LOG_DEBUG,
 		&quot;trying to load zeta-catalog with sig %s for lang %s results in %s&quot;,
 		signature, language, strerror(fInitCheck));
 }
@@ -75,9 +77,10 @@
 
 
 extern &quot;C&quot; BCatalogAddOn *
-instantiate_catalog(const char *signature, const char *language, int32 fingerprint)
+instantiate_catalog(const char *signature, const char *language, uint32 fingerprint)
 {
-	ZetaCatalog *catalog = new ZetaCatalog(signature, language, fingerprint);
+	ZetaCatalog *catalog
+		= new(std::nothrow) ZetaCatalog(signature, language, fingerprint);
 	if (catalog &amp;&amp; catalog-&gt;InitCheck() != B_OK) {
 		delete catalog;
 		return NULL;

Modified: haiku/trunk/src/bin/locale/Jamfile
===================================================================
--- haiku/trunk/src/bin/locale/Jamfile	2009-09-18 22:22:55 UTC (rev 33175)
+++ haiku/trunk/src/bin/locale/Jamfile	2009-09-18 22:23:34 UTC (rev 33176)
@@ -3,6 +3,7 @@
 SEARCH_SOURCE += [ FDirName $(HAIKU_TOP) src kits tracker ] ;
 
 UsePublicHeaders locale ;
+UsePrivateHeaders locale shared ;
 
 BinCommand collectcatkeys : collectcatkeys.cpp RegExp.cpp 
 	: be liblocale.so $(TARGET_LIBSUPC++) ;

Modified: haiku/trunk/src/bin/locale/collectcatkeys.cpp
===================================================================
--- haiku/trunk/src/bin/locale/collectcatkeys.cpp	2009-09-18 22:22:55 UTC (rev 33175)
+++ haiku/trunk/src/bin/locale/collectcatkeys.cpp	2009-09-18 22:23:34 UTC (rev 33176)
@@ -1,8 +1,13 @@
-/* 
-** Copyright 2003, Oliver Tappe, <A HREF="https://lists.berlios.de/mailman/listinfo/haiku-commits">zooey at hirschkaefer.de.</A> All rights reserved.
-** Distributed under the terms of the OpenBeOS License.
-*/
+/*
+ * Copyright 2003-2009, Haiku.
+ * Distributed under the terms of the MIT License.
+ *
+ * Authors:
+ *		Oliver Tappe, <A HREF="https://lists.berlios.de/mailman/listinfo/haiku-commits">zooey at hirschkaefer.de</A>
+ *		Adrien Destugues, <A HREF="https://lists.berlios.de/mailman/listinfo/haiku-commits">pulkomandy at gmail.com</A>
+ */
 
+
 #include &lt;cctype&gt;
 #include &lt;cerrno&gt;
 #include &lt;cstdio&gt;
@@ -13,8 +18,10 @@
 #include &lt;Entry.h&gt;
 #include &lt;File.h&gt;
 #include &quot;RegExp.h&quot;
+#include &lt;StorageDefs.h&gt;
 #include &lt;String.h&gt;
 
+
 bool showKeys = false;
 bool showSummary = false;
 bool showWarnings = false;
@@ -34,7 +41,7 @@
 
 
 void
-usage() 
+usage()
 {
 	fprintf(stderr,
 		&quot;usage: collectcatkeys [-pvw] [-r &lt;regex&gt;] [-o &lt;outfile&gt;] [-l &lt;catalogLanguage&gt;]\n&quot;
@@ -56,55 +63,74 @@
 fetchStr(const char *&amp;in, BString &amp;str, bool lookForID)
 {
 	int parLevel = 0;
-	while(isspace(*in) || *in == '(') {
+	while (isspace(*in) || *in == '(') {
 		if (*in == '(')
 			parLevel++;
 		in++;
 	}
 	if (*in == '&quot;') {
+		bool inString = true;
+		bool quoted = false;
 		in++;
-		bool quoted = false;
-		while (*in != '&quot;' || quoted) {
-			if (quoted) {
-				if (*in == 'n')
-					str.Append(&quot;\n&quot;,1);
-				else if (*in == 't')
-					str.Append(&quot;\t&quot;,1);
-				else if (*in == '&quot;')
-					str.Append(&quot;\&quot;&quot;,1);
+		while (parLevel &gt;= 0 &amp;&amp; inString)
+		{
+			// Collect string content until we find a quote marking end of
+			// string (skip escaped quotes)
+			while (*in != '&quot;' || !quoted)
+			{
+				str.Append(in,1);
+				if (*in == '\\' &amp;&amp; !quoted)
+					quoted = true;
 				else
-					// dump quote from unknown quoting-sequence:
-					str.Append(in,1);
-				quoted = false;
-			} else {
-				quoted = (*in == '\\');
-				if (!quoted)
-					str.Append(in,1);
+					quoted = false;
+				in++;
 			}
 			in++;
+
+			inString = false;
+
+			// Strip all whitespace until we find a closing parenthesis, or the
+			// beginning of another string
+			// TODO: ignore comments
+			while (isspace(*in) || *in == ')') {
+				if (*in == ')') {
+					if (parLevel == 0)
+						return true;
+					parLevel--;
+				}
+
+				in++;
+			}
+
+			if (*in == '&quot;') {
+				inString = true;
+				in++;
+			}
 		}
-		in++;
-	} else if (!memcmp(in, &quot;__null&quot;, 6)) {
-		// NULL is preprocessed into __null, which we parse as &quot;&quot;
-		in += 6;
-	} else if (lookForID &amp;&amp; (isdigit(*in) || *in == '-' || *in == '+')) {
-		// try to parse an ID (a long):
-		errno = 0;
-		char *next;
-		id = strtol(in, &amp;next, 10);
-		if (id != 0 || errno == 0) {
-			haveID = true;
-			in = next;
+	} else {
+		if (!memcmp(in, &quot;__null&quot;, 6)) {
+			// NULL is preprocessed into __null, which we parse as &quot;&quot;
+			in += 6;
+		} else if (lookForID &amp;&amp; (isdigit(*in) || *in == '-' || *in == '+')) {
+			// try to parse an ID (a long):
+			errno = 0;
+			char *next;
+			id = strtol(in, &amp;next, 10);
+			if (id != 0 || errno == 0) {
+				haveID = true;
+				in = next;
+			}
+		} else
+			return false;
+
+		while (isspace(*in) || *in == ')') {
+			if (*in == ')') {
+				if (!parLevel)
+					return true;
+				parLevel--;
+			}
+			in++;
 		}
-	} else
-		return false;
-	while(isspace(*in) || *in == ')') {
-		if (*in == ')') {
-			if (!parLevel)
-				return true;
-			parLevel--;
-		}
-		in++;
 	}
 	return true;
 }
@@ -145,7 +171,7 @@
 	}
 	status_t res;
 	const char *in = inputStr.String();
-	while(rx.RunMatcher(rxprg, in)) {
+	while (rx.RunMatcher(rxprg, in)) {
 		const char *start = rxprg-&gt;startp[0];
 		in = rxprg-&gt;endp[0];
 		if (fetchKey(in)) {
@@ -154,18 +180,21 @@
 					printf(&quot;CatKey(%ld)\n&quot;, id);
 				res = catalog-&gt;SetString(id, &quot;&quot;);
 				if (res != B_OK) {
-					fprintf(stderr, &quot;couldn't add key %ld - error: %s\n&quot;, 
+					fprintf(stderr, &quot;couldn't add key %ld - error: %s\n&quot;,
 						id, strerror(res));
 					exit(-1);
 				}
 			} else {
-				if (showKeys)
-					printf(&quot;CatKey(\&quot;%s\&quot;, \&quot;%s\&quot;, \&quot;%s\&quot;)\n&quot;, str.String(), 
+				if (showKeys) {
+					printf(&quot;CatKey(\&quot;%s\&quot;, \&quot;%s\&quot;, \&quot;%s\&quot;)\n&quot;, str.String(),
 						ctx.String(), cmt.String());
-				res = catalog-&gt;SetString(str.String(), str.String(), ctx.String(), cmt.String());
+				}
+				res = catalog-&gt;SetString(str.String(), str.String(),
+					ctx.String(), cmt.String());
 				if (res != B_OK) {
-					fprintf(stderr, &quot;couldn't add key %s,%s,%s - error: %s\n&quot;, 
-						str.String(), ctx.String(), cmt.String(), strerror(res));
+					fprintf(stderr, &quot;couldn't add key %s,%s,%s - error: %s\n&quot;,
+						str.String(), ctx.String(), cmt.String(),
+						strerror(res));
 					exit(-1);
 				}
 			}
@@ -174,9 +203,10 @@
 			BString match;
 			if (end)
 				match.SetTo(start, end-start+1);
-			else
-				// can't determine end of statement, we output next 40 characters
+			else {
+				// can't determine end of statement, we output next 40 chars
 				match.SetTo(start, 40);
+			}

[... truncated: 3431 lines follow ...]

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="020682.html">[Haiku-commits] r33175 -	haiku/trunk/src/tests/kits/net/preflet/StatusAddOn
</A></li>
	<LI>Next message: <A HREF="020684.html">[Haiku-commits] BOM: r33176 ...failed	Link	/objects/freebsd/_arch_/release/tools/icu/pkgdata/pkgdata ...
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#20683">[ date ]</a>
              <a href="thread.html#20683">[ thread ]</a>
              <a href="subject.html#20683">[ subject ]</a>
              <a href="author.html#20683">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/haiku-commits">More information about the Haiku-commits
mailing list</a><br>
</body></html>
