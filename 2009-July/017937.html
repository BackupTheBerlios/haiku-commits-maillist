<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Haiku-commits] r31535 - in	haiku/branches/components/gsoc-locale-kit: build/jam	src/bin/locale src/kits/locale src/preferences/locale	src/tools/locale
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/haiku-commits/2009-July/index.html" >
   <LINK REL="made" HREF="mailto:haiku-commits%40lists.berlios.de?Subject=Re%3A%20%5BHaiku-commits%5D%20r31535%20-%20in%0A%09haiku/branches/components/gsoc-locale-kit%3A%20build/jam%0A%09src/bin/locale%20src/kits/locale%20src/preferences/locale%0A%09src/tools/locale&In-Reply-To=%3C200907131107.n6DB78MK020688%40sheep.berlios.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="017932.html">
   <LINK REL="Next"  HREF="017938.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Haiku-commits] r31535 - in	haiku/branches/components/gsoc-locale-kit: build/jam	src/bin/locale src/kits/locale src/preferences/locale	src/tools/locale</H1>
    <B>zooey at BerliOS</B> 
    <A HREF="mailto:haiku-commits%40lists.berlios.de?Subject=Re%3A%20%5BHaiku-commits%5D%20r31535%20-%20in%0A%09haiku/branches/components/gsoc-locale-kit%3A%20build/jam%0A%09src/bin/locale%20src/kits/locale%20src/preferences/locale%0A%09src/tools/locale&In-Reply-To=%3C200907131107.n6DB78MK020688%40sheep.berlios.de%3E"
       TITLE="[Haiku-commits] r31535 - in	haiku/branches/components/gsoc-locale-kit: build/jam	src/bin/locale src/kits/locale src/preferences/locale	src/tools/locale">zooey at mail.berlios.de
       </A><BR>
    <I>Mon Jul 13 13:07:08 CEST 2009</I>
    <P><UL>
        <LI>Previous message: <A HREF="017932.html">[Haiku-commits] r31534 -	haiku/trunk/src/apps/debugger/gui/team_window
</A></li>
        <LI>Next message: <A HREF="017938.html">[Haiku-commits] r31536 - in haiku/branches/components/gsoc-locale-kit: . 3rdparty/vmware build/jam build/scripts data/artwork/icons data/common/boot/post_install data/system/boot docs docs/userguide/en docs/userguide/en/applications docs/userguide/en/installation docs/userguide/en/preferences docs/userguide/images docs/userguide/images/apps-images docs/userguide/images/deskbar-images docs/userguide/images/prefs-images docs/userguide/images/queries-images docs/welcome docs/welcome/en headers/cpp headers/glibc headers/libs headers/libs/png headers/libs/print/libprint headers/os headers/os/app headers/os/bluetooth headers/os/bluetooth/HCI headers/os/drivers headers/os/interface headers/os/kernel headers/os/opengl headers/os/storage headers/os/support headers/posix headers/private/app headers/private/bluetooth headers/private/debug headers/private/device headers/private/fs_shell headers/private/graphics/nvidia headers/private/interface headers/private/kernel headers/private/kernel/arch! headers/private/kernel/arch/x86 headers/private/kernel/disk_device_manager headers/private/kernel/fs headers/private/kernel/util headers/private/libroot headers/private/media headers/private/net headers/private/shared headers/private/system headers/private/system/arch/x86 src/add-ons/accelerants/intel_extreme src/add-ons/accelerants/nvidia src/add-ons/accelerants/nvidia/engine src/add-ons/disk_systems/bfs src/add-ons/disk_systems/intel src/add-ons/input_server/devices/keyboard src/add-ons/input_server/devices/mouse src/add-ons/input_server/devices/wacom src/add-ons/input_server/filters/screen_saver src/add-ons/input_server/methods/canna src/add-ons/kernel/bus_managers/acpi src/add-ons/kernel/bus_managers/pci src/add-ons/kernel/busses/scsi/ahci src/add-ons/kernel/cpu/x86 src/add-ons/kernel/debugger/demangle src/add-ons/kernel/debugger/disasm src/add-ons/kernel/debugger/disasm/x86 src/add-ons/kernel/drivers/bluetooth/h2/h2generic src/add-ons/kernel/drivers/graphics/nvidia sr! c/add-ons/kernel/drivers/midi/usb_midi src/add-ons/kernel/driv! ers/netw
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#17937">[ date ]</a>
              <a href="thread.html#17937">[ thread ]</a>
              <a href="subject.html#17937">[ subject ]</a>
              <a href="author.html#17937">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: zooey
Date: 2009-07-13 13:07:06 +0200 (Mon, 13 Jul 2009)
New Revision: 31535
ViewCVS: <A HREF="http://svn.berlios.de/viewcvs/haiku?rev=31535&amp;view=rev">http://svn.berlios.de/viewcvs/haiku?rev=31535&amp;view=rev</A>

Added:
   haiku/branches/components/gsoc-locale-kit/src/preferences/locale/french.catkeys
Modified:
   haiku/branches/components/gsoc-locale-kit/build/jam/BeOSRules
   haiku/branches/components/gsoc-locale-kit/build/jam/HaikuImage
   haiku/branches/components/gsoc-locale-kit/src/bin/locale/collectcatkeys.cpp
   haiku/branches/components/gsoc-locale-kit/src/bin/locale/linkcatkeys.cpp
   haiku/branches/components/gsoc-locale-kit/src/kits/locale/LocaleRoster.cpp
   haiku/branches/components/gsoc-locale-kit/src/preferences/locale/Jamfile
   haiku/branches/components/gsoc-locale-kit/src/preferences/locale/LocaleWindow.cpp
   haiku/branches/components/gsoc-locale-kit/src/tools/locale/PlainTextCatalog.cpp
   haiku/branches/components/gsoc-locale-kit/src/tools/locale/collectcatkeys.cpp
   haiku/branches/components/gsoc-locale-kit/src/tools/locale/linkcatkeys.cpp
Log:
applied patch by Adrien, with a couple of (style-)changes by myself:
* more work at build-tools side of locale kit, an examplatory use in the
  locale prefs works (mostly), now


Modified: haiku/branches/components/gsoc-locale-kit/build/jam/BeOSRules
===================================================================
--- haiku/branches/components/gsoc-locale-kit/build/jam/BeOSRules	2009-07-13 00:19:26 UTC (rev 31534)
+++ haiku/branches/components/gsoc-locale-kit/build/jam/BeOSRules	2009-07-13 11:07:06 UTC (rev 31535)
@@ -315,8 +315,8 @@
 	DEFINES on $(target) = $(defines) ;
 	CCDEFS on $(target) = [ FDefines $(defines) ] ;
 	HDRS on $(target) = [ FIncludes $(headers) : $(localIncludesOption) ]
-												   $(includesSeparator)
-					[ FSysIncludes $(sysHeaders) : $(systemIncludesOption) ] ;
+		$(includesSeparator)
+		[ FSysIncludes $(sysHeaders) : $(systemIncludesOption) ] ;
 	CC on $(target) = $(cc) ;
 
 	LOCALE_KIT_SIGNATURE on $(target) = $(signature) ;
@@ -332,7 +332,7 @@
 actions ExtractCatalogEntries1
 {
 	$(HOST_ADD_BUILD_COMPATIBILITY_LIB_DIR)
-		cat &quot;$(2[2-])&quot; | $(CC) -E $(CCDEFS) $(HDRS) - &gt; &quot;$(1)&quot;.pre
+		cat &quot;$(2[2-])&quot; | $(CC) -E $(CCDEFS) $(HDRS) - &gt; &quot;$(1)&quot;.pre 
 		$(2[1]) -s $(LOCALE_KIT_SIGNATURE) -o &quot;$(1)&quot; &quot;$(1)&quot;.pre
 }
 
@@ -351,5 +351,34 @@
 actions LinkApplicationCatalog1
 {
 	$(HOST_ADD_BUILD_COMPATIBILITY_LIB_DIR)
-		$(2[1]) &quot;$(2[2-])&quot; -s $(LOCALE_KIT_SIGNATURE) -o &quot;$(1)&quot;
+		$(2[1]) &quot;$(2[2-])&quot; -v -s $(LOCALE_KIT_SIGNATURE) -o &quot;$(1)&quot;
 }
+
+# General rules to invoke from jamfiles and that do (almost) everything related
+# to localization
+rule DoCatalogs appName	# Application name
+	: signature 		# Application MIME signature (must match the one
+						# declared in the sourcecode)
+	: sources 			# List of cpp files where to search keys
+	: generatedCatalog	# Name of the generated catalog (most probably
+						# english.catalog)
+	: translatedCatalogs # List of available translations
+{
+	genCat = [ FGristFiles $(generatedCatalog) ] ;
+	
+	for source in $(sources) {
+		ExtractCatalogEntries $(source).catkeys : $(source) : $(signature) ;
+	}
+
+	LinkApplicationCatalog $(genCat) : $(sources).catkeys 
+		: $(signature) ;
+	
+	for catalog in $(translatedCatalogs)
+	{
+		LinkApplicationCatalog $(catalog:B).catalog : $(catalog)
+			: $(signature) ;
+	}
+	
+	AddFilesToHaikuImage system etc locale catalogs $(signature) :
+		$(genCat) $(translatedCatalogs:B).catalog ;
+}

Modified: haiku/branches/components/gsoc-locale-kit/build/jam/HaikuImage
===================================================================
--- haiku/branches/components/gsoc-locale-kit/build/jam/HaikuImage	2009-07-13 00:19:26 UTC (rev 31534)
+++ haiku/branches/components/gsoc-locale-kit/build/jam/HaikuImage	2009-07-13 11:07:06 UTC (rev 31535)
@@ -363,12 +363,6 @@
 etcFiles += &lt;etc&gt;termcap &lt;etc&gt;sysless &lt;etc&gt;sysless.in ;
 AddFilesToHaikuImage system etc : $(etcFiles) ;
 
-# Locale kit catalog files for each application
-# TODO: write a rule to do that automatically, specifying only the MIME 
-# signature and the list of available languages.
-AddFilesToHaikuImage system etc locale catalogs x-vnd.Haiku-LocalePreflet :
-	english.catalog ;
-
 SEARCH on &lt;etc&gt;vimrc = [ FDirName $(HAIKU_TOP) data etc vim ] ;
 AddFilesToHaikuImage system etc vim : &lt;etc&gt;vimrc ;
 

Modified: haiku/branches/components/gsoc-locale-kit/src/bin/locale/collectcatkeys.cpp
===================================================================
--- haiku/branches/components/gsoc-locale-kit/src/bin/locale/collectcatkeys.cpp	2009-07-13 00:19:26 UTC (rev 31534)
+++ haiku/branches/components/gsoc-locale-kit/src/bin/locale/collectcatkeys.cpp	2009-07-13 11:07:06 UTC (rev 31535)
@@ -69,50 +69,68 @@
 		in++;
 	}
 	if (*in == '&quot;') {
+		bool inString = true;
+		bool quoted = false;
 		in++;
-		bool quoted = false;
-		while (*in != '&quot;' || quoted) {
-			if (quoted) {
-				if (*in == 'n')
-					str.Append(&quot;\n&quot;,1);
-				else if (*in == 't')
-					str.Append(&quot;\t&quot;,1);
-				else if (*in == '&quot;')
-					str.Append(&quot;\&quot;&quot;,1);
+		while (parLevel &gt;= 0 &amp;&amp; inString)
+		{
+			// Collect string content until we find a quote marking end of
+			// string (skip escaped quotes)
+			while (*in != '&quot;' || !quoted)
+			{
+				str.Append(in,1);
+				if (*in == '\\' &amp;&amp; !quoted)
+					quoted = true;
 				else
-					// dump quote from unknown quoting-sequence:
-					str.Append(in,1);
-				quoted = false;
-			} else {
-				quoted = (*in == '\\');
-				if (!quoted)
-					str.Append(in,1);
+					quoted = false;
+				in++;
 			}
 			in++;
+
+			inString = false;
+
+			// Strip all whitespace until we find a closing parenthesis, or the
+			// beginning of another string
+			// TODO: ignore comments
+			while (isspace(*in) || *in == ')') {
+				if (*in == ')') {
+					if (parLevel == 0)
+						return true;
+					parLevel--;
+				}
+
+				in++;
+			}
+
+			if (*in == '&quot;') {
+				inString = true;
+				in++;
+			}
 		}
-		in++;
-	} else if (!memcmp(in, &quot;__null&quot;, 6)) {
-		// NULL is preprocessed into __null, which we parse as &quot;&quot;
-		in += 6;
-	} else if (lookForID &amp;&amp; (isdigit(*in) || *in == '-' || *in == '+')) {
-		// try to parse an ID (a long):
-		errno = 0;
-		char *next;
-		id = strtol(in, &amp;next, 10);
-		if (id != 0 || errno == 0) {
-			haveID = true;
-			in = next;
-		}
-	} else
-		return false;
+	} else {
+		if (!memcmp(in, &quot;__null&quot;, 6)) {
+			// NULL is preprocessed into __null, which we parse as &quot;&quot;
+			in += 6;
+		} else if (lookForID &amp;&amp; (isdigit(*in) || *in == '-' || *in == '+')) {
+			// try to parse an ID (a long):
+			errno = 0;
+			char *next;
+			id = strtol(in, &amp;next, 10);
+			if (id != 0 || errno == 0) {
+				haveID = true;
+				in = next;
+			}
+		} else
+			return false;
 
-	while (isspace(*in) || *in == ')') {
-		if (*in == ')') {
-			if (!parLevel)
-				return true;
-			parLevel--;
+		while (isspace(*in) || *in == ')') {
+			if (*in == ')') {
+				if (!parLevel)
+					return true;
+				parLevel--;
+			}
+			in++;
 		}
-		in++;
 	}
 	return true;
 }

Modified: haiku/branches/components/gsoc-locale-kit/src/bin/locale/linkcatkeys.cpp
===================================================================
--- haiku/branches/components/gsoc-locale-kit/src/bin/locale/linkcatkeys.cpp	2009-07-13 00:19:26 UTC (rev 31534)
+++ haiku/branches/components/gsoc-locale-kit/src/bin/locale/linkcatkeys.cpp	2009-07-13 11:07:06 UTC (rev 31535)
@@ -37,6 +37,45 @@
 }
 
 
+void
+parseQuotedChars(BString&amp; stringToParse)
+{
+	char* in = stringToParse.LockBuffer(0);
+	char* out = in;
+	int newLength = 0;
+	bool quoted = false;
+
+	while (*in != 0 || quoted) {
+		if (quoted) {
+			if (*in == 'n')
+				*out = '\n';
+			else if (*in == 't')
+				*out = '\t';
+			else if (*in == '&quot;')
+				*out = '&quot;';
+			else {
+				// dump quote from unknown quoting-sequence:
+				*out = *in ;
+			}
+			quoted = false;
+			out++;
+			newLength++;
+		} else {
+			quoted = (*in == '\\');
+			if (!quoted) {
+				*out = *in;
+				out++;
+				newLength++;
+			}
+		}
+		in++;
+	}
+	*out = '\0';
+
+	stringToParse.UnlockBuffer(newLength);
+}
+
+
 int
 main(int argc, char **argv)
 {
@@ -118,13 +157,25 @@
 
 		// now walk over all entries in input-catalog and add them to
 		// target catalog, unless they already exist there.
-		// (This could be improved by simply inserting the hashmaps,
-		// but this should be fast enough).
 		BHashMapCatalog::CatWalker walker(inputCatImpl);
 		while (!walker.AtEnd()) {
-			const CatKey &amp;key(walker.GetKey());
-			if (!targetCatImpl-&gt;GetString(key))
-				targetCatImpl-&gt;SetString(key, walker.GetValue());
+			const CatKey &amp;plainTextKey(walker.GetKey());
+			BString keyString, keyComment, keyContext;
+			plainTextKey.GetStringParts(&amp;keyString,&amp;keyComment,&amp;keyContext);
+			parseQuotedChars(keyString);
+			const CatKey fixedCatKey(keyString.String(), keyComment.String(),
+					keyContext.String());
+
+			// We need to parse \n, \t and \&quot; now.
+			// They are kept in readable form in the plaintext catkeys, but we
+			// need the raw ascii to match the strings in the compiled program.
+			BString translatedString = walker.GetValue();
+			parseQuotedChars(translatedString);
+
+			if (!targetCatImpl-&gt;GetString(fixedCatKey)) {
+				targetCatImpl-&gt;SetString(fixedCatKey,
+					translatedString.String());
+			}
 			walker.Next();
 		}
 	}

Modified: haiku/branches/components/gsoc-locale-kit/src/kits/locale/LocaleRoster.cpp
===================================================================
--- haiku/branches/components/gsoc-locale-kit/src/kits/locale/LocaleRoster.cpp	2009-07-13 00:19:26 UTC (rev 31534)
+++ haiku/branches/components/gsoc-locale-kit/src/kits/locale/LocaleRoster.cpp	2009-07-13 11:07:06 UTC (rev 31535)
@@ -142,7 +142,7 @@
 	BLocker fLock;
 	BList fCatalogAddOnInfos;
 	BMessage fPreferredLanguages;
-	//
+
 	RosterData();
 	~RosterData();
 	void InitializeCatalogAddOns();
@@ -159,17 +159,17 @@
 	BAutolock lock(fLock);
 	assert(lock.IsLocked());
 
-	// ToDo: make a decision about log-facility and -options
+	// TODO: make a decision about log-facility and -options
 	openlog_team(&quot;liblocale.so&quot;, LOG_PID, LOG_USER);
 #ifndef DEBUG
-	// ToDo: find out why the following bugger isn't working!
+	// TODO: find out why the following bugger isn't working!
 	setlogmask_team(LOG_UPTO(LOG_WARNING));
 #endif
 
 	InitializeCatalogAddOns();
 
-	// ToDo: change this to fetch preferred languages from prefs
-	fPreferredLanguages.AddString(&quot;language&quot;, &quot;german-swiss&quot;);
+	// TODO: change this to fetch preferred languages from prefs
+	fPreferredLanguages.AddString(&quot;language&quot;, &quot;french&quot;);
 	fPreferredLanguages.AddString(&quot;language&quot;, &quot;german&quot;);
 	fPreferredLanguages.AddString(&quot;language&quot;, &quot;english&quot;);
 }
@@ -253,8 +253,9 @@
 					priority = -1;
 					if (node.ReadAttr(kPriorityAttr, B_INT8_TYPE, 0,
 						&amp;priority, sizeof(int8)) &lt;= 0) {
-						// add-on has no priority-attribute yet, so we load it to
-						// fetch the priority from the corresponding symbol...
+						// add-on has no priority-attribute yet, so we load it 
+						// to fetch the priority from the corresponding
+						// symbol...
 						BString fullAddOnPath(addOnFolderName);
 						fullAddOnPath &lt;&lt; &quot;/&quot; &lt;&lt; dent-&gt;d_name;
 						image_id image = load_add_on(fullAddOnPath.String());

Modified: haiku/branches/components/gsoc-locale-kit/src/preferences/locale/Jamfile
===================================================================
--- haiku/branches/components/gsoc-locale-kit/src/preferences/locale/Jamfile	2009-07-13 00:19:26 UTC (rev 31534)
+++ haiku/branches/components/gsoc-locale-kit/src/preferences/locale/Jamfile	2009-07-13 11:07:06 UTC (rev 31535)
@@ -7,10 +7,12 @@
 	: Locale.rdef 
 	;
 
-ExtractCatalogEntries LocalePreflet.catkeys : 
-	Locale.cpp 
-	: Haiku_Preflets_Locale ;
-
-LinkApplicationCatalog english.catalog : 
-	LocalePreflet.catkeys 
-	: Haiku_Preflets_Locale ;
+DoCatalogs Locale			# application name
+	: x-vnd.Haiku-Locale	# app signature
+	:						# sources to extract the keys from
+	Locale.cpp
+	LocaleWindow.cpp
+	: english.catalog		# default catalog generated from catkeys
+	:						# translations
+	[ FDirName $(HAIKU_TOP) src preferences locale french.catkeys ]
+	;

Modified: haiku/branches/components/gsoc-locale-kit/src/preferences/locale/LocaleWindow.cpp
===================================================================
--- haiku/branches/components/gsoc-locale-kit/src/preferences/locale/LocaleWindow.cpp	2009-07-13 00:19:26 UTC (rev 31534)
+++ haiku/branches/components/gsoc-locale-kit/src/preferences/locale/LocaleWindow.cpp	2009-07-13 11:07:06 UTC (rev 31535)
@@ -9,14 +9,19 @@
 
 #include &lt;Application.h&gt;
 #include &lt;Button.h&gt;
+#include &lt;Catalog.h&gt;
 #include &lt;GroupLayout.h&gt;
 #include &lt;GroupLayoutBuilder.h&gt;
 #include &lt;ListView.h&gt;
+#include &lt;Locale.h&gt;
 #include &lt;Screen.h&gt;
 #include &lt;ScrollView.h&gt;
 #include &lt;TabView.h&gt;
 
 
+#define TR_CONTEXT &quot;Locale Preflet Window&quot;
+
+
 const static uint32 kMsgSelectLanguage = 'slng';
 const static uint32 kMsgDefaults = 'dflt';
 const static uint32 kMsgRevert = 'revt';
@@ -28,9 +33,9 @@
 {
 	// Buttons at the bottom
 
-	BButton *button = new BButton(&quot;Defaults&quot;, new BMessage(kMsgDefaults));
+	BButton *button = new BButton(TR(&quot;Defaults&quot;), new BMessage(kMsgDefaults));
 
-	fRevertButton = new BButton(&quot;Revert&quot;, new BMessage(kMsgRevert));
+	fRevertButton = new BButton(TR(&quot;Revert&quot;), new BMessage(kMsgRevert));
 	fRevertButton-&gt;SetEnabled(false);
 
 	// Tabs
@@ -38,13 +43,14 @@
 
 	// Language tab
 
-	BView *tab = new BView(&quot;Language&quot;, B_WILL_DRAW);
+	BView *tab = new BView(TR(&quot;Language&quot;), B_WILL_DRAW);
 	tab-&gt;SetViewColor(tabView-&gt;ViewColor());
 	tab-&gt;SetLayout(new BGroupLayout(B_VERTICAL, 10));
 	tabView-&gt;AddTab(tab);
 
 	{
-		BListView *listView = new BListView(&quot;preferred&quot;, B_SINGLE_SELECTION_LIST);
+		BListView *listView = new BListView(&quot;preferred&quot;,
+			B_SINGLE_SELECTION_LIST);
 		listView-&gt;SetSelectionMessage(new BMessage(kMsgSelectLanguage));
 
 		BScrollView *scrollView = new BScrollView(&quot;scroller&quot;, listView, 
@@ -57,13 +63,13 @@
 
 	// Country tab
 
-	tab = new BView(&quot;Country&quot;, B_WILL_DRAW);
+	tab = new BView(TR(&quot;Country&quot;), B_WILL_DRAW);
 	tab-&gt;SetViewColor(tabView-&gt;ViewColor());
 	tabView-&gt;AddTab(tab);
 
 	// Keyboard tab
 
-	tab = new BView(&quot;Keyboard&quot;, B_WILL_DRAW);
+	tab = new BView(TR(&quot;Keyboard&quot;), B_WILL_DRAW);
 	tab-&gt;SetViewColor(tabView-&gt;ViewColor());
 	tabView-&gt;AddTab(tab);
 

Added: haiku/branches/components/gsoc-locale-kit/src/preferences/locale/french.catkeys
===================================================================
--- haiku/branches/components/gsoc-locale-kit/src/preferences/locale/french.catkeys	2009-07-13 00:19:26 UTC (rev 31534)
+++ haiku/branches/components/gsoc-locale-kit/src/preferences/locale/french.catkeys	2009-07-13 11:07:06 UTC (rev 31535)
@@ -0,0 +1,7 @@
+1	french	x-vnd.Haiku-Locale	101974625
+Locale\n\twritten by Axel D&#246;rfler\n\tCopyright 2005, Haiku.\n\n	Locale Preflet		2612084183	Locale\n\t&#233;crit par Axel D&#246;rfler\n\tCopyright 2009, Haiku.\n\n
+Keyboard	Locale Preflet Window		439013050	Clavier
+Defaults	Locale Preflet Window		3903918745	D&#233;fauts
+Revert	Locale Preflet Window		3820004861	D&#233;faire
+Country	Locale Preflet Window		573711869	Pays
+Language	Locale Preflet Window		1031611593	Langage

Modified: haiku/branches/components/gsoc-locale-kit/src/tools/locale/PlainTextCatalog.cpp
===================================================================
--- haiku/branches/components/gsoc-locale-kit/src/tools/locale/PlainTextCatalog.cpp	2009-07-13 00:19:26 UTC (rev 31534)
+++ haiku/branches/components/gsoc-locale-kit/src/tools/locale/PlainTextCatalog.cpp	2009-07-13 11:07:06 UTC (rev 31535)
@@ -69,17 +69,8 @@
 	:
 	BHashMapCatalog(signature, language, fingerprint)
 {
-	status_t status;
-
 	// Look for the catalog in the directory we are going to use
 	// This constructor is not used so lets disable that...
-	/*
-	BString catalogName = &quot;generated/locale/&quot; &lt;&lt; kCatFolder
-		&lt;&lt; &quot;/&quot; &lt;&lt; fSignature
-		&lt;&lt; &quot;/&quot; &lt;&lt; fLanguageName
-		&lt;&lt; kCatExtension;
-	status = ReadFromFile(catalogName.String());
-	*/
 
 	fInitCheck = B_NOT_SUPPORTED;
 	fprintf(stderr,
@@ -235,7 +226,7 @@
 		if (ss.fail()) {
     		//something happened
 			fprintf(stderr,
-				&quot;Unable to convert key %s (%d) for string %s (%s / %s) from &quot;
+				&quot;Unable to convert key %s (%u) for string %s (%s / %s) from &quot;
 				&quot;%s\n&quot;,
 				stringKey.c_str(), key, originalString.c_str(), context.c_str(),
 				comment.c_str(), path);
@@ -248,8 +239,6 @@
 		// happen, you know. (and CatKey::== will fail)
 		SetString(originalString.c_str(), translated.c_str(), context.c_str(),
 			comment.c_str()); 
-		fprintf(stderr, &quot;Added string %s (key %u) from file %s\n&quot;,
-			originalString.c_str(), key, path);
 	}
 
 	catalogFile.close();

Modified: haiku/branches/components/gsoc-locale-kit/src/tools/locale/collectcatkeys.cpp
===================================================================
--- haiku/branches/components/gsoc-locale-kit/src/tools/locale/collectcatkeys.cpp	2009-07-13 00:19:26 UTC (rev 31534)
+++ haiku/branches/components/gsoc-locale-kit/src/tools/locale/collectcatkeys.cpp	2009-07-13 11:07:06 UTC (rev 31535)
@@ -68,50 +68,68 @@
 		in++;
 	}
 	if (*in == '&quot;') {
+		bool inString = true;
+		bool quoted = false;
 		in++;
-		bool quoted = false;
-		while (*in != '&quot;' || quoted) {
-			if (quoted) {
-				if (*in == 'n')
-					str.Append(&quot;\n&quot;,1);
-				else if (*in == 't')
-					str.Append(&quot;\t&quot;,1);
-				else if (*in == '&quot;')
-					str.Append(&quot;\&quot;&quot;,1);
+		while (parLevel &gt;= 0 &amp;&amp; inString)
+		{
+			// Collect string content until we find a quote marking end of
+			// string (skip escaped quotes)
+			while (*in != '&quot;' || quoted)
+			{
+				str.Append(in,1);
+				if (*in == '\\' &amp;&amp; !quoted)
+					quoted = true ;
 				else
-					// dump quote from unknown quoting-sequence:
-					str.Append(in,1);
-				quoted = false;
-			} else {
-				quoted = (*in == '\\');
-				if (!quoted)
-					str.Append(in,1);
+					quoted = false ;
+				in++;
 			}
 			in++;
+
+			inString = false;
+
+			// Strip all whitespace until we find a closing parenthesis, or the
+			// beginning of another string
+			// TODO: ignore comments
+			while (isspace(*in) || *in == ')') {
+				if (*in == ')') {
+					if (parLevel == 0)
+						return true;
+					parLevel--;
+				}
+
+				in++;
+			}
+
+			if (*in == '&quot;') {
+				inString = true;
+				in++;
+			}
 		}
-		in++;
-	} else if (!memcmp(in, &quot;__null&quot;, 6)) {
-		// NULL is preprocessed into __null, which we parse as &quot;&quot;
-		in += 6;
-	} else if (lookForID &amp;&amp; (isdigit(*in) || *in == '-' || *in == '+')) {
-		// try to parse an ID (a long):
-		errno = 0;
-		char *next;
-		id = strtol(in, &amp;next, 10);
-		if (id != 0 || errno == 0) {
-			haveID = true;
-			in = next;
-		}
-	} else
-		return false;
+	} else {
+		if (!memcmp(in, &quot;__null&quot;, 6)) {
+			// NULL is preprocessed into __null, which we parse as &quot;&quot;
+			in += 6;
+		} else if (lookForID &amp;&amp; (isdigit(*in) || *in == '-' || *in == '+')) {
+			// try to parse an ID (a long):
+			errno = 0;
+			char *next;
+			id = strtol(in, &amp;next, 10);
+			if (id != 0 || errno == 0) {
+				haveID = true;
+				in = next;
+			}
+		} else
+			return false;
 
-	while (isspace(*in) || *in == ')') {
-		if (*in == ')') {
-			if (!parLevel)
-				return true;
-			parLevel--;
+		while (isspace(*in) || *in == ')') {
+			if (*in == ')') {
+				if (!parLevel)
+					return true;
+				parLevel--;
+			}
+			in++;
 		}
-		in++;
 	}
 	return true;
 }
@@ -123,18 +141,25 @@
 	str = ctx = cmt = &quot;&quot;;
 	haveID = false;
 	// fetch native string or id:
-	if (!fetchStr(in, str, true))
+	if (!fetchStr(in, str, true)) {
+		fprintf(stderr,&quot;String parsing error\n&quot;);
 		return false;
+	}
 	if (*in == ',') {
 		in++;
 		// fetch context:
-		if (!fetchStr(in, ctx, false))
+		if (!fetchStr(in, ctx, false)) {
+			fprintf(stderr,&quot;Context parsing error\n&quot;);
 			return false;
+		}
 		if (*in == ',') {
 			in++;
 			// fetch comment:
 			if (!fetchStr(in, cmt, false))
+			{
+				fprintf(stderr,&quot;Comment parsing error\n&quot;);
 				return false;
+			}
 		}
 	}
 	return true;

Modified: haiku/branches/components/gsoc-locale-kit/src/tools/locale/linkcatkeys.cpp
===================================================================
--- haiku/branches/components/gsoc-locale-kit/src/tools/locale/linkcatkeys.cpp	2009-07-13 00:19:26 UTC (rev 31534)
+++ haiku/branches/components/gsoc-locale-kit/src/tools/locale/linkcatkeys.cpp	2009-07-13 11:07:06 UTC (rev 31535)
@@ -37,6 +37,45 @@
 }
 
 
+void
+parseQuotedChars(BString&amp; stringToParse)
+{
+	char* in = stringToParse.LockBuffer(0);
+	char* out = in;
+	int newLength = 0;
+	bool quoted = false;
+
+	while (*in != 0 || quoted) {
+		if (quoted) {
+			if (*in == 'n')
+				*out = '\n';
+			else if (*in == 't')
+				*out = '\t';
+			else if (*in == '&quot;')
+				*out = '&quot;';
+			else {
+				// dump quote from unknown quoting-sequence:
+				*out = *in ;
+			}
+			quoted = false;
+			out++;
+			newLength++;
+		} else {
+			quoted = (*in == '\\');
+			if (!quoted) {
+				*out = *in;
+				out++;
+				newLength++;
+			}
+		}
+		in++;
+	}
+	*out = '\0';
+
+	stringToParse.UnlockBuffer(newLength);
+}
+
+
 int
 main(int argc, char **argv)
 {
@@ -104,13 +143,25 @@
 
 		// now walk over all entries in input-catalog and add them to
 		// target catalog, unless they already exist there.
-		// (This could be improved by simply inserting the hashmaps,
-		// but this should be fast enough).
 		BHashMapCatalog::CatWalker walker(&amp;inputCatalog);
 		while (!walker.AtEnd()) {
-			const CatKey &amp;key(walker.GetKey());
-			if (!targetCatImpl.GetString(key))
-				targetCatImpl.SetString(key, walker.GetValue());
+			const CatKey &amp;plainTextKey(walker.GetKey());
+			BString keyString, keyComment, keyContext;
+			plainTextKey.GetStringParts(&amp;keyString,&amp;keyComment,&amp;keyContext);
+			parseQuotedChars(keyString);
+			const CatKey fixedCatKey(keyString.String(), keyComment.String(),
+					keyContext.String());
+
+			// We need to parse \n, \t and \&quot; now.
+			// They are kept in readable form in the plaintext catkeys, but we
+			// need the raw ascii to match the strings in the compiled program.
+			BString translatedString = walker.GetValue();
+			parseQuotedChars(translatedString);
+
+			if (!targetCatImpl.GetString(fixedCatKey)) {
+				targetCatImpl.SetString(fixedCatKey,
+					translatedString.String());
+			}
 			walker.Next();
 		}
 	}


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="017932.html">[Haiku-commits] r31534 -	haiku/trunk/src/apps/debugger/gui/team_window
</A></li>
	<LI>Next message: <A HREF="017938.html">[Haiku-commits] r31536 - in haiku/branches/components/gsoc-locale-kit: . 3rdparty/vmware build/jam build/scripts data/artwork/icons data/common/boot/post_install data/system/boot docs docs/userguide/en docs/userguide/en/applications docs/userguide/en/installation docs/userguide/en/preferences docs/userguide/images docs/userguide/images/apps-images docs/userguide/images/deskbar-images docs/userguide/images/prefs-images docs/userguide/images/queries-images docs/welcome docs/welcome/en headers/cpp headers/glibc headers/libs headers/libs/png headers/libs/print/libprint headers/os headers/os/app headers/os/bluetooth headers/os/bluetooth/HCI headers/os/drivers headers/os/interface headers/os/kernel headers/os/opengl headers/os/storage headers/os/support headers/posix headers/private/app headers/private/bluetooth headers/private/debug headers/private/device headers/private/fs_shell headers/private/graphics/nvidia headers/private/interface headers/private/kernel headers/private/kernel/arch! headers/private/kernel/arch/x86 headers/private/kernel/disk_device_manager headers/private/kernel/fs headers/private/kernel/util headers/private/libroot headers/private/media headers/private/net headers/private/shared headers/private/system headers/private/system/arch/x86 src/add-ons/accelerants/intel_extreme src/add-ons/accelerants/nvidia src/add-ons/accelerants/nvidia/engine src/add-ons/disk_systems/bfs src/add-ons/disk_systems/intel src/add-ons/input_server/devices/keyboard src/add-ons/input_server/devices/mouse src/add-ons/input_server/devices/wacom src/add-ons/input_server/filters/screen_saver src/add-ons/input_server/methods/canna src/add-ons/kernel/bus_managers/acpi src/add-ons/kernel/bus_managers/pci src/add-ons/kernel/busses/scsi/ahci src/add-ons/kernel/cpu/x86 src/add-ons/kernel/debugger/demangle src/add-ons/kernel/debugger/disasm src/add-ons/kernel/debugger/disasm/x86 src/add-ons/kernel/drivers/bluetooth/h2/h2generic src/add-ons/kernel/drivers/graphics/nvidia sr! c/add-ons/kernel/drivers/midi/usb_midi src/add-ons/kernel/driv! ers/netw
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#17937">[ date ]</a>
              <a href="thread.html#17937">[ thread ]</a>
              <a href="subject.html#17937">[ subject ]</a>
              <a href="author.html#17937">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/haiku-commits">More information about the Haiku-commits
mailing list</a><br>
</body></html>
