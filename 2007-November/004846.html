<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Haiku-commits] r22992 - in	haiku/trunk/src/add-ons/kernel/drivers/network: .	marvell_yukon marvell_yukon/dev marvell_yukon/dev/mii	marvell_yukon/dev/msk
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/haiku-commits/2007-November/index.html" >
   <LINK REL="made" HREF="mailto:haiku-commits%40lists.berlios.de?Subject=Re%3A%20%5BHaiku-commits%5D%20r22992%20-%20in%0A%09haiku/trunk/src/add-ons/kernel/drivers/network%3A%20.%0A%09marvell_yukon%20marvell_yukon/dev%20marvell_yukon/dev/mii%0A%09marvell_yukon/dev/msk&In-Reply-To=%3C200711251132.lAPBW3Fp008641%40sheep.berlios.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="004845.html">
   <LINK REL="Next"  HREF="004847.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Haiku-commits] r22992 - in	haiku/trunk/src/add-ons/kernel/drivers/network: .	marvell_yukon marvell_yukon/dev marvell_yukon/dev/mii	marvell_yukon/dev/msk</H1>
    <B>axeld at BerliOS</B> 
    <A HREF="mailto:haiku-commits%40lists.berlios.de?Subject=Re%3A%20%5BHaiku-commits%5D%20r22992%20-%20in%0A%09haiku/trunk/src/add-ons/kernel/drivers/network%3A%20.%0A%09marvell_yukon%20marvell_yukon/dev%20marvell_yukon/dev/mii%0A%09marvell_yukon/dev/msk&In-Reply-To=%3C200711251132.lAPBW3Fp008641%40sheep.berlios.de%3E"
       TITLE="[Haiku-commits] r22992 - in	haiku/trunk/src/add-ons/kernel/drivers/network: .	marvell_yukon marvell_yukon/dev marvell_yukon/dev/mii	marvell_yukon/dev/msk">axeld at mail.berlios.de
       </A><BR>
    <I>Sun Nov 25 12:32:03 CET 2007</I>
    <P><UL>
        <LI>Previous message: <A HREF="004845.html">[Haiku-commits] r22991 - in haiku/trunk/src:	add-ons/kernel/drivers/network/3com/pci	add-ons/kernel/drivers/network/ipro1000/dev/em	add-ons/kernel/drivers/network/rtl8139/pci	add-ons/kernel/drivers/network/via_rhine/pci	libs/compat/freebsd_network	libs/compat/freebsd_network/compat/dev/pci	libs/compat/freebsd_network/compat/machine	libs/compat/freebsd_network/compat/net	libs/compat/freebsd_network/compat/netinet	libs/compat/freebsd_network/compat/sys	libs/compat/freebsd_network/compat/vm
</A></li>
        <LI>Next message: <A HREF="004847.html">[Haiku-commits] r22993 - in	haiku/trunk/src/libs/compat/freebsd_network: . compat/net
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4846">[ date ]</a>
              <a href="thread.html#4846">[ thread ]</a>
              <a href="subject.html#4846">[ subject ]</a>
              <a href="author.html#4846">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: axeld
Date: 2007-11-25 12:31:51 +0100 (Sun, 25 Nov 2007)
New Revision: 22992
ViewCVS: <A HREF="http://svn.berlios.de/viewcvs/haiku?rev=22992&amp;view=rev">http://svn.berlios.de/viewcvs/haiku?rev=22992&amp;view=rev</A>

Added:
   haiku/trunk/src/add-ons/kernel/drivers/network/marvell_yukon/
   haiku/trunk/src/add-ons/kernel/drivers/network/marvell_yukon/Jamfile
   haiku/trunk/src/add-ons/kernel/drivers/network/marvell_yukon/dev/
   haiku/trunk/src/add-ons/kernel/drivers/network/marvell_yukon/dev/Jamfile
   haiku/trunk/src/add-ons/kernel/drivers/network/marvell_yukon/dev/mii/
   haiku/trunk/src/add-ons/kernel/drivers/network/marvell_yukon/dev/mii/brgphyreg.h
   haiku/trunk/src/add-ons/kernel/drivers/network/marvell_yukon/dev/msk/
   haiku/trunk/src/add-ons/kernel/drivers/network/marvell_yukon/dev/msk/Jamfile
   haiku/trunk/src/add-ons/kernel/drivers/network/marvell_yukon/dev/msk/glue.c
   haiku/trunk/src/add-ons/kernel/drivers/network/marvell_yukon/dev/msk/if_msk.c
   haiku/trunk/src/add-ons/kernel/drivers/network/marvell_yukon/dev/msk/if_mskreg.h
Modified:
   haiku/trunk/src/add-ons/kernel/drivers/network/Jamfile
Log:
Added FreeBSD 7 driver for the Marvell Yukon chips. Compiles, but is otherwise
completely untested yet.


Modified: haiku/trunk/src/add-ons/kernel/drivers/network/Jamfile
===================================================================
--- haiku/trunk/src/add-ons/kernel/drivers/network/Jamfile	2007-11-25 11:29:29 UTC (rev 22991)
+++ haiku/trunk/src/add-ons/kernel/drivers/network/Jamfile	2007-11-25 11:31:51 UTC (rev 22992)
@@ -15,6 +15,7 @@
 # FreeBSD 6.2 drivers
 SubInclude HAIKU_TOP src add-ons kernel drivers network 3com ;
 SubInclude HAIKU_TOP src add-ons kernel drivers network ipro100 ;
+SubInclude HAIKU_TOP src add-ons kernel drivers network marvell_yukon ;
 SubInclude HAIKU_TOP src add-ons kernel drivers network pcnet ;
 
 SubIncludeGPL HAIKU_TOP src add-ons kernel drivers network bcm440x ;

Added: haiku/trunk/src/add-ons/kernel/drivers/network/marvell_yukon/Jamfile
===================================================================
--- haiku/trunk/src/add-ons/kernel/drivers/network/marvell_yukon/Jamfile	2007-11-25 11:29:29 UTC (rev 22991)
+++ haiku/trunk/src/add-ons/kernel/drivers/network/marvell_yukon/Jamfile	2007-11-25 11:31:51 UTC (rev 22992)
@@ -0,0 +1,3 @@
+SubDir HAIKU_TOP src add-ons kernel drivers network marvell_yukon ;
+
+SubInclude HAIKU_TOP src add-ons kernel drivers network marvell_yukon dev ;

Added: haiku/trunk/src/add-ons/kernel/drivers/network/marvell_yukon/dev/Jamfile
===================================================================
--- haiku/trunk/src/add-ons/kernel/drivers/network/marvell_yukon/dev/Jamfile	2007-11-25 11:29:29 UTC (rev 22991)
+++ haiku/trunk/src/add-ons/kernel/drivers/network/marvell_yukon/dev/Jamfile	2007-11-25 11:31:51 UTC (rev 22992)
@@ -0,0 +1,4 @@
+SubDir HAIKU_TOP src add-ons kernel drivers network marvell_yukon dev ;
+
+#SubInclude HAIKU_TOP src add-ons kernel drivers network marvell_yukon dev mii ;
+SubInclude HAIKU_TOP src add-ons kernel drivers network marvell_yukon dev msk ;

Added: haiku/trunk/src/add-ons/kernel/drivers/network/marvell_yukon/dev/mii/brgphyreg.h
===================================================================
--- haiku/trunk/src/add-ons/kernel/drivers/network/marvell_yukon/dev/mii/brgphyreg.h	2007-11-25 11:29:29 UTC (rev 22991)
+++ haiku/trunk/src/add-ons/kernel/drivers/network/marvell_yukon/dev/mii/brgphyreg.h	2007-11-25 11:31:51 UTC (rev 22992)
@@ -0,0 +1,364 @@
+/*-
+ * Copyright (c) 2000
+ *	Bill Paul &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/haiku-commits">wpaul at ee.columbia.edu</A>&gt;.  All rights reserved.
+ *
+ * Redistribution and use in source and binary forms, with or without
+ * modification, are permitted provided that the following conditions
+ * are met:
+ * 1. Redistributions of source code must retain the above copyright
+ *    notice, this list of conditions and the following disclaimer.
+ * 2. Redistributions in binary form must reproduce the above copyright
+ *    notice, this list of conditions and the following disclaimer in the
+ *    documentation and/or other materials provided with the distribution.
+ * 3. All advertising materials mentioning features or use of this software
+ *    must display the following acknowledgement:
+ *	This product includes software developed by Bill Paul.
+ * 4. Neither the name of the author nor the names of any co-contributors
+ *    may be used to endorse or promote products derived from this software
+ *    without specific prior written permission.
+ *
+ * THIS SOFTWARE IS PROVIDED BY Bill Paul AND CONTRIBUTORS ``AS IS'' AND
+ * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
+ * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE
+ * ARE DISCLAIMED.  IN NO EVENT SHALL Bill Paul OR THE VOICES IN HIS HEAD
+ * BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR
+ * CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF
+ * SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS
+ * INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN
+ * CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)
+ * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF
+ * THE POSSIBILITY OF SUCH DAMAGE.
+ *
+ * $FreeBSD: src/sys/dev/mii/brgphyreg.h,v 1.6.2.2 2007/06/14 21:07:19 davidch Exp $
+ */
+
+#ifndef _DEV_MII_BRGPHYREG_H_
+#define	_DEV_MII_BRGPHYREG_H_
+
+/*
+ * Broadcom BCM5400 registers
+ */
+
+#define	BRGPHY_MII_BMCR	    	0x00
+#define	BRGPHY_BMCR_RESET		0x8000
+#define	BRGPHY_BMCR_LOOP		0x4000
+#define	BRGPHY_BMCR_SPD0		0x2000	/* Speed select, lower bit */
+#define	BRGPHY_BMCR_AUTOEN		0x1000	/* Autoneg enabled */
+#define	BRGPHY_BMCR_PDOWN		0x0800	/* Power down */
+#define	BRGPHY_BMCR_ISO			0x0400	/* Isolate */
+#define	BRGPHY_BMCR_STARTNEG	0x0200	/* Restart autoneg */
+#define	BRGPHY_BMCR_FDX			0x0100	/* Duplex mode */
+#define	BRGPHY_BMCR_CTEST		0x0080	/* Collision test enable */
+#define	BRGPHY_BMCR_SPD1		0x0040	/* Speed select, upper bit */
+
+#define	BRGPHY_S1000			BRGPHY_BMCR_SPD1	/* 1000mbps */
+#define	BRGPHY_S100				BRGPHY_BMCR_SPD0	/* 100mpbs */
+#define	BRGPHY_S10				0					/* 10mbps */
+
+#define	BRGPHY_MII_BMSR		0x01
+#define	BRGPHY_BMSR_EXTSTS	0x0100	/* Extended status present */
+#define	BRGPHY_BMSR_PRESUB	0x0040	/* Preamble surpression */
+#define	BRGPHY_BMSR_ACOMP	0x0020	/* Autoneg complete */
+#define	BRGPHY_BMSR_RFAULT	0x0010	/* Remote fault condition occured */
+#define	BRGPHY_BMSR_ANEG	0x0008	/* Autoneg capable */
+#define	BRGPHY_BMSR_LINK	0x0004	/* Link status */
+#define	BRGPHY_BMSR_JABBER	0x0002	/* Jabber detected */
+#define	BRGPHY_BMSR_EXT		0x0001	/* Extended capability */
+
+#define	BRGPHY_MII_ANAR		0x04
+#define	BRGPHY_ANAR_NP		0x8000	/* Next page */
+#define	BRGPHY_ANAR_RF		0x2000	/* Remote fault */
+#define	BRGPHY_ANAR_ASP		0x0800	/* Asymmetric Pause */
+#define	BRGPHY_ANAR_PC		0x0400	/* Pause capable */
+#define	BRGPHY_ANAR_SEL		0x001F	/* Selector field, 00001=Ethernet */
+
+#define	BRGPHY_MII_ANLPAR	0x05
+#define	BRGPHY_ANLPAR_NP	0x8000	/* Next page */
+#define	BRGPHY_ANLPAR_RF	0x2000	/* Remote fault */
+#define	BRGPHY_ANLPAR_ASP	0x0800	/* Asymmetric Pause */
+#define	BRGPHY_ANLPAR_PC	0x0400	/* Pause capable */
+#define	BRGPHY_ANLPAR_SEL	0x001F	/* Selector field, 00001=Ethernet */
+
+#define	BRGPHY_SEL_TYPE		0x0001	/* Ethernet */
+
+#define	BRGPHY_MII_ANER		0x06
+#define	BRGPHY_ANER_PDF		0x0010	/* Parallel detection fault */
+#define	BRGPHY_ANER_LPNP	0x0008	/* Link partner can next page */
+#define	BRGPHY_ANER_NP		0x0004	/* Local PHY can next page */
+#define	BRGPHY_ANER_RX		0x0002	/* Next page received */
+#define	BRGPHY_ANER_LPAN	0x0001 	/* Link partner autoneg capable */
+
+#define	BRGPHY_MII_NEXTP	0x07	/* Next page */
+
+#define	BRGPHY_MII_NEXTP_LP	0x08	/* Next page of link partner */
+
+#define	BRGPHY_MII_1000CTL	0x09	/* 1000baseT control */
+#define	BRGPHY_1000CTL_TST	0xE000	/* Test modes */
+#define	BRGPHY_1000CTL_MSE	0x1000	/* Master/Slave enable */
+#define	BRGPHY_1000CTL_MSC	0x0800	/* Master/Slave configuration */
+#define	BRGPHY_1000CTL_RD	0x0400	/* Repeater/DTE */
+#define	BRGPHY_1000CTL_AFD	0x0200	/* Advertise full duplex */
+#define	BRGPHY_1000CTL_AHD	0x0100	/* Advertise half duplex */
+
+#define	BRGPHY_MII_1000STS	0x0A	/* 1000baseT status */
+#define	BRGPHY_1000STS_MSF	0x8000	/* Master/slave fault */
+#define	BRGPHY_1000STS_MSR	0x4000	/* Master/slave result */
+#define	BRGPHY_1000STS_LRS	0x2000	/* Local receiver status */
+#define	BRGPHY_1000STS_RRS	0x1000	/* Remote receiver status */
+#define	BRGPHY_1000STS_LPFD	0x0800	/* Link partner can FD */
+#define	BRGPHY_1000STS_LPHD	0x0400	/* Link partner can HD */
+#define	BRGPHY_1000STS_IEC	0x00FF	/* Idle error count */
+
+#define	BRGPHY_MII_EXTSTS	0x0F	/* Extended status */
+#define	BRGPHY_EXTSTS_X_FD_CAP	0x8000	/* 1000base-X FD capable */
+#define	BRGPHY_EXTSTS_X_HD_CAP	0x4000	/* 1000base-X HD capable */
+#define	BRGPHY_EXTSTS_T_FD_CAP	0x2000	/* 1000base-T FD capable */
+#define	BRGPHY_EXTSTS_T_HD_CAP	0x1000	/* 1000base-T HD capable */
+
+#define	BRGPHY_MII_PHY_EXTCTL	0x10	/* PHY extended control */
+#define	BRGPHY_PHY_EXTCTL_MAC_PHY	0x8000	/* 10BIT/GMI-interface */
+#define	BRGPHY_PHY_EXTCTL_DIS_CROSS	0x4000	/* Disable MDI crossover */
+#define	BRGPHY_PHY_EXTCTL_TX_DIS	0x2000	/* TX output disabled */
+#define	BRGPHY_PHY_EXTCTL_INT_DIS	0x1000	/* Interrupts disabled */
+#define	BRGPHY_PHY_EXTCTL_F_INT		0x0800	/* Force interrupt */
+#define	BRGPHY_PHY_EXTCTL_BY_45		0x0400	/* Bypass 4B5B-Decoder */
+#define	BRGPHY_PHY_EXTCTL_BY_SCR	0x0200	/* Bypass scrambler */
+#define	BRGPHY_PHY_EXTCTL_BY_MLT3	0x0100	/* Bypass MLT3 encoder */
+#define	BRGPHY_PHY_EXTCTL_BY_RXA	0x0080	/* Bypass RX alignment */
+#define	BRGPHY_PHY_EXTCTL_RES_SCR	0x0040	/* Reset scrambler */
+#define	BRGPHY_PHY_EXTCTL_EN_LTR	0x0020	/* Enable LED traffic mode */
+#define	BRGPHY_PHY_EXTCTL_LED_ON	0x0010	/* Force LEDs on */
+#define	BRGPHY_PHY_EXTCTL_LED_OFF	0x0008	/* Force LEDs off */
+#define	BRGPHY_PHY_EXTCTL_EX_IPG	0x0004	/* Extended TX IPG mode */
+#define	BRGPHY_PHY_EXTCTL_3_LED		0x0002	/* Three link LED mode */
+#define	BRGPHY_PHY_EXTCTL_HIGH_LA	0x0001	/* GMII Fifo Elasticy (?) */
+
+#define	BRGPHY_MII_PHY_EXTSTS	0x11	/* PHY extended status */
+#define	BRGPHY_PHY_EXTSTS_CROSS_STAT	0x2000	/* MDI crossover status */
+#define	BRGPHY_PHY_EXTSTS_INT_STAT	0x1000	/* Interrupt status */
+#define	BRGPHY_PHY_EXTSTS_RRS		0x0800	/* Remote receiver status */
+#define	BRGPHY_PHY_EXTSTS_LRS		0x0400	/* Local receiver status */
+#define	BRGPHY_PHY_EXTSTS_LOCKED	0x0200	/* Locked */
+#define	BRGPHY_PHY_EXTSTS_LS		0x0100	/* Link status */
+#define	BRGPHY_PHY_EXTSTS_RF		0x0080	/* Remove fault */
+#define	BRGPHY_PHY_EXTSTS_CE_ER		0x0040	/* Carrier ext error */
+#define	BRGPHY_PHY_EXTSTS_BAD_SSD	0x0020	/* Bad SSD */
+#define	BRGPHY_PHY_EXTSTS_BAD_ESD	0x0010	/* Bad ESS */
+#define	BRGPHY_PHY_EXTSTS_RX_ER		0x0008	/* RX error */
+#define	BRGPHY_PHY_EXTSTS_TX_ER		0x0004	/* TX error */
+#define	BRGPHY_PHY_EXTSTS_LOCK_ER	0x0002	/* Lock error */
+#define	BRGPHY_PHY_EXTSTS_MLT3_ER	0x0001	/* MLT3 code error */
+
+#define	BRGPHY_MII_RXERRCNT	0x12	/* RX error counter */
+
+#define	BRGPHY_MII_FCERRCNT	0x13	/* False carrier sense counter */
+#define	BGRPHY_FCERRCNT		0x00FF	/* False carrier counter */
+
+#define	BRGPHY_MII_RXNOCNT	0x14	/* RX not OK counter */
+#define	BRGPHY_RXNOCNT_LOCAL	0xFF00	/* Local RX not OK counter */
+#define	BRGPHY_RXNOCNT_REMOTE	0x00FF	/* Local RX not OK counter */
+
+#define	BRGPHY_MII_DSP_RW_PORT	0x15	/* DSP coefficient r/w port */
+
+#define	BRGPHY_MII_DSP_ADDR_REG	0x17	/* DSP coefficient addr register */
+
+#define	BRGPHY_DSP_TAP_NUMBER_MASK		0x00
+#define	BRGPHY_DSP_AGC_A			0x00
+#define	BRGPHY_DSP_AGC_B			0x01
+#define	BRGPHY_DSP_MSE_PAIR_STATUS		0x02
+#define	BRGPHY_DSP_SOFT_DECISION		0x03
+#define	BRGPHY_DSP_PHASE_REG			0x04
+#define	BRGPHY_DSP_SKEW				0x05
+#define	BRGPHY_DSP_POWER_SAVER_UPPER_BOUND	0x06
+#define	BRGPHY_DSP_POWER_SAVER_LOWER_BOUND	0x07
+#define	BRGPHY_DSP_LAST_ECHO			0x08
+#define	BRGPHY_DSP_FREQUENCY			0x09
+#define	BRGPHY_DSP_PLL_BANDWIDTH		0x0A
+#define	BRGPHY_DSP_PLL_PHASE_OFFSET		0x0B
+
+#define	BRGPHYDSP_FILTER_DCOFFSET		0x0C00
+#define	BRGPHY_DSP_FILTER_FEXT3			0x0B00
+#define	BRGPHY_DSP_FILTER_FEXT2			0x0A00
+#define	BRGPHY_DSP_FILTER_FEXT1			0x0900
+#define	BRGPHY_DSP_FILTER_FEXT0			0x0800
+#define	BRGPHY_DSP_FILTER_NEXT3			0x0700
+#define	BRGPHY_DSP_FILTER_NEXT2			0x0600
+#define	BRGPHY_DSP_FILTER_NEXT1			0x0500
+#define	BRGPHY_DSP_FILTER_NEXT0			0x0400
+#define	BRGPHY_DSP_FILTER_ECHO			0x0300
+#define	BRGPHY_DSP_FILTER_DFE			0x0200
+#define	BRGPHY_DSP_FILTER_FFE			0x0100
+
+#define	BRGPHY_DSP_CONTROL_ALL_FILTERS		0x1000
+
+#define	BRGPHY_DSP_SEL_CH_0			0x0000
+#define	BRGPHY_DSP_SEL_CH_1			0x2000
+#define	BRGPHY_DSP_SEL_CH_2			0x4000
+#define	BRGPHY_DSP_SEL_CH_3			0x6000
+
+#define	BRGPHY_MII_AUXCTL	0x18	/* AUX control */
+#define	BRGPHY_AUXCTL_LOW_SQ	0x8000	/* Low squelch */
+#define	BRGPHY_AUXCTL_LONG_PKT	0x4000	/* RX long packets */
+#define	BRGPHY_AUXCTL_ER_CTL	0x3000	/* Edgerate control */
+#define	BRGPHY_AUXCTL_TX_TST	0x0400	/* TX test, always 1 */
+#define	BRGPHY_AUXCTL_DIS_PRF	0x0080	/* dis part resp filter */
+#define	BRGPHY_AUXCTL_DIAG_MODE	0x0004	/* Diagnostic mode */
+
+#define	BRGPHY_MII_AUXSTS	0x19	/* AUX status */
+#define	BRGPHY_AUXSTS_ACOMP	0x8000	/* Autoneg complete */
+#define	BRGPHY_AUXSTS_AN_ACK	0x4000	/* Autoneg complete ack */
+#define	BRGPHY_AUXSTS_AN_ACK_D	0x2000	/* Autoneg complete ack detect */
+#define	BRGPHY_AUXSTS_AN_NPW	0x1000	/* Autoneg next page wait */
+#define	BRGPHY_AUXSTS_AN_RES	0x0700	/* Autoneg HCD */
+#define	BRGPHY_AUXSTS_PDF	0x0080	/* Parallel detect. fault */
+#define	BRGPHY_AUXSTS_RF	0x0040	/* Remote fault */
+#define	BRGPHY_AUXSTS_ANP_R	0x0020	/* Autoneg page received */
+#define	BRGPHY_AUXSTS_LP_ANAB	0x0010	/* Link partner autoneg ability */
+#define	BRGPHY_AUXSTS_LP_NPAB	0x0008	/* Link partner next page ability */
+#define	BRGPHY_AUXSTS_LINK	0x0004	/* Link status */
+#define	BRGPHY_AUXSTS_PRR	0x0002	/* Pause resolution-RX */
+#define	BRGPHY_AUXSTS_PRT	0x0001	/* Pause resolution-TX */
+
+#define	BRGPHY_RES_1000FD	0x0700	/* 1000baseT full duplex */
+#define	BRGPHY_RES_1000HD	0x0600	/* 1000baseT half duplex */
+#define	BRGPHY_RES_100FD	0x0500	/* 100baseT full duplex */
+#define	BRGPHY_RES_100T4	0x0400	/* 100baseT4 */
+#define	BRGPHY_RES_100HD	0x0300	/* 100baseT half duplex */
+#define	BRGPHY_RES_10FD		0x0200	/* 10baseT full duplex */
+#define	BRGPHY_RES_10HD		0x0100	/* 10baseT half duplex */
+
+#define	BRGPHY_MII_ISR		0x1A	/* Interrupt status */
+#define	BRGPHY_ISR_PSERR	0x4000	/* Pair swap error */
+#define	BRGPHY_ISR_MDXI_SC	0x2000	/* MDIX Status Change */
+#define	BRGPHY_ISR_HCT		0x1000	/* Counter above 32K */
+#define	BRGPHY_ISR_LCT		0x0800	/* All counter below 128 */
+#define	BRGPHY_ISR_AN_PR	0x0400	/* Autoneg page received */
+#define	BRGPHY_ISR_NO_HDCL	0x0200	/* No HCD Link */
+#define	BRGPHY_ISR_NO_HDC	0x0100	/* No HCD */
+#define	BRGPHY_ISR_USHDC	0x0080	/* Negotiated Unsupported HCD */
+#define	BRGPHY_ISR_SCR_S_ERR	0x0040	/* Scrambler sync error */
+#define	BRGPHY_ISR_RRS_CHG	0x0020	/* Remote RX status change */
+#define	BRGPHY_ISR_LRS_CHG	0x0010	/* Local RX status change */
+#define	BRGPHY_ISR_DUP_CHG	0x0008	/* Duplex mode change */
+#define	BRGPHY_ISR_LSP_CHG	0x0004	/* Link speed changed */
+#define	BRGPHY_ISR_LNK_CHG	0x0002	/* Link status change */
+#define	BRGPHY_ISR_CRCERR	0x0001	/* CRC error */
+
+#define	BRGPHY_MII_IMR		0x1B	/* Interrupt mask */
+#define	BRGPHY_IMR_PSERR	0x4000	/* Pair swap error */
+#define	BRGPHY_IMR_MDXI_SC	0x2000	/* MDIX Status Change */
+#define	BRGPHY_IMR_HCT		0x1000	/* Counter above 32K */
+#define	BRGPHY_IMR_LCT		0x0800	/* All counter below 128 */
+#define	BRGPHY_IMR_AN_PR	0x0400	/* Autoneg page received */
+#define	BRGPHY_IMR_NO_HDCL	0x0200	/* No HCD Link */
+#define	BRGPHY_IMR_NO_HDC	0x0100	/* No HCD */
+#define	BRGPHY_IMR_USHDC	0x0080	/* Negotiated Unsupported HCD */
+#define	BRGPHY_IMR_SCR_S_ERR	0x0040	/* Scrambler sync error */
+#define	BRGPHY_IMR_RRS_CHG	0x0020	/* Remote RX status change */
+#define	BRGPHY_IMR_LRS_CHG	0x0010	/* Local RX status change */
+#define	BRGPHY_IMR_DUP_CHG	0x0008	/* Duplex mode change */
+#define	BRGPHY_IMR_LSP_CHG	0x0004	/* Link speed changed */
+#define	BRGPHY_IMR_LNK_CHG	0x0002	/* Link status change */
+#define	BRGPHY_IMR_CRCERR	0x0001	/* CRC error */
+
+/*******************************************************/
+/* Begin: Shared SerDes PHY register definitions       */
+/*******************************************************/
+
+/* SerDes autoneg is different from copper */
+#define BRGPHY_SERDES_ANAR				0x04
+#define BRGPHY_SERDES_ANAR_FDX			0x0020
+#define BRGPHY_SERDES_ANAR_HDX			0x0040
+#define BRGPHY_SERDES_ANAR_NO_PAUSE		(0x0 &lt;&lt; 7)
+#define BRGPHY_SERDES_ANAR_SYM_PAUSE	(0x1 &lt;&lt; 7)
+#define BRGPHY_SERDES_ANAR_ASYM_PAUSE	(0x2 &lt;&lt; 7)
+#define BRGPHY_SERDES_ANAR_BOTH_PAUSE	(0x3 &lt;&lt; 7)
+
+#define BRGPHY_SERDES_ANLPAR			0x05
+#define BRGPHY_SERDES_ANLPAR_FDX		0x0020
+#define BRGPHY_SERDES_ANLPAR_HDX		0x0040
+#define BRGPHY_SERDES_ANLPAR_NO_PAUSE	(0x0 &lt;&lt; 7)
+#define BRGPHY_SERDES_ANLPAR_SYM_PAUSE	(0x1 &lt;&lt; 7)
+#define BRGPHY_SERDES_ANLPAR_ASYM_PAUSE	(0x2 &lt;&lt; 7)
+#define BRGPHY_SERDES_ANLPAR_BOTH_PAUSE	(0x3 &lt;&lt; 7)
+
+/*******************************************************/
+/* End: Shared SerDes PHY register definitions         */
+/*******************************************************/
+
+/*******************************************************/
+/* Begin: PHY register values for the 5706 PHY         */
+/*******************************************************/
+
+/* 
+ * Shadow register 0x1C, bit 15 is write enable,
+ * bits 14-10 select function (0x00 to 0x1F).
+ */
+#define BRGPHY_MII_SHADOW_1C			0x1C
+#define BRGPHY_SHADOW_1C_WRITE_EN		0x8000
+#define BRGPHY_SHADOW_1C_SELECT_MASK	0x7C00
+
+/* Shadow 0x1C Mode Control Register (select value 0x1F) */
+#define BRGPHY_SHADOW_1C_MODE_CTRL		(0x1F &lt;&lt; 10)
+/* When set, Regs 0-0x0F are 1000X, else 1000T */
+#define BRGPHY_SHADOW_1C_ENA_1000X		0x0001	
+
+#define	BRGPHY_MII_TEST1	0x1E
+#define	BRGPHY_TEST1_TRIM_EN	0x0010
+#define	BRGPHY_TEST1_CRC_EN	0x8000
+
+#define BRGPHY_MII_TEST2		0x1F
+
+/*******************************************************/
+/* End: PHY register values for the 5706 PHY           */
+/*******************************************************/
+
+/*******************************************************/
+/* Begin: PHY register values for the 5708S SerDes PHY */
+/*******************************************************/
+
+/* Autoneg Next Page Transmit 1 Regiser */
+#define BRGPHY_5708S_ANEG_NXT_PG_XMIT1			0x0B
+#define BRGPHY_5708S_ANEG_NXT_PG_XMIT1_25G		0x0001
+
+/* Use the BLOCK_ADDR register to select the page for registers 0x10 to 0x1E */
+#define BRGPHY_5708S_BLOCK_ADDR					0x1f
+#define BRGPHY_5708S_DIG_PG0 					0x0000
+#define BRGPHY_5708S_DIG3_PG2					0x0002
+#define BRGPHY_5708S_TX_MISC_PG5				0x0005
+
+/* 5708S SerDes &quot;Digital&quot; Registers (page 0) */
+#define BRGPHY_5708S_PG0_1000X_CTL1				0x10
+#define BRGPHY_5708S_PG0_1000X_CTL1_AUTODET_EN	0x0010
+#define BRGPHY_5708S_PG0_1000X_CTL1_FIBER_MODE	0x0001
+
+#define BRGPHY_5708S_PG0_1000X_STAT1			0x14
+#define BRGPHY_5708S_PG0_1000X_STAT1_LINK		0x0002
+#define BRGPHY_5708S_PG0_1000X_STAT1_FDX		0x0004
+#define BRGPHY_5708S_PG0_1000X_STAT1_SPEED_MASK	0x0018
+#define BRGPHY_5708S_PG0_1000X_STAT1_SPEED_10	(0x0 &lt;&lt; 3)
+#define BRGPHY_5708S_PG0_1000X_STAT1_SPEED_100	(0x1 &lt;&lt; 3)
+#define BRGPHY_5708S_PG0_1000X_STAT1_SPEED_1G	(0x2 &lt;&lt; 3)
+#define BRGPHY_5708S_PG0_1000X_STAT1_SPEED_25G	(0x3 &lt;&lt; 3)
+
+
+#define BRGPHY_5708S_PG0_1000X_CTL2				0x11
+#define BRGPHY_5708S_PG0_1000X_CTL2_PAR_DET_EN	0x0001
+
+/* 5708S SerDes &quot;Digital 3&quot; Registers (page 2) */
+#define BRGPHY_5708S_PG2_DIGCTL_3_0				0x10
+#define BRGPHY_5708S_PG2_DIGCTL_3_0_USE_IEEE	0x0001
+
+/* 5708S SerDes &quot;TX Misc&quot; Registers (page 5) */
+#define BRGPHY_5708S_PG5_2500STATUS1			0x10
+#define BRGPHY_5708S_PG5_TXACTL1				0x15
+#define BRGPHY_5708S_PG5_TXACTL3				0x17
+
+/*******************************************************/
+/* End: PHY register values for the 5708S SerDes PHY   */
+/*******************************************************/
+
+#define	BRGPHY_INTRS	\
+	~(BRGPHY_IMR_LNK_CHG|BRGPHY_IMR_LSP_CHG|BRGPHY_IMR_DUP_CHG)
+
+#endif /* _DEV_BRGPHY_MIIREG_H_ */

Added: haiku/trunk/src/add-ons/kernel/drivers/network/marvell_yukon/dev/msk/Jamfile
===================================================================
--- haiku/trunk/src/add-ons/kernel/drivers/network/marvell_yukon/dev/msk/Jamfile	2007-11-25 11:29:29 UTC (rev 22991)
+++ haiku/trunk/src/add-ons/kernel/drivers/network/marvell_yukon/dev/msk/Jamfile	2007-11-25 11:31:51 UTC (rev 22992)
@@ -0,0 +1,14 @@
+SubDir HAIKU_TOP src add-ons kernel drivers network marvell_yukon dev msk ;
+
+UsePrivateHeaders kernel net ;
+
+UseHeaders [ FDirName $(SUBDIR) .. .. ] : true ;
+UseHeaders [ FDirName $(HAIKU_TOP) src libs compat freebsd_network compat ] : true ;
+
+SubDirCcFlags [ FDefines _KERNEL=1 FBSD_DRIVER=1 EM_FAST_INTR=1 ] ;
+
+KernelAddon marvell_yukon :
+	if_msk.c
+	glue.c
+	: libfreebsd_network.a
+	;

Added: haiku/trunk/src/add-ons/kernel/drivers/network/marvell_yukon/dev/msk/glue.c
===================================================================
--- haiku/trunk/src/add-ons/kernel/drivers/network/marvell_yukon/dev/msk/glue.c	2007-11-25 11:29:29 UTC (rev 22991)
+++ haiku/trunk/src/add-ons/kernel/drivers/network/marvell_yukon/dev/msk/glue.c	2007-11-25 11:31:51 UTC (rev 22992)
@@ -0,0 +1,13 @@
+#include &lt;sys/bus.h&gt;
+
+HAIKU_FBSD_DRIVER_GLUE(marvell_yukon, mskc, pci)
+
+NO_HAIKU_CHECK_DISABLE_INTERRUPTS();
+NO_HAIKU_REENABLE_INTERRUPTS();
+NO_HAIKU_FBSD_MII_DRIVER();
+
+#ifdef EM_FAST_INTR
+	HAIKU_DRIVER_REQUIREMENTS(FBSD_TASKQUEUES | FBSD_FAST_TASKQUEUE);
+#else
+	HAIKU_DRIVER_REQUIREMENTS(0);
+#endif

Added: haiku/trunk/src/add-ons/kernel/drivers/network/marvell_yukon/dev/msk/if_msk.c
===================================================================
--- haiku/trunk/src/add-ons/kernel/drivers/network/marvell_yukon/dev/msk/if_msk.c	2007-11-25 11:29:29 UTC (rev 22991)
+++ haiku/trunk/src/add-ons/kernel/drivers/network/marvell_yukon/dev/msk/if_msk.c	2007-11-25 11:31:51 UTC (rev 22992)
@@ -0,0 +1,4157 @@
+/******************************************************************************
+ *
+ * Name   : sky2.c
+ * Project: Gigabit Ethernet Driver for FreeBSD 5.x/6.x
+ * Version: $Revision: 1.23 $
+ * Date   : $Date: 2005/12/22 09:04:11 $
+ * Purpose: Main driver source file
+ *
+ *****************************************************************************/
+
+/******************************************************************************
+ *
+ *	LICENSE:
+ *	Copyright (C) Marvell International Ltd. and/or its affiliates
+ *
+ *	The computer program files contained in this folder (&quot;Files&quot;)
+ *	are provided to you under the BSD-type license terms provided
+ *	below, and any use of such Files and any derivative works
+ *	thereof created by you shall be governed by the following terms
+ *	and conditions:
+ *
+ *	- Redistributions of source code must retain the above copyright
+ *	  notice, this list of conditions and the following disclaimer.
+ *	- Redistributions in binary form must reproduce the above
+ *	  copyright notice, this list of conditions and the following
+ *	  disclaimer in the documentation and/or other materials provided
+ *	  with the distribution.
+ *	- Neither the name of Marvell nor the names of its contributors
+ *	  may be used to endorse or promote products derived from this
+ *	  software without specific prior written permission.
+ *
+ *	THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
+ *	&quot;AS IS&quot; AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
+ *	LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS
+ *	FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE
+ *	COPYRIGHT OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT,
+ *	INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING,
+ *	BUT NOT LIMITED TO, PROCUREMENT OF  SUBSTITUTE GOODS OR SERVICES;
+ *	LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)
+ *	HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT,
+ *	STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)
+ *	ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED
+ *	OF THE POSSIBILITY OF SUCH DAMAGE.
+ *	/LICENSE
+ *
+ *****************************************************************************/
+
+/*-
+ * Copyright (c) 1997, 1998, 1999, 2000
+ *	Bill Paul &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/haiku-commits">wpaul at ctr.columbia.edu</A>&gt;.  All rights reserved.
+ *
+ * Redistribution and use in source and binary forms, with or without
+ * modification, are permitted provided that the following conditions
+ * are met:
+ * 1. Redistributions of source code must retain the above copyright
+ *    notice, this list of conditions and the following disclaimer.
+ * 2. Redistributions in binary form must reproduce the above copyright
+ *    notice, this list of conditions and the following disclaimer in the
+ *    documentation and/or other materials provided with the distribution.
+ * 3. All advertising materials mentioning features or use of this software
+ *    must display the following acknowledgement:
+ *	This product includes software developed by Bill Paul.
+ * 4. Neither the name of the author nor the names of any co-contributors
+ *    may be used to endorse or promote products derived from this software
+ *    without specific prior written permission.
+ *
+ * THIS SOFTWARE IS PROVIDED BY Bill Paul AND CONTRIBUTORS ``AS IS'' AND
+ * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
+ * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE
+ * ARE DISCLAIMED.  IN NO EVENT SHALL Bill Paul OR THE VOICES IN HIS HEAD
+ * BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR
+ * CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF
+ * SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS
+ * INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN
+ * CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)
+ * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF
+ * THE POSSIBILITY OF SUCH DAMAGE.
+ */
+/*-
+ * Copyright (c) 2003 Nathan L. Binkert &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/haiku-commits">binkertn at umich.edu</A>&gt;
+ *
+ * Permission to use, copy, modify, and distribute this software for any
+ * purpose with or without fee is hereby granted, provided that the above
+ * copyright notice and this permission notice appear in all copies.
+ *
+ * THE SOFTWARE IS PROVIDED &quot;AS IS&quot; AND THE AUTHOR DISCLAIMS ALL WARRANTIES
+ * WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF
+ * MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR
+ * ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES
+ * WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN
+ * ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF
+ * OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.
+ */
+
+/*
+ * Device driver for the Marvell Yukon II Ethernet controller.
+ * Due to lack of documentation, this driver is based on the code from
+ * sk(4) and Marvell's myk(4) driver for FreeBSD 5.x.
+ */
+
+#include &lt;sys/cdefs.h&gt;
+__FBSDID(&quot;$FreeBSD: src/sys/dev/msk/if_msk.c,v 1.18 2007/07/20 00:25:20 yongari Exp $&quot;);
+
+#include &lt;sys/param.h&gt;
+#include &lt;sys/systm.h&gt;
+#include &lt;sys/bus.h&gt;
+#include &lt;sys/endian.h&gt;
+#include &lt;sys/mbuf.h&gt;
+#include &lt;sys/malloc.h&gt;
+#include &lt;sys/kernel.h&gt;
+#include &lt;sys/module.h&gt;
+#include &lt;sys/socket.h&gt;
+#include &lt;sys/sockio.h&gt;
+#include &lt;sys/queue.h&gt;
+#include &lt;sys/sysctl.h&gt;
+#include &lt;sys/taskqueue.h&gt;
+
+#include &lt;net/bpf.h&gt;
+#include &lt;net/ethernet.h&gt;
+#include &lt;net/if.h&gt;
+#include &lt;net/if_arp.h&gt;
+#include &lt;net/if_dl.h&gt;
+#include &lt;net/if_media.h&gt;
+#include &lt;net/if_types.h&gt;
+#include &lt;net/if_vlan_var.h&gt;
+
+#include &lt;netinet/in.h&gt;
+#include &lt;netinet/in_systm.h&gt;
+#include &lt;netinet/ip.h&gt;
+#include &lt;netinet/tcp.h&gt;
+#include &lt;netinet/udp.h&gt;
+
+#include &lt;machine/bus.h&gt;
+#include &lt;machine/in_cksum.h&gt;
+#include &lt;machine/resource.h&gt;
+#include &lt;sys/rman.h&gt;
+
+#include &lt;dev/mii/mii.h&gt;
+#include &lt;dev/mii/miivar.h&gt;
+#include &lt;dev/mii/brgphyreg.h&gt;
+
+#include &lt;dev/pci/pcireg.h&gt;
+#include &lt;dev/pci/pcivar.h&gt;
+
+#include &lt;dev/msk/if_mskreg.h&gt;
+
+MODULE_DEPEND(msk, pci, 1, 1, 1);
+MODULE_DEPEND(msk, ether, 1, 1, 1);
+MODULE_DEPEND(msk, miibus, 1, 1, 1);
+
+/* &quot;device miibus&quot; required.  See GENERIC if you get errors here. */
+#include &quot;miibus_if.h&quot;
+
+/* Tunables. */
+static int msi_disable = 0;
+TUNABLE_INT(&quot;hw.msk.msi_disable&quot;, &amp;msi_disable);
+static int legacy_intr = 0;
+TUNABLE_INT(&quot;hw.msk.legacy_intr&quot;, &amp;legacy_intr);
+
+#define MSK_CSUM_FEATURES	(CSUM_TCP | CSUM_UDP)
+
+/*
+ * Devices supported by this driver.
+ */
+static struct msk_product {
+	uint16_t	msk_vendorid;
+	uint16_t	msk_deviceid;
+	const char	*msk_name;
+} msk_products[] = {
+	{ VENDORID_SK, DEVICEID_SK_YUKON2,
+	    &quot;SK-9Sxx Gigabit Ethernet&quot; },
+	{ VENDORID_SK, DEVICEID_SK_YUKON2_EXPR,
+	    &quot;SK-9Exx Gigabit Ethernet&quot;},
+	{ VENDORID_MARVELL, DEVICEID_MRVL_8021CU,
+	    &quot;Marvell Yukon 88E8021CU Gigabit Ethernet&quot; },
+	{ VENDORID_MARVELL, DEVICEID_MRVL_8021X,
+	    &quot;Marvell Yukon 88E8021 SX/LX Gigabit Ethernet&quot; },
+	{ VENDORID_MARVELL, DEVICEID_MRVL_8022CU,
+	    &quot;Marvell Yukon 88E8022CU Gigabit Ethernet&quot; },
+	{ VENDORID_MARVELL, DEVICEID_MRVL_8022X,
+	    &quot;Marvell Yukon 88E8022 SX/LX Gigabit Ethernet&quot; },
+	{ VENDORID_MARVELL, DEVICEID_MRVL_8061CU,
+	    &quot;Marvell Yukon 88E8061CU Gigabit Ethernet&quot; },
+	{ VENDORID_MARVELL, DEVICEID_MRVL_8061X,
+	    &quot;Marvell Yukon 88E8061 SX/LX Gigabit Ethernet&quot; },
+	{ VENDORID_MARVELL, DEVICEID_MRVL_8062CU,
+	    &quot;Marvell Yukon 88E8062CU Gigabit Ethernet&quot; },
+	{ VENDORID_MARVELL, DEVICEID_MRVL_8062X,
+	    &quot;Marvell Yukon 88E8062 SX/LX Gigabit Ethernet&quot; },
+	{ VENDORID_MARVELL, DEVICEID_MRVL_8035,
+	    &quot;Marvell Yukon 88E8035 Gigabit Ethernet&quot; },
+	{ VENDORID_MARVELL, DEVICEID_MRVL_8036,
+	    &quot;Marvell Yukon 88E8036 Gigabit Ethernet&quot; },
+	{ VENDORID_MARVELL, DEVICEID_MRVL_8038,
+	    &quot;Marvell Yukon 88E8038 Gigabit Ethernet&quot; },
+	{ VENDORID_MARVELL, DEVICEID_MRVL_4361,
+	    &quot;Marvell Yukon 88E8050 Gigabit Ethernet&quot; },
+	{ VENDORID_MARVELL, DEVICEID_MRVL_4360,
+	    &quot;Marvell Yukon 88E8052 Gigabit Ethernet&quot; },
+	{ VENDORID_MARVELL, DEVICEID_MRVL_4362,
+	    &quot;Marvell Yukon 88E8053 Gigabit Ethernet&quot; },
+	{ VENDORID_MARVELL, DEVICEID_MRVL_4363,
+	    &quot;Marvell Yukon 88E8055 Gigabit Ethernet&quot; },
+	{ VENDORID_MARVELL, DEVICEID_MRVL_4364,
+	    &quot;Marvell Yukon 88E8056 Gigabit Ethernet&quot; },
+	{ VENDORID_DLINK, DEVICEID_DLINK_DGE550SX,
+	    &quot;D-Link 550SX Gigabit Ethernet&quot; },
+	{ VENDORID_DLINK, DEVICEID_DLINK_DGE560T,
+	    &quot;D-Link 560T Gigabit Ethernet&quot; }
+};
+
+static const char *model_name[] = {
+	&quot;Yukon XL&quot;,
+        &quot;Yukon EC Ultra&quot;,
+        &quot;Yukon Unknown&quot;,
+        &quot;Yukon EC&quot;,
+        &quot;Yukon FE&quot;
+};
+
+static int mskc_probe(device_t);
+static int mskc_attach(device_t);
+static int mskc_detach(device_t);
+static void mskc_shutdown(device_t);
+static int mskc_setup_rambuffer(struct msk_softc *);
+static int mskc_suspend(device_t);
+static int mskc_resume(device_t);
+static void mskc_reset(struct msk_softc *);
+
+static int msk_probe(device_t);
+static int msk_attach(device_t);
+static int msk_detach(device_t);
+
+static void msk_tick(void *);
+static void msk_legacy_intr(void *);
+static int msk_intr(void *);
+static void msk_int_task(void *, int);
+static void msk_intr_phy(struct msk_if_softc *);
+static void msk_intr_gmac(struct msk_if_softc *);
+static __inline void msk_rxput(struct msk_if_softc *);
+static int msk_handle_events(struct msk_softc *);
+static void msk_handle_hwerr(struct msk_if_softc *, uint32_t);
+static void msk_intr_hwerr(struct msk_softc *);
+static void msk_rxeof(struct msk_if_softc *, uint32_t, int);
+static void msk_jumbo_rxeof(struct msk_if_softc *, uint32_t, int);
+static void msk_txeof(struct msk_if_softc *, int);
+static struct mbuf *msk_defrag(struct mbuf *, int, int);
+static int msk_encap(struct msk_if_softc *, struct mbuf **);
+static void msk_tx_task(void *, int);
+static void msk_start(struct ifnet *);
+static int msk_ioctl(struct ifnet *, u_long, caddr_t);
+static void msk_set_prefetch(struct msk_softc *, int, bus_addr_t, uint32_t);
+static void msk_set_rambuffer(struct msk_if_softc *);
+static void msk_init(void *);
+static void msk_init_locked(struct msk_if_softc *);
+static void msk_stop(struct msk_if_softc *);
+static void msk_watchdog(struct msk_if_softc *);
+static int msk_mediachange(struct ifnet *);
+static void msk_mediastatus(struct ifnet *, struct ifmediareq *);
+static void msk_phy_power(struct msk_softc *, int);
+static void msk_dmamap_cb(void *, bus_dma_segment_t *, int, int);
+static int msk_status_dma_alloc(struct msk_softc *);
+static void msk_status_dma_free(struct msk_softc *);
+static int msk_txrx_dma_alloc(struct msk_if_softc *);
+static void msk_txrx_dma_free(struct msk_if_softc *);
+static void *msk_jalloc(struct msk_if_softc *);
+static void msk_jfree(void *, void *);
+static int msk_init_rx_ring(struct msk_if_softc *);
+static int msk_init_jumbo_rx_ring(struct msk_if_softc *);
+static void msk_init_tx_ring(struct msk_if_softc *);
+static __inline void msk_discard_rxbuf(struct msk_if_softc *, int);
+static __inline void msk_discard_jumbo_rxbuf(struct msk_if_softc *, int);
+static int msk_newbuf(struct msk_if_softc *, int);
+static int msk_jumbo_newbuf(struct msk_if_softc *, int);
+
+static int msk_phy_readreg(struct msk_if_softc *, int, int);
+static int msk_phy_writereg(struct msk_if_softc *, int, int, int);
+static int msk_miibus_readreg(device_t, int, int);
+static int msk_miibus_writereg(device_t, int, int, int);
+static void msk_miibus_statchg(device_t);
+static void msk_link_task(void *, int);
+
+static void msk_setmulti(struct msk_if_softc *);
+static void msk_setvlan(struct msk_if_softc *, struct ifnet *);
+static void msk_setpromisc(struct msk_if_softc *);
+
+static int sysctl_int_range(SYSCTL_HANDLER_ARGS, int, int);
+static int sysctl_hw_msk_proc_limit(SYSCTL_HANDLER_ARGS);
+
+static device_method_t mskc_methods[] = {
+	/* Device interface */
+	DEVMETHOD(device_probe,		mskc_probe),
+	DEVMETHOD(device_attach,	mskc_attach),
+	DEVMETHOD(device_detach,	mskc_detach),
+	DEVMETHOD(device_suspend,	mskc_suspend),
+	DEVMETHOD(device_resume,	mskc_resume),
+	DEVMETHOD(device_shutdown,	mskc_shutdown),
+
+	/* bus interface */
+	DEVMETHOD(bus_print_child,	bus_generic_print_child),
+	DEVMETHOD(bus_driver_added,	bus_generic_driver_added),
+
+	{ NULL, NULL }
+};
+
+static driver_t mskc_driver = {
+	&quot;mskc&quot;,
+	mskc_methods,
+	sizeof(struct msk_softc)
+};
+
+static devclass_t mskc_devclass;
+
+static device_method_t msk_methods[] = {
+	/* Device interface */
+	DEVMETHOD(device_probe,		msk_probe),
+	DEVMETHOD(device_attach,	msk_attach),
+	DEVMETHOD(device_detach,	msk_detach),
+	DEVMETHOD(device_shutdown,	bus_generic_shutdown),
+
+	/* bus interface */
+	DEVMETHOD(bus_print_child,	bus_generic_print_child),
+	DEVMETHOD(bus_driver_added,	bus_generic_driver_added),
+
+	/* MII interface */
+	DEVMETHOD(miibus_readreg,	msk_miibus_readreg),
+	DEVMETHOD(miibus_writereg,	msk_miibus_writereg),
+	DEVMETHOD(miibus_statchg,	msk_miibus_statchg),
+
+	{ NULL, NULL }
+};
+
+static driver_t msk_driver = {
+	&quot;msk&quot;,
+	msk_methods,
+	sizeof(struct msk_if_softc)
+};
+
+static devclass_t msk_devclass;
+
+DRIVER_MODULE(mskc, pci, mskc_driver, mskc_devclass, 0, 0);
+DRIVER_MODULE(msk, mskc, msk_driver, msk_devclass, 0, 0);
+DRIVER_MODULE(miibus, msk, miibus_driver, miibus_devclass, 0, 0);
+
+static struct resource_spec msk_res_spec_io[] = {
+	{ SYS_RES_IOPORT,	PCIR_BAR(1),	RF_ACTIVE },
+	{ -1,			0,		0 }
+};
+
+static struct resource_spec msk_res_spec_mem[] = {
+	{ SYS_RES_MEMORY,	PCIR_BAR(0),	RF_ACTIVE },
+	{ -1,			0,		0 }
+};
+
+static struct resource_spec msk_irq_spec_legacy[] = {
+	{ SYS_RES_IRQ,		0,		RF_ACTIVE | RF_SHAREABLE },
+	{ -1,			0,		0 }
+};
+
+static struct resource_spec msk_irq_spec_msi[] = {
+	{ SYS_RES_IRQ,		1,		RF_ACTIVE },
+	{ SYS_RES_IRQ,		2,		RF_ACTIVE },
+	{ -1,			0,		0 }
+};
+
+static int
+msk_miibus_readreg(device_t dev, int phy, int reg)
+{
+	struct msk_if_softc *sc_if;
+
+	sc_if = device_get_softc(dev);
+
+	return (msk_phy_readreg(sc_if, phy, reg));
+}
+
+static int
+msk_phy_readreg(struct msk_if_softc *sc_if, int phy, int reg)
+{
+	struct msk_softc *sc;
+	int i, val;
+
+	sc = sc_if-&gt;msk_softc;
+
+        GMAC_WRITE_2(sc, sc_if-&gt;msk_port, GM_SMI_CTRL,
+	    GM_SMI_CT_PHY_AD(phy) | GM_SMI_CT_REG_AD(reg) | GM_SMI_CT_OP_RD);
+
+	for (i = 0; i &lt; MSK_TIMEOUT; i++) {
+		DELAY(1);
+		val = GMAC_READ_2(sc, sc_if-&gt;msk_port, GM_SMI_CTRL);
+		if ((val &amp; GM_SMI_CT_RD_VAL) != 0) {
+			val = GMAC_READ_2(sc, sc_if-&gt;msk_port, GM_SMI_DATA);
+			break;
+		}
+	}
+
+	if (i == MSK_TIMEOUT) {
+		if_printf(sc_if-&gt;msk_ifp, &quot;phy failed to come ready\n&quot;);
+		val = 0;
+	}
+
+	return (val);
+}
+
+static int
+msk_miibus_writereg(device_t dev, int phy, int reg, int val)
+{
+	struct msk_if_softc *sc_if;
+
+	sc_if = device_get_softc(dev);
+
+	return (msk_phy_writereg(sc_if, phy, reg, val));
+}
+
+static int
+msk_phy_writereg(struct msk_if_softc *sc_if, int phy, int reg, int val)
+{
+	struct msk_softc *sc;
+	int i;
+
+	sc = sc_if-&gt;msk_softc;
+
+	GMAC_WRITE_2(sc, sc_if-&gt;msk_port, GM_SMI_DATA, val);
+        GMAC_WRITE_2(sc, sc_if-&gt;msk_port, GM_SMI_CTRL,
+	    GM_SMI_CT_PHY_AD(phy) | GM_SMI_CT_REG_AD(reg));
+	for (i = 0; i &lt; MSK_TIMEOUT; i++) {
+		DELAY(1);
+		if ((GMAC_READ_2(sc, sc_if-&gt;msk_port, GM_SMI_CTRL) &amp;
+		    GM_SMI_CT_BUSY) == 0)
+			break;
+	}
+	if (i == MSK_TIMEOUT)
+		if_printf(sc_if-&gt;msk_ifp, &quot;phy write timeout\n&quot;);
+
+	return (0);
+}
+
+static void
+msk_miibus_statchg(device_t dev)
+{
+	struct msk_if_softc *sc_if;
+
+	sc_if = device_get_softc(dev);
+	taskqueue_enqueue(taskqueue_swi, &amp;sc_if-&gt;msk_link_task);
+}
+
+static void
+msk_link_task(void *arg, int pending)
+{
+	struct msk_softc *sc;
+	struct msk_if_softc *sc_if;
+	struct mii_data *mii;
+	struct ifnet *ifp;
+	uint32_t gmac;
+
+	sc_if = (struct msk_if_softc *)arg;
+	sc = sc_if-&gt;msk_softc;
+
+	MSK_IF_LOCK(sc_if);
+
+	mii = device_get_softc(sc_if-&gt;msk_miibus);
+	ifp = sc_if-&gt;msk_ifp;
+	if (mii == NULL || ifp == NULL) {
+		MSK_IF_UNLOCK(sc_if);
+		return;
+	}
+
+	if (mii-&gt;mii_media_status &amp; IFM_ACTIVE) {
+		if (IFM_SUBTYPE(mii-&gt;mii_media_active) != IFM_NONE)
+			sc_if-&gt;msk_link = 1;
+	} else
+		sc_if-&gt;msk_link = 0;
+
+	if (sc_if-&gt;msk_link != 0) {
+		/* Enable Tx FIFO Underrun. */
+		CSR_WRITE_1(sc, MR_ADDR(sc_if-&gt;msk_port, GMAC_IRQ_MSK),
+		    GM_IS_TX_FF_UR | GM_IS_RX_FF_OR);
+		/*
+		 * Because mii(4) notify msk(4) that it detected link status
+		 * change, there is no need to enable automatic
+		 * speed/flow-control/duplex updates.
+		 */
+		gmac = GM_GPCR_AU_ALL_DIS;
+		switch (IFM_SUBTYPE(mii-&gt;mii_media_active)) {
+		case IFM_1000_SX:
+		case IFM_1000_T:
+			gmac |= GM_GPCR_SPEED_1000;
+			break;
+		case IFM_100_TX:
+			gmac |= GM_GPCR_SPEED_100;
+			break;
+		case IFM_10_T:
+			break;
+		}
+
+		if (((mii-&gt;mii_media_active &amp; IFM_GMASK) &amp; IFM_FDX) != 0)
+			gmac |= GM_GPCR_DUP_FULL;
+		/* Disable Rx flow control. */
+		if (((mii-&gt;mii_media_active &amp; IFM_GMASK) &amp; IFM_FLAG0) == 0)
+			gmac |= GM_GPCR_FC_RX_DIS;
+		/* Disable Tx flow control. */
+		if (((mii-&gt;mii_media_active &amp; IFM_GMASK) &amp; IFM_FLAG1) == 0)
+			gmac |= GM_GPCR_FC_TX_DIS;
+		gmac |= GM_GPCR_RX_ENA | GM_GPCR_TX_ENA;
+		GMAC_WRITE_2(sc, sc_if-&gt;msk_port, GM_GP_CTRL, gmac);
+		/* Read again to ensure writing. */
+		GMAC_READ_2(sc, sc_if-&gt;msk_port, GM_GP_CTRL);
+
+		gmac = GMC_PAUSE_ON;
+		if (((mii-&gt;mii_media_active &amp; IFM_GMASK) &amp;
+		    (IFM_FLAG0 | IFM_FLAG1)) == 0)
+			gmac = GMC_PAUSE_OFF;
+		/* Diable pause for 10/100 Mbps in half-duplex mode. */
+		if ((((mii-&gt;mii_media_active &amp; IFM_GMASK) &amp; IFM_FDX) == 0) &amp;&amp;
+		    (IFM_SUBTYPE(mii-&gt;mii_media_active) == IFM_100_TX ||
+		    IFM_SUBTYPE(mii-&gt;mii_media_active) == IFM_10_T))
+			gmac = GMC_PAUSE_OFF;
+		CSR_WRITE_4(sc, MR_ADDR(sc_if-&gt;msk_port, GMAC_CTRL), gmac);
+
+		/* Enable PHY interrupt for FIFO underrun/overflow. */
+		if (sc-&gt;msk_marvell_phy)
+			msk_phy_writereg(sc_if, PHY_ADDR_MARV,
+			    PHY_MARV_INT_MASK, PHY_M_IS_FIFO_ERROR);
+	} else {
+		/*
+		 * Link state changed to down.
+		 * Disable PHY interrupts.
+		 */
+		if (sc-&gt;msk_marvell_phy)
+			msk_phy_writereg(sc_if, PHY_ADDR_MARV,
+			    PHY_MARV_INT_MASK, 0);
+		/* Disable Rx/Tx MAC. */
+		gmac = GMAC_READ_2(sc, sc_if-&gt;msk_port, GM_GP_CTRL);
+		gmac &amp;= ~(GM_GPCR_RX_ENA | GM_GPCR_TX_ENA);
+		GMAC_WRITE_2(sc, sc_if-&gt;msk_port, GM_GP_CTRL, gmac);
+		/* Read again to ensure writing. */
+		GMAC_READ_2(sc, sc_if-&gt;msk_port, GM_GP_CTRL);
+	}
+
+	MSK_IF_UNLOCK(sc_if);
+}
+
+static void
+msk_setmulti(struct msk_if_softc *sc_if)
+{
+	struct msk_softc *sc;
+	struct ifnet *ifp;
+	struct ifmultiaddr *ifma;
+	uint32_t mchash[2];
+	uint32_t crc;
+	uint16_t mode;
+
+	sc = sc_if-&gt;msk_softc;
+
+	MSK_IF_LOCK_ASSERT(sc_if);
+

[... truncated: 6009 lines follow ...]

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="004845.html">[Haiku-commits] r22991 - in haiku/trunk/src:	add-ons/kernel/drivers/network/3com/pci	add-ons/kernel/drivers/network/ipro1000/dev/em	add-ons/kernel/drivers/network/rtl8139/pci	add-ons/kernel/drivers/network/via_rhine/pci	libs/compat/freebsd_network	libs/compat/freebsd_network/compat/dev/pci	libs/compat/freebsd_network/compat/machine	libs/compat/freebsd_network/compat/net	libs/compat/freebsd_network/compat/netinet	libs/compat/freebsd_network/compat/sys	libs/compat/freebsd_network/compat/vm
</A></li>
	<LI>Next message: <A HREF="004847.html">[Haiku-commits] r22993 - in	haiku/trunk/src/libs/compat/freebsd_network: . compat/net
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4846">[ date ]</a>
              <a href="thread.html#4846">[ thread ]</a>
              <a href="subject.html#4846">[ subject ]</a>
              <a href="author.html#4846">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/haiku-commits">More information about the Haiku-commits
mailing list</a><br>
</body></html>
