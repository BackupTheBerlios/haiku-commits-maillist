<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Haiku-commits] r22991 - in haiku/trunk/src:	add-ons/kernel/drivers/network/3com/pci	add-ons/kernel/drivers/network/ipro1000/dev/em	add-ons/kernel/drivers/network/rtl8139/pci	add-ons/kernel/drivers/network/via_rhine/pci	libs/compat/freebsd_network	libs/compat/freebsd_network/compat/dev/pci	libs/compat/freebsd_network/compat/machine	libs/compat/freebsd_network/compat/net	libs/compat/freebsd_network/compat/netinet	libs/compat/freebsd_network/compat/sys	libs/compat/freebsd_network/compat/vm
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/haiku-commits/2007-November/index.html" >
   <LINK REL="made" HREF="mailto:haiku-commits%40lists.berlios.de?Subject=Re%3A%20%5BHaiku-commits%5D%20r22991%20-%20in%20haiku/trunk/src%3A%0A%09add-ons/kernel/drivers/network/3com/pci%0A%09add-ons/kernel/drivers/network/ipro1000/dev/em%0A%09add-ons/kernel/drivers/network/rtl8139/pci%0A%09add-ons/kernel/drivers/network/via_rhine/pci%0A%09libs/compat/freebsd_network%0A%09libs/compat/freebsd_network/compat/dev/pci%0A%09libs/compat/freebsd_network/compat/machine%0A%09libs/compat/freebsd_network/compat/net%0A%09libs/compat/freebsd_network/compat/netinet%0A%09libs/compat/freebsd_network/compat/sys%0A%09libs/compat/freebsd_network/compat/vm&In-Reply-To=%3C200711251129.lAPBTqKM004375%40sheep.berlios.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="004844.html">
   <LINK REL="Next"  HREF="004846.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Haiku-commits] r22991 - in haiku/trunk/src:	add-ons/kernel/drivers/network/3com/pci	add-ons/kernel/drivers/network/ipro1000/dev/em	add-ons/kernel/drivers/network/rtl8139/pci	add-ons/kernel/drivers/network/via_rhine/pci	libs/compat/freebsd_network	libs/compat/freebsd_network/compat/dev/pci	libs/compat/freebsd_network/compat/machine	libs/compat/freebsd_network/compat/net	libs/compat/freebsd_network/compat/netinet	libs/compat/freebsd_network/compat/sys	libs/compat/freebsd_network/compat/vm</H1>
    <B>axeld at BerliOS</B> 
    <A HREF="mailto:haiku-commits%40lists.berlios.de?Subject=Re%3A%20%5BHaiku-commits%5D%20r22991%20-%20in%20haiku/trunk/src%3A%0A%09add-ons/kernel/drivers/network/3com/pci%0A%09add-ons/kernel/drivers/network/ipro1000/dev/em%0A%09add-ons/kernel/drivers/network/rtl8139/pci%0A%09add-ons/kernel/drivers/network/via_rhine/pci%0A%09libs/compat/freebsd_network%0A%09libs/compat/freebsd_network/compat/dev/pci%0A%09libs/compat/freebsd_network/compat/machine%0A%09libs/compat/freebsd_network/compat/net%0A%09libs/compat/freebsd_network/compat/netinet%0A%09libs/compat/freebsd_network/compat/sys%0A%09libs/compat/freebsd_network/compat/vm&In-Reply-To=%3C200711251129.lAPBTqKM004375%40sheep.berlios.de%3E"
       TITLE="[Haiku-commits] r22991 - in haiku/trunk/src:	add-ons/kernel/drivers/network/3com/pci	add-ons/kernel/drivers/network/ipro1000/dev/em	add-ons/kernel/drivers/network/rtl8139/pci	add-ons/kernel/drivers/network/via_rhine/pci	libs/compat/freebsd_network	libs/compat/freebsd_network/compat/dev/pci	libs/compat/freebsd_network/compat/machine	libs/compat/freebsd_network/compat/net	libs/compat/freebsd_network/compat/netinet	libs/compat/freebsd_network/compat/sys	libs/compat/freebsd_network/compat/vm">axeld at mail.berlios.de
       </A><BR>
    <I>Sun Nov 25 12:29:52 CET 2007</I>
    <P><UL>
        <LI>Previous message: <A HREF="004844.html">[Haiku-commits] r22990 - haiku/trunk/docs/develop/kernel
</A></li>
        <LI>Next message: <A HREF="004846.html">[Haiku-commits] r22992 - in	haiku/trunk/src/add-ons/kernel/drivers/network: .	marvell_yukon marvell_yukon/dev marvell_yukon/dev/mii	marvell_yukon/dev/msk
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4845">[ date ]</a>
              <a href="thread.html#4845">[ thread ]</a>
              <a href="subject.html#4845">[ subject ]</a>
              <a href="author.html#4845">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: axeld
Date: 2007-11-25 12:29:29 +0100 (Sun, 25 Nov 2007)
New Revision: 22991
ViewCVS: <A HREF="http://svn.berlios.de/viewcvs/haiku?rev=22991&amp;view=rev">http://svn.berlios.de/viewcvs/haiku?rev=22991&amp;view=rev</A>

Added:
   haiku/trunk/src/add-ons/kernel/drivers/network/ipro1000/dev/em/e1000_80003es2lan.c
   haiku/trunk/src/add-ons/kernel/drivers/network/ipro1000/dev/em/e1000_80003es2lan.h
   haiku/trunk/src/add-ons/kernel/drivers/network/ipro1000/dev/em/e1000_82540.c
   haiku/trunk/src/add-ons/kernel/drivers/network/ipro1000/dev/em/e1000_82541.c
   haiku/trunk/src/add-ons/kernel/drivers/network/ipro1000/dev/em/e1000_82541.h
   haiku/trunk/src/add-ons/kernel/drivers/network/ipro1000/dev/em/e1000_82542.c
   haiku/trunk/src/add-ons/kernel/drivers/network/ipro1000/dev/em/e1000_82543.c
   haiku/trunk/src/add-ons/kernel/drivers/network/ipro1000/dev/em/e1000_82543.h
   haiku/trunk/src/add-ons/kernel/drivers/network/ipro1000/dev/em/e1000_82571.c
   haiku/trunk/src/add-ons/kernel/drivers/network/ipro1000/dev/em/e1000_82571.h
   haiku/trunk/src/add-ons/kernel/drivers/network/ipro1000/dev/em/e1000_82575.c
   haiku/trunk/src/add-ons/kernel/drivers/network/ipro1000/dev/em/e1000_82575.h
   haiku/trunk/src/add-ons/kernel/drivers/network/ipro1000/dev/em/e1000_api.c
   haiku/trunk/src/add-ons/kernel/drivers/network/ipro1000/dev/em/e1000_api.h
   haiku/trunk/src/add-ons/kernel/drivers/network/ipro1000/dev/em/e1000_defines.h
   haiku/trunk/src/add-ons/kernel/drivers/network/ipro1000/dev/em/e1000_hw.h
   haiku/trunk/src/add-ons/kernel/drivers/network/ipro1000/dev/em/e1000_ich8lan.c
   haiku/trunk/src/add-ons/kernel/drivers/network/ipro1000/dev/em/e1000_ich8lan.h
   haiku/trunk/src/add-ons/kernel/drivers/network/ipro1000/dev/em/e1000_mac.c
   haiku/trunk/src/add-ons/kernel/drivers/network/ipro1000/dev/em/e1000_mac.h
   haiku/trunk/src/add-ons/kernel/drivers/network/ipro1000/dev/em/e1000_manage.c
   haiku/trunk/src/add-ons/kernel/drivers/network/ipro1000/dev/em/e1000_manage.h
   haiku/trunk/src/add-ons/kernel/drivers/network/ipro1000/dev/em/e1000_nvm.c
   haiku/trunk/src/add-ons/kernel/drivers/network/ipro1000/dev/em/e1000_nvm.h
   haiku/trunk/src/add-ons/kernel/drivers/network/ipro1000/dev/em/e1000_osdep.h
   haiku/trunk/src/add-ons/kernel/drivers/network/ipro1000/dev/em/e1000_phy.c
   haiku/trunk/src/add-ons/kernel/drivers/network/ipro1000/dev/em/e1000_phy.h
   haiku/trunk/src/add-ons/kernel/drivers/network/ipro1000/dev/em/e1000_regs.h
   haiku/trunk/src/libs/compat/freebsd_network/compat/netinet/ip6.h
   haiku/trunk/src/libs/compat/freebsd_network/compat/sys/_bus_dma.h
Removed:
   haiku/trunk/src/add-ons/kernel/drivers/network/ipro1000/dev/em/if_em_hw.c
   haiku/trunk/src/add-ons/kernel/drivers/network/ipro1000/dev/em/if_em_hw.h
   haiku/trunk/src/add-ons/kernel/drivers/network/ipro1000/dev/em/if_em_osdep.h
   haiku/trunk/src/libs/compat/freebsd_network/README
Modified:
   haiku/trunk/src/add-ons/kernel/drivers/network/3com/pci/if_xl.c
   haiku/trunk/src/add-ons/kernel/drivers/network/3com/pci/if_xlreg.h
   haiku/trunk/src/add-ons/kernel/drivers/network/ipro1000/dev/em/Jamfile
   haiku/trunk/src/add-ons/kernel/drivers/network/ipro1000/dev/em/LICENSE
   haiku/trunk/src/add-ons/kernel/drivers/network/ipro1000/dev/em/README
   haiku/trunk/src/add-ons/kernel/drivers/network/ipro1000/dev/em/if_em.c
   haiku/trunk/src/add-ons/kernel/drivers/network/ipro1000/dev/em/if_em.h
   haiku/trunk/src/add-ons/kernel/drivers/network/rtl8139/pci/if_rl.c
   haiku/trunk/src/add-ons/kernel/drivers/network/rtl8139/pci/if_rlreg.h
   haiku/trunk/src/add-ons/kernel/drivers/network/via_rhine/pci/glue.c
   haiku/trunk/src/add-ons/kernel/drivers/network/via_rhine/pci/if_vr.c
   haiku/trunk/src/add-ons/kernel/drivers/network/via_rhine/pci/if_vrreg.h
   haiku/trunk/src/libs/compat/freebsd_network/Jamfile
   haiku/trunk/src/libs/compat/freebsd_network/bus.c
   haiku/trunk/src/libs/compat/freebsd_network/compat.c
   haiku/trunk/src/libs/compat/freebsd_network/compat/dev/pci/pcireg.h
   haiku/trunk/src/libs/compat/freebsd_network/compat/dev/pci/pcivar.h
   haiku/trunk/src/libs/compat/freebsd_network/compat/machine/atomic.h
   haiku/trunk/src/libs/compat/freebsd_network/compat/machine/in_cksum.h
   haiku/trunk/src/libs/compat/freebsd_network/compat/net/bpf.h
   haiku/trunk/src/libs/compat/freebsd_network/compat/net/ethernet.h
   haiku/trunk/src/libs/compat/freebsd_network/compat/net/if.h
   haiku/trunk/src/libs/compat/freebsd_network/compat/net/if_vlan_var.h
   haiku/trunk/src/libs/compat/freebsd_network/compat/sys/bus.h
   haiku/trunk/src/libs/compat/freebsd_network/compat/sys/bus_dma.h
   haiku/trunk/src/libs/compat/freebsd_network/compat/sys/mbuf-fbsd.h
   haiku/trunk/src/libs/compat/freebsd_network/compat/sys/mbuf.h
   haiku/trunk/src/libs/compat/freebsd_network/compat/sys/mutex.h
   haiku/trunk/src/libs/compat/freebsd_network/compat/sys/rman.h
   haiku/trunk/src/libs/compat/freebsd_network/compat/sys/systm.h
   haiku/trunk/src/libs/compat/freebsd_network/compat/vm/vm.h
   haiku/trunk/src/libs/compat/freebsd_network/device.c
   haiku/trunk/src/libs/compat/freebsd_network/if.c
   haiku/trunk/src/libs/compat/freebsd_network/mbuf.c
Log:
* Updated the FreeBSD compatibility layer for network drivers to FreeBSD 7
  (RELENG_7_BP).
* There are many white spots, though, most notable PCI MSI(-X) support, and
  jumbo frames.
* Fixed removing interrupts for the INTR_FAST case. Since FreeBSD 7 added
  a new interrupt &quot;filter&quot; mechanism, we can finally report if the interface
  was handled by a device or not (though only very few devices support this
  yet).
* Updated the 3com, rtl8139, e1000, and via_rhine drivers to the latest code
  base. They all compile, but I haven't tested them after the changes yet!


Modified: haiku/trunk/src/add-ons/kernel/drivers/network/3com/pci/if_xl.c
===================================================================
--- haiku/trunk/src/add-ons/kernel/drivers/network/3com/pci/if_xl.c	2007-11-24 15:43:46 UTC (rev 22990)
+++ haiku/trunk/src/add-ons/kernel/drivers/network/3com/pci/if_xl.c	2007-11-25 11:29:29 UTC (rev 22991)
@@ -31,7 +31,7 @@
  */
 
 #include &lt;sys/cdefs.h&gt;
-__FBSDID(&quot;$FreeBSD: src/sys/pci/if_xl.c,v 1.190.2.10 2006/08/17 00:13:07 yongari Exp $&quot;);
+__FBSDID(&quot;$FreeBSD: src/sys/pci/if_xl.c,v 1.210 2007/08/06 14:26:03 rwatson Exp $&quot;);
 
 /*
  * 3Com 3c90x Etherlink XL PCI NIC driver
@@ -245,7 +245,7 @@
 static void xl_init(void *);
 static void xl_init_locked(struct xl_softc *);
 static void xl_stop(struct xl_softc *);
-static void xl_watchdog(struct ifnet *);
+static int xl_watchdog(struct xl_softc *);
 static void xl_shutdown(device_t);
 static int xl_suspend(device_t);
 static int xl_resume(device_t);
@@ -391,7 +391,7 @@
 	}
 
 	if (i == XL_TIMEOUT)
-		if_printf(sc-&gt;xl_ifp, &quot;command never completed!\n&quot;);
+		device_printf(sc-&gt;xl_dev, &quot;command never completed!\n&quot;);
 }
 
 /*
@@ -656,8 +656,7 @@
 		if (sc-&gt;xl_type == XL_TYPE_905B &amp;&amp;
 		    sc-&gt;xl_media == XL_MEDIAOPT_10FL) {
 			if (bootverbose)
-				if_printf(sc-&gt;xl_ifp,
-				    &quot;found 10baseFL\n&quot;);
+				device_printf(sc-&gt;xl_dev, &quot;found 10baseFL\n&quot;);
 			ifmedia_add(ifm, IFM_ETHER | IFM_10_FL, 0, NULL);
 			ifmedia_add(ifm, IFM_ETHER | IFM_10_FL|IFM_HDX, 0,
 			    NULL);
@@ -666,14 +665,14 @@
 				    IFM_ETHER | IFM_10_FL | IFM_FDX, 0, NULL);
 		} else {
 			if (bootverbose)
-				if_printf(sc-&gt;xl_ifp, &quot;found AUI\n&quot;);
+				device_printf(sc-&gt;xl_dev, &quot;found AUI\n&quot;);
 			ifmedia_add(ifm, IFM_ETHER | IFM_10_5, 0, NULL);
 		}
 	}
 
 	if (sc-&gt;xl_media &amp; XL_MEDIAOPT_BNC) {
 		if (bootverbose)
-			if_printf(sc-&gt;xl_ifp, &quot;found BNC\n&quot;);
+			device_printf(sc-&gt;xl_dev, &quot;found BNC\n&quot;);
 		ifmedia_add(ifm, IFM_ETHER | IFM_10_2, 0, NULL);
 	}
 }
@@ -695,7 +694,7 @@
 	}
 
 	if (i == 100) {
-		if_printf(sc-&gt;xl_ifp, &quot;eeprom failed to come ready\n&quot;);
+		device_printf(sc-&gt;xl_dev, &quot;eeprom failed to come ready\n&quot;);
 		return (1);
 	}
 
@@ -857,9 +856,9 @@
 	if (m == NULL)
 		return;
 
-	bcopy(&amp;IFP2ENADDR(sc-&gt;xl_ifp),
+	bcopy(IF_LLADDR(sc-&gt;xl_ifp),
 		mtod(m, struct ether_header *)-&gt;ether_dhost, ETHER_ADDR_LEN);
-	bcopy(&amp;IFP2ENADDR(sc-&gt;xl_ifp),
+	bcopy(IF_LLADDR(sc-&gt;xl_ifp),
 		mtod(m, struct ether_header *)-&gt;ether_shost, ETHER_ADDR_LEN);
 	mtod(m, struct ether_header *)-&gt;ether_type = htons(3);
 	mtod(m, unsigned char *)[14] = 0;
@@ -984,7 +983,7 @@
 	DELAY(800);
 	XL_SEL_WIN(7);
 
-	if_printf(sc-&gt;xl_ifp, &quot;selecting %s, %s duplex\n&quot;, pmsg, dmsg);
+	device_printf(sc-&gt;xl_dev, &quot;selecting %s, %s duplex\n&quot;, pmsg, dmsg);
 }
 
 static void
@@ -1016,7 +1015,7 @@
 	}
 
 	if (i == XL_TIMEOUT)
-		if_printf(sc-&gt;xl_ifp, &quot;reset didn't complete\n&quot;);
+		device_printf(sc-&gt;xl_dev, &quot;reset didn't complete\n&quot;);
 
 	/* Reset TX and RX. */
 	/* Note: the RX reset takes an absurd amount of time
@@ -1099,20 +1098,20 @@
 		if (sc-&gt;xl_xcvr &lt;= XL_XCVR_AUTO)
 			return;
 		else {
-			if_printf(sc-&gt;xl_ifp,
+			device_printf(sc-&gt;xl_dev,
 			    &quot;bogus xcvr value in EEPROM (%x)\n&quot;, sc-&gt;xl_xcvr);
-			if_printf(sc-&gt;xl_ifp,
+			device_printf(sc-&gt;xl_dev,
 			    &quot;choosing new default based on card type\n&quot;);
 		}
 	} else {
 		if (sc-&gt;xl_type == XL_TYPE_905B &amp;&amp;
 		    sc-&gt;xl_media &amp; XL_MEDIAOPT_10FL)
 			return;
-		if_printf(sc-&gt;xl_ifp,
+		device_printf(sc-&gt;xl_dev,
 &quot;WARNING: no media options bits set in the media options register!!\n&quot;);
-		if_printf(sc-&gt;xl_ifp,
+		device_printf(sc-&gt;xl_dev,
 &quot;this could be a manufacturing defect in your adapter or system\n&quot;);
-		if_printf(sc-&gt;xl_ifp,
+		device_printf(sc-&gt;xl_dev,
 &quot;attempting to guess media type; you should probably consult your vendor\n&quot;);
 	}
 
@@ -1137,7 +1136,7 @@
 		sc-&gt;xl_media = XL_MEDIAOPT_BT;
 		sc-&gt;xl_xcvr = XL_XCVR_10BT;
 		if (verbose)
-			if_printf(sc-&gt;xl_ifp,
+			device_printf(sc-&gt;xl_dev,
 			    &quot;guessing 10BaseT transceiver\n&quot;);
 		break;
 	case TC_DEVICEID_BOOMERANG_10BT_COMBO:	/* 3c900-COMBO */
@@ -1145,20 +1144,20 @@
 		sc-&gt;xl_media = XL_MEDIAOPT_BT|XL_MEDIAOPT_BNC|XL_MEDIAOPT_AUI;
 		sc-&gt;xl_xcvr = XL_XCVR_10BT;
 		if (verbose)
-			if_printf(sc-&gt;xl_ifp,
+			device_printf(sc-&gt;xl_dev,
 			    &quot;guessing COMBO (AUI/BNC/TP)\n&quot;);
 		break;
 	case TC_DEVICEID_KRAKATOA_10BT_TPC:	/* 3c900B-TPC */
 		sc-&gt;xl_media = XL_MEDIAOPT_BT|XL_MEDIAOPT_BNC;
 		sc-&gt;xl_xcvr = XL_XCVR_10BT;
 		if (verbose)
-			if_printf(sc-&gt;xl_ifp, &quot;guessing TPC (BNC/TP)\n&quot;);
+			device_printf(sc-&gt;xl_dev, &quot;guessing TPC (BNC/TP)\n&quot;);
 		break;
 	case TC_DEVICEID_CYCLONE_10FL:		/* 3c900B-FL */
 		sc-&gt;xl_media = XL_MEDIAOPT_10FL;
 		sc-&gt;xl_xcvr = XL_XCVR_AUI;
 		if (verbose)
-			if_printf(sc-&gt;xl_ifp, &quot;guessing 10baseFL\n&quot;);
+			device_printf(sc-&gt;xl_dev, &quot;guessing 10baseFL\n&quot;);
 		break;
 	case TC_DEVICEID_BOOMERANG_10_100BT:	/* 3c905-TX */
 	case TC_DEVICEID_HURRICANE_555:		/* 3c555 */
@@ -1175,15 +1174,14 @@
 		sc-&gt;xl_media = XL_MEDIAOPT_MII;
 		sc-&gt;xl_xcvr = XL_XCVR_MII;
 		if (verbose)
-			if_printf(sc-&gt;xl_ifp, &quot;guessing MII\n&quot;);
+			device_printf(sc-&gt;xl_dev, &quot;guessing MII\n&quot;);
 		break;
 	case TC_DEVICEID_BOOMERANG_100BT4:	/* 3c905-T4 */
 	case TC_DEVICEID_CYCLONE_10_100BT4:	/* 3c905B-T4 */
 		sc-&gt;xl_media = XL_MEDIAOPT_BT4;
 		sc-&gt;xl_xcvr = XL_XCVR_MII;
 		if (verbose)
-			if_printf(sc-&gt;xl_ifp,
-			    &quot;guessing 100baseT4/MII\n&quot;);
+			device_printf(sc-&gt;xl_dev, &quot;guessing 100baseT4/MII\n&quot;);
 		break;
 	case TC_DEVICEID_HURRICANE_10_100BT:	/* 3c905B-TX */
 	case TC_DEVICEID_HURRICANE_10_100BT_SERV:/*3c980-TX */
@@ -1194,18 +1192,17 @@
 		sc-&gt;xl_media = XL_MEDIAOPT_BTX;
 		sc-&gt;xl_xcvr = XL_XCVR_AUTO;
 		if (verbose)
-			if_printf(sc-&gt;xl_ifp,
-			    &quot;guessing 10/100 internal\n&quot;);
+			device_printf(sc-&gt;xl_dev, &quot;guessing 10/100 internal\n&quot;);
 		break;
 	case TC_DEVICEID_CYCLONE_10_100_COMBO:	/* 3c905B-COMBO */
 		sc-&gt;xl_media = XL_MEDIAOPT_BTX|XL_MEDIAOPT_BNC|XL_MEDIAOPT_AUI;
 		sc-&gt;xl_xcvr = XL_XCVR_AUTO;
 		if (verbose)
-			if_printf(sc-&gt;xl_ifp,
+			device_printf(sc-&gt;xl_dev,
 			    &quot;guessing 10/100 plus BNC/AUI\n&quot;);
 		break;
 	default:
-		if_printf(sc-&gt;xl_ifp,
+		device_printf(sc-&gt;xl_dev,
 		    &quot;unknown device ID: %x -- defaulting to 10baseT\n&quot;, devid);
 		sc-&gt;xl_media = XL_MEDIAOPT_BT;
 		break;
@@ -1228,6 +1225,8 @@
 	uint16_t		did;
 
 	sc = device_get_softc(dev);
+	sc-&gt;xl_dev = dev;
+	
 	unit = device_get_unit(dev);
 
 	mtx_init(&amp;sc-&gt;xl_mtx, device_get_nameunit(dev), MTX_NETWORK_LOCK,
@@ -1250,13 +1249,18 @@
 	if (did == TC_DEVICEID_HURRICANE_556B)
 		sc-&gt;xl_flags |= XL_FLAG_NO_XCVR_PWR;
 
+	if (did == TC_DEVICEID_HURRICANE_575B ||
+	    did == TC_DEVICEID_HURRICANE_575C ||
+	    did == TC_DEVICEID_HURRICANE_656B ||
+	    did == TC_DEVICEID_TORNADO_656C)
+		sc-&gt;xl_flags |= XL_FLAG_FUNCREG;
 	if (did == TC_DEVICEID_HURRICANE_575A ||
 	    did == TC_DEVICEID_HURRICANE_575B ||
 	    did == TC_DEVICEID_HURRICANE_575C ||
 	    did == TC_DEVICEID_HURRICANE_656B ||
 	    did == TC_DEVICEID_TORNADO_656C)
-		sc-&gt;xl_flags |= XL_FLAG_FUNCREG | XL_FLAG_PHYOK |
-		    XL_FLAG_EEPROM_OFFSET_30 | XL_FLAG_8BITROM;
+		sc-&gt;xl_flags |= XL_FLAG_PHYOK | XL_FLAG_EEPROM_OFFSET_30 |
+		  XL_FLAG_8BITROM;
 	if (did == TC_DEVICEID_HURRICANE_656)
 		sc-&gt;xl_flags |= XL_FLAG_FUNCREG | XL_FLAG_PHYOK;
 	if (did == TC_DEVICEID_HURRICANE_575B)
@@ -1322,7 +1326,7 @@
 		    RF_ACTIVE);
 
 		if (sc-&gt;xl_fres == NULL) {
-			device_printf(dev, &quot;couldn't map ports/memory\n&quot;);
+			device_printf(dev, &quot;couldn't map funcreg memory\n&quot;);
 			error = ENXIO;
 			goto fail;
 		}
@@ -1376,7 +1380,7 @@
 	 * All of our lists are allocated as a contiguous block
 	 * of memory.
 	 */
-	error = bus_dma_tag_create(NULL, 8, 0,
+	error = bus_dma_tag_create(bus_get_dma_tag(dev), 8, 0,
 	    BUS_SPACE_MAXADDR_32BIT, BUS_SPACE_MAXADDR, NULL, NULL,
 	    XL_RX_LIST_SZ, 1, XL_RX_LIST_SZ, 0, NULL, NULL,
 	    &amp;sc-&gt;xl_ldata.xl_rx_tag);
@@ -1408,7 +1412,7 @@
 		goto fail;
 	}
 
-	error = bus_dma_tag_create(NULL, 8, 0,
+	error = bus_dma_tag_create(bus_get_dma_tag(dev), 8, 0,
 	    BUS_SPACE_MAXADDR_32BIT, BUS_SPACE_MAXADDR, NULL, NULL,
 	    XL_TX_LIST_SZ, 1, XL_TX_LIST_SZ, 0, NULL, NULL,
 	    &amp;sc-&gt;xl_ldata.xl_tx_tag);
@@ -1443,7 +1447,7 @@
 	/*
 	 * Allocate a DMA tag for the mapping of mbufs.
 	 */
-	error = bus_dma_tag_create(NULL, 1, 0,
+	error = bus_dma_tag_create(bus_get_dma_tag(dev), 1, 0,
 	    BUS_SPACE_MAXADDR_32BIT, BUS_SPACE_MAXADDR, NULL, NULL,
 	    MCLBYTES * XL_MAXFRAGS, XL_MAXFRAGS, MCLBYTES, 0, NULL,
 	    NULL, &amp;sc-&gt;xl_mtag);
@@ -1477,7 +1481,6 @@
 	/* Set the TX start threshold for best performance. */
 	sc-&gt;xl_tx_thresh = XL_MIN_FRAMELEN;
 
-	ifp-&gt;if_mtu = ETHERMTU;
 	ifp-&gt;if_flags = IFF_BROADCAST | IFF_SIMPLEX | IFF_MULTICAST;
 	ifp-&gt;if_ioctl = xl_ioctl;
 	ifp-&gt;if_capabilities = IFCAP_VLAN_MTU;
@@ -1494,7 +1497,6 @@
 	ifp-&gt;if_capabilities |= IFCAP_POLLING;
 #endif
 	ifp-&gt;if_start = xl_start;
-	ifp-&gt;if_watchdog = xl_watchdog;
 	ifp-&gt;if_init = xl_init;
 	IFQ_SET_MAXLEN(&amp;ifp-&gt;if_snd, XL_TX_LIST_CNT - 1);
 	ifp-&gt;if_snd.ifq_drv_maxlen = XL_TX_LIST_CNT - 1;
@@ -1604,7 +1606,7 @@
 	ether_ifattach(ifp, eaddr);
 
 	error = bus_setup_intr(dev, sc-&gt;xl_irq, INTR_TYPE_NET | INTR_MPSAFE,
-	    xl_intr, sc, &amp;sc-&gt;xl_intrhand);
+	    NULL, xl_intr, sc, &amp;sc-&gt;xl_intrhand);
 	if (error) {
 		device_printf(dev, &quot;couldn't set up irq\n&quot;);
 		ether_ifdetach(ifp);
@@ -1658,7 +1660,7 @@
 		*media = IFM_ETHER|IFM_100_FX;
 		break;
 	default:
-		if_printf(sc-&gt;xl_ifp, &quot;unknown XCVR type: %d\n&quot;,
+		device_printf(sc-&gt;xl_dev, &quot;unknown XCVR type: %d\n&quot;,
 		    sc-&gt;xl_xcvr);
 		/*
 		 * This will probably be wrong, but it prevents
@@ -1713,8 +1715,6 @@
 		callout_drain(&amp;sc-&gt;xl_stat_callout);
 		ether_ifdetach(ifp);
 	}
-	if (ifp)
-		if_free(ifp);
 	if (sc-&gt;xl_miibus)
 		device_delete_child(dev, sc-&gt;xl_miibus);
 	bus_generic_detach(dev);
@@ -1730,6 +1730,9 @@
 	if (sc-&gt;xl_res)
 		bus_release_resource(dev, res, rid, sc-&gt;xl_res);
 
+	if (ifp)
+		if_free(ifp);
+
 	if (sc-&gt;xl_mtag) {
 		bus_dmamap_destroy(sc-&gt;xl_mtag, sc-&gt;xl_tmpmap);
 		bus_dma_tag_destroy(sc-&gt;xl_mtag);
@@ -1905,7 +1908,7 @@
 	    xl_dma_map_rxbuf, &amp;baddr, BUS_DMA_NOWAIT);
 	if (error) {
 		m_freem(m_new);
-		if_printf(sc-&gt;xl_ifp, &quot;can't map mbuf (error %d)\n&quot;,
+		device_printf(sc-&gt;xl_dev, &quot;can't map mbuf (error %d)\n&quot;,
 		    error);
 		return (error);
 	}
@@ -2004,7 +2007,7 @@
 		 * If not, something truly strange has happened.
 		 */
 		if (!(rxstat &amp; XL_RXSTAT_UP_CMPLT)) {
-			if_printf(ifp,
+			device_printf(sc-&gt;xl_dev,
 			    &quot;bad receive status -- packet dropped\n&quot;);
 			ifp-&gt;if_ierrors++;
 			cur_rx-&gt;xl_ptr-&gt;xl_status = 0;
@@ -2099,12 +2102,10 @@
 {
 	struct xl_softc *sc = (struct xl_softc *)arg;
 
-	NET_LOCK_GIANT();
 	XL_LOCK(sc);
 	if (sc-&gt;xl_ifp-&gt;if_drv_flags &amp; IFF_DRV_RUNNING)
 		xl_rxeof(sc);
 	XL_UNLOCK(sc);
-	NET_UNLOCK_GIANT();
 }
 
 /*
@@ -2148,8 +2149,7 @@
 
 	if (sc-&gt;xl_cdata.xl_tx_head == NULL) {
 		ifp-&gt;if_drv_flags &amp;= ~IFF_DRV_OACTIVE;
-		/* Clear the timeout timer. */
-		ifp-&gt;if_timer = 0;
+		sc-&gt;xl_wdog_timer = 0;
 		sc-&gt;xl_cdata.xl_tx_tail = NULL;
 	} else {
 		if (CSR_READ_4(sc, XL_DMACTL) &amp; XL_DMACTL_DOWN_STALLED ||
@@ -2196,7 +2196,7 @@
 	}
 
 	if (sc-&gt;xl_cdata.xl_tx_cnt == 0)
-		ifp-&gt;if_timer = 0;
+		sc-&gt;xl_wdog_timer = 0;
 	sc-&gt;xl_cdata.xl_tx_cons = idx;
 
 	if (cur_tx != NULL)
@@ -2219,7 +2219,7 @@
 		if (txstat &amp; XL_TXSTATUS_UNDERRUN ||
 			txstat &amp; XL_TXSTATUS_JABBER ||
 			txstat &amp; XL_TXSTATUS_RECLAIM) {
-			if_printf(sc-&gt;xl_ifp,
+			device_printf(sc-&gt;xl_dev,
 			    &quot;transmission error: %x\n&quot;, txstat);
 			CSR_WRITE_2(sc, XL_COMMAND, XL_CMD_TX_RESET);
 			xl_wait(sc);
@@ -2247,7 +2247,7 @@
 			if (txstat &amp; XL_TXSTATUS_UNDERRUN &amp;&amp;
 			    sc-&gt;xl_tx_thresh &lt; XL_PACKET_SIZE) {
 				sc-&gt;xl_tx_thresh += XL_MIN_FRAMELEN;
-				if_printf(sc-&gt;xl_ifp,
+				device_printf(sc-&gt;xl_dev,
 &quot;tx underrun, increasing tx start threshold to %d bytes\n&quot;, sc-&gt;xl_tx_thresh);
 			}
 			CSR_WRITE_2(sc, XL_COMMAND,
@@ -2286,17 +2286,11 @@
 	}
 #endif
 
-#ifndef __HAIKU__
 	while ((status = CSR_READ_2(sc, XL_STATUS)) &amp; XL_INTRS &amp;&amp;
 	    status != 0xFFFF) {
 		CSR_WRITE_2(sc, XL_COMMAND,
 		    XL_CMD_INTR_ACK|(status &amp; XL_INTRS));
-#else
-	status = atomic_and((int32 *)&amp;sc-&gt;xl_intr_status, 0);
-//	if (status &amp; XL_INTRS)
-//		dprintf(&quot;GOT %x\n&quot;, status &amp; XL_INTRS);
-	if ((status &amp; XL_INTRS) != 0 &amp;&amp; status != 0xFFFF) {
-#endif
+
 		if (status &amp; XL_STAT_UP_COMPLETE) {
 			int	curpkts;
 
@@ -2412,6 +2406,10 @@
 	struct xl_softc *sc = xsc;
 
 	XL_LOCK_ASSERT(sc);
+
+	if (xl_watchdog(sc) == EJUSTRETURN)
+		return;
+
 	xl_stats_update_locked(sc);
 }
 
@@ -2667,7 +2665,7 @@
 	/*
 	 * Set a timeout in case the chip goes out to lunch.
 	 */
-	ifp-&gt;if_timer = 5;
+	sc-&gt;xl_wdog_timer = 5;
 
 	/*
 	 * XXX Under certain conditions, usually on slower machines
@@ -2765,7 +2763,7 @@
 	/*
 	 * Set a timeout in case the chip goes out to lunch.
 	 */
-	ifp-&gt;if_timer = 5;
+	sc-&gt;xl_wdog_timer = 5;
 }
 
 static void
@@ -2808,7 +2806,7 @@
 	XL_SEL_WIN(2);
 	for (i = 0; i &lt; ETHER_ADDR_LEN; i++) {
 		CSR_WRITE_1(sc, XL_W2_STATION_ADDR_LO + i,
-				IFP2ENADDR(sc-&gt;xl_ifp)[i]);
+				IF_LLADDR(sc-&gt;xl_ifp)[i]);
 	}
 
 	/* Clear the station mask. */
@@ -2824,7 +2822,7 @@
 	/* Init circular RX list. */
 	error = xl_list_rx_init(sc);
 	if (error) {
-		if_printf(ifp, &quot;initialization of the rx ring failed (%d)\n&quot;,
+		device_printf(sc-&gt;xl_dev, &quot;initialization of the rx ring failed (%d)\n&quot;,
 		    error);
 		xl_stop(sc);
 		return;
@@ -2836,7 +2834,7 @@
 	else
 		error = xl_list_tx_init(sc);
 	if (error) {
-		if_printf(ifp, &quot;initialization of the tx ring failed (%d)\n&quot;,
+		device_printf(sc-&gt;xl_dev, &quot;initialization of the tx ring failed (%d)\n&quot;,
 		    error);
 		xl_stop(sc);
 		return;
@@ -3000,6 +2998,7 @@
 	ifp-&gt;if_drv_flags |= IFF_DRV_RUNNING;
 	ifp-&gt;if_drv_flags &amp;= ~IFF_DRV_OACTIVE;
 
+	sc-&gt;xl_wdog_timer = 0;
 	callout_reset(&amp;sc-&gt;xl_stat_callout, hz, xl_stats_update, sc);
 }
 
@@ -3232,24 +3231,25 @@
 	return (error);
 }
 
-/*
- * XXX: Invoked from ifnet slow timer. Lock coverage needed.
- */
-static void
-xl_watchdog(struct ifnet *ifp)
+static int
+xl_watchdog(struct xl_softc *sc)
 {
-	struct xl_softc		*sc = ifp-&gt;if_softc;
+	struct ifnet		*ifp = sc-&gt;xl_ifp;
 	u_int16_t		status = 0;
 
-	XL_LOCK(sc);
+	XL_LOCK_ASSERT(sc);
 
+	if (sc-&gt;xl_wdog_timer == 0 || --sc-&gt;xl_wdog_timer != 0)
+		return (0);
+
 	ifp-&gt;if_oerrors++;
 	XL_SEL_WIN(4);
 	status = CSR_READ_2(sc, XL_W4_MEDIA_STATUS);
-	if_printf(ifp, &quot;watchdog timeout\n&quot;);
+	device_printf(sc-&gt;xl_dev, &quot;watchdog timeout\n&quot;);
 
 	if (status &amp; XL_MEDIASTAT_CARRIER)
-		if_printf(ifp, &quot;no carrier - transceiver cable problem?\n&quot;);
+		device_printf(sc-&gt;xl_dev,
+		    &quot;no carrier - transceiver cable problem?\n&quot;);
 
 	xl_txeoc(sc);
 	xl_txeof(sc);
@@ -3264,7 +3264,7 @@
 			xl_start_locked(ifp);
 	}
 
-	XL_UNLOCK(sc);
+	return (EJUSTRETURN);
 }
 
 /*
@@ -3279,7 +3279,7 @@
 
 	XL_LOCK_ASSERT(sc);
 
-	ifp-&gt;if_timer = 0;
+	sc-&gt;xl_wdog_timer = 0;
 
 	CSR_WRITE_2(sc, XL_COMMAND, XL_CMD_RX_DISABLE);
 	CSR_WRITE_2(sc, XL_COMMAND, XL_CMD_STATS_DISABLE);

Modified: haiku/trunk/src/add-ons/kernel/drivers/network/3com/pci/if_xlreg.h
===================================================================
--- haiku/trunk/src/add-ons/kernel/drivers/network/3com/pci/if_xlreg.h	2007-11-24 15:43:46 UTC (rev 22990)
+++ haiku/trunk/src/add-ons/kernel/drivers/network/3com/pci/if_xlreg.h	2007-11-25 11:29:29 UTC (rev 22991)
@@ -29,7 +29,7 @@
  * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF
  * THE POSSIBILITY OF SUCH DAMAGE.
  *
- * $FreeBSD: src/sys/pci/if_xlreg.h,v 1.55.2.1 2005/08/26 14:46:22 jhb Exp $
+ * $FreeBSD: src/sys/pci/if_xlreg.h,v 1.59 2006/12/06 02:18:41 marius Exp $
  */
 
 #define XL_EE_READ	0x0080	/* read, 5 bit address */
@@ -581,6 +581,7 @@
 
 struct xl_softc {
 	struct ifnet		*xl_ifp;	/* interface info */
+	device_t		xl_dev;		/* device info */
 	struct ifmedia		ifmedia;	/* media info */
 	bus_space_handle_t	xl_bhandle;
 	bus_space_tag_t		xl_btag;
@@ -602,6 +603,7 @@
 	struct xl_list_data	xl_ldata;
 	struct xl_chain_data	xl_cdata;
 	struct callout		xl_stat_callout;
+	int			xl_wdog_timer;
 	int			xl_flags;
 	struct resource		*xl_fres;
 	bus_space_handle_t	xl_fhandle;
@@ -612,7 +614,7 @@
 	int			rxcycles;
 #endif
 #ifdef __HAIKU__
-	u_int32_t		xl_intr_status;
+	u_int32_t	xl_intr_status;
 #endif
 };
 

Modified: haiku/trunk/src/add-ons/kernel/drivers/network/ipro1000/dev/em/Jamfile
===================================================================
--- haiku/trunk/src/add-ons/kernel/drivers/network/ipro1000/dev/em/Jamfile	2007-11-24 15:43:46 UTC (rev 22990)
+++ haiku/trunk/src/add-ons/kernel/drivers/network/ipro1000/dev/em/Jamfile	2007-11-25 11:29:29 UTC (rev 22991)
@@ -8,8 +8,21 @@
 SubDirCcFlags [ FDefines _KERNEL=1 FBSD_DRIVER=1 EM_FAST_INTR=1 ] ;
 
 KernelAddon e1000 :
+	e1000_80003es2lan.c
+	e1000_82540.c
+	e1000_82541.c
+	e1000_82542.c
+	e1000_82543.c
+	e1000_82571.c
+	e1000_82575.c
+	e1000_api.c
+	e1000_ich8lan.c
+	e1000_mac.c
+	e1000_manage.c
+	e1000_nvm.c
+	e1000_phy.c
 	if_em.c
-	if_em_hw.c
+
 	glue.c
 	: libfreebsd_network.a
 	;

Modified: haiku/trunk/src/add-ons/kernel/drivers/network/ipro1000/dev/em/LICENSE
===================================================================
--- haiku/trunk/src/add-ons/kernel/drivers/network/ipro1000/dev/em/LICENSE	2007-11-24 15:43:46 UTC (rev 22990)
+++ haiku/trunk/src/add-ons/kernel/drivers/network/ipro1000/dev/em/LICENSE	2007-11-25 11:29:29 UTC (rev 22991)
@@ -1,31 +1,31 @@
-$FreeBSD: src/sys/dev/em/LICENSE,v 1.3.2.1 2006/08/08 09:20:26 glebius Exp $
-/*-
-Copyright (c) 2001-2005, Intel Corporation 
-All rights reserved.
+$FreeBSD: src/sys/dev/em/LICENSE,v 1.6 2007/05/04 00:00:11 jfv Exp $
 
-Redistribution and use in source and binary forms, with or without 
-modification, are permitted provided that the following conditions are met:
+  Copyright (c) 2001-2007, Intel Corporation 
+  All rights reserved.
+  
+  Redistribution and use in source and binary forms, with or without 
+  modification, are permitted provided that the following conditions are met:
+  
+   1. Redistributions of source code must retain the above copyright notice, 
+      this list of conditions and the following disclaimer.
+  
+   2. Redistributions in binary form must reproduce the above copyright 
+      notice, this list of conditions and the following disclaimer in the 
+      documentation and/or other materials provided with the distribution.
+  
+   3. Neither the name of the Intel Corporation nor the names of its 
+      contributors may be used to endorse or promote products derived from 
+      this software without specific prior written permission.
+  
+  THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS &quot;AS IS&quot;
+  AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE 
+  IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE 
+  ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE 
+  LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR 
+  CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF 
+  SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS 
+  INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN 
+  CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) 
+  ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE
+  POSSIBILITY OF SUCH DAMAGE.
 
- 1. Redistributions of source code must retain the above copyright notice, 
-    this list of conditions and the following disclaimer.
-
- 2. Redistributions in binary form must reproduce the above copyright 
-    notice, this list of conditions and the following disclaimer in the 
-    documentation and/or other materials provided with the distribution.
-
- 3. Neither the name of the Intel Corporation nor the names of its 
-    contributors may be used to endorse or promote products derived from 
-    this software without specific prior written permission.
-
-THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS &quot;AS IS&quot;
-AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE 
-IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE 
-ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE 
-LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR 
-CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF 
-SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS 
-INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN 
-CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) 
-ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE
-POSSIBILITY OF SUCH DAMAGE.
-*/

Modified: haiku/trunk/src/add-ons/kernel/drivers/network/ipro1000/dev/em/README
===================================================================
--- haiku/trunk/src/add-ons/kernel/drivers/network/ipro1000/dev/em/README	2007-11-24 15:43:46 UTC (rev 22990)
+++ haiku/trunk/src/add-ons/kernel/drivers/network/ipro1000/dev/em/README	2007-11-25 11:29:29 UTC (rev 22991)
@@ -1,8 +1,8 @@
-$FreeBSD: src/sys/dev/em/README,v 1.10.2.1 2006/08/08 09:20:26 glebius Exp $
-FreeBSD* Driver for the Intel(R) PRO/1000 Family of Adapters
-============================================================
+$FreeBSD: src/sys/dev/em/README,v 1.15 2007/05/30 23:32:21 jfv Exp $
+FreeBSD* Driver for Intel Network Connection
+=============================================
 
-May 2, 2006
+May 30, 2007
 
 
 Contents
@@ -21,11 +21,11 @@
 Overview
 ========
 
-This file describes the FreeBSD* driver for the Intel(R) PRO/1000 Family of
-Adapters. This driver has been developed for use with FreeBSD, Release 6.x.
+This file describes the FreeBSD* driver for Intel Network Connection.
+This driver has been developed for use with FreeBSD, Release 7.x.
 
 For questions related to hardware requirements, refer to the documentation
-supplied with your Intel PRO/1000 adapter. All hardware requirements listed
+supplied with your Gigabit adapter. All hardware requirements listed
 apply to use with FreeBSD.
 
 
@@ -62,7 +62,7 @@
 
 2. Untar/unzip the archive:
 
-        tar xvfz em-x.x.x.tar.gz
+        tar xzvf em-x.x.x.tar.gz
 
    This will create an em-x.x.x directory.
 
@@ -74,7 +74,7 @@
                   cd em-x.x.x
                   make
 
-        b. To install the compiled module in system directory:
+        b. To install the compiled module to the system directory:
 
                   make install
 
@@ -84,35 +84,19 @@
 
                   if_em_load=&quot;YES&quot;
 
-4. To compile the driver into the kernel:
+4. To compile the driver into the kernel, enter:
 
         cd em-x.x.x/src
+        cp *.[ch] /usr/src/sys/dev/em
 
-        cp if_em* /usr/src/sys/dev/em
+        Edit the kernel configuration file (i.e., GENERIC or MYKERNEL) in
+        /usr/src/sys/i386/conf, and ensure the following line is present:
 
-        cp Makefile.kernel /usr/src/sys/modules/em/Makefile
-
-   Edit the /usr/src/sys/conf/files file, and add the following lines only if
-   they don't already exist:
-
-        dev/em/if_em.c optional em
-
-        dev/em/if_em_hw.c optional em
-
-   Remove the following lines from the /usr/src/sys/conf/files file,
-   if they exist:
-
-        dev/em/if_em_fxhw.c optional em
-        dev/em/if_em_phy.c optional em
-
-   Edit the kernel configuration file (i.e., GENERIC or MYKERNEL) in
-   /usr/src/sys/i386/conf, and ensure the following line is present:
-
         device em
 
-   Compile and install the kernel. The system must be rebooted for the kernel
-   updates to take effect. For additional information on compiling the
-   kernel, consult the FreeBSD operating system documentation.
+        Compile and install the kernel. The system must be rebooted for the
+        kernel updates to take effect. For additional information on compiling
+        the kernel, consult the FreeBSD operating system documentation.
 
 5. To assign an IP address to the interface, enter the following:
 
@@ -150,7 +134,13 @@
          not specified and you are not running at gigabit speed, the driver
          defaults to half-duplex.
 
+If the interface is currently forced to 100 full duplex, in order to change
+to half duplex you must use this command:
 
+        ifconfig em&lt;interface_num&gt; &lt;IP_address&gt; media 100baseTX -mediaopt
+            full-duplex
+
+
 This driver supports the following media type options:
 
    autoselect      -  Enables auto-negotiation for speed and duplex.
@@ -207,13 +197,15 @@
   - Some Intel gigabit adapters that support Jumbo Frames have a frame size
     limit of 9238 bytes, with a corresponding MTU size limit of 9216 bytes.
     The adapters with this limitation are based on the Intel(R) 82571EB,
-    82572EI, 82573L and 80003ES2LAN controller.  These correspond to the
-    following product names:
+    82572EI, 82573L, 82566, 82562, and 80003ES2LAN controller.  These
+    correspond to the following product names:
      Intel(R) PRO/1000 PT Server Adapter
      Intel(R) PRO/1000 PT Desktop Adapter
      Intel(R) PRO/1000 PT Network Connection
      Intel(R) PRO/1000 PT Dual Port Server Adapter
      Intel(R) PRO/1000 PT Dual Port Network Connection
+     Intel(R) PRO/1000 PT Quad Port Server Adapter
+     Intel(R) PRO/1000 PF Quad Port Server Adapter
      Intel(R) PRO/1000 PF Server Adapter
      Intel(R) PRO/1000 PF Network Connection
      Intel(R) PRO/1000 PF Dual Port Server Adapter
@@ -221,6 +213,7 @@
      Intel(R) PRO/1000 PL Network Connection
      Intel(R) PRO/1000 EB Network Connection with I/O Acceleration
      Intel(R) PRO/1000 EB Backplane Connection with I/O Acceleration
+     Intel(R) 82566DM-2 Gigabit Network Connection
 
   - Adapters based on the Intel(R) 82542 and 82573V/E controller do not
     support Jumbo Frames. These correspond to the following product names:
@@ -236,8 +229,13 @@
     Intel(R) 82566DC Gigabit Network Connection
     Intel(R) 82566MM Gigabit Network Connection
     Intel(R) 82566MC Gigabit Network Connection
+    Intel(R) 82562GT 10/100 Network Connection
+    Intel(R) 82562G 10/100 Network Connection
+    Intel(R) 82566DC-2 Gigabit Network Connection
+    Intel(R) 82562V-2 10/100 Network Connection
+    Intel(R) 82562G-2 10/100 Network Connection
+    Intel(R) 82562GT-2 10/100 Network Connection
 
-
   VLANs
   -----
   To create a new VLAN interface:
@@ -252,18 +250,19 @@
 
   Example:
 
-        ifconfig vlan10 10.0.0.1 netmask 255.255.255.0 vlan10 vlandev em0
+        ifconfig vlan10 10.0.0.1 netmask 255.255.255.0 vlan 10 vlandev em0
 
-  In this example, all packets will be marked on egress with  802.1Q VLAN
+  In this example, all packets will be marked on egress with 802.1Q VLAN
   tags, specifying a VLAN ID of 10.
 
   To remove a VLAN interface:
 
-        ifconfig &lt;vlan_name&gt; destroy
+  Intel Network Connection        ifconfig &lt;vlan_name&gt; destroy
 
 
   Polling
   -------
+
   To enable polling in the driver, add the following options to the kernel
   configuration, and then recompile the kernel:
 
@@ -271,9 +270,9 @@
         options HZ=1000
 
   At runtime use:
-        ifconfig em0 polling to turn polling on
-  Use:
-        ifconfig em0 -polling to turn polling off
+        ifconfig emX polling (to turn polling on)
+  and:
+        ifconfig emX -polling  (to turn it off)
 
 
   Checksum Offload
@@ -306,17 +305,50 @@
   See the ifconfig man page for further information.
 
 
+  TSO
+  ---
+  The FreeBSD driver offers support for TSO (TCP Segmentation Offload).
+
+  You can enable/disable it in two ways/places:
+
+        -  sysctl net.inet.tcp.tso=0    (or 1 to enable it)
+
+  Doing this disables TSO in the stack and will affect all adapters.
+
+        -  ifconfig emX -tso
+
+  Doing this will disable TSO only for this adapter.
+
+  To enable:
+
+        -  ifconfig emX tso
+
+  NOTES: By default only PCI-Express adapters are ENABLED to do TSO. Others
+  can be enabled by the user at their own risk
+  TSO is not supported on 82547 and 82544-based adapters, as well as older adapters.
+
+
 Known Limitations
 =================
 
-  In FreeBSD version 4.x with Symmetric MultiProcessing (SMP), there is a known
-  issue on some newer hardware.  The problem is generic kernel and only in SMP
-  mode.  The workaround is to either use FreeBSD version 4.x in single processor
-  mode, or use FreeBSD 5.4 or later.
+  Detected Tx Unit Hang in Quad Port Adapters
+  -------------------------------------------
 
+  In some cases ports 3 and 4 wont pass traffic. Ports 1 and 2 don't show
+  any errors and will pass traffic.
+
+  This issue MAY be resolved by updating to the latest BIOS. You can
+  check your system's BIOS by downloading the Linux Firmware Developer Kit
+  that can be obtained at <A HREF="http://www.linuxfirmwarekit.org/">http://www.linuxfirmwarekit.org/</A>
+
+
   There are known performance issues with this driver when running UDP traffic
   with Jumbo Frames.
+  ----------------------------------------------------------------------------
 
+  82541/82547 can't link or is slow to link with some link partners
+  -----------------------------------------------------------------
+
   There is a known compatibility issue where time to link is slow or link is not
   established between 82541/82547 controllers and some switches.  Known switches
   include:
@@ -325,12 +357,12 @@
 
   The driver can be compiled with the following changes:
 
-  Edit ./em.x.x.x/src/if_em.h to uncomment the #define EM_MASTER_SLAVE
-  from within the comments.  For example, change from:
+  Edit ./em.x.x.x/src/if_em.h to change the #define EM_MASTER_SLAVE
+  For example, change from:
 
-      /* #define EM_MASTER_SLAVE  2 */
+      #define EM_MASTER_SLAVE   e1000_ms_hw_default
   to:
-      #define EM_MASTER_SLAVE  2
+      #define EM_MASTER_SLAVE   2
 
   Use one of the following options:
       1 = Master mode

Added: haiku/trunk/src/add-ons/kernel/drivers/network/ipro1000/dev/em/e1000_80003es2lan.c
===================================================================
--- haiku/trunk/src/add-ons/kernel/drivers/network/ipro1000/dev/em/e1000_80003es2lan.c	2007-11-24 15:43:46 UTC (rev 22990)
+++ haiku/trunk/src/add-ons/kernel/drivers/network/ipro1000/dev/em/e1000_80003es2lan.c	2007-11-25 11:29:29 UTC (rev 22991)
@@ -0,0 +1,1339 @@
+/*******************************************************************************
+
+  Copyright (c) 2001-2007, Intel Corporation 
+  All rights reserved.
+  
+  Redistribution and use in source and binary forms, with or without 
+  modification, are permitted provided that the following conditions are met:
+  
+   1. Redistributions of source code must retain the above copyright notice, 
+      this list of conditions and the following disclaimer.
+  
+   2. Redistributions in binary form must reproduce the above copyright 
+      notice, this list of conditions and the following disclaimer in the 
+      documentation and/or other materials provided with the distribution.
+  
+   3. Neither the name of the Intel Corporation nor the names of its 
+      contributors may be used to endorse or promote products derived from 
+      this software without specific prior written permission.
+  
+  THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS &quot;AS IS&quot;
+  AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE 
+  IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE 
+  ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE 
+  LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR 
+  CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF 
+  SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS 
+  INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN 
+  CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) 
+  ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE
+  POSSIBILITY OF SUCH DAMAGE.
+
+*******************************************************************************/
+/*$FreeBSD: src/sys/dev/em/e1000_80003es2lan.c,v 1.3 2007/05/16 00:14:23 jfv Exp $*/
+
+/* e1000_80003es2lan
+ */
+
+#include &quot;e1000_api.h&quot;
+#include &quot;e1000_80003es2lan.h&quot;
+
+void e1000_init_function_pointers_80003es2lan(struct e1000_hw *hw);
+
+STATIC s32  e1000_init_phy_params_80003es2lan(struct e1000_hw *hw);
+STATIC s32  e1000_init_nvm_params_80003es2lan(struct e1000_hw *hw);
+STATIC s32  e1000_init_mac_params_80003es2lan(struct e1000_hw *hw);
+STATIC s32  e1000_acquire_phy_80003es2lan(struct e1000_hw *hw);
+STATIC void e1000_release_phy_80003es2lan(struct e1000_hw *hw);
+STATIC s32  e1000_acquire_nvm_80003es2lan(struct e1000_hw *hw);
+STATIC void e1000_release_nvm_80003es2lan(struct e1000_hw *hw);
+STATIC s32  e1000_read_phy_reg_gg82563_80003es2lan(struct e1000_hw *hw,
+                                                   u32 offset,
+                                                   u16 *data);
+STATIC s32  e1000_write_phy_reg_gg82563_80003es2lan(struct e1000_hw *hw,
+                                                    u32 offset,
+                                                    u16 data);
+STATIC s32  e1000_write_nvm_80003es2lan(struct e1000_hw *hw, u16 offset,
+                                        u16 words, u16 *data);
+STATIC s32  e1000_get_cfg_done_80003es2lan(struct e1000_hw *hw);
+STATIC s32  e1000_phy_force_speed_duplex_80003es2lan(struct e1000_hw *hw);
+STATIC s32  e1000_get_cable_length_80003es2lan(struct e1000_hw *hw);
+STATIC s32  e1000_get_link_up_info_80003es2lan(struct e1000_hw *hw, u16 *speed,
+                                               u16 *duplex);
+STATIC s32  e1000_reset_hw_80003es2lan(struct e1000_hw *hw);
+STATIC s32  e1000_init_hw_80003es2lan(struct e1000_hw *hw);
+STATIC s32  e1000_setup_copper_link_80003es2lan(struct e1000_hw *hw);
+STATIC void e1000_clear_hw_cntrs_80003es2lan(struct e1000_hw *hw);
+static s32  e1000_acquire_swfw_sync_80003es2lan(struct e1000_hw *hw, u16 mask);
+static s32  e1000_cfg_kmrn_10_100_80003es2lan(struct e1000_hw *hw, u16 duplex);
+static s32  e1000_cfg_kmrn_1000_80003es2lan(struct e1000_hw *hw);
+static s32  e1000_copper_link_setup_gg82563_80003es2lan(struct e1000_hw *hw);
+static void e1000_initialize_hw_bits_80003es2lan(struct e1000_hw *hw);
+static void e1000_release_swfw_sync_80003es2lan(struct e1000_hw *hw, u16 mask);
+
+/* A table for the GG82563 cable length where the range is defined
+ * with a lower bound at &quot;index&quot; and the upper bound at
+ * &quot;index + 5&quot;.
+ */
+static const
+u16 e1000_gg82563_cable_length_table[] =
+         { 0, 60, 115, 150, 150, 60, 115, 150, 180, 180, 0xFF };
+#define GG82563_CABLE_LENGTH_TABLE_SIZE \
+                (sizeof(e1000_gg82563_cable_length_table) / \
+                 sizeof(e1000_gg82563_cable_length_table[0]))
+
+/**

[... truncated: 30303 lines follow ...]

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="004844.html">[Haiku-commits] r22990 - haiku/trunk/docs/develop/kernel
</A></li>
	<LI>Next message: <A HREF="004846.html">[Haiku-commits] r22992 - in	haiku/trunk/src/add-ons/kernel/drivers/network: .	marvell_yukon marvell_yukon/dev marvell_yukon/dev/mii	marvell_yukon/dev/msk
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#4845">[ date ]</a>
              <a href="thread.html#4845">[ thread ]</a>
              <a href="subject.html#4845">[ subject ]</a>
              <a href="author.html#4845">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/haiku-commits">More information about the Haiku-commits
mailing list</a><br>
</body></html>
