<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Haiku-commits] r21388 - in	haiku/trunk/src/add-ons/media/plugins/avi_reader: . libOpenDML
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/haiku-commits/2007-June/index.html" >
   <LINK REL="made" HREF="mailto:haiku-commits%40lists.berlios.de?Subject=Re%3A%20%5BHaiku-commits%5D%20r21388%20-%20in%0A%09haiku/trunk/src/add-ons/media/plugins/avi_reader%3A%20.%20libOpenDML&In-Reply-To=%3C200706102313.l5ANDT5r019359%40sheep.berlios.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="002681.html">
   <LINK REL="Next"  HREF="002684.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Haiku-commits] r21388 - in	haiku/trunk/src/add-ons/media/plugins/avi_reader: . libOpenDML</H1>
    <B>marcusoverhagen at BerliOS</B> 
    <A HREF="mailto:haiku-commits%40lists.berlios.de?Subject=Re%3A%20%5BHaiku-commits%5D%20r21388%20-%20in%0A%09haiku/trunk/src/add-ons/media/plugins/avi_reader%3A%20.%20libOpenDML&In-Reply-To=%3C200706102313.l5ANDT5r019359%40sheep.berlios.de%3E"
       TITLE="[Haiku-commits] r21388 - in	haiku/trunk/src/add-ons/media/plugins/avi_reader: . libOpenDML">marcusoverhagen at mail.berlios.de
       </A><BR>
    <I>Mon Jun 11 01:13:29 CEST 2007</I>
    <P><UL>
        <LI>Previous message: <A HREF="002681.html">[Haiku-commits] r21387 -	haiku/trunk/src/add-ons/translators/wonderbrush/support
</A></li>
        <LI>Next message: <A HREF="002684.html">[Haiku-commits] r21388 - in	haiku/trunk/src/add-ons/media/plugins/avi_reader: . libOpenDML
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2683">[ date ]</a>
              <a href="thread.html#2683">[ thread ]</a>
              <a href="subject.html#2683">[ subject ]</a>
              <a href="author.html#2683">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: marcusoverhagen
Date: 2007-06-11 01:13:28 +0200 (Mon, 11 Jun 2007)
New Revision: 21388
ViewCVS: <A HREF="http://svn.berlios.de/viewcvs/haiku?rev=21388&amp;view=rev">http://svn.berlios.de/viewcvs/haiku?rev=21388&amp;view=rev</A>

Added:
   haiku/trunk/src/add-ons/media/plugins/avi_reader/libOpenDML/FallbackIndex.cpp
   haiku/trunk/src/add-ons/media/plugins/avi_reader/libOpenDML/FallbackIndex.h
   haiku/trunk/src/add-ons/media/plugins/avi_reader/libOpenDML/Index.cpp
   haiku/trunk/src/add-ons/media/plugins/avi_reader/libOpenDML/Index.h
   haiku/trunk/src/add-ons/media/plugins/avi_reader/libOpenDML/OpenDMLIndex.cpp
   haiku/trunk/src/add-ons/media/plugins/avi_reader/libOpenDML/OpenDMLIndex.h
   haiku/trunk/src/add-ons/media/plugins/avi_reader/libOpenDML/StandardIndex.cpp
   haiku/trunk/src/add-ons/media/plugins/avi_reader/libOpenDML/StandardIndex.h
Modified:
   haiku/trunk/src/add-ons/media/plugins/avi_reader/avi_reader.cpp
   haiku/trunk/src/add-ons/media/plugins/avi_reader/avi_reader.h
   haiku/trunk/src/add-ons/media/plugins/avi_reader/libOpenDML/Jamfile
   haiku/trunk/src/add-ons/media/plugins/avi_reader/libOpenDML/OpenDMLFile.cpp
   haiku/trunk/src/add-ons/media/plugins/avi_reader/libOpenDML/OpenDMLFile.h
Log:
Preparation of seek support. Put AVI index handling into different files. Preload the full idx1 (standard) index during file opening.


Modified: haiku/trunk/src/add-ons/media/plugins/avi_reader/avi_reader.cpp
===================================================================
--- haiku/trunk/src/add-ons/media/plugins/avi_reader/avi_reader.cpp	2007-06-10 20:29:44 UTC (rev 21387)
+++ haiku/trunk/src/add-ons/media/plugins/avi_reader/avi_reader.cpp	2007-06-10 23:13:28 UTC (rev 21388)
@@ -1,5 +1,5 @@
 /*
- * Copyright (c) 2004, Marcus Overhagen
+ * Copyright (c) 2004-2007, Marcus Overhagen
  * All rights reserved.
  *
  * Redistribution and use in source and binary forms, with or without modification,
@@ -32,7 +32,7 @@
 #include &quot;RawFormats.h&quot;
 #include &quot;avi_reader.h&quot;
 
-//#define TRACE_AVI_READER
+#define TRACE_AVI_READER
 #ifdef TRACE_AVI_READER
   #define TRACE printf
 #else
@@ -71,7 +71,7 @@
 
 
 aviReader::aviReader()
- :	fFile(0)
+ :	fFile(NULL)
 {
 	TRACE(&quot;aviReader::aviReader\n&quot;);
 }
@@ -110,8 +110,8 @@
 	
 	TRACE(&quot;aviReader::Sniff: this stream seems to be supported\n&quot;);
 	
-	fFile = new OpenDMLFile();
-	if (B_OK != fFile-&gt;SetTo(pos_io_source)) {
+	fFile = new OpenDMLFile(pos_io_source);
+	if (B_OK != fFile-&gt;Init()) {
 		ERROR(&quot;aviReader::Sniff: can't setup OpenDMLFile\n&quot;);
 		return B_ERROR;
 	}
@@ -169,24 +169,24 @@
 		
 		if (audio_format-&gt;format_tag == 0x0001) {// PCM
 			cookie-&gt;frame_count = stream_header-&gt;length / ((stream_header-&gt;sample_size + 7) / 8);
-			TRACE(&quot;frame_count %Ld (is PCM)\n&quot;, cookie-&gt;frame_count);
+			TRACE(&quot;audio frame_count %Ld (is PCM)\n&quot;, cookie-&gt;frame_count);
 		} else if (stream_header-&gt;rate) { // not PCM
 			cookie-&gt;frame_count = (stream_header-&gt;length * (int64)audio_format-&gt;frames_per_sec) / stream_header-&gt;rate;
-			TRACE(&quot;frame_count %Ld (using rate)\n&quot;, cookie-&gt;frame_count);
+			TRACE(&quot;audio frame_count %Ld (using rate)\n&quot;, cookie-&gt;frame_count);
 		} else { // not PCM
 			cookie-&gt;frame_count = (stream_header-&gt;length * (int64)audio_format-&gt;frames_per_sec) / (stream_header-&gt;sample_size * audio_format-&gt;avg_bytes_per_sec);
-			TRACE(&quot;frame_count %Ld (using fallback)\n&quot;, cookie-&gt;frame_count);
+			TRACE(&quot;audio frame_count %Ld (using fallback)\n&quot;, cookie-&gt;frame_count);
 		}
 
 		if (stream_header-&gt;rate &amp;&amp; stream_header-&gt;scale) {
 			cookie-&gt;duration = (1000000LL * (int64)stream_header-&gt;length * (int64)stream_header-&gt;scale) / stream_header-&gt;rate;
-			TRACE(&quot;duration %.6f (%Ld) (using scale &amp; rate)\n&quot;, cookie-&gt;duration / 1E6, cookie-&gt;duration);
+			TRACE(&quot;audio duration %.6f (%Ld) (using scale &amp; rate)\n&quot;, cookie-&gt;duration / 1E6, cookie-&gt;duration);
 		} else if (stream_header-&gt;rate) {
 			cookie-&gt;duration = (1000000LL * (int64)stream_header-&gt;length) / stream_header-&gt;rate;
-			TRACE(&quot;duration %.6f (%Ld) (using rate)\n&quot;, cookie-&gt;duration / 1E6, cookie-&gt;duration);
+			TRACE(&quot;audio duration %.6f (%Ld) (using rate)\n&quot;, cookie-&gt;duration / 1E6, cookie-&gt;duration);
 		} else {
 			cookie-&gt;duration = fFile-&gt;Duration();
-			TRACE(&quot;duration %.6f (%Ld) (using fallback)\n&quot;, cookie-&gt;duration / 1E6, cookie-&gt;duration);
+			TRACE(&quot;audio duration %.6f (%Ld) (using fallback)\n&quot;, cookie-&gt;duration / 1E6, cookie-&gt;duration);
 		}
 		
 		cookie-&gt;audio = true;
@@ -195,19 +195,19 @@
 		if (stream_header-&gt;scale &amp;&amp; stream_header-&gt;rate &amp;&amp; stream_header-&gt;sample_size) {
 			cookie-&gt;bytes_per_sec_rate = stream_header-&gt;rate * stream_header-&gt;sample_size;
 			cookie-&gt;bytes_per_sec_scale = stream_header-&gt;scale;
-			TRACE(&quot;bytes_per_sec_rate %ld, bytes_per_sec_scale %ld (using both)\n&quot;, cookie-&gt;bytes_per_sec_rate, cookie-&gt;bytes_per_sec_scale);
+			TRACE(&quot;audio bytes_per_sec_rate %ld, bytes_per_sec_scale %ld (using both)\n&quot;, cookie-&gt;bytes_per_sec_rate, cookie-&gt;bytes_per_sec_scale);
 		} else if (audio_format-&gt;avg_bytes_per_sec) {
 			cookie-&gt;bytes_per_sec_rate = audio_format-&gt;avg_bytes_per_sec;
 			cookie-&gt;bytes_per_sec_scale = 1;
-			TRACE(&quot;bytes_per_sec_rate %ld, bytes_per_sec_scale %ld (using avg_bytes_per_sec)\n&quot;, cookie-&gt;bytes_per_sec_rate, cookie-&gt;bytes_per_sec_scale);
+			TRACE(&quot;audio bytes_per_sec_rate %ld, bytes_per_sec_scale %ld (using avg_bytes_per_sec)\n&quot;, cookie-&gt;bytes_per_sec_rate, cookie-&gt;bytes_per_sec_scale);
 		} else if (stream_header-&gt;rate) {
 			cookie-&gt;bytes_per_sec_rate = stream_header-&gt;rate;
 			cookie-&gt;bytes_per_sec_scale = 1;
-			TRACE(&quot;bytes_per_sec_rate %ld, bytes_per_sec_scale %ld (using rate)\n&quot;, cookie-&gt;bytes_per_sec_rate, cookie-&gt;bytes_per_sec_scale);
+			TRACE(&quot;audio bytes_per_sec_rate %ld, bytes_per_sec_scale %ld (using rate)\n&quot;, cookie-&gt;bytes_per_sec_rate, cookie-&gt;bytes_per_sec_scale);
 		} else {
 			cookie-&gt;bytes_per_sec_rate = 128000;
 			cookie-&gt;bytes_per_sec_scale = 8;
-			TRACE(&quot;bytes_per_sec_rate %ld, bytes_per_sec_scale %ld (using fallback)\n&quot;, cookie-&gt;bytes_per_sec_rate, cookie-&gt;bytes_per_sec_scale);
+			TRACE(&quot;audio bytes_per_sec_rate %ld, bytes_per_sec_scale %ld (using fallback)\n&quot;, cookie-&gt;bytes_per_sec_rate, cookie-&gt;bytes_per_sec_scale);
 		}
 
 		if (audio_format-&gt;format_tag == 0x0001) {
@@ -291,8 +291,8 @@
 		cookie-&gt;frame_count = stream_header-&gt;length;
 		cookie-&gt;duration = (cookie-&gt;frame_count * (int64)cookie-&gt;frames_per_sec_scale * 1000000LL) / cookie-&gt;frames_per_sec_rate;
 		
-		TRACE(&quot;frame_count %Ld\n&quot;, cookie-&gt;frame_count);
-		TRACE(&quot;duration %.6f (%Ld)\n&quot;, cookie-&gt;duration / 1E6, cookie-&gt;duration);
+		TRACE(&quot;video frame_count %Ld\n&quot;, cookie-&gt;frame_count);
+		TRACE(&quot;video duration %.6f (%Ld)\n&quot;, cookie-&gt;duration / 1E6, cookie-&gt;duration);
 
 		description.family = B_AVI_FORMAT_FAMILY;
 		if (stream_header-&gt;fourcc_handler == 'ekaf' || stream_header-&gt;fourcc_handler == 0) // 'fake' or 0 fourcc =&gt; used compression id
@@ -383,9 +383,14 @@
 	avi_cookie *cookie = (avi_cookie *)_cookie;
 
 	int64 start; uint32 size; bool keyframe;
-	if (!fFile-&gt;GetNextChunkInfo(cookie-&gt;stream, &amp;start, &amp;size, &amp;keyframe))
+	if (fFile-&gt;GetNextChunkInfo(cookie-&gt;stream, &amp;start, &amp;size, &amp;keyframe) &lt; B_OK)
 		return B_LAST_BUFFER_ERROR;
 
+	if (size &gt; 0x200000) { // 2 MB
+		ERROR(&quot;stream %d: frame too big: %u byte\n&quot;, size);
+		return B_NO_MEMORY;
+	}
+
 	if (cookie-&gt;buffer_size &lt; size) {
 		delete [] cookie-&gt;buffer;
 		cookie-&gt;buffer_size = (size + 15) &amp; ~15;

Modified: haiku/trunk/src/add-ons/media/plugins/avi_reader/avi_reader.h
===================================================================
--- haiku/trunk/src/add-ons/media/plugins/avi_reader/avi_reader.h	2007-06-10 20:29:44 UTC (rev 21387)
+++ haiku/trunk/src/add-ons/media/plugins/avi_reader/avi_reader.h	2007-06-10 23:13:28 UTC (rev 21388)
@@ -1,5 +1,5 @@
 /*
- * Copyright (c) 2004, Marcus Overhagen
+ * Copyright (c) 2004-2007, Marcus Overhagen
  * All rights reserved.
  *
  * Redistribution and use in source and binary forms, with or without modification,
@@ -26,7 +26,7 @@
 #define _AVI_READER_H
 
 #include &quot;ReaderPlugin.h&quot;
-#include &quot;libOpenDML/OpenDMLFile.h&quot;
+#include &quot;OpenDMLFile.h&quot;
 
 class aviReader : public Reader
 {

Added: haiku/trunk/src/add-ons/media/plugins/avi_reader/libOpenDML/FallbackIndex.cpp
===================================================================
--- haiku/trunk/src/add-ons/media/plugins/avi_reader/libOpenDML/FallbackIndex.cpp	2007-06-10 20:29:44 UTC (rev 21387)
+++ haiku/trunk/src/add-ons/media/plugins/avi_reader/libOpenDML/FallbackIndex.cpp	2007-06-10 23:13:28 UTC (rev 21388)
@@ -0,0 +1,59 @@
+/*
+ * Copyright (c) 2007, Marcus Overhagen
+ * All rights reserved.
+ *
+ * Redistribution and use in source and binary forms, with or without modification,
+ * are permitted provided that the following conditions are met:
+ *
+ *  * Redistributions of source code must retain the above copyright notice,
+ *    this list of conditions and the following disclaimer.
+ *  * Redistributions in binary form must reproduce the above copyright notice,
+ *    this list of conditions and the following disclaimer in the documentation
+ *    and/or other materials provided with the distribution.
+ *
+ * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS &quot;AS IS&quot; AND
+ * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED
+ * WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.
+ * IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT,
+ * INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING,
+ * BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
+ * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF
+ * LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE
+ * OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED
+ * OF THE POSSIBILITY OF SUCH DAMAGE.
+ */
+#include &lt;SupportDefs.h&gt;
+#include &lt;stdio.h&gt;
+#include &quot;FallbackIndex.h&quot;
+
+
+FallbackIndex::FallbackIndex(BPositionIO *source, OpenDMLParser *parser)
+ :	Index(source, parser)
+{
+}
+
+
+FallbackIndex::~FallbackIndex()
+{
+}
+
+
+status_t
+FallbackIndex::Init()
+{
+	return B_ERROR;
+}
+
+
+status_t
+FallbackIndex::GetNextChunkInfo(int stream_index, int64 *start, uint32 *size, bool *keyframe)
+{
+	return B_ERROR;
+}
+
+
+status_t
+FallbackIndex::Seek(int stream_index, uint32 seekTo, int64 *frame, bigtime_t *time)
+{
+	return B_ERROR;
+}

Added: haiku/trunk/src/add-ons/media/plugins/avi_reader/libOpenDML/FallbackIndex.h
===================================================================
--- haiku/trunk/src/add-ons/media/plugins/avi_reader/libOpenDML/FallbackIndex.h	2007-06-10 20:29:44 UTC (rev 21387)
+++ haiku/trunk/src/add-ons/media/plugins/avi_reader/libOpenDML/FallbackIndex.h	2007-06-10 23:13:28 UTC (rev 21388)
@@ -0,0 +1,42 @@
+/*
+ * Copyright (c) 2007, Marcus Overhagen
+ * All rights reserved.
+ *
+ * Redistribution and use in source and binary forms, with or without modification,
+ * are permitted provided that the following conditions are met:
+ *
+ *  * Redistributions of source code must retain the above copyright notice,
+ *    this list of conditions and the following disclaimer.
+ *  * Redistributions in binary form must reproduce the above copyright notice,
+ *    this list of conditions and the following disclaimer in the documentation
+ *    and/or other materials provided with the distribution.
+ *
+ * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS &quot;AS IS&quot; AND
+ * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED
+ * WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.
+ * IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT,
+ * INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING,
+ * BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
+ * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF
+ * LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE
+ * OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED
+ * OF THE POSSIBILITY OF SUCH DAMAGE.
+ */
+#ifndef _FALLBACK_INDEX_H
+#define _FALLBACK_INDEX_H
+
+#include &quot;Index.h&quot;
+
+class FallbackIndex : public Index
+{
+public:
+						FallbackIndex(BPositionIO *source, OpenDMLParser *parser);
+						~FallbackIndex();
+
+	status_t			Init();
+
+	status_t			GetNextChunkInfo(int stream_index, int64 *start, uint32 *size, bool *keyframe);
+	status_t			Seek(int stream_index, uint32 seekTo, int64 *frame, bigtime_t *time);
+};
+
+#endif

Added: haiku/trunk/src/add-ons/media/plugins/avi_reader/libOpenDML/Index.cpp
===================================================================
--- haiku/trunk/src/add-ons/media/plugins/avi_reader/libOpenDML/Index.cpp	2007-06-10 20:29:44 UTC (rev 21387)
+++ haiku/trunk/src/add-ons/media/plugins/avi_reader/libOpenDML/Index.cpp	2007-06-10 23:13:28 UTC (rev 21388)
@@ -0,0 +1,38 @@
+/*
+ * Copyright (c) 2007, Marcus Overhagen
+ * All rights reserved.
+ *
+ * Redistribution and use in source and binary forms, with or without modification,
+ * are permitted provided that the following conditions are met:
+ *
+ *  * Redistributions of source code must retain the above copyright notice,
+ *    this list of conditions and the following disclaimer.
+ *  * Redistributions in binary form must reproduce the above copyright notice,
+ *    this list of conditions and the following disclaimer in the documentation
+ *    and/or other materials provided with the distribution.
+ *
+ * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS &quot;AS IS&quot; AND
+ * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED
+ * WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.
+ * IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT,
+ * INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING,
+ * BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
+ * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF
+ * LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE
+ * OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED
+ * OF THE POSSIBILITY OF SUCH DAMAGE.
+ */
+#include &lt;SupportDefs.h&gt;
+#include &lt;stdio.h&gt;
+#include &quot;Index.h&quot;
+
+Index::Index(BPositionIO *source, OpenDMLParser *parser)
+ :	fSource(source)
+ ,	fParser(parser)
+{
+}
+
+
+Index::~Index()
+{
+}

Added: haiku/trunk/src/add-ons/media/plugins/avi_reader/libOpenDML/Index.h
===================================================================
--- haiku/trunk/src/add-ons/media/plugins/avi_reader/libOpenDML/Index.h	2007-06-10 20:29:44 UTC (rev 21387)
+++ haiku/trunk/src/add-ons/media/plugins/avi_reader/libOpenDML/Index.h	2007-06-10 23:13:28 UTC (rev 21388)
@@ -0,0 +1,46 @@
+/*
+ * Copyright (c) 2007, Marcus Overhagen
+ * All rights reserved.
+ *
+ * Redistribution and use in source and binary forms, with or without modification,
+ * are permitted provided that the following conditions are met:
+ *
+ *  * Redistributions of source code must retain the above copyright notice,
+ *    this list of conditions and the following disclaimer.
+ *  * Redistributions in binary form must reproduce the above copyright notice,
+ *    this list of conditions and the following disclaimer in the documentation
+ *    and/or other materials provided with the distribution.
+ *
+ * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS &quot;AS IS&quot; AND
+ * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED
+ * WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.
+ * IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT,
+ * INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING,
+ * BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
+ * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF
+ * LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE
+ * OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED
+ * OF THE POSSIBILITY OF SUCH DAMAGE.
+ */
+#ifndef _INDEX_H
+#define _INDEX_H
+
+class OpenDMLParser;
+
+class Index
+{
+public:
+						Index(BPositionIO *source, OpenDMLParser *parser);
+	virtual				~Index();
+
+	virtual status_t	Init() = 0;
+
+	virtual status_t	GetNextChunkInfo(int stream_index, int64 *start, uint32 *size, bool *keyframe) = 0;
+	virtual status_t	Seek(int stream_index, uint32 seekTo, int64 *frame, bigtime_t *time) = 0;
+
+protected:
+	BPositionIO *		fSource;
+	OpenDMLParser *		fParser;
+};
+
+#endif

Modified: haiku/trunk/src/add-ons/media/plugins/avi_reader/libOpenDML/Jamfile
===================================================================
--- haiku/trunk/src/add-ons/media/plugins/avi_reader/libOpenDML/Jamfile	2007-06-10 20:29:44 UTC (rev 21387)
+++ haiku/trunk/src/add-ons/media/plugins/avi_reader/libOpenDML/Jamfile	2007-06-10 23:13:28 UTC (rev 21388)
@@ -1,6 +1,12 @@
 SubDir HAIKU_TOP src add-ons media plugins avi_reader libOpenDML ;
 
+UsePrivateHeaders media ;
+
 StaticLibrary libopendml.a :
 	OpenDMLFile.cpp
 	OpenDMLParser.cpp
+	Index.cpp
+	OpenDMLIndex.cpp
+	StandardIndex.cpp
+	FallbackIndex.cpp
 ;

Modified: haiku/trunk/src/add-ons/media/plugins/avi_reader/libOpenDML/OpenDMLFile.cpp
===================================================================
--- haiku/trunk/src/add-ons/media/plugins/avi_reader/libOpenDML/OpenDMLFile.cpp	2007-06-10 20:29:44 UTC (rev 21387)
+++ haiku/trunk/src/add-ons/media/plugins/avi_reader/libOpenDML/OpenDMLFile.cpp	2007-06-10 23:13:28 UTC (rev 21388)
@@ -24,6 +24,9 @@
  */
 #include &lt;stdio.h&gt;
 #include &quot;OpenDMLFile.h&quot;
+#include &quot;OpenDMLIndex.h&quot;
+#include &quot;StandardIndex.h&quot;
+#include &quot;FallbackIndex.h&quot;
 
 #define TRACE_ODML_FILE
 #ifdef TRACE_ODML_FILE
@@ -34,6 +37,7 @@
 
 #define ERROR(a...) fprintf(stderr, a)
 
+#if 0
 #define INDEX_CHUNK_SIZE 32768
 
 struct OpenDMLFile::stream_data
@@ -62,19 +66,19 @@
 	int		index_chunk_entry_count;
 	int		index_chunk_entry_pos;
 };
+#endif
 
-OpenDMLFile::OpenDMLFile()
- : 	fSource(0),
-	fParser(0),
- 	fStreamCount(0),
- 	fStreamData(0)
+OpenDMLFile::OpenDMLFile(BPositionIO *source)
+ : 	fSource(source)
+ ,	fParser(NULL)
+ ,	fIndex(NULL)
 {
 }
 
 OpenDMLFile::~OpenDMLFile()
 {
 	delete fParser;
-	delete [] fStreamData;
+	delete fIndex;
 }
 
 /* static */ bool
@@ -88,10 +92,8 @@
 }
 
 status_t
-OpenDMLFile::SetTo(BPositionIO *source)
+OpenDMLFile::Init()
 {
-	fSource = source;
-	delete fParser;
 	fParser = new OpenDMLParser(fSource);
 
 	if (fParser-&gt;Parse() &lt; B_OK) {
@@ -103,28 +105,40 @@
 		return B_ERROR;
 	}
 	
-	if (fParser-&gt;StreamCount() != 0 &amp;&amp; fParser-&gt;StandardIndexSize() == 0) {
-		TRACE(&quot;OpenDMLFile::SetTo file has no standard avi index\n&quot;);
-		bool found_odml_index = false;
-		for (int i = 0; i &lt; fParser-&gt;StreamCount(); i++) {
-			if (fParser-&gt;StreamInfo(i)-&gt;odml_index_size != 0) {
-				found_odml_index = true;
-				break;
-			}
+	if (fParser-&gt;StreamCount() == 0) {
+		ERROR(&quot;OpenDMLFile::SetTo: no streams found\n&quot;);
+	}
+
+	if (fParser-&gt;StreamInfo(0)-&gt;odml_index_size != 0) {
+		fIndex = new OpenDMLIndex(fSource, fParser);
+		if (fIndex-&gt;Init() &lt; B_OK) {
+			delete fIndex;
+			fIndex = NULL;
 		}
-		if (!found_odml_index) {
-			ERROR(&quot;OpenDMLFile::SetTo file has no standard avi index, and no OpenDML track index found\n&quot;);
+	}
+	if (!fIndex &amp;&amp; fParser-&gt;StandardIndexSize() != 0) {
+		fIndex = new StandardIndex(fSource, fParser);
+		if (fIndex-&gt;Init() &lt; B_OK) {
+			delete fIndex;
+			fIndex = NULL;
+		}
+	}
+	if (!fIndex) {
+		fIndex = new FallbackIndex(fSource, fParser);
+		if (fIndex-&gt;Init() &lt; B_OK) {
+			delete fIndex;
+			fIndex = NULL;
+			TRACE(&quot;OpenDMLFile::SetTo: init of fallback index failed!\n&quot;);
 			return B_ERROR;
 		}
 	}
 	
 	TRACE(&quot;OpenDMLFile::SetTo: this is a %s AVI file with %d streams\n&quot;, fParser-&gt;OdmlExtendedHeader() ? &quot;OpenDML&quot; : &quot;standard&quot;, fParser-&gt;StreamCount());
 
-	InitData();
-
 	return B_OK;
 }
 
+#if 0
 void
 OpenDMLFile::InitData()
 {
@@ -375,22 +389,18 @@
 	TRACE(&quot;OpenDMLFile::AviGetNextChunkInfo: index end reached\n&quot;);
 	return false;
 }
+#endif
 
-bool
+status_t
 OpenDMLFile::GetNextChunkInfo(int stream_index, int64 *start, uint32 *size, bool *keyframe)
 {
-	stream_data *data = &amp;fStreamData[stream_index];
-	if (data-&gt;has_standard_index)
-		return AviGetNextChunkInfo(stream_index, start, size, keyframe);
-	if (data-&gt;has_odml_index)
-		return OdmlGetNextChunkInfo(stream_index, start, size, keyframe);
-	return false;
+	return fIndex-&gt;GetNextChunkInfo(stream_index, start, size, keyframe);
 }
 
 int
 OpenDMLFile::StreamCount()
 {
-	return fStreamCount;
+	return fParser-&gt;StreamCount();
 }
 
 bigtime_t
@@ -416,13 +426,13 @@
 bool
 OpenDMLFile::IsVideo(int stream_index)
 {
-	return fStreamData[stream_index].info-&gt;is_video;
+	return fParser-&gt;StreamInfo(stream_index)-&gt;is_video;
 }
 
 bool
 OpenDMLFile::IsAudio(int stream_index)
 {
-	return fStreamData[stream_index].info-&gt;is_audio;
+	return fParser-&gt;StreamInfo(stream_index)-&gt;is_audio;
 }
 
 const avi_main_header *
@@ -434,25 +444,25 @@
 const wave_format_ex *
 OpenDMLFile::AudioFormat(int stream_index, size_t *size /* = 0*/)
 {
-	if (!fStreamData[stream_index].info-&gt;is_audio)
+	if (!fParser-&gt;StreamInfo(stream_index)-&gt;is_audio)
 		return 0;
-	if (!fStreamData[stream_index].info-&gt;audio_format)
+	if (!fParser-&gt;StreamInfo(stream_index)-&gt;audio_format)
 		return 0;
 	if (size)
-		*size = fStreamData[stream_index].info-&gt;audio_format_size;
-	return fStreamData[stream_index].info-&gt;audio_format;
+		*size = fParser-&gt;StreamInfo(stream_index)-&gt;audio_format_size;
+	return fParser-&gt;StreamInfo(stream_index)-&gt;audio_format;
 }
 
 const bitmap_info_header *
 OpenDMLFile::VideoFormat(int stream_index)
 {
-	return (fStreamData[stream_index].info-&gt;is_video &amp;&amp; fStreamData[stream_index].info-&gt;video_format_valid) ?
-		&amp;fStreamData[stream_index].info-&gt;video_format : 0;
+	return (fParser-&gt;StreamInfo(stream_index)-&gt;is_video &amp;&amp; fParser-&gt;StreamInfo(stream_index)-&gt;video_format_valid) ?
+		&amp;fParser-&gt;StreamInfo(stream_index)-&gt;video_format : 0;
 }
 
 const avi_stream_header *
 OpenDMLFile::StreamFormat(int stream_index)
 {
-	return (fStreamData[stream_index].info-&gt;stream_header_valid) ?
-		&amp;fStreamData[stream_index].info-&gt;stream_header : 0;
+	return (fParser-&gt;StreamInfo(stream_index)-&gt;stream_header_valid) ?
+		&amp;fParser-&gt;StreamInfo(stream_index)-&gt;stream_header : 0;
 }

Modified: haiku/trunk/src/add-ons/media/plugins/avi_reader/libOpenDML/OpenDMLFile.h
===================================================================
--- haiku/trunk/src/add-ons/media/plugins/avi_reader/libOpenDML/OpenDMLFile.h	2007-06-10 20:29:44 UTC (rev 21387)
+++ haiku/trunk/src/add-ons/media/plugins/avi_reader/libOpenDML/OpenDMLFile.h	2007-06-10 23:13:28 UTC (rev 21388)
@@ -27,24 +27,25 @@
 
 #include &lt;DataIO.h&gt;
 #include &quot;OpenDMLParser.h&quot;
+#include &quot;Index.h&quot;
 
 class OpenDMLFile
 {
 public:
-				OpenDMLFile();
-				~OpenDMLFile();
+						OpenDMLFile(BPositionIO *source);
+						~OpenDMLFile();
 
-	static bool IsSupported(BPositionIO *source);
+	static bool 		IsSupported(BPositionIO *source);
 
-	status_t	SetTo(BPositionIO *source);
+	status_t			Init();
 	
-	int			StreamCount();
+	int					StreamCount();
 	
-	bigtime_t	Duration();
-	uint32		FrameCount();
+	bigtime_t			Duration();
+	uint32				FrameCount();
 	
-	bool		IsVideo(int stream_index);
-	bool		IsAudio(int stream_index);
+	bool				IsVideo(int stream_index);
+	bool				IsAudio(int stream_index);
 
 	const avi_main_header *AviMainHeader();
 
@@ -52,27 +53,14 @@
 	const bitmap_info_header *	VideoFormat(int stream_index);
 	const avi_stream_header *	StreamFormat(int stream_index);
 	
-	bool		GetNextChunkInfo(int stream_index, int64 *start, uint32 *size, bool *keyframe);
+	status_t			GetNextChunkInfo(int stream_index, int64 *start, uint32 *size, bool *keyframe);
 	
 	BPositionIO *Source() { return fSource; }
-
-private:
-	void		InitData();
-
-	bool		OdmlReadIndexChunk(int stream_index);
-	bool		OdmlReadIndexInfo(int stream_index);
-	bool		OdmlGetNextChunkInfo(int stream_index, int64 *start, uint32 *size, bool *keyframe);
-
-	bool		AviGetNextChunkInfo(int stream_index, int64 *start, uint32 *size, bool *keyframe);
 		
 private:
 	BPositionIO *	fSource;
 	OpenDMLParser *	fParser;
-
-	struct stream_data;
-	
-	int				fStreamCount;
-	stream_data *	fStreamData;
+	Index *			fIndex;
 };
 
 #endif

Added: haiku/trunk/src/add-ons/media/plugins/avi_reader/libOpenDML/OpenDMLIndex.cpp
===================================================================
--- haiku/trunk/src/add-ons/media/plugins/avi_reader/libOpenDML/OpenDMLIndex.cpp	2007-06-10 20:29:44 UTC (rev 21387)
+++ haiku/trunk/src/add-ons/media/plugins/avi_reader/libOpenDML/OpenDMLIndex.cpp	2007-06-10 23:13:28 UTC (rev 21388)
@@ -0,0 +1,59 @@
+/*
+ * Copyright (c) 2007, Marcus Overhagen
+ * All rights reserved.
+ *
+ * Redistribution and use in source and binary forms, with or without modification,
+ * are permitted provided that the following conditions are met:
+ *
+ *  * Redistributions of source code must retain the above copyright notice,
+ *    this list of conditions and the following disclaimer.
+ *  * Redistributions in binary form must reproduce the above copyright notice,
+ *    this list of conditions and the following disclaimer in the documentation
+ *    and/or other materials provided with the distribution.
+ *
+ * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS &quot;AS IS&quot; AND
+ * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED
+ * WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.
+ * IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT,
+ * INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING,
+ * BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
+ * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF
+ * LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE
+ * OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED
+ * OF THE POSSIBILITY OF SUCH DAMAGE.
+ */
+#include &lt;SupportDefs.h&gt;
+#include &lt;stdio.h&gt;
+#include &quot;OpenDMLIndex.h&quot;
+
+
+OpenDMLIndex::OpenDMLIndex(BPositionIO *source, OpenDMLParser *parser)
+ :	Index(source, parser)
+{
+}
+
+
+OpenDMLIndex::~OpenDMLIndex()
+{
+}
+
+
+status_t
+OpenDMLIndex::Init()
+{
+	return B_ERROR;
+}
+
+
+status_t
+OpenDMLIndex::GetNextChunkInfo(int stream_index, int64 *start, uint32 *size, bool *keyframe)
+{
+	return B_ERROR;
+}
+
+
+status_t
+OpenDMLIndex::Seek(int stream_index, uint32 seekTo, int64 *frame, bigtime_t *time)
+{
+	return B_ERROR;
+}

Added: haiku/trunk/src/add-ons/media/plugins/avi_reader/libOpenDML/OpenDMLIndex.h
===================================================================
--- haiku/trunk/src/add-ons/media/plugins/avi_reader/libOpenDML/OpenDMLIndex.h	2007-06-10 20:29:44 UTC (rev 21387)
+++ haiku/trunk/src/add-ons/media/plugins/avi_reader/libOpenDML/OpenDMLIndex.h	2007-06-10 23:13:28 UTC (rev 21388)
@@ -0,0 +1,42 @@
+/*
+ * Copyright (c) 2007, Marcus Overhagen
+ * All rights reserved.
+ *
+ * Redistribution and use in source and binary forms, with or without modification,
+ * are permitted provided that the following conditions are met:
+ *
+ *  * Redistributions of source code must retain the above copyright notice,
+ *    this list of conditions and the following disclaimer.
+ *  * Redistributions in binary form must reproduce the above copyright notice,
+ *    this list of conditions and the following disclaimer in the documentation
+ *    and/or other materials provided with the distribution.
+ *
+ * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS &quot;AS IS&quot; AND
+ * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED
+ * WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.
+ * IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT,
+ * INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING,
+ * BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
+ * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF
+ * LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE
+ * OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED
+ * OF THE POSSIBILITY OF SUCH DAMAGE.
+ */
+#ifndef _OPEN_DML_INDEX_H
+#define _OPEN_DML_INDEX_H
+
+#include &quot;Index.h&quot;
+
+class OpenDMLIndex : public Index
+{
+public:
+						OpenDMLIndex(BPositionIO *source, OpenDMLParser *parser);
+						~OpenDMLIndex();
+
+	status_t			Init();
+
+	status_t			GetNextChunkInfo(int stream_index, int64 *start, uint32 *size, bool *keyframe);
+	status_t			Seek(int stream_index, uint32 seekTo, int64 *frame, bigtime_t *time);
+};
+
+#endif

Added: haiku/trunk/src/add-ons/media/plugins/avi_reader/libOpenDML/StandardIndex.cpp
===================================================================
--- haiku/trunk/src/add-ons/media/plugins/avi_reader/libOpenDML/StandardIndex.cpp	2007-06-10 20:29:44 UTC (rev 21387)
+++ haiku/trunk/src/add-ons/media/plugins/avi_reader/libOpenDML/StandardIndex.cpp	2007-06-10 23:13:28 UTC (rev 21388)
@@ -0,0 +1,162 @@
+/*
+ * Copyright (c) 2007, Marcus Overhagen
+ * All rights reserved.
+ *
+ * Redistribution and use in source and binary forms, with or without modification,
+ * are permitted provided that the following conditions are met:
+ *
+ *  * Redistributions of source code must retain the above copyright notice,
+ *    this list of conditions and the following disclaimer.
+ *  * Redistributions in binary form must reproduce the above copyright notice,
+ *    this list of conditions and the following disclaimer in the documentation
+ *    and/or other materials provided with the distribution.
+ *
+ * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS &quot;AS IS&quot; AND
+ * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED
+ * WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.
+ * IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT,
+ * INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING,
+ * BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
+ * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF
+ * LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE
+ * OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED
+ * OF THE POSSIBILITY OF SUCH DAMAGE.
+ */
+#include &lt;SupportDefs.h&gt;
+#include &lt;DataIO.h&gt;
+#include &lt;stdio.h&gt;
+#include &lt;new&gt;
+#include &quot;ReaderPlugin.h&quot; // B_MEDIA_*
+#include &quot;StandardIndex.h&quot;
+#include &quot;OpenDMLParser.h&quot;
+
+#include &lt;StopWatch.h&gt;
+
+
+struct StandardIndex::stream_data
+{
+	uint32 chunk_id;
+	uint32 pos;
+};
+
+StandardIndex::StandardIndex(BPositionIO *source, OpenDMLParser *parser)
+ :	Index(source, parser)
+ ,	fIndex(NULL)
+ ,	fIndexSize(0)
+ ,	fStreamData(NULL)
+ ,	fStreamCount(parser-&gt;StreamCount())
+ ,	fDataOffset(parser-&gt;MovieListStart() - 4)
+{
+}
+
+
+StandardIndex::~StandardIndex()
+{
+	delete [] fIndex;
+	delete [] fStreamData;
+}
+
+
+status_t
+StandardIndex::Init()
+{
+	uint32 indexBytes = fParser-&gt;StandardIndexSize();
+	fIndexSize = indexBytes / sizeof(avi_standard_index_entry);
+	indexBytes = fIndexSize * sizeof(avi_standard_index_entry);
+
+ { BStopWatch w(&quot;StandardIndex::Init: malloc&quot;);
+
+	if (indexBytes &gt; 0x1900000) { // 25 MB
+		printf(&quot;StandardIndex::Init index is way too big\n&quot;);
+		return B_NO_MEMORY;
+	}
+
+	if (fIndexSize == 0) {
+		printf(&quot;StandardIndex::Init index is empty\n&quot;);
+		return B_NO_MEMORY;
+	}
+
+	fIndex = new (std::nothrow) avi_standard_index_entry[fIndexSize];
+	if (fIndex == NULL) {
+		printf(&quot;StandardIndex::Init out of memory\n&quot;);
+		return B_NO_MEMORY;
+	}
+}
+{ BStopWatch w(&quot;StandardIndex::Init: file read&quot;);
+
+	if (indexBytes != fSource-&gt;ReadAt(fParser-&gt;StandardIndexStart(), fIndex, indexBytes)) {
+		printf(&quot;StandardIndex::Init file reading failed\n&quot;);
+		delete [] fIndex;
+		fIndex = NULL;
+		return B_IO_ERROR;
+	}
+}
+
+	fStreamData = new stream_data[fStreamCount];
+	for (int i = 0; i &lt; fStreamCount; i++) {
+		fStreamData[i].chunk_id = i / 10 + '0' + (i % 10 + '0') * 256;
+		fStreamData[i].pos = 0;
+	}
+	
+	//DumpIndex();
+
+	return B_OK;
+}
+
+
+void 
+StandardIndex::DumpIndex()
+{
+	uint32 chunk = fIndex-&gt;chunk_id;
+	int count = 0;
+	int pos = 0;
+
+	printf(&quot;StandardIndex::DumpIndex %u entries\n&quot;, fIndexSize);
+	for (int i = 0; i &lt; fIndexSize; i++) {
+		count++;
+		if (chunk != fIndex[i].chunk_id) {
+			printf(&quot;%3d %c%c%c%c&quot;, count, FOURCC_PARAM(chunk));
+			chunk = fIndex[i].chunk_id;
+			count = 0;
+			if (++pos % 8 == 0)
+				printf(&quot;\n&quot;);			
+		}
+	}
+	if (count)
+		printf(&quot;%3d %c%c%c%c&quot;, count, FOURCC_PARAM(chunk));
+	printf(&quot;\n&quot;);			
+}
+
+
+status_t
+StandardIndex::GetNextChunkInfo(int stream_index, int64 *start, uint32 *size, bool *keyframe)
+{
+	stream_data *data = &amp;fStreamData[stream_index];
+	while (data-&gt;pos &lt; fIndexSize) {
+		if ((fIndex[data-&gt;pos].chunk_id &amp; 0xffff) == data-&gt;chunk_id) {
+			*keyframe = fIndex[data-&gt;pos].flags &amp; AVIIF_KEYFRAME;
+			*start = fDataOffset + fIndex[data-&gt;pos].chunk_offset + 8;  // skip 8 bytes (chunk id + chunk size)
+			*size = fIndex[data-&gt;pos].chunk_length;
+			data-&gt;pos++;
+			return B_OK;
+		}
+		data-&gt;pos++;
+	}
+
+	return B_ERROR;
+}
+
+
+status_t
+StandardIndex::Seek(int stream_index, uint32 seekTo, int64 *frame, bigtime_t *time)
+{
+/*
+	printf(&quot;StandardIndex::Seek: seekTo%s%s%s%s, time %Ld, frame %Ld\n&quot;,
+		(seekTo &amp; B_MEDIA_SEEK_TO_TIME) ? &quot; B_MEDIA_SEEK_TO_TIME&quot; : &quot;&quot;,
+		(seekTo &amp; B_MEDIA_SEEK_TO_FRAME) ? &quot; B_MEDIA_SEEK_TO_FRAME&quot; : &quot;&quot;,
+		(seekTo &amp; B_MEDIA_SEEK_CLOSEST_FORWARD) ? &quot; B_MEDIA_SEEK_CLOSEST_FORWARD&quot; : &quot;&quot;,
+		(seekTo &amp; B_MEDIA_SEEK_CLOSEST_BACKWARD) ? &quot; B_MEDIA_SEEK_CLOSEST_BACKWARD&quot; : &quot;&quot;);
+*/
+	return B_ERROR;
+}
+

Added: haiku/trunk/src/add-ons/media/plugins/avi_reader/libOpenDML/StandardIndex.h
===================================================================
--- haiku/trunk/src/add-ons/media/plugins/avi_reader/libOpenDML/StandardIndex.h	2007-06-10 20:29:44 UTC (rev 21387)
+++ haiku/trunk/src/add-ons/media/plugins/avi_reader/libOpenDML/StandardIndex.h	2007-06-10 23:13:28 UTC (rev 21388)
@@ -0,0 +1,54 @@
+/*
+ * Copyright (c) 2007, Marcus Overhagen
+ * All rights reserved.
+ *
+ * Redistribution and use in source and binary forms, with or without modification,
+ * are permitted provided that the following conditions are met:
+ *
+ *  * Redistributions of source code must retain the above copyright notice,
+ *    this list of conditions and the following disclaimer.
+ *  * Redistributions in binary form must reproduce the above copyright notice,
+ *    this list of conditions and the following disclaimer in the documentation
+ *    and/or other materials provided with the distribution.
+ *
+ * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS &quot;AS IS&quot; AND
+ * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED
+ * WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.
+ * IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT,
+ * INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING,
+ * BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
+ * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF
+ * LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE
+ * OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED
+ * OF THE POSSIBILITY OF SUCH DAMAGE.
+ */
+#ifndef _STANDARD_INDEX_H
+#define _STANDARD_INDEX_H
+
+#include &quot;Index.h&quot;
+#include &quot;avi.h&quot;
+
+class StandardIndex : public Index
+{
+public:
+						StandardIndex(BPositionIO *source, OpenDMLParser *parser);
+						~StandardIndex();
+
+	status_t			Init();
+
+	status_t			GetNextChunkInfo(int stream_index, int64 *start, uint32 *size, bool *keyframe);
+	status_t			Seek(int stream_index, uint32 seekTo, int64 *frame, bigtime_t *time);
+
+private:
+	void				DumpIndex();
+
+private:
+	struct stream_data;
+	avi_standard_index_entry *fIndex;
+	uint32				fIndexSize;
+	stream_data *		fStreamData;
+	int					fStreamCount;
+	int64				fDataOffset;
+};
+
+#endif


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="002681.html">[Haiku-commits] r21387 -	haiku/trunk/src/add-ons/translators/wonderbrush/support
</A></li>
	<LI>Next message: <A HREF="002684.html">[Haiku-commits] r21388 - in	haiku/trunk/src/add-ons/media/plugins/avi_reader: . libOpenDML
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2683">[ date ]</a>
              <a href="thread.html#2683">[ thread ]</a>
              <a href="subject.html#2683">[ subject ]</a>
              <a href="author.html#2683">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/haiku-commits">More information about the Haiku-commits
mailing list</a><br>
</body></html>
