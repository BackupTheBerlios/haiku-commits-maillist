<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Haiku-commits] r21515 - in haiku/trunk: headers/build/os/app	headers/build/private/app src/build/libbe/app
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/haiku-commits/2007-June/index.html" >
   <LINK REL="made" HREF="mailto:haiku-commits%40lists.berlios.de?Subject=Re%3A%20%5BHaiku-commits%5D%20r21515%20-%20in%20haiku/trunk%3A%20headers/build/os/app%0A%09headers/build/private/app%20src/build/libbe/app&In-Reply-To=%3C200706272033.l5RKXqKJ000542%40sheep.berlios.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="002905.html">
   <LINK REL="Next"  HREF="002907.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Haiku-commits] r21515 - in haiku/trunk: headers/build/os/app	headers/build/private/app src/build/libbe/app</H1>
    <B>mmlr at BerliOS</B> 
    <A HREF="mailto:haiku-commits%40lists.berlios.de?Subject=Re%3A%20%5BHaiku-commits%5D%20r21515%20-%20in%20haiku/trunk%3A%20headers/build/os/app%0A%09headers/build/private/app%20src/build/libbe/app&In-Reply-To=%3C200706272033.l5RKXqKJ000542%40sheep.berlios.de%3E"
       TITLE="[Haiku-commits] r21515 - in haiku/trunk: headers/build/os/app	headers/build/private/app src/build/libbe/app">mmlr at mail.berlios.de
       </A><BR>
    <I>Wed Jun 27 22:33:52 CEST 2007</I>
    <P><UL>
        <LI>Previous message: <A HREF="002905.html">[Haiku-commits] r21514 - in haiku/trunk: headers/private/app	headers/private/kernel/util src/kits/app
</A></li>
        <LI>Next message: <A HREF="002907.html">[Haiku-commits] r21516 - haiku/trunk/src/add-ons/kernel/busses/usb
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2906">[ date ]</a>
              <a href="thread.html#2906">[ thread ]</a>
              <a href="subject.html#2906">[ subject ]</a>
              <a href="author.html#2906">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: mmlr
Date: 2007-06-27 22:33:51 +0200 (Wed, 27 Jun 2007)
New Revision: 21515
ViewCVS: <A HREF="http://svn.berlios.de/viewcvs/haiku?rev=21515&amp;view=rev">http://svn.berlios.de/viewcvs/haiku?rev=21515&amp;view=rev</A>

Added:
   haiku/trunk/headers/build/private/app/MessageAdapter.h
   haiku/trunk/src/build/libbe/app/MessageAdapter.cpp
Removed:
   haiku/trunk/headers/build/private/app/Message2.h
   haiku/trunk/headers/build/private/app/Message3.h
   haiku/trunk/headers/build/private/app/MessageBody.h
   haiku/trunk/headers/build/private/app/MessageBody2.h
   haiku/trunk/headers/build/private/app/MessageBody3.h
   haiku/trunk/headers/build/private/app/MessageField.h
   haiku/trunk/headers/build/private/app/MessageField2.h
   haiku/trunk/headers/build/private/app/MessageField3.h
   haiku/trunk/headers/build/private/app/MessageUtils2.h
   haiku/trunk/headers/build/private/app/MessageUtils3.h
   haiku/trunk/src/build/libbe/app/MessageBody.cpp
   haiku/trunk/src/build/libbe/app/MessageField.cpp
Modified:
   haiku/trunk/headers/build/os/app/Message.h
   haiku/trunk/headers/build/private/app/MessagePrivate.h
   haiku/trunk/headers/build/private/app/MessageUtils.h
   haiku/trunk/src/build/libbe/app/Jamfile
   haiku/trunk/src/build/libbe/app/Message.cpp
   haiku/trunk/src/build/libbe/app/MessageUtils.cpp
   haiku/trunk/src/build/libbe/app/Messenger.cpp
Log:
* Ported over a simplified version (no message sending) of the current BMessage implementation to the build libbe
* Also ported over the new MessageAdapter class
* Removed old BMessage implementation prototypes that apparently were left in the private folder

Modified: haiku/trunk/headers/build/os/app/Message.h
===================================================================
--- haiku/trunk/headers/build/os/app/Message.h	2007-06-27 20:22:53 UTC (rev 21514)
+++ haiku/trunk/headers/build/os/app/Message.h	2007-06-27 20:33:51 UTC (rev 21515)
@@ -1,76 +1,33 @@
-//------------------------------------------------------------------------------
-//	Copyright (c) 2001-2002, OpenBeOS
-//
-//	Permission is hereby granted, free of charge, to any person obtaining a
-//	copy of this software and associated documentation files (the &quot;Software&quot;),
-//	to deal in the Software without restriction, including without limitation
-//	the rights to use, copy, modify, merge, publish, distribute, sublicense,
-//	and/or sell copies of the Software, and to permit persons to whom the
-//	Software is furnished to do so, subject to the following conditions:
-//
-//	The above copyright notice and this permission notice shall be included in
-//	all copies or substantial portions of the Software.
-//
-//	THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
-//	IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
-//	FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
-//	AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
-//	LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
-//	FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER
-//	DEALINGS IN THE SOFTWARE.
-//
-//	File Name:		Message.h
-//	Author(s):		Erik Jaesler (<A HREF="https://lists.berlios.de/mailman/listinfo/haiku-commits">erik at cgsoftware.com</A>)
-//					DarkWyrm &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/haiku-commits">bpmagic at columbus.rr.com</A>&gt;
-//	Description:	BMessage class creates objects that store data and that
-//					can be processed in a message loop.  BMessage objects
-//					are also used as data containers by the archiving and 
-//					the scripting mechanisms.
-//------------------------------------------------------------------------------
-
+/*
+ * Copyright 2005-2007, Haiku Inc. All Rights Reserved.
+ * Distributed under the terms of the MIT License.
+ *
+ * Authors:
+ *	Michael Lotz &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/haiku-commits">mmlr at mlotz.ch</A>&gt;
+ */
 #ifndef _MESSAGE_H
 #define _MESSAGE_H
 
-// Standard Includes -----------------------------------------------------------
-
-// System Includes -------------------------------------------------------------
 #include &lt;BeBuild.h&gt;
-#include &lt;OS.h&gt;
-#include &lt;Rect.h&gt;
 #include &lt;DataIO.h&gt;
 #include &lt;Flattenable.h&gt;
+#include &lt;OS.h&gt;
+#include &lt;Rect.h&gt;
 
 #include &lt;AppDefs.h&gt;		/* For convenience */
 #include &lt;TypeConstants.h&gt;	/* For convenience */
 
-// Project Includes ------------------------------------------------------------
+class BBlockCache;
+class BMessenger;
+class BHandler;
+class BString;
 
-// Local Includes --------------------------------------------------------------
 
-// Local Defines ---------------------------------------------------------------
-
-// Globals ---------------------------------------------------------------------
-
-
-
-class	BBlockCache;
-class	BMessenger;
-class	BHandler;
-class	BString;
-
-// Private or reserved ---------------------------------------------------------
-extern &quot;C&quot; void		_msg_cache_cleanup_();
-extern &quot;C&quot; int		_init_message_();
-extern &quot;C&quot; int		_delete_message_();
-//------------------------------------------------------------------------------
-
-
-// Name lengths and Scripting specifiers ---------------------------------------
+// Name lengths and Scripting specifiers
 #define B_FIELD_NAME_LENGTH			255
 #define B_PROPERTY_NAME_LENGTH		255
 
-enum
-{
+enum {
 	B_NO_SPECIFIER = 0,
 	B_DIRECT_SPECIFIER = 1,
 	B_INDEX_SPECIFIER,
@@ -81,359 +38,245 @@
 	B_ID_SPECIFIER,
 
 	B_SPECIFIERS_END = 128
-	// app-defined specifiers start at B_SPECIFIERS_END+1
+	// app-defined specifiers start at B_SPECIFIERS_END + 1
 };
 
-namespace BPrivate {
-	class BMessageBody;
-}
+class BMessage {
+	public:
+		uint32			what;
 
-// BMessage class --------------------------------------------------------------
-class BMessage
-{
-public:
-		uint32		what;
+						BMessage();
+						BMessage(uint32 what);
+						BMessage(const BMessage &amp;other);
+		virtual			~BMessage();
 
-					BMessage();
-					BMessage(uint32 what);
-					BMessage(const BMessage &amp;a_message);
-virtual				~BMessage();
+		BMessage		&amp;operator=(const BMessage &amp;other);
 
-		BMessage	&amp;operator=(const BMessage &amp;msg);
+		// Statistics and misc info
+		status_t		GetInfo(type_code typeRequested, int32 index,
+							char **nameFound, type_code *typeFound,
+							int32 *countFound = NULL) const;
+		status_t		GetInfo(const char *name, type_code *typeFound,
+							int32 *countFound = NULL) const;
+		status_t		GetInfo(const char *name, type_code *typeFound,
+							bool *fixedSize) const;
 
-// Statistics and misc info
-		status_t	GetInfo(type_code typeRequested, int32 which, char **name,
-							type_code *typeReturned, int32 *count = NULL) const;
+		int32			CountNames(type_code type) const;
+		bool			IsEmpty() const;
+		bool			IsSystem() const;
+		bool			IsReply() const;
+		void			PrintToStream() const;
 
-		status_t	GetInfo(const char *name, type_code *type, int32 *c = 0) const;
-		status_t	GetInfo(const char *name, type_code *type, bool *fixed_size) const;
+		status_t		Rename(const char *oldEntry, const char *newEntry);
 
-		int32		CountNames(type_code type) const;
-		bool		IsEmpty() const;
-		bool		IsSystem() const;
-		bool		IsReply() const;
-		void		PrintToStream() const;
-
-		status_t	Rename(const char *old_entry, const char *new_entry);
-
-// Delivery info
-		bool		WasDelivered() const;
-		bool		IsSourceWaiting() const;
-		BMessenger	ReturnAddress() const;
+		// Delivery info
+		bool			WasDelivered() const;
+		bool			IsSourceWaiting() const;
+		BMessenger		ReturnAddress() const;
 		const BMessage	*Previous() const;
-		bool		WasDropped() const;
-		BPoint		DropPoint(BPoint *offset = NULL) const;
+		bool			WasDropped() const;
+		BPoint			DropPoint(BPoint *offset = NULL) const;
 
-// Flattening data
-		ssize_t		FlattenedSize() const;
-		status_t	Flatten(char *buffer, ssize_t size) const;
-		status_t	Flatten(BDataIO *stream, ssize_t *size = NULL) const;
-		status_t	Unflatten(const char *flat_buffer);
-		status_t	Unflatten(BDataIO *stream);
+		// Flattening data
+		ssize_t			FlattenedSize() const;
+		status_t		Flatten(char *buffer, ssize_t size) const;
+		status_t		Flatten(BDataIO *stream, ssize_t *size = NULL) const;
+		status_t		Unflatten(const char *flatBuffer);
+		status_t		Unflatten(BDataIO *stream);
 
+		// Specifiers (scripting)
+		status_t		AddSpecifier(const char *property);
+		status_t		AddSpecifier(const char *property, int32 index);
+		status_t		AddSpecifier(const char *property, int32 index, int32 range);
+		status_t		AddSpecifier(const char *property, const char *name);
+		status_t		AddSpecifier(const BMessage *specifier);
 
-// Specifiers (scripting)
-		status_t	AddSpecifier(const char *property);
-		status_t	AddSpecifier(const char *property, int32 index);
-		status_t	AddSpecifier(const char *property, int32 index, int32 range);
-		status_t	AddSpecifier(const char *property, const char *name);
-		status_t	AddSpecifier(const BMessage *specifier);
+		status_t		SetCurrentSpecifier(int32 index);
+		status_t		GetCurrentSpecifier(int32 *index,
+							BMessage *specifier = NULL, int32 *what = NULL,
+							const char **property = NULL) const;
+		bool			HasSpecifiers() const;
+		status_t		PopSpecifier();
 
-		status_t	SetCurrentSpecifier(int32 index);
-		status_t	GetCurrentSpecifier(int32 *index, BMessage *specifier = NULL,
-							int32 *form = NULL, const char **property = NULL) const;
-		bool		HasSpecifiers() const;
-		status_t	PopSpecifier();
+		// Adding data
+		status_t		AddRect(const char *name, BRect aRect);
+		status_t		AddPoint(const char *name, BPoint aPoint);
+		status_t		AddString(const char *name, const char *aString);
+		status_t		AddString(const char *name, const BString &amp;aString);
+		status_t		AddInt8(const char *name, int8 value);
+		status_t		AddInt16(const char *name, int16 value);
+		status_t		AddInt32(const char *name, int32 value);
+		status_t		AddInt64(const char *name, int64 value);
+		status_t		AddBool(const char *name, bool aBoolean);
+		status_t		AddFloat(const char *name, float aFloat);
+		status_t		AddDouble(const char *name, double aDouble);
+		status_t		AddPointer(const char *name, const void *aPointer);
+		status_t		AddMessenger(const char *name, BMessenger messenger);
+		status_t		AddRef(const char *name, const entry_ref *ref);
+		status_t		AddMessage(const char *name, const BMessage *message);
+		status_t		AddFlat(const char *name, BFlattenable *object,
+							int32 count = 1);
+		status_t		AddData(const char *name, type_code type,
+							const void *data, ssize_t numBytes,
+							bool isFixedSize = true, int32 count = 1);
 
-// Adding data
-		status_t	AddRect(const char *name, BRect a_rect);
-		status_t	AddPoint(const char *name, BPoint a_point);
-		status_t	AddString(const char *name, const char *a_string);
-		status_t	AddString(const char *name, const BString&amp; a_string);
-		status_t	AddInt8(const char *name, int8 val);
-		status_t	AddInt16(const char *name, int16 val);
-		status_t	AddInt32(const char *name, int32 val);
-		status_t	AddInt64(const char *name, int64 val);
-		status_t	AddBool(const char *name, bool a_boolean);
-		status_t	AddFloat(const char *name, float a_float);
-		status_t	AddDouble(const char *name, double a_double);
-		status_t	AddPointer(const char *name, const void *ptr);
-		status_t	AddMessenger(const char *name, BMessenger messenger);
-		status_t	AddRef(const char *name, const entry_ref *ref);
-		status_t	AddMessage(const char *name, const BMessage *msg);
-		status_t	AddFlat(const char *name, BFlattenable *obj, int32 count = 1);
-		status_t	AddData(const char *name, type_code type, const void *data,
-						ssize_t numBytes, bool is_fixed_size = true, int32 count = 1);
+		// Removing data
+		status_t		RemoveData(const char *name, int32 index = 0);
+		status_t		RemoveName(const char *name);
+		status_t		MakeEmpty();
 
-// Removing data
-		status_t	RemoveData(const char *name, int32 index = 0);
-		status_t	RemoveName(const char *name);
-		status_t	MakeEmpty();
-
-// Finding data
-		status_t	FindRect(const char *name, BRect *rect) const;
-		status_t	FindRect(const char *name, int32 index, BRect *rect) const;
-		status_t	FindPoint(const char *name, BPoint *pt) const;
-		status_t	FindPoint(const char *name, int32 index, BPoint *pt) const;
-		status_t	FindString(const char *name, const char **str) const;
-		status_t	FindString(const char *name, int32 index, const char **str) const;
-		status_t	FindString(const char *name, BString *str) const;
-		status_t	FindString(const char *name, int32 index, BString *str) const;
-		status_t	FindInt8(const char *name, int8 *value) const;
-		status_t	FindInt8(const char *name, int32 index, int8 *val) const;
-		status_t	FindInt16(const char *name, int16 *value) const;
-		status_t	FindInt16(const char *name, int32 index, int16 *val) const;
-		status_t	FindInt32(const char *name, int32 *value) const;
-		status_t	FindInt32(const char *name, int32 index, int32 *val) const;
-		status_t	FindInt64(const char *name, int64 *value) const;
-		status_t	FindInt64(const char *name, int32 index, int64 *val) const;
-		status_t	FindBool(const char *name, bool *value) const;
-		status_t	FindBool(const char *name, int32 index, bool *value) const;
-		status_t	FindFloat(const char *name, float *f) const;
-		status_t	FindFloat(const char *name, int32 index, float *f) const;
-		status_t	FindDouble(const char *name, double *d) const;
-		status_t	FindDouble(const char *name, int32 index, double *d) const;
-		status_t	FindPointer(const char *name, void **ptr) const;
-		status_t	FindPointer(const char *name, int32 index,  void **ptr) const;
-		status_t	FindMessenger(const char *name, BMessenger *m) const;
-		status_t	FindMessenger(const char *name, int32 index, BMessenger *m) const;
-		status_t	FindRef(const char *name, entry_ref *ref) const;
-		status_t	FindRef(const char *name, int32 index, entry_ref *ref) const;
-		status_t	FindMessage(const char *name, BMessage *msg) const;
-		status_t	FindMessage(const char *name, int32 index, BMessage *msg) const;
-		status_t	FindFlat(const char *name, BFlattenable *obj) const;
-		status_t	FindFlat(const char *name, int32 index, BFlattenable *obj) const;
-		status_t	FindData(const char *name, type_code type,
+		// Finding data
+		status_t		FindRect(const char *name, BRect *rect) const;
+		status_t		FindRect(const char *name, int32 index, BRect *rect) const;
+		status_t		FindPoint(const char *name, BPoint *point) const;
+		status_t		FindPoint(const char *name, int32 index, BPoint *point) const;
+		status_t		FindString(const char *name, const char **string) const;
+		status_t		FindString(const char *name, int32 index, const char **string) const;
+		status_t		FindString(const char *name, BString *string) const;
+		status_t		FindString(const char *name, int32 index, BString *string) const;
+		status_t		FindInt8(const char *name, int8 *value) const;
+		status_t		FindInt8(const char *name, int32 index, int8 *value) const;
+		status_t		FindInt16(const char *name, int16 *value) const;
+		status_t		FindInt16(const char *name, int32 index, int16 *value) const;
+		status_t		FindInt32(const char *name, int32 *value) const;
+		status_t		FindInt32(const char *name, int32 index, int32 *value) const;
+		status_t		FindInt64(const char *name, int64 *value) const;
+		status_t		FindInt64(const char *name, int32 index, int64 *value) const;
+		status_t		FindBool(const char *name, bool *value) const;
+		status_t		FindBool(const char *name, int32 index, bool *value) const;
+		status_t		FindFloat(const char *name, float *value) const;
+		status_t		FindFloat(const char *name, int32 index, float *value) const;
+		status_t		FindDouble(const char *name, double *value) const;
+		status_t		FindDouble(const char *name, int32 index, double *value) const;
+		status_t		FindPointer(const char *name, void **pointer) const;
+		status_t		FindPointer(const char *name, int32 index,  void **pointer) const;
+		status_t		FindMessenger(const char *name, BMessenger *messenger) const;
+		status_t		FindMessenger(const char *name, int32 index, BMessenger *messenger) const;
+		status_t		FindRef(const char *name, entry_ref *ref) const;
+		status_t		FindRef(const char *name, int32 index, entry_ref *ref) const;
+		status_t		FindMessage(const char *name, BMessage *message) const;
+		status_t		FindMessage(const char *name, int32 index, BMessage *message) const;
+		status_t		FindFlat(const char *name, BFlattenable *object) const;
+		status_t		FindFlat(const char *name, int32 index, BFlattenable *object) const;
+		status_t		FindData(const char *name, type_code type,
 							const void **data, ssize_t *numBytes) const;
-		status_t	FindData(const char *name, type_code type, int32 index,
+		status_t		FindData(const char *name, type_code type, int32 index,
 							const void **data, ssize_t *numBytes) const;
 
-// Replacing data
-		status_t	ReplaceRect(const char *name, BRect a_rect);
-		status_t	ReplaceRect(const char *name, int32 index, BRect a_rect);
-		status_t	ReplacePoint(const char *name, BPoint a_point);
-		status_t	ReplacePoint(const char *name, int32 index, BPoint a_point);
-		status_t	ReplaceString(const char *name, const char *string);
-		status_t	ReplaceString(const char *name, int32 index, const char *string);
-		status_t	ReplaceString(const char *name, const BString&amp; string);
-		status_t	ReplaceString(const char *name, int32 index, const BString&amp; string);
-		status_t	ReplaceInt8(const char *name, int8 val);
-		status_t	ReplaceInt8(const char *name, int32 index, int8 val);
-		status_t	ReplaceInt16(const char *name, int16 val);
-		status_t	ReplaceInt16(const char *name, int32 index, int16 val);
-		status_t	ReplaceInt32(const char *name, int32 val);
-		status_t	ReplaceInt32(const char *name, int32 index, int32 val);
-		status_t	ReplaceInt64(const char *name, int64 val);
-		status_t	ReplaceInt64(const char *name, int32 index, int64 val);
-		status_t	ReplaceBool(const char *name, bool a_bool);
-		status_t	ReplaceBool(const char *name, int32 index, bool a_bool);
-		status_t	ReplaceFloat(const char *name, float a_float);
-		status_t	ReplaceFloat(const char *name, int32 index, float a_float);
-		status_t	ReplaceDouble(const char *name, double a_double);
-		status_t	ReplaceDouble(const char *name, int32 index, double a_double);
-		status_t	ReplacePointer(const char *name, const void *ptr);
-		status_t	ReplacePointer(const char *name,int32 index,const void *ptr);
-		status_t	ReplaceMessenger(const char *name, BMessenger messenger);
-		status_t	ReplaceMessenger(const char *name, int32 index, BMessenger msngr);
-		status_t	ReplaceRef(	const char *name,const entry_ref *ref);
-		status_t	ReplaceRef(	const char *name, int32 index, const entry_ref *ref);
-		status_t	ReplaceMessage(const char *name, const BMessage *msg);
-		status_t	ReplaceMessage(const char *name, int32 index, const BMessage *msg);
-		status_t	ReplaceFlat(const char *name, BFlattenable *obj);
-		status_t	ReplaceFlat(const char *name, int32 index, BFlattenable *obj);
-		status_t	ReplaceData(const char *name, type_code type,
-								const void *data, ssize_t data_size);
-		status_t	ReplaceData(const char *name, type_code type, int32 index,
-								const void *data, ssize_t data_size);
+		// Replacing data
+		status_t		ReplaceRect(const char *name, BRect aRect);
+		status_t		ReplaceRect(const char *name, int32 index, BRect aRect);
+		status_t		ReplacePoint(const char *name, BPoint aPoint);
+		status_t		ReplacePoint(const char *name, int32 index, BPoint aPoint);
+		status_t		ReplaceString(const char *name, const char *aString);
+		status_t		ReplaceString(const char *name, int32 index, const char *aString);
+		status_t		ReplaceString(const char *name, const BString &amp;aString);
+		status_t		ReplaceString(const char *name, int32 index, const BString &amp;aString);
+		status_t		ReplaceInt8(const char *name, int8 value);
+		status_t		ReplaceInt8(const char *name, int32 index, int8 value);
+		status_t		ReplaceInt16(const char *name, int16 value);
+		status_t		ReplaceInt16(const char *name, int32 index, int16 value);
+		status_t		ReplaceInt32(const char *name, int32 value);
+		status_t		ReplaceInt32(const char *name, int32 index, int32 value);
+		status_t		ReplaceInt64(const char *name, int64 value);
+		status_t		ReplaceInt64(const char *name, int32 index, int64 value);
+		status_t		ReplaceBool(const char *name, bool aBoolean);
+		status_t		ReplaceBool(const char *name, int32 index, bool aBoolean);
+		status_t		ReplaceFloat(const char *name, float aFloat);
+		status_t		ReplaceFloat(const char *name, int32 index, float aFloat);
+		status_t		ReplaceDouble(const char *name, double aDouble);
+		status_t		ReplaceDouble(const char *name, int32 index, double aDouble);
+		status_t		ReplacePointer(const char *name, const void *pointer);
+		status_t		ReplacePointer(const char *name,int32 index,const void *pointer);
+		status_t		ReplaceMessenger(const char *name, BMessenger messenger);
+		status_t		ReplaceMessenger(const char *name, int32 index, BMessenger messenger);
+		status_t		ReplaceRef(	const char *name,const entry_ref *ref);
+		status_t		ReplaceRef(	const char *name, int32 index, const entry_ref *ref);
+		status_t		ReplaceMessage(const char *name, const BMessage *message);
+		status_t		ReplaceMessage(const char *name, int32 index, const BMessage *message);
+		status_t		ReplaceFlat(const char *name, BFlattenable *object);
+		status_t		ReplaceFlat(const char *name, int32 index, BFlattenable *object);
+		status_t		ReplaceData(const char *name, type_code type,
+							const void *data, ssize_t numBytes);
+		status_t		ReplaceData(const char *name, type_code type, int32 index,
+							const void *data, ssize_t numBytes);
 
-		void		*operator new(size_t size);
-		void		*operator new(size_t, void* p);
-		void		operator delete(void *ptr, size_t size);
+		void			*operator new(size_t size);
+		void			*operator new(size_t, void *pointer);
+		void			operator delete(void *pointer, size_t size);
 
-// Private, reserved, or obsolete ----------------------------------------------
-		bool		HasRect(const char *, int32 n = 0) const;
-		bool		HasPoint(const char *, int32 n = 0) const;
-		bool		HasString(const char *, int32 n = 0) const;
-		bool		HasInt8(const char *, int32 n = 0) const;
-		bool		HasInt16(const char *, int32 n = 0) const;
-		bool		HasInt32(const char *, int32 n = 0) const;
-		bool		HasInt64(const char *, int32 n = 0) const;
-		bool		HasBool(const char *, int32 n = 0) const;
-		bool		HasFloat(const char *, int32 n = 0) const;
-		bool		HasDouble(const char *, int32 n = 0) const;
-		bool		HasPointer(const char *, int32 n = 0) const;
-		bool		HasMessenger(const char *, int32 n = 0) const;
-		bool		HasRef(const char *, int32 n = 0) const;
-		bool		HasMessage(const char *, int32 n = 0) const;
-		bool		HasFlat(const char *, const BFlattenable *) const;
-		bool		HasFlat(const char *,int32 ,const BFlattenable *) const;
-		bool		HasData(const char *, type_code , int32 n = 0) const;
-		BRect		FindRect(const char *, int32 n = 0) const;
-		BPoint		FindPoint(const char *, int32 n = 0) const;
-		const char	*FindString(const char *, int32 n = 0) const;
-		int8		FindInt8(const char *, int32 n = 0) const;
-		int16		FindInt16(const char *, int32 n = 0) const;
-		int32		FindInt32(const char *, int32 n = 0) const;
-		int64		FindInt64(const char *, int32 n = 0) const;
-		bool		FindBool(const char *, int32 n = 0) const;
-		float		FindFloat(const char *, int32 n = 0) const;
-		double		FindDouble(const char *, int32 n = 0) const;
+		// Private, reserved, or obsolete
+		bool			HasRect(const char *, int32 n = 0) const;
+		bool			HasPoint(const char *, int32 n = 0) const;
+		bool			HasString(const char *, int32 n = 0) const;
+		bool			HasInt8(const char *, int32 n = 0) const;
+		bool			HasInt16(const char *, int32 n = 0) const;
+		bool			HasInt32(const char *, int32 n = 0) const;
+		bool			HasInt64(const char *, int32 n = 0) const;
+		bool			HasBool(const char *, int32 n = 0) const;
+		bool			HasFloat(const char *, int32 n = 0) const;
+		bool			HasDouble(const char *, int32 n = 0) const;
+		bool			HasPointer(const char *, int32 n = 0) const;
+		bool			HasMessenger(const char *, int32 n = 0) const;
+		bool			HasRef(const char *, int32 n = 0) const;
+		bool			HasMessage(const char *, int32 n = 0) const;
+		bool			HasFlat(const char *, const BFlattenable *) const;
+		bool			HasFlat(const char *, int32 n, const BFlattenable *) const;
+		bool			HasData(const char *, type_code , int32 n = 0) const;
+		BRect			FindRect(const char *, int32 n = 0) const;
+		BPoint			FindPoint(const char *, int32 n = 0) const;
+		const char		*FindString(const char *, int32 n = 0) const;
+		int8			FindInt8(const char *, int32 n = 0) const;
+		int16			FindInt16(const char *, int32 n = 0) const;
+		int32			FindInt32(const char *, int32 n = 0) const;
+		int64			FindInt64(const char *, int32 n = 0) const;
+		bool			FindBool(const char *, int32 n = 0) const;
+		float			FindFloat(const char *, int32 n = 0) const;
+		double			FindDouble(const char *, int32 n = 0) const;
 
 		class Private;
+		struct message_header;
+		struct field_header;
 
-private:
-		class Header;
+	private:
+		friend class Private;
+		friend class BMessageQueue;
 
-friend class	BMessageQueue;
-friend class	BMessenger;
-friend class	BApplication;
-friend class	Header;
-friend class	Private;
+		status_t		_InitCommon();
+		status_t		_InitHeader();
+		status_t		_Clear();
 
-friend inline	void		_set_message_target_(BMessage *, int32, bool);
-friend inline	void		_set_message_reply_(BMessage *, BMessenger);
-friend inline	int32		_get_message_target_(BMessage *);
-friend inline	bool		_use_preferred_target_(BMessage *);
+		status_t		_ResizeData(int32 offset, int32 change);
 
-					// deprecated
-					BMessage(BMessage *a_message);
-					
-virtual	void		_ReservedMessage1();
-virtual	void		_ReservedMessage2();
-virtual	void		_ReservedMessage3();
+		uint32			_HashName(const char* name) const;
+		status_t		_FindField(const char* name, type_code type,
+							field_header** _result) const;
+		status_t		_AddField(const char* name, type_code type,
+							bool isFixedSize, field_header** _result);
+		status_t		_RemoveField(field_header* field);
 
-		void		init_data();
-		status_t	flatten_target_info(BDataIO *stream,
-										ssize_t size,
-										uchar flags) const;
-		status_t	real_flatten(char *result,
-								ssize_t size) const;
-		status_t	real_flatten(BDataIO *stream) const;
-		char		*stack_flatten(char *stack_ptr,
-									ssize_t stack_size,
-									bool incl_reply,
-									ssize_t *size = NULL) const;
+		ssize_t			_NativeFlattenedSize() const;
+		status_t		_NativeFlatten(char *buffer, ssize_t size) const;
+		status_t		_NativeFlatten(BDataIO *stream, ssize_t *size = NULL) const;
+		void			_PrintToStream(const char* indent) const;
 
-		ssize_t		calc_size(uchar flags) const;
-		ssize_t		calc_hdr_size(uchar flags) const;
-		status_t	nfind_data(	const char *name,
-								type_code type,
-								int32 index,
-								const void **data,
-								ssize_t *data_size) const;
-		status_t	copy_data(	const char *name,
-								type_code type,
-								int32 index,
-								void *data,
-								ssize_t data_size) const;
+	private:
+		message_header*	fHeader;
+		field_header*	fFields;
+		uint8*			fData;
+		area_id			fClonedArea;
 
-static	void		_StaticInit();
-static	void		_StaticCleanup();
-static	void		_StaticCacheCleanup();
+		mutable	BMessage* fOriginal;
 
-static	BBlockCache	*sMsgCache;
+		BMessage*		fQueueLink;
+			// fQueueLink is used by BMessageQueue to build a linked list
 
-		struct dyn_array {
-			int32		fLogicalBytes;
-			int32		fPhysicalBytes;
-			int32		fChunkSize;		
-			int32		fCount;
-			int32		fEntryHdrSize;	
-		};
+						// deprecated
+						BMessage(BMessage *message);
 
-		struct entry_hdr  : public dyn_array {
-			entry_hdr	*fNext;
-			uint32		fType;
-			uchar		fNameLength;	
-			char		fName[1];
-		};
+		static void		_StaticCacheCleanup();
 
-		struct var_chunk {
-			int32	fDataSize;				
-			char	fData[1];
-		};
-
-		entry_hdr 	*entry_find(const char *name, uint32 type,status_t *result=NULL) const;
-		void 		entry_remove(entry_hdr *entry);
-		
-		void		*da_create(int32 header_size, int32 chunk_size,
-								bool fixed, int32 nchunks);
-		status_t	da_add_data(dyn_array **da, const void *data, int32 size);
-		void		*da_find_data(dyn_array *da, int32 index,
-									int32 *size = NULL) const;
-		status_t	da_delete_data(dyn_array **pda, int32 index);
-		status_t	da_replace_data(dyn_array **pda, int32 index,
-									const void *data, int32 dsize);
-		int32		da_calc_size(int32 hdr_size, int32 chunksize,
-								bool is_fixed, int32 nchunks) const;
-		void		*da_grow(dyn_array **pda, int32 increase);
-		void		da_dump(dyn_array *da);
-
-		int32		da_chunk_hdr_size() const
-						{ return sizeof(int32); }
-		int32		da_chunk_size(var_chunk *v) const
-						{ return (v-&gt;fDataSize + da_chunk_hdr_size() + 7) &amp; ~7; }
-		var_chunk	*da_first_chunk(dyn_array *da) const
-						{ return (var_chunk *) da_start_of_data(da); }
-		var_chunk	*da_next_chunk(var_chunk *v) const
-						{ return (var_chunk *) (((char*) v) + da_chunk_size(v)); }
-		var_chunk	*da_chunk_ptr(void *data) const
-						{ return (var_chunk*) (((char *) data) - da_chunk_hdr_size()); }
-
-		int32		da_pad_8(int32 val) const
-						{ return (val + 7) &amp; ~7; }
-		int32		da_total_size(dyn_array *da) const
-						{ return (int32)sizeof(dyn_array) + da-&gt;fEntryHdrSize +
-											da-&gt;fPhysicalBytes; }
-		int32		da_total_logical_size(dyn_array *da) const
-						{ return (int32)sizeof(dyn_array) + da-&gt;fEntryHdrSize +
-											da-&gt;fLogicalBytes; }
-		char		*da_start_of_data(dyn_array *da) const
-						{ return ((char *) da) + (sizeof(dyn_array) +
-											da-&gt;fEntryHdrSize); }
-		bool		da_is_mini_data(dyn_array *da) const
-						{ return ((da-&gt;fLogicalBytes &lt;= (int32) UCHAR_MAX) &amp;&amp;
-											(da-&gt;fCount &lt;= (int32) UCHAR_MAX));}
-		void		da_swap_var_sized(dyn_array *da);
-		void		da_swap_fixed_sized(dyn_array *da);
-
-		BMessage			*link;
-		int32				fTarget;	
-		BMessage			*fOriginal;
-		uint32				fChangeCount;
-		int32				fCurSpecifier;
-		uint32				fPtrOffset;
-
-		// ejaesler: Stealing one for my whacky BMessageBody l33tness
-		uint32				_reserved[2];
-		BPrivate::BMessageBody*	fBody;
-
-		BMessage::entry_hdr	*fEntries;
-
-		struct reply_to_info {
-			port_id				port;
-			int32				target;
-			team_id				team;
-			bool				preferred;
-		} fReplyTo;
-
-		bool				fPreferred;
-		bool				fReplyRequired;
-		bool				fReplyDone;
-		bool				fIsReply;
-		bool				fWasDelivered;
-		bool				fReadOnly;
-		bool				fHasSpecifiers;	
+		static BBlockCache* sMsgCache;
 };
 
-//------------------------------------------------------------------------------
-
 #endif	// _MESSAGE_H
-
-/*
- * $Log $
- *
- * $Id  $
- *
- */
-

Deleted: haiku/trunk/headers/build/private/app/Message2.h

Deleted: haiku/trunk/headers/build/private/app/Message3.h

Added: haiku/trunk/headers/build/private/app/MessageAdapter.h
===================================================================
--- haiku/trunk/headers/build/private/app/MessageAdapter.h	2007-06-27 20:22:53 UTC (rev 21514)
+++ haiku/trunk/headers/build/private/app/MessageAdapter.h	2007-06-27 20:33:51 UTC (rev 21515)
@@ -0,0 +1,51 @@
+/*
+ * Copyright 2007, Haiku Inc. All rights reserved.
+ * Distributed under the terms of the MIT License.
+ *
+ * Authors:
+ *		Michael Lotz &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/haiku-commits">mmlr at mlotz.ch</A>&gt;
+ */
+#ifndef _MESSAGE_ADAPTER_H_
+#define _MESSAGE_ADAPTER_H_
+
+#include &lt;Message.h&gt;
+
+// message formats
+#define MESSAGE_FORMAT_R5				'FOB1'
+#define MESSAGE_FORMAT_R5_SWAPPED		'1BOF'
+#define MESSAGE_FORMAT_DANO				'FOB2'
+#define MESSAGE_FORMAT_DANO_SWAPPED		'2BOF'
+#define MESSAGE_FORMAT_HAIKU			'1FMH'
+#define MESSAGE_FORMAT_HAIKU_SWAPPED	'HMF1'
+
+namespace BPrivate {
+
+class MessageAdapter {
+public:
+static	ssize_t			FlattenedSize(uint32 format, const BMessage *from);
+
+static	status_t		Flatten(uint32 format, const BMessage *from,
+							char *buffer, ssize_t *size);
+static	status_t		Flatten(uint32 format, const BMessage *from,
+							BDataIO *stream, ssize_t *size);
+
+static	status_t		Unflatten(uint32 format, BMessage *into,
+							const char *buffer);
+static	status_t		Unflatten(uint32 format, BMessage *into,
+							BDataIO *stream);
+
+private:
+static	ssize_t			_R5FlattenedSize(const BMessage *from);
+
+static	status_t		_FlattenR5Message(uint32 format, const BMessage *from,
+							char *buffer, ssize_t *size);
+
+static	status_t		_UnflattenR5Message(uint32 format, BMessage *into,
+							BDataIO *stream);
+static	status_t		_UnflattenDanoMessage(uint32 format, BMessage *into,
+							BDataIO *stream);
+};
+
+} // namespace BPrivate
+
+#endif // _MESSAGE_ADAPTER_H_

Deleted: haiku/trunk/headers/build/private/app/MessageBody.h

Deleted: haiku/trunk/headers/build/private/app/MessageBody2.h

Deleted: haiku/trunk/headers/build/private/app/MessageBody3.h

Deleted: haiku/trunk/headers/build/private/app/MessageField.h

Deleted: haiku/trunk/headers/build/private/app/MessageField2.h

Deleted: haiku/trunk/headers/build/private/app/MessageField3.h

Modified: haiku/trunk/headers/build/private/app/MessagePrivate.h
===================================================================
--- haiku/trunk/headers/build/private/app/MessagePrivate.h	2007-06-27 20:22:53 UTC (rev 21514)
+++ haiku/trunk/headers/build/private/app/MessagePrivate.h	2007-06-27 20:33:51 UTC (rev 21515)
@@ -1,80 +1,189 @@
-//------------------------------------------------------------------------------
-//	MessagePrivate.h
-//
-//------------------------------------------------------------------------------
+/*
+ * Copyright 2005-2007, Haiku Inc. All rights reserved.
+ * Distributed under the terms of the MIT License.
+ *
+ * Authors:
+ *		Michael Lotz &lt;<A HREF="https://lists.berlios.de/mailman/listinfo/haiku-commits">mmlr at mlotz.ch</A>&gt;
+ */
+#ifndef _MESSAGE_PRIVATE_H_
+#define _MESSAGE_PRIVATE_H_
 
-#ifndef MESSAGEPRIVATE_H
-#define MESSAGEPRIVATE_H
-
 #include &lt;Message.h&gt;
-#include &lt;Messenger.h&gt;
-#include &lt;MessengerPrivate.h&gt;
 #include &lt;TokenSpace.h&gt;
 
-class BMessage::Private
-{
+
+#define MESSAGE_BODY_HASH_TABLE_SIZE	10
+#define MAX_DATA_PREALLOCATION			B_PAGE_SIZE * 10
+#define MAX_FIELD_PREALLOCATION			50
+#define MAX_ITEM_PREALLOCATION			B_PAGE_SIZE
+
+
+static const int32 kPortMessageCode = 'pjpp';
+
+
+enum {
+	MESSAGE_FLAG_VALID = 0x0001,
+	MESSAGE_FLAG_REPLY_REQUIRED = 0x0002,
+	MESSAGE_FLAG_REPLY_DONE = 0x0004,
+	MESSAGE_FLAG_IS_REPLY = 0x0008,
+	MESSAGE_FLAG_WAS_DELIVERED = 0x0010,
+	MESSAGE_FLAG_HAS_SPECIFIERS = 0x0020,
+	MESSAGE_FLAG_WAS_DROPPED = 0x0080,
+	MESSAGE_FLAG_PASS_BY_AREA = 0x0100
+};
+
+
+enum {
+	FIELD_FLAG_VALID = 0x0001,
+	FIELD_FLAG_FIXED_SIZE = 0x0002,
+};
+
+
+struct BMessage::field_header {
+	uint32		flags;
+	type_code	type;
+	int32		name_length;
+	int32		count;
+	ssize_t		data_size;
+	ssize_t		allocated;
+	int32		offset;
+	int32		next_field;
+};
+
+
+struct BMessage::message_header {
+	uint32		format;
+	uint32		what;
+	uint32		flags;
+
+	ssize_t		fields_size;
+	ssize_t		data_size;
+	ssize_t		fields_available;
+	ssize_t		data_available;
+
+	uint32		fields_checksum;
+	uint32		data_checksum;
+
+	int32		target;
+	int32		current_specifier;
+	area_id		shared_area;
+
+	// reply info
+	port_id		reply_port;
+	int32		reply_target;
+	team_id		reply_team;
+
+	// body info
+	int32		field_count;
+	int32		hash_table_size;
+	int32		hash_table[MESSAGE_BODY_HASH_TABLE_SIZE];
+
+	/*	The hash table does contain indexes into the field list and
+		not direct offsets to the fields. This has the advantage
+		of not needing to update offsets in two locations.
+		The hash table must be reevaluated when we remove a field
+		though.
+	*/
+};
+
+
+class BMessage::Private {
 	public:
-		Private(BMessage* msg) : fMessage(msg) {;}
-		Private(BMessage&amp; msg) : fMessage(&amp;msg) {;}
+		Private(BMessage *msg)
+			: fMessage(msg)
+		{
+		}
 
-		inline void SetTarget(int32 token, bool preferred)
+		Private(BMessage &amp;msg)
+			: fMessage(&amp;msg)
 		{
-			fMessage-&gt;fTarget = token;
-			fMessage-&gt;fPreferred = preferred;
 		}
 
-		inline void SetReply(BMessenger messenger)
+		void
+		SetTarget(int32 token)
 		{
-			BMessenger::Private mp(messenger);
-			fMessage-&gt;fReplyTo.port = mp.Port();
-			fMessage-&gt;fReplyTo.target
-				= (mp.IsPreferredTarget() ? B_PREFERRED_TOKEN : mp.Token());
-			fMessage-&gt;fReplyTo.team = mp.Team();
-			fMessage-&gt;fReplyTo.preferred = mp.IsPreferredTarget();
+			fMessage-&gt;fHeader-&gt;target = token;
 		}
 
-		inline int32 GetTarget()
+		int32
+		GetTarget()
 		{
-			return fMessage-&gt;fTarget;
+			return fMessage-&gt;fHeader-&gt;target;
 		}
 
-		inline bool UsePreferredTarget()
+		bool
+		UsePreferredTarget()
 		{
-			return fMessage-&gt;fPreferred;
+			return fMessage-&gt;fHeader-&gt;target == B_PREFERRED_TOKEN;
 		}
 
-		static inline status_t SendFlattenedMessage(void *data, int32 size,
-			port_id port, int32 token, bool preferred, bigtime_t timeout)
+		void
+		SetWasDropped(bool wasDropped)
 		{
-			return BMessage::_SendFlattenedMessage(data, size, port, token,
-				preferred, timeout);
+			if (wasDropped)
+				fMessage-&gt;fHeader-&gt;flags |= MESSAGE_FLAG_WAS_DROPPED;
+			else
+				fMessage-&gt;fHeader-&gt;flags &amp;= ~MESSAGE_FLAG_WAS_DROPPED;
 		}
 
-		static inline void StaticInit()
+		status_t
+		Clear()
 		{
-			BMessage::_StaticInit();
+			return fMessage-&gt;_Clear();
 		}
 
-		static inline void StaticCleanup()
+		status_t
+		InitHeader()
 		{
-			BMessage::_StaticCleanup();
+			return fMessage-&gt;_InitHeader();
 		}
 
-		static inline void StaticCacheCleanup()
+		BMessage::message_header*
+		GetMessageHeader()
 		{
+			return fMessage-&gt;fHeader;
+		}
+
+		BMessage::field_header*
+		GetMessageFields()
+		{
+			return fMessage-&gt;fFields;
+		}
+
+		uint8*
+		GetMessageData()
+		{
+			return fMessage-&gt;fData;
+		}
+
+		ssize_t
+		NativeFlattenedSize() const
+		{
+			return fMessage-&gt;_NativeFlattenedSize();
+		}
+
+		status_t
+		NativeFlatten(char *buffer, ssize_t size) const
+		{
+			return fMessage-&gt;_NativeFlatten(buffer, size);
+		}
+
+		status_t
+		NativeFlatten(BDataIO *stream, ssize_t *size) const
+		{
+			return fMessage-&gt;_NativeFlatten(stream, size);
+		}
+
+		// static methods
+
+		static void
+		StaticCacheCleanup()
+		{
 			BMessage::_StaticCacheCleanup();
 		}
 
 	private:
-		BMessage*	fMessage;
+		BMessage* fMessage;
 };
 
-#endif	// MESSAGEPRIVATE_H
-
-/*
- * $Log $
- *
- * $Id  $
- *
- */
-
+#endif	// _MESSAGE_PRIVATE_H_

Modified: haiku/trunk/headers/build/private/app/MessageUtils.h
===================================================================
--- haiku/trunk/headers/build/private/app/MessageUtils.h	2007-06-27 20:22:53 UTC (rev 21514)
+++ haiku/trunk/headers/build/private/app/MessageUtils.h	2007-06-27 20:33:51 UTC (rev 21515)
@@ -1,209 +1,163 @@
-//------------------------------------------------------------------------------
-//	MessageUtils.h
-//
-//------------------------------------------------------------------------------
+#ifndef _MESSAGE_UTILS_H_
+#define _MESSAGE_UTILS_H_
 
-#ifndef MESSAGEUTILS_H
-#define MESSAGEUTILS_H
-
-// Standard Includes -----------------------------------------------------------
-
-// System Includes -------------------------------------------------------------
 #include &lt;ByteOrder.h&gt;
 #include &lt;DataIO.h&gt;
 #include &lt;Entry.h&gt;
 #include &lt;Message.h&gt;
-#include &lt;Messenger.h&gt;

[... truncated: 4299 lines follow ...]

</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="002905.html">[Haiku-commits] r21514 - in haiku/trunk: headers/private/app	headers/private/kernel/util src/kits/app
</A></li>
	<LI>Next message: <A HREF="002907.html">[Haiku-commits] r21516 - haiku/trunk/src/add-ons/kernel/busses/usb
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2906">[ date ]</a>
              <a href="thread.html#2906">[ thread ]</a>
              <a href="subject.html#2906">[ subject ]</a>
              <a href="author.html#2906">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/haiku-commits">More information about the Haiku-commits
mailing list</a><br>
</body></html>
